---
layout: "post"
title: "内网穿透"
date: "2017-10-09 20:18"
categories: extend
tags: [frp]
---

## 简介

- 内网穿透，即NAT穿透，让外网用户可通过公网ip访问到内网服务。有时想要让其他人通过域名访问或者测试我们在本地搭建的 web 服务，但是由于本地机器没有公网 IP，无法将域名解析到本地的机器，通过内网穿透就可以实现这一功能
- 常见的内网穿透工具如ngrok(二级域名每次启动会变化)、花生壳(需要支付8元)、NATAPP(和ngrok类似，2-3天会更新二级域名)。当然本文不不会介绍这些xx.
- 本文介绍的内网穿透工具：frp。(内网穿透仍然需要一台公网IP的服务器，如阿里云服务器)

## frp实现内网穿透

### frp介绍

- 开源项目，支持`TCP`、`UDP`、`HTTP`、`HTTPS`，支持自定义域名绑定
- [github链接](https://github.com/fatedier/frp)、[中文文档](https://github.com/fatedier/frp/blob/master/README_zh.md)

### frp使用

> - 本文配合nginx使用(本文公网服务器不是主要用于内网穿透，且解析了多个域名，所以有些端口，如80被占用)
> - 本文以微信公众号H5开发为例(微信H5开发需要绑定回调地址，此回调地址必须是备案的域名，因此本地开发比较麻烦故使用内网穿透解决)

- 下载最新frp版本，本文使用`v0.13.0`
    - 需要下载公网IP服务器(以下简称"服务器")适用版(如`frp_0.13.0_linux_amd64.tar.gz`)和本地适用版(如`frp_0.13.0_windows_amd64.zip`)
- 服务端
    - 解压后含有`frps.ini`(配置文件)、`frps`(可执行文件)
    - 对`frps.ini`进行配置

        ```txt
        [common]
        bind_port = 7000
        # 使用泛域名*.frp.aezo.cn(需要将*.frp解析到此服务器)，此配置可忽略
        subdomain_host = frp.aezo.cn
        # 访问本地服务需要映射公网ip的端口
        vhost_http_port = 7070

        # dashboard(后台可视化管理)访问地址和用户名密码
        dashboard_port = 7500
        dashboard_user = smalle
        dashboard_pwd = smalle
        ```
    - 后台运行frp服务端：`nohup sudo -b ./frps > my.log 2>&1 &`
    - 服务器将开放相应端口：**7000、7070、7050(入)；7000(出)**
    - 服务器nginx配置如下

        ```js
        server {
            listen  80;
        	server_name test.aezo.cn;

        	location / {
            		proxy_set_header X-Forward-For $proxy_add_x_forwarded_for;
            		proxy_set_header Host $http_host;
            		proxy_redirect off;
            		if (!-f $request_filename) {
            			proxy_pass http://test.aezo.cn:7070;
            			break;
            		}
            	}
            }
        ```
    - 需要将域名`test.aezo.cn`解析到此服务器(101.1.1.1)
- 客户端
    - 解压后含有`frpc.ini`(配置文件)、`frpc`(可执行文件)
    - 对`frpc.ini`进行配置

        ```txt
        [common]
        # 服务器公网ip
        server_addr = 101.1.1.1
        server_port = 7000

        [web]
        type = http
        # 访问本地服务的端口
        local_port = 80
        custom_domains = test.aezo.cn

        # 此配置可忽略
        [web01]
        type = http
        local_port = 80
        # 使用泛域名进行解析(映射到http://test.frp.aezo.cn)
        subdomain = test
        ```
    - cmd运行`frpc -c ./frpc.ini`(可写成start.bat文件方便快速运行)
    - 客户端也可配合使用nginx
- 请求流程
    - 访问：http://test.aezo.cn，被nginx监听
    - 服务端nginx转向：http://test.aezo.cn:7070，被frp监听
    - frp通过7000端口和frp客户端进行通信：http://127.0.0.1:80
- 微信h5开发：将`test.aezo.cn`绑定到对应的回调地址上即可











---
