<!doctype html><html class="theme-next mist use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css"><meta name="keywords" content="jenkins,"><link rel="alternate" href="/atom.xml" title="月星墙的博客" type="application/atom+xml"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1"><meta name="description" content="简介 jenkins Jenkins CI，用Jenkins来进行持续集成，需要自己架设服务器 Travis CI是在线托管的CI服务，用Travis来进行持续集成，不需要自己搭服务器，使用方便，对开源项目是免费的，支持多数主流语言 https://travis-ci.org/ 非盈利的，为GitHub上Public的repository提供免费服务；对应的也有收费服务 Travis 要求项目的根"><meta name="keywords" content="jenkins"><meta property="og:type" content="article"><meta property="og:title" content="Jenkins"><meta property="og:url" content="http://blog.aezo.cn/2018/10/09/devops/jenkins/index.html"><meta property="og:site_name" content="月星墙的博客"><meta property="og:description" content="简介 jenkins Jenkins CI，用Jenkins来进行持续集成，需要自己架设服务器 Travis CI是在线托管的CI服务，用Travis来进行持续集成，不需要自己搭服务器，使用方便，对开源项目是免费的，支持多数主流语言 https://travis-ci.org/ 非盈利的，为GitHub上Public的repository提供免费服务；对应的也有收费服务 Travis 要求项目的根"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="http://blog.aezo.cn/data/images/devops/jenkins-docker-gitlab.png"><meta property="og:updated_time" content="2021-08-31T06:07:20.346Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Jenkins"><meta name="twitter:description" content="简介 jenkins Jenkins CI，用Jenkins来进行持续集成，需要自己架设服务器 Travis CI是在线托管的CI服务，用Travis来进行持续集成，不需要自己搭服务器，使用方便，对开源项目是免费的，支持多数主流语言 https://travis-ci.org/ 非盈利的，为GitHub上Public的repository提供免费服务；对应的也有收费服务 Travis 要求项目的根"><meta name="twitter:image" content="http://blog.aezo.cn/data/images/devops/jenkins-docker-gitlab.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",sidebar:{position:"right",display:"post",offset:12,offset_float:0,b2t:!1,scrollpercent:!1},fancybox:!0,motion:!0,duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"BWD6R9FA4K",apiKey:"3330f3cbaa099dfc30395de5f5b20151",indexName:"blog",hits:{per_page:10},labels:{input_placeholder:"请输入关键字",hits_empty:"我们没有找到任何搜索结果: ${query}",hits_stats:"找到约${hits}条结果（用时${time}ms）"}}}</script><link rel="canonical" href="http://blog.aezo.cn/2018/10/09/devops/jenkins/"><title>Jenkins | 月星墙的博客</title><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?085f9cd91ef2ad985f791c677472f0d1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-right page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">月星墙的博客</span><span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">Better Code, Better Life</h1></div><div class="site-nav-toggle"> <button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br> 首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br> 分类</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br> 关于</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br> 归档</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br> 标签</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i><br> 站点地图</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br> 搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"> <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><link itemprop="mainEntityOfPage" href="http://blog.aezo.cn/2018/10/09/devops/jenkins/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="smalle"><meta itemprop="description" content=""><meta itemprop="image" content="https://avatars0.githubusercontent.com/u/15698218?v=3&u=ce740bf0b67ff0d74990ba6fc644d6e92f572dcb&s=400"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="月星墙的博客"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">Jenkins</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-09T16:35:00+08:00">2018-10-09</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/devops/" itemprop="url" rel="index"><span itemprop="name">devops</span></a></span></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><ul><li><a href="https://jenkins.io/zh/" target="_blank" rel="noopener">jenkins</a></li><li>Jenkins CI，用Jenkins来进行持续集成，需要自己架设服务器</li><li>Travis CI是在线托管的CI服务，用Travis来进行持续集成，不需要自己搭服务器，使用方便，对开源项目是免费的，支持多数主流语言<ul><li><a href="https://travis-ci.org/" target="_blank" rel="noopener">https://travis-ci.org/</a> 非盈利的，为GitHub上Public的repository提供免费服务；对应的也有收费服务</li><li>Travis 要求项目的根目录下面，必须有一个.travis.yml文件。这是配置文件，指定了 Travis 的行为</li></ul></li></ul><h2 id="安装编译及运行"><a href="#安装编译及运行" class="headerlink" title="安装编译及运行"></a>安装编译及运行</h2><ul><li>本文基于<code>Jenkins ver. 2.181</code>、Jenkins ver. 2.164.3</li></ul><h3 id="直接安装运行"><a href="#直接安装运行" class="headerlink" title="直接安装运行"></a>直接安装运行</h3><h4 id="直接-docker-命令启动"><a href="#直接-docker-命令启动" class="headerlink" title="直接 docker 命令启动"></a>直接 docker 命令启动</h4><ul><li><code>docker volume create jenkins-data</code> 创建 jenkins-data 容器卷，专门存放 jenkins 数据</li><li>启动</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建镜像并运行(\后不能有空格)</span></span><br><span class="line">docker run \</span><br><span class="line">  -u root \</span><br><span class="line">  -d \</span><br><span class="line">  -p 2081:8080 \</span><br><span class="line">  -p 50080:50000 \</span><br><span class="line">  -v jenkins-data:/var/jenkins_home \</span><br><span class="line">  <span class="comment"># 映射主机的docker到容器里面，这样在容器里面就可以使用主机安装的 docker了(可以在Jenkins容器里操作宿主机的其他容器)</span></span><br><span class="line">  -v /var/run/docker.sock:/var/run/docker.sock \</span><br><span class="line">  <span class="comment"># jenkins/jenkins:2.181则必须再挂载此命令；jenkinsci/blueocean无需</span></span><br><span class="line">  -v /usr/bin/docker:/usr/bin/docker:ro \</span><br><span class="line">  <span class="comment"># 映射本地maven仓库(通过jenkins安装maven会使用到)</span></span><br><span class="line">  -v /root/.m2:/root/.m2 \</span><br><span class="line">  --name jenkins \</span><br><span class="line">  --restart=always \</span><br><span class="line">  <span class="comment">#jenkins/jenkins:2.181</span></span><br><span class="line">  jenkinsci/blueocean:1.18.1 <span class="comment"># 对应jenkins版本 Jenkins ver. 2.164.3。默认包含(Blue Ocean)</span></span><br></pre></td></tr></table></figure><h4 id="基于-docker-compose"><a href="#基于-docker-compose" class="headerlink" title="基于 docker-compose"></a>基于 docker-compose</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用docker-compose</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">"3"</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="attr">  jenkins:</span></span><br><span class="line"><span class="attr">    container_name:</span> <span class="string">jenkins</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">jenkinsci/blueocean:1.18.1</span></span><br><span class="line">    <span class="comment"># 解决时区问题，重新构建镜像</span></span><br><span class="line">    <span class="comment">#build:</span></span><br><span class="line">    <span class="comment">#  context: .</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">2081</span><span class="string">:8080</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">50080</span><span class="string">:50000</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="attr">      - jenkins-data:</span><span class="string">/var/jenkins_home</span></span><br><span class="line">      <span class="comment"># 必须是jenkinsci/blueocean才可在容器中执行docker命令，jenkins/jenkins镜像没有测试成功</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/var/run/docker.sock:/var/run/docker.sock</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/usr/bin/docker:/usr/bin/docker:ro</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/root/.m2:/root/.m2</span></span><br><span class="line"><span class="attr">    restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="comment"># 必须使用root用户启动</span></span><br><span class="line"><span class="attr">    user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line"><span class="attr">  jenkins-data:</span></span><br><span class="line"><span class="attr">    external:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><ul><li>激活：秘钥位置为/var/jenkins_home/secrets/initialAdminPassword，实际存储位置为/data/docker/volumes/jenkins-data/_data/secrets/initialAdminPassword(其中/data/docker 为 docker 默认存储路径，jenkins-data 为容器卷名)</li><li><p>jenkinsci/blueocean 容器中时区为 UTC 无法修改问题(jenkins 程序时区正常)，可在<code>docker-compose.yaml</code>所在目录创建<code>Dockerfile</code>文件用于重新构建镜像</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">FROM jenkinsci/blueocean:1.18.1</span><br><span class="line"><span class="comment"># 使用root用户安装tzdata</span></span><br><span class="line">USER root</span><br><span class="line">RUN /bin/sh -c apk --no-cache add tzdata</span><br><span class="line"><span class="comment"># 切回jenkins用户</span></span><br><span class="line">USER jenkins</span><br></pre></td></tr></table></figure><ul><li><code>docker-compose up -d --build</code> 重新编译</li></ul></li></ul><h4 id="k8s-helm-启动"><a href="#k8s-helm-启动" class="headerlink" title="k8s-helm 启动"></a>k8s-helm 启动</h4><p>参考<a href="/_posts/devops/helm.md#Jenkins">http://blog.aezo.cn/2019/06/22/devops/helm/</a></p><h3 id="手动编译运行"><a href="#手动编译运行" class="headerlink" title="手动编译运行"></a>手动编译运行</h3><blockquote><p>基于 stable-2.164 分支。具体参考：<a href="https://wiki.jenkins.io/display/JENKINS/Building+Jenkins" target="_blank" rel="noopener">https://wiki.jenkins.io/display/JENKINS/Building+Jenkins</a></p></blockquote><ul><li>安装依赖环境：jdk1.8、maven3.5.4+<ul><li>maven 版本过低时，maven-enforcer-plugin 校验报错</li></ul></li><li>下载源码 <code>git clone https://github.com/jenkinsci/jenkins.git</code> (可检出 stable-2.164 分支)</li><li>maven 编译并打包<ul><li>通过命令行编译 <strong><code>mvn -Plight-test package -DskipTests</code></strong></li><li>或者在 IDEA 上操作：勾选 Maven Projects - Profiles - light-test，执行 Jenkins main module - Lifecyle - package</li><li>编译时会生成<code>cli/target/generated-sources/Messages.java</code><blockquote><p>If your IDE complains that ‘Messages’ class is not found, they are missing because they are supposed to be generated. Run a Maven build once and you should see them all. If that doesn’t fix the problem, make sure your IDE added target/generated-sources to the compile source roots.</p></blockquote></li><li>打包时会生成 war/node(war/node/yarn)、war/node_modules，并打包静态资源文件</li></ul></li><li>Run/Debug 中添加 tomcat 配置，Deployment 选择 jenkins-war:war</li><li>debug 启动 tomcat。也可在远程启动 debug 监听 <code>mvnDebug jenkins-dev:run</code> 默认监听端口 8000，可通过 remote debug 进行远程调试</li></ul><h3 id="项目文件说明"><a href="#项目文件说明" class="headerlink" title="项目文件说明"></a>项目文件说明</h3><ul><li>/var/jenkins_home/config.xml 配置文件入口，可对应配置中的表单字段名</li></ul><h2 id="Pipeline"><a href="#Pipeline" class="headerlink" title="Pipeline"></a>Pipeline</h2><ul><li><a href="https://www.jenkins.io/zh/doc/book/pipeline/" target="_blank" rel="noopener">官网入门</a></li><li><a href="https://www.jenkins.io/doc/pipeline/steps/" target="_blank" rel="noopener">pipeline 支持的 steps 及支持的相关插件</a></li><li><a href="https://www.jenkins.io/doc/pipeline/steps/workflow-basic-steps/" target="_blank" rel="noopener">基本的steps命令</a></li><li>内置文档<ul><li>对于插件的使用可以参考 Pipeline 脚本编辑处的<strong>流水线语法</strong>：https://<jenkins-host>/job/<my-job-name>/pipeline-syntax/</my-job-name></jenkins-host></li><li>全局变量：https://<jenkins-host>/pipeline-syntax/globals</jenkins-host></li></ul></li><li>遵循 Groovy 语法规则</li><li>案例参考下文<a href="#构建示例">Pipeline相关</a></li><li>一个 Jenkinsfile 就是一个文本文件，Pipeline 支持两种形式，一种是 Declarative 管道，一个是 Scripted 管道</li></ul><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.Declarative风格 比较常用</span></span><br><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line"></span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">'编译阶段'</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                echo <span class="string">'Building..'</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">'部署阶段'</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                echo <span class="string">'Deploying..'</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.Scripted风格</span></span><br><span class="line">node &#123;</span><br><span class="line">    stage(<span class="string">'Build'</span>) &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Deploy'</span>) &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.或者直接调用命令，下文[常用插件命令-调用凭证即可直接运行](#常用插件命令)</span></span><br></pre></td></tr></table></figure><ul><li><a href="https://www.jenkins.io/doc/book/pipeline/syntax/" target="_blank" rel="noopener">常用关键字</a></li></ul><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 系统设置中设置global pipeline libraries，名字为jenkins_library，添加git地址共享库</span></span><br><span class="line">library <span class="string">"jenkins_library"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> context = [:] <span class="comment">// 定义一个全局变量(map)，但是不能在自定义函数中使用</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// pipeline前面可以有其他代码，例如导入语句，和其他功能代码</span></span><br><span class="line">pipeline &#123;</span><br><span class="line">    <span class="comment">// agent 指令指定整个管道或某个特定的stage的执行环境。它的参数可用使用：</span></span><br><span class="line">        <span class="comment">// any - 任意一个可用的agent</span></span><br><span class="line">        <span class="comment">// none - 如果放在pipeline顶层，那么每一个stage都需要定义自己的agent指令</span></span><br><span class="line">        <span class="comment">// label - 在jenkins环境中指定标签的agent上面执行，比如agent &#123; label 'my-defined-label' &#125;</span></span><br><span class="line">        <span class="comment">// node - agent &#123; node &#123; label 'labelName' &#125; &#125; 和 label一样，但是可用定义更多可选项</span></span><br><span class="line">        <span class="comment">// docker - 指定在docker容器中运行</span></span><br><span class="line">        <span class="comment">// dockerfile - 使用源码根目录下面的Dockerfile构建容器来运行</span></span><br><span class="line">    agent any</span><br><span class="line">    <span class="comment">// agent &#123; label "jnlp-agent" &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义键值对的环境变量</span></span><br><span class="line">    environment &#123;</span><br><span class="line">        APP_VERSION = <span class="string">'v1.0.0'</span></span><br><span class="line">        BROWSER_NAME = <span class="string">'chrome'</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义自动安装并自动放入PATH里面的工具集合，工具名称必须预先在Jenkins中配置好了 → Global Tool Configuration</span></span><br><span class="line">    tools &#123;</span><br><span class="line">        maven <span class="string">'apache-maven-3.0.1'</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 由一个或多个stage指令组成，stages块也是核心逻辑的部分. 可进行嵌套</span></span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">'Test'</span>) &#123;</span><br><span class="line">            <span class="comment">// when指令允许Pipeline根据给定条件确定是否应执行该阶段。该when指令必须至少包含一个条件。如果when指令包含多个条件，则所有子条件必须返回true才能执行该阶段</span></span><br><span class="line">            when &#123;</span><br><span class="line">                branch <span class="string">'production'</span></span><br><span class="line">                <span class="comment">// environment name: 'DEPLOY_TO', value: 'production' // 环境变量</span></span><br><span class="line">                <span class="comment">// expression &#123; return true &#125; // 表达式返回true时触发</span></span><br><span class="line">                <span class="comment">// 还有如equals、allOf等</span></span><br><span class="line">            &#125;</span><br><span class="line">            steps &#123;</span><br><span class="line">                <span class="comment">// 基本的steps命令(其他命令不能再steps中，可以使用一个script包裹) https://www.jenkins.io/doc/pipeline/steps/workflow-basic-steps/</span></span><br><span class="line">                println <span class="string">'hello...'</span> <span class="comment">// println可以打印对象，echo只能打印字符串</span></span><br><span class="line">                echo <span class="string">'Test..'</span></span><br><span class="line">                echo <span class="string">"Running on $&#123;env.BROWSER_NAME&#125;"</span></span><br><span class="line"></span><br><span class="line">                script &#123;</span><br><span class="line">                    context.flag = <span class="literal">false</span> <span class="comment">// 给全局变量赋值</span></span><br><span class="line">                    <span class="keyword">def</span> browsers = [<span class="string">'chrome'</span>, <span class="string">'firefox'</span>]</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; browsers.size(); ++i) &#123;</span><br><span class="line">                        echo <span class="string">"Testing the $&#123;browsers[i]&#125; browser"</span></span><br><span class="line">                        <span class="keyword">if</span>( browsers[i] == env.BROWSER_NAME ) &#123;</span><br><span class="line">                            <span class="keyword">return</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                myDir = <span class="string">'test'</span></span><br><span class="line">                sh <span class="string">"printenv"</span></span><br><span class="line">                echo gitlabMergeRequestTitle <span class="comment">// 可正常打印</span></span><br><span class="line">                echo evn.gitlabMergeRequestTitle <span class="comment">// 可正常打印</span></span><br><span class="line">                sh <span class="string">'echo $&#123;myDir&#125;'</span> <span class="comment">// 无法获取变量</span></span><br><span class="line">                sh <span class="string">"echo $&#123;myDir&#125;"</span> <span class="comment">// 可以获取变量</span></span><br><span class="line">                sh <span class="string">"""echo $&#123;myDir&#125;"""</span> <span class="comment">// 可换行文本，可以获取变量('''的可换行文本不行)</span></span><br><span class="line">                sh <span class="string">"echo $&#123;gitlabMergeRequestTitle&#125;"</span> <span class="comment">// 无法获取到环境比变量。gitlab hook时会注入gitlabMergeRequestTitle</span></span><br><span class="line">                sh <span class="string">"echo $&#123;evn.gitlabMergeRequestTitle&#125;"</span> <span class="comment">// 无法获取环境比变量</span></span><br><span class="line">                sh <span class="string">"echo \$gitlabMergeRequestTitle"</span> <span class="comment">// 可以打印出环境比变量(获取shell的环境变量，防止被groovy注入的当前脚本变量)</span></span><br><span class="line">                sh <span class="string">"echo \$evn\\.gitlabMergeRequestTitle"</span> <span class="comment">// 可以打印出环境比变量</span></span><br><span class="line"></span><br><span class="line">                result = sh (<span class="string">script:</span> <span class="string">"cat test.txt | grep 123"</span>, <span class="string">returnStatus:</span> <span class="literal">true</span>) <span class="comment">// 返回执行状态。找到了返回0，未找到返回1</span></span><br><span class="line">                result = sh (<span class="string">script:</span> <span class="string">"cat test.txt"</span>, <span class="string">returnStdout:</span> <span class="literal">true</span>) <span class="comment">// 返回命令的输出</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// stages &#123;&#125;</span></span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">'steps test'</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                <span class="comment">// error: 抛出异常，中断整个pipeline</span></span><br><span class="line">                <span class="comment">// timeout闭包内运行的步骤超时时间</span></span><br><span class="line">                timeout(<span class="number">50</span>) &#123;</span><br><span class="line">                    <span class="comment">// 一直循环运行闭包内容，直到return true，经常与timeout同时使用</span></span><br><span class="line">                    waitUntil &#123;</span><br><span class="line">                        script &#123;</span><br><span class="line">                            <span class="keyword">def</span> r = sh <span class="string">script:</span> <span class="string">'curl http://xxx'</span>, <span class="string">returnStatus:</span> <span class="literal">true</span></span><br><span class="line">                            <span class="keyword">return</span> (r == <span class="number">0</span>)</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 闭包内脚本重复执行次数</span></span><br><span class="line">                retry(<span class="number">10</span>)&#123;</span><br><span class="line">                    script &#123;</span><br><span class="line">                        sh <span class="string">script:</span> <span class="string">'curl http://xxx'</span>, <span class="string">returnStatus:</span> <span class="literal">true</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 暂停pipeline一段时间，单位为秒</span></span><br><span class="line">                sleep(<span class="number">20</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">"parallel test"</span>) &#123;</span><br><span class="line">            parallel &#123;</span><br><span class="line">                stage(<span class="string">'Stage1'</span>) &#123;</span><br><span class="line">                    agent &#123; label <span class="string">"test1"</span> &#125;</span><br><span class="line">                    steps &#123;</span><br><span class="line">                        echo <span class="string">"在 agent test1 上执行的并行任务 1."</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                stage(<span class="string">'Stage2'</span>) &#123;</span><br><span class="line">                    agent &#123; label <span class="string">"test2"</span> &#125;</span><br><span class="line">                    steps &#123;</span><br><span class="line">                        echo <span class="string">"在 agent test2 上执行的并行任务 2."</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// post：管道执行结束后要进行的操作。支持在里面定义很多Conditions块</span></span><br><span class="line">        <span class="comment">// always 不管返回什么状态都会执行</span></span><br><span class="line">        <span class="comment">// changed 如果当前管道返回值和上一次已经完成的管道返回值不同时候执行</span></span><br><span class="line">        <span class="comment">// failure 当前管道返回状态值为failed时候执行，在Web UI界面上面是红色的标志</span></span><br><span class="line">        <span class="comment">// success 返回success时候执行，在Web UI界面上面是绿色的标志</span></span><br><span class="line">        <span class="comment">// unstable 返回状态值为unstable时执行，通常因为测试失败，代码不合法引起的。在Web UI界面上面是黄色的标志</span></span><br><span class="line">    post &#123;</span><br><span class="line">        always &#123;</span><br><span class="line">            echo <span class="string">'I will always say Hello again!'</span></span><br><span class="line">            println context.flag</span><br><span class="line">            script &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="常用插件命令"><a href="#常用插件命令" class="headerlink" title="常用插件命令"></a>常用插件命令</h3><ul><li>更多可查看下文每个插件的使用或在网站流水线语法中查看</li></ul><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.调用凭证(隐藏密码，暂未发现 Pipeline 如何使用全局密码)</span></span><br><span class="line">withCredentials([usernamePassword(<span class="string">credentialsId:</span> <span class="string">'0c108a09-e321-45c6-bf9c-06626ddd1e4a'</span>, <span class="string">passwordVariable:</span> <span class="string">'MY_PASSWORD'</span>, <span class="string">usernameVariable:</span> <span class="string">'MY_USERNAME'</span>)]) &#123;</span><br><span class="line">    <span class="comment">// 打印 U: **** P: ****</span></span><br><span class="line">	sh <span class="string">"echo U: $&#123;MY_USERNAME&#125; P: $&#123;MY_PASSWORD&#125;"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.注入环境变量</span></span><br><span class="line">withEnv([<span class="string">'myparam=hello'</span>]) &#123;</span><br><span class="line">    sh <span class="string">"echo $&#123;env.myparam&#125;"</span> <span class="comment">// hello</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.连接远程服务器(传输文件、执行命令)</span></span><br><span class="line"><span class="keyword">def</span> projectName = <span class="string">'test'</span></span><br><span class="line">sshPublisher(<span class="string">publishers:</span> [sshPublisherDesc(<span class="string">configName:</span> <span class="string">'node1'</span>, <span class="string">transfers:</span> [</span><br><span class="line">    <span class="comment">// 连接服务器node1，将jenkins工作目录的文件传输到远程的test目录(相当于SFTP根目录)，如果没有此test目录则会创建(创建的前提是没有此目录且有文件要传输)</span></span><br><span class="line">    <span class="comment">// 注意：此时sourceFiles千万不能用./来表示当前目录，这样是过滤不到文件的</span></span><br><span class="line">    <span class="comment">// removePrefix为复制到目标目录时去掉目录前缀</span></span><br><span class="line">    <span class="comment">// sourceFiles文件格式遵守ant规范，http://ant.apache.org/manual/dirtasks.html#patterns</span></span><br><span class="line">    sshTransfer(<span class="string">sourceFiles:</span> <span class="string">"module1/target/*.jar"</span>, <span class="string">removePrefix:</span> <span class="string">"module1/target"</span>, <span class="string">remoteDirectory:</span> <span class="string">"$&#123;projectName&#125;"</span>, <span class="string">execCommand:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        echo $&#123;projectName&#125;</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">    )</span><br><span class="line">])])</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4.发送邮件</span></span><br><span class="line">emailext <span class="string">body:</span> <span class="string">'$DEFAULT_CONTENT'</span>, <span class="string">postsendScript:</span> <span class="string">'$DEFAULT_POSTSEND_SCRIPT'</span>, <span class="string">presendScript:</span> <span class="string">'$DEFAULT_PRESEND_SCRIPT'</span>, <span class="string">recipientProviders:</span> [developers()], <span class="string">replyTo:</span> <span class="string">'$DEFAULT_REPLYTO'</span>, <span class="string">subject:</span> <span class="string">'$DEFAULT_SUBJECT'</span>, <span class="string">to:</span> <span class="string">'$DEFAULT_RECIPIENTS;admin@qq.com'</span></span><br></pre></td></tr></table></figure><h2 id="构建"><a href="#构建" class="headerlink" title="构建"></a>构建</h2><h3 id="项目构建界面说明"><a href="#项目构建界面说明" class="headerlink" title="项目构建界面说明"></a>项目构建界面说明</h3><ul><li><code>Workspace</code> 为构建任务源码目录(构建配置中的<code>.</code>即为此构建源码目录，如<code>/var/jenkins_home/workspace/xx</code>)</li><li><code>Changes</code> 可记录 Git 源码提交记录</li><li><code>立即构建</code> 可手动执行此构建任务(一般是通过 Gitlab 触发)</li><li><code>Delete 工程</code>只能删除此构建任务，并不会删除 workspace 目录下的缓存项目源码。可进入容器手动删除<code>/var/jenkins_home/workspace/xx</code></li></ul><h3 id="自由风格构建说明"><a href="#自由风格构建说明" class="headerlink" title="自由风格构建说明"></a>自由风格构建说明</h3><h4 id="General"><a href="#General" class="headerlink" title="General"></a>General</h4><ul><li>限制项目的运行节点<ul><li>可基于节点标签(参考<a href="#节点管理">节点管理</a>)或名称进行选择，支持<code>&amp;&amp;</code>、<code>||</code>、<code>!</code>等运算符</li></ul></li></ul><h4 id="源码管理-Git"><a href="#源码管理-Git" class="headerlink" title="源码管理(Git)"></a>源码管理(Git)</h4><blockquote><p>此处的源码管理指在 jenkins 宿主机上管理任务相应源码，比如打包等操作。如 ofbiz 项目直接在服务器上拉取最新代码时可以不用源码管理，直接在构建中发起远程命令即可</p></blockquote><ul><li>Repositories：git 仓库配置</li><li>Branches to build：需要构建的分支，如<code>origin/test</code></li><li>Additional Behaviours：扩展配置<ul><li>Advanced clone behaviours：配置 git clone，对于较多代码拉取可将其中 Timeout 设置成<code>30</code>分钟</li></ul></li></ul><h4 id="构建触发器"><a href="#构建触发器" class="headerlink" title="构建触发器"></a>构建触发器</h4><ul><li><code>Build when a change is pushed to GitLab. GitLab webhook URL: http://192.168.1.100/project/test</code> 代码推送等变更时构建，常用(需安装<code>GitLab</code>插件)<ul><li>Enabled GitLab triggers<ul><li><code>Push Events</code> 直接推送到此分支时构建(<strong>去勾选</strong>，如直接在 git 客户端将 develop 推送到 test 则无法触发。勾选会产生问题：当在 gitlab 接受 develop 到 test 的请求会产生 2 次构建)</li><li><code>Opened Merge Request Events</code> <strong>去勾选</strong></li><li><code>Accepted Merge Request Events</code> 接受合并请求时构建(<strong>勾选</strong>)</li><li><code>Closed Merge Request Events</code> 去勾选</li><li><code>Approved Merge Requests (EE-only)</code>(勾选，EE-only 表示只有 gitlab 企业版才支持)</li><li><code>Comments</code>(勾选)</li><li><code>Comment (regex) for triggering a build</code> 提交备注正则构建(如：<code>[Jenkins Build]</code>)</li></ul></li><li>Allowed branches 允许触发的分支<ul><li>Filter branches by name - Include 基于名称进行触发，如：<code>test</code>(此时不能写成<code>origin/test</code>)</li><li>Secret token - Generate 生成 token 用于 git webhook 触发</li></ul></li><li>Gitlab 设置 Webhooks(可设置多个)：URL 和 Secret Token 填上文；Trigger 勾选<code>Push events</code>、<code>Tag push events</code>、<code>Merge Request events</code>(gitlab 提供对配置的 url 进行访问可达测试，需要 jenkins 先保存一遍上述生成的 token)。触发流程如下：<ul><li>当开发通过 git 提交代码或进行其他操作触发了 gitlab 此时定义的 Trigger</li><li>然后 gitlab 会对配置的 URL 进行 post</li><li>通过 post 的地址会进入到 jenkins 定义的构建任务中</li><li>jenkins 对触发进行过滤，判断是否需要进行构建</li></ul></li><li>触发相对比较及时，gitlab 产生后会迅速触发到 jenkins(不用刷新项目页面也自动显示新的构建)。jenkins 产生的构建会备注如<ul><li><code>Triggered ​by ​GitLab ​Merge ​Request ​#16: ​my-group-name/develop ​=&gt; test</code> 此时是接受了 develop 到 test 的请求</li><li><code>Started ​by ​GitLab ​push ​by smalle</code> 此时是直接在 git 客户端将 develop 推送到 test</li></ul></li></ul></li><li><code>Gitlab Merge Requests Builder</code> 定时自动生成构建任务(需安装<code>GitLab</code>插件)</li></ul><h4 id="构建环境"><a href="#构建环境" class="headerlink" title="构建环境"></a>构建环境</h4><ul><li>Inject passwords to the build as environment variables<ul><li>Global passwords：导入全局密码到环境变量</li><li>Job passwords：定义当前任务需使用的密码</li><li>如<code>echo ${MY_PASS}</code>最终是以<code>***</code>进行打印</li></ul></li></ul><h4 id="构建-Build"><a href="#构建-Build" class="headerlink" title="构建(Build)"></a>构建(Build)</h4><ul><li><code>执行 shell</code> 在 jenkins 运行的机器上执行命令。构建日志中<code>+</code>表示用户定义的命令</li><li><p><code>Send files or execute commands over SSH</code> 执行 ssh 服务器命令进行构建(需安装插件<code>Publish over SSH</code>)</p><ul><li><p><code>Exec command</code> 执行远程命令(不会记录在 linux 的 history 中)，如</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"build ofbiz start..."</span></span><br><span class="line"><span class="comment"># echo $PATH # 此时打印出的是jenkins本地环境的PATH，而不是远程服务器的</span></span><br><span class="line"><span class="comment"># export PATH=/opt/soft/jdk1.7.0_80/bin:/opt/soft/jdk1.7.0_80/jre/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin # 临时设置PATH为远程服务器PATH，解决java: command not found</span></span><br><span class="line"><span class="comment"># 加载全局配置文件，解决java: command not found</span></span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br><span class="line"><span class="built_in">cd</span> /home/ofbiz/tools</span><br><span class="line">./stopofbiz.sh</span><br><span class="line"><span class="built_in">cd</span> ..</span><br><span class="line">git pull</span><br><span class="line">./ant</span><br><span class="line">nohup bash /home/ofbiz/tools/startofbiz.sh &gt; /dev/null 2&gt;&amp;1 &amp;</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"build ofbiz end..."</span></span><br></pre></td></tr></table></figure><ul><li>其中<code>source /etc/profile</code>为了防止报错<code>java: command not found</code>(jenkins 不会自动加载环境变量)</li><li>当 windows 启动项目 bat 脚本时，一直有输出的话，Dos 窗口会一直处于等待状态，而 jenkins 的构建时会输出 windows 的脚本运行信息，所以 Jenkins 也会一直处于构建状态。此时可考虑 bat 脚本后台运行，如使用<code>.vbe</code>脚本对 bat 文件进行包装</li></ul></li></ul></li><li><p>调用顶层 Maven 目标</p><ul><li>Maven Version：可选择全局工具配置中配置的 maven，若无此选项可参考下文全局工具配置</li><li>Goals：如<code>clean package -Dmaven.test.skip=true</code></li><li>高级 - POM：可自定义 pom 文件位置，如<code>my-module-one/pom.xml</code></li></ul></li></ul><h4 id="构建后操作"><a href="#构建后操作" class="headerlink" title="构建后操作"></a>构建后操作</h4><ul><li><code>E-mail Notification</code> 邮件通知<ul><li>勾选<code>Send e-mail for every unstable build</code>(每次构建失败都会发送邮件，当从构建失败转为构建成功时也会发邮件，之后构建成功则不发送邮件提醒；测试勾选或不勾选都一样)</li><li>多个邮箱使用空格分开</li><li>需要先到系统管理中设置邮件发送服务器，其中 SMTP 发件地址需要和系统管理员邮件地址一致</li></ul></li></ul><h3 id="Pipeline-和-Jenkinsfile-构建"><a href="#Pipeline-和-Jenkinsfile-构建" class="headerlink" title="Pipeline 和 Jenkinsfile 构建"></a>Pipeline 和 Jenkinsfile 构建</h3><blockquote><p>本示例 Jenkins 基于 docker 进行安装。参考：<a href="https://jenkins.io/zh/doc/tutorials/build-a-java-app-with-maven/#run-jenkins-in-docker" target="_blank" rel="noopener">https://jenkins.io/zh/doc/tutorials/build-a-java-app-with-maven/#run-jenkins-in-docker</a></p></blockquote><ul><li>创建 Pipeline：新建 Item - 流水线(Pipeline)</li><li>General、构建触发器、高级项目选项此示例可不用填写(实际可按需填写)</li><li>流水线<ul><li>定义：<code>Pipeline script</code>(在 Jenkins 配置中定义 Pipeline 脚本)、<code>Pipeline script from SCM</code>(从软件配置管理系统，如 Git 仓库获取脚本；可配置脚本所在 Git 仓库的文件路径)</li></ul></li></ul><h4 id="Jenkinsfile"><a href="#Jenkinsfile" class="headerlink" title="Jenkinsfile"></a>Jenkinsfile</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Jenkinsfile(保存在Git仓库的jenkins目录)</span></span><br><span class="line"><span class="comment"># 此时是基于Git仓库进行Jenkins配置的：jenkins会先将源码获取到workspace目录，然后基于当前项目目录执行Jenkinsfile中的指令</span></span><br><span class="line">pipeline &#123;</span><br><span class="line">    agent &#123;</span><br><span class="line">        docker &#123;</span><br><span class="line">            <span class="comment"># 基于maven容器进行构建</span></span><br><span class="line">            <span class="comment"># 此示例Jenkins基于docker进行安装，由于绑定了/var/run/docker.sock，所有在Jenkins容器中可以(在宿主机上)创建启动容器</span></span><br><span class="line">            <span class="comment"># 构建时会在宿主机创建maven的容器(数据保存在宿主机的/root/.m2目录下)</span></span><br><span class="line">            image <span class="string">'maven:3-alpine'</span></span><br><span class="line">            args <span class="string">'-v /root/.m2:/root/.m2'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">'Build'</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">'mvn -B -DskipTests clean package'</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">'Test'</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">'mvn test'</span></span><br><span class="line">            &#125;</span><br><span class="line">            post &#123;</span><br><span class="line">                always &#123;</span><br><span class="line">                    junit <span class="string">'target/surefire-reports/*.xml'</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"># 执行交付/发布步骤</span></span><br><span class="line">        stage(<span class="string">'Deliver'</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                <span class="comment"># 此时当前目录为Git仓库根目录。此处为执行sh命令，如果命令较为复杂一般是保存在sh脚本中</span></span><br><span class="line">                sh <span class="string">'./jenkins/scripts/deliver.sh'</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">## scripts/deliver.sh</span></span><br><span class="line">mvn jar:jar install:install <span class="built_in">help</span>:evaluate -Dexpression=project.name</span><br><span class="line">VERSION=`mvn <span class="built_in">help</span>:evaluate -Dexpression=project.version | grep <span class="string">"^[^\[]"</span>`</span><br><span class="line">NAME=`mvn <span class="built_in">help</span>:evaluate -Dexpression=project.name | grep <span class="string">"^[^\[]"</span>`</span><br><span class="line">java -jar target/<span class="variable">$&#123;NAME&#125;</span>-<span class="variable">$&#123;VERSION&#125;</span>.jar</span><br></pre></td></tr></table></figure><h2 id="构建示例"><a href="#构建示例" class="headerlink" title="构建示例"></a>构建示例</h2><h3 id="Jenkins-Docker-Harbor-Gitlab"><a href="#Jenkins-Docker-Harbor-Gitlab" class="headerlink" title="Jenkins+Docker+Harbor+Gitlab"></a>Jenkins+Docker+Harbor+Gitlab</h3><ul><li>流程图如下 <a href="https://www.jianshu.com/p/358bfb64e3a6" target="_blank" rel="noopener">^2</a></li></ul><p><img src="/data/images/devops/jenkins-docker-gitlab.png" alt="jenkins-docker-gitlab"></p><ul><li>基于 k8s 示例：<a href="http://www.mydlq.club/article/8/#wow10" target="_blank" rel="noopener">http://www.mydlq.club/article/8/#wow10</a></li></ul><h4 id="模式一"><a href="#模式一" class="headerlink" title="模式一"></a>模式一</h4><ul><li>Springboot 项目的 pom.xml 加入打包 docker 插件，并手动推送到镜像仓库(如 Harbor)</li><li>jenkins 任务源码从 gitlab 获取，即设置 Gitlab Webhooks</li><li><p>jenkins 构建时分别执行 maven 打包、给服务器发送启动 docker 命令</p><ul><li>如果是 harbor 构建的镜像，可在 docker 容器中先登录(第一次登录会把认证信息存储起来，下次执行命令无需登录)</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"exec command start..."</span></span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br><span class="line"><span class="built_in">cd</span> /home/smalle/compose/nginx</span><br><span class="line"></span><br><span class="line">sudo docker-compose up -d</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"exec command end..."</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="模式二"><a href="#模式二" class="headerlink" title="模式二"></a>模式二</h4><ul><li>上述流程需要开发先将镜像打包到镜像仓库，此处也可以通过在 jenkins 所在服务器打包(自动处理版本问题)。如下</li><li>构建触发器参考<a href="#构建触发器">构建触发器-Gitlab</a></li><li>构建环境 - Inject passwords to the build as environment variables - 勾选 Global passwords(全局密码在系统设置中添加)</li><li><p>构建 - Execute Shell(打包镜像并上传到 Harbor)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Variables</span></span><br><span class="line">JENKINS_PROJECT_HOME=<span class="string">'/var/jenkins_home/workspace/demo'</span></span><br><span class="line">HARBOR_IP=<span class="string">'192.168.1.100:5000'</span> <span class="comment"># 也可设置成全局变量</span></span><br><span class="line">REPOSITORIES=<span class="string">'test/demo'</span></span><br><span class="line">HARBOR_USER=<span class="string">'test'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 尽管jenkins容器中执行的是宿主机docker命令，且宿主机已经认证过，但此处仍需认证. G_PASS_HARBOR_USER为全局密码变量(Global Passwords)</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;G_PASS_HARBOR_USER&#125;</span> | docker login -u <span class="variable">$&#123;HARBOR_USER&#125;</span> --password-stdin <span class="variable">$&#123;HARBOR_IP&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除本地历史构建的镜像(镜像历史会保存在镜像仓库不用担心丢失)</span></span><br><span class="line">IMAGE_ID=`docker images | grep <span class="variable">$&#123;REPOSITORIES&#125;</span> | awk <span class="string">'&#123;print $3&#125;'</span>`</span><br><span class="line"><span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$&#123;IMAGE_ID&#125;</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    docker rmi <span class="variable">$&#123;IMAGE_ID&#125;</span> || <span class="literal">true</span> <span class="comment"># 执行失败继续执行后续命令。如k8s环境有可能编译节点和运行节点相同导致镜像占用无法删除(未使用的镜像仍然可以删除)</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Build image.</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$&#123;JENKINS_PROJECT_HOME&#125;</span> <span class="comment"># 默认就是项目的工作空间(源码根目录)，此处cd可结合jenkins-agent使用。自定义工作目录可用于k8s-jenkins保存源码目录供下次编译使用，参考下文节点管理</span></span><br><span class="line">DOCKER_TAG=`date +%y%m%d-%H%M%S` <span class="comment"># 190902-165827</span></span><br><span class="line">docker build --rm -t <span class="variable">$&#123;HARBOR_IP&#125;</span>/<span class="variable">$&#123;REPOSITORIES&#125;</span>:<span class="variable">$&#123;DOCKER_TAG&#125;</span> --build-arg APP_VERSION=v<span class="variable">$&#123;DOCKER_TAG&#125;</span> -f ./docker/Dockerfile .</span><br><span class="line"></span><br><span class="line"><span class="comment"># Push to the harbor registry.</span></span><br><span class="line">docker push <span class="variable">$&#123;HARBOR_IP&#125;</span>/<span class="variable">$&#123;REPOSITORIES&#125;</span>:<span class="variable">$&#123;DOCKER_TAG&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存环境变量到工作目录文件中供其他shell使用(配合EnvInject Plugin)</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"DOCKER_TAG=<span class="variable">$&#123;DOCKER_TAG&#125;</span>"</span> &gt; ./env_jenkins.sh</span><br></pre></td></tr></table></figure></li><li><p>构建 - Inject environment variables(注入上一个 shell 的环境变量文件)，参考<a href="#Environment%20Injector(注入环境变量">本文 Environment Injector 插件</a>&gt;)</p></li><li><p>构建 - over SSH(执行 helm 部署 Pod)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HELM_NAME=<span class="string">'demo'</span></span><br><span class="line">sudo /usr/<span class="built_in">local</span>/bin/helm upgrade --<span class="built_in">set</span> image.tag=<span class="variable">$&#123;DOCKER_TAG&#125;</span> <span class="variable">$&#123;HELM_NAME&#125;</span> /root/helm-chart/<span class="built_in">test</span>/<span class="variable">$&#123;HELM_NAME&#125;</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="推荐-Pipeline-K8s-Harbor-Gitlab-Springboot-Maven-可改成Declarative风格"><a href="#推荐-Pipeline-K8s-Harbor-Gitlab-Springboot-Maven-可改成Declarative风格" class="headerlink" title="(推荐)Pipeline+K8s+Harbor+Gitlab+Springboot+Maven(可改成Declarative风格)"></a>(推荐)Pipeline+K8s+Harbor+Gitlab+Springboot+Maven(可改成Declarative风格)</h3><blockquote><p><a href="http://www.mydlq.club/article/8/" target="_blank" rel="noopener">http://www.mydlq.club/article/8/</a></p></blockquote><ul><li>创建项目 - 风格选择 Pipeline</li><li>General：(为了安全)勾选不允许并发构建、(为了提升效率)勾选流水线效率、持久保存设置覆盖(Performance-optimized…)</li><li>构建触发器参考<a href="#构建触发器">构建触发器-Gitlab</a></li><li>流水线 - Pipeline script(另一个选项为 Pipeline script from SCM)<ul><li>勾选<code>使用 Groovy 沙盒</code></li><li>Jenkinsfile 脚本</li></ul></li></ul><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 声明执行Helm的方法</span></span><br><span class="line"><span class="keyword">def</span> helmDeploy(Map args) &#123;</span><br><span class="line">    <span class="keyword">if</span>(args.init) &#123;</span><br><span class="line">        println <span class="string">"Helm 客户端初始化"</span></span><br><span class="line">        sh <span class="string">"helm init --client-only --stable-repo-url https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts"</span></span><br><span class="line">		withCredentials([usernamePassword(<span class="string">credentialsId:</span> <span class="string">'7f3ee3d0-af55-4783-b65d-42cfb22576a8'</span>, <span class="string">passwordVariable:</span> <span class="string">'HELM_REPO_USER_PASS'</span>, <span class="string">usernameVariable:</span> <span class="string">'HELM_REPO_USER'</span>)]) &#123;</span><br><span class="line">			sh <span class="string">"helm repo add aezocn $&#123;args.url&#125; --username $&#123;HELM_REPO_USER&#125; --password $&#123;HELM_REPO_USER_PASS&#125;"</span></span><br><span class="line">		&#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (args.dry_run) &#123;</span><br><span class="line">        println <span class="string">"尝试 Helm 部署，验证是否能正常部署"</span></span><br><span class="line">        sh <span class="string">"helm upgrade --install $&#123;args.name&#125; --namespace $&#123;args.namespace&#125; $&#123;args.values&#125; --set $&#123;args.sets&#125; aezocn/$&#123;args.template&#125; --dry-run --debug"</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        println <span class="string">"正式 Helm 部署"</span></span><br><span class="line">        sh <span class="string">"helm upgrade --install $&#123;args.name&#125; --namespace $&#123;args.namespace&#125; $&#123;args.values&#125; --set $&#123;args.sets&#125; aezocn/$&#123;args.template&#125;"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// jenkins slave 执行流水线任务</span></span><br><span class="line"><span class="comment">// 整个构建超时时间为600s</span></span><br><span class="line">timeout(<span class="string">time:</span> <span class="number">600</span>, <span class="string">unit:</span> <span class="string">'SECONDS'</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="comment">// 代理名称，填写系统设置中设置的 Cloud 中 Template 模板的 label</span></span><br><span class="line">		<span class="keyword">def</span> label = <span class="string">"jnlp-agent"</span></span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 调用Kubernetes提供的方法</span></span><br><span class="line">        podTemplate(<span class="string">label:</span> label, <span class="string">cloud:</span> <span class="string">'kubernetes'</span>) &#123;</span><br><span class="line">			<span class="comment">// 在代理节点上运行脚本</span></span><br><span class="line">			node (label) &#123;</span><br><span class="line">				<span class="comment">// 将源码拉取到当前目录(/home/jenkins/agent/workspace/my-jenkins-project-name/)，即此项目的工作空间</span></span><br><span class="line">				stage(<span class="string">'Git阶段'</span>) &#123;</span><br><span class="line">					git <span class="string">credentialsId:</span> <span class="string">'0c108a09-e321-47c6-bf9c-06626ccd1e4a'</span>, <span class="string">branch:</span> <span class="string">"master"</span>, <span class="string">changelog:</span> <span class="literal">true</span>, <span class="string">url:</span> <span class="string">"$&#123;G_GIT_HTTP_URL&#125;aezocn/test.git"</span></span><br><span class="line">				&#125;</span><br><span class="line">				stage(<span class="string">'Maven阶段'</span>) &#123;</span><br><span class="line">					<span class="comment">// 使用pod中的某个容器</span></span><br><span class="line">					container(<span class="string">'maven'</span>) &#123;</span><br><span class="line">						<span class="comment">// 这里引用上面设置的全局的 settings.xml 文件，根据其ID将其引入并创建该文件</span></span><br><span class="line">						configFileProvider([configFile(<span class="string">fileId:</span> <span class="string">"15263da5-15d5-4bb5-abb7-5cc604def581"</span>, <span class="string">targetLocation:</span> <span class="string">"settings.xml"</span>)]) &#123;</span><br><span class="line">							sh <span class="string">'mvn -f ./oa-dev-center-api/pom.xml clean install -Dmaven.test.skip=true --settings settings.xml'</span></span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				stage(<span class="string">'Docker阶段'</span>) &#123;</span><br><span class="line">					echo <span class="string">"Docker 阶段"</span></span><br><span class="line">					container(<span class="string">'docker'</span>) &#123;</span><br><span class="line">						<span class="comment">// 读取pom参数</span></span><br><span class="line">						echo <span class="string">"读取 pom.xml 参数"</span></span><br><span class="line">						pom = readMavenPom <span class="string">file:</span> <span class="string">'./oa-dev-center-api/pom.xml'</span></span><br><span class="line">						println pom</span><br><span class="line">						<span class="comment">// 设置镜像仓库地址</span></span><br><span class="line">						harbor_host = <span class="string">"$&#123;G_DOCKER_REGISTRY&#125;"</span></span><br><span class="line">						<span class="comment">// 设置仓库项目名</span></span><br><span class="line">						harbor_project_name = <span class="string">"devops"</span></span><br><span class="line">						echo <span class="string">"编译 Docker 镜像"</span></span><br><span class="line">						<span class="comment">// harbor账号id </span></span><br><span class="line">						docker.withRegistry(<span class="string">"http://$&#123;harbor_host&#125;"</span>, <span class="string">"8bbd8356-ff16-4afb-b782-4f253a36d0e1"</span>) &#123;</span><br><span class="line">							echo <span class="string">"构建镜像"</span></span><br><span class="line">							<span class="comment">// 指定dockerfile文件目录打包镜像(如果镜像在当前目录则可不需要第二个参数)，pom里面设置的项目名与版本号打标签</span></span><br><span class="line">							<span class="keyword">def</span> customImage = docker.build(<span class="string">"$&#123;harbor_host&#125;/$&#123;harbor_project_name&#125;/$&#123;pom.artifactId&#125;:$&#123;pom.version&#125;"</span>, <span class="string">"./oa-dev-center-api"</span>)</span><br><span class="line">							echo <span class="string">"推送镜像"</span></span><br><span class="line">							customImage.push()</span><br><span class="line">							echo <span class="string">"删除镜像"</span></span><br><span class="line">							sh <span class="string">"docker rmi $&#123;harbor_host&#125;/$&#123;harbor_project_name&#125;/$&#123;pom.artifactId&#125;:$&#123;pom.version&#125;"</span></span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				stage(<span class="string">'Helm阶段'</span>) &#123;</span><br><span class="line">					container(<span class="string">'helm-kubectl'</span>) &#123;</span><br><span class="line">						<span class="comment">// 此处可直接使用Tiller的sa账号，将sa的token秘钥保存到凭证中</span></span><br><span class="line">						withKubeConfig([<span class="string">credentialsId:</span> <span class="string">"4cd72b9c-c5a0-6e6e-b68a-cc1d3472b694"</span>, <span class="string">serverUrl:</span> <span class="string">"https://kubernetes.default.svc.cluster.local"</span>]) &#123;</span><br><span class="line">							name = <span class="string">"$&#123;pom.artifactId&#125;"</span></span><br><span class="line">							namespace = <span class="string">"devops"</span></span><br><span class="line">							repo_url = <span class="string">"$&#123;G_HELM_REPO_URL&#125;"</span></span><br><span class="line">							template = <span class="string">"springboot --version 1.1.0"</span></span><br><span class="line">							</span><br><span class="line">							<span class="comment">// 检测是否存在yaml文件</span></span><br><span class="line">							<span class="keyword">def</span> values = <span class="string">""</span></span><br><span class="line">							<span class="keyword">if</span> (fileExists(<span class="string">'oa-dev-center-api/devops/values.yaml'</span>)) &#123;</span><br><span class="line">								values = <span class="string">"-f oa-dev-center-api/devops/values.yaml"</span></span><br><span class="line">							&#125;</span><br><span class="line">							</span><br><span class="line">							image = <span class="string">"image.repository=$&#123;harbor_host&#125;/$&#123;harbor_project_name&#125;/$&#123;pom.artifactId&#125;"</span></span><br><span class="line">							tag = <span class="string">"image.tag=$&#123;pom.version&#125;"</span></span><br><span class="line">							pullPolicy = <span class="string">"image.pullPolicy=Always"</span></span><br><span class="line">							now = <span class="keyword">new</span> Date().format(<span class="string">"yyyyMMddHHmmss"</span>)</span><br><span class="line">							env = <span class="string">"evn.BUILD_TIME=$&#123;now&#125;,env.DATABASES_NAME=oa_dev_center,env.DATABASES_HOST=192.168.6.130,env.DATABASES_PORT=3306,env.DATABASES_USER=oa-dev-center,env.DATABASES_PASSWORD=root,env.APP_OPTS='--spring.profiles.active=test'"</span></span><br><span class="line">							sets = <span class="string">"$&#123;image&#125;,$&#123;tag&#125;,$&#123;pullPolicy&#125;,$&#123;env&#125;"</span></span><br><span class="line">							</span><br><span class="line">							<span class="comment">// 执行 Helm 方法</span></span><br><span class="line">							echo <span class="string">"Helm 初始化"</span></span><br><span class="line">							helmDeploy(<span class="string">init:</span> <span class="literal">true</span>, <span class="string">url:</span> <span class="string">"$&#123;repo_url&#125;"</span>);</span><br><span class="line">							echo <span class="string">"Helm 执行部署测试"</span></span><br><span class="line">							helmDeploy(<span class="string">init:</span> <span class="literal">false</span>, <span class="string">dry_run:</span> <span class="literal">true</span>, <span class="string">name:</span> <span class="string">"$&#123;name&#125;"</span>, <span class="string">namespace:</span> <span class="string">"$&#123;namespace&#125;"</span>, <span class="string">template:</span> <span class="string">"$&#123;template&#125;"</span>, <span class="string">values:</span> <span class="string">"$&#123;values&#125;"</span>, <span class="string">sets:</span> <span class="string">"$&#123;sets&#125;"</span>)</span><br><span class="line">							echo <span class="string">"Helm 执行正式部署"</span></span><br><span class="line">							helmDeploy(<span class="string">init:</span> <span class="literal">false</span>, <span class="string">dry_run:</span> <span class="literal">false</span>, <span class="string">name:</span> <span class="string">"$&#123;name&#125;"</span>, <span class="string">namespace:</span> <span class="string">"$&#123;namespace&#125;"</span>, <span class="string">template:</span> <span class="string">"$&#123;template&#125;"</span>, <span class="string">values:</span> <span class="string">"$&#123;values&#125;"</span>, <span class="string">sets:</span> <span class="string">"$&#123;sets&#125;"</span>)</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">		echo <span class="string">"失败。。。"</span></span><br><span class="line">		println e</span><br><span class="line">        currentBuild.result = <span class="string">"FAILURE"</span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// 获取执行状态</span></span><br><span class="line">        <span class="keyword">def</span> currResult = currentBuild.result ?: <span class="string">'SUCCESS'</span></span><br><span class="line">        <span class="comment">// 判断执行任务状态，根据不同状态发送邮件</span></span><br><span class="line">        stage(<span class="string">'email'</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (currResult == <span class="string">'SUCCESS'</span>) &#123;</span><br><span class="line">                echo <span class="string">"发送成功邮件"</span></span><br><span class="line">                emailext <span class="string">body:</span> <span class="string">'$DEFAULT_CONTENT'</span>, <span class="string">postsendScript:</span> <span class="string">'$DEFAULT_POSTSEND_SCRIPT'</span>, <span class="string">presendScript:</span> <span class="string">'$DEFAULT_PRESEND_SCRIPT'</span>, <span class="string">attachLog:</span> <span class="literal">true</span>, <span class="string">compressLog:</span> <span class="literal">true</span>, <span class="string">recipientProviders:</span> [developers()], <span class="string">replyTo:</span> <span class="string">'$DEFAULT_REPLYTO'</span>, <span class="string">subject:</span> <span class="string">'$DEFAULT_SUBJECT'</span>, <span class="string">to:</span> <span class="string">'$DEFAULT_RECIPIENTS;admin@qq.com'</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                echo <span class="string">"发送失败邮件"</span></span><br><span class="line">                emailext <span class="string">body:</span> <span class="string">'$DEFAULT_CONTENT'</span>, <span class="string">postsendScript:</span> <span class="string">'$DEFAULT_POSTSEND_SCRIPT'</span>, <span class="string">presendScript:</span> <span class="string">'$DEFAULT_PRESEND_SCRIPT'</span>, <span class="string">attachLog:</span> <span class="literal">true</span>, <span class="string">compressLog:</span> <span class="literal">true</span>, <span class="string">recipientProviders:</span> [developers()], <span class="string">replyTo:</span> <span class="string">'$DEFAULT_REPLYTO'</span>, <span class="string">subject:</span> <span class="string">'$DEFAULT_SUBJECT'</span>, <span class="string">to:</span> <span class="string">'$DEFAULT_RECIPIENTS;admin@qq.com'</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>springboot 项目配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># git项目文件结构</span></span><br><span class="line">|-- oa-dev-center-web</span><br><span class="line">|-- oa-dev-center-api</span><br><span class="line">|---- src</span><br><span class="line">|---- devops</span><br><span class="line">|------ runboot.sh</span><br><span class="line">|------ values.yaml <span class="comment"># helm charts values.yaml</span></span><br><span class="line">|------ <span class="built_in">wait</span>-for-it.sh</span><br><span class="line">|---- Dockerfile</span><br><span class="line">|---- pom.xml</span><br></pre></td></tr></table></figure></li><li><p>常见问题</p><ul><li>第一次构建可能报错<code>Scripts not permitted to use method org.apache.maven.model.Model getArtifactId</code>，是因为在沙箱环境下 getArtifactId 等脚本方法需要管理员通过才可执行<ul><li>解决：在系统管理 - In-process Script Approval - approved(method org.apache.maven.model.Model getArtifactId)</li></ul></li><li>访问 api server 时，需要对应的 ServiceAccount 账号，此处可直接使用 Tiller 的 sa 账号。获取方式如<code>kubectl get secret $(kubectl get secret -n kube-system|grep tiller-token|awk &#39;{print $1}&#39;) -n kube-system -o jsonpath={.data.token}|base64 -d |xargs echo</code>，将秘钥保存到 jenkins 凭证中获取凭证 ID 供 Pipeline 脚本使用</li></ul></li></ul><h3 id="Pipeline-Declarative-Windows-Gilab"><a href="#Pipeline-Declarative-Windows-Gilab" class="headerlink" title="Pipeline(Declarative)+Windows+Gilab"></a>Pipeline(Declarative)+Windows+Gilab</h3><ul><li>General<ul><li>勾选流水线效率、持久保存设置覆盖</li><li>去勾选不允许并发构建<ul><li>多个触发会创建多个agent来进行构建</li><li>一个触发构建执行完成后会自动删除agent/workspace/job中从git仓库获取的文件，像脚本中创建的不会自动删除</li></ul></li></ul></li><li>构建触发器(其他配置参考上文)<ul><li>选择Filter branches by regex<ul><li>Target Branch Regex如 <code>test|master|fixbug|test-.*</code> (只要目标分支为其中一个就会触发构建)</li></ul></li></ul></li><li>流水线<ul><li>Pipeline script from SCM - Git</li><li>Repository URL 为 <code>${gitlabTargetRepoHttpUrl}</code> (基于gitlab hook注入到jenkins的环境变量自动获取需要构建的git仓库地址)</li><li>Branches to build 为 <code>origin/${gitlabTargetBranch}</code> (自动获取分支)</li><li>脚本路径为<code>devops/Jenkinsfile</code></li><li>轻量级检出</li></ul></li><li>git仓库需要存放<code>devops/Jenkinsfile</code>文件<ul><li>此案例只需要定义一个jenkins job便可构建多个项目。缺点时获取的构建变更不准确</li></ul></li></ul><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * jenkins slave 执行流水线任务。基于windows power shell(可在windows服务器上安装如windows power server来提供ssh服务)，必须通过gitlab触发</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">def</span> context = [:]</span><br><span class="line"><span class="comment">//==============================================================================================================</span></span><br><span class="line"><span class="comment">// 自定义服务器相关参数(发布的服务器共用一套配置即可)</span></span><br><span class="line"><span class="comment">//==============================================================================================================</span></span><br><span class="line"><span class="comment">// 远程服务器，需要在jenkins中配置过</span></span><br><span class="line">context.remoteServerName = <span class="string">'node1'</span></span><br><span class="line"><span class="comment">// 远程服务器SFTP服务根目录，如node1为C:/temp/jenkins</span></span><br><span class="line">context.remoteSftpRoot = <span class="string">'C:/temp/jenkins'</span></span><br><span class="line"><span class="comment">// (构建后台API需要) 远程服务器JAVA_HOME目录。如node1为C:/Program Files/Java/jre1.8.0_181</span></span><br><span class="line">context.remoteJavaHome = <span class="string">'C:/Program Files/Java/jre1.8.0_181'</span></span><br><span class="line"><span class="comment">// (构建后台API需要) 远程服务器RunHiddenConsole程序路径(windows下使程序后台运行)</span></span><br><span class="line">context.remoteRunHiddenConsole = <span class="string">'D:/soft/RunHiddenConsole.exe'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//==============================================================================================================</span></span><br><span class="line"><span class="comment">// ***自定义项目相关参数(每个项目配置不同)***</span></span><br><span class="line"><span class="comment">//==============================================================================================================</span></span><br><span class="line"><span class="comment">// 项目名称(可使用git仓库名或公司唯一项目名)</span></span><br><span class="line">context.projectName = <span class="string">'demo'</span></span><br><span class="line">context.emailToUser = <span class="string">'admin@example.com;system@example.com'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// **是否需要构建后台API**</span></span><br><span class="line">context.apiStage = <span class="literal">true</span></span><br><span class="line"><span class="comment">// API部署在远程服务器的目录</span></span><br><span class="line">context.remoteApiDir = <span class="string">'C:/demo_dir'</span></span><br><span class="line"><span class="comment">// pom.xml文件在git仓库中的相对位置。**相对路径，但不能使用./开头**；pom在git仓库根目录则留空，如果在子目录如 def pomDir = 'my-api/'</span></span><br><span class="line">context.pomDir = <span class="string">''</span></span><br><span class="line"><span class="comment">// 启动jar参数</span></span><br><span class="line">context.startJarArgs = <span class="string">'--spring.profile=test'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// **是否需要构建WEB(不含nginx配置)**</span></span><br><span class="line">context.webStage = <span class="literal">false</span></span><br><span class="line"><span class="comment">// WEB部署在远程服务器的目录</span></span><br><span class="line">context.remoteWebDir = <span class="string">'C:/demo_dir'</span></span><br><span class="line"><span class="comment">// package.json文件在git仓库中的相对位置。**相对路径，但不能使用./开头**；pom在git仓库根目录则留空，如果在子目录如 def pomDir = 'my-web/'</span></span><br><span class="line">context.packageJsonDir = <span class="string">''</span></span><br><span class="line"><span class="comment">// 编译静态包的命令</span></span><br><span class="line">context.npmBuildCommand = <span class="string">"npm run test"</span></span><br><span class="line"><span class="comment">// 编译出的静态包后，需要复制到远程服务器的文件或文件夹路径</span></span><br><span class="line"><span class="comment">// (1)如果需要将编译后的dist放到context.remoteWebDir则填dist/**</span></span><br><span class="line"><span class="comment">// (2)如果需要将dist/index.html、dist/static等文件(不包含dist目录)放到context.remoteWebDir则填["dist/index.html","dist/static/**"]</span></span><br><span class="line">context.distNameArr = [<span class="string">"dist/**"</span>]</span><br><span class="line"><span class="comment">// 移动文件时需要移除的目录前缀，默认无需移除，配合context.distNameArr的场景(1)使用，对于场景(2)则需要填写'dist/'</span></span><br><span class="line">context.removeDistNamePrefix = <span class="string">''</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//==============================================================================================================</span></span><br><span class="line"><span class="comment">// 上传编译文件到服务器并启动和通用参数配置</span></span><br><span class="line"><span class="comment">//==============================================================================================================</span></span><br><span class="line"><span class="comment">// 是否自动发送邮件</span></span><br><span class="line">context.sendEmailFlag = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 上传jar包到服务器并启动</span></span><br><span class="line"><span class="keyword">def</span> sshJarUploadAndExec(Map args) &#123;</span><br><span class="line">    now = <span class="keyword">new</span> Date().format(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>)</span><br><span class="line">    projectDir = <span class="string">"$&#123;args.projectName&#125;-api"</span></span><br><span class="line">    sshPublisher(<span class="string">publishers:</span> [sshPublisherDesc(<span class="string">configName:</span> <span class="string">"$&#123;args.remoteServerName&#125;"</span>, <span class="string">transfers:</span> [</span><br><span class="line">		<span class="comment">// 将编译好文件上传到服务器的sftp目录。sourceFiles基于ant文件命名规范来的</span></span><br><span class="line">        sshTransfer(<span class="string">sourceFiles:</span> <span class="string">"$&#123;args.pomDir&#125;target/$&#123;args.apiJarName&#125;"</span>, <span class="string">removePrefix:</span> <span class="string">"$&#123;args.pomDir&#125;target"</span>, <span class="string">remoteDirectory:</span> <span class="string">"$&#123;projectDir&#125;"</span>, <span class="string">execCommand:</span></span><br><span class="line">            <span class="string">"""</span></span><br><span class="line"><span class="string">            echo running...</span></span><br><span class="line"><span class="string">            # 备份。创建备份目录 C:/demo_dir/demo-bak-10，并将原C:/demo_dir目录下的jar包复制到备份目录</span></span><br><span class="line"><span class="string">            if(-not (test-path "$&#123;args.remoteApiDir&#125;/$&#123;args.projectName&#125;-bak-$&#123;env.BUILD_NUMBER&#125;")) &#123; mkdir "$&#123;args.remoteApiDir&#125;/$&#123;args.projectName&#125;-bak-$&#123;env.BUILD_NUMBER&#125;" &#125;</span></span><br><span class="line"><span class="string">            if(test-path "$&#123;args.remoteApiDir&#125;/$&#123;args.apiJarName&#125;*") &#123; cp "$&#123;args.remoteApiDir&#125;/$&#123;args.apiJarName&#125;*" "$&#123;args.remoteApiDir&#125;/$&#123;args.projectName&#125;-bak-$&#123;env.BUILD_NUMBER&#125;" &#125;</span></span><br><span class="line"><span class="string">            # 停止原进程。基于java.exe的包装文件进行停职进程</span></span><br><span class="line"><span class="string">            if(test-path '$&#123;args.remoteApiDir&#125;/java-$&#123;projectDir&#125;.exe') &#123; tasklist /fo csv | findstr 'java-$&#123;projectDir&#125;.exe' ; if(\$?) &#123; taskkill /f /im java-$&#123;projectDir&#125;.exe ; sleep 10 &#125; &#125;</span></span><br><span class="line"><span class="string">            # 复制文件。1.将java.exe复制到项目录并重命名，之后以此文件启动jar，方便上面停止进程 2.从sftp目录复制编译文件到发布目录</span></span><br><span class="line"><span class="string">            cp "$&#123;args.remoteJavaHome&#125;/bin/java.exe" "$&#123;args.remoteApiDir&#125;/java-$&#123;projectDir&#125;.exe"</span></span><br><span class="line"><span class="string">            cp "$&#123;args.remoteSftpRoot&#125;/$&#123;projectDir&#125;/$&#123;args.apiJarName&#125;" "$&#123;args.remoteApiDir&#125;/$&#123;args.apiJarName&#125;"</span></span><br><span class="line"><span class="string">            # 启动程序。使用RunHiddenConsole和上述重名的java.exe启动jar</span></span><br><span class="line"><span class="string">            $&#123;args.remoteRunHiddenConsole&#125; $&#123;args.remoteApiDir&#125;/java-$&#123;projectDir&#125;.exe -DBUILD_TIME="$&#123;env.BUILD_NUMBER&#125;_$&#123;now&#125;" -jar "$&#123;args.remoteApiDir&#125;/$&#123;args.apiJarName&#125;" $&#123;args.startJarArgs&#125;</span></span><br><span class="line"><span class="string">            """</span></span><br><span class="line">        )</span><br><span class="line">    ])])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 上传前台静态文件到服务器</span></span><br><span class="line"><span class="keyword">def</span> sshWebUpload(Map args) &#123;</span><br><span class="line">    projectDir = <span class="string">"$&#123;args.projectName&#125;-web"</span></span><br><span class="line">    sourceFileStr = <span class="string">""</span></span><br><span class="line">    backupDirStrCommand = <span class="string">""</span></span><br><span class="line">    rmDirStrCommand = <span class="string">""</span></span><br><span class="line">    moveDirCommand = <span class="string">""</span></span><br><span class="line">	<span class="comment">// 基于配置的文件或文件夹组装命令</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i &lt; args.distNameArr.size(); i++) &#123;</span><br><span class="line">        dir = args.distNameArr.get(i)</span><br><span class="line">        sourceFileStr += <span class="string">"$&#123;args.packageJsonDir&#125;$&#123;dir&#125;"</span></span><br><span class="line">        <span class="keyword">if</span>((i+<span class="number">1</span>) != args.distNameArr.size()) &#123;</span><br><span class="line">            sourceFileStr +=<span class="string">","</span></span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">// 去掉文件夹的/**，防止复制文件夹中文件时漏复制文件夹本身</span></span><br><span class="line">        dir = <span class="string">"\$('$&#123;dir&#125;' -replace '/\\**\$','')"</span></span><br><span class="line">        removePrefixDir = <span class="string">"\$($&#123;dir&#125; -replace '^$&#123;args.removeDistNamePrefix&#125;','')"</span></span><br><span class="line"></span><br><span class="line">        backupDirStrCommand += <span class="string">"if(test-path \"$&#123;args.remoteWebDir&#125;/$&#123;removePrefixDir&#125;\") &#123; cp -erroraction 'silentlycontinue' -Recurse \"$&#123;args.remoteWebDir&#125;/$&#123;removePrefixDir&#125;\" '$&#123;args.remoteWebDir&#125;/$&#123;args.projectName&#125;-bak-$&#123;env.BUILD_NUMBER&#125;' &#125; \n"</span></span><br><span class="line">        rmDirStrCommand += <span class="string">"if(test-path \"$&#123;args.remoteWebDir&#125;/$&#123;removePrefixDir&#125;\") &#123; rm -Recurse -Force \"$&#123;args.remoteWebDir&#125;/$&#123;removePrefixDir&#125;\" &#125; \n"</span></span><br><span class="line">        moveDirCommand += <span class="string">"if(test-path \"$&#123;args.remoteSftpRoot&#125;/$&#123;projectDir&#125;/$&#123;dir&#125;\") &#123; mv \"$&#123;args.remoteSftpRoot&#125;/$&#123;projectDir&#125;/$&#123;dir&#125;\" '$&#123;args.remoteWebDir&#125;/' &#125; \n"</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sshPublisher(<span class="string">publishers:</span> [sshPublisherDesc(<span class="string">configName:</span> <span class="string">"$&#123;args.remoteServerName&#125;"</span>, <span class="string">transfers:</span> [</span><br><span class="line">        sshTransfer(<span class="string">sourceFiles:</span> <span class="string">"$&#123;sourceFileStr&#125;"</span>, <span class="string">removePrefix:</span> <span class="string">"$&#123;args.packageJsonDir&#125;"</span>, <span class="string">remoteDirectory:</span> <span class="string">"$&#123;projectDir&#125;"</span>, <span class="string">execCommand:</span></span><br><span class="line">            <span class="string">"""</span></span><br><span class="line"><span class="string">            echo running...</span></span><br><span class="line"><span class="string">            # 备份</span></span><br><span class="line"><span class="string">            if(-not (test-path "$&#123;args.remoteWebDir&#125;/$&#123;args.projectName&#125;-bak-$&#123;env.BUILD_NUMBER&#125;")) &#123; mkdir "$&#123;args.remoteWebDir&#125;/$&#123;args.projectName&#125;-bak-$&#123;env.BUILD_NUMBER&#125;" &#125;</span></span><br><span class="line"><span class="string">            $&#123;backupDirStrCommand&#125;</span></span><br><span class="line"><span class="string">            # 删除原文件</span></span><br><span class="line"><span class="string">            $&#123;rmDirStrCommand&#125;</span></span><br><span class="line"><span class="string">            # 复制文件到www目录(需提前将nginx映射到该目录)</span></span><br><span class="line"><span class="string">            $&#123;moveDirCommand&#125;</span></span><br><span class="line"><span class="string">            """</span></span><br><span class="line">        )</span><br><span class="line">    ])])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pipeline &#123;</span><br><span class="line">    agent &#123;</span><br><span class="line">        label <span class="string">"jnlp-agent"</span></span><br><span class="line">    &#125;</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">'Git阶段'</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                script &#123;</span><br><span class="line">					<span class="comment">// 如果提交的标题有[ci skip]则跳过此次构建</span></span><br><span class="line">                    result = sh (<span class="string">script:</span> <span class="string">"echo \$gitlabMergeRequestTitle | grep '\\[ci skip\\]' | wc -l"</span>, <span class="string">returnStdout:</span> <span class="literal">true</span>)</span><br><span class="line">                    <span class="keyword">if</span> (result == <span class="string">"1\n"</span>) &#123;</span><br><span class="line">                        context.sendEmailFlag = <span class="literal">false</span></span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> hudson.AbortException(<span class="string">'[ci skip]'</span>)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">"构建阶段"</span>) &#123;</span><br><span class="line">            parallel &#123;</span><br><span class="line">                stage(<span class="string">'API构建阶段'</span>) &#123;</span><br><span class="line">                    when &#123;</span><br><span class="line">                        expression &#123;</span><br><span class="line">							<span class="comment">// 如果提交的标题有[ci skip api]则跳过API构建</span></span><br><span class="line">                            result = sh (<span class="string">script:</span> <span class="string">"echo \$gitlabMergeRequestTitle | grep '\\[ci skip api\\]' | wc -l"</span>, <span class="string">returnStdout:</span> <span class="literal">true</span>)</span><br><span class="line">                            <span class="keyword">return</span> context.apiStage &amp;&amp; result == <span class="string">"0\n"</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    options &#123;</span><br><span class="line">                        timeout(<span class="string">time:</span> <span class="number">600</span>, <span class="string">unit:</span> <span class="string">"SECONDS"</span>)</span><br><span class="line">                    &#125;</span><br><span class="line">                    stages &#123;</span><br><span class="line">                        stage(<span class="string">'Maven阶段'</span>) &#123;</span><br><span class="line">                            steps &#123;</span><br><span class="line">                                script &#123;</span><br><span class="line">                                    container(<span class="string">'maven'</span>) &#123;</span><br><span class="line">                                        configFileProvider([configFile(<span class="string">fileId:</span> <span class="string">"15263da5-15d5-4bb5-abb7-5dd604def581"</span>, <span class="string">targetLocation:</span> <span class="string">"settings.xml"</span>)]) &#123;</span><br><span class="line">                                            sh (<span class="string">script:</span> <span class="string">"mvn -f $&#123;context.pomDir&#125;pom.xml clean install -Dmaven.test.skip=true --settings settings.xml"</span>)</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        stage(<span class="string">'上传JAR包并启动阶段'</span>) &#123;</span><br><span class="line">                            steps &#123;</span><br><span class="line">                                script &#123;</span><br><span class="line">                                    pom = readMavenPom <span class="string">file:</span> <span class="string">"$&#123;context.pomDir&#125;pom.xml"</span></span><br><span class="line">                                    context.apiJarName = <span class="string">"$&#123;pom.artifactId&#125;-$&#123;pom.version&#125;.jar"</span></span><br><span class="line">                                    sshJarUploadAndExec(context)</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                stage(<span class="string">'WEB构建阶段'</span>) &#123;</span><br><span class="line">                    when &#123;</span><br><span class="line">                        expression &#123;</span><br><span class="line">                            result = sh (<span class="string">script:</span> <span class="string">"echo \$gitlabMergeRequestTitle | grep '\\[ci skip web\\]' | wc -l"</span>, <span class="string">returnStdout:</span> <span class="literal">true</span>)</span><br><span class="line">                            <span class="keyword">return</span> context.webStage &amp;&amp; result == <span class="string">"0\n"</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    options &#123;</span><br><span class="line">                        timeout(<span class="string">time:</span> <span class="number">1200</span>, <span class="string">unit:</span> <span class="string">"SECONDS"</span>)</span><br><span class="line">                    &#125;</span><br><span class="line">                    stages &#123;</span><br><span class="line">                        stage(<span class="string">'NodeJS编译阶段'</span>) &#123;</span><br><span class="line">                            steps &#123;</span><br><span class="line">                                script &#123;</span><br><span class="line">                                    container(<span class="string">'nodejs'</span>) &#123;</span><br><span class="line">                                        packageJsonDir = context.packageJsonDir</span><br><span class="line">                                        <span class="keyword">if</span>(packageJsonDir == <span class="string">""</span>) &#123;</span><br><span class="line">                                            packageJsonDir = <span class="string">"./"</span></span><br><span class="line">                                        &#125;</span><br><span class="line">                                        sh <span class="string">"""</span></span><br><span class="line"><span class="string">                                        cd $&#123;packageJsonDir&#125;</span></span><br><span class="line"><span class="string">                                        # npm i mirror-config-china --registry=https://registry.npm.taobao.org # electron等应用可能需要</span></span><br><span class="line"><span class="string">                                        npm install --registry=$&#123;G_NPM_REGISTRY&#125;</span></span><br><span class="line"><span class="string">                                        $&#123;context.npmBuildCommand&#125;</span></span><br><span class="line"><span class="string">                                        """</span></span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        stage(<span class="string">'上传前台编译包'</span>) &#123;</span><br><span class="line">                            steps &#123;</span><br><span class="line">                                script &#123;</span><br><span class="line">                                    sshWebUpload(context)</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    post &#123;</span><br><span class="line">        always &#123;</span><br><span class="line">            script &#123;</span><br><span class="line">                echo <span class="string">"是否发送邮件: $&#123;context.sendEmailFlag&#125;"</span></span><br><span class="line">                <span class="keyword">if</span>(context.sendEmailFlag) &#123;</span><br><span class="line">                    <span class="keyword">def</span> currResult = currentBuild.result ?: <span class="string">'SUCCESS'</span></span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (currResult == <span class="string">'SUCCESS'</span>) &#123;</span><br><span class="line">                        echo <span class="string">"发送成功邮件"</span></span><br><span class="line">                        emailext <span class="string">body:</span> <span class="string">'$DEFAULT_CONTENT'</span>, <span class="string">postsendScript:</span> <span class="string">'$DEFAULT_POSTSEND_SCRIPT'</span>, <span class="string">presendScript:</span> <span class="string">'$DEFAULT_PRESEND_SCRIPT'</span>, <span class="string">attachLog:</span> <span class="literal">true</span>,</span><br><span class="line"><span class="symbol">                                subject:</span> <span class="string">"\$PROJECT_NAME: \$BUILD_STATUS! (Build: #\$BUILD_NUMBER, Repo: $&#123;gitlabTargetRepoHttpUrl&#125;, Target Branch: origin/$&#123;gitlabTargetBranch&#125;)"</span>,</span><br><span class="line"><span class="symbol">                                recipientProviders:</span> [developers()], <span class="string">replyTo:</span> <span class="string">'$DEFAULT_REPLYTO'</span>, <span class="string">to:</span> <span class="string">"\$DEFAULT_RECIPIENTS;$&#123;context.emailToUser&#125;"</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        echo <span class="string">"发送失败邮件"</span></span><br><span class="line">                        emailext <span class="string">body:</span> <span class="string">'$DEFAULT_CONTENT'</span>, <span class="string">postsendScript:</span> <span class="string">'$DEFAULT_POSTSEND_SCRIPT'</span>, <span class="string">presendScript:</span> <span class="string">'$DEFAULT_PRESEND_SCRIPT'</span>, <span class="string">attachLog:</span> <span class="literal">true</span>,</span><br><span class="line"><span class="symbol">                                subject:</span> <span class="string">"\$PROJECT_NAME: \$BUILD_STATUS! (Build: #\$BUILD_NUMBER, Repo: $&#123;gitlabTargetRepoHttpUrl&#125;, Target Branch: origin/$&#123;gitlabTargetBranch&#125;)"</span>,</span><br><span class="line"><span class="symbol">                                recipientProviders:</span> [developers()], <span class="string">replyTo:</span> <span class="string">'$DEFAULT_REPLYTO'</span>, <span class="string">to:</span> <span class="string">"\$DEFAULT_RECIPIENTS;$&#123;context.emailToUser&#125;"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="系统管理-Manage-Jenkins"><a href="#系统管理-Manage-Jenkins" class="headerlink" title="系统管理(Manage Jenkins)"></a>系统管理(Manage Jenkins)</h2><h3 id="系统设置-Configure-System"><a href="#系统设置-Configure-System" class="headerlink" title="系统设置(Configure System)"></a>系统设置(Configure System)</h3><ul><li>主目录：基于 docker 安装时一般为<code>/var/jenkins_home</code></li><li>全局属性<ul><li>环境变量：自定义全局环境变量，在所有任务中均可使用</li></ul></li><li>Jenkins Location<ul><li>Jenkins URL：jenkins 的路径，如：<code>http://192.168.1.100:8080/</code>。如果此处配置成外网，当通过内网访问时会提示<code>反向代理设置有误</code>，但是不影响使用。发送的邮件中一般会用到此地址</li><li>系统管理员邮件地址：此地址需要和 SMTP 发件地址一致，如：<code>aezo-jenkins&lt;test@example.com&gt;</code>(from 地址可添加昵称：<code>昵称&lt;from&gt;</code>)</li></ul></li><li>Global Passwords：全局密码(Pipeline 无法使用，但可配合 withCredentials 使用凭证功能)<ul><li>使用：通过【构建环境-Inject passwords to the build as environment variables】导入密码到环境变量</li></ul></li><li>邮件通知：配置 smtp 服务器<ul><li>SMTP server 不能带端口</li><li>其中 SMTP 发件地址需要和系统管理员邮件地址一致</li></ul></li><li>Publish over SSH<ul><li>SSH Servers：配置目标服务器，高级功能中可使用 HTTP/SOCKS5 代理(可能存在测试代理连接失败 BUG，但是可以正常使用)</li></ul></li></ul><h3 id="全局工具配置-Global-Tool-Configuration"><a href="#全局工具配置-Global-Tool-Configuration" class="headerlink" title="全局工具配置(Global Tool Configuration)"></a>全局工具配置(Global Tool Configuration)</h3><ul><li>Maven <a href="https://www.jianshu.com/p/7883c251eb09" target="_blank" rel="noopener">^1</a><ul><li>安装 Jenkins 默认不含 maven，可通过下列方法解决<ul><li>docker 安装 Jenkins 时，pipeline 风格可在<code>agant</code>中运行 maven 镜像</li><li>自由风格可使用宿主机 maven 或通过 jenkins 自动安装</li></ul></li><li>使用宿主机 maven 配置：Name<code>maven3.6</code>；去勾选自动安装；MAVEN_HOME 填写宿主机目录(如果是 docker 安装的 jenkins 可将本地 maven 安装目录挂载到容器目录如/var/maven_home，然后此处使用/var/maven_home)</li><li>通过 jenkins 自动安装<ul><li>配置：Name<code>maven3.6</code>；勾选自动安装；Version<code>3.6.1</code>(之后重新进入此配置页面，可能默认不会显示之前的配置)</li><li>需要安装<code>Maven Integration</code>插件</li><li>进行了上述配置和插件安装默认还是不会自动安装 maven，需要<code>构建一个maven项目</code>，然后构建此项目才会自动安装(安装成功后，在资源风格项目中也可以使用)</li></ul></li><li>自动安装的 maven 插件位置：<code>/data/docker/volumes/jenkins-data/_data/tools/hudson.tasks.Maven_MavenInstallation/maven3.6</code> (基于 docker 安装 jenkins)<ul><li>可修改<code>conf/settings.xml</code>相关配置，如配置阿里云镜像地址</li></ul></li><li>maven 仓库默认保存在宿主机的<code>/root/.m2</code>目录</li></ul></li></ul><h3 id="插件管理"><a href="#插件管理" class="headerlink" title="插件管理"></a>插件管理</h3><ul><li>修改插件镜像地址<ul><li>插件管理 - 高级 - 升级站点URL设置成<code>https://updates.jenkins-zh.cn/update-center.json</code> - 提交 - 立即获取</li></ul></li></ul><h4 id="默认安装插件"><a href="#默认安装插件" class="headerlink" title="默认安装插件"></a>默认安装插件</h4><ul><li>Git(内置 git 客户端)</li></ul><h4 id="其他插件推荐"><a href="#其他插件推荐" class="headerlink" title="其他插件推荐"></a>其他插件推荐</h4><h5 id="Publish-over-SSH-执行远程命令"><a href="#Publish-over-SSH-执行远程命令" class="headerlink" title="Publish over SSH(执行远程命令)"></a>Publish over SSH(执行远程命令)</h5><ul><li><a href="https://github.com/jenkinsci/publish-over-ssh-plugin" target="_blank" rel="noopener">src</a>、<a href="https://wiki.jenkins.io/display/JENKINS/Publish+Over+SSH+Plugin" target="_blank" rel="noopener">wiki</a></li><li>利用此插件可以连接远程 Linux 服务器，进行文件的上传或是命令的提交；也可以连接提供 SSH 服务的 windows 服务器，windows 提供 ssh 服务参考<a href="/_posts/extend/windows.md#ssh服务器">windows.md#ssh 服务器#PowerShell Server</a></li><li>BapSshHostConfiguration#createClient 进行服务器连接</li><li>此插件 1.20.1 界面<code>Test Configuration</code>测试代理连接存在 bug，实际是支持代理连接的</li><li>Pipeline 使用</li></ul><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// configName为系统设置的SSH服务器名</span></span><br><span class="line">sshPublisher(<span class="string">publishers:</span> [sshPublisherDesc(<span class="string">configName:</span> <span class="string">'node1'</span>, <span class="string">transfers:</span> [</span><br><span class="line">    <span class="comment">// 会将匹配到的文件和文件夹(多个用,分割)一起复制到远程目录(会相当于SFTP根目录创建此远程目录)</span></span><br><span class="line">    sshTransfer(<span class="string">sourceFiles:</span> <span class="string">'target/*.jar'</span>, <span class="string">remoteDirectory:</span> <span class="string">'demo'</span>, <span class="string">execCommand:</span></span><br><span class="line">        <span class="string">'''</span></span><br><span class="line"><span class="string">        cd d:/temp</span></span><br><span class="line"><span class="string">        ls</span></span><br><span class="line"><span class="string">        '''</span></span><br><span class="line">    )</span><br><span class="line">])])</span><br></pre></td></tr></table></figure><h5 id="GitLab"><a href="#GitLab" class="headerlink" title="GitLab"></a>GitLab</h5><ul><li><a href="https://github.com/jenkinsci/gitlab-plugin" target="_blank" rel="noopener">wiki</a></li><li>允许 GitLab 触发 Jenkins 构建并在 GitLab UI 中显示结果</li><li>gitlab 触发 webhook 时，会设置一些变量到环境中，如：gitlabTargetRepoHttpUrl、gitlabSourceBranch、gitlabTargetBranch、gitlabMergeRequestTitle、gitlabActionType。详见：<a href="https://github.com/jenkinsci/gitlab-plugin#defined-variables" target="_blank" rel="noopener">https://github.com/jenkinsci/gitlab-plugin#defined-variables</a></li></ul><h5 id="Maven-Integration"><a href="#Maven-Integration" class="headerlink" title="Maven Integration"></a>Maven Integration</h5><ul><li>使用：新建 Item - 构建一个 maven 项目</li><li>项目配置：Goals and options <code>clean install -Dmaven.test.skip=true</code></li></ul><h5 id="Localization-Chinese-Simplified"><a href="#Localization-Chinese-Simplified" class="headerlink" title="Localization: Chinese (Simplified)"></a>Localization: Chinese (Simplified)</h5><ul><li>界面汉化(汉化部分，Local 插件也只能汉化部分)</li></ul><h5 id="Docker-plugin"><a href="#Docker-plugin" class="headerlink" title="Docker plugin"></a>Docker plugin</h5><ul><li>提供使用 jenkins 进行镜像编译、推送到 Harbor 等镜像仓库(也可通过 maven 插件配置 docker 镜像编译和推送)</li></ul><h5 id="Ant"><a href="#Ant" class="headerlink" title="Ant"></a>Ant</h5><ul><li>构建 - 增加构建步骤 - Invoke Ant</li><li>安装的插件不能通过 shell 命令执行 ant</li></ul><h5 id="Environment-Injector-注入环境变量"><a href="#Environment-Injector-注入环境变量" class="headerlink" title="Environment Injector(注入环境变量)"></a>Environment Injector(注入环境变量)</h5><ul><li><a href="https://wiki.jenkins.io/display/JENKINS/EnvInject+Plugin" target="_blank" rel="noopener">wiki</a></li><li><p>同一个 Job 不同 shell 参数传递</p><ul><li>如果涉及到 over SSH 远程命令调用则必须使用文件进行参数传递</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Build - 执行Shell(将环境变量保存到当前工作目录的文件中)</span></span><br><span class="line">DOCKER_TAG=`date +%Y%m%d-%H%M%S`</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"DOCKER_TAG=<span class="variable">$&#123;DOCKER_TAG&#125;</span>"</span> &gt; ./env_jenkins.sh</span><br><span class="line"></span><br><span class="line"><span class="comment">## Build - Inject environment variables(从当前工作目录载入文件读取其环境变量并注入到当前环境)</span></span><br><span class="line">Properties File Path=./env_jenkins.sh</span><br><span class="line"><span class="comment"># Properties Content中也可以定义参数，但是通过本地shell修改后，在over SSH中不能生效(还是拿到原始Properties Content中定义的参数值)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Build - Send files or execute commands over SSH</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;DOCKER_TAG&#125;</span></span><br></pre></td></tr></table></figure></li><li><p>可通过 linux 命令<code>printenv</code>打印所有环境变量</p></li></ul><h5 id="Email-Extension"><a href="#Email-Extension" class="headerlink" title="Email Extension"></a>Email Extension</h5><blockquote><p><a href="https://wiki.jenkins.io/display/JENKINS/Email-ext+plugin" target="_blank" rel="noopener">https://wiki.jenkins.io/display/JENKINS/Email-ext+plugin</a></p></blockquote><ul><li>邮件发送扩展 <a href="https://www.jianshu.com/p/ba0b4faba00c" target="_blank" rel="noopener">^3</a><ul><li>原本 jenkins 自带邮件发送功能，但是不够强大，参考<a href="#系统设置(Configure%20System">系统设置(Configure System)</a>&gt;)</li><li>此扩展可自定义何时(成功、失败等)出发邮件发送</li></ul></li><li>相应配置在【系统管理-系统配置-Extended E-mail Notification】中<ul><li>配置 smtp 认证同 jenkins 自带邮件发送</li><li>Allowed Domains 可配置允许发送邮件的域</li><li>Default Content Type：HTML (text/html)</li><li>Default Subject：【jenkins】$PROJECT_NAME: $BUILD_STATUS! (Build #\$BUILD_NUMBER)</li><li>Default Content：<a href="#Email-Extension-Default-Content">Email-Extension-Default-Content</a></li><li>Default Pre-send Script：可不设置。该脚本将在发送电子邮件之前运行，以允许在发送之前修改电子邮件；也可以通过将布尔变量 cancel 设置为 true 来取消发送电子邮件；在任务设置中可编辑此项或使用\${DEFAULT_PRESEND_SCRIPT}导入此系统配置</li></ul></li><li>任务设置：构建后操作-Editable Email Notification<ul><li>Advanced Settings…<ul><li>Triggers - Add Trigger - [Success(构建成功)/Failure - Any(所有失败)/Always(一直)]<ul><li>Send To：默认选中了<code>Developers</code>这个组。即给此次合并提交所涉及的开发发送邮件(从 git 信息中提取邮箱)</li><li>高级<ul><li>Recipient List：收件人(除了 Send To 中的收件人，此处可额外定义收件人)。如：<a href="mailto:`a@example.com" target="_blank" rel="noopener">`a@example.com</a>,cc:<a href="mailto:b@example.com" target="_blank" rel="noopener">b@example.com</a>,bcc:<a href="mailto:c@example.com" target="_blank" rel="noopener">c@example.com</a>`(CC 抄送，BCC 密件抄送)</li><li>Content Type：HTML (text/html)</li><li>Attach Build Log：Attach Build Log</li></ul></li></ul></li></ul></li></ul></li></ul><h5 id="Kubernetes-连接k8s创建jenkins-agent"><a href="#Kubernetes-连接k8s创建jenkins-agent" class="headerlink" title="Kubernetes(连接k8s创建jenkins-agent)"></a>Kubernetes(连接k8s创建jenkins-agent)</h5><ul><li>在 Kubernetes 集群中运行动态代理节点(agent)的 Jenkins 插件，<a href="https://plugins.jenkins.io/kubernetes" target="_blank" rel="noopener">参考</a></li><li>安装此插件增加的扩展配置：系统管理 - 系统配置 - 云<ul><li>名称：默认<code>kubernetes</code></li><li>Kubernetes 地址：<code>https://kubernetes.default.svc.cluster.local</code>，或者省略<code>svc.cluster.local</code>，即<a href="https://kubernetes.default" target="_blank" rel="noopener">https://kubernetes.default</a></li><li>Kubernetes 命名空间：留空或 default</li><li>凭据：留空(默认使用 jenkins 主 pod 的 ServiceAccount 账号访问 k8 api server)</li><li>Jenkins 地址：<code>http://jenkins.devops:8080</code>，此处 jenkins 基于 k8s 部署，中间表示<code>服务名称.命名空间</code></li><li>Jenkins 通道：agent 通过 jnlp 和 jenkins 通信通道，此处如<code>jenkins-agent.devops:50000</code>(jenkins-agent 为 k8s 服务名，如果 jenkins 普通部署此处填 jenkins 的 hostname 即可)。此处的 50000 需要 k8s 暴露到服务层，对应 jenkins-pod 的端口也是 50000(在系统配置-全局安全配置-代理-TCP port for inbound agents-指定端口 50000)</li><li>添加模板，创建 agent 的 Pod 模板(Kubernetes Pod Template)，可以创建多个模板<ul><li>名称：jnlp-agent</li><li>命名空间：agent-pod 运行的命名空间，留空则和 jenkins-pod 运行于同一空间</li><li>标签列表(label)：<code>jnlp-agent</code> 可用于构建时基于标签选择不同的 Pod Template</li><li>卷(如 agent 需要执行 docker 等命令，可挂载 jenkins pod 宿主机的 docker。下文pod中为在 agent pod 中包含 docker 容器，因此此选项可不操作)<ul><li>增加 Host Path Volume(为了让此 agent 可以调用宿主机的 docker 命令)<ul><li>主机路径、挂载路径：/var/run/docker.sock</li><li>主机路径、挂载路径：/usr/bin/docker</li></ul></li></ul></li><li>Pod 的原始 yaml(具体配置见下文。pod 基础配置，策略为 Override 则表示，上述配置如果和原始 yaml 重复则按照上述配置来)</li><li>Yaml merge strategy：Override</li><li>Show raw yaml in console：勾选表示jenkins构建日志中会显示agent的pod-yaml配置，调试的时候可以勾选</li></ul></li></ul></li><li>Pod 的原始 yaml</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 需要使用空格排版</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">jenkins-slave</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  securityContext:</span> <span class="comment">#容器安全设置</span></span><br><span class="line"><span class="attr">    runAsUser:</span> <span class="number">0</span> <span class="comment">#以ROOT用户运行容器</span></span><br><span class="line"><span class="attr">    privileged:</span> <span class="literal">true</span> <span class="comment">#赋予特权执行容器</span></span><br><span class="line">  <span class="comment"># 如果不需要agent执行如下命令则不行配置容器</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">jnlp</span> <span class="comment">#Jenkins Slave镜像</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">bzyep49h.mirror.aliyuncs.com/jenkins/jnlp-slave:3.27-1</span></span><br><span class="line">      <span class="comment">#设置工作目录</span></span><br><span class="line"><span class="attr">      workingDir:</span> <span class="string">/home/jenkins/agent</span></span><br><span class="line"><span class="attr">      tty:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">docker</span> <span class="comment">#Docker镜像</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">bzyep49h.mirror.aliyuncs.com/library/docker:18.06.2-dind</span></span><br><span class="line"><span class="attr">      command:</span> <span class="string">["cat"]</span></span><br><span class="line"><span class="attr">      tty:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      volumeMounts:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">docker</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/usr/bin/docker</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">docker-sock</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/var/run/docker.sock</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">docker-config</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/etc/docker</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">maven</span> <span class="comment">#Maven镜像</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">bzyep49h.mirror.aliyuncs.com/library/maven:3.6.0-jdk-8-alpine</span></span><br><span class="line"><span class="attr">      command:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">cat</span></span><br><span class="line"><span class="attr">      tty:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      volumeMounts:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">maven-m2</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/root/.m2</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">helm-kubectl</span> <span class="comment">#Kubectl &amp; Helm镜像</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">bzyep49h.mirror.aliyuncs.com/dtzar/helm-kubectl:2.14.3</span></span><br><span class="line"><span class="attr">      command:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">cat</span></span><br><span class="line"><span class="attr">      tty:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">nodejs</span> <span class="comment"># node镜像</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">bzyep49h.mirror.aliyuncs.com/library/node:10.23.0</span></span><br><span class="line"><span class="attr">      command:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">cat</span></span><br><span class="line"><span class="attr">      tty:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  volumes:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">docker</span> <span class="comment">#将宿主机 Docker 文件夹挂进容器，方便存储&amp;拉取本地镜像</span></span><br><span class="line"><span class="attr">      hostPath:</span></span><br><span class="line"><span class="attr">        path:</span> <span class="string">/usr/bin/docker</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">docker-sock</span> <span class="comment">#将宿主机 Docker.sock 挂进容器</span></span><br><span class="line"><span class="attr">      hostPath:</span></span><br><span class="line"><span class="attr">        path:</span> <span class="string">/var/run/docker.sock</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">docker-config</span> <span class="comment">#将宿主机 Docker 配置挂在进入容器</span></span><br><span class="line"><span class="attr">      hostPath:</span></span><br><span class="line"><span class="attr">        path:</span> <span class="string">/etc/docker</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">maven-m2</span> <span class="comment">#Maven 本地仓库挂在到 NFS 共享存储，方便不同节点能同时访问与存储</span></span><br><span class="line"><span class="attr">      nfs:</span></span><br><span class="line"><span class="attr">        server:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.130</span></span><br><span class="line"><span class="attr">        path:</span> <span class="string">"/home/data/nfs/m2"</span></span><br><span class="line"><span class="attr">  affinity:</span></span><br><span class="line"><span class="attr">    nodeAffinity:</span></span><br><span class="line"><span class="attr">      preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line"><span class="attr">        - weight:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">          preference:</span></span><br><span class="line"><span class="attr">            matchExpressions:</span></span><br><span class="line"><span class="bullet">              -</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">                  key:</span> <span class="string">"unilog/jenkins-agent"</span><span class="string">,</span></span><br><span class="line"><span class="attr">                  operator:</span> <span class="string">In,</span></span><br><span class="line"><span class="attr">                  values:</span> <span class="string">["enabled"],</span></span><br><span class="line">                <span class="string">&#125;</span></span><br></pre></td></tr></table></figure><h5 id="Kubernetes-CLI-Plugin"><a href="#Kubernetes-CLI-Plugin" class="headerlink" title="Kubernetes CLI Plugin"></a>Kubernetes CLI Plugin</h5><ul><li>可执行 k8s 命令</li></ul><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 提供 kubectl 执行的环境，其中得设置存储了 token 的凭据ID和 kubernetes api 地址(需要此service account token有权限获取nodes)</span></span><br><span class="line">withKubeConfig([<span class="string">credentialsId:</span> <span class="string">"xxxx-xxxx-xxxx-xxxx"</span>, <span class="string">serverUrl:</span> <span class="string">"https://kubernetes.default.svc.cluster.local"</span>]) &#123;</span><br><span class="line">    sh <span class="string">"kubectl get nodes"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="Config-File-Provider"><a href="#Config-File-Provider" class="headerlink" title="Config File Provider"></a>Config File Provider</h5><ul><li>配置管理 - Managed files</li><li><p>如配置全局 maven 的 setting.xml</p><ul><li>Add a new Config - Global Maven settings.xml - 修改 maven 镜像为阿里云镜像</li><li><p>会生成一个全局 ID，可在 Pipeline 中使用</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">configFileProvider([configFile(<span class="string">fileId:</span> <span class="string">"15263da5-15d5-4bb5-abb7-5dd604def581"</span>, <span class="string">targetLocation:</span> <span class="string">"settings.xml"</span>)]) &#123;</span><br><span class="line">    sh <span class="string">"mvn clean install -Dmaven.test.skip=true --settings settings.xml"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></li></ul><h5 id="Pipeline-Utility-Steps"><a href="#Pipeline-Utility-Steps" class="headerlink" title="Pipeline Utility Steps"></a>Pipeline Utility Steps</h5><ul><li>功能：提取/创建 Zip 文件、生成(yaml)文件、读取 maven 项目的 pom.xml 文件(参数)、读取 properties 文件参数、从工作区中的文件中读取 JSON、在工作区中查找文件</li><li><p>Pipeline 模式下使用</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 读取 pom.xml 文件</span></span><br><span class="line">pom = readMavenPom <span class="string">file:</span> <span class="string">"./pom.xml"</span></span><br><span class="line">echo <span class="string">"$&#123;pom.artifactId&#125;:$&#123;pom.version&#125;"</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="节点管理-Manage-Nodes"><a href="#节点管理-Manage-Nodes" class="headerlink" title="节点管理(Manage Nodes)"></a>节点管理(Manage Nodes)</h3><ul><li>jenkins 支持分布式部署，此处可设置每个节点的构建队列个数</li><li>基于 k8s-helm 运行 jenkins 可配置成自动根据任务量创建 slave 节点。参考<a href="/_posts/devops/helm.md#Jenkins">http://blog.aezo.cn/2019/06/22/devops/helm/</a></li><li>新建节点(agent)<ul><li>远程工作目录如 <code>/var/jenkins_home/jenkins-agent/agent-ofbiz</code>(最终保存于 jenkins-master 家目录；通过此节点构建的项目，其工作空间保存于此目录)</li><li>标签如 <code>agent-ofbiz</code>(配合<a href="#General">General</a>中”限制项目的运行节点”配置使用)</li><li>启动方式 Launch command 如 <code>java -jar /var/jenkins_home/bin/agent.jar</code><ul><li>点击<code>Launch command</code>后面的帮助，可下载<code>agent.jar</code></li><li>需将<code>agent.jar</code>复制到 jenkins-master 家目录的 bin 目录下</li></ul></li><li>可用性，如选择”有需要的时候保持代理在线，当空闲时离线”。对应子配置<code>In demand delay=0; Idle delay=15</code>(任务构建延迟 0 分钟，节点如果空闲 15 分钟则停止)</li><li><strong>基于 k8s-helm 运行 jenkins 存储问题</strong>：任务的工作目录保存在 slave 节点，每次执行完任务后，slave 节点删除，工作空间丢失。此时可自定义一个 agent，用于构建类似 ofbiz 等需要保存工作空间的项目</li></ul></li></ul><h3 id="其他配置"><a href="#其他配置" class="headerlink" title="其他配置"></a>其他配置</h3><h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><ul><li>出现<code>Dependency errors</code>和<code>Downstream dependency errors</code>可根据提示升级对应插件，如果需要升级 jenkins 可以考虑忽略</li></ul><h2 id="jenkins-源码解析"><a href="#jenkins-源码解析" class="headerlink" title="jenkins 源码解析"></a>jenkins 源码解析</h2><ul><li>jenkins 数据全部存储在内存或者文件中，启动 jenkins 前提前设置环境变量<code>JENKINS_HOME</code>则会在此目录生成数据文件.<ul><li>JENKINS_HOME/plugins 为插件目录，安装的插件也都存放于此，如果需要 debugger 插件则将对应插件目录中的 jar 添加到 war 模块的依赖中去</li></ul></li></ul><h3 id="kohsuke"><a href="#kohsuke" class="headerlink" title="kohsuke"></a>kohsuke</h3><blockquote><p>kohsuke 为 jenkins 使用的 servlet 框架，亦是 jenkins 创始人 kohsuke 名字</p></blockquote><ul><li>测试如访问 <a href="http://localhost:8080/api/" target="_blank" rel="noopener">http://localhost:8080/api/</a> 、 <a href="http://localhost:8080/api/json/" target="_blank" rel="noopener">http://localhost:8080/api/json/</a> 、<a href="http://localhost:8080/newJob/" target="_blank" rel="noopener">http://localhost:8080/newJob/</a></li><li>jenkins 中 war 模块为最终打包的入口模块，此模块会引用 core、cli 模块。此模块<code>web.xml</code>配置如下</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>Stapler<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.kohsuke.stapler.Stapler<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>default-encodings<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>text/html=UTF-8<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>diagnosticThreadName<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>false<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">async-supported</span>&gt;</span>true<span class="tag">&lt;/<span class="name">async-supported</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>Stapler<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>Hudson(core)和 Jenkins(core)<ul><li>hudson.model.Hudson extends hudson.model.Jenkins</li><li>hudson.model.Jenkins implements org.kohsuke.stapler.StaplerProxy, org.kohsuke.stapler.StaplerFallback</li></ul></li><li><code>Stapler</code>内中主要的处理方法在<code>tryInvoke</code>中</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">tryInvoke</span><span class="params">(RequestImpl req, ResponseImpl rsp, Object node)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">    <span class="comment">// 刚进入servlet时，此处node初始化为Hudson对象</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断是否为Stapler代理对象</span></span><br><span class="line">    <span class="keyword">if</span> (node <span class="keyword">instanceof</span> StaplerProxy) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (node <span class="keyword">instanceof</span> StaplerOverridable) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取 org.kohsuke.stapler.MetaClass 信息</span></span><br><span class="line">    <span class="comment">// WebApp中会缓存一个Map存放MetaClass，无对应缓存则通过 mc = new MetaClass(this, c); 进行初始化</span></span><br><span class="line">    <span class="comment">// MetaClass 初始化时主要执行了 MetaClass#buildDispatchers() 进行初始化(本质是获取node对象信息组装dispatchers集合，方便后面进行url-method路由)</span></span><br><span class="line">    <span class="comment">// 组织dispatchers顺序(不同的类型使用Dispatcher子类进行添加)</span></span><br><span class="line">    <span class="comment">//      DirectoryishDispatcher</span></span><br><span class="line">    <span class="comment">//      HttpDeletableDispatcher</span></span><br><span class="line">    <span class="comment">//      this.registerDoToken(node) // 注册do开头的函数</span></span><br><span class="line">    <span class="comment">//      node.methods.name("doIndex").iterator()</span></span><br><span class="line">    <span class="comment">//      node.methods.prefix("js").iterator()</span></span><br><span class="line">    <span class="comment">//      node.methods.annotated(JavaScriptMethod.class).iterator()</span></span><br><span class="line">    <span class="comment">//      this.webApp.facets.iterator() // facets里面为模板渲染路由，如 jelly、groovy</span></span><br><span class="line">    <span class="comment">//      node.fields.iterator()</span></span><br><span class="line">    <span class="comment">//      node.methods.prefix("get") // 注册get开头的函数</span></span><br><span class="line">    <span class="comment">//      node.methods.name("doDynamic").iterator()</span></span><br><span class="line">    <span class="comment">//      this.klass.isArray() // klass为node对应的包装对象</span></span><br><span class="line">    <span class="comment">//      this.klass.isMap()</span></span><br><span class="line">    MetaClass metaClass = <span class="keyword">this</span>.webApp.getMetaClass(node);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 基于MetaClass进行url匹配。大部分在此处进行匹配</span></span><br><span class="line">    Iterator var16 = metaClass.dispatchers.iterator();</span><br><span class="line">    <span class="keyword">while</span>(var16.hasNext()) &#123;</span><br><span class="line">        Dispatcher d = (Dispatcher)var16.next();</span><br><span class="line">        <span class="comment">// 参考下午 NameBasedDispatcher 源码解析</span></span><br><span class="line">        <span class="keyword">if</span> (d.dispatch(req, rsp, node)) &#123;</span><br><span class="line">            <span class="comment">// 可在此处打断点，追踪执行的堆栈信息。由于后台会自动刷新，可设置断点条件：`!"/jen/ajaxBuildQueue".equals(req.getOriginalRequestURI()) &amp;&amp; !"/jen/ajaxExecutors".equals(req.getOriginalRequestURI())`</span></span><br><span class="line">            <span class="keyword">if</span> (LOGGER.isLoggable(Level.FINER)) &#123;</span><br><span class="line">                LOGGER.finer(<span class="string">"Handled by "</span> + d);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 返回，response已经完成数据输出</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 最后，当基于方法提取的url未匹配到，则进入到此判断，一些ajax页面是这样生成的 (如访问 http://localhost:8080/newJob/)</span></span><br><span class="line">    <span class="keyword">if</span> (node <span class="keyword">instanceof</span> StaplerFallback) &#123;</span><br><span class="line">        <span class="comment">// 获取此node的StaplerFallback对象，如 hudson.model.AllView，此类会生成一个头尾dom，中间的dom可通过ajax添加进去</span></span><br><span class="line">        Object n = ((StaplerFallback)node).getStaplerFallback();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (n != node &amp;&amp; n != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.invoke(req, rsp, n); <span class="comment">// 最终仍然进入 tryInvoke 进行匹配</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 果然仍然未匹配到则404</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>org.kohsuke.stapler.NameBasedDispatcher extends Dispatcher</code>。如<code>node.methods.prefix(&quot;get&quot;)</code>提出的都是通过<code>NameBasedDispatcher</code>进行包装的</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">dispatch</span><span class="params">(RequestImpl req, ResponseImpl rsp, Object node)</span> <span class="keyword">throws</span> IOException, ServletException, IllegalAccessException, InvocationTargetException </span>&#123;</span><br><span class="line">    <span class="comment">// req.tokens为基于url进行切片。如/api会生成一个["api"]，/api/json会生成一个["api", "json"]</span></span><br><span class="line">    <span class="comment">// req.tokens.peek()提取一个，如访问：http://localhost:8080/api/json/. Stapler首先会进行/api路由，执行Jenkins#getApi；处理完成后通过 req.getStapler().invoke(req, rsp, ff.invoke(req, rsp, node, new Object[0])); 进入到/json路由，此时执行hudson.model.Api#doJson</span></span><br><span class="line">    <span class="keyword">if</span> (req.tokens.hasMore() &amp;&amp; req.tokens.peek().equals(<span class="keyword">this</span>.name)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (req.tokens.countRemainingTokens() &lt;= <span class="keyword">this</span>.argCount) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            req.tokens.next();</span><br><span class="line">            <span class="comment">// 执行路由。内部执行 req.getStapler().invoke(req, rsp, ff.invoke(req, rsp, node, new Object[0])); 跳转到下一个路由</span></span><br><span class="line">            <span class="keyword">boolean</span> b = <span class="keyword">this</span>.doDispatch(req, rsp, node);</span><br><span class="line">            <span class="keyword">if</span> (!b) &#123;</span><br><span class="line">                req.tokens.prev();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> b;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="附件"><a href="#附件" class="headerlink" title="附件"></a>附件</h2><h3 id="Email-Extension-Default-Content"><a href="#Email-Extension-Default-Content" class="headerlink" title="Email-Extension-Default-Content"></a>Email-Extension-Default-Content</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>$&#123;ENV, var="JOB_NAME"&#125;-第$&#123;BUILD_NUMBER&#125;次构建日志<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">      body &#123;</span></span><br><span class="line"><span class="undefined">        font-family: "Microsoft YaHei UI", "Microsoft YaHei", Arial,</span></span><br><span class="line"><span class="undefined">          "Courier New", sans-serif;</span></span><br><span class="line"><span class="undefined">        font-size: 16px;</span></span><br><span class="line"><span class="undefined">        line-height: 20px;</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span></span></span><br><span class="line"><span class="tag">    <span class="attr">leftmargin</span>=<span class="string">"8"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">marginwidth</span>=<span class="string">"0"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">topmargin</span>=<span class="string">"8"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">marginheight</span>=<span class="string">"4"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">offset</span>=<span class="string">"0"</span></span></span><br><span class="line"><span class="tag">  &gt;</span></span><br><span class="line">    (本邮件是程序自动下发，请勿回复！)<span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">width</span>=<span class="string">"95%"</span> <span class="attr">cellpadding</span>=<span class="string">"0"</span> <span class="attr">cellspacing</span>=<span class="string">"0"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">b</span>&gt;</span><span class="tag">&lt;<span class="name">font</span> <span class="attr">color</span>=<span class="string">"#f4a34d"</span>&gt;</span>构建信息<span class="tag">&lt;/<span class="name">font</span>&gt;</span><span class="tag">&lt;/<span class="name">b</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">hr</span> <span class="attr">size</span>=<span class="string">"2"</span> <span class="attr">width</span>=<span class="string">"100%"</span> <span class="attr">align</span>=<span class="string">"center"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>项目名称 ： $&#123;PROJECT_NAME&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>构建编号 ： 第$&#123;BUILD_NUMBER&#125;次构建<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>构建状态 ： <span class="tag">&lt;<span class="name">b</span>&gt;</span>$&#123;BUILD_STATUS&#125;<span class="tag">&lt;/<span class="name">b</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>触发原因： $&#123;CAUSE&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">              构建日志： <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"$&#123;BUILD_URL&#125;console"</span>&gt;</span>$&#123;BUILD_URL&#125;console<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>构建 Url ： <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"$&#123;BUILD_URL&#125;"</span>&gt;</span>$&#123;BUILD_URL&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>工作目录 ： <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"$&#123;PROJECT_URL&#125;ws"</span>&gt;</span>$&#123;PROJECT_URL&#125;ws<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>项目 Url ： <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"$&#123;PROJECT_URL&#125;"</span>&gt;</span>$&#123;PROJECT_URL&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">b</span>&gt;</span><span class="tag">&lt;<span class="name">font</span> <span class="attr">color</span>=<span class="string">"#f4a34d"</span>&gt;</span>变更集<span class="tag">&lt;/<span class="name">font</span>&gt;</span><span class="tag">&lt;/<span class="name">b</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">hr</span> <span class="attr">size</span>=<span class="string">"2"</span> <span class="attr">width</span>=<span class="string">"100%"</span> <span class="attr">align</span>=<span class="string">"center"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--包含构建日志--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">          $&#123;JELLY_SCRIPT,template="html"&#125;<span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">hr</span> <span class="attr">size</span>=<span class="string">"2"</span> <span class="attr">width</span>=<span class="string">"100%"</span> <span class="attr">align</span>=<span class="string">"center"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">        &lt;tr&gt;</span></span><br><span class="line"><span class="comment">            &lt;td&gt;&lt;b&gt;&lt;font color="#f4a34d"&gt;构建日志 (最后 100行)&lt;/font&gt;&lt;/b&gt;</span></span><br><span class="line"><span class="comment">            &lt;hr size="2" width="100%" align="center" /&gt;&lt;/td&gt;</span></span><br><span class="line"><span class="comment">        &lt;/tr&gt;</span></span><br><span class="line"><span class="comment">        &lt;tr&gt;</span></span><br><span class="line"><span class="comment">            &lt;td&gt;$&#123;BUILD_LOG, maxLines=100&#125;&lt;br/&gt;</span></span><br><span class="line"><span class="comment">            &lt;hr size="2" width="100%" align="center" /&gt;&lt;/td&gt;</span></span><br><span class="line"><span class="comment">        &lt;/tr&gt;</span></span><br><span class="line"><span class="comment">        --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><hr><p>参考文章</p></div><div></div><div></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> smalle</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="http://blog.aezo.cn/2018/10/09/devops/jenkins/" title="Jenkins">http://blog.aezo.cn/2018/10/09/devops/jenkins/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/jenkins/" rel="tag"># jenkins</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2018/09/24/lang/python/django-rest-framework/" rel="next" title="Django-Rest-Framework"><i class="fa fa-chevron-left"></i> Django-Rest-Framework</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"> <a href="/2018/10/23/linux/加密解密/" rel="prev" title="加密解密">加密解密<i class="fa fa-chevron-right"></i></a></div></div></footer></article><div class="post-spread"><div> <a target="_blank" href="https://github.com/oldinaction/ChatGPT-MP"><img class="nofancybox" style="width:300px;margin:0 auto" src="https://cdn7.aezo.cn/one/chat/chat-gpt-open-banner.jpg" alt="ChatGPT开源小程序" title="ChatGPT开源小程序"></a></div></div></div></div><div class="comments" id="comments"></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> 文章目录</li><li class="sidebar-nav-overview" data-target="site-overview"> 站点概览</li></ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="https://avatars0.githubusercontent.com/u/15698218?v=3&u=ce740bf0b67ff0d74990ba6fc644d6e92f572dcb&s=400" alt="smalle"><p class="site-author-name" itemprop="name">smalle</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">162</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/index.html"><span class="site-state-item-count">14</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/index.html"><span class="site-state-item-count">146</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"></div><div> 欢迎关注公众号：阿壹族 <img class="nofancybox" style="width:120px;margin:0 auto" src="https://cdn7.aezo.cn/common/qrcode/ayz_qrcode.jpg" alt="欢迎关注公众号：阿壹族" title="欢迎关注公众号：阿壹族"></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#简介"><span class="nav-number">1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装编译及运行"><span class="nav-number">2.</span> <span class="nav-text">安装编译及运行</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#直接安装运行"><span class="nav-number">2.1.</span> <span class="nav-text">直接安装运行</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#直接-docker-命令启动"><span class="nav-number">2.1.1.</span> <span class="nav-text">直接 docker 命令启动</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#基于-docker-compose"><span class="nav-number">2.1.2.</span> <span class="nav-text">基于 docker-compose</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#k8s-helm-启动"><span class="nav-number">2.1.3.</span> <span class="nav-text">k8s-helm 启动</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#手动编译运行"><span class="nav-number">2.2.</span> <span class="nav-text">手动编译运行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#项目文件说明"><span class="nav-number">2.3.</span> <span class="nav-text">项目文件说明</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pipeline"><span class="nav-number">3.</span> <span class="nav-text">Pipeline</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#常用插件命令"><span class="nav-number">3.1.</span> <span class="nav-text">常用插件命令</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#构建"><span class="nav-number">4.</span> <span class="nav-text">构建</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#项目构建界面说明"><span class="nav-number">4.1.</span> <span class="nav-text">项目构建界面说明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#自由风格构建说明"><span class="nav-number">4.2.</span> <span class="nav-text">自由风格构建说明</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#General"><span class="nav-number">4.2.1.</span> <span class="nav-text">General</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#源码管理-Git"><span class="nav-number">4.2.2.</span> <span class="nav-text">源码管理(Git)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#构建触发器"><span class="nav-number">4.2.3.</span> <span class="nav-text">构建触发器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#构建环境"><span class="nav-number">4.2.4.</span> <span class="nav-text">构建环境</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#构建-Build"><span class="nav-number">4.2.5.</span> <span class="nav-text">构建(Build)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#构建后操作"><span class="nav-number">4.2.6.</span> <span class="nav-text">构建后操作</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Pipeline-和-Jenkinsfile-构建"><span class="nav-number">4.3.</span> <span class="nav-text">Pipeline 和 Jenkinsfile 构建</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Jenkinsfile"><span class="nav-number">4.3.1.</span> <span class="nav-text">Jenkinsfile</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#构建示例"><span class="nav-number">5.</span> <span class="nav-text">构建示例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Jenkins-Docker-Harbor-Gitlab"><span class="nav-number">5.1.</span> <span class="nav-text">Jenkins+Docker+Harbor+Gitlab</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#模式一"><span class="nav-number">5.1.1.</span> <span class="nav-text">模式一</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#模式二"><span class="nav-number">5.1.2.</span> <span class="nav-text">模式二</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#推荐-Pipeline-K8s-Harbor-Gitlab-Springboot-Maven-可改成Declarative风格"><span class="nav-number">5.2.</span> <span class="nav-text">(推荐)Pipeline+K8s+Harbor+Gitlab+Springboot+Maven(可改成Declarative风格)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Pipeline-Declarative-Windows-Gilab"><span class="nav-number">5.3.</span> <span class="nav-text">Pipeline(Declarative)+Windows+Gilab</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#系统管理-Manage-Jenkins"><span class="nav-number">6.</span> <span class="nav-text">系统管理(Manage Jenkins)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#系统设置-Configure-System"><span class="nav-number">6.1.</span> <span class="nav-text">系统设置(Configure System)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#全局工具配置-Global-Tool-Configuration"><span class="nav-number">6.2.</span> <span class="nav-text">全局工具配置(Global Tool Configuration)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#插件管理"><span class="nav-number">6.3.</span> <span class="nav-text">插件管理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#默认安装插件"><span class="nav-number">6.3.1.</span> <span class="nav-text">默认安装插件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#其他插件推荐"><span class="nav-number">6.3.2.</span> <span class="nav-text">其他插件推荐</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Publish-over-SSH-执行远程命令"><span class="nav-number">6.3.2.1.</span> <span class="nav-text">Publish over SSH(执行远程命令)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#GitLab"><span class="nav-number">6.3.2.2.</span> <span class="nav-text">GitLab</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Maven-Integration"><span class="nav-number">6.3.2.3.</span> <span class="nav-text">Maven Integration</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Localization-Chinese-Simplified"><span class="nav-number">6.3.2.4.</span> <span class="nav-text">Localization: Chinese (Simplified)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Docker-plugin"><span class="nav-number">6.3.2.5.</span> <span class="nav-text">Docker plugin</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Ant"><span class="nav-number">6.3.2.6.</span> <span class="nav-text">Ant</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Environment-Injector-注入环境变量"><span class="nav-number">6.3.2.7.</span> <span class="nav-text">Environment Injector(注入环境变量)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Email-Extension"><span class="nav-number">6.3.2.8.</span> <span class="nav-text">Email Extension</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Kubernetes-连接k8s创建jenkins-agent"><span class="nav-number">6.3.2.9.</span> <span class="nav-text">Kubernetes(连接k8s创建jenkins-agent)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Kubernetes-CLI-Plugin"><span class="nav-number">6.3.2.10.</span> <span class="nav-text">Kubernetes CLI Plugin</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Config-File-Provider"><span class="nav-number">6.3.2.11.</span> <span class="nav-text">Config File Provider</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Pipeline-Utility-Steps"><span class="nav-number">6.3.2.12.</span> <span class="nav-text">Pipeline Utility Steps</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#节点管理-Manage-Nodes"><span class="nav-number">6.4.</span> <span class="nav-text">节点管理(Manage Nodes)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#其他配置"><span class="nav-number">6.5.</span> <span class="nav-text">其他配置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#常见问题"><span class="nav-number">7.</span> <span class="nav-text">常见问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#jenkins-源码解析"><span class="nav-number">8.</span> <span class="nav-text">jenkins 源码解析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#kohsuke"><span class="nav-number">8.1.</span> <span class="nav-text">kohsuke</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#附件"><span class="nav-number">9.</span> <span class="nav-text">附件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Email-Extension-Default-Content"><span class="nav-number">9.1.</span> <span class="nav-text">Email-Extension-Default-Content</span></a></li></ol></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright"> &copy; 2016 - <span itemprop="copyrightYear">2023</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">smalle</span>&nbsp;&nbsp;&nbsp;&nbsp;<div class="powered-by"> 由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div><div class="powered-by"> 主题 - <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a></div><div class="theme-info"> <a class="theme-link" target="_blank" href="https://tongji.baidu.com/main/overview/10000542408/overview/index?siteId=18991897">站长统计</a></div></div><div class="ad"> <span style="font-weight:700">AD&nbsp;&nbsp;&nbsp;&nbsp;</span><div class="theme-info"> <a target="_blank" href="https://promotion.aliyun.com/ntms/yunparter/invite.html?userCode=oby5nolb">阿里云大礼包</a></div></div><div class="aezocn"> <span style="font-weight:700">&copy;AEZO.CN&nbsp;&nbsp;&nbsp;&nbsp;</span><div class="powered-by"> <a target="_blank" href="https://shengqitech.aezo.cn/">圣骑科技</a></div><div class="powered-by"> <a target="_blank" href="https://cdn7.aezo.cn/common/qrcode/one_qrcode.jpg">【One能抽屉】小程序</a></div><div class="theme-info"> <a target="_blank" href="http://shop.aezo.cn/">杂货铺(省钱小助手)</a></div></div><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?085f9cd91ef2ad985f791c677472f0d1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script><script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script type="text/javascript" src="/js/src/js.cookie.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/scroll-cookie.js?v=5.1.1"></script></body></html>