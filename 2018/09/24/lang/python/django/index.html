<!doctype html><html class="theme-next mist use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css"><meta name="keywords" content="python,django,"><link rel="alternate" href="/atom.xml" title="Smalle's Blog | AEZOCN" type="application/atom+xml"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1"><meta name="description" content="简介 官网  manage命令1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950# python manage.py &amp;lt;xxx&amp;gt;python manage.py [xxx] --help# 以下为内置命令，也可扩展命令[auth]    changepas"><meta name="keywords" content="python,django"><meta property="og:type" content="article"><meta property="og:title" content="Django"><meta property="og:url" content="http://blog.aezo.cn/2018/09/24/lang/python/django/index.html"><meta property="og:site_name" content="Smalle&#39;s Blog | AEZOCN"><meta property="og:description" content="简介 官网  manage命令1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950# python manage.py &amp;lt;xxx&amp;gt;python manage.py [xxx] --help# 以下为内置命令，也可扩展命令[auth]    changepas"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="http://blog.aezo.cn/data/images/lang/django-request.png"><meta property="og:updated_time" content="2021-08-31T06:07:20.362Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Django"><meta name="twitter:description" content="简介 官网  manage命令1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950# python manage.py &amp;lt;xxx&amp;gt;python manage.py [xxx] --help# 以下为内置命令，也可扩展命令[auth]    changepas"><meta name="twitter:image" content="http://blog.aezo.cn/data/images/lang/django-request.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",sidebar:{position:"right",display:"post",offset:12,offset_float:0,b2t:!1,scrollpercent:!1},fancybox:!0,motion:!0,duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"BWD6R9FA4K",apiKey:"3330f3cbaa099dfc30395de5f5b20151",indexName:"blog",hits:{per_page:10},labels:{input_placeholder:"请输入关键字",hits_empty:"我们没有找到任何搜索结果: ${query}",hits_stats:"找到约${hits}条结果（用时${time}ms）"}}}</script><link rel="canonical" href="http://blog.aezo.cn/2018/09/24/lang/python/django/"><title>Django | Smalle's Blog | AEZOCN</title><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?d82223039d601f2f819f8fe140a63468";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><div style="display:none"><script src="//s95.cnzz.com/z_stat.php?id=cnzz_stat_icon_1276691827&web_id=cnzz_stat_icon_1276691827" language="JavaScript"></script></div></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-right page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Smalle's Blog | AEZOCN</span><span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">Better Code, Better Life</h1></div><div class="site-nav-toggle"> <button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br> 首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br> 分类</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br> 关于</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br> 归档</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br> 标签</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i><br> 站点地图</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br> 搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"> <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><link itemprop="mainEntityOfPage" href="http://blog.aezo.cn/2018/09/24/lang/python/django/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="smalle"><meta itemprop="description" content=""><meta itemprop="image" content="https://avatars0.githubusercontent.com/u/15698218?v=3&u=ce740bf0b67ff0d74990ba6fc644d6e92f572dcb&s=400"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Smalle's Blog | AEZOCN"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">Django</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-24T21:29:00+08:00">2018-09-24</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/lang/" itemprop="url" rel="index"><span itemprop="name">lang</span></a></span></span></div></header><div class="post-body" itemprop="articleBody"><div></div><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><ul><li><a href="https://www.djangoproject.com/" target="_blank" rel="noopener">官网</a></li></ul><h2 id="manage命令"><a href="#manage命令" class="headerlink" title="manage命令"></a>manage命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># python manage.py &lt;xxx&gt;</span></span><br><span class="line">python manage.py [xxx] --<span class="built_in">help</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 以下为内置命令，也可扩展命令</span></span><br><span class="line">[auth]</span><br><span class="line">    changepassword</span><br><span class="line">    createsuperuser     <span class="comment"># python manage.py createsuperuser --email admin@aezo.cn --username admin # 输入密码admin888</span></span><br><span class="line">[authtoken]</span><br><span class="line">    drf_create_token</span><br><span class="line">[contenttypes]</span><br><span class="line">    remove_stale_contenttypes</span><br><span class="line">[django]</span><br><span class="line">    check</span><br><span class="line">    compilemessages</span><br><span class="line">    createcachetable</span><br><span class="line">    dbshell             <span class="comment"># 进入数据库命令行</span></span><br><span class="line">    diffsettings</span><br><span class="line">    dumpdata</span><br><span class="line">    flush</span><br><span class="line">    inspectdb           <span class="comment"># 根据数据库表结构生成django模型</span></span><br><span class="line">    loaddata</span><br><span class="line">    makemessages</span><br><span class="line">    makemigrations      <span class="comment"># 根据models.py的定义生成表结构迁移文件，每执行一次就会在migrations文件夹内生成一个文件</span></span><br><span class="line">    migrate             <span class="comment"># 执行迁移文件(将所有app，包括内置app下的迁移全部依次执行)到数据库。每次执行会先判断migrations文件夹下的文件在django_migrations表中是否存在，不存在则执行，并将执行记录保存在django_migrations表中</span></span><br><span class="line">        --fake APP_NAME zero <span class="comment"># 仅将my_app中的迁移添加到django_migrations表(生成一条假记录)，不会真正执行SQL</span></span><br><span class="line">    sendtestemail</span><br><span class="line">    shell               <span class="comment"># 进入django的shell环境</span></span><br><span class="line">    showmigrations      <span class="comment"># 查看迁移</span></span><br><span class="line">    sqlflush</span><br><span class="line">    sqlmigrate</span><br><span class="line">    sqlsequencereset</span><br><span class="line">    squashmigrations</span><br><span class="line">    startapp            <span class="comment"># 创建App</span></span><br><span class="line">    startproject        <span class="comment"># 新建一个项目</span></span><br><span class="line">    <span class="built_in">test</span></span><br><span class="line">    testserver</span><br><span class="line">[sessions]</span><br><span class="line">    clearsessions</span><br><span class="line">[staticfiles]</span><br><span class="line">    collectstatic       <span class="comment"># 收集资源文件，参考下文[静态资源](#静态资源)</span></span><br><span class="line">        --noinput       <span class="comment"># 如果静态资源目录有文件则需确认，加上此参数则跳过确认</span></span><br><span class="line">    findstatic</span><br><span class="line">    runserver           <span class="comment"># 启动项目。eg：python manage.py runserver 0.0.0.0:8000 # 启动项目(开启局域网访问)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 举例</span></span><br><span class="line">python manage.py startapp myapp     <span class="comment"># 创建App</span></span><br><span class="line">python manage.py makemigrations     <span class="comment"># 生成迁移</span></span><br><span class="line">python manage.py migrate            <span class="comment"># 执行迁移(将所有app，包括内置app下的迁移全部依次执行)</span></span><br><span class="line">python manage.py collectstatic      <span class="comment"># 收集资源文件</span></span><br><span class="line">python manage.py runserver          <span class="comment"># 启动项目</span></span><br></pre></td></tr></table></figure><h2 id="hello-world"><a href="#hello-world" class="headerlink" title="hello world"></a>hello world</h2><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### urls.py 项目入口urls</span></span><br><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path, include</span><br><span class="line"><span class="keyword">from</span> monitor <span class="keyword">import</span> urls <span class="keyword">as</span> monitor_urls</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r'^'</span>, admin.site.urls),  <span class="comment"># 如果域名后面没有指定路径就匹配这一条规则</span></span><br><span class="line">    path(<span class="string">'favicon.ico'</span>, RedirectView.as_view(url=<span class="string">'static/theme/default/images/favicon.ico'</span>)),</span><br><span class="line">    url(<span class="string">r'^static/(?P&lt;path&gt;.*)$'</span>, static.serve, &#123;<span class="string">'document_root'</span>: settings.STATIC_ROOT&#125;, name=<span class="string">'static'</span>),  <span class="comment"># 静态资源地址</span></span><br><span class="line"></span><br><span class="line">    path(<span class="string">'admin/'</span>, admin.site.urls),</span><br><span class="line">    path(<span class="string">'monitor/'</span>, include(monitor_urls)),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">### app/urls.py 子模块urls</span></span><br><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url</span><br><span class="line"><span class="keyword">from</span> monitor <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r'^hello$'</span>, views.HelloView.as_view()),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">### app/views.py</span></span><br><span class="line"><span class="keyword">from</span> django.views <span class="keyword">import</span> View</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloView</span><span class="params">(View)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="comment"># 使用模板(templates/monitor/index.html)：相对于templates目录的路径，且必须在`INSTALLED_APPS`中加入本app(如：'apps.monitor')</span></span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">'monitor/index.html'</span>, &#123;</span><br><span class="line">            <span class="string">'my_msg'</span>: <span class="string">"welcome"</span>,</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="comment"># self.dispatch()</span></span><br><span class="line">        <span class="keyword">if</span> request.user.username == <span class="string">'admin'</span>:  <span class="comment"># 通过/admin登录后，默认会保存user到session中</span></span><br><span class="line">            <span class="keyword">return</span> HttpResponse(<span class="string">'hello world...'</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> HttpResponse(<span class="string">'please login...'</span>)</span><br></pre></td></tr></table></figure><h2 id="Model"><a href="#Model" class="headerlink" title="Model"></a>Model</h2><blockquote><p><a href="http://www.cnblogs.com/wupeiqi/articles/5246483.html" target="_blank" rel="noopener">http://www.cnblogs.com/wupeiqi/articles/5246483.html</a></p></blockquote><h3 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h3><ul><li>数据库配置</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">DATABASES = &#123;</span><br><span class="line">    <span class="comment"># 默认使用的是sqlite3数据库</span></span><br><span class="line">    <span class="comment"># 'default': &#123;</span></span><br><span class="line">    <span class="comment">#     'ENGINE': 'django.db.backends.sqlite3',</span></span><br><span class="line">    <span class="comment">#     'NAME': os.path.join(BASE_DIR, 'db.sqlite3'),</span></span><br><span class="line">    <span class="comment"># &#125;,</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 使用mysqls数据库</span></span><br><span class="line">    <span class="comment"># `pip install mysqlclient-1.3.13-cp36-cp36m-win_amd64.whl` 安装客户端(windows)</span></span><br><span class="line">    <span class="string">'default'</span>: &#123;</span><br><span class="line">        <span class="string">'ENGINE'</span>: <span class="string">'django.db.backends.mysql'</span>,</span><br><span class="line">        <span class="string">'NAME'</span>: <span class="string">'django_rest'</span>, <span class="comment"># 数据库名</span></span><br><span class="line">        <span class="string">'HOST'</span>: <span class="string">'localhost'</span>,</span><br><span class="line">        <span class="string">'PORT'</span>: <span class="string">'3306'</span>,</span><br><span class="line">        <span class="string">'USER'</span>: <span class="string">'root'</span>,</span><br><span class="line">        <span class="string">'PASSWORD'</span>: <span class="string">'root'</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>生成/更新表结构<ul><li><code>python manage.py makemigrations</code> 生成迁移文件</li><li><code>python manage.py migrate</code> 执行迁移文件(数据库表结构会同步更新)</li><li>不建议手动到数据库删除表</li></ul></li><li>创建管理用户(保存在auth_user表中)<ul><li><code>python manage.py createsuperuser --email admin@aezo.cn --username admin</code>(输入密码admin888)</li></ul></li><li>创建权限组数据并添加用户<ul><li><code>insert into &quot;auth_group&quot; (&quot;id&quot;, &quot;name&quot;) values (1, &#39;管理员&#39;)</code></li><li><code>insert into &quot;auth_user_groups&quot; (&quot;id&quot;, &quot;user_id&quot;, &quot;group_id&quot;) values (1, 1, 1)</code></li></ul></li></ul><h3 id="表结构定义"><a href="#表结构定义" class="headerlink" title="表结构定义"></a>表结构定义</h3><ul><li>字段通用属性<ul><li><code>verbose_name</code> 定义字段说明，admin模块界面显示的字段名。中文定义如：<code>verbose_name=u&#39;字段说明&#39;</code></li><li><code>primary_key=True</code> 为主键</li><li><code>blank=True</code> admin会根据在创建数据库时的非空与否属性来确定字段是否必填(所有类型字段默认都是不为空的)。对于时间和数字，允许为空的条件需要 <code>blank=True,null=True</code> 否则会引发错误</li><li><code>null=True</code> 可为空。字符串可以不初始化，但是在修改时不能为空字符串。如果需要为空字符串可加blank=True</li><li><code>choices</code> 可选值元组</li><li><code>default</code> 默认值</li></ul></li><li><p><code>DateTimeField</code>、<code>DateField</code>、<code>TimeField</code> <a href="http://www.nanerbang.com/article/5488/" title="DateTimeField如何自动设置为当前时间并且能被修改" target="_blank" rel="noopener">^1</a></p><ul><li>上述类型，其值分别对应着Python里的datetime.datetime、datetime.date和datetime.time三个实例</li><li><code>auto_now=True</code> 这个参数的默认值为false，设置为true时，能够在保存该字段时，将其值设置为当前时间，并且每次修改model，都会自动更新。因此这个参数在需要存储<strong>最后修改时间</strong>的场景下，十分方便。需要注意的是，设置该参数为true时，并不简单地意味着字段的默认值为当前时间，而是指字段会被”强制”更新到当前时间(只有每次调用Model.save时才会自动更新，其他的如QuerySet.update是无法更新的)，你无法程序中手动为字段赋值；如果使用django再带的admin管理器，那么该字段在admin中是只读的</li><li><code>auto_now_add</code> 设置为True时，会在model对象第一次被创建时，将字段的值设置为创建时的时间，以后修改对象时，字段的值不会再更新。该属性通常被用在存储<strong>创建时间</strong>的场景下。与auto_now类似，auto_now_add也具有强制性，一旦被设置为True，就无法在程序中手动为字段赋值，在admin中字段也会成为只读的</li><li><code>default=django.utils.timezone.now</code> <strong>默认值为当前时间且再admin模块可修改</strong></li><li>上述3个默认时间属性都不会再数据库级别创建默认值</li><li>程序中手动修改字段值<code>party.update_time = django.utils.timezone.now()</code>，此时保存实体后，存储的时间类型为UTC时间(在数据库中直接查看是会比Asia/Shanghai晚8个小时，但是setting.py中设置了时区为Asia/Shanghai，则admin页面显示是正常的Asia/Shanghai时间)</li><li><p>时间处理</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.utils <span class="keyword">import</span> timezone</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line">party.update_time <span class="comment"># 2020-01-06 07:39:53.063158+00:00</span></span><br><span class="line">party.update_time.now() <span class="comment"># 2020-01-06 16:16:26.077810</span></span><br><span class="line">party.update_time.now(timezone.get_current_timezone()) <span class="comment"># 2020-01-06 16:16:26.077810+08:00</span></span><br><span class="line"></span><br><span class="line">datetime.datetime.now() <span class="comment"># 2020-01-06 16:16:26.077810</span></span><br><span class="line">datetime.datetime.now(timezone.utc) <span class="comment"># 2020-01-06 08:16:26.077810+00:00</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> party.update_time <span class="keyword">and</span> (datetime.datetime.now(timezone.utc) - party.update_time).total_seconds() &lt; <span class="number">600</span>:</span><br><span class="line">    print(<span class="string">'party最近10分钟更新过'</span>)</span><br></pre></td></tr></table></figure></li></ul></li><li><p><code>ForeignKey</code>、<code>ManyToManyField</code>、<code>OneToOneField</code>分别在Model中定义多对一(使用ForeignKey的表为子表)，多对多，一对一关系。相关参数</p><ul><li><code>related_name</code><ul><li>father.child_set.all()。获取子表(子表Child中有一个外键，此时父表中默认会存储 <code>子表_set</code> 来获取子表；也可在子表中定义 related_name；如果子表中有某一个表的两个外键，则必须要定义related_name)</li><li>father.child_related_name.all()。child_related_name为子表中定义的 related_name 名称</li><li>book = models.ForeignKey(Author, related_name=’child_related_name’, on_delete=models.CASCADE)</li></ul></li><li><code>db_column</code> 定义外键生成的字段名</li><li><code>on_delete</code> 删除主表时，对子表的行为。ForeignKey必须<ul><li><code>CASCADE</code> 删除作者信息一并删除作者名下的所有书的信息</li><li><code>PROTECT</code> 删除作者的信息时，采取保护机制，抛出错误：即不删除Books的内容</li><li><code>SET_NULL</code> 只有当null=True才将关联的内容置空</li><li><code>SET_DEFAULT</code> 设置为默认值</li><li><code>SET()</code> 括号里可以是函数，设置为自己定义的东西</li><li><code>DO_NOTHING</code> 字面的意思，啥也不干</li></ul></li><li><code>db_constraint=False</code> <strong>数据库中不创建外键</strong>。但是django仍然可以通过外键属性获取关联对象</li></ul></li><li><code>Meta</code>为每个mode的元数据定义类<ul><li><code>verbose_name_plural</code> 可在admin模块显示此字段定义表别名</li></ul></li><li><p>主键</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 自定义主键</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Party</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="comment"># 手动定义主键名称</span></span><br><span class="line">    <span class="comment"># party_id = models.AutoField(primary_key=True) # mysql长度为10位int类型，且为自增主键</span></span><br><span class="line">    <span class="comment"># party_id = models.BigAutoField(primary_key=True) # mysql长度为20位bigint类型，且为自增主键</span></span><br><span class="line">    <span class="comment"># party_id = models.BigIntegerField(primary_key=True) # mysql长度为20位bigint类型，无法自增需要手动赋值主键</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 未定义主键则默认创建主键名为id，类型11位的int，且为自增</span></span><br><span class="line">    name = models.CharField(max_length=<span class="number">20</span>)</span><br><span class="line">    <span class="string">'''在types.py中定义：</span></span><br><span class="line"><span class="string">    party_source = (</span></span><br><span class="line"><span class="string">        ('A', '来源一'),</span></span><br><span class="line"><span class="string">        ('B', '来源二'),</span></span><br><span class="line"><span class="string">    )</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    party_source = models.CharField(verbose_name=<span class="string">u'Party来源'</span>, choices=types.party_source, max_length=<span class="number">60</span>)</span><br><span class="line">    is_gov = models.BooleanField(verbose_name=<span class="string">u'是否为政府机构'</span>, default=<span class="keyword">True</span>)  <span class="comment"># mysql字段类型为tinyint</span></span><br><span class="line">    update_time = models.DateTimeField(verbose_name=<span class="string">u'最近更新时间'</span>, null=<span class="keyword">True</span>, blank=<span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关于联合主键</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PartyRole</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    party = models.ForeignKey(<span class="string">'Party'</span>, on_delete=models.CASCADE)  <span class="comment"># 此处同时使用了ForeignKey外键，见下文</span></span><br><span class="line">    role_type = models.ForeignKey(<span class="string">'RoleType'</span>, on_delete=models.CASCADE)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        db_table = <span class="string">'biz_party_role'</span>  <span class="comment"># 定义实际表名</span></span><br><span class="line">        verbose_name_plural = <span class="string">u'Party角色'</span>  <span class="comment"># admin模块界面显示的字段名，默认显示表名</span></span><br><span class="line">        unique_together = (<span class="string">"party"</span>, <span class="string">"role_type"</span>)   <span class="comment"># django未实现联合主键, 只能通过组合唯一建校验</span></span><br><span class="line">        <span class="comment"># 自定义权限</span></span><br><span class="line">        permissions = (</span><br><span class="line">            (<span class="string">"publish_goods"</span>, <span class="string">"Can publish goods"</span>),</span><br><span class="line">            (<span class="string">"comment_goods"</span>, <span class="string">"Can comment goods"</span>),</span><br><span class="line">        )</span><br></pre></td></tr></table></figure></li><li><p>外键/关联(使用物理外键，配合admin模块可更快实现增删改查功能)</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 案例一：models.py</span></span><br><span class="line"><span class="comment"># Author必须定义在Books上面</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Author</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    author = models.CharField(max_length=<span class="number">250</span>) </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Books</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="comment"># book = models.ForeignKey('Author', on_delete=models.CASCADE) # 此时Author可以定义在Books下面。并且Author可以通过配置文件导入，否则需要在Books上面定义</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 默认外键名为`属性名_id`</span></span><br><span class="line">    book = models.ForeignKey(Author, on_delete=models.CASCADE)</span><br><span class="line">    <span class="comment"># book = models.ForeignKey(Author, on_delete=models.SET_NULL, db_constraint=False, null=True, blank=True) # 定义逻辑外键/软外键</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 自关联</span></span><br><span class="line">    parent_book = models.ForeignKey(to=<span class="string">'self'</span>, on_delete=models.CASCADE)</span><br><span class="line"></span><br><span class="line"><span class="comment">## 案例二：models.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PartyRelationship</span><span class="params">(BaseModel)</span>:</span></span><br><span class="line">    <span class="string">"""当事人(个人/组织)角色关系，如雇佣关系/部门关系等(职位属于人事模块)"""</span></span><br><span class="line">    party_relationship_type = models.ForeignKey(<span class="string">'PartyRelationshipType'</span>, on_delete=models.PROTECT)</span><br><span class="line">    party_id_from = models.ForeignKey(<span class="string">'Party'</span>, db_column=<span class="string">'party_id_from'</span>, related_name=<span class="string">'party_relationship_from'</span>,</span><br><span class="line">                                    on_delete=models.CASCADE)</span><br><span class="line">    party_id_to = models.ForeignKey(<span class="string">'Party'</span>, db_column=<span class="string">'party_id_to'</span>, related_name=<span class="string">'party_relationship_to'</span>,</span><br><span class="line">                                    on_delete=models.CASCADE)</span><br><span class="line">    role_type_id_from = models.ForeignKey(<span class="string">'RoleType'</span>, db_column=<span class="string">'role_type_id_from'</span>, related_name=<span class="string">'party_relationship_from'</span>,</span><br><span class="line">                                        on_delete=models.PROTECT)</span><br><span class="line">    role_type_id_to = models.ForeignKey(<span class="string">'RoleType'</span>, db_column=<span class="string">'role_type_id_to'</span>, related_name=<span class="string">'party_relationship_to'</span>,</span><br><span class="line">                                        on_delete=models.PROTECT)</span><br><span class="line">    from_date = models.DateTimeField(default=timezone.now)</span><br><span class="line">    thru_date = models.DateTimeField(verbose_name=<span class="string">u'过期时间'</span>, null=<span class="keyword">True</span>, blank=<span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        db_table = <span class="string">'biz_party_relationship'</span></span><br><span class="line">        <span class="comment"># django未实现联合主键, 只能通过组合唯一建校验</span></span><br><span class="line">        unique_together = (<span class="string">"party_id_from"</span>, <span class="string">"party_id_to"</span>, <span class="string">"role_type_id_from"</span>, <span class="string">"role_type_id_to"</span>, <span class="string">"from_date"</span>)</span><br><span class="line">        verbose_name_plural = <span class="string">u'Party角色关系'</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="CRUD"><a href="#CRUD" class="headerlink" title="CRUD"></a>CRUD</h3><h4 id="基本增删改"><a href="#基本增删改" class="headerlink" title="基本增删改"></a>基本增删改</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> api.test <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="comment">## 增</span></span><br><span class="line"><span class="comment"># 法一，返回值object</span></span><br><span class="line">models.MyUser.objects.create(name=<span class="string">'smalle'</span>, password=<span class="string">'123'</span>)</span><br><span class="line"><span class="comment"># 法二，返回值object</span></span><br><span class="line">obj = models.MyUser(name=<span class="string">'smalle'</span>, password=<span class="string">'123'</span>) <span class="comment"># 也可 obj = models.MyUser()</span></span><br><span class="line">obj.save()</span><br><span class="line"><span class="comment"># 法三，返回值object。可以接受字典类型数据 **kwargs</span></span><br><span class="line">dic = &#123;<span class="string">'name'</span>:<span class="string">'smalle'</span>,<span class="string">'password'</span>:<span class="string">'123'</span>&#125;</span><br><span class="line">models.MyUser.objects.create(**dic)</span><br><span class="line"><span class="comment"># 法四，返回值是一个元组(object, True/False)。首先尝试获取，不存在就创建，可以防止重复；创建时返回 True, 已经存在时返回 False</span></span><br><span class="line">models.MyUser.objects.get_or_create(name=<span class="string">"smalle"</span>, email=<span class="string">"test@163.com"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 查</span></span><br><span class="line"><span class="comment"># 获取单条数据，不存在则报错（不建议），返回 MyUser.objects</span></span><br><span class="line">user = models.MyUser.objects.get(id=<span class="number">1</span>)  <span class="comment"># 如果不存在会报错 models.MyUser.DoesNotExist</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取全部，返回queryset类型</span></span><br><span class="line">users = models.MyUser.objects.all()</span><br><span class="line"><span class="keyword">if</span> users.exists(): <span class="keyword">pass</span></span><br><span class="line"><span class="comment"># 获取全部数据的第1条数据</span></span><br><span class="line">models.MyUser.objects.all().first()</span><br><span class="line"><span class="comment"># 获取指定条件的数据，返回queryset类型</span></span><br><span class="line">models.MyUser.objects.filter(name=<span class="string">'smalle'</span>)</span><br><span class="line"><span class="comment"># filter可以接受字典类型数据 **kwargs(下同)</span></span><br><span class="line">dic = &#123;<span class="string">'name'</span>:<span class="string">'smalle'</span>,<span class="string">'password'</span>:<span class="string">'123'</span>&#125;</span><br><span class="line">models.MyUser.objects.filter(**dic)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 改</span></span><br><span class="line"><span class="comment"># 批量更新。适用于 .all()  .filter()  .exclude() 等后面 (危险操作，正式场合操作务必谨慎)</span></span><br><span class="line">models.MyUser.objects.filter(name=<span class="string">'smalle'</span>).update(password=<span class="string">'123456'</span>)</span><br><span class="line">models.MyUser.objects.filter(name__iexact=<span class="string">"abc"</span>).update(name=<span class="string">'xxx'</span>) <span class="comment"># __iexact 后缀可过滤名称为 abc 但是不区分大小写，可以找到 ABC, Abc, aBC，这些都符合条件。将他们都改成 xxx</span></span><br><span class="line">models.MyUser.objects.all().delete() <span class="comment"># 删除所有 Person 记录</span></span><br><span class="line"><span class="comment"># 单个 object 更新。适合于 .get(), get_or_create(), update_or_create() 等得到的 obj</span></span><br><span class="line">obj = models.MyUser.objects.get(id=<span class="number">1</span>)</span><br><span class="line">obj.password = <span class="string">'123456'</span></span><br><span class="line">obj.save()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 删</span></span><br><span class="line">models.MyUser.objects.filter(name=<span class="string">'smalle'</span>).delete()</span><br></pre></td></tr></table></figure><h4 id="进阶查询"><a href="#进阶查询" class="headerlink" title="进阶查询"></a>进阶查询</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> api.test <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取个数</span></span><br><span class="line">models.MyUser.objects.filter(sex=<span class="string">'boy'</span>).count()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取id大于1 且 小于10的值</span></span><br><span class="line">models.MyUser.objects.filter(id__lt=<span class="number">10</span>, id__gt=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># in 获取id等于11、22、33的数据</span></span><br><span class="line">models.MyUser.objects.filter(id__in=[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])</span><br><span class="line"><span class="comment"># not in</span></span><br><span class="line">models.MyUser.objects.exclude(id__in=[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 包含/不包含</span></span><br><span class="line">models.MyUser.objects.filter(name__contains=<span class="string">"aezo"</span>) <span class="comment"># __contains 包含</span></span><br><span class="line">models.MyUser.objects.filter(name__icontains=<span class="string">"aezo"</span>) <span class="comment"># __icontains大小写不敏感</span></span><br><span class="line">models.MyUser.objects.exclude(name__icontains=<span class="string">"aezo"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 范围bettwen and</span></span><br><span class="line">models.MyUser.objects.filter(id__range=[<span class="number">1</span>, <span class="number">10</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># order by</span></span><br><span class="line">models.MyUser.objects.filter(sex=<span class="string">'boy'</span>).order_by(<span class="string">'id'</span>)    <span class="comment"># asc</span></span><br><span class="line">models.MyUser.objects.filter(sex=<span class="string">'boy'</span>).order_by(<span class="string">'-id'</span>)   <span class="comment"># desc</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># limit、offset。切片操作，获取前10个，切片可以节约内存，不支持负索引，可使用 reverse() 解决</span></span><br><span class="line">models.MyUser.objects.all()[:<span class="number">10</span>]</span><br><span class="line">models.MyUser.objects.all()[<span class="number">10</span>:<span class="number">20</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># __regex正则匹配，__iregex 不区分大小写</span></span><br><span class="line">models.MyUser.objects.get(name__regex=<span class="string">r'^(An?|The) +'</span>)</span><br><span class="line">models.MyUser.objects.get(name__iregex=<span class="string">r'^(an?|the) +'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 日期</span></span><br><span class="line">models.MyUser.objects.filter(birth_date__date=datetime.date(<span class="number">2000</span>, <span class="number">1</span>, <span class="number">1</span>)) <span class="comment"># __date 日期等于</span></span><br><span class="line">models.MyUser.objects.filter(birth_date__date__gt=datetime.date(<span class="number">2000</span>, <span class="number">1</span>, <span class="number">1</span>)) <span class="comment"># __date__gt 日期大于</span></span><br><span class="line">models.MyUser.objects.filter(pub_date__year=<span class="number">2000</span>) <span class="comment"># 同理 __month、__day、__week_day、__hour、__minute、__second</span></span><br></pre></td></tr></table></figure><h4 id="联表查询"><a href="#联表查询" class="headerlink" title="联表查询"></a>联表查询</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> api.test <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="comment"># 外键。查询子表</span></span><br><span class="line">father = models.Father.objects.filter(id=<span class="number">1</span>).first()</span><br><span class="line">father.child_set.all() <span class="comment"># 获取子表(子表Child中有一个外键，此时父表中默认会存储 `子表_set` 来获取子表；也可在子表中定义 related_name；如果子表中有某一个表的两个外键，则必须要定义related_name)</span></span><br><span class="line">father.child_related_name.all() <span class="comment"># child_related_name为子表中定义的 related_name 名称</span></span><br></pre></td></tr></table></figure><h4 id="QuerySet"><a href="#QuerySet" class="headerlink" title="QuerySet"></a>QuerySet</h4><ul><li>从数据库中查询(all/filter)出来的结果一般是一个集合，这个集合叫做 <code>QuerySet</code> <a href="https://code.ziqiangxuetang.com/django/django-queryset-api.html" target="_blank" rel="noopener">^3</a></li><li>如果只是检查 MyUser 中是否有对象，应该用 <code>models.MyUser.objects.all().exists()</code></li><li>推荐用 <code>models.MyUser.objects.count()</code> 来查询数量，而不是用 <code>len(users)</code>，前者用的是SQL为<code>SELECT COUNT(*)</code>更高效</li><li><code>list(users)</code> 可以强行将 QuerySet 变成列表</li><li>案例</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 参考：https://code.ziqiangxuetang.com/django/django-queryset-api.html</span></span><br><span class="line"><span class="keyword">from</span> api.test <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="comment">## QuerySet 是可迭代的</span></span><br><span class="line">users = models.MyUser.objects.all()</span><br><span class="line"><span class="keyword">for</span> u <span class="keyword">in</span> users:</span><br><span class="line">    print(u.name)</span><br><span class="line"><span class="keyword">if</span> users.exists():  <span class="comment"># 如果无数据返回的也是 QuerySet 对象，如果通过 `if users is not None:`永远返回True，因此需要使用exists判断</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## QuerySet 查询结果排序</span></span><br><span class="line">models.MyUser.objects.all().order_by(<span class="string">'-name'</span>) <span class="comment"># 在 column name 前加一个负号，可以实现倒序</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## QuerySet 支持链式查询</span></span><br><span class="line">models.MyUser.objects.filter(name__contains=<span class="string">"smalle"</span>).exclude(email=<span class="string">"admin@163.com"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">## QuerySet 支持切片，可以节省内存。但是QuerySet不支持负索引</span></span><br><span class="line">models.MyUser.objects.all()[:<span class="number">10</span>] <span class="comment"># 取出前10条</span></span><br><span class="line">models.MyUser.objects.all()[<span class="number">-10</span>:] <span class="comment"># 会报错！！！</span></span><br><span class="line"><span class="comment"># 使用 reverse() 解决</span></span><br><span class="line">models.MyUser.objects.all().reverse()[:<span class="number">2</span>] <span class="comment"># 最后两条</span></span><br><span class="line">models.MyUser.objects.all().reverse()[<span class="number">0</span>] <span class="comment"># 最后一条</span></span><br><span class="line"><span class="comment"># 使用 order_by 解决</span></span><br><span class="line">models.MyUser.objects.order_by(<span class="string">'-id'</span>)[:<span class="number">20</span>] <span class="comment"># id最大的20条</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## QuerySet 重复的问题，使用 .distinct() 去重。一般的情况下，QuerySet 中不会出来重复的，但是多次查询将结果并到一起，可能会出来重复的值</span></span><br><span class="line">qs1 = models.MyUser.objects.filter(label__name=<span class="string">'test'</span>)</span><br><span class="line">qs2 = models.MyUser.objects.filter(attr__name=<span class="string">'hello'</span>)</span><br><span class="line">qs3 = models.MyUser.objects.filter(inputer__name=<span class="string">'smalle'</span>)</span><br><span class="line"><span class="comment"># 合并到一起，这个时候就有可能出现重复的</span></span><br><span class="line">qs = qs1 | qs2 | qs3</span><br><span class="line"><span class="comment"># 执行去重方法</span></span><br><span class="line">qs = qs.distinct()</span><br></pre></td></tr></table></figure><ul><li>进阶案例 <a href="https://code.ziqiangxuetang.com/django/django-queryset-advance.html" target="_blank" rel="noopener">^4</a></li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 参考：https://code.ziqiangxuetang.com/django/django-queryset-advance.html</span></span><br><span class="line"><span class="keyword">from</span> api.test <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="comment">### 查看 Django queryset 执行的 SQL</span></span><br><span class="line">print(str(models.MyUser.objects.all().query))</span><br><span class="line">models.MyUser.objects.all().query.__str__()</span><br><span class="line"></span><br><span class="line"><span class="comment">### values_list 和 values</span></span><br><span class="line"><span class="comment"># values_list 和 values 返回的并不是真正的 列表 或 字典，也是 queryset。他们也是用的时候才真正的去数据库查</span></span><br><span class="line"><span class="comment"># 如果查询后没有使用，在数据库更新后再使用，此时得到在是新内容。如果想要旧内容保持着，数据库更新后不要变，可以 list 一下便会立即查询数据到内存</span></span><br><span class="line"><span class="comment"># 如果只是遍历这些结果，没有必要 list 它们转成列表(会浪费内存)</span></span><br><span class="line"><span class="comment">## values_list 获取元组形式结果。如获取用户的 name 和 qq</span></span><br><span class="line">users = models.MyUser.objects.values_list(<span class="string">'name'</span>, <span class="string">'qq'</span>)</span><br><span class="line">list(users)</span><br><span class="line"><span class="comment"># 如果只需要 1 个字段，可以指定 flat=True</span></span><br><span class="line">list(models.MyUser.objects.values_list(<span class="string">'name'</span>, flat=<span class="keyword">True</span>))</span><br><span class="line"><span class="comment">## values 获取字典形式的结果。如获取用户的 name 和 qq</span></span><br><span class="line">models.MyUser.objects.values(<span class="string">'name'</span>, <span class="string">'qq'</span>)</span><br><span class="line">list(models.MyUser.objects.values(<span class="string">'name'</span>, <span class="string">'qq'</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">### extra、defer、only</span></span><br><span class="line"><span class="comment">## extra 实现：别名(如`select name as full_name from my_user;`)，条件，排序等</span></span><br><span class="line"><span class="comment"># 使用extra后，name 和 tag_name 都可以使用</span></span><br><span class="line">users = models.MyUser.objects.all().extra(select=&#123;<span class="string">'full_name'</span>: <span class="string">'name'</span>&#125;)</span><br><span class="line">users[<span class="number">0</span>].name</span><br><span class="line">users[<span class="number">0</span>].full_name</span><br><span class="line"><span class="comment">## defer 排除不需要的字段。此处如排除原来的 name 字段</span></span><br><span class="line">models.MyUser.objects.all().extra(select=&#123;<span class="string">'full_name'</span>: <span class="string">'name'</span>&#125;).defer(<span class="string">'name'</span>)</span><br><span class="line">models.MyUser.objects.all().defer(<span class="string">'password'</span>)</span><br><span class="line"><span class="comment">## only 仅选择需要的字段(主键也会自动带出)</span></span><br><span class="line">models.MyUser.objects.all().only(<span class="string">'name'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">### annotate 实现聚合：计数，求和，平均数等</span></span><br><span class="line"><span class="comment">## 计数。如计算每个组作者的文章数</span></span><br><span class="line"><span class="comment"># select author_id, count(author_id) as count from article group by author_id</span></span><br><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Count</span><br><span class="line">models.Article.objects.all().values(<span class="string">'author_id'</span>).annotate(count=Count(<span class="string">'author'</span>)).values(<span class="string">'author_id'</span>, <span class="string">'count'</span>)</span><br><span class="line">models.Article.objects.all().values(<span class="string">'author__name'</span>).annotate(count=Count(<span class="string">'author'</span>)).values(<span class="string">'author__name'</span>, <span class="string">'count'</span>)  <span class="comment"># 获取关联表字段</span></span><br><span class="line"><span class="comment">## 求和。如求一个作者所有文章的总分</span></span><br><span class="line"><span class="comment"># select "author"."name", sum("article"."score") as "sum_score" from "article" inner join "author" on ("article"."author_id" = "author"."id") group by "author"."name"</span></span><br><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Sum</span><br><span class="line">models.Article.objects.values(<span class="string">'author__name'</span>).annotate(sum_score=Sum(<span class="string">'score'</span>)).values(<span class="string">'author__name'</span>, <span class="string">'sum_score'</span>)</span><br><span class="line"><span class="comment">## 平均值。如求一个作者的所有文章的得分(score)平均值</span></span><br><span class="line"><span class="comment"># select author_id, avg(score) as avg_score from article group by author_id</span></span><br><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Avg</span><br><span class="line">models.Article.objects.values(<span class="string">'author_id'</span>).annotate(avg_score=Avg(<span class="string">'score'</span>)).values(<span class="string">'author_id'</span>, <span class="string">'avg_score'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">### select_related、prefetch_related</span></span><br><span class="line"><span class="comment">## select_related 优化一对一，多对一查询(select_related 是使用 SQL JOIN 一次性取出相关的内容)。eg：取出10篇文章，并需要用到作者的姓名</span></span><br><span class="line"><span class="comment"># 法一</span></span><br><span class="line">articles = models.Article.objects.all()[:<span class="number">10</span>]  <span class="comment"># 不访问数据库</span></span><br><span class="line">a1 = articles[<span class="number">0</span>]  <span class="comment"># 会访问数据库。取第一篇</span></span><br><span class="line">a1.author_id  <span class="comment"># 不访问数据库</span></span><br><span class="line">a1.author.name  <span class="comment"># 再次访问数据库</span></span><br><span class="line"><span class="comment"># 法二(推荐)。filter同样可以使用select_related进行链式查询</span></span><br><span class="line">articles = models.Article.objects.all().select_related(<span class="string">'author'</span>)[:<span class="number">10</span>]</span><br><span class="line">a1 = articles[<span class="number">0</span>]  <span class="comment"># 会访问数据库</span></span><br><span class="line">a1.author.name  <span class="comment"># 不访问数据库</span></span><br><span class="line"><span class="comment">## prefetch_related 优化一对多，多对多查询(prefetch_related是通过再执行一条额外的SQL语句，然后用 Python 把两次SQL查询的内容关联 joining 到一起)</span></span><br><span class="line"><span class="comment"># 法一</span></span><br><span class="line">articles = models.Article.objects.all()[:<span class="number">3</span>]</span><br><span class="line"><span class="keyword">for</span> a <span class="keyword">in</span> articles:  <span class="comment"># 第一次循环查询两次数据库，后面两次循环每次查询一次数据</span></span><br><span class="line">    print(a.title, a.tags.all())</span><br><span class="line"><span class="comment"># 法二(推荐)</span></span><br><span class="line">articles = models.Article.objects.all().prefetch_related(<span class="string">'tags'</span>)[:<span class="number">10</span>]</span><br><span class="line"><span class="keyword">for</span> a <span class="keyword">in</span> articles:  <span class="comment"># 第一次循环查询两次数据库，后面不查询数据</span></span><br><span class="line">    print(a.title, a.tags.all())</span><br><span class="line"></span><br><span class="line"><span class="comment">### 自定义聚合功能</span></span><br><span class="line"><span class="comment"># 定义</span></span><br><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Aggregate, CharField</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GroupConcat</span><span class="params">(Aggregate)</span>:</span></span><br><span class="line">    function = <span class="string">'GROUP_CONCAT'</span></span><br><span class="line">    template = <span class="string">'%(function)s(%(distinct)s%(expressions)s%(ordering)s%(separator)s)'</span></span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, expression, distinct=False, ordering=None, separator=<span class="string">','</span>, **extra)</span>:</span></span><br><span class="line">        super(GroupConcat, self).__init__(</span><br><span class="line">            expression,</span><br><span class="line">            distinct=<span class="string">'DISTINCT '</span> <span class="keyword">if</span> distinct <span class="keyword">else</span> <span class="string">''</span>,</span><br><span class="line">            ordering=<span class="string">' ORDER BY %s'</span> % ordering <span class="keyword">if</span> ordering <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span> <span class="keyword">else</span> <span class="string">''</span>,</span><br><span class="line">            separator=<span class="string">' SEPARATOR "%s"'</span> % separator,</span><br><span class="line">            output_field=CharField(),</span><br><span class="line">            **extra)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用。比如聚合后的错误日志记录有这些字段 time、level、info，想把 level、info 一样的聚到到一起，按时间和发生次数倒序排列，并含有每次日志发生的时间</span></span><br><span class="line">models.ErrorLogModel.objects.values(<span class="string">'level'</span>, <span class="string">'info'</span>).annotate(</span><br><span class="line">    count=Count(<span class="number">1</span>), time=GroupConcat(<span class="string">'time'</span>, ordering=<span class="string">'time DESC'</span>, separator=<span class="string">' | '</span>)</span><br><span class="line">).order_by(<span class="string">'-time'</span>, <span class="string">'-count'</span>)</span><br></pre></td></tr></table></figure><h2 id="自带App"><a href="#自带App" class="headerlink" title="自带App"></a>自带App</h2><h3 id="admin"><a href="#admin" class="headerlink" title="admin"></a>admin</h3><h4 id="admin-py-快速生成管理界面"><a href="#admin-py-快速生成管理界面" class="headerlink" title="admin.py 快速生成管理界面"></a>admin.py 快速生成管理界面</h4><ul><li>应用注册：在<code>setting.py</code>的<code>INSTALLED_APPS</code>中加入此应用<code>apps.monitor</code></li><li><code>admin.py</code>必须写在每个app对应根目录下 <a href="https://www.cnblogs.com/huchong/p/7894660.html" target="_blank" rel="noopener">^2</a></li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## party/models.py(模型)</span></span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> sqbiz.base.models <span class="keyword">import</span> BaseModel</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> types</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PartyType</span><span class="params">(BaseModel)</span>:</span></span><br><span class="line">    party_type_id = models.CharField(primary_key=<span class="keyword">True</span>, max_length=<span class="number">60</span>, choices=types.party_type_id)</span><br><span class="line">    parent_type = models.ForeignKey(<span class="string">'self'</span>, on_delete=models.CASCADE, null=<span class="keyword">True</span>, blank=<span class="keyword">True</span>)</span><br><span class="line">    party_type_name = models.CharField(max_length=<span class="number">100</span>)</span><br><span class="line">    attr1 = models.CharField(max_length=<span class="number">60</span>)</span><br><span class="line">    attr2 = models.CharField(max_length=<span class="number">60</span>)</span><br><span class="line">    description = models.TextField(verbose_name=<span class="string">u'描述'</span>, null=<span class="keyword">True</span>, blank=<span class="keyword">True</span>) <span class="comment"># TextField 类型字段，在admin模块会自动显示成 textarea 表单元素</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        db_table = <span class="string">'biz_party_type'</span></span><br><span class="line">        verbose_name_plural = <span class="string">'Party类型'</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># admin模块子表显示父表时会调用，否则显示成PartyType object。python2使用的是__unicode__函数</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.party_type_name</span><br><span class="line"></span><br><span class="line"><span class="comment">## party/admin.py</span></span><br><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> sqbiz.party <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="comment"># 同 admin.site.register(models.PartyType, PartyTypeAdmin) # 注册此类</span></span><br><span class="line"><span class="meta">@admin.register(models.PartyType)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PartyTypeAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></span><br><span class="line">    <span class="keyword">from</span> django.core.paginator <span class="keyword">import</span> Paginator</span><br><span class="line"></span><br><span class="line">    <span class="comment">## 列表</span></span><br><span class="line">    <span class="comment"># 列表展示的字段，默认显示 ModelName object (PK)。此处my_custome_name为自定义字段名(model中无此字段)，如果要显示外键内的其他字段也可类似自定义字段</span></span><br><span class="line">    list_display = (<span class="string">'party_type_id'</span>, <span class="string">'parent_type'</span>, <span class="string">'party_type_name'</span>, <span class="string">'create_time'</span>, <span class="string">'my_custome_name'</span>) <span class="comment"># 此处的parent_type自关联外键，不能写成parent_type_id真实字段名，必需为model的字段名</span></span><br><span class="line">    list_display_links = (<span class="string">'party_type_id'</span>, <span class="string">'parent_type'</span>)  <span class="comment"># 设置哪些字段可以点击进入编辑界面(默认第一个字段)</span></span><br><span class="line">    ordering = (<span class="string">'-create_time'</span>,)  <span class="comment"># 默认排序字段，负号表示降序排序</span></span><br><span class="line">    list_max_show_all = <span class="number">200</span>  <span class="comment"># 真实数据小于该值时，才会有显示全部，否则分页显示</span></span><br><span class="line">    list_per_page = <span class="number">100</span>  <span class="comment"># 设置每页显示多少条记录，默认是100条</span></span><br><span class="line">    paginator = Paginator  <span class="comment"># 分页插件</span></span><br><span class="line"></span><br><span class="line">    actions = [func, ]  <span class="comment"># 增加Action</span></span><br><span class="line">    actions_selection_counter = <span class="keyword">True</span>  <span class="comment"># 显示选中的记录条数，默认True</span></span><br><span class="line">    actions_on_top = <span class="keyword">True</span>  <span class="comment"># Action选项都是在页面上方显示</span></span><br><span class="line">    actions_on_bottom = <span class="keyword">True</span>  <span class="comment"># Action选项都是在页面下方显示，默认False</span></span><br><span class="line"></span><br><span class="line">    empty_value_display = <span class="string">"-NA-"</span>  <span class="comment"># 列数据为空时，默认显示数据</span></span><br><span class="line">    list_select_related = <span class="keyword">True</span>  <span class="comment"># Django在检索管理更改列表页面上的对象列表时使用select_related()，这可以节省大量的数据库查询。默认False</span></span><br><span class="line">    list_editable = (<span class="string">'parent_type'</span>, <span class="string">'party_type_name'</span>, <span class="string">'create_time'</span>,)  <span class="comment"># 列表可编辑字段(可操作input/select/date/外键等)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">## 筛选</span></span><br><span class="line">    <span class="comment"># 列表查询字段(所有的字段通过同一个搜索框输入)。__获取对象属性，此时相当于基于父表project的name进行筛选</span></span><br><span class="line">    search_fields = [<span class="string">'party_type_name'</span>, <span class="string">'description'</span>, <span class="string">'parent_type__party_type_name'</span>]</span><br><span class="line">    list_filter = [<span class="string">'party_type_name'</span>]  <span class="comment"># 列表右边显示的过滤器(基于字段值distinct后进行快速筛选链接)。**也可自定义筛选类，参考下文**</span></span><br><span class="line">    date_hierarchy = <span class="string">'create_time'</span>  <span class="comment"># 详细时间分层筛选</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">## 编辑</span></span><br><span class="line">    form = MyForm  <span class="comment"># 用于定制用户请求时候表单验证。可继承 ModelForm</span></span><br><span class="line">    <span class="comment"># 新增/修改时的表单字段</span></span><br><span class="line">    fields = [<span class="string">'party_type_id'</span>, <span class="string">'parent_type'</span>, <span class="string">'party_type_name'</span>, <span class="string">'description'</span>, <span class="string">'create_time'</span>] <span class="comment"># 此处的parent_type外键，不能写成parent_type_id真实字段名</span></span><br><span class="line">    <span class="comment"># 排除该字段</span></span><br><span class="line">    exclude = (<span class="string">'create_time'</span>,)</span><br><span class="line">    <span class="comment"># 新增/修改表单暴露字段(常用)</span></span><br><span class="line">    fieldsets = (</span><br><span class="line">        <span class="comment"># 基于Key分栏显示，None也可定义成 'PartyType信息'</span></span><br><span class="line">        (<span class="keyword">None</span>, &#123;<span class="string">'fields'</span>: (<span class="string">'party_type_name'</span>, (<span class="string">'attr1'</span>, <span class="string">'attr2'</span>), <span class="string">'description'</span>, <span class="string">'create_time'</span>,)&#125;), <span class="comment"># ('attr1', 'attr2')表示两个字段显示时处于一行</span></span><br><span class="line">        (<span class="string">'ParentType信息'</span>, &#123;<span class="string">'fields'</span>: (<span class="string">'parent_type'</span>,)&#125;),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 基于用户过滤数据显示</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        <span class="string">"""重新定义此ModelAdmin函数，使普通用户只能看到自己添加的类型"""</span></span><br><span class="line">        qs = super(PartyTypeAdmin, self).get_queryset(request)</span><br><span class="line">        <span class="keyword">if</span> request.user.is_superuser:</span><br><span class="line">            <span class="keyword">return</span> qs</span><br><span class="line">        <span class="keyword">return</span> qs.filter(create_user_id=UserInfo.objects.filter(user_name=request.user))</span><br><span class="line"></span><br><span class="line">    <span class="comment">## 设置只读字段</span></span><br><span class="line">    readonly_fields = (<span class="string">'create_time'</span>,)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_readonly_fields</span><span class="params">(self, request, obj=None)</span>:</span></span><br><span class="line">        <span class="string">"""重新定义此ModelAdmin函数，限制普通用户该字段为只读，超级管理员可修改"""</span></span><br><span class="line">        <span class="keyword">if</span> request.user.is_superuser:</span><br><span class="line">            self.readonly_fields = []</span><br><span class="line">        <span class="keyword">elif</span> hasattr(obj, <span class="string">'parent_type_id'</span>) <span class="keyword">and</span> obj.parent_type_id:</span><br><span class="line">            self.readonly_fields = []</span><br><span class="line">        <span class="keyword">return</span> self.readonly_fields</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">save_model</span><span class="params">(self, request, obj, form, change)</span>:</span></span><br><span class="line">        <span class="string">"""重新定义ModelAdmin函数，编辑时进行额外操作。删除时操作可以重新定义delete_model方法"""</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">make_paper_num</span><span class="params">()</span>:</span></span><br><span class="line">            <span class="string">"""生成随机字符串"""</span></span><br><span class="line">            <span class="keyword">import</span> datetime</span><br><span class="line">            <span class="keyword">import</span> random</span><br><span class="line">            current_time = datetime.datetime.now().strftime(<span class="string">"%Y%m%d%H%M%S"</span>)  <span class="comment"># 生成当前时间</span></span><br><span class="line">            random_num = random.randint(<span class="number">0</span>, <span class="number">100</span>)  <span class="comment"># 生成的随机整数n，其中0&lt;=n&lt;=100</span></span><br><span class="line">            unique_num = str(current_time) + str(random_num)</span><br><span class="line">            <span class="keyword">return</span> unique_num  <span class="comment"># 201912131506155</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> change:  <span class="comment"># 更新时</span></span><br><span class="line">            <span class="keyword">if</span> obj.description <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">                obj.description = obj.description + make_paper_num()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                obj.description = make_paper_num()</span><br><span class="line">        <span class="keyword">else</span>:  <span class="comment"># 新增时</span></span><br><span class="line">            obj.description = make_paper_num()</span><br><span class="line">        super(PartyTypeAdmin, self).save_model(request, obj, form, change)  <span class="comment"># 此种修改不会被django记录到修改历史中</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">## 自定义列表字段 my_custome_name(条件：1.list_display中需要添加此字段；2.定义的方法名和字段名需要一致)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">my_custome_name</span><span class="params">(self, partyType)</span>:</span></span><br><span class="line">        <span class="string">"""自定义列表字段my_custome_name函数，用来显示子表的扩展属性名"""</span></span><br><span class="line">        my_custome_name = map(<span class="keyword">lambda</span> x: x.attr_name, partyType.extAttrs.all())</span><br><span class="line">        <span class="keyword">return</span> <span class="string">', '</span>.join(my_custome_name)</span><br><span class="line">    my_custome_name.short_description = <span class="string">'自定义名称'</span>  <span class="comment"># 设置表头显示</span></span><br><span class="line">    my_custome_name.empty_value_display = <span class="string">"None"</span>  <span class="comment"># 自定义字段为空时的默认值</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 定制Action行为具体方法</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">(self, request, queryset)</span>:</span></span><br><span class="line">        print(self, request, queryset)</span><br><span class="line">        print(request.POST.getlist(<span class="string">'_selected_action'</span>))</span><br></pre></td></tr></table></figure><ul><li>自定义筛选类</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## api/admin.py</span></span><br><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> api.pmhours <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义的Filter类的代码必需放在ModelAdmin类的前面，否则无法使用</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NameKeywordFilter</span><span class="params">(admin.SimpleListFilter)</span>:</span></span><br><span class="line">    <span class="string">"""自定义筛选类"""</span></span><br><span class="line">    title = <span class="string">'项目名关键词'</span>  <span class="comment"># 右侧栏筛选标题</span></span><br><span class="line">    parameter_name = <span class="string">'name'</span>  <span class="comment"># 在url中显示的参数名，如?name=xxx。不要使用q和next，这两个参数已作为django admin的默认参数使用了</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">lookups</span><span class="params">(self, request, model_admin)</span>:</span></span><br><span class="line">        <span class="string">"""自定义可筛选的参数元组"""</span></span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            (<span class="string">'A'</span>, <span class="string">'客户A'</span>),</span><br><span class="line">            (<span class="string">'B'</span>, <span class="string">'客户B'</span>),</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">queryset</span><span class="params">(self, request, queryset)</span>:</span></span><br><span class="line">        <span class="string">"""调用self.value()获取url中的参数，然后筛选所需的queryset."""</span></span><br><span class="line">        <span class="keyword">if</span> self.value() == <span class="string">'A'</span>:</span><br><span class="line">            <span class="keyword">return</span> queryset.filter(name__icontains=<span class="string">'客户A'</span>)</span><br><span class="line">        <span class="keyword">if</span> self.value() == <span class="string">'B'</span>:</span><br><span class="line">            <span class="keyword">return</span> queryset.filter(name__icontains=<span class="string">'客户B'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@admin.register(models.Project)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProjectAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></span><br><span class="line">    list_display = (<span class="string">'name'</span>, <span class="string">'project_type'</span>, <span class="string">'manager'</span>, <span class="string">'section_type'</span>, <span class="string">'description'</span>, <span class="string">'start_time'</span>,)</span><br><span class="line">    list_filter = [<span class="string">'project_type'</span>, NameKeywordFilter, ]  <span class="comment"># 引入自定义筛选类</span></span><br></pre></td></tr></table></figure><ul><li></li><li>一对多字段编辑(主子表一起编辑)</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> sqbiz.order <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="comment"># 必须定义在OrderAdmin上方</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderDetailInline</span><span class="params">(admin.TabularInline)</span>:</span></span><br><span class="line">    model = models.OrderDetail</span><br><span class="line">    <span class="comment"># 在主表编辑界面，默认显示2个子表编辑行(不够可手动新增行)</span></span><br><span class="line">    extra = <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@admin.register(Order)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></span><br><span class="line">    inlines = [OrderDetailInline,]</span><br><span class="line">    list_display = (<span class="string">'order_no'</span>, <span class="string">'customer'</span>,)</span><br></pre></td></tr></table></figure><ul><li>ManyToMany多对多字段编辑<ul><li>可以用filter_horizontal或filter_vertical定义字段</li></ul></li></ul><h4 id="添加动作-操作函数-到actions-列表行增加操作按钮"><a href="#添加动作-操作函数-到actions-列表行增加操作按钮" class="headerlink" title="添加动作(操作函数)到actions/列表行增加操作按钮"></a>添加动作(操作函数)到actions/列表行增加操作按钮</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProjectAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></span><br><span class="line">    <span class="comment">## 添加actions</span></span><br><span class="line">    actions = [<span class="string">'confirme'</span>, ]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># queryset为勾选的记录</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">confirme</span><span class="params">(self, request, queryset)</span>:</span></span><br><span class="line">        <span class="comment"># from django.contrib import messages</span></span><br><span class="line">        queryset.update(is_sure=<span class="keyword">True</span>)</span><br><span class="line">        self.message_user(request, <span class="string">'审核通过'</span>)  <span class="comment"># message_user 为 ModelAdmin 提供的 Alert 提示信息函数</span></span><br><span class="line">        <span class="comment"># self.message_user(request, '审核不通过', level=messages.ERROR)</span></span><br><span class="line">    confirme.short_description = <span class="string">'确认'</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 列表行增加操作按钮</span></span><br><span class="line">    list_display = (<span class="string">'name'</span>, <span class="string">'buttons'</span>)  <span class="comment"># buttons为自定义的列表显示字段，具体通过同名函数获取</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">buttons</span><span class="params">(self, obj)</span>:</span></span><br><span class="line">        <span class="keyword">from</span> django.utils.html <span class="keyword">import</span> format_html</span><br><span class="line">        button_html = <span class="string">"""&lt;a href="/admin/monitor/script/%s/change/"&gt;编辑&lt;/a&gt;"""</span> % (obj.id,)</span><br><span class="line">        <span class="keyword">return</span> format_html(button_html)</span><br><span class="line">    _buttons.short_description = <span class="string">"操作"</span></span><br></pre></td></tr></table></figure><h4 id="自定义用户登录操作"><a href="#自定义用户登录操作" class="headerlink" title="自定义用户登录操作"></a>自定义用户登录操作</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## setting.py</span></span><br><span class="line">AUTH_USER_MODEL = <span class="string">"party.UserLogin"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## party/models.py</span></span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> AbstractUser</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserLogin</span><span class="params">(AbstractUser)</span>:</span></span><br><span class="line">    <span class="string">"""扩展django的User模型"""</span></span><br><span class="line">    id = models.BigAutoField(primary_key=<span class="keyword">True</span>)</span><br><span class="line">    party = models.ForeignKey(<span class="string">'Party'</span>, on_delete=models.CASCADE, null=<span class="keyword">True</span>, blank=<span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line">    first_name = <span class="keyword">None</span></span><br><span class="line">    last_name = <span class="keyword">None</span></span><br><span class="line">    is_staff = <span class="keyword">True</span></span><br><span class="line">    <span class="comment"># is_superuser = None</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        db_table = <span class="string">'biz_user_login'</span></span><br><span class="line">        verbose_name_plural = <span class="string">'登录用户'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## party/admin.py</span></span><br><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> forms</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.forms <span class="keyword">import</span> ReadOnlyPasswordHashField</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.admin <span class="keyword">import</span> UserAdmin</span><br><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> sqbiz.party <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserLoginChangeForm</span><span class="params">(forms.ModelForm)</span>:</span></span><br><span class="line">    password = ReadOnlyPasswordHashField()</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = models.UserLogin</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_password</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.initial[<span class="string">"password"</span>]</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserLoginCreateForm</span><span class="params">(forms.ModelForm)</span>:</span></span><br><span class="line">    password1 = forms.CharField(label=<span class="string">'密码'</span>, widget=forms.PasswordInput)</span><br><span class="line">    password2 = forms.CharField(label=<span class="string">'密码确认'</span>, widget=forms.PasswordInput)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = models.UserLogin</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_password2</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""校验字段(clean_字段名)"""</span></span><br><span class="line">        password1 = self.cleaned_data.get(<span class="string">"password1"</span>)</span><br><span class="line">        password2 = self.cleaned_data.get(<span class="string">"password2"</span>)</span><br><span class="line">        <span class="keyword">if</span> password1 <span class="keyword">and</span> password2 <span class="keyword">and</span> password1 != password2:</span><br><span class="line">            <span class="keyword">raise</span> forms.ValidationError(<span class="string">"密码不匹配"</span>)</span><br><span class="line">        <span class="keyword">return</span> password2</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">save</span><span class="params">(self, commit=True)</span>:</span></span><br><span class="line">        user = super(UserLoginCreateForm, self).save(commit=<span class="keyword">False</span>)</span><br><span class="line">        user.set_password(self.cleaned_data[<span class="string">"password1"</span>])</span><br><span class="line">        <span class="keyword">if</span> commit:</span><br><span class="line">            user.save()</span><br><span class="line">        <span class="keyword">return</span> user</span><br><span class="line"></span><br><span class="line"><span class="meta">@admin.register(models.UserLogin)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserLoginAdmin</span><span class="params">(UserAdmin)</span>:</span></span><br><span class="line">    form = UserLoginChangeForm</span><br><span class="line">    add_form = UserLoginCreateForm</span><br><span class="line"></span><br><span class="line">    list_display = (<span class="string">'username'</span>, <span class="string">'party'</span>)</span><br><span class="line">    list_filter = (<span class="string">'is_superuser'</span>, <span class="string">'is_active'</span>, <span class="string">'groups'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># fields = ['username', 'password', 'party'] # 新增/修改暴露字段</span></span><br><span class="line">    <span class="comment"># 修改表单暴露字段(基于Key分栏显示)</span></span><br><span class="line">    fieldsets = (</span><br><span class="line">        (<span class="keyword">None</span>, &#123;<span class="string">'fields'</span>: (<span class="string">'username'</span>, <span class="string">'password'</span>, <span class="string">'email'</span>,)&#125;),</span><br><span class="line">        (<span class="string">'Party信息'</span>, &#123;<span class="string">'fields'</span>: (<span class="string">'party'</span>,)&#125;),</span><br><span class="line">    )</span><br><span class="line">    <span class="comment"># 新增表单暴露字段</span></span><br><span class="line">    add_fieldsets = (</span><br><span class="line">        (<span class="keyword">None</span>, &#123;<span class="string">'classes'</span>: (<span class="string">'my-field-set-css-class'</span>,),</span><br><span class="line">                <span class="string">'fields'</span>: (<span class="string">'username'</span>, <span class="string">'password1'</span>, <span class="string">'password2'</span>, <span class="string">'email'</span>, <span class="string">'party'</span>,)&#125;),</span><br><span class="line">    )</span><br></pre></td></tr></table></figure><h4 id="自定义Django后台名称和favicon图标"><a href="#自定义Django后台名称和favicon图标" class="headerlink" title="自定义Django后台名称和favicon图标"></a>自定义Django后台名称和favicon图标</h4><ul><li>修改默认的Django标题 <a href="https://aber.sh/articles/Django-Admin-Name/" target="_blank" rel="noopener">^5</a></li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.views.generic <span class="keyword">import</span> RedirectView</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在配置完static路径的情况下使用</span></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">'favicon.ico'</span>, RedirectView.as_view(url=<span class="string">'static/theme/default/images/favicon.ico'</span>)),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在总入口urls.py中修改</span></span><br><span class="line">admin.site.site_header = <span class="string">'我在后台首页左上角'</span></span><br><span class="line">admin.site.site_title = <span class="string">'我在浏览器标签后面'</span></span><br><span class="line">admin.site.index_title = <span class="string">'我在浏览器标签前面'</span></span><br></pre></td></tr></table></figure><h4 id="扩展主题"><a href="#扩展主题" class="headerlink" title="扩展主题"></a>扩展主题</h4><ul><li>使用主题插件如：<a href="https://github.com/newpanjing/simpleui" target="_blank" rel="noopener">simpleui</a>、<a href="https://github.com/sehmaschine/django-grappelli" target="_blank" rel="noopener">Grappelli</a></li></ul><h3 id="django-contrib-contenttypes"><a href="#django-contrib-contenttypes" class="headerlink" title="django.contrib.contenttypes"></a>django.contrib.contenttypes</h3><blockquote><p>源码参考【A02_DjangoTest】</p></blockquote><ul><li>主要用于一张表A和多张表关联，表A中一个字段用于存其他的表名，另外一个字段用于存储其他表的主键</li><li>示例</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## models.py</span></span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> django.contrib.contenttypes.fields <span class="keyword">import</span> GenericForeignKey, GenericRelation</span><br><span class="line"><span class="keyword">from</span> django.contrib.contenttypes.models <span class="keyword">import</span> ContentType</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HeadImage</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    username = models.CharField(max_length=<span class="number">32</span>, verbose_name=<span class="string">'用户姓名'</span>)</span><br><span class="line">    <span class="comment"># 不生成表字段，主要方便查询</span></span><br><span class="line">    image_list = GenericRelation(<span class="string">'Image'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BannerImage</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    name = models.CharField(max_length=<span class="number">64</span>)</span><br><span class="line">    href = models.CharField(max_length=<span class="number">255</span>, verbose_name=<span class="string">'Banner点击后的连接'</span>)</span><br><span class="line">    <span class="comment"># 不生成表字段，主要方便查询</span></span><br><span class="line">    image_list = GenericRelation(<span class="string">'Image'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Image</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    path = models.CharField(max_length=<span class="number">255</span>)</span><br><span class="line">    <span class="comment"># content_type最终会在Image表中生成一个字段content_type_id，此字段对应表 django_content_type</span></span><br><span class="line">    content_type = models.ForeignKey(ContentType, verbose_name=<span class="string">'关联的表类型'</span>, on_delete=models.CASCADE)</span><br><span class="line">    object_id = models.IntegerField(verbose_name=<span class="string">'关联表的主键ID'</span>)</span><br><span class="line">    <span class="comment"># 不会生成表字段，主要方便操作数据</span></span><br><span class="line">    content_object = GenericForeignKey(<span class="string">'content_type'</span>, <span class="string">'object_id'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## views.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_contenttypes_create</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="string">'''创建数据'''</span></span><br><span class="line">    banner = models.BannerImage.objects.filter(name=<span class="string">'home'</span>).first()</span><br><span class="line">    models.Image.objects.create(path=<span class="string">'home1.jpg'</span>, content_object=banner)</span><br><span class="line">    models.Image.objects.create(path=<span class="string">'home2.jpg'</span>, content_object=banner)</span><br><span class="line">    models.Image.objects.create(path=<span class="string">'home3.jpg'</span>, content_object=banner)</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">'test_contenttypes_create...'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_contenttypes_list</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="string">'''查询数据'''</span></span><br><span class="line">    banner = models.BannerImage.objects.filter(id=<span class="number">1</span>).first()</span><br><span class="line">    image_list = banner.image_list.all()</span><br><span class="line">    <span class="comment"># &lt;QuerySet [&lt;Image: Image object (1)&gt;, &lt;Image: Image object (2)&gt;, &lt;Image: Image object (3)&gt;]&gt;</span></span><br><span class="line">    print(image_list)</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">'test_contenttypes_list...'</span>)</span><br></pre></td></tr></table></figure><h2 id="django中间件-MIDDLEWARE"><a href="#django中间件-MIDDLEWARE" class="headerlink" title="django中间件(MIDDLEWARE)"></a>django中间件(MIDDLEWARE)</h2><ul><li>中间件类型：<code>process_request</code>、<code>process_view</code>、<code>process_response</code>、<code>process_exception</code>、<code>process_render_template</code></li><li>中间件执行顺序：用户请求 -&gt; 经过所有process_request -&gt; 视图函数 -&gt; 经过所有process_view</li><li>CSRF(Cross-site request forgery)跨站请求伪造<ul><li>全站开启或关闭，看中间件配置中是否有：’django.middleware.csrf.CsrfViewMiddleware’</li><li>在process_view中检查视图是否有装饰器<code>@crsf_exempt</code>(全局有csrf时，此函数不考虑csrf)、<code>@crsf_protect</code>(全局无时，此函数考虑csrf)</li><li>需要csrf检查时，从前请求体或cookies中获取token</li><li>在csrf存在时，且未CBV模式下，去掉某个url的csrf功能，有两种方式<ul><li>View子类上加<code>@method_decorator(csrf_exempt, name=&#39;dispatch&#39;)</code></li><li>View子类重写dispatch方法，并在dispatch方法上加<code>@method_decorator(csrf_exempt)</code>(加在其他方法上无效)</li></ul></li><li>使用时在html的表单中加入 &#123;%csrf_token%&#125;</li></ul></li></ul><h2 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h2><ul><li>覆盖500/404等异常展示：直接在templates目录中加404.html即可覆盖默认页面显示</li><li>自定义异常执行方法</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># django自定义错误返回处理方法</span></span><br><span class="line"><span class="comment">## urls.py</span></span><br><span class="line">handler404 = <span class="string">"myapp.views.page_not_found"</span></span><br><span class="line">handler500 = <span class="string">"myapp.views.page_error"</span></span><br><span class="line">handler403 = <span class="string">"myapp.views.permission_denied"</span></span><br><span class="line">handler400 = <span class="string">"myapp.views.bad_request"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## myapp/views.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">page_not_found</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render_to_response(<span class="string">'404.html'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">page_error</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render_to_response(<span class="string">'500.html'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">permission_denied</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render_to_response(<span class="string">'403.html'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bad_request</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render_to_response(<span class="string">'400.html'</span>)</span><br></pre></td></tr></table></figure><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### setting.py</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取项目目录</span></span><br><span class="line">BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))</span><br><span class="line"><span class="comment"># 开启调试模式，出错后业务会显示堆栈信息，生成环境需要关闭</span></span><br><span class="line">DEBUG = bool(os.getenv(<span class="string">'DJANGO_DEBUG'</span>, <span class="keyword">True</span>))  <span class="comment"># 环境变量设置DJANGO_DEBUG=''</span></span><br><span class="line"><span class="comment"># 允许对外访问的主机地址。如增加服务器的内网地址，则可以通过本服务器的内网地址进行访问</span></span><br><span class="line">ALLOWED_HOSTS = [</span><br><span class="line">    <span class="string">'127.0.0.1'</span>,</span><br><span class="line">    <span class="string">'localhost'</span>,</span><br><span class="line">] + [<span class="string">'*'</span>] <span class="keyword">if</span> os.getenv(<span class="string">'ALLOWED_HOSTS'</span>) <span class="keyword">is</span> <span class="keyword">None</span> <span class="keyword">else</span> os.getenv(<span class="string">'ALLOWED_HOSTS'</span>).split(<span class="string">","</span>)</span><br><span class="line"><span class="comment"># 安装的apps(如要显示某app的admin模块，则必须先注册该app)</span></span><br><span class="line">INSTALLED_APPS = []</span><br><span class="line"><span class="comment"># 引入的中间件</span></span><br><span class="line">MIDDLEWARE = []</span><br><span class="line"><span class="comment"># 数据库连接</span></span><br><span class="line">DATABASES = &#123;</span><br><span class="line">    <span class="comment"># 'default': &#123;</span></span><br><span class="line">    <span class="comment">#     'ENGINE': 'django.db.backends.sqlite3',</span></span><br><span class="line">    <span class="comment">#     'NAME': os.path.join(BASE_DIR, 'db.sqlite3'),</span></span><br><span class="line">    <span class="comment"># &#125;,</span></span><br><span class="line">    <span class="string">'default'</span>: &#123;</span><br><span class="line">        <span class="string">'ENGINE'</span>: <span class="string">'django.db.backends.mysql'</span>,</span><br><span class="line">        <span class="string">'NAME'</span>: os.getenv(<span class="string">'DATABASES_NAME'</span>, <span class="string">'django_rest'</span>),</span><br><span class="line">        <span class="string">'HOST'</span>: os.getenv(<span class="string">'DATABASES_HOST'</span>, <span class="string">'localhost'</span>),</span><br><span class="line">        <span class="string">'PORT'</span>: os.getenv(<span class="string">'DATABASES_PORT'</span>, <span class="string">'3306'</span>),</span><br><span class="line">        <span class="string">'USER'</span>: os.getenv(<span class="string">'DATABASES_USER'</span>, <span class="string">'root'</span>),</span><br><span class="line">        <span class="string">'PASSWORD'</span>: os.getenv(<span class="string">'DATABASES_PASSWORD'</span>, <span class="string">'root'</span>),</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 语言</span></span><br><span class="line">LANGUAGE_CODE = <span class="string">'zh-Hans'</span></span><br><span class="line"><span class="comment"># 时区</span></span><br><span class="line">TIME_ZONE = <span class="string">'Asia/Shanghai'</span></span><br><span class="line">USE_I18N = <span class="keyword">True</span></span><br><span class="line"><span class="comment"># 语言环境规定的日期时间格式具有更高的优先级，将忽略 `DATE_FORMAT = 'Y-m-d'` 和 `DATETIME_FORMAT = 'Y-m-d H:i:s'` 的配置</span></span><br><span class="line">USE_L10N = <span class="keyword">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 静态文件目录</span></span><br><span class="line">STATIC_URL = <span class="string">'/static/'</span></span><br><span class="line">STATIC_ROOT = <span class="string">'static'</span>  <span class="comment"># 为项目目录下的static文件夹</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 跨域配置</span></span><br><span class="line">CORS_ORIGIN_ALLOW_ALL = <span class="keyword">True</span></span><br><span class="line"><span class="comment"># CORS_ORIGIN_WHITELIST = (</span></span><br><span class="line"><span class="comment">#     'localhost:8080',</span></span><br><span class="line"><span class="comment">#     '127.0.0.1:8080'</span></span><br><span class="line"><span class="comment"># )</span></span><br><span class="line">CORS_ALLOW_METHODS = (</span><br><span class="line">    <span class="string">'DELETE'</span>,</span><br><span class="line">    <span class="string">'GET'</span>,</span><br><span class="line">    <span class="string">'OPTIONS'</span>,</span><br><span class="line">    <span class="string">'PATCH'</span>,</span><br><span class="line">    <span class="string">'POST'</span>,</span><br><span class="line">    <span class="string">'PUT'</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志</span></span><br><span class="line">LOGGING = &#123;</span><br><span class="line">    <span class="string">'version'</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">'disable_existing_loggers'</span>: <span class="keyword">False</span>,</span><br><span class="line">    <span class="string">'handlers'</span>: &#123;</span><br><span class="line">        <span class="string">'console'</span>: &#123;</span><br><span class="line">            <span class="string">'class'</span>: <span class="string">'logging.StreamHandler'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">'loggers'</span>: &#123;</span><br><span class="line">        <span class="comment"># 打印数据库执行语句</span></span><br><span class="line">        <span class="string">'django.db.backends'</span>: &#123;</span><br><span class="line">            <span class="string">'handlers'</span>: [<span class="string">'console'</span>],</span><br><span class="line">            <span class="string">'level'</span>: <span class="string">'DEBUG'</span> <span class="keyword">if</span> DEBUG <span class="keyword">else</span> <span class="string">'INFO'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="杂项"><a href="#杂项" class="headerlink" title="杂项"></a>杂项</h2><h3 id="静态资源"><a href="#静态资源" class="headerlink" title="静态资源"></a>静态资源</h3><blockquote><p>django在配置文件中设置<code>DEBUG = False</code>后静态资源404问题。解决方式如以下几种：</p></blockquote><ul><li><code>python manage.py runserver --insecure</code> 启动加参数<code>--insecure</code>(正式环境中不建议)</li><li>解决方法</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 在项目目录创建static文件</span></span><br><span class="line"><span class="comment">## pybiz/settings.py 创建静态资源目录</span></span><br><span class="line">STATIC_URL = <span class="string">'/static/'</span></span><br><span class="line"><span class="comment"># STATIC_ROOT = ("/home/data/static/")</span></span><br><span class="line">STATIC_ROOT = <span class="string">'static'</span>  <span class="comment"># 默认基于BASE_DIR</span></span><br><span class="line"><span class="comment"># STATICFILES_DIRS = [</span></span><br><span class="line"><span class="comment">#     os.path.join(BASE_DIR, 'static/pub'),  # 不能包含STATIC_ROOT </span></span><br><span class="line"><span class="comment"># ]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 收集各模块的静态资源文件到上述目录</span></span><br><span class="line">python manage.py collectstatic</span><br><span class="line"></span><br><span class="line"><span class="comment">## 暴露静态资源目录</span></span><br><span class="line"><span class="comment"># 法一：通过django访问</span></span><br><span class="line"><span class="comment"># pybiz/urls.py</span></span><br><span class="line"><span class="keyword">from</span> django.views <span class="keyword">import</span> static</span><br><span class="line"><span class="keyword">from</span> pybiz <span class="keyword">import</span> settings</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r'^static/(?P&lt;path&gt;.*)$'</span>, static.serve, &#123;<span class="string">'document_root'</span>: settings.STATIC_ROOT&#125;, name=<span class="string">'static'</span>),  <span class="comment"># 和上文STATIC_URL对应 </span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 法二：使用nginx暴露</span></span><br></pre></td></tr></table></figure><h3 id="请求对象"><a href="#请求对象" class="headerlink" title="请求对象"></a>请求对象</h3><ul><li><code>request.POST[&#39;username&#39;]</code> 或者 <code>request.POST.get(&#39;username&#39;)</code> 获取普通input的值。参考python字典取值<ul><li>如果传递过来的数值不为空，那么这两种方法都没有错误，可以得到相同的结果。但是如果传递过来的数值为空，那么<code>request.POST[&#39;username&#39;]</code>则会提示Keyerror错误，而<code>request.POST.get(&#39;username&#39;)</code>则不会报错，而是返回一个None</li><li>request.POST.get(‘username’, ‘default_value’)</li><li><code>request.GET</code>同理</li></ul></li><li><code>request.POST.getlist(&#39;hobby&#39;)</code> 获取checkbox的值</li><li><code>username = self.request.query_params.get(&#39;username&#39;, None)</code> 获取url参数</li></ul><h3 id="请求生命周期"><a href="#请求生命周期" class="headerlink" title="请求生命周期"></a>请求生命周期</h3><p><img src="/data/images/lang/django-request.png" alt="django-request"></p><h3 id="发送邮件"><a href="#发送邮件" class="headerlink" title="发送邮件"></a>发送邮件</h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## settings.py</span></span><br><span class="line">EMAIL_BACKEND = <span class="string">'django.core.mail.backends.smtp.EmailBackend'</span></span><br><span class="line">EMAIL_USE_TLS = <span class="keyword">False</span></span><br><span class="line">EMAIL_HOST = <span class="string">'smtp.163.com'</span></span><br><span class="line">EMAIL_PORT = <span class="number">25</span></span><br><span class="line">EMAIL_HOST_USER = <span class="string">'aezocn@163.com'</span></span><br><span class="line">EMAIL_HOST_PASSWORD = <span class="string">'XXX'</span>  <span class="comment"># 163的客户端授权码</span></span><br><span class="line">DEFAULT_FROM_EMAIL = <span class="string">'aezo-django&lt;aezocn@163.com&gt;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 发送</span></span><br><span class="line"><span class="keyword">from</span> django.core.mail <span class="keyword">import</span> send_mail, send_mass_mail</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送一份邮件(此处为普通文本，可以使用\n，\t等，还可使用超文本)</span></span><br><span class="line">send_mail(<span class="string">'Subject here'</span>, <span class="string">'Here is the message.'</span>, <span class="string">'from@example.com'</span>, [<span class="string">'to@example.com'</span>], fail_silently=<span class="keyword">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送多份邮件</span></span><br><span class="line">message1 = (<span class="string">'Subject here'</span>, <span class="string">'Here is the message'</span>, <span class="keyword">None</span>, [<span class="string">'first@example.com'</span>, <span class="string">'other@example.com'</span>])  <span class="comment"># 接收人为多个</span></span><br><span class="line">message2 = (<span class="string">'Another Subject'</span>, <span class="string">'Here is another message'</span>, <span class="string">'hello &lt;from@example.com&gt;'</span>, [<span class="string">'second@test.com'</span>])</span><br><span class="line">send_mass_mail((message1, message2), fail_silently=<span class="keyword">False</span>)</span><br></pre></td></tr></table></figure><h3 id="记录日志"><a href="#记录日志" class="headerlink" title="记录日志"></a>记录日志</h3><ul><li>脚本中使用</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging  <span class="comment"># python内置库</span></span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(<span class="string">'log'</span>)  <span class="comment"># log为logger名称，在settings.py中配置了此名称log的处理方式</span></span><br><span class="line"></span><br><span class="line">logger.info(<span class="string">'hello world...'</span>)</span><br><span class="line">logger.exception(e)</span><br></pre></td></tr></table></figure><ul><li>settings.py</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">cur_path = os.path.dirname(os.path.realpath(__file__))</span><br><span class="line">log_path = os.path.join(os.path.dirname(cur_path), <span class="string">'runtime/logs'</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(log_path): os.makedirs(log_path)  <span class="comment"># 如果不存在这个logs文件夹，就自动创建一个</span></span><br><span class="line"></span><br><span class="line">LOGGING = &#123;</span><br><span class="line">    <span class="string">'version'</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">'disable_existing_loggers'</span>: <span class="keyword">True</span>,</span><br><span class="line">    <span class="string">'formatters'</span>: &#123;</span><br><span class="line">        <span class="comment"># 日志格式</span></span><br><span class="line">        <span class="string">'standard'</span>: &#123;</span><br><span class="line">            <span class="string">'format'</span>: <span class="string">'[%(asctime)s] [%(filename)s:%(lineno)d] [%(module)s:%(funcName)s] '</span></span><br><span class="line">                      <span class="string">'[%(levelname)s]- %(message)s'</span>&#125;,</span><br><span class="line">        <span class="comment"># 简单格式</span></span><br><span class="line">        <span class="string">'simple'</span>: &#123;</span><br><span class="line">            <span class="string">'format'</span>: <span class="string">'%(levelname)s %(message)s'</span></span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment"># 过滤</span></span><br><span class="line">    <span class="string">'filters'</span>: &#123;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment"># 定义具体处理日志的方式</span></span><br><span class="line">    <span class="string">'handlers'</span>: &#123;</span><br><span class="line">        <span class="comment"># 默认记录所有日志</span></span><br><span class="line">        <span class="string">'default'</span>: &#123;</span><br><span class="line">            <span class="string">'level'</span>: <span class="string">'INFO'</span>,</span><br><span class="line">            <span class="string">'class'</span>: <span class="string">'logging.handlers.RotatingFileHandler'</span>,</span><br><span class="line">            <span class="string">'filename'</span>: os.path.join(log_path, <span class="string">'all-&#123;&#125;.log'</span>.format(time.strftime(<span class="string">'%Y-%m-%d'</span>))),</span><br><span class="line">            <span class="string">'maxBytes'</span>: <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">5</span>,  <span class="comment"># 文件大小</span></span><br><span class="line">            <span class="string">'backupCount'</span>: <span class="number">30</span>,  <span class="comment"># 备份数</span></span><br><span class="line">            <span class="string">'formatter'</span>: <span class="string">'standard'</span>,  <span class="comment"># 输出格式</span></span><br><span class="line">            <span class="string">'encoding'</span>: <span class="string">'utf-8'</span>,  <span class="comment"># 设置默认编码，否则打印出来汉字乱码</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment"># 输出错误日志</span></span><br><span class="line">        <span class="string">'error'</span>: &#123;</span><br><span class="line">            <span class="string">'level'</span>: <span class="string">'ERROR'</span>,</span><br><span class="line">            <span class="string">'class'</span>: <span class="string">'logging.handlers.RotatingFileHandler'</span>,</span><br><span class="line">            <span class="string">'filename'</span>: os.path.join(log_path, <span class="string">'error-&#123;&#125;.log'</span>.format(time.strftime(<span class="string">'%Y-%m-%d'</span>))),</span><br><span class="line">            <span class="string">'maxBytes'</span>: <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">5</span>,  <span class="comment"># 文件大小</span></span><br><span class="line">            <span class="string">'backupCount'</span>: <span class="number">7</span>,  <span class="comment"># 备份数</span></span><br><span class="line">            <span class="string">'formatter'</span>: <span class="string">'standard'</span>,  <span class="comment"># 输出格式</span></span><br><span class="line">            <span class="string">'encoding'</span>: <span class="string">'utf-8'</span>,  <span class="comment"># 设置默认编码</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment"># 控制台输出</span></span><br><span class="line">        <span class="string">'console'</span>: &#123;</span><br><span class="line">            <span class="string">'level'</span>: <span class="string">'DEBUG'</span>,</span><br><span class="line">            <span class="string">'class'</span>: <span class="string">'logging.StreamHandler'</span>,</span><br><span class="line">            <span class="string">'formatter'</span>: <span class="string">'standard'</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment"># 输出info日志</span></span><br><span class="line">        <span class="string">'info'</span>: &#123;</span><br><span class="line">            <span class="string">'level'</span>: <span class="string">'INFO'</span>,</span><br><span class="line">            <span class="string">'class'</span>: <span class="string">'logging.handlers.RotatingFileHandler'</span>,</span><br><span class="line">            <span class="string">'filename'</span>: os.path.join(log_path, <span class="string">'info-&#123;&#125;.log'</span>.format(time.strftime(<span class="string">'%Y-%m-%d'</span>))),</span><br><span class="line">            <span class="string">'maxBytes'</span>: <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">5</span>,</span><br><span class="line">            <span class="string">'backupCount'</span>: <span class="number">15</span>,</span><br><span class="line">            <span class="string">'formatter'</span>: <span class="string">'standard'</span>,</span><br><span class="line">            <span class="string">'encoding'</span>: <span class="string">'utf-8'</span>,  <span class="comment"># 设置默认编码</span></span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment"># 配置用哪几种 handlers 来处理日志</span></span><br><span class="line">    <span class="string">'loggers'</span>: &#123;</span><br><span class="line">        <span class="comment"># 类型为 django 处理所有类型的日志，默认调用</span></span><br><span class="line">        <span class="string">'django'</span>: &#123;</span><br><span class="line">            <span class="string">'handlers'</span>: [<span class="string">'default'</span>, <span class="string">'console'</span>],</span><br><span class="line">            <span class="string">'level'</span>: <span class="string">'INFO'</span>,</span><br><span class="line">            <span class="string">'propagate'</span>: <span class="keyword">False</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment"># log 调用时需要当作参数传入</span></span><br><span class="line">        <span class="string">'log'</span>: &#123;</span><br><span class="line">            <span class="string">'handlers'</span>: [<span class="string">'error'</span>, <span class="string">'info'</span>, <span class="string">'console'</span>, <span class="string">'default'</span>],</span><br><span class="line">            <span class="string">'level'</span>: <span class="string">'INFO'</span>,</span><br><span class="line">            <span class="string">'propagate'</span>: <span class="keyword">True</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment"># 打印数据库执行语句</span></span><br><span class="line">        <span class="string">'django.db.backends'</span>: &#123;</span><br><span class="line">            <span class="string">'handlers'</span>: [<span class="string">'console'</span>],</span><br><span class="line">            <span class="string">'level'</span>: <span class="string">'DEBUG'</span> <span class="keyword">if</span> DEBUG <span class="keyword">else</span> <span class="string">'INFO'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="模块打包成python包"><a href="#模块打包成python包" class="headerlink" title="模块打包成python包"></a>模块打包成python包</h3><ul><li><code>pip install setuptools</code> 安装打包工具</li><li><code>python setup.py sdist</code> 执行打包</li><li><code>pip install --user django-polls/dist/django-polls-0.1.tar.gz</code> 基于用户安装 <code>django-polls</code>, 如果基于<code>virtualenv</code>安装允许同时运行多个相互独立的Python环境，每个环境都有各自库和应用包命名空间的拷贝</li><li><code>pip list</code> 查看包列表</li><li><code>pip uninstall django-polls</code> 卸载包</li></ul><h3 id="FBV-CBV模式"><a href="#FBV-CBV模式" class="headerlink" title="FBV/CBV模式"></a>FBV/CBV模式</h3><ul><li>函数作为视图或类作为视图，源码参考【A02_DjangoTest】</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># FBV: function base view</span></span><br><span class="line"><span class="comment"># CBV: class base view</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### url.py</span></span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r'^users/'</span>, views.users), <span class="comment"># FBV</span></span><br><span class="line">    url(<span class="string">r'^students/'</span>, views.StudentsView.as_view()), <span class="comment"># CBV</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">### views.py</span></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render, HttpResponse</span><br><span class="line"></span><br><span class="line"><span class="comment">## FBV</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">users</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="comment"># if request.method == "GET":</span></span><br><span class="line">    <span class="comment">#     pass</span></span><br><span class="line">    user_list = [<span class="string">'smalle'</span>, <span class="string">'aezocn'</span>]</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(json.dumps(user_list))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.views <span class="keyword">import</span> View</span><br><span class="line"></span><br><span class="line"><span class="comment">## CBV: 根据不同的Http类型自动选择对应方法</span></span><br><span class="line"><span class="keyword">from</span> django.views <span class="keyword">import</span> View</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyBaseView</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="comment"># 装饰器作用(拦截器)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dispatch</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">        print(<span class="string">'before...'</span>)</span><br><span class="line">        <span class="comment"># 此时MyBaseView无父类，则到self(StudentsView)的其他父类查找dispatch</span></span><br><span class="line">        ret = super(MyBaseView, self).dispatch(request, *args, **kwargs)</span><br><span class="line">        print(<span class="string">'end...'</span>)</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StudentsView</span><span class="params">(MyBaseView, View)</span>:</span> <span class="comment"># 多继承(优先级从左到右)，寻找自身属性或方法 -&gt; 寻找最左边父类的属性或方法 -&gt; 寻找第二个父类的属性或方法 -&gt; ...</span></span><br><span class="line">    <span class="comment"># def dispatch(self, request, *args, **kwargs):</span></span><br><span class="line">    <span class="comment">#     # 反射获取对应的方法(父类View内部也是实现了一个dispatch，其原理也是基于反射实现)</span></span><br><span class="line">    <span class="comment">#     fun = getattr(self, request.method.lower())</span></span><br><span class="line">    <span class="comment">#     return fun(request, *args, **kwargs)</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self,request,*args,**kwargs)</span>:</span></span><br><span class="line">        print(<span class="string">'get...'</span>)</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">'GET...'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self,request,*args,**kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">'POST...'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span><span class="params">(self,request,*args,**kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">'PUT...'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(self,request,*args,**kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">'DELETE...'</span>)</span><br></pre></td></tr></table></figure><h2 id="docker发布"><a href="#docker发布" class="headerlink" title="docker发布"></a>docker发布</h2><ul><li><code>project-root/Dockerfile</code>举例</li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> python:<span class="number">3.6</span></span><br><span class="line"><span class="keyword">MAINTAINER</span> smalle</span><br><span class="line"></span><br><span class="line"><span class="keyword">ARG</span> APP_VERSION=<span class="string">"v1.0.0"</span></span><br><span class="line"><span class="keyword">ENV</span> APP_VERSION=$&#123;APP_VERSION&#125;</span><br><span class="line"><span class="keyword">ENV</span> PYTHONUNBUFFERED <span class="number">1</span></span><br><span class="line"><span class="comment"># 是否开启Django DEBUG，更多配置如下</span></span><br><span class="line"><span class="keyword">ENV</span> DJANGO_DEBUG <span class="string">''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> mkdir /webapps</span></span><br><span class="line"><span class="bash">RUN apt-get update &amp;&amp; apt-get upgrade -y &amp;&amp; apt-get install -y \</span></span><br><span class="line"><span class="bash">libsqlite3-dev</span></span><br><span class="line"><span class="bash">RUN pip install -U pip setuptools</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">COPY requirements.txt /webapps/</span></span><br><span class="line"><span class="bash">RUN pip install -r /webapps/requirements.txt</span></span><br><span class="line"><span class="bash">ADD . /webapps/</span></span><br><span class="line"><span class="bash">WORKDIR /webapps</span></span><br><span class="line"><span class="bash">EXPOSE 80</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">CMD [<span class="string">"/bin/bash"</span>, <span class="string">"-c"</span>, <span class="string">"python manage.py collectstatic --noinput &amp;&amp; python manage.py runserver 0.0.0.0:80"</span>]</span></span><br></pre></td></tr></table></figure><ul><li>setting.py</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">DEBUG = bool(os.getenv(<span class="string">'DJANGO_DEBUG'</span>, <span class="keyword">True</span>))</span><br><span class="line"></span><br><span class="line">ALLOWED_HOSTS = [</span><br><span class="line">    <span class="string">'127.0.0.1'</span>,</span><br><span class="line">    <span class="string">'localhost'</span>,</span><br><span class="line">    <span class="string">'192.168.17.237'</span></span><br><span class="line">] + ([<span class="string">'*'</span>] <span class="keyword">if</span> <span class="keyword">not</span> os.getenv(<span class="string">'ALLOWED_HOSTS'</span>) <span class="keyword">else</span> os.getenv(<span class="string">'ALLOWED_HOSTS'</span>).split(<span class="string">","</span>))</span><br><span class="line"></span><br><span class="line">DATABASES = &#123;</span><br><span class="line">    <span class="string">'default'</span>: &#123;</span><br><span class="line">        <span class="string">'ENGINE'</span>: <span class="string">'django.db.backends.mysql'</span>,</span><br><span class="line">        <span class="string">'NAME'</span>: os.getenv(<span class="string">'DATABASES_NAME'</span>, <span class="string">'django_rest'</span>),</span><br><span class="line">        <span class="string">'HOST'</span>: os.getenv(<span class="string">'DATABASES_HOST'</span>, <span class="string">'localhost'</span>),</span><br><span class="line">        <span class="string">'PORT'</span>: os.getenv(<span class="string">'DATABASES_PORT'</span>, <span class="string">'3306'</span>),</span><br><span class="line">        <span class="string">'USER'</span>: os.getenv(<span class="string">'DATABASES_USER'</span>, <span class="string">'root'</span>),</span><br><span class="line">        <span class="string">'PASSWORD'</span>: os.getenv(<span class="string">'DATABASES_PASSWORD'</span>, <span class="string">'root'</span>),</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>编译<code>docker build --rm -t pybiz:1.0.0 -f ./Dockerfile .</code></li><li>k8s-helm相关配置，其他参考<a href="/_posts/devops/helm.md#Chart说明">Chart说明</a></li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## values.yaml</span></span><br><span class="line"><span class="attr">deployment:</span></span><br><span class="line"><span class="attr">  env:</span></span><br><span class="line"><span class="attr">    ALLOWED_HOSTS:</span> <span class="number">192.168</span><span class="number">.17</span><span class="number">.237</span></span><br><span class="line"><span class="attr">    DATABASES_NAME:</span> <span class="string">pybiz</span></span><br><span class="line"><span class="attr">    DATABASES_HOST:</span> <span class="string">mysql-devops.devops.svc.cluster.local</span></span><br><span class="line"><span class="attr">    DATABASES_PORT:</span> <span class="number">3306</span></span><br><span class="line"><span class="attr">    DATABASES_USER:</span> <span class="string">devops</span></span><br><span class="line"><span class="attr">    DATABASES_PASSWORD:</span> <span class="string">devops</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## templates/deployment.yaml</span></span><br><span class="line"><span class="attr">containers:</span></span><br><span class="line"><span class="attr">  env:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">THIS_POD_IP</span></span><br><span class="line"><span class="attr">    valueFrom:</span></span><br><span class="line"><span class="attr">      fieldRef:</span></span><br><span class="line"><span class="attr">        fieldPath:</span> <span class="string">status.podIP</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">ALLOWED_HOSTS</span></span><br><span class="line">    <span class="comment"># THIS_POD_IP动态获取pod-ip</span></span><br><span class="line"><span class="attr">    value:</span> <span class="string">"$(THIS_POD_IP),<span class="template-variable">&#123;&#123;- .Release.Name -&#125;&#125;</span>.<span class="template-variable">&#123;&#123;- .Release.Namespace -&#125;&#125;</span>.svc,<span class="template-variable">&#123;&#123;- range $k, $v := .Values.ingress.hosts -&#125;&#125;</span><span class="template-variable">&#123;&#123;- $v.host -&#125;&#125;</span><span class="template-variable">&#123;&#123;- end -&#125;&#125;</span>,<span class="template-variable">&#123;&#123; .Values.deployment.env.ALLOWED_HOSTS &#125;&#125;</span>"</span></span><br><span class="line">  <span class="string">&#123;&#123;-</span> <span class="string">range</span> <span class="string">$key,$val</span> <span class="string">:=</span> <span class="string">.Values.deployment.env</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="string">&#123;&#123;-</span> <span class="string">if</span> <span class="string">ne</span> <span class="string">$key</span> <span class="string">"ALLOWED_HOSTS"</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">&#123;&#123;</span> <span class="string">$key</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">    value:</span> <span class="string">"<span class="template-variable">&#123;&#123; $val &#125;&#125;</span>"</span> <span class="comment"># 一定要加双引号</span></span><br><span class="line">  <span class="string">&#123;&#123;-</span> <span class="string">end&#125;&#125;</span></span><br><span class="line">  <span class="string">&#123;&#123;-</span> <span class="string">end&#125;&#125;</span></span><br><span class="line"><span class="string">```</span>                      </span><br><span class="line"></span><br><span class="line"><span class="comment">## python基础</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="string">列表生成式</span></span><br><span class="line"></span><br><span class="line"><span class="string">```py</span></span><br><span class="line"><span class="string">&gt;&gt;&gt;</span> <span class="string">[x</span> <span class="string">*</span> <span class="string">x</span> <span class="string">for</span> <span class="string">x</span> <span class="string">in</span> <span class="string">range(1,</span> <span class="number">11</span><span class="string">)]</span></span><br><span class="line"><span class="string">[1,</span> <span class="number">4</span><span class="string">,</span> <span class="number">9</span><span class="string">,</span> <span class="number">16</span><span class="string">,</span> <span class="number">25</span><span class="string">,</span> <span class="number">36</span><span class="string">,</span> <span class="number">49</span><span class="string">,</span> <span class="number">64</span><span class="string">,</span> <span class="number">81</span><span class="string">,</span> <span class="number">100</span><span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="string">&gt;&gt;&gt;</span> <span class="string">[x</span> <span class="string">*</span> <span class="string">x</span> <span class="string">for</span> <span class="string">x</span> <span class="string">in</span> <span class="string">range(1,</span> <span class="number">11</span><span class="string">)</span> <span class="string">if</span> <span class="string">x</span> <span class="string">%</span> <span class="number">2</span> <span class="string">==</span> <span class="number">0</span><span class="string">]</span></span><br><span class="line"><span class="string">[4,</span> <span class="number">16</span><span class="string">,</span> <span class="number">36</span><span class="string">,</span> <span class="number">64</span><span class="string">,</span> <span class="number">100</span><span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="string">&gt;&gt;&gt;</span> <span class="string">C</span> <span class="string">=</span> <span class="string">[Foo,</span> <span class="string">Bar]</span></span><br><span class="line"><span class="string">&gt;&gt;&gt;</span> <span class="string">[item()</span> <span class="string">for</span> <span class="string">x</span> <span class="string">in</span> <span class="string">C]</span></span><br><span class="line"><span class="string">[Foo(),</span> <span class="string">Bar()]</span></span><br></pre></td></tr></table></figure><ul><li>继承</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 多继承(优先级从左到右)，寻找自身属性或方法 -&gt; 寻找最左边父类的属性或方法 -&gt; 寻找第二个父类的属性或方法 -&gt; ...</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StudentsView</span><span class="params">(MyBaseView, View)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_super</span><span class="params">(self)</span>:</span></span><br><span class="line">    `   <span class="comment"># 获取父类</span></span><br><span class="line">        super(StudentsView, self)</span><br></pre></td></tr></table></figure><ul><li>反射(<code>getattr</code>)</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StudentsView</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run_hello</span><span class="params">(self)</span>:</span></span><br><span class="line">        fun = getattr(self, <span class="string">"hello"</span>)  <span class="comment"># 获取对象的属性或方法</span></span><br><span class="line">        fun()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'hello...'</span>)</span><br></pre></td></tr></table></figure><hr><p>参考文章</p></div><div></div><div></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> smalle</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="http://blog.aezo.cn/2018/09/24/lang/python/django/" title="Django">http://blog.aezo.cn/2018/09/24/lang/python/django/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/python/" rel="tag"># python</a> <a href="/tags/django/" rel="tag"># django</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2018/09/24/lang/python/django-rest-framework/" rel="next" title="Django-Rest-Framework"><i class="fa fa-chevron-left"></i> Django-Rest-Framework</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"> <a href="/2018/10/09/devops/jenkins/" rel="prev" title="Jenkins">Jenkins<i class="fa fa-chevron-right"></i></a></div></div></footer></article><div class="post-spread"></div></div></div><div class="comments" id="comments"></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> 文章目录</li><li class="sidebar-nav-overview" data-target="site-overview"> 站点概览</li></ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="https://avatars0.githubusercontent.com/u/15698218?v=3&u=ce740bf0b67ff0d74990ba6fc644d6e92f572dcb&s=400" alt="smalle"><p class="site-author-name" itemprop="name">smalle</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">159</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/index.html"><span class="site-state-item-count">13</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/index.html"><span class="site-state-item-count">141</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#简介"><span class="nav-number">1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#manage命令"><span class="nav-number">2.</span> <span class="nav-text">manage命令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#hello-world"><span class="nav-number">3.</span> <span class="nav-text">hello world</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Model"><span class="nav-number">4.</span> <span class="nav-text">Model</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#数据库"><span class="nav-number">4.1.</span> <span class="nav-text">数据库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#表结构定义"><span class="nav-number">4.2.</span> <span class="nav-text">表结构定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CRUD"><span class="nav-number">4.3.</span> <span class="nav-text">CRUD</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#基本增删改"><span class="nav-number">4.3.1.</span> <span class="nav-text">基本增删改</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#进阶查询"><span class="nav-number">4.3.2.</span> <span class="nav-text">进阶查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#联表查询"><span class="nav-number">4.3.3.</span> <span class="nav-text">联表查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#QuerySet"><span class="nav-number">4.3.4.</span> <span class="nav-text">QuerySet</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#自带App"><span class="nav-number">5.</span> <span class="nav-text">自带App</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#admin"><span class="nav-number">5.1.</span> <span class="nav-text">admin</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#admin-py-快速生成管理界面"><span class="nav-number">5.1.1.</span> <span class="nav-text">admin.py 快速生成管理界面</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#添加动作-操作函数-到actions-列表行增加操作按钮"><span class="nav-number">5.1.2.</span> <span class="nav-text">添加动作(操作函数)到actions/列表行增加操作按钮</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#自定义用户登录操作"><span class="nav-number">5.1.3.</span> <span class="nav-text">自定义用户登录操作</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#自定义Django后台名称和favicon图标"><span class="nav-number">5.1.4.</span> <span class="nav-text">自定义Django后台名称和favicon图标</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#扩展主题"><span class="nav-number">5.1.5.</span> <span class="nav-text">扩展主题</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#django-contrib-contenttypes"><span class="nav-number">5.2.</span> <span class="nav-text">django.contrib.contenttypes</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#django中间件-MIDDLEWARE"><span class="nav-number">6.</span> <span class="nav-text">django中间件(MIDDLEWARE)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#异常处理"><span class="nav-number">7.</span> <span class="nav-text">异常处理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置"><span class="nav-number">8.</span> <span class="nav-text">配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#杂项"><span class="nav-number">9.</span> <span class="nav-text">杂项</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#静态资源"><span class="nav-number">9.1.</span> <span class="nav-text">静态资源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#请求对象"><span class="nav-number">9.2.</span> <span class="nav-text">请求对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#请求生命周期"><span class="nav-number">9.3.</span> <span class="nav-text">请求生命周期</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#发送邮件"><span class="nav-number">9.4.</span> <span class="nav-text">发送邮件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#记录日志"><span class="nav-number">9.5.</span> <span class="nav-text">记录日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#模块打包成python包"><span class="nav-number">9.6.</span> <span class="nav-text">模块打包成python包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#FBV-CBV模式"><span class="nav-number">9.7.</span> <span class="nav-text">FBV/CBV模式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#docker发布"><span class="nav-number">10.</span> <span class="nav-text">docker发布</span></a></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright"> &copy; 2016 - <span itemprop="copyrightYear">2022</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">smalle</span>&nbsp;&nbsp;&nbsp;&nbsp;<div class="powered-by"> 由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div><div class="powered-by"> 主题 - <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a></div><div class="theme-info cnzz" style="margin:0 0 -5px 10px"><script type="text/javascript">var cnzz_protocol="https:"==document.location.protocol?"https://":"http://";document.write(unescape("%3Cspan id='cnzz_stat_icon_1276691827'%3E%3C/span%3E%3Cscript src='"+cnzz_protocol+"s23.cnzz.com/z_stat.php%3Fid%3D1276691827%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"))</script></div></div><div class="ad"> <span style="font-weight:700">AD&nbsp;&nbsp;&nbsp;&nbsp;</span><div class="theme-info"> <a target="_blank" href="https://promotion.aliyun.com/ntms/yunparter/invite.html?userCode=oby5nolb">阿里云大礼包</a></div></div><div class="aezocn"> <span style="font-weight:700">@AEZO.CN&nbsp;&nbsp;&nbsp;&nbsp;</span><div class="theme-info"> <a target="_blank" href="http://shop.aezo.cn/">杂货铺</a></div></div><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?d82223039d601f2f819f8fe140a63468";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script><script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script type="text/javascript" src="/js/src/js.cookie.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/scroll-cookie.js?v=5.1.1"></script></body></html>