<!doctype html><html class="theme-next mist use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css"><meta name="keywords" content="python,django,restful,"><link rel="alternate" href="/atom.xml" title="月星墙的博客" type="application/atom+xml"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1"><meta name="description" content="简介 django-rest-framework，是一套基于Django 的 REST 框架，是一个强大灵活的构建 Web API 的工具包 官网 pip3 install djangorestframework 安装 10大特性：权限、认证、节流、版本控制、解析器、序列化、分页、视图、路由、渲染器 rest framework 主要基于CBV模式，且大部分特性是基于必须是继承了APIView；F"><meta name="keywords" content="python,django,restful"><meta property="og:type" content="article"><meta property="og:title" content="Django-Rest-Framework"><meta property="og:url" content="http://blog.aezo.cn/2018/09/24/lang/python/django-rest-framework/index.html"><meta property="og:site_name" content="月星墙的博客"><meta property="og:description" content="简介 django-rest-framework，是一套基于Django 的 REST 框架，是一个强大灵活的构建 Web API 的工具包 官网 pip3 install djangorestframework 安装 10大特性：权限、认证、节流、版本控制、解析器、序列化、分页、视图、路由、渲染器 rest framework 主要基于CBV模式，且大部分特性是基于必须是继承了APIView；F"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="https://www.plantuml.com/plantuml/svg/XT7DIiD0403W-px5WESczr9ADGqYj22AthVPCLsJp8R9nAXuLV0PV80-G8y5VPfQ7wFf7pHGubw6sVbs66O7XMYMCajLaLZADUiC9ZfAOdObcS2bZk4i3CEBON0afffCnLO42OHBL68bHGNrCO-QOWUCXS13RR5odC3Vx6FvzRrQp7u_VvRlyzLy0JsRnTsfIDxr_KdgOa_Zg_CYyZSn8Y-dkA-G3EnwtrkieFVMwS3vzTKcKVkukxn4GhRHeRRbjoXZ-sof8VO5rNnmagY0KGkEdS7qgD4sFvWR5BRur8xkSlDVds6zBtOlhMPa2sa5pVbFW46zp_glrm00"><meta property="og:updated_time" content="2021-08-31T06:07:20.361Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Django-Rest-Framework"><meta name="twitter:description" content="简介 django-rest-framework，是一套基于Django 的 REST 框架，是一个强大灵活的构建 Web API 的工具包 官网 pip3 install djangorestframework 安装 10大特性：权限、认证、节流、版本控制、解析器、序列化、分页、视图、路由、渲染器 rest framework 主要基于CBV模式，且大部分特性是基于必须是继承了APIView；F"><meta name="twitter:image" content="https://www.plantuml.com/plantuml/svg/XT7DIiD0403W-px5WESczr9ADGqYj22AthVPCLsJp8R9nAXuLV0PV80-G8y5VPfQ7wFf7pHGubw6sVbs66O7XMYMCajLaLZADUiC9ZfAOdObcS2bZk4i3CEBON0afffCnLO42OHBL68bHGNrCO-QOWUCXS13RR5odC3Vx6FvzRrQp7u_VvRlyzLy0JsRnTsfIDxr_KdgOa_Zg_CYyZSn8Y-dkA-G3EnwtrkieFVMwS3vzTKcKVkukxn4GhRHeRRbjoXZ-sof8VO5rNnmagY0KGkEdS7qgD4sFvWR5BRur8xkSlDVds6zBtOlhMPa2sa5pVbFW46zp_glrm00"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",sidebar:{position:"right",display:"post",offset:12,offset_float:0,b2t:!1,scrollpercent:!1},fancybox:!0,motion:!0,duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"BWD6R9FA4K",apiKey:"3330f3cbaa099dfc30395de5f5b20151",indexName:"blog",hits:{per_page:10},labels:{input_placeholder:"请输入关键字",hits_empty:"我们没有找到任何搜索结果: ${query}",hits_stats:"找到约${hits}条结果（用时${time}ms）"}}}</script><link rel="canonical" href="http://blog.aezo.cn/2018/09/24/lang/python/django-rest-framework/"><title>Django-Rest-Framework | 月星墙的博客</title><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?085f9cd91ef2ad985f791c677472f0d1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-right page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">月星墙的博客</span><span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">Better Code, Better Life</h1></div><div class="site-nav-toggle"> <button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br> 首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br> 分类</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br> 关于</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br> 归档</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br> 标签</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i><br> 站点地图</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br> 搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"> <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><link itemprop="mainEntityOfPage" href="http://blog.aezo.cn/2018/09/24/lang/python/django-rest-framework/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="smalle"><meta itemprop="description" content=""><meta itemprop="image" content="https://avatars0.githubusercontent.com/u/15698218?v=3&u=ce740bf0b67ff0d74990ba6fc644d6e92f572dcb&s=400"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="月星墙的博客"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">Django-Rest-Framework</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-24T21:29:00+08:00">2018-09-24</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/lang/" itemprop="url" rel="index"><span itemprop="name">lang</span></a></span></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><ul><li>django-rest-framework，是一套基于Django 的 REST 框架，是一个强大灵活的构建 Web API 的工具包</li><li><a href="https://www.django-rest-framework.org/" target="_blank" rel="noopener">官网</a></li><li><code>pip3 install djangorestframework</code> 安装</li><li>10大特性：权限、认证、节流、版本控制、解析器、序列化、分页、视图、路由、渲染器</li><li><code>rest framework</code> <strong>主要基于CBV模式，且大部分特性是基于必须是继承了APIView；FBV模式时上述特性无法体现。</strong> FBV/CBV参考：<a href="/_posts/lang/python/django.md">http://blog.aezo.cn/2018/09/24/lang/python/django.md</a></li></ul><h2 id="认证"><a href="#认证" class="headerlink" title="认证"></a>认证</h2><blockquote><p>可参看下文rest framework 源码解析【封装request和认证】。源码参考[A03_DjangoRestFrameworkTest]</p></blockquote><ul><li>自定义认证类</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> exceptions</span><br><span class="line"><span class="keyword">from</span> rest_framework.authentication <span class="keyword">import</span> BaseAuthentication</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyAuthentication</span><span class="params">(BaseAuthentication)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">authenticate</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        token = request._request.GET.get(<span class="string">'token'</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> token:</span><br><span class="line">            <span class="keyword">raise</span> exceptions.AuthenticationFailed(<span class="string">'无效的token'</span>)</span><br><span class="line">        <span class="keyword">return</span> (<span class="string">'hello'</span>, <span class="keyword">None</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 由于继承了BaseAuthentication，其中包含必须的authenticate_header方法，否则需要定义此方法</span></span><br><span class="line">    <span class="comment"># def authenticate_header(self, val):</span></span><br><span class="line">    <span class="comment">#     pass</span></span><br></pre></td></tr></table></figure><ul><li>全局认证类配置</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># setting.py</span></span><br><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="comment"># 全局认证类：从第一个顺序执行认证，直到认证成功/失败</span></span><br><span class="line">    <span class="string">'DEFAULT_AUTHENTICATION_CLASSES'</span>: [</span><br><span class="line">        <span class="comment"># 使用自定自定义认证类</span></span><br><span class="line">        <span class="string">'smtest.utils.auth.MyFirstAuthentication'</span>,</span><br><span class="line">        <span class="string">'smtest.utils.auth.MyAuthentication'</span>,</span><br><span class="line">        <span class="comment"># 使用rest_framework提供认证类</span></span><br><span class="line">        <span class="string">'rest_framework.authentication.TokenAuthentication'</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>局部认证类配置</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NoAuthView</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    <span class="comment"># 配置局部认证类</span></span><br><span class="line">    authentication_classes = [] <span class="comment"># 此时则不会进行认证</span></span><br><span class="line">    <span class="comment"># authentication_classes = [MyAuthentication,] # 此时只执行MyAuthentication这个认证器</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self,request,*args,**kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">'GET...'</span>)</span><br></pre></td></tr></table></figure><ul><li>基于token生成的认证</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## smtest/models.py 实体</span></span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    roles = (</span><br><span class="line">        (<span class="number">1</span>, <span class="string">'普通用户'</span>),</span><br><span class="line">        (<span class="number">2</span>, <span class="string">'VIP'</span>),</span><br><span class="line">        (<span class="number">3</span>, <span class="string">'SVIP'</span>)</span><br><span class="line">    )</span><br><span class="line">    role = models.IntegerField(choices=roles)</span><br><span class="line">    username = models.CharField(max_length=<span class="number">64</span>, unique=<span class="keyword">True</span>)</span><br><span class="line">    password = models.CharField(max_length=<span class="number">64</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserToken</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    user = models.OneToOneField(to=<span class="string">'UserInfo'</span>, on_delete=models.CASCADE) <span class="comment"># 外键的名称为此关联对象引用名加`_id`</span></span><br><span class="line">    token = models.CharField(max_length=<span class="number">64</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## smtest/views.py 登录</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md5</span><span class="params">(username)</span>:</span></span><br><span class="line">    <span class="keyword">import</span> hashlib</span><br><span class="line">    <span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">    ctime = str(time.time())</span><br><span class="line">    m = hashlib.md5(bytes(username, encoding=<span class="string">'utf-8'</span>))</span><br><span class="line">    m.update(bytes(ctime, encoding=<span class="string">'utf-8'</span>))</span><br><span class="line">    <span class="keyword">return</span> m.hexdigest()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 用户名密码认证, 获取token(rest_framework内部已经实现了生成token的方法)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthView</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    authentication_classes = [] <span class="comment"># 此时则不会进行认证</span></span><br><span class="line">    <span class="comment"># permission_classes = [] # 此时不会校验权限(尽管不校验登录, 但是rest framework默认认为是一个匿名用户) # 权限相关代码</span></span><br><span class="line">    <span class="comment"># throttle_classes = [VisitThrottle,] # 节流控制相关代码</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self,request,*args,**kwargs)</span>:</span></span><br><span class="line">        ret = &#123;<span class="string">'code'</span>: <span class="number">1000</span>, <span class="string">'msg'</span>: <span class="keyword">None</span>&#125;</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            username = request._request.POST.get(<span class="string">'username'</span>)</span><br><span class="line">            password = request._request.POST.get(<span class="string">'password'</span>)</span><br><span class="line">            user = models.UserInfo.objects.filter(username=username, password=password).first()</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> user:</span><br><span class="line">                ret[<span class="string">'code'</span>] = <span class="number">1001</span></span><br><span class="line">                ret[<span class="string">'msg'</span>] = <span class="string">"用户名或密码错误"</span></span><br><span class="line">                <span class="keyword">return</span> JsonResponse(ret)  <span class="comment"># 通过 django.http.JsonResponse 返回</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 生成token</span></span><br><span class="line">            token = md5(username)</span><br><span class="line">            models.UserToken.objects.update_or_create(user=user, defaults=&#123;<span class="string">'token'</span>: token&#125;)</span><br><span class="line">            ret[<span class="string">'token'</span>] = token</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            print(e)</span><br><span class="line">            ret[<span class="string">'code'</span>] = <span class="number">1002</span></span><br><span class="line">            ret[<span class="string">'msg'</span>] = <span class="string">"未知错误"</span></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(ret)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## smtest/utils/auth.py 认证</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyAuthentication</span><span class="params">(BaseAuthentication)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">authenticate</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        token = request._request.GET.get(<span class="string">'token'</span>)</span><br><span class="line">        user_token = models.UserToken.objects.filter(token=token).first()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> user_token:</span><br><span class="line">            <span class="keyword">raise</span> exceptions.AuthenticationFailed(<span class="string">'无效的token'</span>)</span><br><span class="line">        <span class="keyword">return</span> (user_token.user, user_token)</span><br></pre></td></tr></table></figure><h3 id="使用rest-framework认证模块"><a href="#使用rest-framework认证模块" class="headerlink" title="使用rest framework认证模块"></a>使用rest framework认证模块</h3><ul><li>setting.py配置</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS = [</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    <span class="string">'rest_framework'</span>,</span><br><span class="line">    <span class="comment"># 会生成表 authtoken_token</span></span><br><span class="line">    <span class="string">'rest_framework.authtoken'</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">'DEFAULT_AUTHENTICATION_CLASSES'</span>: [</span><br><span class="line">        <span class="comment"># 优先基于session认证，然后基于Token认证。session登录成功则不会产生token</span></span><br><span class="line">        <span class="comment"># 'rest_framework.authentication.SessionAuthentication',</span></span><br><span class="line">        <span class="comment"># 根据token认证 -&gt; 获取用户信息 (header中加：-H 'authorization: Token eb1957411275098fffdea0570fcce8817dbbb556')</span></span><br><span class="line">        <span class="comment"># 如果header中无token相关信息则返回None -&gt;&gt; django.contrib.auth.models.AnonymousUser</span></span><br><span class="line">        <span class="string">'rest_framework.authentication.TokenAuthentication'</span>,</span><br><span class="line">        <span class="comment"># 解决 rest_framework.authentication.TokenAuthentication 中无token也可访问问题</span></span><br><span class="line">        <span class="string">'myproject.utils.auths.MyTokenAuthentication'</span>,</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>MyTokenAuthentication</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># myproject/utils/auths.py</span></span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> authentication</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> exceptions</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyTokenAuthentication</span><span class="params">(authentication.TokenAuthentication)</span>:</span></span><br><span class="line">    keyword = <span class="string">'access_token'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">authenticate</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        auth = authentication.get_authorization_header(request).split()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> auth <span class="keyword">or</span> auth[<span class="number">0</span>].lower() != self.keyword.lower().encode():</span><br><span class="line">            <span class="comment"># 也可在对应请求类型中加参数，如GET：?access_token=a9074b1fd0ef2c0f2a6f96dab7963de17d4efa91</span></span><br><span class="line">            data = getattr(request, request._request.method)</span><br><span class="line">            token = data.get(self.keyword)</span><br><span class="line">            <span class="keyword">if</span> token:</span><br><span class="line">                <span class="keyword">return</span> self.authenticate_credentials(token)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> token:</span><br><span class="line">                msg = <span class="string">"请在header中添加access_token信息。如：-H 'Authorization: Token a9074b1fd0ef2c0f2a6f96dab7963de17d4efa91'"</span></span><br><span class="line">                <span class="keyword">raise</span> exceptions.AuthenticationFailed(msg)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 基于用户名密码获取时不校验token</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.authtoken.views <span class="keyword">import</span> ObtainAuthToken</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BizTokenBackend</span><span class="params">(ObtainAuthToken)</span>:</span></span><br><span class="line">    <span class="string">"""基于用户名/密码获取Token"""</span></span><br><span class="line">    <span class="comment"># 登录不进行验证(ObtainAuthToken会走所有的authentication_classes)</span></span><br><span class="line">    authentication_classes = ()</span><br></pre></td></tr></table></figure><ul><li>urls.py</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> myproject.utils.auths <span class="keyword">import</span> BizTokenBackend</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    <span class="comment"># 基于session认证的登录界面和登录/登出处理</span></span><br><span class="line">    <span class="comment"># 引入rest_framework的登录界面(此视图是基于django的backends进行验证, 会在api主页添加Login/Logout超链接)</span></span><br><span class="line">    <span class="comment"># rest_framework的登录界面中提交认证form表单的action为 api-auth/login。登录/登出处理不走APIView的dispatch</span></span><br><span class="line">    <span class="comment"># url(r'^api-auth/', include('rest_framework.urls', namespace='rest_framework')),</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 根据用户名/密码获取Token</span></span><br><span class="line">    <span class="comment"># curl获取token: curl -X POST http://127.0.0.1:8000/api-auth-token/ -F username=admin -F password=admin</span></span><br><span class="line">    <span class="comment"># 返回 &#123;"token": "a9074b1fd0ef2c0f2a6f96dab7963de17d4efa91"&#125; # token保存在表 authtoken_token</span></span><br><span class="line">    url(<span class="string">r'^api-auth-token/'</span>, BizTokenBackend.as_view()),</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure><h2 id="权限"><a href="#权限" class="headerlink" title="权限"></a>权限</h2><blockquote><p>可参看下文rest framework 源码解析【封装request和认证，权限】。源码参考[A03_DjangoRestFrameworkTest]</p></blockquote><ul><li>自定义权限类</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## smtest/utils/permission.py</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.permissions <span class="keyword">import</span> BasePermission</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可不继承BasePermission，但是习惯继承此类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VIPPermission</span><span class="params">(BasePermission)</span>:</span></span><br><span class="line">    <span class="comment"># 无权访问时的提示信息</span></span><br><span class="line">    message = <span class="string">'您尚不是VIP用户'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">has_permission</span><span class="params">(self, request, view)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> request.user.role &gt;= <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SVIPPermission</span><span class="params">(BasePermission)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">has_permission</span><span class="params">(self, request, view)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> request.user.role == <span class="number">3</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">True</span></span><br></pre></td></tr></table></figure><ul><li>全局权限类配置</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># setting.py</span></span><br><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="comment"># 全局权限类</span></span><br><span class="line">    <span class="string">'DEFAULT_PERMISSION_CLASSES'</span>: [</span><br><span class="line">        <span class="string">'smtest.utils.permission.VIPPermission'</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>局部权限类配置</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderView</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    <span class="comment"># 局部权限类配置</span></span><br><span class="line">    permission_classes = [SVIPPermission,]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self,request,*args,**kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">'svip order...'</span>)</span><br></pre></td></tr></table></figure><h2 id="访问控制-节流"><a href="#访问控制-节流" class="headerlink" title="访问控制/节流"></a>访问控制/节流</h2><blockquote><p>可参看下文源码解析【封装request和认证，权限】。源码参考[A03_DjangoRestFrameworkTest]</p></blockquote><ul><li>自定义节流类</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.throttling <span class="keyword">import</span> BaseThrottle, SimpleRateThrottle</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">ADDR_VISIT = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestThrottle</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""自定义节流类(根据IP实现).也可简单继承BaseThrottle"""</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.history = []</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">allow_request</span><span class="params">(self, request, view)</span>:</span></span><br><span class="line">        ctime = time.time()</span><br><span class="line">        <span class="comment"># 获取IP。如果从request取某个属性取不到，则会到request._request中去取</span></span><br><span class="line">        remote_addr = request.META.get(<span class="string">'REMOTE_ADDR'</span>)</span><br><span class="line">        <span class="keyword">if</span> remote_addr <span class="keyword">not</span> <span class="keyword">in</span> ADDR_VISIT:</span><br><span class="line">            ADDR_VISIT[remote_addr] = [ctime,]</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line">        history = ADDR_VISIT.get(remote_addr)</span><br><span class="line">        self.history = history</span><br><span class="line">        <span class="comment"># 最早的一个访问时间如果如果小于当前时间减60秒则移除掉此访问时间记录</span></span><br><span class="line">        <span class="keyword">while</span> history <span class="keyword">and</span> history[<span class="number">-1</span>] &lt; ctime - <span class="number">60</span>:</span><br><span class="line">            history.pop()</span><br><span class="line">        <span class="comment"># 多长时间内最多访问的次数</span></span><br><span class="line">        <span class="keyword">if</span> len(history) &lt; <span class="number">3</span>:</span><br><span class="line">            history.insert(<span class="number">0</span>, ctime)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wait</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">'''还需要等多长时间才可访问'''</span></span><br><span class="line">        ctime = time.time()</span><br><span class="line">        <span class="keyword">return</span> <span class="number">60</span> - (ctime - self.history[<span class="number">-1</span>])</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VisitThrottle</span><span class="params">(SimpleRateThrottle)</span>:</span></span><br><span class="line">    <span class="string">"""继承SimpleRateThrottle节流类：可简单配置访问频率"""</span></span><br><span class="line">    <span class="comment"># 配置文件中 DEFAULT_THROTTLE_RATES 的key名. 'THROTTLE_RATES': &#123;'MyThrottleVIP': '10/m'&#125; # 10/m表示每分钟访问10次</span></span><br><span class="line">    scope = <span class="string">'VisitThrottle'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_cache_key</span><span class="params">(self, request, view)</span>:</span></span><br><span class="line">        <span class="comment"># 返回IP地址</span></span><br><span class="line">        <span class="keyword">return</span> self.get_ident(request)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VIPThrottle</span><span class="params">(SimpleRateThrottle)</span>:</span></span><br><span class="line">    scope = <span class="string">'VIPThrottle'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_cache_key</span><span class="params">(self, request, view)</span>:</span></span><br><span class="line">        <span class="comment"># 返回用户名为缓存key</span></span><br><span class="line">        <span class="keyword">return</span> request.user.username</span><br></pre></td></tr></table></figure><ul><li>全局限流配置</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="comment"># 节流</span></span><br><span class="line">    <span class="string">'DEFAULT_THROTTLE_CLASSES'</span>: [</span><br><span class="line">        <span class="string">'smtest.utils.throttle.VIPThrottle'</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="comment"># 节流频率配置。继承SimpleRateThrottle节流类时，配置的节流频率</span></span><br><span class="line">    <span class="string">'DEFAULT_THROTTLE_RATES'</span>: &#123;</span><br><span class="line">        <span class="string">'VisitThrottle'</span>: <span class="string">'5/m'</span>,</span><br><span class="line">        <span class="string">'VIPThrottle'</span>: <span class="string">'10/m'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>局部限流配置</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderView</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    <span class="comment"># permission_classes = [SVIPPermission,]</span></span><br><span class="line">    <span class="comment"># 局部限流类</span></span><br><span class="line">    throttle_classes = [TestThrottle,]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self,request,*args,**kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">'svip order...'</span>)</span><br></pre></td></tr></table></figure><h2 id="版本控制"><a href="#版本控制" class="headerlink" title="版本控制"></a>版本控制</h2><blockquote><p>原理类似认证。源码参考[A03_DjangoRestFrameworkTest2]</p></blockquote><ul><li>全局配置</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="comment"># 版本控制类(基于路径)。还有基于url参数的控制类QueryParameterVersioning、基于域名的HostNameVersioning(v1.aezo.cn)</span></span><br><span class="line">    <span class="string">'DEFAULT_VERSIONING_CLASS'</span>: <span class="string">'rest_framework.versioning.URLPathVersioning'</span>,</span><br><span class="line">    <span class="comment"># 默认版本</span></span><br><span class="line">    <span class="string">'DEFAULT_VERSION'</span>: <span class="string">'v1'</span>,</span><br><span class="line">    <span class="comment"># 允许的版本</span></span><br><span class="line">    <span class="string">'ALLOWED_VERSIONS'</span>: [<span class="string">'v1'</span>, <span class="string">'v2'</span>],</span><br><span class="line">    <span class="comment"># 版本字段名称(url中正则表达式会用到)</span></span><br><span class="line">    <span class="string">'VERSION_PARAM'</span>: <span class="string">'version'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>url配置</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line">    <span class="comment"># name='t_version'在反向生成url时会用到</span></span><br><span class="line">    url(<span class="string">r'^(?P&lt;version&gt;[v1|v2]+)/test_version/$'</span>, views.VersionTest.as_view(), name=<span class="string">'t_version'</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure><ul><li>版本获取</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render, HttpResponse</span><br><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> reverse</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VersionTest</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="comment"># self.dispatch</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># rest_framework.versioning.QueryParameterVersioning</span></span><br><span class="line">        <span class="comment"># GET /something/?version=v1 HTTP/1.1</span></span><br><span class="line">        <span class="comment"># request._request.GET.get('version')</span></span><br><span class="line">        <span class="comment"># request.query_params.get('version')</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># GET /v1/something/ HTTP/1.1</span></span><br><span class="line">        <span class="comment"># 获取版本</span></span><br><span class="line">        print(request.version)</span><br><span class="line">        <span class="comment"># 获取版本处理对象(rest_framework.versioning.URLPathVersioning)</span></span><br><span class="line">        print(request.versioning_scheme)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 基于rest_framework反向生成绝对路径url(必须传递request参数). http://127.0.0.1:8000/api/v1/test_version/</span></span><br><span class="line">        u1 = request.versioning_scheme.reverse(viewname=<span class="string">'t_version'</span>, request=request)</span><br><span class="line">        print(u1)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 基于django反向生成相对路径url(不传递request参数，则必须传递kwargs参数). /api/v2/test_version/</span></span><br><span class="line">        u2 = reverse(viewname=<span class="string">'t_version'</span>, kwargs=&#123;<span class="string">'version'</span>: <span class="string">'v2'</span>&#125;)</span><br><span class="line">        print(u2)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">'GET...'</span>)</span><br></pre></td></tr></table></figure><h2 id="解析器"><a href="#解析器" class="headerlink" title="解析器"></a>解析器</h2><blockquote><p>源码参考[A03_DjangoRestFrameworkTest2]</p></blockquote><ul><li>全局配置</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="comment"># 全局解析器配置(还有上传文件的 MultiPartParser 等)</span></span><br><span class="line">    <span class="string">'DEFAULT_PARSER_CLASSES'</span>: [<span class="string">'rest_framework.parsers.JSONParser'</span>, <span class="string">'rest_framework.parsers.FormParser'</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>局部配置及获取数据</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ParserTest</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    <span class="comment"># parser_classes = [JSONParser, FormParser] # 局部解析器配置</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="comment"># self.dispatch</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        只有执行request.data时才会执行下列流程(源码从request.data开始查看)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        request.data -&gt;&gt; self._load_data_and_files -&gt;&gt; self._parse -&gt;&gt; self.negotiator.select_parser(self, self.parsers)</span></span><br><span class="line"><span class="string">            -&gt;&gt; select_parser(DefaultContentNegotiation) -&gt;&gt; parser.parse</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        1.获取请求</span></span><br><span class="line"><span class="string">        2.获取用户请求体</span></span><br><span class="line"><span class="string">        3.获取用户请求头，到parser_classes = [JSONParser, FormParser]中循环比较解析器是否支持此请求头(根据media_type判断)</span></span><br><span class="line"><span class="string">        4.相应解析器将请求体进行解析</span></span><br><span class="line"><span class="string">        5.获取数据</span></span><br><span class="line"><span class="string">            JSONParser: application/json &lt;&lt;- &#123;'name': 'smalle'&#125;</span></span><br><span class="line"><span class="string">            FormParser: application/x-www-form-urlencoded &lt;&lt;- &lt;QueryDict: &#123;'name': ['smalle']&#125;&gt;</span></span><br><span class="line"><span class="string">            MultiPartParser: multipart/form-data(普通的表单提交)</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        print(request.data)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">'ParserTest...'</span>)</span><br></pre></td></tr></table></figure><ul><li>django请求头相关<ul><li><code>request.POST</code>中有值(从<code>request.body</code>中取值的)的前提<ul><li>请求头必须是<code>application/x-www-form-urlencoded</code></li><li>请求数据格式必须是<code>name=smalle&amp;age=18</code></li></ul></li><li><code>&lt;form&gt;</code>和<code>ajax</code>默认都是<code>application/x-www-form-urlencoded</code><ul><li><code>&lt;form&gt;</code>的请求格式即为<code>name=smalle&amp;age=18</code></li><li><code>jquery</code>中<code>ajax</code>的<code>data</code>属性传入的值尽管是json对象，但是jquery内部会转换成<code>name=smalle&amp;age=18</code></li></ul></li><li>将ajax的请求头改成<code>application/json</code>，此时<code>request.POST</code>中无值(data何种形式都不行)，<code>request.body</code>中有值</li></ul></li></ul><h2 id="序列化"><a href="#序列化" class="headerlink" title="序列化"></a>序列化</h2><blockquote><p>原理参考下文。源码参考[A03_DjangoRestFrameworkTest2]</p></blockquote><ul><li>实体不序列返回时容易出现类似<code>&lt;Django object &gt; is not JSON serializable</code>的错误。方法如下<ul><li>对于字典类型 <code>return JsonResponse(data)</code> 通过 django.http.JsonResponse 返回</li><li>定义序列化类</li></ul></li></ul><h3 id="定义序列化操作器"><a href="#定义序列化操作器" class="headerlink" title="定义序列化操作器"></a>定义序列化操作器</h3><p>-继承<code>Serializer</code>或<code>ModelSerializer</code></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserRoleSerializer</span><span class="params">(serializers.Serializer)</span>:</span></span><br><span class="line">    <span class="string">"""简单类序列化示例"""</span></span><br><span class="line">    <span class="comment"># 默认属性名为字段名</span></span><br><span class="line">    id = serializers.IntegerField()</span><br><span class="line">    title = serializers.CharField()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfoSerializer</span><span class="params">(serializers.Serializer)</span>:</span></span><br><span class="line">    <span class="string">"""复杂类序列化示例"""</span></span><br><span class="line">    id = serializers.IntegerField()</span><br><span class="line">    username = serializers.CharField()</span><br><span class="line"></span><br><span class="line">    level = serializers.IntegerField()</span><br><span class="line">    <span class="comment"># source指向了model的字段名，此时序列话的key名才可定义成其他。此时结果同上面的level</span></span><br><span class="line">    level_2 = serializers.CharField(source=<span class="string">'level'</span>)</span><br><span class="line">    <span class="comment"># 内部执行了 row.get_xxx_display()</span></span><br><span class="line">    level_name = serializers.CharField(source=<span class="string">'get_level_display'</span>)</span><br><span class="line"></span><br><span class="line">    group = serializers.CharField(source=<span class="string">'group.title'</span>)</span><br><span class="line">    <span class="comment"># 自定义显示，必须定义个方法名为`get_序列化字段名`</span></span><br><span class="line">    roles = serializers.SerializerMethodField()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_roles</span><span class="params">(self, row)</span>:</span></span><br><span class="line">        roles = row.role.all()</span><br><span class="line">        ret = []</span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> roles:</span><br><span class="line">            ret.append(&#123;</span><br><span class="line">                <span class="string">'id'</span>: item.id,</span><br><span class="line">                <span class="string">'title'</span>: item.title</span><br><span class="line">            &#125;)</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfoSerializer2</span><span class="params">(serializers.ModelSerializer)</span>:</span></span><br><span class="line">    <span class="string">"""继承ModelSerializer"""</span></span><br><span class="line">    <span class="comment"># required=False 表示在保存对象时，不会校验此字段必输(此字段为翻译字段，保存时传递code即可)</span></span><br><span class="line">    level_name = serializers.CharField(source=<span class="string">'get_level_display'</span>, required=<span class="keyword">False</span>)</span><br><span class="line">    group = serializers.CharField(source=<span class="string">'group.title'</span>)</span><br><span class="line">    <span class="comment"># required=True 表示在保存对象时，此字段为必输项。则rest framework会进行此字段校验。将前台传递的 group_id 保存到表的 group_id 字段中。（model中为group的对象属性名，此时不定义则group_id不会进入到serializers.validated_data中，从而无法保存进数据库）</span></span><br><span class="line">    group_id = serializers.CharField(required=<span class="keyword">True</span>)</span><br><span class="line">    roles = serializers.SerializerMethodField()</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = models.UserInfo</span><br><span class="line">        <span class="comment"># 映射model的全部字段</span></span><br><span class="line">        <span class="comment"># fields = '__all__'</span></span><br><span class="line">        fields = [<span class="string">'id'</span>, <span class="string">'username'</span>, <span class="string">'level_name'</span>, <span class="string">'group'</span>, <span class="string">'roles'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_roles</span><span class="params">(self, row)</span>:</span></span><br><span class="line">        roles = row.role.all()</span><br><span class="line">        ret = []</span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> roles:</span><br><span class="line">            ret.append(&#123;</span><br><span class="line">                <span class="string">'id'</span>: item.id,</span><br><span class="line">                <span class="string">'title'</span>: item.title</span><br><span class="line">            &#125;)</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfoSerializer3</span><span class="params">(serializers.ModelSerializer)</span>:</span></span><br><span class="line">    <span class="string">"""继承ModelSerializer，且定义深度"""</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = models.UserInfo</span><br><span class="line">        <span class="comment"># 映射model的全部字段</span></span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line">        <span class="comment"># fields = ['id', 'username', 'group', 'role']</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 默认值为0，即当前model字段。如果为1则向下再查询一层(解析此model的关系表基本字段)</span></span><br><span class="line">        depth = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfoSerializer4</span><span class="params">(serializers.ModelSerializer)</span>:</span></span><br><span class="line">    <span class="string">"""返回链接示例"""</span></span><br><span class="line">    <span class="comment"># 需要定义url: url(r'^(?P&lt;version&gt;[v1|v2]+)/group_serializer/(?P&lt;my_pk&gt;\d+)$', views.SerializerGroup.as_view(), name='group_url')</span></span><br><span class="line">    <span class="comment"># 此相当于根据group的id反向生成url. lookup_field默认为pk(转换的字段名); lookup_url_kwarg默认取lookup_field的值(即pk)</span></span><br><span class="line">    group = serializers.HyperlinkedIdentityField(view_name=<span class="string">'group_url'</span>, lookup_field=<span class="string">'group_id'</span>, lookup_url_kwarg=<span class="string">'my_pk'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = models.UserInfo</span><br><span class="line">        <span class="comment"># fields = '__all__'</span></span><br><span class="line">        fields = [<span class="string">'id'</span>, <span class="string">'username'</span>, <span class="string">'group'</span>, <span class="string">'role'</span>]</span><br><span class="line">        depth = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GroupSerializer</span><span class="params">(serializers.ModelSerializer)</span>:</span></span><br><span class="line">    <span class="string">"""简单类序列化示例"""</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = models.UserGroup</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SerializerUserRole</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">        roles = models.UserRole.objects.all()</span><br><span class="line">        <span class="comment"># &lt;QuerySet [&lt;UserRole: UserRole object (1)&gt;, &lt;UserRole: UserRole object (2)&gt;]&gt; . 不能通过json转换</span></span><br><span class="line">        print(roles)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 1.基于django实现序列化</span></span><br><span class="line">        roles2 = models.UserRole.objects.all().values(<span class="string">'id'</span>, <span class="string">'title'</span>)</span><br><span class="line">        roles2 = list(roles2)</span><br><span class="line">        <span class="comment"># [&#123;"id": 1, "title": "\u8001\u5e08"&#125;, &#123;"id": 2, "title": "\u540c\u5b66"&#125;]</span></span><br><span class="line">        ret2 = json.dumps(roles2)</span><br><span class="line">        <span class="comment"># [&#123;"id": 1, "title": "老师"&#125;, &#123;"id": 2, "title": "同学"&#125;]</span></span><br><span class="line">        ret2 = json.dumps(roles2, ensure_ascii=<span class="keyword">False</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 2.基于rest framework实现序列化</span></span><br><span class="line">        ser = UserRoleSerializer(instance=roles, many=<span class="keyword">True</span>)</span><br><span class="line">        <span class="comment"># [OrderedDict([('id', 1), ('title', '老师')]), OrderedDict([('id', 2), ('title', '同学')])]</span></span><br><span class="line">        print(ser.data)</span><br><span class="line">        <span class="comment"># [&#123;"id": 1, "title": "老师"&#125;, &#123;"id": 2, "title": "同学"&#125;]</span></span><br><span class="line">        ret3 = json.dumps(ser.data, ensure_ascii=<span class="keyword">False</span>)</span><br><span class="line"></span><br><span class="line">        role = models.UserRole.objects.all().first()</span><br><span class="line">        <span class="comment"># 此时只有一条数据(first返回的是一个对象，many必须为False。如果执行filter(返回的是一个集合)返回一条数据此处也必须是many=True</span></span><br><span class="line">        ser2 = UserRoleSerializer(instance=role, many=<span class="keyword">False</span>)</span><br><span class="line">        <span class="comment"># &#123;"id": 1, "title": "老师"&#125;</span></span><br><span class="line">        ret4 = json.dumps(ser2.data, ensure_ascii=<span class="keyword">False</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(ret4)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SerializerUserInfo</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="comment"># [</span></span><br><span class="line">        <span class="comment">#     &#123;</span></span><br><span class="line">        <span class="comment">#         "id": 1,</span></span><br><span class="line">        <span class="comment">#         "username": "smalle",</span></span><br><span class="line">        <span class="comment">#         "level": 1,</span></span><br><span class="line">        <span class="comment">#         "level_2": "1",</span></span><br><span class="line">        <span class="comment">#         "level_name": "普通用户",</span></span><br><span class="line">        <span class="comment">#         "group": "A组",</span></span><br><span class="line">        <span class="comment">#         "roles": [</span></span><br><span class="line">        <span class="comment">#             &#123;</span></span><br><span class="line">        <span class="comment">#                 "id": 1,</span></span><br><span class="line">        <span class="comment">#                 "title": "老师"</span></span><br><span class="line">        <span class="comment">#             &#125;,</span></span><br><span class="line">        <span class="comment">#             &#123;</span></span><br><span class="line">        <span class="comment">#                 "id": 2,</span></span><br><span class="line">        <span class="comment">#                 "title": "同学"</span></span><br><span class="line">        <span class="comment">#             &#125;</span></span><br><span class="line">        <span class="comment">#         ]</span></span><br><span class="line">        <span class="comment">#     &#125;,</span></span><br><span class="line">        <span class="comment">#     &#123;</span></span><br><span class="line">        <span class="comment">#         "id": 2,</span></span><br><span class="line">        <span class="comment">#         "username": "aezo",</span></span><br><span class="line">        <span class="comment">#         "level": 2,</span></span><br><span class="line">        <span class="comment">#         "level_2": "2",</span></span><br><span class="line">        <span class="comment">#         "level_name": "VIP",</span></span><br><span class="line">        <span class="comment">#         "group": "A组",</span></span><br><span class="line">        <span class="comment">#         "roles": [</span></span><br><span class="line">        <span class="comment">#             &#123;</span></span><br><span class="line">        <span class="comment">#                 "id": 1,</span></span><br><span class="line">        <span class="comment">#                 "title": "老师"</span></span><br><span class="line">        <span class="comment">#             &#125;</span></span><br><span class="line">        <span class="comment">#         ]</span></span><br><span class="line">        <span class="comment">#     &#125;</span></span><br><span class="line">        <span class="comment"># ]</span></span><br><span class="line">        <span class="comment"># 复杂类序列化</span></span><br><span class="line">        users = models.UserInfo.objects.all()</span><br><span class="line">        ser = UserInfoSerializer(instance=users, many=<span class="keyword">True</span>)</span><br><span class="line">        ret = json.dumps(ser.data, ensure_ascii=<span class="keyword">False</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 继承ModelSerializer序列化复杂类</span></span><br><span class="line">        ser2 = UserInfoSerializer2(instance=users, many=<span class="keyword">True</span>)</span><br><span class="line">        ret2 = json.dumps(ser2.data, ensure_ascii=<span class="keyword">False</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ModelSerializer中depth的使用</span></span><br><span class="line">        <span class="comment"># [&#123;"id": 1, "level": 1, "username": "smalle", "password": "123", "group": &#123;"id": 1, "title": "A组"&#125;, "role": [&#123;"id": 1, "title": "老师"&#125;, &#123;"id": 2, "title": "同学"&#125;]&#125;, &#123;"id": 2, "level": 2, "username": "aezo", "password": "123", "group": &#123;"id": 1, "title": "A组"&#125;, "role": [&#123;"id": 1, "title": "老师"&#125;]&#125;]</span></span><br><span class="line">        ser3 = UserInfoSerializer3(instance=users, many=<span class="keyword">True</span>)</span><br><span class="line">        ret3 = json.dumps(ser3.data, ensure_ascii=<span class="keyword">False</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 生成超链接. [&#123;"id": 1, "username": "smalle", "group": "http://127.0.0.1:8000/api/v1/group_serializer/1", "role": [1, 2]&#125;, &#123;"id": 2, "username": "aezo", "group": "http://127.0.0.1:8000/api/v1/group_serializer/1", "role": [1]&#125;]</span></span><br><span class="line">        ser4 = UserInfoSerializer4(instance=users, many=<span class="keyword">True</span>, context=&#123;<span class="string">'request'</span>: request&#125;)</span><br><span class="line">        ret4 = json.dumps(ser4.data, ensure_ascii=<span class="keyword">False</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(ret4)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SerializerGroup</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    <span class="string">"""序列化超链接相关示例"""</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">        pk = kwargs.get(<span class="string">'my_pk'</span>)</span><br><span class="line">        group = models.UserGroup.objects.filter(pk=pk).first()</span><br><span class="line">        ser = GroupSerializer(instance=group, many=<span class="keyword">False</span>)</span><br><span class="line">        ret = json.dumps(ser.data, ensure_ascii=<span class="keyword">False</span>)</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(ret)</span><br></pre></td></tr></table></figure><h3 id="提交数据验证"><a href="#提交数据验证" class="headerlink" title="提交数据验证"></a>提交数据验证</h3><ul><li>前台提交的数据会保存在 <code>serializer.initial_data</code>，然后根据校验规则进行校验，通过的字段保存到 <code>serializer.validated_data</code>。最后根据 <code>serializer.validated_data</code> 进行数据保存</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StartsWithValidator</span>:</span></span><br><span class="line">    <span class="string">"""自定义验证器(一般不使用这种方法验证, 而使用钩子函数)"""</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, base)</span>:</span></span><br><span class="line">        self.base = base</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        <span class="string">'''序列化执行器会自动调用此方法, value即为提交的参数值'''</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> value.startswith(self.base):</span><br><span class="line">            message = <span class="string">'用户名必须以 %s 开头'</span> % self.base</span><br><span class="line">            <span class="keyword">raise</span> serializers.ValidationError(message)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfoValidateSerializer</span><span class="params">(serializers.Serializer)</span>:</span></span><br><span class="line">    <span class="comment"># username = serializers.CharField()</span></span><br><span class="line">    <span class="comment"># username = serializers.CharField(error_messages=&#123;'required': '用户名不能为空'&#125;)</span></span><br><span class="line">    <span class="comment"># username = serializers.CharField(error_messages=&#123;'required': '用户名不能为空'&#125;, validators=[StartsWithValidator('aezo_'),])</span></span><br><span class="line">    username = serializers.CharField(error_messages=&#123;<span class="string">'required'</span>: <span class="string">'用户名不能为空'</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 验证器钩子函数(validate_属性名)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate_username</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> value.startswith(<span class="string">'aezocn_'</span>):</span><br><span class="line">            message = <span class="string">'用户名必须以 aezocn_ 开头'</span></span><br><span class="line">            <span class="keyword">raise</span> serializers.ValidationError(message)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 此时验证通过需要将原始值返回</span></span><br><span class="line">            <span class="keyword">return</span> value</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SerializerUserInfoValidate</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">        ser = UserInfoValidateSerializer(data=request.data)</span><br><span class="line">        <span class="keyword">if</span> ser.is_valid():</span><br><span class="line">            print(ser.validated_data[<span class="string">'username'</span>])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># &#123;'username': [ErrorDetail(string='This field is required.', code='required')]&#125;</span></span><br><span class="line">            <span class="comment"># &#123;'username': [ErrorDetail(string='用户名必须以 aezocn_ 开头', code='invalid')]&#125;</span></span><br><span class="line">            print(ser.errors)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">'SerializerUserInfoValidate...'</span>)</span><br></pre></td></tr></table></figure><h2 id="分页"><a href="#分页" class="headerlink" title="分页"></a>分页</h2><blockquote><p>源码参考[A03_DjangoRestFrameworkTest2]</p></blockquote><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.pagination <span class="keyword">import</span> PageNumberPagination, LimitOffsetPagination, CursorPagination</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PageSerializer</span><span class="params">(serializers.ModelSerializer)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = models.UserGroup</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPageNumberPagination</span><span class="params">(PageNumberPagination)</span>:</span></span><br><span class="line">    <span class="comment"># 基于页面和页大小分页. http://127.0.0.1:8000/api/v1/group_page/?page=2&amp;size=3</span></span><br><span class="line">    page_query_param = <span class="string">'page'</span></span><br><span class="line">    page_size_query_param = <span class="string">'size'</span></span><br><span class="line">    page_size = <span class="number">2</span></span><br><span class="line">    max_page_size = <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyLimitOffsetPagination</span><span class="params">(LimitOffsetPagination)</span>:</span></span><br><span class="line">    <span class="comment"># 基于起始位置和显示大小分页. http://127.0.0.1:8000/api/v1/group_page/?offset=2&amp;limit=3</span></span><br><span class="line">    limit_query_param = <span class="string">'limit'</span></span><br><span class="line">    offset_query_param = <span class="string">'offset'</span></span><br><span class="line">    default_limit = <span class="number">2</span></span><br><span class="line">    max_limit = <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyCursorPagination</span><span class="params">(CursorPagination)</span>:</span></span><br><span class="line">    <span class="comment"># 页码加密分页. http://127.0.0.1:8000/api/v1/group_page/?cursor=cD02&amp;size=3</span></span><br><span class="line">    cursor_query_param = <span class="string">'cursor'</span></span><br><span class="line">    page_size_query_param = <span class="string">'size'</span></span><br><span class="line">    ordering = <span class="string">'-id'</span> <span class="comment"># id降序排列</span></span><br><span class="line">    page_size = <span class="number">2</span></span><br><span class="line">    max_page_size = <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GroupPage</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">        groups = models.UserGroup.objects.all()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># page = PageNumberPagination() # 默认的分页类，需在配置文件中加`PAGE_SIZE`</span></span><br><span class="line">        <span class="comment"># page = MyPageNumberPagination()</span></span><br><span class="line">        <span class="comment"># page = MyLimitOffsetPagination()</span></span><br><span class="line">        page = MyCursorPagination()</span><br><span class="line"></span><br><span class="line">        page_groups = page.paginate_queryset(queryset=groups, request=request, view=self)</span><br><span class="line">        ser = PageSerializer(instance=page_groups, many=<span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ret = json.dumps(ser.data, ensure_ascii=False)</span></span><br><span class="line">        <span class="comment"># return HttpResponse(ret)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 基于页面加密返回必须使用此返回(其中包含了下一页/上一页的cursor值)</span></span><br><span class="line">        <span class="keyword">return</span> page.get_paginated_response(ser.data)</span><br></pre></td></tr></table></figure><h2 id="渲染器"><a href="#渲染器" class="headerlink" title="渲染器"></a>渲染器</h2><blockquote><p>源码参考[A03_DjangoRestFrameworkTest2]</p></blockquote><ul><li>注册rest_framework</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS = [</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    <span class="comment"># 注册之后可使用器渲染器</span></span><br><span class="line">    <span class="string">'rest_framework'</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure><ul><li>全局配置</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    <span class="comment"># 全局渲染器(可省略，默认即为这两个渲染器)</span></span><br><span class="line">    <span class="string">'DEFAULT_RENDERER_CLASSES'</span>: [<span class="string">'rest_framework.renderers.JSONRenderer'</span>, <span class="string">'rest_framework.renderers.BrowsableAPIRenderer'</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>使用<code>Response</code>返回数据</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.renderers <span class="keyword">import</span> JSONRenderer, BrowsableAPIRenderer, AdminRenderer</span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SerializerGroup</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    <span class="comment"># 局部配置</span></span><br><span class="line">    <span class="comment"># renderer_classes = [JSONRenderer, BrowsableAPIRenderer]</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">        pk = kwargs.get(<span class="string">'my_pk'</span>)</span><br><span class="line">        group = models.UserGroup.objects.filter(pk=pk).first()</span><br><span class="line">        ser = GroupSerializer(instance=group, many=<span class="keyword">False</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 只能返回json</span></span><br><span class="line">        <span class="comment"># ret = json.dumps(ser.data, ensure_ascii=False)</span></span><br><span class="line">        <span class="comment"># return HttpResponse(ret)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 可进行判断是返回json还是api(页面展示)</span></span><br><span class="line">        <span class="keyword">return</span> Response(ser.data)</span><br></pre></td></tr></table></figure><ul><li>访问 <code>http://127.0.0.1:8000/api/v1/group_serializer/1</code> <strong>在浏览器(api页面)和postman(json数据)中可自动识别</strong><ul><li><code>http://127.0.0.1:8000/api/v1/group_serializer/1?format=api</code> 返回api页面(包含结果数据)</li><li><code>http://127.0.0.1:8000/api/v1/group_serializer/1?format=json</code> <strong>只返回json数据</strong></li></ul></li><li>修改api模板可参看下文渲染器源码解析</li></ul><h2 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h2><blockquote><p>源码参考[A03_DjangoRestFrameworkTest2]</p></blockquote><ul><li><code>ModelViewSet</code>路由配置</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># url(r'^(?P&lt;version&gt;[v1|v2]+)/view_test/$', views.GenericViewTest.as_view(&#123;'get': 'list', 'post': 'create'&#125;)),</span></span><br><span class="line"><span class="comment"># 如果是get类型的请求，则执行retrieve方法(RetrieveModelMixin)；如果是put类型请求则全部更新，执行update方法；如果是patch类型请求则局部更新，执行partial_update(UpdateModelMixin)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 写法一(使用ViewSet.as_view则必须指明对应的actions方法)</span></span><br><span class="line">url(<span class="string">r'^(?P&lt;version&gt;[v1|v2]+)/view_test/(?P&lt;pk&gt;\d+)/$'</span>, views.ViewTest.as_view(&#123;<span class="string">'get'</span>: <span class="string">'retrieve'</span>, <span class="string">'put'</span>: <span class="string">'update'</span>, <span class="string">'patch'</span>: <span class="string">'partial_update'</span>, <span class="string">'delete'</span>: <span class="string">'destroy'</span>&#125;)),</span><br><span class="line"></span><br><span class="line"><span class="comment">## 写法二(使用router会自动对应其actions方法)</span></span><br><span class="line"><span class="comment"># GET /entity/          =&gt; list</span></span><br><span class="line"><span class="comment"># GET /entity/&#123;pk&#125;/     =&gt; retrieve</span></span><br><span class="line"><span class="comment"># POST /entity/         =&gt; create</span></span><br><span class="line"><span class="comment"># PUT /entity/&#123;pk&#125;/     =&gt; update</span></span><br><span class="line"><span class="comment"># DELETE /entity/&#123;pk&#125;/  =&gt; destroy</span></span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> routers</span><br><span class="line"></span><br><span class="line">router = routers.DefaultRouter()</span><br><span class="line">router.register(<span class="string">r'project'</span>, views.ProjectView)</span><br><span class="line"></span><br><span class="line">url(<span class="string">''</span>, include(router.urls)),</span><br></pre></td></tr></table></figure><ul><li><code>ModelViewSet</code>视图子类</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.generics <span class="keyword">import</span> GenericAPIView</span><br><span class="line"><span class="keyword">from</span> rest_framework.viewsets <span class="keyword">import</span> GenericViewSet, ModelViewSet</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserRoleSerializer2</span><span class="params">(serializers.ModelSerializer)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = models.UserRole</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GenericViewTest</span><span class="params">(GenericViewSet)</span>:</span></span><br><span class="line">    queryset = models.UserRole.objects.all()</span><br><span class="line">    <span class="comment"># 序列化必须是ModelSerializer的，否则新增报错</span></span><br><span class="line">    serializer_class = UserRoleSerializer2</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">list</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        ser = self.get_serializer(queryset)</span><br><span class="line">        <span class="keyword">return</span> Response(ser.data)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ViewTest</span><span class="params">(ModelViewSet)</span>:</span></span><br><span class="line">    queryset = models.UserRole.objects.all()</span><br><span class="line">    <span class="comment"># 序列化必须是ModelSerializer的，否则新增报错</span></span><br><span class="line">    serializer_class = UserRoleSerializer2</span><br><span class="line">    <span class="comment"># pagination_class = api_settings.DEFAULT_PAGINATION_CLASS</span></span><br><span class="line">    pagination_class = MyPageNumberPagination</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_create</span><span class="params">(self, serializer)</span>:</span></span><br><span class="line">        <span class="string">'''重写最终保存方法'''</span></span><br><span class="line">        user = serializer.context[<span class="string">'request'</span>].user</span><br><span class="line">        <span class="comment"># 往 validated_data 加入当前登录人ID，最终保存到创建人中</span></span><br><span class="line">        serializer.validated_data[<span class="string">'create_user_id'</span>] = user.id</span><br><span class="line">        super().perform_create(serializer)</span><br></pre></td></tr></table></figure><h2 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h2><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## urls.py</span></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">'admin/'</span>, admin.site.urls),</span><br><span class="line">    url(<span class="string">r'^hello/'</span>, views.hello), <span class="comment"># FBV</span></span><br><span class="line">    url(<span class="string">r'^test/'</span>, views.TestView.as_view()), <span class="comment"># CBV</span></span><br><span class="line">    url(<span class="string">r'^api/'</span>, include(<span class="string">'smtest2.urls'</span>)),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">## smtest2/urls.py</span></span><br><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url, include</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> routers</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">router = routers.DefaultRouter()</span><br><span class="line">router.register(<span class="string">r'url_test'</span>, views.ViewTest)</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    <span class="comment"># 其中 (?P&lt;version&gt;[v1|v2]+) 参考上文版本控制</span></span><br><span class="line">    <span class="comment"># VersionTest继承APIView时，get类型请求默认调用VersionTest的get方法。name='t_version' 表示路由的名字</span></span><br><span class="line">    url(<span class="string">r'^(?P&lt;version&gt;[v1|v2]+)/test_version/$'</span>, views.VersionTest.as_view(), name=<span class="string">'t_version'</span>),</span><br><span class="line">    url(<span class="string">r'^(?P&lt;version&gt;[v1|v2]+)/test_parser/$'</span>, views.ParserTest.as_view()),</span><br><span class="line">    url(<span class="string">r'^(?P&lt;version&gt;[v1|v2]+)/user_role_serializer/$'</span>, views.SerializerUserRole.as_view()),</span><br><span class="line">    url(<span class="string">r'^(?P&lt;version&gt;[v1|v2]+)/user_info_serializer/$'</span>, views.SerializerUserInfo.as_view()),</span><br><span class="line">    <span class="comment"># 可通过 pk = kwargs.get('my_pk') 获取路径参数值</span></span><br><span class="line">    url(<span class="string">r'^(?P&lt;version&gt;[v1|v2]+)/group_serializer/(?P&lt;my_pk&gt;\d+)/$'</span>, views.SerializerGroup.as_view(), name=<span class="string">'group_url'</span>),</span><br><span class="line">    url(<span class="string">r'^(?P&lt;version&gt;[v1|v2]+)/user_info_serializer_validate/$'</span>, views.SerializerUserInfoValidate.as_view()),</span><br><span class="line">    url(<span class="string">r'^(?P&lt;version&gt;[v1|v2]+)/group_page/$'</span>, views.GroupPage.as_view()),</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ViewTest继承APIView，重写get类型的请求调用的方法，此时则是调用ViewTest类的list方法(默认是get方法)</span></span><br><span class="line">    <span class="comment"># url(r'^(?P&lt;version&gt;[v1|v2]+)/view_test/$', views.ViewTest.as_view(&#123;'get': 'list', 'post': 'create'&#125;)),</span></span><br><span class="line">    <span class="comment"># ViewTest继承ModelViewSet时。如果是get类型的请求，则执行retrieve方法(RetrieveModelMixin)；如果是put类型请求则全部更新，执行update方法；如果是patch类型请求则局部更新，执行partial_update(UpdateModelMixin)</span></span><br><span class="line">    url(<span class="string">r'^(?P&lt;version&gt;[v1|v2]+)/view_test/(?P&lt;pk&gt;\d+)/$'</span>, views.ViewTest.as_view(&#123;<span class="string">'get'</span>: <span class="string">'retrieve'</span>, <span class="string">'post'</span>: <span class="string">'create'</span>, <span class="string">'put'</span>: <span class="string">'update'</span>, <span class="string">'patch'</span>: <span class="string">'partial_update'</span>, <span class="string">'delete'</span>: <span class="string">'destroy'</span>&#125;)),</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 可访问 /group_page_format.json(仅json结果) 和 /group_page_format.api(通过页面展示json结果) 获取数据的不同展现形式</span></span><br><span class="line">    url(<span class="string">r'^(?P&lt;version&gt;[v1|v2]+)/group_page_format\.(?P&lt;format&gt;\w+)$'</span>, views.GroupPage.as_view()),</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 自动生成ViewTest视图的url，其中包含了format(结果到的展现形式)。简单的增删查改可直接自动生成</span></span><br><span class="line">    url(<span class="string">r'^(?P&lt;version&gt;[v1|v2]+)/'</span>, include(router.urls)),</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h2 id="过滤器"><a href="#过滤器" class="headerlink" title="过滤器"></a>过滤器</h2><blockquote><p><a href="https://www.django-rest-framework.org/api-guide/filtering/" target="_blank" rel="noopener">https://www.django-rest-framework.org/api-guide/filtering/</a></p></blockquote><ul><li>settings.py</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS = [</span><br><span class="line">    ...</span><br><span class="line">    <span class="string">'rest_framework'</span>,</span><br><span class="line">    <span class="comment"># 'django_filters',  # 引入第三方插件，参考下文</span></span><br><span class="line">]</span><br><span class="line">​</span><br><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="comment"># 默认过滤器</span></span><br><span class="line">    <span class="string">'DEFAULT_FILTER_BACKENDS'</span>: (</span><br><span class="line">        <span class="string">'url_filter.integrations.drf.DjangoFilterBackend'</span>,  <span class="comment"># 参考下文</span></span><br><span class="line">        <span class="comment"># 'django_filters.rest_framework.DjangoFilterBackend',</span></span><br><span class="line">    ),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="django-url-filter-过滤插件-推荐"><a href="#django-url-filter-过滤插件-推荐" class="headerlink" title="django-url-filter 过滤插件(推荐)"></a>django-url-filter 过滤插件(推荐)</h3><blockquote><p><a href="https://github.com/miki725/django-url-filter" target="_blank" rel="noopener">https://github.com/miki725/django-url-filter</a></p></blockquote><ul><li><code>pip install django-url-filter</code> 安装插件(可不用引入到INSTALLED_APPS)</li></ul><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> url_filter.integrations.drf <span class="keyword">import</span> DjangoFilterBackend</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProductViewSet</span><span class="params">(viewsets.ModelViewSet)</span>:</span></span><br><span class="line">    filter_backends = (DjangoFilterBackend, )</span><br><span class="line">    <span class="comment"># 允许的过滤字段</span></span><br><span class="line">    filter_fields = [<span class="string">'username'</span>, <span class="string">'email'</span>]</span><br><span class="line">    <span class="comment"># filter_class # 基于filter_class进行过滤</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## url写法如下</span></span><br><span class="line">example.com/users/?id=5</span><br><span class="line">example.com/users/?id__in=5,10,15</span><br><span class="line">example.com/users/?id__range=5,10  # get user with id between 5 and 10</span><br><span class="line">example.com/users/?username=foo</span><br><span class="line">example.com/users/?username__icontains=foo  # 类似like。get user with username containing case insensitive "foo"(mysql根据实际字段名来)</span><br><span class="line">example.com/users/?username__icontains!=foo  # get user where username does NOT contain "foo"</span><br><span class="line">example.com/users/?profile__joined__year=2015  # get user who joined in 2015 as per user profile</span><br><span class="line">example.com/users/?profile__joined__range=2010-01-01,2015-12-31  # get user who joined in between 2010 and 2015 as per user profile</span><br><span class="line">example.com/users/?profile__joined__gt=2010-01-01  # get user who joined in after 2010 as per user profile</span><br></pre></td></tr></table></figure><h3 id="django-filter-过滤插件"><a href="#django-filter-过滤插件" class="headerlink" title="django-filter 过滤插件"></a>django-filter 过滤插件</h3><blockquote><p><a href="https://django-filter.readthedocs.io/en/latest/index.html" target="_blank" rel="noopener">https://django-filter.readthedocs.io/en/latest/index.html</a></p></blockquote><ul><li><code>pip install django-filter</code> 安装django-filter过滤器插件</li><li>views.py</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django_filters.rest_framework <span class="keyword">import</span> DjangoFilterBackend</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProductViewSet</span><span class="params">(viewsets.ModelViewSet)</span>:</span></span><br><span class="line">    queryset = Product.objects.all()</span><br><span class="line">    serializer_class = ProductSerializer</span><br><span class="line">    <span class="comment"># 自定义需要使用的过滤器，覆盖配置文件中的默认过滤器</span></span><br><span class="line">    filter_backends = (filters.DjangoFilterBackend,)</span><br><span class="line">    <span class="comment"># 使用filterset_fields直接进行过滤，和filterset_class不能同时使用。可访问 http://example.com/api/products/4675/?name=apple&amp;price=10 得到过滤后结果</span></span><br><span class="line">    filterset_fields = (<span class="string">"name"</span>, <span class="string">"price"</span>, )</span><br><span class="line">    <span class="comment"># 使用filterset_class进行过滤</span></span><br><span class="line">    <span class="comment"># filterset_class = ProductFilter</span></span><br></pre></td></tr></table></figure><ul><li>自定义过滤器<ul><li>基于<code>django_filters</code>插件实现</li><li>filters.py(配合filterset_class使用)</li></ul></li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django_filters <span class="keyword">import</span> rest_framework <span class="keyword">as</span> filters <span class="comment"># 注意导入路径，是从rest_framework中导入</span></span><br><span class="line">​</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProductFilter</span><span class="params">(filters.FilterSet)</span>:</span></span><br><span class="line">    min_price = filters.NumberFilter(field_name=<span class="string">"price"</span>, lookup_expr=<span class="string">'gte'</span>)  <span class="comment"># &gt;=</span></span><br><span class="line">    max_price = filters.NumberFilter(field_name=<span class="string">"price"</span>, lookup_expr=<span class="string">'lte'</span>)</span><br><span class="line">    </span><br><span class="line">    price__gt = django_filters.NumberFilter(field_name=<span class="string">'price'</span>, lookup_expr=<span class="string">'gt'</span>)</span><br><span class="line">    price__lt = django_filters.NumberFilter(field_name=<span class="string">'price'</span>, lookup_expr=<span class="string">'lt'</span>)</span><br><span class="line">​</span><br><span class="line">    release_year = django_filters.NumberFilter(field_name=<span class="string">'release_date'</span>, lookup_expr=<span class="string">'year'</span>)</span><br><span class="line">    release_year__gt = django_filters.NumberFilter(field_name=<span class="string">'release_date'</span>, lookup_expr=<span class="string">'year__gt'</span>)</span><br><span class="line">    release_year__lt = django_filters.NumberFilter(field_name=<span class="string">'release_date'</span>, lookup_expr=<span class="string">'year__lt'</span>)</span><br><span class="line">​</span><br><span class="line">    <span class="comment"># lookup_expr 查询方式  ("gt" "lt"为查询参数)  </span></span><br><span class="line">    manufacturer__name = django_filters.CharFilter(lookup_expr=<span class="string">'icontains'</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Product </span><br><span class="line">        fields = [<span class="string">"manufacturer"</span>, <span class="string">"price"</span>, <span class="string">"min_price"</span>, <span class="string">"max_price"</span>]</span><br></pre></td></tr></table></figure><h3 id="SearchFilter-模糊匹配进行过滤"><a href="#SearchFilter-模糊匹配进行过滤" class="headerlink" title="SearchFilter 模糊匹配进行过滤"></a>SearchFilter 模糊匹配进行过滤</h3><ul><li>rest-framework内置。类似django admin的搜索，所有字段均使用一个<code>search</code>参数传入，此参数名可通过修改<code>api_settings.SEARCH_PARAM</code>进行覆盖</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> filters</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserListView</span><span class="params">(generics.ListAPIView)</span>:</span></span><br><span class="line">    queryset = User.objects.all()</span><br><span class="line">    serializer_class = UserSerializer</span><br><span class="line">    filter_backends = [filters.SearchFilter]</span><br><span class="line">    <span class="comment"># 默认 search_fields 是精确匹配。^ 匹配开头，= 精确匹配，@ 全文搜索(仅mysql支持)，$ 正则匹配(以什么结尾)。mysql根据数据库字段决定是否区分大小写</span></span><br><span class="line">    <span class="comment"># 可访问 http://example.com/api/products/4675/?search=apple 相当于查询name=apple或者producer__name以apple开头的</span></span><br><span class="line">    <span class="comment"># 或访问 http://example.com/api/products/4675/?search=apple,test 多个参数值可用空格或者逗号隔开，此时相当于查询 ((name=apple or producer__name=^apple) and (name=test or producer__name=^test))</span></span><br><span class="line">    search_fields = [<span class="string">'name'</span>, <span class="string">'^producer__name'</span>]</span><br></pre></td></tr></table></figure><h3 id="OrderingFilter-排序过滤"><a href="#OrderingFilter-排序过滤" class="headerlink" title="OrderingFilter 排序过滤"></a>OrderingFilter 排序过滤</h3><ul><li>rest-framework内置</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> filters</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserListView</span><span class="params">(generics.ListAPIView)</span>:</span></span><br><span class="line">    queryset = User.objects.all()</span><br><span class="line">    serializer_class = UserSerializer</span><br><span class="line">    filter_backends = [filters.OrderingFilter]</span><br><span class="line">    <span class="comment"># 支持的排序字段。可访问 http://example.com/api/users?ordering=-username 基于username降序排列</span></span><br><span class="line">    ordering_fields = [<span class="string">'username'</span>, <span class="string">'email'</span>]</span><br><span class="line">    <span class="comment"># ordering_fields = '__all__'  # 支持所有字段排序</span></span><br><span class="line">    <span class="comment"># 默认的排序字段</span></span><br><span class="line">    ordering = [<span class="string">'username'</span>]</span><br></pre></td></tr></table></figure><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><h3 id="跨域"><a href="#跨域" class="headerlink" title="跨域"></a>跨域</h3><ul><li>使用<code>corsheaders</code>，参考：<a href="https://github.com/ottoyiu/django-cors-headers/" target="_blank" rel="noopener">https://github.com/ottoyiu/django-cors-headers/</a></li><li><code>pip install django-cors-headers</code> 安装</li><li>setting.py配置</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS = (</span><br><span class="line">    ...</span><br><span class="line">    <span class="string">'corsheaders'</span>,</span><br><span class="line">    ...</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">MIDDLEWARE = [  <span class="comment"># Or MIDDLEWARE_CLASSES on Django &lt; 1.10</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="string">'corsheaders.middleware.CorsMiddleware'</span>,</span><br><span class="line">    <span class="string">'django.middleware.common.CommonMiddleware'</span>,</span><br><span class="line">    ...</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开启所有</span></span><br><span class="line">CORS_ORIGIN_ALLOW_ALL = <span class="keyword">True</span></span><br><span class="line"><span class="comment"># 允许部分</span></span><br><span class="line"><span class="comment"># CORS_ORIGIN_WHITELIST = (</span></span><br><span class="line"><span class="comment">#     'localhost:8080',</span></span><br><span class="line"><span class="comment">#     '127.0.0.1:8080'</span></span><br><span class="line"><span class="comment"># )</span></span><br><span class="line">CORS_ALLOW_METHODS = (</span><br><span class="line">    <span class="string">'DELETE'</span>,</span><br><span class="line">    <span class="string">'GET'</span>,</span><br><span class="line">    <span class="string">'OPTIONS'</span>,</span><br><span class="line">    <span class="string">'PATCH'</span>,</span><br><span class="line">    <span class="string">'POST'</span>,</span><br><span class="line">    <span class="string">'PUT'</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h3 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## settings.py</span></span><br><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    <span class="string">'EXCEPTION_HANDLER'</span>: <span class="string">'myproject.utils.exceptions.custom_exception_handler'</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">## myproject/utils/exceptions.py</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> exception_handler, Response</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">custom_exception_handler</span><span class="params">(exc, context)</span>:</span></span><br><span class="line">    response = exception_handler(exc, context)</span><br><span class="line">    <span class="keyword">if</span> response <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">        response.data[<span class="string">'status_code'</span>] = response.status_code</span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> Response(&#123;<span class="string">'status_code'</span>: <span class="number">500</span>&#125;)</span><br></pre></td></tr></table></figure><h3 id="禁用crsf"><a href="#禁用crsf" class="headerlink" title="禁用crsf"></a>禁用crsf</h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">MIDDLEWARE = [</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    <span class="comment"># 注释crsf中间件</span></span><br><span class="line">    <span class="comment"># 'django.middleware.csrf.CsrfViewMiddleware',</span></span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure><h3 id="统一结果返回"><a href="#统一结果返回" class="headerlink" title="统一结果返回"></a>统一结果返回</h3><ul><li><a href="https://blog.csdn.net/a394268045/article/details/97165872" target="_blank" rel="noopener">https://blog.csdn.net/a394268045/article/details/97165872</a></li></ul><h2 id="rest-framework-源码解析"><a href="#rest-framework-源码解析" class="headerlink" title="rest framework 源码解析"></a>rest framework 源码解析</h2><h3 id="封装request和认证-1"><a href="#封装request和认证-1" class="headerlink" title="封装request和认证 ^1"></a>封装request和认证 <a href="https://www.bilibili.com/video/av28871471/?p=11" target="_blank" rel="noopener">^1</a></h3><ul><li>CBV模式下视图类继承rest_framework的<code>APIView</code>对象(继承了django的View对象)，所有的请求也会先进入到<code>self.dispatch()</code>方法。封装request和认证过程如下</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## rest_framework/views.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dispatch</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">    self.args = args</span><br><span class="line">    self.kwargs = kwargs</span><br><span class="line">    <span class="comment"># 1.对原始request重新组装。return Request(request, parsers=self.get_parsers(), authenticators=self.get_authenticators(), negotiator=self.get_content_negotiator(), parser_context=parser_context)</span></span><br><span class="line">    <span class="comment"># 1.1 新request中包含了原始request(request._request)、authenticators认证类对象数组([TokenAuthentication(),])</span></span><br><span class="line">    <span class="comment"># 1.2 authenticators=self.get_authenticators()返回的是return [auth() for auth in self.authentication_classes]</span></span><br><span class="line">    request = self.initialize_request(request, *args, **kwargs)</span><br><span class="line">    self.request = request</span><br><span class="line">    self.headers = self.default_response_headers  <span class="comment"># deprecate?</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 2.认证/权限/节流...。实现认证：self.perform_authentication(request) -&gt;&gt; request.user -&gt;&gt; self._authenticate() -&gt;&gt; authenticator.authenticate(self)</span></span><br><span class="line">        self.initial(request, *args, **kwargs)</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## rest_framework/request.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_authenticate</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> authenticator <span class="keyword">in</span> self.authenticators:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 调用认证方法</span></span><br><span class="line">            <span class="comment"># 1.认证抛出异常，执行self._not_authenticated()，并将异常raise(向上抛出)</span></span><br><span class="line">            <span class="comment"># 2.认证方法返回一个元组，(user, auth) =&gt; (request.user, request.auth)</span></span><br><span class="line">            <span class="comment"># 3.认证方法返回None，此时循环下一个认证器。如果都为None则执行self._not_authenticated()，此时默认返回匿名用户(AnonymousUser, None)</span></span><br><span class="line">            user_auth_tuple = authenticator.authenticate(self)</span><br><span class="line">        <span class="keyword">except</span> exceptions.APIException:</span><br><span class="line">            self._not_authenticated()</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> user_auth_tuple <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            self._authenticator = authenticator</span><br><span class="line">            self.user, self.auth = user_auth_tuple</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    self._not_authenticated()</span><br></pre></td></tr></table></figure><h3 id="权限-1"><a href="#权限-1" class="headerlink" title="权限"></a>权限</h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## rest_framework/views.py</span></span><br><span class="line"><span class="comment"># 权限：dispatch -&gt;&gt; initial -&gt;&gt; check_permissions</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_permissions</span><span class="params">(self, request)</span>:</span></span><br><span class="line">    <span class="comment"># get_permissions &lt;&lt;- return [permission() for permission in self.permission_classes]</span></span><br><span class="line">    <span class="keyword">for</span> permission <span class="keyword">in</span> self.get_permissions():</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> permission.has_permission(request, self):</span><br><span class="line">            self.permission_denied(</span><br><span class="line">                <span class="comment"># 获取permission对象的message属性，用于返回错误</span></span><br><span class="line">                request, message=getattr(permission, <span class="string">'message'</span>, <span class="keyword">None</span>)</span><br><span class="line">            )</span><br></pre></td></tr></table></figure><h3 id="访问控制-节流-1"><a href="#访问控制-节流-1" class="headerlink" title="访问控制/节流"></a>访问控制/节流</h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## rest_framework/views.py</span></span><br><span class="line"><span class="comment"># 节流：dispatch -&gt;&gt; initial -&gt;&gt; check_throttles</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_throttles</span><span class="params">(self, request)</span>:</span></span><br><span class="line">    <span class="comment"># return [throttle() for throttle in self.throttle_classes]</span></span><br><span class="line">    <span class="keyword">for</span> throttle <span class="keyword">in</span> self.get_throttles():</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> throttle.allow_request(request, self):</span><br><span class="line">            self.throttled(request, throttle.wait())</span><br></pre></td></tr></table></figure><ul><li>内置节流类(<code>SimpleRateThrottle</code>)</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## rest_framework/throttling.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpleRateThrottle</span><span class="params">(BaseThrottle)</span>:</span></span><br><span class="line">    cache = default_cache</span><br><span class="line">    timer = time.time</span><br><span class="line">    cache_format = <span class="string">'throttle_%(scope)s_%(ident)s'</span></span><br><span class="line">    scope = <span class="keyword">None</span></span><br><span class="line">    THROTTLE_RATES = api_settings.DEFAULT_THROTTLE_RATES</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> getattr(self, <span class="string">'rate'</span>, <span class="keyword">None</span>):</span><br><span class="line">            <span class="comment"># 1.反射获取rate属性，没有则self.get_rate()</span></span><br><span class="line">            self.rate = self.get_rate()</span><br><span class="line">        <span class="comment"># 2.配置文件中配置self.rate = '10/m', 进行self.parse_rate解析</span></span><br><span class="line">        self.num_requests, self.duration = self.parse_rate(self.rate)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_cache_key</span><span class="params">(self, request, view)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError(<span class="string">'.get_cache_key() must be overridden'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_rate</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># ...</span></span><br><span class="line">        <span class="comment"># 通过scope值到self.THROTTLE_RATES(api_settings.DEFAULT_THROTTLE_RATES)配置文件中取值</span></span><br><span class="line">        <span class="keyword">return</span> self.THROTTLE_RATES[self.scope]</span><br><span class="line">        <span class="comment"># ...</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse_rate</span><span class="params">(self, rate)</span>:</span></span><br><span class="line">        <span class="comment"># ...</span></span><br><span class="line">        num, period = rate.split(<span class="string">'/'</span>)</span><br><span class="line">        num_requests = int(num)</span><br><span class="line">        <span class="comment"># period[0]表示period的第一个字母，此时得到duration=60(s)</span></span><br><span class="line">        duration = &#123;<span class="string">'s'</span>: <span class="number">1</span>, <span class="string">'m'</span>: <span class="number">60</span>, <span class="string">'h'</span>: <span class="number">3600</span>, <span class="string">'d'</span>: <span class="number">86400</span>&#125;[period[<span class="number">0</span>]]</span><br><span class="line">        <span class="keyword">return</span> (num_requests, duration)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">allow_request</span><span class="params">(self, request, view)</span>:</span></span><br><span class="line">        <span class="comment"># ...</span></span><br><span class="line">        <span class="comment"># self.get_cache_key获取一个缓存key(此方法有子类实现)</span></span><br><span class="line">        self.key = self.get_cache_key(request, view)</span><br><span class="line">        <span class="keyword">if</span> self.key <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 从缓存中获取访问历史(使用django缓存)</span></span><br><span class="line">        self.history = self.cache.get(self.key, [])</span><br><span class="line">        <span class="comment"># ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ...</span></span><br></pre></td></tr></table></figure><h3 id="视图-1"><a href="#视图-1" class="headerlink" title="视图"></a>视图</h3><ul><li>继承关系<ul><li><code>django</code>应该可以继承<code>View</code>，<code>rest framework</code>应用可以使用下面所有视图类。常用：<code>ModelViewSet</code>、<code>GenericViewSet</code>、<code>APIView</code></li><li>使用django View时，对应url方法默认是调用<code>View.as_view()</code>方法</li></ul></li></ul><p><img src="https://www.plantuml.com/plantuml/svg/XT7DIiD0403W-px5WESczr9ADGqYj22AthVPCLsJp8R9nAXuLV0PV80-G8y5VPfQ7wFf7pHGubw6sVbs66O7XMYMCajLaLZADUiC9ZfAOdObcS2bZk4i3CEBON0afffCnLO42OHBL68bHGNrCO-QOWUCXS13RR5odC3Vx6FvzRrQp7u_VvRlyzLy0JsRnTsfIDxr_KdgOa_Zg_CYyZSn8Y-dkA-G3EnwtrkieFVMwS3vzTKcKVkukxn4GhRHeRRbjoXZ-sof8VO5rNnmagY0KGkEdS7qgD4sFvWR5BRur8xkSlDVds6zBtOlhMPa2sa5pVbFW46zp_glrm00"></p><ul><li>源码说明 <a href="https://www.lagou.com/lgeduarticle/37382.html" target="_blank" rel="noopener">^2</a></li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## rest_framework/viewsets.py</span></span><br><span class="line"><span class="comment"># 常用的基于Model的ViewSet，混入了以下几个类，以CreateModelMixin为例</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ModelViewSet</span><span class="params">(mixins.CreateModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                   mixins.RetrieveModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                   mixins.UpdateModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                   mixins.DestroyModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                   mixins.ListModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                   GenericViewSet)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    A viewset that provides default `create()`, `retrieve()`, `update()`,</span></span><br><span class="line"><span class="string">    `partial_update()`, `destroy()` and `list()` actions.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## rest_framework/mixins.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CreateModelMixin</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Create a model instance.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># Model类型的视图路由，当post访问时，路由默认会访问到create方法('post': 'create')，即对数据进行保存</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="comment"># 传入前端传入的数据，进行反序列化</span></span><br><span class="line">        serializer = self.get_serializer(data=request.data)</span><br><span class="line">        <span class="comment"># 判断是否全部都校验通过，通过了就执行后面语句；raise_exception=True不通过直接报错，下面也不会执行</span></span><br><span class="line">        serializer.is_valid(raise_exception=<span class="keyword">True</span>)</span><br><span class="line">        <span class="comment"># 执行 perform_create 实际就是 .save() 保存实体。可重写此方法，进行更多逻辑处理，类似一个保存钩子</span></span><br><span class="line">        self.perform_create(serializer)</span><br><span class="line">        <span class="comment"># 组装头部信息</span></span><br><span class="line">        headers = self.get_success_headers(serializer.data)</span><br><span class="line">        <span class="comment"># 遵循规范返回创建对象的数据。status 状态信息，对应的是一个个状态码</span></span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data, status=status.HTTP_201_CREATED, headers=headers)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># create中会调用，实际就是.save() 保存实体</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_create</span><span class="params">(self, serializer)</span>:</span></span><br><span class="line">        serializer.save()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_success_headers</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">'Location'</span>: str(data[api_settings.URL_FIELD_NAME])&#125;</span><br><span class="line">        <span class="keyword">except</span> (TypeError, KeyError):</span><br><span class="line">            <span class="keyword">return</span> &#123;&#125;</span><br></pre></td></tr></table></figure><h3 id="序列化-1"><a href="#序列化-1" class="headerlink" title="序列化"></a>序列化</h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.序列化处理对象</span></span><br><span class="line"><span class="comment">## rest_framework/serializers.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseSerializer</span><span class="params">(Field)</span>:</span></span><br><span class="line">    <span class="comment"># 继承关系：UserInfoSerializer -&gt; ModelSerializer -&gt; Serializer -&gt; BaseSerializer</span></span><br><span class="line">    <span class="comment"># python类实例化：Foo() -&gt;&gt; 先执行 __new__ -&gt;&gt; 再执行此 __new__ 方法返回对象的 __init__(如果此时返回的是Bar，那么只会执行Bar的 __init__，而不会执行Foo中的__init__)。如果Foo中没有定义__new__，则直接执行Foo的 __init__ 方法</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, instance=None, data=empty, **kwargs)</span>:</span></span><br><span class="line">        self.instance = instance</span><br><span class="line">        <span class="keyword">if</span> data <span class="keyword">is</span> <span class="keyword">not</span> empty:</span><br><span class="line">            self.initial_data = data</span><br><span class="line">        self.partial = kwargs.pop(<span class="string">'partial'</span>, <span class="keyword">False</span>)</span><br><span class="line">        self._context = kwargs.pop(<span class="string">'context'</span>, &#123;&#125;)</span><br><span class="line">        kwargs.pop(<span class="string">'many'</span>, <span class="keyword">None</span>)</span><br><span class="line">        super(BaseSerializer, self).__init__(**kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span><span class="params">(cls, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> kwargs.pop(<span class="string">'many'</span>, <span class="keyword">False</span>):</span><br><span class="line">            <span class="comment"># many=True 处理QuerySet时，获取序列化处理对象</span></span><br><span class="line">            <span class="keyword">return</span> cls.many_init(*args, **kwargs)</span><br><span class="line">        <span class="comment"># many = False 处理单个对象时，返回实例化对象(self)</span></span><br><span class="line">        <span class="keyword">return</span> super(BaseSerializer, cls).__new__(cls, *args, **kwargs)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">many_init</span><span class="params">(cls, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="comment"># ...</span></span><br><span class="line">        <span class="comment"># 获取 Meta 类</span></span><br><span class="line">        meta = getattr(cls, <span class="string">'Meta'</span>, <span class="keyword">None</span>)</span><br><span class="line">        <span class="comment"># 如果 Meta 类没有 list_serializer_class 属性，则默认使用 ListSerializer 实例化对象(处理虚拟化)</span></span><br><span class="line">        list_serializer_class = getattr(meta, <span class="string">'list_serializer_class'</span>, ListSerializer)</span><br><span class="line">        <span class="keyword">return</span> list_serializer_class(*args, **list_kwargs)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.从ser.data(ser = UserRoleSerializer(instance=roles, many=True))开始解读源码。此时只考虑解析单个对象，List同理</span></span><br><span class="line"><span class="comment"># ser.data -&gt;&gt; self.to_representation -&gt;&gt; self._readable_fields -&gt;&gt; self.get_fields  -&gt;&gt; field.to_representation</span></span><br><span class="line"><span class="comment">## rest_framework/serializers.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Serializer</span><span class="params">(BaseSerializer)</span>:</span></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">data</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># 返回父类data</span></span><br><span class="line">        ret = super(Serializer, self).data</span><br><span class="line">        <span class="keyword">return</span> ReturnDict(ret, serializer=self)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseSerializer</span><span class="params">(Field)</span>:</span></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">data</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># ...</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> hasattr(self, <span class="string">'_data'</span>):</span><br><span class="line">            <span class="comment"># 执行self.to_representation方法</span></span><br><span class="line">            <span class="keyword">if</span> self.instance <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span> <span class="keyword">and</span> <span class="keyword">not</span> getattr(self, <span class="string">'_errors'</span>, <span class="keyword">None</span>):</span><br><span class="line">                self._data = self.to_representation(self.instance)</span><br><span class="line">            <span class="keyword">elif</span> hasattr(self, <span class="string">'_validated_data'</span>) <span class="keyword">and</span> <span class="keyword">not</span> getattr(self, <span class="string">'_errors'</span>, <span class="keyword">None</span>):</span><br><span class="line">                self._data = self.to_representation(self.validated_data)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self._data = self.get_initial()</span><br><span class="line">        <span class="keyword">return</span> self._data</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ModelSerializer</span><span class="params">(Serializer)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_fields</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">'''获取需要序列化的字段信息'''</span></span><br><span class="line">        <span class="comment">#...</span></span><br><span class="line">        model = getattr(self.Meta, <span class="string">'model'</span>)</span><br><span class="line">        depth = getattr(self.Meta, <span class="string">'depth'</span>, <span class="number">0</span>)</span><br><span class="line">        <span class="comment">#...</span></span><br><span class="line">        field_names = self.get_field_names(declared_fields, info)</span><br><span class="line">        extra_kwargs = self.get_extra_kwargs() <span class="comment"># Meta中可以定义，如 extra_kwargs = &#123;'start_time': &#123;'format': '%Y-%m'&#125;&#125; 描述字段扩展信息。参数提供：format/required/default/validators等</span></span><br><span class="line">        <span class="comment">#...</span></span><br><span class="line">        fields = OrderedDict()</span><br><span class="line">        <span class="keyword">for</span> field_name <span class="keyword">in</span> field_names:</span><br><span class="line">            <span class="comment">#...</span></span><br><span class="line">        <span class="keyword">return</span> fields</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">to_representation</span><span class="params">(self, instance)</span>:</span></span><br><span class="line">        ret = OrderedDict()</span><br><span class="line">        <span class="comment"># 获取需要序列化的字段信息 -&gt;&gt; self.get_fields</span></span><br><span class="line">        fields = self._readable_fields</span><br><span class="line"></span><br><span class="line">        <span class="comment"># fields为序列化中定义的字段 [id = serializers.IntegerField(), username = serializers.CharField(), ...]</span></span><br><span class="line">        <span class="keyword">for</span> field <span class="keyword">in</span> fields:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># CharField().get_attribute(user对象), user对象.username</span></span><br><span class="line">                attribute = field.get_attribute(instance)</span><br><span class="line">            <span class="keyword">except</span> SkipField:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            check_for_none = attribute.pk <span class="keyword">if</span> isinstance(attribute, PKOnlyObject) <span class="keyword">else</span> attribute</span><br><span class="line">            <span class="keyword">if</span> check_for_none <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">                ret[field.field_name] = <span class="keyword">None</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># 执行每个字段类型的to_representation获取数据的展现值</span></span><br><span class="line">                <span class="comment"># CharField().to_representation()、HyperlinkedIdentityField().to_representation() # 包含了反向生成url</span></span><br><span class="line">                <span class="comment"># 如果 depth &gt; 0, 此时 field 为 NestedSerializer(ModelSerializer)</span></span><br><span class="line">                ret[field.field_name] = field.to_representation(attribute)</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line"><span class="comment">## rest_framework/fields.py</span></span><br><span class="line"><span class="comment"># 继承关系 CharField -&gt; Field</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Field</span><span class="params">(Field)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_attribute</span><span class="params">(self, instance)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># self.source_attrs = self.source.split('.')</span></span><br><span class="line">            <span class="comment"># instance对象：user。source：group.title/get_level_display/role.all</span></span><br><span class="line">            <span class="keyword">return</span> get_attribute(instance, self.source_attrs)</span><br><span class="line">        <span class="comment"># ...</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_attribute</span><span class="params">(instance, attrs)</span>:</span></span><br><span class="line">    <span class="comment"># attrs = [group, title]/[get_level_display]/[role, all]</span></span><br><span class="line">    <span class="keyword">for</span> attr <span class="keyword">in</span> attrs:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 是否为字典(字段必须用 [] 取值，class对象可通过 . 取值)</span></span><br><span class="line">            <span class="keyword">if</span> isinstance(instance, collections.Mapping):</span><br><span class="line">                instance = instance[attr]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># 第一次循环相当于 instance = instance.group</span></span><br><span class="line">                <span class="comment"># 第二次循环相当于 instance = group.title</span></span><br><span class="line">                <span class="comment"># 如果是 get_level_display, 则第一次循环相当于 instance = instance.get_level_display</span></span><br><span class="line">                instance = getattr(instance, attr)</span><br><span class="line">        <span class="keyword">except</span> ObjectDoesNotExist:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">if</span> is_simple_callable(instance):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># instance.get_level_display 是一个可执行的方法，则执行方法获取</span></span><br><span class="line">                instance = instance()</span><br><span class="line">            <span class="comment"># ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 返回属性值(此时instance已经变成属性值)</span></span><br><span class="line">    <span class="keyword">return</span> instance        </span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.验证</span></span><br><span class="line"><span class="comment"># ser.is_valid() -&gt;&gt; self.run_validation -&gt;&gt; Serializer().run_validation() -&gt;&gt; self.to_internal_value -&gt;&gt; validate_xxx() -&gt;&gt; self.run_validators</span></span><br><span class="line"><span class="comment">## rest_framework/serializers.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseSerializer</span><span class="params">(Field)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">is_valid</span><span class="params">(self, raise_exception=False)</span>:</span></span><br><span class="line">        <span class="comment"># ...</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> hasattr(self, <span class="string">'_validated_data'</span>):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># 执行 run_validation 方法(从SerializerUserInfo -&gt; ModelSerializer -&gt; Serializer -&gt; BaseSerializer -&gt; Field依次查询此方法。注意不要使用PyCharm左键点击，这样找到的不准确)。比如此时执行Serializer().run_validation()</span></span><br><span class="line">                self._validated_data = self.run_validation(self.initial_data)</span><br><span class="line">            <span class="keyword">except</span> ValidationError <span class="keyword">as</span> exc:</span><br><span class="line">                self._validated_data = &#123;&#125;</span><br><span class="line">                self._errors = exc.detail</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self._errors = &#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self._errors <span class="keyword">and</span> raise_exception:</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(self.errors)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">not</span> bool(self._errors)</span><br><span class="line"></span><br><span class="line"><span class="meta">@six.add_metaclass(SerializerMetaclass)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Serializer</span><span class="params">(BaseSerializer)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run_validation</span><span class="params">(self, data=empty)</span>:</span></span><br><span class="line">        (is_empty_value, data) = self.validate_empty_values(data)</span><br><span class="line">        <span class="keyword">if</span> is_empty_value:</span><br><span class="line">            <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 获取内部值(获取执行用户验证器钩子函数后的值)</span></span><br><span class="line">        value = self.to_internal_value(data)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 执行 validators 参数中的验证器</span></span><br><span class="line">            self.run_validators(value)</span><br><span class="line">            value = self.validate(value)</span><br><span class="line">            <span class="keyword">assert</span> value <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>, <span class="string">'.validate() should return the validated data'</span></span><br><span class="line">        <span class="keyword">except</span> (ValidationError, DjangoValidationError) <span class="keyword">as</span> exc:</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(detail=as_serializer_error(exc))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">to_internal_value</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        <span class="comment"># ...</span></span><br><span class="line">        <span class="keyword">for</span> field <span class="keyword">in</span> fields:</span><br><span class="line">            <span class="comment"># 获取此序列化执行器的验证器钩子函数 `validate_序列化类属性名`</span></span><br><span class="line">            validate_method = getattr(self, <span class="string">'validate_'</span> + field.field_name, <span class="keyword">None</span>)</span><br><span class="line">            primitive_value = field.get_value(data)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># 执行字段验证器。如 serializers.EmailField</span></span><br><span class="line">                validated_value = field.run_validation(primitive_value)</span><br><span class="line">                <span class="keyword">if</span> validate_method <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">                    <span class="comment"># 执行验证器钩子函数</span></span><br><span class="line">                    validated_value = validate_method(validated_value)</span><br><span class="line">            <span class="keyword">except</span> ValidationError <span class="keyword">as</span> exc:</span><br><span class="line">                errors[field.field_name] = exc.detail</span><br><span class="line">            <span class="comment"># ...</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> errors:</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(errors)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ret</span><br></pre></td></tr></table></figure><h3 id="渲染器-1"><a href="#渲染器-1" class="headerlink" title="渲染器"></a>渲染器</h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rest_framework/renderers.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BrowsableAPIRenderer</span><span class="params">(BaseRenderer)</span>:</span></span><br><span class="line">    media_type = <span class="string">'text/html'</span></span><br><span class="line">    format = <span class="string">'api'</span>  <span class="comment"># 返回的josn数据通过api页面进行展示</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 继承此类，重新指定以下两个模板，即可修改api页面排版</span></span><br><span class="line">    template = <span class="string">'rest_framework/api.html'</span></span><br><span class="line">    filter_template = <span class="string">'rest_framework/filters/base.html'</span></span><br><span class="line">    </span><br><span class="line">    code_style = <span class="string">'emacs'</span></span><br><span class="line">    charset = <span class="string">'utf-8'</span></span><br><span class="line">    form_renderer_class = HTMLFormRenderer</span><br><span class="line">    <span class="comment"># ...</span></span><br></pre></td></tr></table></figure><hr><p>参考文章</p></div><div></div><div></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> smalle</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="http://blog.aezo.cn/2018/09/24/lang/python/django-rest-framework/" title="Django-Rest-Framework">http://blog.aezo.cn/2018/09/24/lang/python/django-rest-framework/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/python/" rel="tag"># python</a> <a href="/tags/django/" rel="tag"># django</a> <a href="/tags/restful/" rel="tag"># restful</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2018/09/24/lang/python/django/" rel="next" title="Django"><i class="fa fa-chevron-left"></i> Django</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"> <a href="/2018/10/09/devops/jenkins/" rel="prev" title="Jenkins">Jenkins<i class="fa fa-chevron-right"></i></a></div></div></footer></article><div class="post-spread"><div> <a target="_blank" href="https://github.com/oldinaction/ChatGPT-MP"><img class="nofancybox" style="width:300px;margin:0 auto" src="https://cdn7.aezo.cn/one/chat/chat-gpt-open-banner.jpg" alt="ChatGPT开源小程序" title="ChatGPT开源小程序"></a></div></div></div></div><div class="comments" id="comments"></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> 文章目录</li><li class="sidebar-nav-overview" data-target="site-overview"> 站点概览</li></ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="https://avatars0.githubusercontent.com/u/15698218?v=3&u=ce740bf0b67ff0d74990ba6fc644d6e92f572dcb&s=400" alt="smalle"><p class="site-author-name" itemprop="name">smalle</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">162</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/index.html"><span class="site-state-item-count">13</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/index.html"><span class="site-state-item-count">145</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"></div><div> 欢迎关注公众号：阿壹族 <img class="nofancybox" style="width:120px;margin:0 auto" src="https://cdn7.aezo.cn/common/qrcode/ayz_qrcode.jpg" alt="欢迎关注公众号：阿壹族" title="欢迎关注公众号：阿壹族"></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#简介"><span class="nav-number">1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#认证"><span class="nav-number">2.</span> <span class="nav-text">认证</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#使用rest-framework认证模块"><span class="nav-number">2.1.</span> <span class="nav-text">使用rest framework认证模块</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#权限"><span class="nav-number">3.</span> <span class="nav-text">权限</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#访问控制-节流"><span class="nav-number">4.</span> <span class="nav-text">访问控制/节流</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#版本控制"><span class="nav-number">5.</span> <span class="nav-text">版本控制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#解析器"><span class="nav-number">6.</span> <span class="nav-text">解析器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#序列化"><span class="nav-number">7.</span> <span class="nav-text">序列化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#定义序列化操作器"><span class="nav-number">7.1.</span> <span class="nav-text">定义序列化操作器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#提交数据验证"><span class="nav-number">7.2.</span> <span class="nav-text">提交数据验证</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分页"><span class="nav-number">8.</span> <span class="nav-text">分页</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#渲染器"><span class="nav-number">9.</span> <span class="nav-text">渲染器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#视图"><span class="nav-number">10.</span> <span class="nav-text">视图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#路由"><span class="nav-number">11.</span> <span class="nav-text">路由</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#过滤器"><span class="nav-number">12.</span> <span class="nav-text">过滤器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#django-url-filter-过滤插件-推荐"><span class="nav-number">12.1.</span> <span class="nav-text">django-url-filter 过滤插件(推荐)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#django-filter-过滤插件"><span class="nav-number">12.2.</span> <span class="nav-text">django-filter 过滤插件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SearchFilter-模糊匹配进行过滤"><span class="nav-number">12.3.</span> <span class="nav-text">SearchFilter 模糊匹配进行过滤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#OrderingFilter-排序过滤"><span class="nav-number">12.4.</span> <span class="nav-text">OrderingFilter 排序过滤</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#其他"><span class="nav-number">13.</span> <span class="nav-text">其他</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#跨域"><span class="nav-number">13.1.</span> <span class="nav-text">跨域</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#异常处理"><span class="nav-number">13.2.</span> <span class="nav-text">异常处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#禁用crsf"><span class="nav-number">13.3.</span> <span class="nav-text">禁用crsf</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#统一结果返回"><span class="nav-number">13.4.</span> <span class="nav-text">统一结果返回</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#rest-framework-源码解析"><span class="nav-number">14.</span> <span class="nav-text">rest framework 源码解析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#封装request和认证-1"><span class="nav-number">14.1.</span> <span class="nav-text">封装request和认证 ^1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#权限-1"><span class="nav-number">14.2.</span> <span class="nav-text">权限</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#访问控制-节流-1"><span class="nav-number">14.3.</span> <span class="nav-text">访问控制/节流</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#视图-1"><span class="nav-number">14.4.</span> <span class="nav-text">视图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#序列化-1"><span class="nav-number">14.5.</span> <span class="nav-text">序列化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#渲染器-1"><span class="nav-number">14.6.</span> <span class="nav-text">渲染器</span></a></li></ol></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright"> &copy; 2016 - <span itemprop="copyrightYear">2023</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">smalle</span>&nbsp;&nbsp;&nbsp;&nbsp;<div class="powered-by"> 由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div><div class="powered-by"> 主题 - <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a></div><div class="theme-info"> <a class="theme-link" target="_blank" href="https://tongji.baidu.com/main/overview/10000542408/overview/index?siteId=18991897">站长统计</a></div></div><div class="ad"> <span style="font-weight:700">AD&nbsp;&nbsp;&nbsp;&nbsp;</span><div class="theme-info"> <a target="_blank" href="https://promotion.aliyun.com/ntms/yunparter/invite.html?userCode=oby5nolb">阿里云大礼包</a></div></div><div class="aezocn"> <span style="font-weight:700">&copy;AEZO.CN&nbsp;&nbsp;&nbsp;&nbsp;</span><div class="powered-by"> <a target="_blank" href="https://shengqitech.aezo.cn/">圣骑科技</a></div><div class="powered-by"> <a target="_blank" href="https://cdn7.aezo.cn/common/qrcode/one_qrcode.jpg">【One能抽屉】小程序</a></div><div class="theme-info"> <a target="_blank" href="http://shop.aezo.cn/">杂货铺(省钱小助手)</a></div></div><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?085f9cd91ef2ad985f791c677472f0d1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script><script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script type="text/javascript" src="/js/src/js.cookie.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/scroll-cookie.js?v=5.1.1"></script></body></html>