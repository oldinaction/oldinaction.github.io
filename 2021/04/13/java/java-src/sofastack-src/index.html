<!doctype html><html class="theme-next mist use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css"><meta name="keywords" content="src,springboot,微服务,plugin,"><link rel="alternate" href="/atom.xml" title="Smalle's Blog | AEZOCN" type="application/atom+xml"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1"><meta name="description" content="isle-sofa-boot模块隔离初始化 初始化SOFABoot模块：主要是初始化各模块的SpringContext上下文 如基于多Ark Biz启动，一般不会包含此包，各Biz间通信基于runtime-sofa-boot包完成  Spring启动完成后广播事件 Spring相关  12345678910111213141516171819202122232425// AbstractAppli"><meta name="keywords" content="src,springboot,微服务,plugin"><meta property="og:type" content="article"><meta property="og:title" content="SOFAStack源码分析"><meta property="og:url" content="http://blog.aezo.cn/2021/04/13/java/java-src/sofastack-src/index.html"><meta property="og:site_name" content="Smalle&#39;s Blog | AEZOCN"><meta property="og:description" content="isle-sofa-boot模块隔离初始化 初始化SOFABoot模块：主要是初始化各模块的SpringContext上下文 如基于多Ark Biz启动，一般不会包含此包，各Biz间通信基于runtime-sofa-boot包完成  Spring启动完成后广播事件 Spring相关  12345678910111213141516171819202122232425// AbstractAppli"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="http://blog.aezo.cn/data/images/java/sofa-ark.png"><meta property="og:updated_time" content="2022-01-18T11:10:03.266Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="SOFAStack源码分析"><meta name="twitter:description" content="isle-sofa-boot模块隔离初始化 初始化SOFABoot模块：主要是初始化各模块的SpringContext上下文 如基于多Ark Biz启动，一般不会包含此包，各Biz间通信基于runtime-sofa-boot包完成  Spring启动完成后广播事件 Spring相关  12345678910111213141516171819202122232425// AbstractAppli"><meta name="twitter:image" content="http://blog.aezo.cn/data/images/java/sofa-ark.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",sidebar:{position:"right",display:"post",offset:12,offset_float:0,b2t:!1,scrollpercent:!1},fancybox:!0,motion:!0,duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"BWD6R9FA4K",apiKey:"3330f3cbaa099dfc30395de5f5b20151",indexName:"blog",hits:{per_page:10},labels:{input_placeholder:"请输入关键字",hits_empty:"我们没有找到任何搜索结果: ${query}",hits_stats:"找到约${hits}条结果（用时${time}ms）"}}}</script><link rel="canonical" href="http://blog.aezo.cn/2021/04/13/java/java-src/sofastack-src/"><title>SOFAStack源码分析 | Smalle's Blog | AEZOCN</title><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?085f9cd91ef2ad985f791c677472f0d1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><div style="display:none"><script src="//s95.cnzz.com/z_stat.php?id=cnzz_stat_icon_1276691827&web_id=cnzz_stat_icon_1276691827" language="JavaScript"></script></div></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-right page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Smalle's Blog | AEZOCN</span><span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">Better Code, Better Life</h1></div><div class="site-nav-toggle"> <button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br> 首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br> 分类</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br> 关于</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br> 归档</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br> 标签</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i><br> 站点地图</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br> 搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"> <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><link itemprop="mainEntityOfPage" href="http://blog.aezo.cn/2021/04/13/java/java-src/sofastack-src/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="smalle"><meta itemprop="description" content=""><meta itemprop="image" content="https://avatars0.githubusercontent.com/u/15698218?v=3&u=ce740bf0b67ff0d74990ba6fc644d6e92f572dcb&s=400"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Smalle's Blog | AEZOCN"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">SOFAStack源码分析</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-04-13T22:23:00+08:00">2021-04-13</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a></span></span></div></header><div class="post-body" itemprop="articleBody"><div></div><h2 id="isle-sofa-boot模块隔离"><a href="#isle-sofa-boot模块隔离" class="headerlink" title="isle-sofa-boot模块隔离"></a>isle-sofa-boot模块隔离</h2><h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><ul><li><strong>初始化SOFABoot模块：主要是初始化各模块的SpringContext上下文</strong></li><li>如基于多Ark Biz启动，一般不会包含此包，各Biz间通信基于runtime-sofa-boot包完成</li></ul><h4 id="Spring启动完成后广播事件"><a href="#Spring启动完成后广播事件" class="headerlink" title="Spring启动完成后广播事件"></a>Spring启动完成后广播事件</h4><ul><li>Spring相关</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AbstractApplicationContext.java，参考[spring-ioc-src.md#refresh方法概览](/_posts/java/java-src/spring-ioc-src.md#refresh方法概览)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">this</span>.finishRefresh();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ServletWebServerApplicationContext.java</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finishRefresh</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 调用父类</span></span><br><span class="line">    <span class="keyword">super</span>.finishRefresh();</span><br><span class="line">    WebServer webServer = <span class="keyword">this</span>.startWebServer();</span><br><span class="line">    <span class="keyword">if</span> (webServer != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.publishEvent(<span class="keyword">new</span> ServletWebServerInitializedEvent(webServer, <span class="keyword">this</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AbstractApplicationContext.java</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finishRefresh</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.clearResourceCaches();</span><br><span class="line">    <span class="keyword">this</span>.initLifecycleProcessor();</span><br><span class="line">    <span class="keyword">this</span>.getLifecycleProcessor().onRefresh();</span><br><span class="line">    <span class="comment">// 广播事件</span></span><br><span class="line">    <span class="keyword">this</span>.publishEvent((ApplicationEvent)(<span class="keyword">new</span> ContextRefreshedEvent(<span class="keyword">this</span>)));</span><br><span class="line">    LiveBeansView.registerApplicationContext(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>SofaModuleContextRefreshedListener.java 监听Spring启动后事件</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SofaModuleContextRefreshedListener实例化参考[sofa-boot-autoconfigure](#sofa-boot-autoconfigure)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SofaModuleContextRefreshedListener</span> <span class="keyword">implements</span> <span class="title">PriorityOrdered</span>,</span></span><br><span class="line"><span class="class">                                               <span class="title">ApplicationListener</span>&lt;<span class="title">ContextRefreshedEvent</span>&gt;,</span></span><br><span class="line"><span class="class">                                               <span class="title">ApplicationContextAware</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(ContextRefreshedEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (applicationContext.equals(event.getApplicationContext())) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 处理 pipeline 流水线</span></span><br><span class="line">                pipelineContext.process();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                SofaLogger.error(<span class="string">"process pipeline error"</span>, t);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(t);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;                                                </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="处理pipeline流水线"><a href="#处理pipeline流水线" class="headerlink" title="处理pipeline流水线"></a>处理pipeline流水线</h4><ul><li>DefaultPipelineContext.java, 其实例化参考<a href="#sofa-boot-autoconfigure">sofa-boot-autoconfigure</a></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultPipelineContext</span> <span class="keyword">implements</span> <span class="title">PipelineContext</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;PipelineStage&gt; stageList;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 依次处理所有 PipelineStage：**ModelCreatingStage、SpringContextInstallStage、ModuleLogOutputStage**</span></span><br><span class="line">        <span class="keyword">for</span> (PipelineStage pipelineStage : stageList) &#123;</span><br><span class="line">            pipelineStage.process();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="SpringContextInstallStage为例"><a href="#SpringContextInstallStage为例" class="headerlink" title="SpringContextInstallStage为例"></a>SpringContextInstallStage为例</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AbstractPipelineStage.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractPipelineStage</span> <span class="keyword">implements</span> <span class="title">PipelineStage</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// ++++++++++++++++++ SpringContextInstallStage of SqBiz Main Start +++++++++++++++++</span></span><br><span class="line">        SofaLogger.info(<span class="string">"++++++++++++++++++ &#123;&#125; of &#123;&#125; Start +++++++++++++++++"</span>, <span class="keyword">this</span>.getClass()</span><br><span class="line">            .getSimpleName(), appName); <span class="comment">// appName 为 spring.application.name</span></span><br><span class="line">        <span class="comment">// 实际处理程序</span></span><br><span class="line">        doProcess();</span><br><span class="line">        <span class="comment">// ++++++++++++++++++ SpringContextInstallStage of SqBiz Main End +++++++++++++++++</span></span><br><span class="line">        SofaLogger.info(<span class="string">"++++++++++++++++++ &#123;&#125; of &#123;&#125; End +++++++++++++++++"</span>, <span class="keyword">this</span>.getClass()</span><br><span class="line">            .getSimpleName(), appName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SpringContextInstallStage.java, 其实例化参考[sofa-boot-autoconfigure](#sofa-boot-autoconfigure)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringContextInstallStage</span> <span class="keyword">extends</span> <span class="title">AbstractPipelineStage</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doProcess</span><span class="params">(ApplicationRuntimeModel application)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 打印模块信息</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        All activated module list(2) &gt;&gt;&gt;&gt;&gt;&gt;&gt;</span></span><br><span class="line"><span class="comment">            ├─ cn.aezo.sqbiz.sqbiz-plugin.service-consumer</span></span><br><span class="line"><span class="comment">            └─ cn.aezo.sqbiz.sqbiz-plugin.service-provider</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        Modules that could install(2) &gt;&gt;&gt;&gt;&gt;&gt;&gt;</span></span><br><span class="line"><span class="comment">            ├─ cn.aezo.sqbiz.sqbiz-plugin.service-provider</span></span><br><span class="line"><span class="comment">            └─ cn.aezo.sqbiz.sqbiz-plugin.service-consumer</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        outputModulesMessage(application);</span><br><span class="line">        <span class="comment">// 创建模块的SpringContextLoader(上下文加载器). new DynamicSpringContextLoader(applicationContext)</span></span><br><span class="line">        SpringContextLoader springContextLoader = createSpringContextLoader();</span><br><span class="line">        <span class="comment">// **加载SpringContext配置文件**</span></span><br><span class="line">        installSpringContext(application, springContextLoader);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (sofaModuleProperties.isModuleStartUpParallel()) &#123;</span><br><span class="line">            <span class="comment">// **并行刷新SpringContext，初始化Bean**</span></span><br><span class="line">            refreshSpringContextParallel(application);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 刷新SpringContext</span></span><br><span class="line">            refreshSpringContext(application);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="创建模块的SpringContextLoader-上下文加载器"><a href="#创建模块的SpringContextLoader-上下文加载器" class="headerlink" title="创建模块的SpringContextLoader(上下文加载器)"></a>创建模块的SpringContextLoader(上下文加载器)</h6><ul><li>SpringContextInstallStage.java</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> SpringContextLoader <span class="title">createSpringContextLoader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> DynamicSpringContextLoader(applicationContext);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>DynamicSpringContextLoader.java解析spring配置文件，加载Bean。下文<a href="#加载SpringContext配置文件">加载SpringContext配置文件</a>会调用</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicSpringContextLoader</span> <span class="keyword">implements</span> <span class="title">SpringContextLoader</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 加载SpringContext配置文件时会调用</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadSpringContext</span><span class="params">(DeploymentDescriptor deployment,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  ApplicationRuntimeModel application)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// rootApplicationContext 如主模块上下文</span></span><br><span class="line">        SofaModuleProperties sofaModuleProperties = rootApplicationContext</span><br><span class="line">            .getBean(SofaModuleProperties.class);</span><br><span class="line"></span><br><span class="line">        BeanLoadCostBeanFactory beanFactory = <span class="keyword">new</span> BeanLoadCostBeanFactory(</span><br><span class="line">            sofaModuleProperties.getBeanLoadCost(), deployment.getModuleName());</span><br><span class="line">        beanFactory</span><br><span class="line">            .setAutowireCandidateResolver(<span class="keyword">new</span> QualifierAnnotationAutowireCandidateResolver());</span><br><span class="line">        GenericApplicationContext ctx = sofaModuleProperties.isPublishEventToParent() ? <span class="keyword">new</span> GenericApplicationContext(</span><br><span class="line">            beanFactory) : <span class="keyword">new</span> SofaModuleApplicationContext(beanFactory);</span><br><span class="line">        <span class="comment">// 获取激活的环境类型</span></span><br><span class="line">        String activeProfiles = sofaModuleProperties.getActiveProfiles();</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(activeProfiles)) &#123;</span><br><span class="line">            String[] profiles = activeProfiles.split(SofaBootConstants.PROFILE_SEPARATOR);</span><br><span class="line">            ctx.getEnvironment().setActiveProfiles(profiles);</span><br><span class="line">        &#125;</span><br><span class="line">        setUpParentSpringContext(ctx, deployment, application);</span><br><span class="line">        <span class="keyword">final</span> ClassLoader moduleClassLoader = deployment.getClassLoader();</span><br><span class="line">        ctx.setClassLoader(moduleClassLoader);</span><br><span class="line">        CachedIntrospectionResults.acceptClassLoader(moduleClassLoader);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// set allowBeanDefinitionOverriding</span></span><br><span class="line">        ctx.setAllowBeanDefinitionOverriding(sofaModuleProperties.isAllowBeanDefinitionOverriding());</span><br><span class="line"></span><br><span class="line">        ctx.getBeanFactory().setBeanClassLoader(moduleClassLoader);</span><br><span class="line">        ctx.getBeanFactory().addPropertyEditorRegistrar(<span class="keyword">new</span> PropertyEditorRegistrar() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerCustomEditors</span><span class="params">(PropertyEditorRegistry registry)</span> </span>&#123;</span><br><span class="line">                registry.registerCustomEditor(Class.class, <span class="keyword">new</span> ClassEditor(moduleClassLoader));</span><br><span class="line">                registry.registerCustomEditor(Class[].class,</span><br><span class="line">                    <span class="keyword">new</span> ClassArrayEditor(moduleClassLoader));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        deployment.setApplicationContext(ctx);</span><br><span class="line"></span><br><span class="line">        XmlBeanDefinitionReader beanDefinitionReader = <span class="keyword">new</span> XmlBeanDefinitionReader(ctx);</span><br><span class="line">        beanDefinitionReader.setValidating(<span class="keyword">true</span>);</span><br><span class="line">        beanDefinitionReader.setNamespaceAware(<span class="keyword">true</span>);</span><br><span class="line">        beanDefinitionReader</span><br><span class="line">            .setBeanClassLoader(deployment.getApplicationContext().getClassLoader());</span><br><span class="line">        beanDefinitionReader.setResourceLoader(ctx);</span><br><span class="line">        <span class="comment">// 加载配置文件中定义的Bean</span></span><br><span class="line">        loadBeanDefinitions(deployment, beanDefinitionReader);</span><br><span class="line">        addPostProcessors(beanFactory);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="加载SpringContext配置文件"><a href="#加载SpringContext配置文件" class="headerlink" title="加载SpringContext配置文件"></a>加载SpringContext配置文件</h6><ul><li>SpringContextInstallStage.java</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 加载SpringContext配置文件</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">installSpringContext</span><span class="params">(ApplicationRuntimeModel application,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    SpringContextLoader springContextLoader)</span> </span>&#123;</span><br><span class="line">    ClassLoader oldClassLoader = Thread.currentThread().getContextClassLoader();</span><br><span class="line">    <span class="comment">// 循环处理依赖的模块：sofa-module.properties</span></span><br><span class="line">    <span class="keyword">for</span> (DeploymentDescriptor deployment : application.getResolvedDeployments()) &#123;</span><br><span class="line">        <span class="comment">// 判断是否有Spring配置文件</span></span><br><span class="line">        <span class="keyword">if</span> (deployment.isSpringPowered()) &#123;</span><br><span class="line">            <span class="comment">// Start install SqBiz Main's module: cn.aezo.sqbiz.sqbiz-plugin.service-provider</span></span><br><span class="line">            SofaLogger.info(<span class="string">"Start install "</span> + application.getAppName() + <span class="string">"'s module: "</span></span><br><span class="line">                            + deployment.getName());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 记录加载器，如：BizClassLoader(bizIdentity=Startup In IDE:Mock version)</span></span><br><span class="line">                Thread.currentThread().setContextClassLoader(deployment.getClassLoader());</span><br><span class="line">                <span class="comment">// 参考上文[创建模块的SpringContextLoader(上下文加载器)](#创建模块的SpringContextLoader(上下文加载器))</span></span><br><span class="line">                springContextLoader.loadSpringContext(deployment, application);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                SofaLogger.error(<span class="string">"Install module &#123;&#125; got an error!"</span>, deployment.getName(), t);</span><br><span class="line">                application.addFailed(deployment);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                Thread.currentThread().setContextClassLoader(oldClassLoader);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>AbstractDeploymentDescriptor.java</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractDeploymentDescriptor</span> <span class="keyword">implements</span> <span class="title">DeploymentDescriptor</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Spring配置文件</span></span><br><span class="line">    Map&lt;String, Resource&gt;                   springResources;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isSpringPowered</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 配置文件不存在则先读取XML文件</span></span><br><span class="line">        <span class="keyword">if</span> (springResources == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.loadSpringXMLs();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果存在配置文件，则说明存在Spring上下文环境，之后可进行刷新SpringContext</span></span><br><span class="line">        <span class="keyword">return</span> !springResources.isEmpty();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>FileDeploymentDescriptor.java 基于文件安装的模块，另外一个实现是基于Jar(JarDeploymentDescriptor)</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileDeploymentDescriptor</span> <span class="keyword">extends</span> <span class="title">AbstractDeploymentDescriptor</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadSpringXMLs</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        springResources = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// When path contains special characters (e.g., white space, Chinese), URL converts them to UTF8 code point.</span></span><br><span class="line">            <span class="comment">// In order to processing correctly, create File from URI</span></span><br><span class="line">            <span class="comment">// Spring配置文件目录, 如: C:\Users\smalle\Desktop\sofa-ark-dynamic-guides-master\ark-dynamic-module\target\classes\META-INF\spring</span></span><br><span class="line">            URI springXmlUri = <span class="keyword">new</span> URI(<span class="string">"file://"</span></span><br><span class="line">                                       + url.getFile().substring(</span><br><span class="line">                                           <span class="number">0</span>,</span><br><span class="line">                                           url.getFile().length()</span><br><span class="line">                                                   - SofaBootConstants.SOFA_MODULE_FILE.length())</span><br><span class="line">                                       + SofaBootConstants.SPRING_CONTEXT_PATH); <span class="comment">// META-INF/spring</span></span><br><span class="line">            File springXml = <span class="keyword">new</span> File(springXmlUri);</span><br><span class="line">            List&lt;File&gt; springFiles = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            <span class="keyword">if</span> (springXml.exists()) &#123;</span><br><span class="line">                listFiles(springFiles, springXml, <span class="string">".xml"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (File f : springFiles) &#123;</span><br><span class="line">                <span class="comment">// 保存到 springResources 缓存中</span></span><br><span class="line">                springResources.put(f.getAbsolutePath(), <span class="keyword">new</span> FileSystemResource(f));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="并行刷新SpringContext"><a href="#并行刷新SpringContext" class="headerlink" title="并行刷新SpringContext"></a>并行刷新SpringContext</h6><ul><li>SpringContextInstallStage.java</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">refreshSpringContextParallel</span><span class="params">(ApplicationRuntimeModel application)</span> </span>&#123;</span><br><span class="line">    ClassLoader oldClassLoader = Thread.currentThread().getContextClassLoader();</span><br><span class="line">    List&lt;DeploymentDescriptor&gt; coreRoots = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="comment">// 定义线程执行器，初始化模块时的线程名如：sofa-module-start-cn.aezo.sqbiz.sqbiz-plugin.service-provider</span></span><br><span class="line">    ThreadPoolExecutor executor = <span class="keyword">new</span> SofaThreadPoolExecutor(CPU_COUNT + <span class="number">1</span>, CPU_COUNT + <span class="number">1</span>, <span class="number">60</span>,</span><br><span class="line">        TimeUnit.MILLISECONDS, <span class="keyword">new</span> SynchronousQueue&lt;Runnable&gt;(), <span class="keyword">new</span> NamedThreadFactory(</span><br><span class="line">            <span class="string">"sofa-module-start"</span>), <span class="keyword">new</span> ThreadPoolExecutor.CallerRunsPolicy(),</span><br><span class="line">        <span class="string">"sofa-module-start"</span>, <span class="string">"sofa-boot"</span>, <span class="number">60</span>, <span class="number">30</span>, TimeUnit.SECONDS);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 循环处理依赖的模块：sofa-module.properties</span></span><br><span class="line">        <span class="keyword">for</span> (DeploymentDescriptor deployment : application.getResolvedDeployments()) &#123;</span><br><span class="line">            DependencyTree.Entry entry = application.getDeployRegistry().getEntry(</span><br><span class="line">                deployment.getModuleName());</span><br><span class="line">            <span class="comment">// 判断当前模块是否有依赖, Require-Module</span></span><br><span class="line">            <span class="keyword">if</span> (entry != <span class="keyword">null</span> &amp;&amp; entry.getDependencies() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                coreRoots.add(deployment);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 处理底层(被依赖)模块，内部包含了处理上层调用模块，具体见下文</span></span><br><span class="line">        refreshSpringContextParallel(coreRoots, application.getResolvedDeployments().size(),</span><br><span class="line">            application, executor);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        executor.shutdown();</span><br><span class="line">        Thread.currentThread().setContextClassLoader(oldClassLoader);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">refreshSpringContextParallel</span><span class="params">(List&lt;DeploymentDescriptor&gt; rootDeployments,</span></span></span><br><span class="line"><span class="function"><span class="params">                                              <span class="keyword">int</span> totalSize,</span></span></span><br><span class="line"><span class="function"><span class="params">                                              <span class="keyword">final</span> ApplicationRuntimeModel application,</span></span></span><br><span class="line"><span class="function"><span class="params">                                              <span class="keyword">final</span> ThreadPoolExecutor executor)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (rootDeployments == <span class="keyword">null</span> || rootDeployments.size() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> CountDownLatch latch = <span class="keyword">new</span> CountDownLatch(totalSize);</span><br><span class="line">    List&lt;Future&gt; futures = <span class="keyword">new</span> CopyOnWriteArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 依次处理每个模块</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">final</span> DeploymentDescriptor deployment : rootDeployments) &#123;</span><br><span class="line">        refreshSpringContextParallel(deployment, application, executor, latch, futures);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        latch.await();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Wait for Sofa Module Refresh Fail"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Future future : futures) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            future.get();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 某个模块处理逻辑</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">refreshSpringContextParallel</span><span class="params">(<span class="keyword">final</span> DeploymentDescriptor deployment,</span></span></span><br><span class="line"><span class="function"><span class="params">                                              <span class="keyword">final</span> ApplicationRuntimeModel application,</span></span></span><br><span class="line"><span class="function"><span class="params">                                              <span class="keyword">final</span> ThreadPoolExecutor executor,</span></span></span><br><span class="line"><span class="function"><span class="params">                                              <span class="keyword">final</span> CountDownLatch latch, <span class="keyword">final</span> List&lt;Future&gt; futures)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 提交任务</span></span><br><span class="line">    futures.add(executor.submit(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 任务逻辑</span></span><br><span class="line">            String oldName = Thread.currentThread().getName();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.currentThread().setName(</span><br><span class="line">                    <span class="string">"sofa-module-start-"</span> + deployment.getModuleName());</span><br><span class="line">                Thread.currentThread().setContextClassLoader(deployment.getClassLoader());</span><br><span class="line">                <span class="keyword">if</span> (deployment.isSpringPowered()</span><br><span class="line">                    &amp;&amp; !application.getFailed().contains(deployment)) &#123;</span><br><span class="line">                    <span class="comment">// 是Spring应用，且加载成功时执行</span></span><br><span class="line">                    doRefreshSpringContext(deployment, application);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 当前模块</span></span><br><span class="line">                DependencyTree.Entry&lt;String, DeploymentDescriptor&gt; entry = application</span><br><span class="line">                    .getDeployRegistry().getEntry(deployment.getModuleName());</span><br><span class="line">                <span class="keyword">if</span> (entry != <span class="keyword">null</span> &amp;&amp; entry.getDependsOnMe() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// 循环初始化依赖我的模块(初始化上层调用模块)</span></span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">final</span> DependencyTree.Entry&lt;String, DeploymentDescriptor&gt; child : entry</span><br><span class="line">                        .getDependsOnMe()) &#123;</span><br><span class="line">                        child.getDependencies().remove(entry);</span><br><span class="line">                        <span class="keyword">if</span> (child.getDependencies().size() == <span class="number">0</span>) &#123;</span><br><span class="line">                            refreshSpringContextParallel(child.get(), application, executor,</span><br><span class="line">                                latch, futures);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doRefreshSpringContext</span><span class="params">(DeploymentDescriptor deployment,</span></span></span><br><span class="line"><span class="function"><span class="params">                                          ApplicationRuntimeModel application)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Begin refresh Spring Application Context of module cn.aezo.sqbiz.sqbiz-plugin.service-provider of application SqBiz Main.</span></span><br><span class="line">    SofaLogger.info(<span class="string">"Begin refresh Spring Application Context of module &#123;&#125; of application &#123;&#125;."</span>,</span><br><span class="line">        deployment.getName(), application.getAppName());</span><br><span class="line">    <span class="comment">// 获取模块的上下文</span></span><br><span class="line">    ConfigurableApplicationContext ctx = (ConfigurableApplicationContext) deployment</span><br><span class="line">        .getApplicationContext();</span><br><span class="line">    <span class="keyword">if</span> (ctx != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            deployment.startDeploy(); <span class="comment">// 只是记录一下时间</span></span><br><span class="line">            <span class="comment">// 刷新，即调用 ApplicationContext#refresh 方法。参考上文[ServiceComponent为例](#ServiceComponent为例)</span></span><br><span class="line">            <span class="comment">// 依次打印日志：Registering component - &lt;&lt;PreOut Binding - &lt;&lt;Out Binding - Register Service</span></span><br><span class="line">            ctx.refresh();</span><br><span class="line">            <span class="comment">// 注册SpringContext组件，参考上文[SpringContextComponent为例](#SpringContextComponent为例)。方法详细参考下文</span></span><br><span class="line">            publishContextAsSofaComponent(deployment, application, ctx);</span><br><span class="line">            application.addInstalled(deployment);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            SofaLogger.error(</span><br><span class="line">                <span class="string">"Refreshing Spring Application Context of module &#123;&#125; got an error."</span>,</span><br><span class="line">                deployment.getName(), t);</span><br><span class="line">            application.addFailed(deployment);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            deployment.deployFinish();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        String errorMsg = <span class="string">"Spring Application Context of module "</span> + deployment.getName()</span><br><span class="line">                            + <span class="string">" is null!"</span>;</span><br><span class="line">        application.addFailed(deployment);</span><br><span class="line">        SofaLogger.error(errorMsg, <span class="keyword">new</span> RuntimeException(errorMsg));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">publishContextAsSofaComponent</span><span class="params">(DeploymentDescriptor deployment,</span></span></span><br><span class="line"><span class="function"><span class="params">                                               ApplicationRuntimeModel application,</span></span></span><br><span class="line"><span class="function"><span class="params">                                               ApplicationContext context)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 实例化</span></span><br><span class="line">    ComponentName componentName = ComponentNameFactory.createComponentName(</span><br><span class="line">        SpringContextComponent.SPRING_COMPONENT_TYPE, deployment.getModuleName());</span><br><span class="line">    Implementation implementation = <span class="keyword">new</span> SpringContextImplementation(context);</span><br><span class="line">    ComponentInfo componentInfo = <span class="keyword">new</span> SpringContextComponent(componentName, implementation,</span><br><span class="line">        application.getSofaRuntimeContext());</span><br><span class="line">    <span class="comment">// 注册</span></span><br><span class="line">    application.getSofaRuntimeContext().getComponentManager().register(componentInfo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="runtime-sofa-boot"><a href="#runtime-sofa-boot" class="headerlink" title="runtime-sofa-boot"></a>runtime-sofa-boot</h2><ul><li>runtime-sofa-boot-starter-3.1.4.jar</li></ul><h3 id="初始化-1"><a href="#初始化-1" class="headerlink" title="初始化"></a>初始化</h3><ul><li><strong>基于SofaBoot的简单模块隔离，或者基于多Ark Biz启动，都会用到此包</strong></li><li>主要是管理组件(Component, 本质是Bean/服务. 包括ReferenceComponent,ServiceComponent,SpringContextComponent)生命周期</li><li>组件管理类ComponentManagerImpl<ul><li>register/registerAndGet 注册组件<ul><li>服务端Biz, 其Spring初始化时调用，如：ServiceFactoryBean(通过扫描含@SofaReference注解的Bean)、ExtensionFactoryBean</li><li>服务端基于API初始化时调用：ServiceClientImpl、ExtensionClientImpl</li><li>客户端Biz初始化@SofaReference应用，ReferenceRegisterHelper<ul><li>ReferenceFactoryBean(InitializingBean)</li><li>ReferenceAnnotationBeanPostProcessor(BeanPostProcessor)</li><li>ReferenceClientImpl 客户端基于API注册引用</li></ul></li></ul></li></ul></li><li>Spring初始化时，会调用其 postProcessBeforeInitialization 方法<ul><li>如根据<code>@SofaReference</code>注解，将组件信息(此时为ReferenceComponent类)保存到ComponentManagerImpl#registry集合中，集合中的key为ComponentName类型<ul><li>此时ComponentName如：<code>reference:com.alipay.sofa.isle.sample.SampleJvmService:#2120635923</code>(reference表示基于此注解解析的引用信息，会创建其代理对象)</li></ul></li><li>如根据<code>@SofaService</code>注解，将组件信息(此时为ServiceComponent类)保存到registry集合中</li></ul></li></ul><h4 id="BeanPostProcessor注册组件入口"><a href="#BeanPostProcessor注册组件入口" class="headerlink" title="BeanPostProcessor注册组件入口"></a>BeanPostProcessor注册组件入口</h4><h5 id="ReferenceAnnotationBeanPostProcessor为例"><a href="#ReferenceAnnotationBeanPostProcessor为例" class="headerlink" title="ReferenceAnnotationBeanPostProcessor为例"></a>ReferenceAnnotationBeanPostProcessor为例</h5><ul><li>ReferenceAnnotationBeanPostProcessor.java</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReferenceAnnotationBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title">BeanPostProcessor</span>, <span class="title">PriorityOrdered</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Spring初始化时，会调用其此方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span></span></span><br><span class="line"><span class="function">                                                                               <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        processSofaReference(bean);</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processSofaReference</span><span class="params">(<span class="keyword">final</span> Object bean)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 被Spring扫描的Bean</span></span><br><span class="line">        <span class="keyword">final</span> Class&lt;?&gt; beanClass = bean.getClass();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 遍历Bean的所有属性，并执行回调</span></span><br><span class="line">        ReflectionUtils.doWithFields(beanClass, <span class="keyword">new</span> ReflectionUtils.FieldCallback() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doWith</span><span class="params">(Field field)</span> <span class="keyword">throws</span> IllegalArgumentException, IllegalAccessException </span>&#123;</span><br><span class="line">                AnnotationWrapperBuilder&lt;SofaReference&gt; builder = AnnotationWrapperBuilder.wrap(</span><br><span class="line">                    field.getAnnotation(SofaReference.class)).withBinder(binder);</span><br><span class="line">                SofaReference sofaReferenceAnnotation = builder.build();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (sofaReferenceAnnotation == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                Class&lt;?&gt; interfaceType = sofaReferenceAnnotation.interfaceType();</span><br><span class="line">                <span class="keyword">if</span> (interfaceType.equals(<span class="keyword">void</span>.class)) &#123;</span><br><span class="line">                    interfaceType = field.getType();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 创建ReferenceComponent的代理对象，并注册，具体参考下文</span></span><br><span class="line">                Object proxy = createReferenceProxy(sofaReferenceAnnotation, interfaceType);</span><br><span class="line">                ReflectionUtils.makeAccessible(field);</span><br><span class="line">                <span class="comment">// 将代理对象设置为此属性值</span></span><br><span class="line">                ReflectionUtils.setField(field, bean, proxy);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="keyword">new</span> ReflectionUtils.FieldFilter() &#123; <span class="comment">// 字段过滤器，符合要求的才执行回调</span></span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(Field field)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (!field.isAnnotationPresent(SofaReference.class)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (Modifier.isStatic(field.getModifiers())) &#123;</span><br><span class="line">                    SofaLogger.warn(</span><br><span class="line">                        <span class="string">"SofaReference annotation is not supported on static fields: &#123;&#125;"</span>, field);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        ReflectionUtils.doWithMethods(beanClass, <span class="keyword">new</span> ReflectionUtils.MethodCallback() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doWith</span><span class="params">(Method method)</span> <span class="keyword">throws</span> IllegalArgumentException,</span></span><br><span class="line"><span class="function">                                             IllegalAccessException </span>&#123;</span><br><span class="line">                Class[] parameterTypes = method.getParameterTypes();</span><br><span class="line">                Assert.isTrue(parameterTypes.length == <span class="number">1</span>,</span><br><span class="line">                    <span class="string">"method should have one and only one parameter."</span>);</span><br><span class="line"></span><br><span class="line">                SofaReference sofaReferenceAnnotation = method.getAnnotation(SofaReference.class);</span><br><span class="line">                <span class="keyword">if</span> (sofaReferenceAnnotation == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                AnnotationWrapperBuilder&lt;SofaReference&gt; builder = AnnotationWrapperBuilder.wrap(</span><br><span class="line">                    sofaReferenceAnnotation).withBinder(binder);</span><br><span class="line">                sofaReferenceAnnotation = builder.build();</span><br><span class="line"></span><br><span class="line">                Class&lt;?&gt; interfaceType = sofaReferenceAnnotation.interfaceType();</span><br><span class="line">                <span class="keyword">if</span> (interfaceType.equals(<span class="keyword">void</span>.class)) &#123;</span><br><span class="line">                    interfaceType = parameterTypes[<span class="number">0</span>];</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                Object proxy = createReferenceProxy(sofaReferenceAnnotation, interfaceType);</span><br><span class="line">                ReflectionUtils.invokeMethod(method, bean, proxy);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="keyword">new</span> ReflectionUtils.MethodFilter() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(Method method)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> method.isAnnotationPresent(SofaReference.class);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建ReferenceComponent的代理对象，并注册</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Object <span class="title">createReferenceProxy</span><span class="params">(SofaReference sofaReferenceAnnotation,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        Class&lt;?&gt; interfaceType)</span> </span>&#123;</span><br><span class="line">        Reference reference = <span class="keyword">new</span> ReferenceImpl(sofaReferenceAnnotation.uniqueId(), interfaceType,</span><br><span class="line">            InterfaceMode.annotation, sofaReferenceAnnotation.jvmFirst());</span><br><span class="line">        BindingConverter bindingConverter = bindingConverterFactory</span><br><span class="line">            .getBindingConverter(<span class="keyword">new</span> BindingType(sofaReferenceAnnotation.binding().bindingType()));</span><br><span class="line">        <span class="keyword">if</span> (bindingConverter == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ServiceRuntimeException(<span class="string">"Can not found binding converter for binding type "</span></span><br><span class="line">                                              + sofaReferenceAnnotation.binding().bindingType());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        BindingConverterContext bindingConverterContext = <span class="keyword">new</span> BindingConverterContext();</span><br><span class="line">        bindingConverterContext.setInBinding(<span class="keyword">true</span>);</span><br><span class="line">        bindingConverterContext.setApplicationContext(applicationContext);</span><br><span class="line">        bindingConverterContext.setAppName(sofaRuntimeContext.getAppName());</span><br><span class="line">        bindingConverterContext.setAppClassLoader(sofaRuntimeContext.getAppClassLoader());</span><br><span class="line">        Binding binding = bindingConverter.convert(sofaReferenceAnnotation,</span><br><span class="line">            sofaReferenceAnnotation.binding(), bindingConverterContext);</span><br><span class="line">        reference.addBinding(binding);</span><br><span class="line">        <span class="comment">// 注册组件</span></span><br><span class="line">        <span class="keyword">return</span> ReferenceRegisterHelper.registerReference(reference, bindingAdapterFactory,</span><br><span class="line">            sofaRuntimeContext);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ReferenceRegisterHelper.java</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReferenceRegisterHelper</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">registerReference</span><span class="params">(Reference reference,</span></span></span><br><span class="line"><span class="function"><span class="params">                                           BindingAdapterFactory bindingAdapterFactory,</span></span></span><br><span class="line"><span class="function"><span class="params">                                           SofaRuntimeContext sofaRuntimeContext)</span> </span>&#123;</span><br><span class="line">        Binding binding = (Binding) reference.getBindings().toArray()[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!binding.getBindingType().equals(JvmBinding.JVM_BINDING_TYPE)</span><br><span class="line">            &amp;&amp; !SofaRuntimeProperties.isDisableJvmFirst(sofaRuntimeContext)</span><br><span class="line">            &amp;&amp; reference.isJvmFirst()) &#123;</span><br><span class="line">            <span class="comment">// as rpc invocation would be serialized, so here would Not ignore serialized</span></span><br><span class="line">            reference.addBinding(<span class="keyword">new</span> JvmBinding());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ComponentManager componentManager = sofaRuntimeContext.getComponentManager();</span><br><span class="line">        ReferenceComponent referenceComponent = <span class="keyword">new</span> ReferenceComponent(reference,</span><br><span class="line">            <span class="keyword">new</span> DefaultImplementation(), bindingAdapterFactory, sofaRuntimeContext);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (componentManager.isRegistered(referenceComponent.getName())) &#123;</span><br><span class="line">            <span class="keyword">return</span> componentManager.getComponentInfo(referenceComponent.getName())</span><br><span class="line">                .getImplementation().getTarget();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 注册组件并获取返回的组件信息，参考下文</span></span><br><span class="line">        ComponentInfo componentInfo = componentManager.registerAndGet(referenceComponent);</span><br><span class="line">        <span class="keyword">return</span> componentInfo.getImplementation().getTarget();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="ServiceBeanFactoryPostProcessor为例"><a href="#ServiceBeanFactoryPostProcessor为例" class="headerlink" title="ServiceBeanFactoryPostProcessor为例"></a>ServiceBeanFactoryPostProcessor为例</h5><ul><li>ServiceBeanFactoryPostProcessor.java 修改(Component)Bean的定义</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceBeanFactoryPostProcessor</span> <span class="keyword">implements</span> <span class="title">BeanFactoryPostProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        Arrays.stream(beanFactory.getBeanDefinitionNames())</span><br><span class="line">            .collect(Collectors.toMap(Function.identity(), beanFactory::getBeanDefinition))</span><br><span class="line">            <span class="comment">// 循环所有的bean定义配置，transformSofaBeanDefinition最终会调用到 generateSofaServiceDefinitionOnClass</span></span><br><span class="line">            .forEach((key, value) -&gt; transformSofaBeanDefinition(key, value, beanFactory));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">generateSofaServiceDefinitionOnClass</span><span class="params">(String beanId, Class&lt;?&gt; beanClass,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                      BeanDefinition beanDefinition,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                      ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 获取有 SofaService 注解的类</span></span><br><span class="line">        SofaService sofaServiceAnnotation = beanClass.getAnnotation(SofaService.class);</span><br><span class="line">        generateSofaServiceDefinition(beanId, sofaServiceAnnotation, beanClass, beanDefinition,</span><br><span class="line">            beanFactory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">generateSofaServiceDefinition</span><span class="params">(String beanId, SofaService sofaServiceAnnotation,</span></span></span><br><span class="line"><span class="function"><span class="params">                                               Class&lt;?&gt; beanClass, BeanDefinition beanDefinition,</span></span></span><br><span class="line"><span class="function"><span class="params">                                               ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (sofaServiceAnnotation == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 生成 SofaService 定义对象</span></span><br><span class="line">        AnnotationWrapperBuilder&lt;SofaService&gt; wrapperBuilder = AnnotationWrapperBuilder.wrap(</span><br><span class="line">            sofaServiceAnnotation).withBinder(binder);</span><br><span class="line">        sofaServiceAnnotation = wrapperBuilder.build();</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; interfaceType = sofaServiceAnnotation.interfaceType();</span><br><span class="line">        <span class="keyword">if</span> (interfaceType.equals(<span class="keyword">void</span>.class)) &#123;</span><br><span class="line">            Class&lt;?&gt; interfaces[] = beanClass.getInterfaces();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (beanClass.isInterface() || interfaces == <span class="keyword">null</span> || interfaces.length == <span class="number">0</span>) &#123;</span><br><span class="line">                interfaceType = beanClass;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (interfaces.length == <span class="number">1</span>) &#123;</span><br><span class="line">                interfaceType = interfaces[<span class="number">0</span>];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> FatalBeanException(<span class="string">"Bean "</span> + beanId + <span class="string">" has more than one interface."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        BeanDefinitionBuilder builder = BeanDefinitionBuilder.genericBeanDefinition();</span><br><span class="line">        String serviceId = SofaBeanNameGenerator.generateSofaServiceBeanName(interfaceType,</span><br><span class="line">            sofaServiceAnnotation.uniqueId());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 在Bean实例化之前，修改Bean的定义</span></span><br><span class="line">        <span class="keyword">if</span> (!beanFactory.containsBeanDefinition(serviceId)) &#123;</span><br><span class="line">            builder.getRawBeanDefinition().setScope(beanDefinition.getScope());</span><br><span class="line">            builder.setLazyInit(beanDefinition.isLazyInit());</span><br><span class="line">            builder.getRawBeanDefinition().setBeanClass(ServiceFactoryBean.class);</span><br><span class="line">            builder.addPropertyValue(AbstractContractDefinitionParser.INTERFACE_CLASS_PROPERTY,</span><br><span class="line">                interfaceType);</span><br><span class="line">            builder.addPropertyValue(AbstractContractDefinitionParser.UNIQUE_ID_PROPERTY,</span><br><span class="line">                sofaServiceAnnotation.uniqueId());</span><br><span class="line">            builder.addPropertyValue(AbstractContractDefinitionParser.BINDINGS,</span><br><span class="line">                getSofaServiceBinding(sofaServiceAnnotation, sofaServiceAnnotation.bindings()));</span><br><span class="line">            builder.addPropertyReference(ServiceDefinitionParser.REF, beanId);</span><br><span class="line">            builder.addPropertyValue(ServiceDefinitionParser.BEAN_ID, beanId);</span><br><span class="line">            builder.addPropertyValue(AbstractContractDefinitionParser.DEFINITION_BUILDING_API_TYPE,</span><br><span class="line">                <span class="keyword">true</span>);</span><br><span class="line">            builder.addDependsOn(beanId);</span><br><span class="line">            ((BeanDefinitionRegistry) beanFactory).registerBeanDefinition(serviceId,</span><br><span class="line">                builder.getBeanDefinition());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            SofaLogger.error(<span class="string">"SofaService was already registered: &#123;0&#125;"</span>, serviceId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>AbstractContractFactoryBean.java 触发Component注册</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractContractFactoryBean</span> <span class="keyword">implements</span> <span class="title">InitializingBean</span>, <span class="title">FactoryBean</span>,</span></span><br><span class="line"><span class="class">                                                 <span class="title">ApplicationContextAware</span> </span>&#123;</span><br><span class="line">    <span class="comment">// org.springframework.beans.factory.InitializingBean                 </span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        List&lt;Element&gt; tempElements = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (elements != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (TypedStringValue element : elements) &#123;</span><br><span class="line">                DocumentBuilderFactory documentBuilderFactory = DocumentBuilderFactory</span><br><span class="line">                    .newInstance();</span><br><span class="line">                documentBuilderFactory.setNamespaceAware(<span class="keyword">true</span>);</span><br><span class="line">                InputSource inputSource = <span class="keyword">new</span> InputSource(<span class="keyword">new</span> ByteArrayInputStream(element</span><br><span class="line">                    .getValue().getBytes()));</span><br><span class="line">                inputSource.setEncoding(documentEncoding);</span><br><span class="line">                Element node = documentBuilderFactory.newDocumentBuilder().parse(inputSource)</span><br><span class="line">                    .getDocumentElement();</span><br><span class="line">                tempElements.add(node);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        sofaRuntimeContext = applicationContext.getBean(</span><br><span class="line">            SofaRuntimeFrameworkConstants.SOFA_RUNTIME_CONTEXT_BEAN_ID, SofaRuntimeContext.class);</span><br><span class="line">        bindingConverterFactory = getBindingConverterFactory();</span><br><span class="line">        bindingAdapterFactory = getBindingAdapterFactory();</span><br><span class="line">        <span class="keyword">if</span> (!apiType) &#123;</span><br><span class="line">            <span class="keyword">this</span>.bindings = parseBindings(tempElements, applicationContext, isInBinding());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 执行bean创建完后的操作</span></span><br><span class="line">        doAfterPropertiesSet();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ServiceFactoryBean.java<ul><li>同理还有ReferenceFactoryBean</li></ul></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceFactoryBean</span> <span class="keyword">extends</span> <span class="title">AbstractContractFactoryBean</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doAfterPropertiesSet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!apiType &amp;&amp; hasSofaServiceAnnotation()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ServiceRuntimeException(</span><br><span class="line">                <span class="string">"Bean "</span> + beanId + <span class="string">" of type "</span> + ref.getClass()</span><br><span class="line">                        + <span class="string">" has already annotated by @SofaService,"</span></span><br><span class="line">                        + <span class="string">" can not be registered using xml. Please check it."</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Implementation implementation = <span class="keyword">new</span> DefaultImplementation();</span><br><span class="line">        implementation.setTarget(ref);</span><br><span class="line">        service = buildService();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// default add jvm binding and service jvm binding should set serialize as true</span></span><br><span class="line">        <span class="keyword">if</span> (bindings.size() == <span class="number">0</span>) &#123;</span><br><span class="line">            JvmBinding jvmBinding = <span class="keyword">new</span> JvmBinding();</span><br><span class="line">            JvmBindingParam jvmBindingParam = <span class="keyword">new</span> JvmBindingParam().setSerialize(<span class="keyword">true</span>);</span><br><span class="line">            bindings.add(<span class="keyword">new</span> JvmBinding().setJvmBindingParam(jvmBindingParam));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Binding binding : bindings) &#123;</span><br><span class="line">            service.addBinding(binding);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ComponentInfo componentInfo = <span class="keyword">new</span> ServiceComponent(implementation, service,</span><br><span class="line">            bindingAdapterFactory, sofaRuntimeContext);</span><br><span class="line">        <span class="comment">// 注册Component，参考下文 ComponentManagerImpl</span></span><br><span class="line">        sofaRuntimeContext.getComponentManager().register(componentInfo);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="组件即其生命周期"><a href="#组件即其生命周期" class="headerlink" title="组件即其生命周期"></a>组件即其生命周期</h4><ul><li>Component接口，组件级别，可以理解为一个服务类相关信息<ul><li>方法：register、unregister、resolve、unresolve、activate、deactivate、exception</li><li>子接口：ComponentInfo，主要需要提供getType、getName等功能</li><li>抽象类：AbstractComponent，主要是实现 ComponentInfo，减少代码量</li><li>对应实现如：SpringContextComponent(类型为Spring)、ServiceComponent(类型为service)、ReferenceComponent(类型为reference)</li></ul></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * SOFA Component Lifecycle:</span></span><br><span class="line"><span class="comment"> * &lt;pre&gt;</span></span><br><span class="line"><span class="comment"> *                  [UNREGISTERED]</span></span><br><span class="line"><span class="comment"> *                      |   ▲</span></span><br><span class="line"><span class="comment"> *           register   │   │   unregister</span></span><br><span class="line"><span class="comment"> *                      |   |</span></span><br><span class="line"><span class="comment"> *                   [REGISTERED]</span></span><br><span class="line"><span class="comment"> *                      |   ▲</span></span><br><span class="line"><span class="comment"> *           resolve    │   │   unresolve</span></span><br><span class="line"><span class="comment"> *                      |   |</span></span><br><span class="line"><span class="comment"> *                    [RESOLVED]</span></span><br><span class="line"><span class="comment"> *                      |   ▲</span></span><br><span class="line"><span class="comment"> *                 ┌────┘   └────┐</span></span><br><span class="line"><span class="comment"> *                 │             │</span></span><br><span class="line"><span class="comment"> *        activate |             ▲ deactivate</span></span><br><span class="line"><span class="comment"> *                 │             │</span></span><br><span class="line"><span class="comment"> *                 └───┐    ┌────┘</span></span><br><span class="line"><span class="comment"> *                          |</span></span><br><span class="line"><span class="comment"> *                   [ACTIVATED]</span></span><br><span class="line"><span class="comment"> * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>ComponentManagerImpl</code> 组件管理者(基于组件类维度)</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ComponentManagerImpl</span> <span class="keyword">implements</span> <span class="title">ComponentManager</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> ConcurrentMap&lt;ComponentName, ComponentInfo&gt; registry;</span><br><span class="line">    <span class="keyword">protected</span> ConcurrentMap&lt;ComponentType, Map&lt;ComponentName, ComponentInfo&gt;&gt; resolvedRegistry;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册组件</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ComponentInfo <span class="title">registerAndGet</span><span class="params">(ComponentInfo componentInfo)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> doRegister(componentInfo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行组件注册</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ComponentInfo <span class="title">doRegister</span><span class="params">(ComponentInfo ci)</span> </span>&#123;</span><br><span class="line">        ComponentName name = ci.getName();</span><br><span class="line">        <span class="keyword">if</span> (isRegistered(name)) &#123;</span><br><span class="line">            SofaLogger.error(<span class="string">"Component was already registered: &#123;&#125;"</span>, name);</span><br><span class="line">            <span class="keyword">if</span> (ci.canBeDuplicate()) &#123;</span><br><span class="line">                <span class="keyword">return</span> getComponentInfo(name);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ServiceRuntimeException(<span class="string">"Component can not be registered duplicated: "</span> + name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 设置 componentStatus = ComponentStatus.REGISTERED 为已注册</span></span><br><span class="line">            ci.register();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            SofaLogger.error(<span class="string">"Failed to register component: &#123;&#125;"</span>, ci.getName(), t);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Registering component: reference:com.alipay.sofa.isle.sample.SampleJvmService:#2120635923</span></span><br><span class="line">        <span class="comment">// Registering component: service:com.alipay.sofa.isle.sample.SampleJvmService</span></span><br><span class="line">        <span class="comment">// Registering component: Spring:cn.aezo.sqbiz.sqbiz-plugin.service-provider</span></span><br><span class="line">        SofaLogger.info(<span class="string">"Registering component: &#123;&#125;"</span>, ci.getName());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 将组件缓存到 registry 集合中</span></span><br><span class="line">            ComponentInfo old = registry.putIfAbsent(ci.getName(), ci);</span><br><span class="line">            <span class="keyword">if</span> (old != <span class="keyword">null</span>) &#123;</span><br><span class="line">                SofaLogger.error(<span class="string">"Component was already registered: &#123;&#125;"</span>, name);</span><br><span class="line">                <span class="keyword">if</span> (ci.canBeDuplicate()) &#123;</span><br><span class="line">                    <span class="keyword">return</span> old;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ServiceRuntimeException(<span class="string">"Component can not be registered duplicated: "</span></span><br><span class="line">                                                  + name);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ci.resolve()) &#123; <span class="comment">// 设置 componentStatus = ComponentStatus.RESOLVED 为已归纳</span></span><br><span class="line">                <span class="comment">// 按照 ComponentType 类型进行归纳，包含：service/reference/Spring等</span></span><br><span class="line">                typeRegistry(ci);</span><br><span class="line">                <span class="comment">// **执行激活组件方法，参考下文**</span></span><br><span class="line">                ci.activate();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            ci.exception(<span class="keyword">new</span> Exception(t));</span><br><span class="line">            SofaLogger.error(<span class="string">"Failed to create the component &#123;&#125;"</span>, ci.getName(), t);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ci;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 卸载</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unregister</span><span class="params">(ComponentInfo componentInfo)</span> <span class="keyword">throws</span> ServiceRuntimeException </span>&#123;</span><br><span class="line">        ComponentName componentName = componentInfo.getName();</span><br><span class="line">        registry.remove(componentName);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (componentName != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ComponentType componentType = componentName.getType();</span><br><span class="line"></span><br><span class="line">            Map&lt;ComponentName, ComponentInfo&gt; typesRi = resolvedRegistry.get(componentType);</span><br><span class="line">            typesRi.remove(componentName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        componentInfo.unregister();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 基于类型归纳组件信息</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">typeRegistry</span><span class="params">(ComponentInfo componentInfo)</span> </span>&#123;</span><br><span class="line">        ComponentName name = componentInfo.getName();</span><br><span class="line">        <span class="keyword">if</span> (name != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ComponentType type = name.getType();</span><br><span class="line">            Map&lt;ComponentName, ComponentInfo&gt; typesRi = resolvedRegistry.get(type);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (typesRi == <span class="keyword">null</span>) &#123;</span><br><span class="line">                resolvedRegistry.putIfAbsent(type, <span class="keyword">new</span> HashMap&lt;ComponentName, ComponentInfo&gt;());</span><br><span class="line">                typesRi = resolvedRegistry.get(type);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            typesRi.put(name, componentInfo);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="激活组件"><a href="#激活组件" class="headerlink" title="激活组件"></a>激活组件</h4><h5 id="ReferenceComponent为例"><a href="#ReferenceComponent为例" class="headerlink" title="ReferenceComponent为例"></a>ReferenceComponent为例</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReferenceComponent</span> <span class="keyword">extends</span> <span class="title">AbstractComponent</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">activate</span><span class="params">()</span> <span class="keyword">throws</span> ServiceRuntimeException </span>&#123;</span><br><span class="line">        <span class="comment">// 是否存在Binding，如：JvmBinding</span></span><br><span class="line">        <span class="keyword">if</span> (reference.hasBinding()) &#123;</span><br><span class="line">            Binding candidate = <span class="keyword">null</span>;</span><br><span class="line">            Set&lt;Binding&gt; bindings = reference.getBindings();</span><br><span class="line">            <span class="keyword">if</span> (bindings.size() == <span class="number">1</span>) &#123;</span><br><span class="line">                candidate = bindings.iterator().next();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (bindings.size() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                Object backupProxy = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">for</span> (Binding binding : bindings) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (JvmBinding.JVM_BINDING_TYPE.getType().equals(binding.getName())) &#123;</span><br><span class="line">                        candidate = binding;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// Under normal RPC reference (local-first/jvm-first is not set to false) binding,</span></span><br><span class="line">                        <span class="comment">// backup proxy is the RPC proxy, which will be invoked if Jvm service is not found</span></span><br><span class="line">                        backupProxy = createProxy(reference, binding);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (candidate != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    ((JvmBinding) candidate).setBackupProxy(backupProxy);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Object proxy = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (candidate != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 基于选择的Binding创建代理</span></span><br><span class="line">                proxy = createProxy(reference, candidate);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 实例化一个默认实现(类似一个包装类，最终是通过proxy调用)</span></span><br><span class="line">            <span class="keyword">this</span>.implementation = <span class="keyword">new</span> DefaultImplementation();</span><br><span class="line">            implementation.setTarget(proxy);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// componentStatus = ComponentStatus.ACTIVATED;</span></span><br><span class="line">        <span class="keyword">super</span>.activate();</span><br><span class="line">        latch.countDown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Object <span class="title">createProxy</span><span class="params">(Reference reference, Binding binding)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// JvmBindingAdapter</span></span><br><span class="line">        BindingAdapter&lt;Binding&gt; bindingAdapter = bindingAdapterFactory.getBindingAdapter(binding</span><br><span class="line">            .getBindingType());</span><br><span class="line">        <span class="keyword">if</span> (bindingAdapter == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ServiceRuntimeException(<span class="string">"Can't find BindingAdapter of type "</span></span><br><span class="line">                                              + binding.getBindingType() + <span class="string">" for reference "</span></span><br><span class="line">                                              + reference + <span class="string">"."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// &gt;&gt;In Binding [jvm] Begins - com.alipay.sofa.isle.sample.SampleJvmService.</span></span><br><span class="line">        SofaLogger.info(<span class="string">" &gt;&gt;In Binding [&#123;&#125;] Begins - &#123;&#125;."</span>, binding.getBindingType(), reference);</span><br><span class="line">        Object proxy;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 获取代理对象，参考下文</span></span><br><span class="line">            proxy = bindingAdapter.inBinding(reference, binding, sofaRuntimeContext);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// &gt;&gt;In Binding [jvm] Ends - com.alipay.sofa.isle.sample.SampleJvmService.</span></span><br><span class="line">            SofaLogger.info(<span class="string">" &gt;&gt;In Binding [&#123;&#125;] Ends - &#123;&#125;."</span>, binding.getBindingType(), reference);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> proxy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查当前组件的状态，在Biz启动完成后执行健康检查，Biz下所有组件检查通过则将Biz标记为actived</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HealthResult <span class="title">isHealthy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!isActivated()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.isHealthy();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        HealthResult result = <span class="keyword">new</span> HealthResult(componentName.getRawName());</span><br><span class="line">        List&lt;HealthResult&gt; bindingHealth = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        JvmBinding jvmBinding = <span class="keyword">null</span>;</span><br><span class="line">        HealthResult jvmBindingHealthResult = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (reference.hasBinding()) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Binding binding : reference.getBindings()) &#123;</span><br><span class="line">                bindingHealth.add(binding.healthCheck());</span><br><span class="line">                <span class="keyword">if</span> (JvmBinding.JVM_BINDING_TYPE.equals(binding.getBindingType())) &#123;</span><br><span class="line">                    jvmBinding = (JvmBinding) binding;</span><br><span class="line">                    jvmBindingHealthResult = bindingHealth.get(bindingHealth.size() - <span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// check reference has a corresponding service</span></span><br><span class="line">        <span class="comment">// 可通过 com.alipay.sofa.boot.skipJvmReferenceHealthCheck=true 设置为不检查组件的健康状态（如有些组件实现是通过ark动态安装进来的，就会出现Biz启动不成功的问题）</span></span><br><span class="line">        <span class="keyword">if</span> (!SofaRuntimeProperties.isSkipJvmReferenceHealthCheck(sofaRuntimeContext)</span><br><span class="line">            &amp;&amp; jvmBinding != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Object serviceTarget = getServiceTarget();</span><br><span class="line">            <span class="keyword">if</span> (serviceTarget == <span class="keyword">null</span> &amp;&amp; !jvmBinding.hasBackupProxy()) &#123;</span><br><span class="line">                jvmBindingHealthResult.setHealthy(<span class="keyword">false</span>);</span><br><span class="line">                jvmBindingHealthResult.setHealthReport(<span class="string">"can not find corresponding jvm service"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        List&lt;HealthResult&gt; failedBindingHealth = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (HealthResult healthResult : bindingHealth) &#123;</span><br><span class="line">            <span class="keyword">if</span> (healthResult != <span class="keyword">null</span> &amp;&amp; !healthResult.isHealthy()) &#123;</span><br><span class="line">                failedBindingHealth.add(healthResult);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (failedBindingHealth.size() == <span class="number">0</span>) &#123;</span><br><span class="line">            result.setHealthy(<span class="keyword">true</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            StringBuilder healthReport = <span class="keyword">new</span> StringBuilder(<span class="string">"|"</span>);</span><br><span class="line">            <span class="keyword">for</span> (HealthResult healthResult : failedBindingHealth) &#123;</span><br><span class="line">                healthReport.append(healthResult.getHealthName()).append(<span class="string">"#"</span>)</span><br><span class="line">                    .append(healthResult.getHealthReport());</span><br><span class="line">            &#125;</span><br><span class="line">            result.setHealthReport(healthReport.substring(<span class="number">1</span>, healthReport.length()));</span><br><span class="line">            result.setHealthy(<span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>JvmBindingAdapter.java</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JvmBindingAdapter</span> <span class="keyword">implements</span> <span class="title">BindingAdapter</span>&lt;<span class="title">JvmBinding</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实现 BindingAdapter 接口方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">inBinding</span><span class="params">(Object contract, JvmBinding binding,</span></span></span><br><span class="line"><span class="function"><span class="params">                            SofaRuntimeContext sofaRuntimeContext)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> createServiceProxy((Contract) contract, binding, sofaRuntimeContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Object <span class="title">createServiceProxy</span><span class="params">(Contract contract, JvmBinding binding,</span></span></span><br><span class="line"><span class="function"><span class="params">                                      SofaRuntimeContext sofaRuntimeContext)</span> </span>&#123;</span><br><span class="line">        ClassLoader newClassLoader;</span><br><span class="line">        <span class="comment">// 获取加载器，如：BizClassLoader(bizIdentity=Startup In IDE:Mock version)</span></span><br><span class="line">        ClassLoader appClassLoader = sofaRuntimeContext.getAppClassLoader();</span><br><span class="line">        Class&lt;?&gt; javaClass = contract.getInterfaceType();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class appLoadedClass = appClassLoader.loadClass(javaClass.getName());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (appLoadedClass == javaClass) &#123;</span><br><span class="line">                newClassLoader = appClassLoader;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                newClassLoader = javaClass.getClassLoader();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            newClassLoader = javaClass.getClassLoader();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ClassLoader oldClassLoader = Thread.currentThread().getContextClassLoader();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.currentThread().setContextClassLoader(newClassLoader);</span><br><span class="line">            <span class="comment">// 实例化 JvmServiceInvoker，通过此对象调用服务</span></span><br><span class="line">            ServiceProxy handler = <span class="keyword">new</span> JvmServiceInvoker(contract, binding, sofaRuntimeContext);</span><br><span class="line">            ProxyFactory factory = <span class="keyword">new</span> ProxyFactory();</span><br><span class="line">            <span class="keyword">if</span> (javaClass.isInterface()) &#123;</span><br><span class="line">                factory.addInterface(javaClass);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                factory.setTargetClass(javaClass);</span><br><span class="line">                factory.setProxyTargetClass(<span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            factory.addAdvice(handler);</span><br><span class="line">            <span class="comment">// 返回代理对象</span></span><br><span class="line">            <span class="keyword">return</span> factory.getProxy(newClassLoader);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Thread.currentThread().setContextClassLoader(oldClassLoader);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ***执行组件服务调用，即找到对应的 @SofaService 声明的服务***</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">JvmServiceInvoker</span> <span class="keyword">extends</span> <span class="title">ServiceProxy</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(MethodInvocation invocation)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (!SofaRuntimeProperties.isJvmFilterEnable()) &#123;</span><br><span class="line">                <span class="comment">// Jvm filtering is not enabled</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">super</span>.invoke(invocation);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ClassLoader oldClassLoader = Thread.currentThread().getContextClassLoader();</span><br><span class="line">            JvmFilterContext context = <span class="keyword">new</span> JvmFilterContext(invocation);</span><br><span class="line">            Object rtn;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (getTarget() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 获取目标服务（实现类）</span></span><br><span class="line">                ServiceComponent serviceComponent = DynamicJvmServiceProxyFinder</span><br><span class="line">                    .getDynamicJvmServiceProxyFinder().findServiceComponent(</span><br><span class="line">                        sofaRuntimeContext.getAppClassLoader(), contract);</span><br><span class="line">                <span class="keyword">if</span> (serviceComponent == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// Jvm service is not found in normal or Ark environment</span></span><br><span class="line">                    <span class="comment">// We're actually invoking an RPC service, skip Jvm filtering</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">super</span>.invoke(invocation);</span><br><span class="line">                &#125;</span><br><span class="line">                context.setSofaRuntimeContext(serviceComponent.getContext());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                context.setSofaRuntimeContext(sofaRuntimeContext);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">long</span> startTime = System.currentTimeMillis();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.currentThread().setContextClassLoader(serviceClassLoader);</span><br><span class="line">                <span class="comment">// Do Jvm filter &lt;code&gt;before&lt;/code&gt; invoking</span></span><br><span class="line">                <span class="comment">// if some filter returns false, skip remaining filters and actual Jvm invoking</span></span><br><span class="line">                <span class="keyword">if</span> (JvmFilterHolder.beforeInvoking(context)) &#123;</span><br><span class="line">                    rtn = doInvoke(invocation);</span><br><span class="line">                    context.setInvokeResult(rtn);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                <span class="comment">// Exception occurs, set &lt;code&gt;e&lt;/code&gt; in Jvm context</span></span><br><span class="line">                context.setException(e);</span><br><span class="line">                doCatch(invocation, e, startTime);</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// Do Jvm Filter &lt;code&gt;after&lt;/code&gt; invoking regardless of the fact whether exception happens or not</span></span><br><span class="line">                JvmFilterHolder.afterInvoking(context);</span><br><span class="line">                rtn = context.getInvokeResult();</span><br><span class="line">                doFinally(invocation, startTime);</span><br><span class="line">                Thread.currentThread().setContextClassLoader(oldClassLoader);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> rtn;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">doInvoke</span><span class="params">(MethodInvocation invocation)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (binding.isDestroyed()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Can not call destroyed reference! JVM Reference["</span></span><br><span class="line">                                                + getInterfaceName() + <span class="string">"#"</span> + getUniqueId()</span><br><span class="line">                                                + <span class="string">"] has already been destroyed."</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            SofaLogger.debug(<span class="string">"&gt;&gt; Start in JVM service invoke, the service interface is  - &#123;&#125;"</span>,</span><br><span class="line">                getInterfaceName());</span><br><span class="line"></span><br><span class="line">            Object retVal;</span><br><span class="line">            Object targetObj = <span class="keyword">this</span>.getTarget();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// invoke internal dynamic-biz jvm service</span></span><br><span class="line">            <span class="keyword">if</span> (targetObj == <span class="keyword">null</span>) &#123;</span><br><span class="line">                ServiceProxy serviceProxy = DynamicJvmServiceProxyFinder</span><br><span class="line">                    .getDynamicJvmServiceProxyFinder().findServiceProxy(</span><br><span class="line">                        sofaRuntimeContext.getAppClassLoader(), contract);</span><br><span class="line">                <span class="keyword">if</span> (serviceProxy != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> serviceProxy.invoke(invocation);</span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        SofaLogger.debug(</span><br><span class="line">                            <span class="string">"&lt;&lt; Finish Cross App JVM service invoke, the service is  - &#123;&#125;]"</span>,</span><br><span class="line">                            (getInterfaceName() + <span class="string">"#"</span> + getUniqueId()));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (targetObj == <span class="keyword">null</span> || ((targetObj <span class="keyword">instanceof</span> Proxy) &amp;&amp; binding.hasBackupProxy())) &#123;</span><br><span class="line">                targetObj = binding.getBackupProxy();</span><br><span class="line">                SofaLogger.debug(<span class="string">"&lt;&lt;&#123;&#125;.&#123;&#125; backup proxy invoke."</span>, getInterfaceName().getName(),</span><br><span class="line">                    invocation.getMethod().getName());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (targetObj == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">                    <span class="string">"JVM Reference["</span></span><br><span class="line">                            + getInterfaceName()</span><br><span class="line">                            + <span class="string">"#"</span></span><br><span class="line">                            + getUniqueId()</span><br><span class="line">                            + <span class="string">"] can not find the corresponding JVM service. "</span></span><br><span class="line">                            + <span class="string">"Please check if there is a SOFA deployment publish the corresponding JVM service. "</span></span><br><span class="line">                            + <span class="string">"If this exception occurred when the application starts up, please add Require-Module to SOFA deployment's MANIFEST.MF to indicate the startup dependency of SOFA modules."</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ClassLoader tcl = Thread.currentThread().getContextClassLoader();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                pushThreadContextClassLoader(sofaRuntimeContext.getAppClassLoader());</span><br><span class="line">                retVal = invocation.getMethod().invoke(targetObj, invocation.getArguments());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InvocationTargetException ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> ex.getTargetException();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                SofaLogger.debug(</span><br><span class="line">                    <span class="string">"&lt;&lt; Finish JVM service invoke, the service implementation is  - &#123;&#125;]"</span>,</span><br><span class="line">                    (<span class="keyword">this</span>.target == <span class="keyword">null</span> ? <span class="string">"null"</span> : <span class="keyword">this</span>.target.getClass().getName()));</span><br><span class="line"></span><br><span class="line">                popThreadContextClassLoader(tcl);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> retVal;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="ServiceComponent为例"><a href="#ServiceComponent为例" class="headerlink" title="ServiceComponent为例"></a>ServiceComponent为例</h5><ul><li>初始化模块的时候会调用，参考下文<a href="#并行刷新SpringContext">并行刷新SpringContext</a></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceComponent</span> <span class="keyword">extends</span> <span class="title">AbstractComponent</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">resolve</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        resolveBinding();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.resolve();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">resolveBinding</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Object target = service.getTarget();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (target == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ServiceRuntimeException(</span><br><span class="line">                <span class="string">"Must contains the target object whiling registering Service."</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (service.hasBinding()) &#123;</span><br><span class="line">            Set&lt;Binding&gt; bindings = service.getBindings();</span><br><span class="line">            <span class="keyword">boolean</span> allPassed = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">for</span> (Binding binding : bindings) &#123;</span><br><span class="line">                BindingAdapter&lt;Binding&gt; bindingAdapter = <span class="keyword">this</span>.bindingAdapterFactory</span><br><span class="line">                    .getBindingAdapter(binding.getBindingType());</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (bindingAdapter == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> ServiceRuntimeException(<span class="string">"Can't find BindingAdapter of type "</span></span><br><span class="line">                                                      + binding.getBindingType()</span><br><span class="line">                                                      + <span class="string">" while registering service "</span> + service</span><br><span class="line">                                                      + <span class="string">"."</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// &lt;&lt;PreOut Binding [jvm] Begins - com.alipay.sofa.isle.sample.SampleJvmService.</span></span><br><span class="line">                SofaLogger.info(<span class="string">" &lt;&lt;PreOut Binding [&#123;&#125;] Begins - &#123;&#125;."</span>, binding.getBindingType(),</span><br><span class="line">                    service);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    bindingAdapter.preOutBinding(service, binding, target, getContext());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                    allPassed = <span class="keyword">false</span>;</span><br><span class="line">                    SofaLogger.error(<span class="string">" &lt;&lt;PreOut Binding [&#123;&#125;] for [&#123;&#125;] occur exception."</span>,</span><br><span class="line">                        binding.getBindingType(), service, t);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// &lt;&lt;PreOut Binding [jvm] Ends - com.alipay.sofa.isle.sample.SampleJvmService.</span></span><br><span class="line">                SofaLogger.info(<span class="string">" &lt;&lt;PreOut Binding [&#123;&#125;] Ends - &#123;&#125;."</span>, binding.getBindingType(),</span><br><span class="line">                    service);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!allPassed) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ServiceRuntimeException(<span class="string">" &lt;&lt;PreOut Binding ["</span> + service</span><br><span class="line">                                                  + <span class="string">"] occur exception."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">activate</span><span class="params">()</span> <span class="keyword">throws</span> ServiceRuntimeException </span>&#123;</span><br><span class="line">        activateBinding();</span><br><span class="line">        <span class="keyword">super</span>.activate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">activateBinding</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Object target = service.getTarget();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (target == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ServiceRuntimeException(</span><br><span class="line">                <span class="string">"Must contains the target object whiling registering Service."</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (service.hasBinding()) &#123;</span><br><span class="line">            <span class="keyword">boolean</span> allPassed = <span class="keyword">true</span>;</span><br><span class="line">            Set&lt;Binding&gt; bindings = service.getBindings();</span><br><span class="line">            <span class="keyword">for</span> (Binding binding : bindings) &#123;</span><br><span class="line">                BindingAdapter&lt;Binding&gt; bindingAdapter = <span class="keyword">this</span>.bindingAdapterFactory</span><br><span class="line">                    .getBindingAdapter(binding.getBindingType());</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (bindingAdapter == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> ServiceRuntimeException(<span class="string">"Can't find BindingAdapter of type "</span></span><br><span class="line">                                                      + binding.getBindingType()</span><br><span class="line">                                                      + <span class="string">" while registering service "</span> + service</span><br><span class="line">                                                      + <span class="string">"."</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                Object outBindingResult;</span><br><span class="line">                <span class="comment">// &lt;&lt;Out Binding [jvm] Begins - com.alipay.sofa.isle.sample.SampleJvmService.</span></span><br><span class="line">                SofaLogger.info(<span class="string">" &lt;&lt;Out Binding [&#123;&#125;] Begins - &#123;&#125;."</span>, binding.getBindingType(),</span><br><span class="line">                    service);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    outBindingResult = bindingAdapter.outBinding(service, binding, target,</span><br><span class="line">                        getContext());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                    allPassed = <span class="keyword">false</span>;</span><br><span class="line">                    binding.setHealthy(<span class="keyword">false</span>);</span><br><span class="line">                    SofaLogger.error(<span class="string">" &lt;&lt;Out binding [&#123;&#125;] for [&#123;&#125;] occur exception."</span>,</span><br><span class="line">                        binding.getBindingType(), service, t);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!Boolean.FALSE.equals(outBindingResult)) &#123;</span><br><span class="line">                    <span class="comment">// &lt;&lt;Out Binding [jvm] Ends - com.alipay.sofa.isle.sample.SampleJvmService.</span></span><br><span class="line">                    SofaLogger.info(<span class="string">" &lt;&lt;Out Binding [&#123;&#125;] Ends - &#123;&#125;."</span>, binding.getBindingType(),</span><br><span class="line">                        service);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    binding.setHealthy(<span class="keyword">false</span>);</span><br><span class="line">                    SofaLogger.info(<span class="string">" &lt;&lt;Out Binding [&#123;&#125;] Fails, Don't publish service - &#123;&#125;."</span>,</span><br><span class="line">                        binding.getBindingType(), service);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!allPassed) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ServiceRuntimeException(<span class="string">" &lt;&lt;Out Binding ["</span> + service</span><br><span class="line">                                                  + <span class="string">"] occur exception."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Register Service - com.alipay.sofa.isle.sample.SampleJvmService</span></span><br><span class="line">        SofaLogger.info(<span class="string">"Register Service - &#123;&#125;"</span>, service);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="SpringContextComponent为例"><a href="#SpringContextComponent为例" class="headerlink" title="SpringContextComponent为例"></a>SpringContextComponent为例</h5><ul><li>sofa v3.6.0才有</li><li>初始化模块的时候会调用，参考下文<a href="#并行刷新SpringContext">并行刷新SpringContext</a></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringContextComponent</span> <span class="keyword">extends</span> <span class="title">AbstractComponent</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 可知，只是改了状态，没做过多操作</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">activate</span><span class="params">()</span> <span class="keyword">throws</span> ServiceRuntimeException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (componentStatus != ComponentStatus.RESOLVED) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        componentStatus = ComponentStatus.ACTIVATED;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="扩展点初始化"><a href="#扩展点初始化" class="headerlink" title="扩展点初始化"></a>扩展点初始化</h3><ul><li>入口</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AbstractExtFactoryBean =&gt; CommonContextBean -&gt; InitializingBean</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExtensionPointFactoryBean</span> <span class="keyword">extends</span> <span class="title">AbstractExtFactoryBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Spring会调用</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// targetBeanName: 扩展点所作用在的 bean 的名字</span></span><br><span class="line">        <span class="comment">// determine serviceClass (can still be null if using a FactoryBean</span></span><br><span class="line">        <span class="comment">// which doesn't declare its product type)</span></span><br><span class="line">        Class&lt;?&gt; extensionPointClass = (target != <span class="keyword">null</span> ? target.getClass() : beanFactory</span><br><span class="line">            .getType(targetBeanName));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1.发布扩展点</span></span><br><span class="line">            publishAsNuxeoExtensionPoint(extensionPointClass);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            SofaLogger.error(e, <span class="string">"Failed to publish extension point."</span>);</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1.</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">publishAsNuxeoExtensionPoint</span><span class="params">(Class&lt;?&gt; beanClass)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Assert.notNull(beanClass, <span class="string">"Service must be implement!"</span>);</span><br><span class="line"></span><br><span class="line">        ExtensionPointBuilder extensionPointBuilder = ExtensionPointBuilder.genericExtensionPoint(</span><br><span class="line">            <span class="keyword">this</span>.name, applicationContext.getClassLoader());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">        Implementation implementation = <span class="keyword">new</span> SpringImplementationImpl(targetBeanName,</span><br><span class="line">            applicationContext);</span><br><span class="line">        ComponentInfo extensionPointComponent = <span class="keyword">new</span> ExtensionPointComponent(</span><br><span class="line">            extensionPointBuilder.getExtensionPoint(), sofaRuntimeContext, implementation);</span><br><span class="line">        <span class="comment">// 2.注册扩展到，参考 ComponentManagerImpl (类似SofaReference等注册)</span></span><br><span class="line">        sofaRuntimeContext.getComponentManager().register(extensionPointComponent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="sofa-boot-autoconfigure"><a href="#sofa-boot-autoconfigure" class="headerlink" title="sofa-boot-autoconfigure"></a>sofa-boot-autoconfigure</h2><ul><li>spring.factories</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\</span><br><span class="line">  com.alipay.sofa.boot.autoconfigure.runtime.SofaRuntimeAutoConfiguration,\</span><br><span class="line">  com.alipay.sofa.boot.autoconfigure.isle.SofaModuleAutoConfiguration,\</span><br><span class="line">  com.alipay.sofa.boot.autoconfigure.rpc.SofaRpcAutoConfiguration,\</span><br><span class="line">  com.alipay.sofa.boot.autoconfigure.tracer.OpenTracingSpringMvcAutoConfiguration,\</span><br><span class="line">  com.alipay.sofa.boot.autoconfigure.tracer.SofaTracerAutoConfiguration,\</span><br><span class="line">  com.alipay.sofa.boot.autoconfigure.tracer.SofaTracerDataSourceAutoConfiguration,\</span><br><span class="line">  com.alipay.sofa.boot.autoconfigure.tracer.SofaTracerFeignClientAutoConfiguration,\</span><br><span class="line">  com.alipay.sofa.boot.autoconfigure.tracer.ZipkinSofaTracerAutoConfiguration,\</span><br><span class="line">  com.alipay.sofa.boot.autoconfigure.tracer.SofaTracerRestTemplateAutoConfiguration,\</span><br><span class="line">  com.alipay.sofa.boot.autoconfigure.tracer.TracerAnnotationAutoConfiguration,\</span><br><span class="line">  com.alipay.sofa.boot.autoconfigure.startup.SofaStartupAutoConfiguration,\</span><br><span class="line">  com.alipay.sofa.boot.autoconfigure.startup.SofaStartupIsleAutoConfiguration</span><br></pre></td></tr></table></figure><ul><li>SofaModuleAutoConfiguration.java</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties</span>(SofaModuleProperties.class)</span><br><span class="line"><span class="meta">@ConditionalOnClass</span>(ApplicationRuntimeModel.class)</span><br><span class="line"><span class="meta">@ConditionalOnProperty</span>(value = <span class="string">"com.alipay.sofa.boot.enable-isle"</span>, matchIfMissing = <span class="keyword">true</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SofaModuleAutoConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 参考上文[Spring启动完成后广播事件](#Spring启动完成后广播事件)</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SofaModuleContextRefreshedListener <span class="title">sofaModuleContextRefreshedListener</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SofaModuleContextRefreshedListener();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModelCreatingStage <span class="title">modelCreatingStage</span><span class="params">(ApplicationContext applicationContext)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ModelCreatingStage((AbstractApplicationContext) applicationContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 参考上文[SpringContextInstallStage为例](#SpringContextInstallStage为例)</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SpringContextInstallStage <span class="title">springContextInstallStage</span><span class="params">(ApplicationContext applicationContext)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SpringContextInstallStage((AbstractApplicationContext) applicationContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModuleLogOutputStage <span class="title">moduleLogOutputStage</span><span class="params">(ApplicationContext applicationContext)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ModuleLogOutputStage((AbstractApplicationContext) applicationContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实例化DefaultPipelineContext，参考上文[处理pipeline流水线](#处理pipeline流水线)</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PipelineContext <span class="title">pipelineContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DefaultPipelineContext();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Ark容器启动流程"><a href="#Ark容器启动流程" class="headerlink" title="Ark容器启动流程"></a>Ark容器启动流程</h2><ul><li>参考：<a href="https://www.sofastack.tech/projects/sofa-boot/sofa-ark-startup/" target="_blank" rel="noopener">https://www.sofastack.tech/projects/sofa-boot/sofa-ark-startup/</a></li><li><p>流程图</p><p> <img src="/data/images/java/sofa-ark.png" alt="sofa-ark.png"></p></li><li>SofaArk相关常量参考<code>com.alipay.sofa.ark.spi.constant.Constants</code></li></ul><h3 id="sofa-ark-support-starter"><a href="#sofa-ark-support-starter" class="headerlink" title="sofa-ark-support-starter"></a>sofa-ark-support-starter</h3><ul><li>启动Ark入口</li><li>ArkApplicationStartListener.java 监听类</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// spring.factories声明此类</span></span><br><span class="line"><span class="comment">// org.springframework.context.ApplicationListener=com.alipay.sofa.ark.springboot.listener.ArkApplicationStartListener</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArkApplicationStartListener</span> <span class="keyword">implements</span> <span class="title">ApplicationListener</span>&lt;<span class="title">SpringApplicationEvent</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(SpringApplicationEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// springboot 2.x 启动</span></span><br><span class="line">            <span class="keyword">if</span> (isSpringBoot2()</span><br><span class="line">                &amp;&amp; APPLICATION_STARTING_EVENT.equals(event.getClass().getCanonicalName())) &#123;</span><br><span class="line">                startUpArk(event);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (isSpringBoot1()</span><br><span class="line">                &amp;&amp; APPLICATION_STARTED_EVENT.equals(event.getClass().getCanonicalName())) &#123;</span><br><span class="line">                startUpArk(event);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Meet exception when determine whether to start SOFAArk!"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startUpArk</span><span class="params">(SpringApplicationEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (LAUNCH_CLASSLOADER_NAME.equals(<span class="keyword">this</span>.getClass().getClassLoader().getClass().getName())) &#123;</span><br><span class="line">            <span class="comment">// 执行 SofaArkBootstrap 启动</span></span><br><span class="line">            SofaArkBootstrap.launch(event.getArgs());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>SofaArkBootstrap.java</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SofaArkBootstrap</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String BIZ_CLASSLOADER = <span class="string">"com.alipay.sofa.ark.container.service.classloader.BizClassLoader"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String MAIN_ENTRY_NAME = <span class="string">"remain"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> EntryMethod  entryMethod;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">launch</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!isSofaArkStarted()) &#123;</span><br><span class="line">                entryMethod = <span class="keyword">new</span> EntryMethod(Thread.currentThread());</span><br><span class="line">                IsolatedThreadGroup threadGroup = <span class="keyword">new</span> IsolatedThreadGroup(</span><br><span class="line">                    entryMethod.getDeclaringClassName());</span><br><span class="line">                <span class="comment">// 下面launchThread线程会执行的任务</span></span><br><span class="line">                <span class="comment">// 传入参数：类名、方法名、参数。最终LaunchRunner#run中反射调用此方法(MAIN_ENTRY_NAME=remain)，即此类下文方法</span></span><br><span class="line">                LaunchRunner launchRunner = <span class="keyword">new</span> LaunchRunner(SofaArkBootstrap.class.getName(),</span><br><span class="line">                    MAIN_ENTRY_NAME, args);</span><br><span class="line">                Thread launchThread = <span class="keyword">new</span> Thread(threadGroup, launchRunner,</span><br><span class="line">                    entryMethod.getMethodName());</span><br><span class="line">                launchThread.start();</span><br><span class="line">                <span class="comment">// 等threadGroup执行完成时(执行launchThread的线程)，程序启动后阻塞在此处</span></span><br><span class="line">                LaunchRunner.join(threadGroup);</span><br><span class="line">                threadGroup.rethrowUncaughtException();</span><br><span class="line">                System.exit(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// LaunchRunner#run最终反射调用此方法</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">remain</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;<span class="comment">// NOPMD</span></span><br><span class="line">        AssertUtils.assertNotNull(entryMethod, <span class="string">"No Entry Method Found."</span>);</span><br><span class="line">        URL[] urls = getURLClassPath();</span><br><span class="line">        <span class="comment">// 执行 ClasspathLauncher#launch。传入参数 ClassPathArchive 记录了</span></span><br><span class="line">            <span class="comment">// urls：classpath下依赖的jar</span></span><br><span class="line">            <span class="comment">// arkConfBaseDir: 配置conf/ark/bootstrap.properties文件路径</span></span><br><span class="line">        <span class="comment">// 最终反射调用ArkContainer入口：ArkContainer.main 方法，见[sofa-ark-container](#sofa-ark-container)</span></span><br><span class="line">        <span class="keyword">new</span> ClasspathLauncher(<span class="keyword">new</span> ClassPathArchive(entryMethod.getDeclaringClassName(), entryMethod.getMethodName(), urls))</span><br><span class="line">            .launch(args, getClasspath(urls), entryMethod.getMethod());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="sofa-ark-container"><a href="#sofa-ark-container" class="headerlink" title="sofa-ark-container"></a>sofa-ark-container</h3><h4 id="ArkContainer"><a href="#ArkContainer" class="headerlink" title="ArkContainer"></a>ArkContainer</h4><ul><li><strong>ArkContainer.java</strong></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArkContainer</span> </span>&#123;</span><br><span class="line">    <span class="comment">// args中包含上文传入的3个参数</span></span><br><span class="line">    <span class="comment">// -Aclasspath=...</span></span><br><span class="line">    <span class="comment">// -BclassName=cn.aezo.sqbiz.SqBizApplication</span></span><br><span class="line">    <span class="comment">// -BmethodName=main</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ArkRuntimeException </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 解析参数</span></span><br><span class="line">            LaunchCommand launchCommand = LaunchCommand.parse(args);</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">            ClassPathArchive classPathArchive = <span class="keyword">new</span> ClassPathArchive(</span><br><span class="line">                launchCommand.getEntryClassName(), launchCommand.getEntryMethodName(),</span><br><span class="line">                launchCommand.getClasspath());</span><br><span class="line">            <span class="comment">// 创建Ark容器并启动</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ArkContainer(classPathArchive, launchCommand).start();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArkRuntimeException(String.format(<span class="string">"SOFAArk startup failed, commandline=%s"</span>,</span><br><span class="line">                LaunchCommand.toString(args)), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> ArkRuntimeException </span>&#123;</span><br><span class="line">        AssertUtils.assertNotNull(arkServiceContainer, <span class="string">"arkServiceContainer is null !"</span>);</span><br><span class="line">        <span class="keyword">if</span> (started.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">            Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    stop();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;));</span><br><span class="line">            <span class="comment">// 准备参数：将conf/ark/bootstrap.properties中的参数缓存到ArkConfigs.CFG中</span></span><br><span class="line">            prepareArkConfig();</span><br><span class="line">            <span class="comment">// 重新初始化ark日志. 获取配置优先级：System.getProperty &gt; ArkConfigs.CFG &gt; defaultValue</span></span><br><span class="line">            reInitializeArkLogger();</span><br><span class="line">            <span class="comment">// 启动 ArkServiceContainer (控制台会显示 SOFA-ARK-telnet-server-worker 的日志)</span></span><br><span class="line">            arkServiceContainer.start();</span><br><span class="line">            <span class="comment">// 初始化Pipeline，会返回 StandardPipeline</span></span><br><span class="line">            Pipeline pipeline = arkServiceContainer.getService(Pipeline.class);</span><br><span class="line">            <span class="comment">// 会依次执行Pipeline：</span></span><br><span class="line">                <span class="comment">// HandleArchiveStage   解析出Ark包</span></span><br><span class="line">                <span class="comment">// RegisterServiceStage 注册Ark包：只是将所有包下的服务都记录下来</span></span><br><span class="line">                <span class="comment">// ExtensionLoaderStage 扩展，参考 sofa-ark-spi</span></span><br><span class="line">                <span class="comment">// DeployPluginStage    启动所有的Ark插件</span></span><br><span class="line">                <span class="comment">// DeployBizStage       启动所有的Ark Biz(见下文)</span></span><br><span class="line">                    <span class="comment">// ArkTomcatWebServer.initialize 主程序和其他Biz程序启动</span></span><br><span class="line">                <span class="comment">// FinishStartupStage   启动完成事件</span></span><br><span class="line">            pipeline.process(pipelineContext);</span><br><span class="line">            <span class="comment">// Ark container started in xxx ms. 项目启动成功</span></span><br><span class="line">            System.out.println(<span class="string">"Ark container started in "</span> + (System.currentTimeMillis() - start) <span class="comment">//NOPMD</span></span><br><span class="line">                               + <span class="string">" ms."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="以DeployBizStage为例-执行Biz的main方法"><a href="#以DeployBizStage为例-执行Biz的main方法" class="headerlink" title="以DeployBizStage为例(执行Biz的main方法)"></a>以DeployBizStage为例(执行Biz的main方法)</h4><ul><li>DeployBizStage.java</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Singleton</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DeployBizStage</span> <span class="keyword">implements</span> <span class="title">PipelineStage</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    <span class="keyword">private</span> BizDeployService  bizDeployService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(PipelineContext pipelineContext)</span> <span class="keyword">throws</span> ArkRuntimeException </span>&#123;</span><br><span class="line">        String[] args = pipelineContext.getLaunchCommand().getLaunchArgs();</span><br><span class="line">        <span class="comment">// 启动</span></span><br><span class="line">        bizDeployService.deploy(args);</span><br><span class="line">        eventAdminService.sendEvent(<span class="keyword">new</span> AfterFinishDeployEvent());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>BizDeployServiceImpl.java</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deploy</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ArkRuntimeException </span>&#123;</span><br><span class="line">    ServiceReference&lt;BizDeployer&gt; serviceReference = registryService</span><br><span class="line">        .referenceService(BizDeployer.class);</span><br><span class="line">    <span class="comment">// DefaultBizDeployer</span></span><br><span class="line">    bizDeployer = serviceReference.getService();</span><br><span class="line"></span><br><span class="line">    LOGGER.info(String.format(<span class="string">"BizDeployer=\'%s\' is starting."</span>, bizDeployer.getDesc()));</span><br><span class="line"></span><br><span class="line">    bizDeployer.init(args);</span><br><span class="line">    <span class="comment">// 启动Biz</span></span><br><span class="line">    bizDeployer.deploy();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>DefaultBizDeployer.java</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deploy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 循环启动所有Biz,优先级可在maven中配置</span></span><br><span class="line">    <span class="keyword">for</span> (Biz biz : bizManagerService.getBizInOrder()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            LOGGER.info(String.format(<span class="string">"Begin to start biz: %s"</span>, biz.getBizName()));</span><br><span class="line">            <span class="comment">// 执行启动</span></span><br><span class="line">            biz.start(arguments);</span><br><span class="line">            LOGGER.info(String.format(<span class="string">"Finish to start biz: %s"</span>, biz.getBizName()));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            LOGGER.error(String.format(<span class="string">"Start biz: %s meet error"</span>, biz.getBizName()), e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArkRuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>BizModel.java</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BizModel</span> <span class="keyword">implements</span> <span class="title">Biz</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        AssertUtils.isTrue(bizState == BizState.RESOLVED, <span class="string">"BizState must be RESOLVED"</span>);</span><br><span class="line">        <span class="keyword">if</span> (mainClass == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArkRuntimeException(String.format(<span class="string">"biz: %s has no main method"</span>, getBizName()));</span><br><span class="line">        &#125;</span><br><span class="line">        ClassLoader oldClassLoader = ClassLoaderUtils.pushContextClassLoader(<span class="keyword">this</span>.classLoader);</span><br><span class="line">        EventAdminService eventAdminService = ArkServiceContainerHolder.getContainer().getService(</span><br><span class="line">            EventAdminService.class);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 触发Biz启动前事件，可自定义进行监听</span></span><br><span class="line">            eventAdminService.sendEvent(<span class="keyword">new</span> BeforeBizStartupEvent(<span class="keyword">this</span>));</span><br><span class="line">            resetProperties();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 包装Biz的mian方法</span></span><br><span class="line">            MainMethodRunner mainMethodRunner = <span class="keyword">new</span> MainMethodRunner(mainClass, args);</span><br><span class="line">            <span class="comment">// 反射调用Biz的main方法，如SpringBootApplication.main</span></span><br><span class="line">            mainMethodRunner.run();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 触发Biz启动后事件，可自定义进行监听</span></span><br><span class="line">            <span class="comment">// this can trigger health checker handler 会触发检查Biz状态事件，参考 SofaEventHandler#doHealthCheck</span></span><br><span class="line">            <span class="comment">// 在Biz启动完成后执行健康检查：会获取Biz下所有组件，并依次检查各组件，参考上文[ReferenceComponent为例](#ReferenceComponent为例)</span></span><br><span class="line">            <span class="comment">// 只有此Biz下全部组件通过，则将Biz标记为 ACTIVATED，否则为 BROKEN</span></span><br><span class="line">            eventAdminService.sendEvent(<span class="keyword">new</span> AfterBizStartupEvent(<span class="keyword">this</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            bizState = BizState.BROKEN;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            ClassLoaderUtils.popContextClassLoader(oldClassLoader);</span><br><span class="line">        &#125;</span><br><span class="line">        BizManagerService bizManagerService = ArkServiceContainerHolder.getContainer().getService(</span><br><span class="line">            BizManagerService.class);</span><br><span class="line">        <span class="keyword">if</span> (bizManagerService.getActiveBiz(bizName) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            bizState = BizState.ACTIVATED;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            bizState = BizState.DEACTIVATED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="启动Biz的服务"><a href="#启动Biz的服务" class="headerlink" title="启动Biz的服务"></a>启动Biz的服务</h4><ul><li>上文mainMethodRunner.run()会调用各Biz的SpringBootApplication.main方法，从而相当于启动一个SpringBoot项目。那么Spring项目启动则势必会调用到refresh方法，最终触发此处onRefresh(refresh - finishRefresh - onRefresh)方法，从而初始化Tomcat</li><li>refresh过程还会刷新SofaBoot Component(如ReferenceComponent,即@SofaReference等注解)的生命周期，参考<a href="#runtime-sofa-boot">runtime-sofa-boot</a></li><li>ServletWebServerApplicationContext.java</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.springframework.boot.web.servlet.context</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServletWebServerApplicationContext</span> <span class="keyword">extends</span> <span class="title">GenericWebApplicationContext</span> <span class="keyword">implements</span> <span class="title">ConfigurableWebServerApplicationContext</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onRefresh</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onRefresh();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 创建Web服务器</span></span><br><span class="line">            <span class="keyword">this</span>.createWebServer();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var2) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ApplicationContextException(<span class="string">"Unable to start web server"</span>, var2);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createWebServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        WebServer webServer = <span class="keyword">this</span>.webServer;</span><br><span class="line">        ServletContext servletContext = <span class="keyword">this</span>.getServletContext();</span><br><span class="line">        <span class="keyword">if</span> (webServer == <span class="keyword">null</span> &amp;&amp; servletContext == <span class="keyword">null</span>) &#123;</span><br><span class="line">            ServletWebServerFactory factory = <span class="keyword">this</span>.getWebServerFactory();</span><br><span class="line">            <span class="keyword">this</span>.webServer = factory.getWebServer(<span class="keyword">new</span> ServletContextInitializer[]&#123;<span class="keyword">this</span>.getSelfInitializer()&#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (servletContext != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.getSelfInitializer().onStartup(servletContext);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ServletException var4) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ApplicationContextException(<span class="string">"Cannot initialize servlet context"</span>, var4);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.initPropertySources();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ArkTomcatServletWebServerFactory.java</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sofa-ark-springboot-starter-1.1.5.jar</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArkTomcatServletWebServerFactory</span> <span class="keyword">extends</span> <span class="title">TomcatServletWebServerFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> WebServer <span class="title">getWebServer</span><span class="params">(ServletContextInitializer... initializers)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (embeddedServerService == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.getWebServer(initializers);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (embeddedServerService.getEmbedServer() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            embeddedServerService.setEmbedServer(initEmbedTomcat());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// tomcat-embed-core-9.0.37.jar &gt; org.apache.catalina.startup.Tomcat</span></span><br><span class="line">        Tomcat embedTomcat = embeddedServerService.getEmbedServer();</span><br><span class="line">        prepareContext(embedTomcat.getHost(), initializers);</span><br><span class="line">        <span class="keyword">return</span> getWebServer(embedTomcat);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> WebServer <span class="title">getWebServer</span><span class="params">(Tomcat tomcat)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ArkTomcatWebServer(tomcat, getPort() &gt;= <span class="number">0</span>, tomcat);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ArkTomcatWebServer</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArkTomcatWebServer</span> <span class="keyword">implements</span> <span class="title">WebServer</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 初始化</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">()</span> <span class="keyword">throws</span> WebServerException </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"Tomcat initialized with port(s): "</span> + getPortsDescription(<span class="keyword">false</span>));</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>.monitor) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Biz类加载流程-BizClassLoader"><a href="#Biz类加载流程-BizClassLoader" class="headerlink" title="Biz类加载流程(BizClassLoader)"></a>Biz类加载流程(BizClassLoader)</h2><ul><li>Biz类加载流程参考<code>BizClassLoader</code><ul><li>Plugin类加载流程参考<code>PluginClassLoader</code></li></ul></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BizClassLoader</span> <span class="keyword">extends</span> <span class="title">AbstractClasspathClassLoader</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; loadClassInternal(String name, <span class="keyword">boolean</span> resolve) <span class="keyword">throws</span> ArkLoaderException &#123;</span><br><span class="line">        Class&lt;?&gt; clazz = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 0. sun reflect related class throw exception directly</span></span><br><span class="line">        <span class="keyword">if</span> (classloaderService.isSunReflectClass(name)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArkLoaderException(</span><br><span class="line">                String</span><br><span class="line">                    .format(</span><br><span class="line">                        <span class="string">"[ArkBiz Loader] %s : can not load class: %s, this class can only be loaded by sun.reflect.DelegatingClassLoader"</span>,</span><br><span class="line">                        bizIdentity, name));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. findLoadedClass</span></span><br><span class="line">        <span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;</span><br><span class="line">            clazz = findLoadedClass(name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. JDK related class</span></span><br><span class="line">        <span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;</span><br><span class="line">            clazz = resolveJDKClass(name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. Ark Spi class</span></span><br><span class="line">        <span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;</span><br><span class="line">            clazz = resolveArkClass(name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. pre find class</span></span><br><span class="line">        <span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;</span><br><span class="line">            clazz = preLoadClass(name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. Plugin Export class</span></span><br><span class="line">        <span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;</span><br><span class="line">            clazz = resolveExportClass(name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6. Biz classpath class</span></span><br><span class="line">        <span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;</span><br><span class="line">            clazz = resolveLocalClass(name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7. Java Agent ClassLoader for agent problem</span></span><br><span class="line">        <span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;</span><br><span class="line">            clazz = resolveJavaAgentClass(name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 8. post find class</span></span><br><span class="line">        <span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;</span><br><span class="line">            clazz = postLoadClass(name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (resolve) &#123;</span><br><span class="line">                <span class="keyword">super</span>.resolveClass(clazz);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> clazz;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArkLoaderException(String.format(<span class="string">"[ArkBiz Loader] %s : can not load class: %s"</span>,</span><br><span class="line">            bizIdentity, name));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="sofa-ark-maven-plugin打包Biz插件"><a href="#sofa-ark-maven-plugin打包Biz插件" class="headerlink" title="sofa-ark-maven-plugin打包Biz插件"></a>sofa-ark-maven-plugin打包Biz插件</h2><ul><li>打包流程参考：<a href="https://zhuanlan.zhihu.com/p/114647271" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/114647271</a></li></ul><h2 id="启动日志示例"><a href="#启动日志示例" class="headerlink" title="启动日志示例"></a>启动日志示例</h2><ul><li>设置<code>logging.level.io.sofastack.guides.master=INFO</code>记录日志</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">20:34:34.539 [main] DEBUG io.netty.util.internal.logging.InternalLoggerFactory - Using SLF4J as the default logging framework</span><br><span class="line"># ...</span><br><span class="line">20:34:36.093 [SOFA-ARK-telnet-server-worker-0-T1] INFO io.netty.handler.logging.LoggingHandler - [id: 0xd2963d81] REGISTERED</span><br><span class="line">20:34:36.117 [SOFA-ARK-telnet-server-worker-0-T1] INFO io.netty.handler.logging.LoggingHandler - [id: 0xd2963d81] BIND: 0.0.0.0/0.0.0.0:1234</span><br><span class="line">20:34:36.167 [SOFA-ARK-telnet-server-worker-0-T1] INFO io.netty.handler.logging.LoggingHandler - [id: 0xd2963d81, L:/0:0:0:0:0:0:0:0:1234] ACTIVE</span><br><span class="line"></span><br><span class="line">2021-04-15 20:34:40.233  INFO 10844 --- [           main] com.alipay.sofa                          : SOFABoot Runtime Starting!</span><br><span class="line"># ...</span><br><span class="line"># --&gt;由于当前模块中使用 @SofaReference 引用了服务 SampleJvmService, 因此扫描到此注解时，会根据注解的信息创建相应的代理对象</span><br><span class="line">2021-04-15 20:34:58.727  INFO 10844 --- [           main] com.alipay.sofa                          : Registering component: reference:com.alipay.sofa.isle.sample.SampleJvmService:#1173235289</span><br><span class="line"># 开始创建代理对象</span><br><span class="line">2021-04-15 20:34:58.731  INFO 10844 --- [           main] com.alipay.sofa                          :  &gt;&gt;In Binding [jvm] Begins - com.alipay.sofa.isle.sample.SampleJvmService.</span><br><span class="line">2021-04-15 20:34:58.759  INFO 10844 --- [           main] com.alipay.sofa                          :  &gt;&gt;In Binding [jvm] Ends - com.alipay.sofa.isle.sample.SampleJvmService.</span><br><span class="line"># &lt;--解析完一个 @SofaReference</span><br><span class="line">2021-04-15 20:34:58.760  INFO 10844 --- [           main] com.alipay.sofa                          : Registering component: reference:com.alipay.sofa.isle.sample.SampleJvmService:annotationImpl#1173235289</span><br><span class="line">2021-04-15 20:34:58.761  INFO 10844 --- [           main] com.alipay.sofa                          :  &gt;&gt;In Binding [jvm] Begins - com.alipay.sofa.isle.sample.SampleJvmService:annotationImpl.</span><br><span class="line">2021-04-15 20:34:58.761  INFO 10844 --- [           main] com.alipay.sofa                          :  &gt;&gt;In Binding [jvm] Ends - com.alipay.sofa.isle.sample.SampleJvmService:annotationImpl.</span><br><span class="line">2021-04-15 20:34:58.761  INFO 10844 --- [           main] com.alipay.sofa                          : Registering component: reference:com.alipay.sofa.isle.sample.SampleJvmService:serviceClientImpl#1173235289</span><br><span class="line">2021-04-15 20:34:58.761  INFO 10844 --- [           main] com.alipay.sofa                          :  &gt;&gt;In Binding [jvm] Begins - com.alipay.sofa.isle.sample.SampleJvmService:serviceClientImpl.</span><br><span class="line">2021-04-15 20:34:58.762  INFO 10844 --- [           main] com.alipay.sofa                          :  &gt;&gt;In Binding [jvm] Ends - com.alipay.sofa.isle.sample.SampleJvmService:serviceClientImpl.</span><br><span class="line"># ...</span><br><span class="line">2021-04-15 20:35:20.688  INFO 10844 --- [           main] com.alipay.sofa                          : ++++++++++++++++++ ModelCreatingStage of SqBiz Main Start +++++++++++++++++</span><br><span class="line">2021-04-15 20:35:20.717  INFO 10844 --- [           main] com.alipay.sofa                          : ++++++++++++++++++ ModelCreatingStage of SqBiz Main End +++++++++++++++++</span><br><span class="line">2021-04-15 20:35:20.717  INFO 10844 --- [           main] com.alipay.sofa                          : ++++++++++++++++++ SpringContextInstallStage of SqBiz Main Start +++++++++++++++++</span><br><span class="line">2021-04-15 20:35:20.720  INFO 10844 --- [           main] com.alipay.sofa                          : </span><br><span class="line">All activated module list(2) &gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">  ├─ cn.aezo.sqbiz.sqbiz-plugin.service-consumer</span><br><span class="line">  └─ cn.aezo.sqbiz.sqbiz-plugin.service-provider</span><br><span class="line"></span><br><span class="line">Modules that could install(2) &gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">  ├─ cn.aezo.sqbiz.sqbiz-plugin.service-provider</span><br><span class="line">  └─ cn.aezo.sqbiz.sqbiz-plugin.service-consumer</span><br><span class="line"></span><br><span class="line">2021-04-15 20:35:20.724  INFO 10844 --- [           main] com.alipay.sofa                          : Start install SqBiz Main&apos;s module: cn.aezo.sqbiz.sqbiz-plugin.service-provider</span><br><span class="line">2021-04-15 20:35:20 JRebel: Monitoring Spring bean definitions in &apos;D:\gitwork\oschina\sqbiz\sqbiz-parent\sqbiz-plugin\service-provider\target\classes\META-INF\spring\service-provide.xml&apos;.</span><br><span class="line">2021-04-15 20:35:21.717  INFO 10844 --- [           main] com.alipay.sofa                          : Start install SqBiz Main&apos;s module: cn.aezo.sqbiz.sqbiz-plugin.service-consumer</span><br><span class="line">2021-04-15 20:35:21 JRebel: Monitoring Spring bean definitions in &apos;D:\gitwork\oschina\sqbiz\sqbiz-parent\sqbiz-plugin\service-consumer\target\classes\META-INF\spring\service-consumer.xml&apos;.</span><br><span class="line">2021-04-15 20:40:08.094  INFO 10844 --- [ervice-provider] com.alipay.sofa                          : Begin refresh Spring Application Context of module cn.aezo.sqbiz.sqbiz-plugin.service-provider of application SqBiz Main.</span><br><span class="line">2021-04-15 20:41:36.672  INFO 10844 --- [ervice-provider] com.alipay.sofa                          : Registering component: service:com.alipay.sofa.isle.sample.SampleJvmService</span><br><span class="line">2021-04-15 20:41:36.673  INFO 10844 --- [ervice-provider] com.alipay.sofa                          :  &lt;&lt;PreOut Binding [jvm] Begins - com.alipay.sofa.isle.sample.SampleJvmService.</span><br><span class="line">2021-04-15 20:41:36.675  INFO 10844 --- [ervice-provider] com.alipay.sofa                          :  &lt;&lt;PreOut Binding [jvm] Ends - com.alipay.sofa.isle.sample.SampleJvmService.</span><br><span class="line">2021-04-15 20:43:22.438  INFO 10844 --- [ervice-provider] com.alipay.sofa                          :  &lt;&lt;Out Binding [jvm] Begins - com.alipay.sofa.isle.sample.SampleJvmService.</span><br><span class="line">2021-04-15 21:03:18.238  INFO 10844 --- [ervice-provider] com.alipay.sofa                          :  &lt;&lt;Out Binding [jvm] Ends - com.alipay.sofa.isle.sample.SampleJvmService.</span><br><span class="line">2021-04-15 21:03:55.586  INFO 10844 --- [ervice-provider] com.alipay.sofa                          : Register Service - com.alipay.sofa.isle.sample.SampleJvmService</span><br><span class="line">2021-04-15 21:05:16.719  INFO 10844 --- [ervice-provider] com.alipay.sofa                          : Registering component: service:com.alipay.sofa.isle.sample.SampleJvmService:serviceClientImpl</span><br><span class="line">2021-04-15 21:05:16.719  INFO 10844 --- [ervice-provider] com.alipay.sofa                          :  &lt;&lt;PreOut Binding [jvm] Begins - com.alipay.sofa.isle.sample.SampleJvmService:serviceClientImpl.</span><br><span class="line">2021-04-15 21:05:16.719  INFO 10844 --- [ervice-provider] com.alipay.sofa                          :  &lt;&lt;PreOut Binding [jvm] Ends - com.alipay.sofa.isle.sample.SampleJvmService:serviceClientImpl.</span><br><span class="line">2021-04-15 21:05:29.506  INFO 10844 --- [ervice-provider] com.alipay.sofa                          :  &lt;&lt;Out Binding [jvm] Begins - com.alipay.sofa.isle.sample.SampleJvmService:serviceClientImpl.</span><br><span class="line">2021-04-15 21:05:29.506  INFO 10844 --- [ervice-provider] com.alipay.sofa                          :  &lt;&lt;Out Binding [jvm] Ends - com.alipay.sofa.isle.sample.SampleJvmService:serviceClientImpl.</span><br><span class="line">2021-04-15 21:05:29.506  INFO 10844 --- [ervice-provider] com.alipay.sofa                          : Register Service - com.alipay.sofa.isle.sample.SampleJvmService:serviceClientImpl</span><br><span class="line">2021-04-15 21:05:29.527  INFO 10844 --- [ervice-provider] com.alipay.sofa                          : Registering component: service:com.alipay.sofa.isle.sample.SampleJvmService:annotationImpl</span><br><span class="line">2021-04-15 21:05:29.528  INFO 10844 --- [ervice-provider] com.alipay.sofa                          :  &lt;&lt;PreOut Binding [jvm] Begins - com.alipay.sofa.isle.sample.SampleJvmService:annotationImpl.</span><br><span class="line">2021-04-15 21:05:29.528  INFO 10844 --- [ervice-provider] com.alipay.sofa                          :  &lt;&lt;PreOut Binding [jvm] Ends - com.alipay.sofa.isle.sample.SampleJvmService:annotationImpl.</span><br><span class="line">2021-04-15 21:05:29.528  INFO 10844 --- [ervice-provider] com.alipay.sofa                          :  &lt;&lt;Out Binding [jvm] Begins - com.alipay.sofa.isle.sample.SampleJvmService:annotationImpl.</span><br><span class="line">2021-04-15 21:05:29.528  INFO 10844 --- [ervice-provider] com.alipay.sofa                          :  &lt;&lt;Out Binding [jvm] Ends - com.alipay.sofa.isle.sample.SampleJvmService:annotationImpl.</span><br><span class="line">2021-04-15 21:05:29.528  INFO 10844 --- [ervice-provider] com.alipay.sofa                          : Register Service - com.alipay.sofa.isle.sample.SampleJvmService:annotationImpl</span><br><span class="line">2021-04-15 21:07:37.682  INFO 10844 --- [ervice-provider] com.alipay.sofa                          : Registering component: Spring:cn.aezo.sqbiz.sqbiz-plugin.service-provider</span><br><span class="line"></span><br><span class="line">2021-04-15 21:17:32.013  INFO 10844 --- [ervice-consumer] com.alipay.sofa                          : Begin refresh Spring Application Context of module cn.aezo.sqbiz.sqbiz-plugin.service-consumer of application SqBiz Main.</span><br><span class="line">Hello, jvm service xml implementation.</span><br><span class="line">Hello, jvm service annotation implementation.</span><br><span class="line">Hello, jvm service service client implementation.</span><br><span class="line">2021-04-15 21:17:35.675  INFO 10844 --- [ervice-consumer] com.alipay.sofa                          : Registering component: Spring:cn.aezo.sqbiz.sqbiz-plugin.service-consumer</span><br><span class="line">2021-04-15 21:17:35.675  INFO 10844 --- [           main] com.alipay.sofa                          : ++++++++++++++++++ SpringContextInstallStage of SqBiz Main End +++++++++++++++++</span><br><span class="line">2021-04-15 21:17:35.676  INFO 10844 --- [           main] com.alipay.sofa                          : ++++++++++++++++++ ModuleLogOutputStage of SqBiz Main Start +++++++++++++++++</span><br><span class="line">2021-04-15 21:17:35.677  INFO 10844 --- [           main] com.alipay.sofa                          : </span><br><span class="line">Spring context initialize success module list(2) &gt;&gt;&gt;&gt;&gt;&gt;&gt; [totalTime = 1780555 ms, realTime = 2177614 ms]</span><br><span class="line">  ├─cn.aezo.sqbiz.sqbiz-plugin.service-provider [1776894 ms]</span><br><span class="line">  │   `---D:\gitwork\oschina\sqbiz\sqbiz-parent\sqbiz-plugin\service-provider\target\classes\META-INF\spring\service-provide.xml</span><br><span class="line">  └─cn.aezo.sqbiz.sqbiz-plugin.service-consumer [3661 ms]</span><br><span class="line">      `---D:\gitwork\oschina\sqbiz\sqbiz-parent\sqbiz-plugin\service-consumer\target\classes\META-INF\spring\service-consumer.xml</span><br><span class="line"></span><br><span class="line">Spring context initialize failed module list(0) &gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line"></span><br><span class="line">Spring bean load time cost list(2) &gt;&gt;&gt;&gt;&gt;&gt;&gt; [totalTime = 1780555 ms, realTime = 2177614 ms]</span><br><span class="line">  ├─[Module] cn.aezo.sqbiz.sqbiz-plugin.service-provider [1776894 ms]</span><br><span class="line">  │   ├─com.alipay.sofa.runtime.spring.factory.ServiceFactoryBean (sampleJvmService)  [1420319ms]</span><br><span class="line">  │   ├─com.alipay.sofa.isle.sample.PublishServiceWithClient (publishServiceWithClient)  [12795ms]</span><br><span class="line">  │   ├─com.alipay.sofa.boot.autoconfigure.runtime.SofaRuntimeAutoConfiguration (runtimeContextBeanFactoryPostProcessor)  [529ms]</span><br><span class="line">  │   ├─org.springframework.boot.autoconfigure.jdbc.DataSourceInitializerPostProcessor (dataSourceInitializerPostProcessor)  [175ms]</span><br><span class="line">  │   ├─org.springframework.boot.actuate.autoconfigure.metrics.MetricsAutoConfiguration (meterRegistryPostProcessor)  [173ms]</span><br><span class="line">  │   ├─org.springframework.boot.autoconfigure.dao.PersistenceExceptionTranslationAutoConfiguration (persistenceExceptionTranslationPostProcessor)  [154ms]</span><br><span class="line">  │   ├─com.alipay.sofa.boot.autoconfigure.runtime.SofaRuntimeAutoConfiguration (jvmFilterPostProcessor)  [122ms]</span><br><span class="line">  │   └─com.alipay.sofa.boot.autoconfigure.isle.SofaModuleAutoConfiguration (sofaModuleBeanFactoryPostProcessor)  [121ms]</span><br><span class="line">  └─[Module] cn.aezo.sqbiz.sqbiz-plugin.service-consumer [3661 ms]</span><br><span class="line">      └─com.alipay.sofa.isle.sample.JvmServiceConsumer (consumer)  [3364ms]</span><br><span class="line"></span><br><span class="line">2021-04-15 21:17:35.678  INFO 10844 --- [           main] com.alipay.sofa                          : ++++++++++++++++++ ModuleLogOutputStage of SqBiz Main End +++++++++++++++++</span><br><span class="line">Ark container started in 44129 ms.</span><br></pre></td></tr></table></figure></div><div></div><div></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> smalle</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="http://blog.aezo.cn/2021/04/13/java/java-src/sofastack-src/" title="SOFAStack源码分析">http://blog.aezo.cn/2021/04/13/java/java-src/sofastack-src/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/src/" rel="tag"># src</a> <a href="/tags/springboot/" rel="tag"># springboot</a> <a href="/tags/微服务/" rel="tag"># 微服务</a> <a href="/tags/plugin/" rel="tag"># plugin</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2021/04/11/java/sofastack/" rel="next" title="SOFAStack"><i class="fa fa-chevron-left"></i> SOFAStack</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"> <a href="/2021/06/01/bigdata/hive/" rel="prev" title="Hive">Hive<i class="fa fa-chevron-right"></i></a></div></div></footer></article><div class="post-spread"></div></div></div><div class="comments" id="comments"></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> 文章目录</li><li class="sidebar-nav-overview" data-target="site-overview"> 站点概览</li></ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="https://avatars0.githubusercontent.com/u/15698218?v=3&u=ce740bf0b67ff0d74990ba6fc644d6e92f572dcb&s=400" alt="smalle"><p class="site-author-name" itemprop="name">smalle</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">162</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/index.html"><span class="site-state-item-count">13</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/index.html"><span class="site-state-item-count">144</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#isle-sofa-boot模块隔离"><span class="nav-number">1.</span> <span class="nav-text">isle-sofa-boot模块隔离</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#初始化"><span class="nav-number">1.1.</span> <span class="nav-text">初始化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Spring启动完成后广播事件"><span class="nav-number">1.1.1.</span> <span class="nav-text">Spring启动完成后广播事件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#处理pipeline流水线"><span class="nav-number">1.1.2.</span> <span class="nav-text">处理pipeline流水线</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#SpringContextInstallStage为例"><span class="nav-number">1.1.2.1.</span> <span class="nav-text">SpringContextInstallStage为例</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#创建模块的SpringContextLoader-上下文加载器"><span class="nav-number">1.1.2.1.1.</span> <span class="nav-text">创建模块的SpringContextLoader(上下文加载器)</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#加载SpringContext配置文件"><span class="nav-number">1.1.2.1.2.</span> <span class="nav-text">加载SpringContext配置文件</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#并行刷新SpringContext"><span class="nav-number">1.1.2.1.3.</span> <span class="nav-text">并行刷新SpringContext</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#runtime-sofa-boot"><span class="nav-number">2.</span> <span class="nav-text">runtime-sofa-boot</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#初始化-1"><span class="nav-number">2.1.</span> <span class="nav-text">初始化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#BeanPostProcessor注册组件入口"><span class="nav-number">2.1.1.</span> <span class="nav-text">BeanPostProcessor注册组件入口</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ReferenceAnnotationBeanPostProcessor为例"><span class="nav-number">2.1.1.1.</span> <span class="nav-text">ReferenceAnnotationBeanPostProcessor为例</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ServiceBeanFactoryPostProcessor为例"><span class="nav-number">2.1.1.2.</span> <span class="nav-text">ServiceBeanFactoryPostProcessor为例</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#组件即其生命周期"><span class="nav-number">2.1.2.</span> <span class="nav-text">组件即其生命周期</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#激活组件"><span class="nav-number">2.1.3.</span> <span class="nav-text">激活组件</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ReferenceComponent为例"><span class="nav-number">2.1.3.1.</span> <span class="nav-text">ReferenceComponent为例</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ServiceComponent为例"><span class="nav-number">2.1.3.2.</span> <span class="nav-text">ServiceComponent为例</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SpringContextComponent为例"><span class="nav-number">2.1.3.3.</span> <span class="nav-text">SpringContextComponent为例</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#扩展点初始化"><span class="nav-number">2.2.</span> <span class="nav-text">扩展点初始化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#sofa-boot-autoconfigure"><span class="nav-number">3.</span> <span class="nav-text">sofa-boot-autoconfigure</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Ark容器启动流程"><span class="nav-number">4.</span> <span class="nav-text">Ark容器启动流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#sofa-ark-support-starter"><span class="nav-number">4.1.</span> <span class="nav-text">sofa-ark-support-starter</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sofa-ark-container"><span class="nav-number">4.2.</span> <span class="nav-text">sofa-ark-container</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ArkContainer"><span class="nav-number">4.2.1.</span> <span class="nav-text">ArkContainer</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#以DeployBizStage为例-执行Biz的main方法"><span class="nav-number">4.2.2.</span> <span class="nav-text">以DeployBizStage为例(执行Biz的main方法)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#启动Biz的服务"><span class="nav-number">4.2.3.</span> <span class="nav-text">启动Biz的服务</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Biz类加载流程-BizClassLoader"><span class="nav-number">5.</span> <span class="nav-text">Biz类加载流程(BizClassLoader)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#sofa-ark-maven-plugin打包Biz插件"><span class="nav-number">6.</span> <span class="nav-text">sofa-ark-maven-plugin打包Biz插件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#启动日志示例"><span class="nav-number">7.</span> <span class="nav-text">启动日志示例</span></a></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright"> &copy; 2016 - <span itemprop="copyrightYear">2023</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">smalle</span>&nbsp;&nbsp;&nbsp;&nbsp;<div class="powered-by"> 由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div><div class="theme-info"> 主题 - <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a></div></div><div class="ad"> <span style="font-weight:700">AD&nbsp;&nbsp;&nbsp;&nbsp;</span><div class="theme-info"> <a target="_blank" href="https://promotion.aliyun.com/ntms/yunparter/invite.html?userCode=oby5nolb">阿里云大礼包</a></div></div><div class="aezocn"> <span style="font-weight:700">&copy;AEZO.CN&nbsp;&nbsp;&nbsp;&nbsp;</span><div class="powered-by"> <a target="_blank" href="https://shengqitech.aezo.cn/">圣骑科技</a></div><div class="powered-by"> <a target="_blank" href="https://cdn7.aezo.cn/common/qrcode/one_qrcode.jpg">【One能抽屉】小程序</a></div><div class="theme-info"> <a target="_blank" href="http://shop.aezo.cn/">杂货铺(省钱小助手)</a></div></div><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?085f9cd91ef2ad985f791c677472f0d1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script><script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script type="text/javascript" src="/js/src/js.cookie.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/scroll-cookie.js?v=5.1.1"></script></body></html>