<!doctype html><html class="theme-next mist use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css"><meta name="keywords" content="mysql,oracle,sql,"><link rel="alternate" href="/atom.xml" title="月星墙的博客" type="application/atom+xml"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1"><meta name="description" content="SQL基础 下文未做特殊说明的语句都是基于Mysql的语法 mysql练习题  设计表三范式 三范式 第一范式：要有主键，列不可分。(如：如果要分别获取姓、名，则应该设计两个字段，而不应该设置为姓名一个字段当查询出来后再进行分割) 第二范式：不能存在部分依赖。即当一张表中有多个字段作为主键时，非主键的字段不能依赖于部分主键 A,B-&amp;gt;C, B-&amp;gt;D 此时A,B如果为侯选建，则D不完全依"><meta name="keywords" content="mysql,oracle,sql"><meta property="og:type" content="article"><meta property="og:title" content="sql基础"><meta property="og:url" content="http://blog.aezo.cn/2017/09/30/db/sql-base/index.html"><meta property="og:site_name" content="月星墙的博客"><meta property="og:description" content="SQL基础 下文未做特殊说明的语句都是基于Mysql的语法 mysql练习题  设计表三范式 三范式 第一范式：要有主键，列不可分。(如：如果要分别获取姓、名，则应该设计两个字段，而不应该设置为姓名一个字段当查询出来后再进行分割) 第二范式：不能存在部分依赖。即当一张表中有多个字段作为主键时，非主键的字段不能依赖于部分主键 A,B-&amp;gt;C, B-&amp;gt;D 此时A,B如果为侯选建，则D不完全依"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="http://blog.aezo.cn/data/images/db/mysql-redo-log.png"><meta property="og:image" content="http://blog.aezo.cn/data/images/db/mysql-innodb-update.png"><meta property="og:updated_time" content="2024-03-12T14:13:40.991Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="sql基础"><meta name="twitter:description" content="SQL基础 下文未做特殊说明的语句都是基于Mysql的语法 mysql练习题  设计表三范式 三范式 第一范式：要有主键，列不可分。(如：如果要分别获取姓、名，则应该设计两个字段，而不应该设置为姓名一个字段当查询出来后再进行分割) 第二范式：不能存在部分依赖。即当一张表中有多个字段作为主键时，非主键的字段不能依赖于部分主键 A,B-&amp;gt;C, B-&amp;gt;D 此时A,B如果为侯选建，则D不完全依"><meta name="twitter:image" content="http://blog.aezo.cn/data/images/db/mysql-redo-log.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",sidebar:{position:"right",display:"post",offset:12,offset_float:0,b2t:!1,scrollpercent:!1},fancybox:!0,motion:!0,duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"BWD6R9FA4K",apiKey:"3330f3cbaa099dfc30395de5f5b20151",indexName:"blog",hits:{per_page:10},labels:{input_placeholder:"请输入关键字",hits_empty:"我们没有找到任何搜索结果: ${query}",hits_stats:"找到约${hits}条结果（用时${time}ms）"}}}</script><link rel="canonical" href="http://blog.aezo.cn/2017/09/30/db/sql-base/"><title>sql基础 | 月星墙的博客</title><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?085f9cd91ef2ad985f791c677472f0d1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-right page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">月星墙的博客</span><span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">Better Code, Better Life</h1></div><div class="site-nav-toggle"> <button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br> 首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br> 分类</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br> 关于</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br> 归档</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br> 标签</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i><br> 站点地图</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br> 搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"> <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><link itemprop="mainEntityOfPage" href="http://blog.aezo.cn/2017/09/30/db/sql-base/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="smalle"><meta itemprop="description" content=""><meta itemprop="image" content="https://avatars0.githubusercontent.com/u/15698218?v=3&u=ce740bf0b67ff0d74990ba6fc644d6e92f572dcb&s=400"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="月星墙的博客"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">sql基础</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-30T12:51:00+08:00">2017-09-30</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/db/" itemprop="url" rel="index"><span itemprop="name">db</span></a></span></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="SQL基础"><a href="#SQL基础" class="headerlink" title="SQL基础"></a>SQL基础</h2><ul><li>下文未做特殊说明的语句都是基于Mysql的语法</li><li><a href="https://github.com/bjmashibing/InternetArchitect/blob/master/13mysql%E8%B0%83%E4%BC%98/mysql%E7%BB%83%E4%B9%A0%E9%A2%98.md" target="_blank" rel="noopener">mysql练习题</a></li></ul><h2 id="设计表"><a href="#设计表" class="headerlink" title="设计表"></a>设计表</h2><h3 id="三范式"><a href="#三范式" class="headerlink" title="三范式"></a>三范式</h3><ul><li>三范式<ul><li>第一范式：要有主键，列不可分。(如：如果要分别获取姓、名，则应该设计两个字段，而不应该设置为姓名一个字段当查询出来后再进行分割)</li><li>第二范式：不能存在部分依赖。即当一张表中有多个字段作为主键时，非主键的字段不能依赖于部分主键<ul><li>A,B-&gt;C, B-&gt;D 此时A,B如果为侯选建，则D不完全依赖A,B(仅依赖B)</li></ul></li><li>第三范式：不能存在传递依赖。如：雇员表中描述雇员需要描述他所在部门，因此只需记录其部门编号即可，如果把部门相关的信息(部门名称、部门位置)加入到雇员表则存在传递依赖<ul><li>A-&gt;B-&gt;C, 此时不能把这个3个字段放到一张表，否则存在传递依赖</li></ul></li></ul></li><li>三范式强调的是表不存在冗余数据(同样的数据不存第二遍)</li><li>符合了三范式后会增加查询难度，要做表连接</li></ul><h3 id="常用建表模型"><a href="#常用建表模型" class="headerlink" title="常用建表模型"></a>常用建表模型</h3><ul><li>字典表(t_type_code)：id、type、code、name、value、note、rank(排序)、permission_code(权限落在行级)、valid_status、input_user_id、input_time、update_user_id、update_time</li><li>大字段表</li><li>树型表(t_structure)：id、structure_type_code(树类型)、parent_id、node_level、node_code、node_name、node_note、node_rank(节点排序)</li><li>属性表(t_attr)：id、attr_type、parent_id、code、value、note、permission_code(属性表可和树型表连用)</li><li>权限相关表<ul><li>权限组(t_security_group)：id、security_group、note</li><li>权限(t_promission)：id、promission、note</li><li>权限组-权限关系表(t_security_group_promission、多对多)：id、security_group、promission</li><li>用户权限组关系表(t_user_security_group、多对多)：id、user_id、security_group</li></ul></li><li>角色相关表 <code>RBAC</code><ul><li>角色类型树：如总经理、销售经理、市场经理、员工</li><li>部门树</li></ul></li><li>主要实体暂存功能</li></ul><h3 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h3><ul><li>根据不同的拜访目的显示不同拜访结果和子结果，根据拜访结果归纳出错误客户信息(某几个拜访结果:信息错误-电话错误; 信息错误-三次无人接听)的拜访<ul><li>原始情况：拜访结果和子结果以树型存储，根据不同的拜访目的存储不同”XXX拜访目的-拜访结果”树(拜访结果大致相同)，且保存树节点ID为了提高查询效率；拜访表添加一个结果状态字段用来在保存的时候根据不同的结果归纳出最终的状态(已提交/信息错误/其他)</li><li>导致困境<ul><li>拜访结果确实可根据数据库定义的”XXX拜访目的-拜访结果”树自动联动。但是查询拜访时想获取同一类型，则搜索选项的下拉都很难显示(要基于所有的结果根据结果代码group by, 而且有可能结果的名称不同)，获取到代码后再根据代码查询到相应的节点ID，通过IN(结果ID)的进行sql查询</li><li>基于不同结果提取出一个最终的状态，导致每次修改数据都要更新此状态</li></ul></li><li>建议方案<ul><li>数据库中只保存一份拜访结果和子结果(将代码和名称归纳到一起)，展示的时候写属性代码矫正联动显示；保存拜访的时候保存结果代码。(最好是拜访结果/拜访目的单独维护表)</li><li>去掉归纳字段，所有的查询直接根据结果代码来(可利用索引优化查询)</li></ul></li></ul></li></ul><h3 id="设计树状结构的存储"><a href="#设计树状结构的存储" class="headerlink" title="设计树状结构的存储"></a>设计树状结构的存储</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*创建表*/</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> article(</span><br><span class="line">    <span class="keyword">id</span> <span class="built_in">int</span> primary <span class="keyword">key</span>,</span><br><span class="line">    cont <span class="built_in">text</span>,</span><br><span class="line">    pid <span class="built_in">int</span>,<span class="comment">/*注释：表示父id*/</span></span><br><span class="line">    isleaf <span class="built_in">int</span>(<span class="number">1</span>),<span class="comment">/*注释：0代表非叶子节点，1代表叶子节点*/</span></span><br><span class="line">    alevel <span class="built_in">int</span>(<span class="number">2</span>)<span class="comment">/*注释：表示层级(可通过层级0表示非叶子节点)*/</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*插入数据*/</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> article <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'蚂蚁大战大象'</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> article <span class="keyword">values</span>(<span class="number">2</span>,<span class="string">'大象被打趴下了'</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> article <span class="keyword">values</span>(<span class="number">3</span>,<span class="string">'蚂蚁也不好过'</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> article <span class="keyword">values</span>(<span class="number">4</span>,<span class="string">'瞎说'</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> article <span class="keyword">values</span>(<span class="number">5</span>,<span class="string">'没有瞎说'</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> article <span class="keyword">values</span>(<span class="number">6</span>,<span class="string">'怎么可能'</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> article <span class="keyword">values</span>(<span class="number">7</span>,<span class="string">'怎么没有可能'</span>, <span class="number">6</span>, <span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> article <span class="keyword">values</span>(<span class="number">8</span>,<span class="string">'可能性是很大的'</span>, <span class="number">6</span>, <span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> article <span class="keyword">values</span>(<span class="number">9</span>,<span class="string">'大象进医院了'</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> article <span class="keyword">values</span>(<span class="number">10</span>,<span class="string">'护士是蚂蚁'</span>, <span class="number">9</span>, <span class="number">1</span>, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*显示*/</span></span><br><span class="line">蚂蚁大战大象</span><br><span class="line">  大象被打趴下了</span><br><span class="line">    蚂蚁也不好过</span><br><span class="line">    瞎说</span><br><span class="line">      没有瞎说</span><br><span class="line">    大象进医院了</span><br><span class="line">      护士是蚂蚁</span><br><span class="line">  怎么可能</span><br><span class="line">    怎么没有可能</span><br><span class="line">    可能性是很大的</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用递归打印树状结构</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> <span class="keyword">replace</span> procedual p(v_pid acticle.pid%<span class="keyword">type</span>, v_level binary_integer) <span class="keyword">is</span></span><br><span class="line">  <span class="keyword">cursor</span> c <span class="keyword">is</span> <span class="keyword">select</span> * <span class="keyword">from</span> article <span class="keyword">where</span> pid = v_pid;</span><br><span class="line">  v_preStr varchar2(1024) = '';</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">1.</span>.v_level <span class="keyword">loop</span></span><br><span class="line">    v_preStr := v_preStr || <span class="string">'****'</span>;</span><br><span class="line">  <span class="keyword">end</span> <span class="keyword">loop</span>;</span><br><span class="line">  for v_article in c loop</span><br><span class="line">    dbms_output.put_line(v_preStr || v_article.cont);</span><br><span class="line">    if(v_article.isleaf = 0) then</span><br><span class="line">      p(v_article.id, v_preStr + 1);</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">if</span>;  </span><br><span class="line">  <span class="keyword">end</span> <span class="keyword">loop</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line">/</span><br><span class="line">exec p(0, 0);</span><br></pre></td></tr></table></figure><h2 id="数据库表信息"><a href="#数据库表信息" class="headerlink" title="数据库表信息"></a>数据库表信息</h2><ul><li><code>show databases;</code> 显示所有数据库</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| sqltest            |</span><br><span class="line">+--------------------+</span><br></pre></td></tr></table></figure><blockquote><p>Oracle一个实例，就是一个数据库，所以没有对应的 show databases 语句。使用<code>select * from gv$instance;</code>查看所有实例</p></blockquote><ul><li><code>use sqltest</code> 选择数据库</li><li><code>show tables;</code> 显示该数据库的所有表</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+-------------------+</span><br><span class="line">| Tables_in_sqltest |</span><br><span class="line">+-------------------+</span><br><span class="line">| dept              |</span><br><span class="line">| emp               |</span><br><span class="line">| salgrade          |</span><br><span class="line">+-------------------+</span><br></pre></td></tr></table></figure><ul><li>雇员表<code>desc emp;</code>或者<code>describe emp;</code> 描述一张表的字段详情<ul><li>date只包含年月日，datetime、timestamp包含了完整的日期时间</li></ul></li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">+----------+-------------+------+-----+---------+-------+</span><br><span class="line">| Field    | Type        | Null | Key | Default | Extra |</span><br><span class="line">+----------+-------------+------+-----+---------+-------+</span><br><span class="line">| empno    | int(4)      | NO   |     | NULL    |       |雇员编号</span><br><span class="line">| ename    | varchar(10) | YES  |     | NULL    |       |雇员姓名</span><br><span class="line">| job      | varchar(9)  | YES  |     | NULL    |       |工种</span><br><span class="line">| mgr      | int(4)      | YES  |     | NULL    |       |经理人编号</span><br><span class="line">| hiredate | timestamp   | YES  |     | NULL    |       |雇佣日期</span><br><span class="line">| sal      | double(7,2) | YES  |     | NULL    |       |工资</span><br><span class="line">| comm     | double(7,2) | YES  |     | NULL    |       |津贴</span><br><span class="line">| deptno   | int(2)      | YES  |     | NULL    |       |部门编号</span><br><span class="line">+----------+-------------+------+-----+---------+-------+</span><br></pre></td></tr></table></figure><ul><li>部门表<code>desc dept;</code></li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">+--------+-------------+------+-----+---------+-------+</span><br><span class="line">| Field  | Type        | Null | Key | Default | Extra |</span><br><span class="line">+--------+-------------+------+-----+---------+-------+</span><br><span class="line">| deptno | int(2)      | NO   |     | NULL    |       |部门编号</span><br><span class="line">| dname  | varchar(14) | YES  |     | NULL    |       |部门名称</span><br><span class="line">| loc    | varchar(13) | YES  |     | NULL    |       |所在地</span><br><span class="line">+--------+-------------+------+-----+---------+-------+</span><br><span class="line">- 薪资表`desc salgrade;`</span><br><span class="line">+-------+---------+------+-----+---------+-------+</span><br><span class="line">| Field | Type    | Null | Key | Default | Extra |</span><br><span class="line">+-------+---------+------+-----+---------+-------+</span><br><span class="line">| grade | int(2)  | YES  |     | NULL    |       |薪资级别</span><br><span class="line">| losal | int(11) | YES  |     | NULL    |       |最低薪资</span><br><span class="line">| hisal | int(11) | YES  |     | NULL    |       |最高薪资</span><br><span class="line">+-------+---------+------+-----+---------+-------+</span><br></pre></td></tr></table></figure><ul><li><p>sqltest中含有emp、dept、salgrade三张表，具体数据如下：</p><ul><li><p><code>select * from emp;</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">+-------+--------+-----------+------+---------------------+---------+---------+--------+</span><br><span class="line">| empno | ename  | job       | mgr  | hiredate            | sal     | comm    | deptno |</span><br><span class="line">+-------+--------+-----------+------+---------------------+---------+---------+--------+</span><br><span class="line">|  7369 | smith  | clerk     | 7902 | 1980-12-17 00:00:00 |  800.00 |    NULL |     20 |</span><br><span class="line">|  7499 | allen  | salesman  | 7698 | 1981-02-20 00:00:00 | 1600.00 |  300.00 |     30 |</span><br><span class="line">|  7521 | ward   | salesman  | 7698 | 1981-02-20 00:00:00 | 1250.00 |  500.00 |     30 |</span><br><span class="line">|  7566 | jones  | manager   | 7839 | 1981-02-04 00:00:00 | 2975.00 |    NULL |     20 |</span><br><span class="line">|  7654 | martin | salesman  | 7698 | 1981-09-28 00:00:00 | 1250.00 | 1400.00 |     30 |</span><br><span class="line">|  7698 | blake  | manager   | 7839 | 1981-05-01 00:00:00 | 2850.00 |    NULL |     30 |</span><br><span class="line">|  7782 | clark  | manager   | 7839 | 1981-06-09 00:00:00 | 2450.00 |    NULL |     10 |</span><br><span class="line">|  7788 | scott  | analyst   | 7566 | 1987-04-19 00:00:00 | 3000.00 |    NULL |     20 |</span><br><span class="line">|  7839 | king   | president | NULL | 1981-11-17 00:00:00 | 5000.00 |    NULL |     10 |</span><br><span class="line">|  7844 | turner | salesman  | 7698 | 1981-09-08 00:00:00 | 1500.00 |    0.00 |     30 |</span><br><span class="line">|  7876 | adams  | clerk     | 7788 | 1987-05-23 00:00:00 | 1100.00 |    NULL |     20 |</span><br><span class="line">|  7900 | james  | clerk     | 7698 | 1981-03-12 00:00:00 |  950.00 |    NULL |     30 |</span><br><span class="line">+-------+--------+-----------+------+---------------------+---------+---------+--------+</span><br></pre></td></tr></table></figure></li><li><p><code>select * from dept;</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">+--------+------------+----------+</span><br><span class="line">| deptno | dname      | loc      |</span><br><span class="line">+--------+------------+----------+</span><br><span class="line">|     10 | accounting | new york |</span><br><span class="line">|     20 | research   | dallas   |</span><br><span class="line">|     30 | sales      | chicago  |</span><br><span class="line">|     40 | operations | boston   |</span><br><span class="line">+--------+------------+----------+</span><br></pre></td></tr></table></figure></li></ul></li></ul><pre><code>- `select * from salgrade;`

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">+-------+-------+-------+</span><br><span class="line">| grade | losal | hisal |</span><br><span class="line">+-------+-------+-------+</span><br><span class="line">|     1 |   700 |  1200 |</span><br><span class="line">|     2 |  1201 |  1400 |</span><br><span class="line">|     3 |  1401 |  2000 |</span><br><span class="line">|     4 |  2001 |  3000 |</span><br><span class="line">|     5 |  3001 |  9999 |</span><br><span class="line">+-------+-------+-------+</span><br></pre></td></tr></table></figure></code></pre><h2 id="数据库模式定义语言DDL-Data-Definition-Language"><a href="#数据库模式定义语言DDL-Data-Definition-Language" class="headerlink" title="数据库模式定义语言DDL(Data Definition Language)"></a>数据库模式定义语言DDL(Data Definition Language)</h2><h3 id="创建和使用数据库"><a href="#创建和使用数据库" class="headerlink" title="创建和使用数据库"></a>创建和使用数据库</h3><ul><li><code>create database sqltest;</code> 创建数据库</li><li><code>use sqltest;</code> 使用数据库，之后在这个数据库上进行表的创建、展示等操作</li></ul><h3 id="数据库基本"><a href="#数据库基本" class="headerlink" title="数据库基本"></a>数据库基本</h3><ul><li>Mysql注释使用<code>/**/</code>，Oracle注释使用<code>/**/</code>或<code>--</code></li><li>与JDBC数据类型映射关系参考<a href="/_posts/java/mybatis.md#MyBatis/Java/Oracle/MySql数据类型对应关系">mybatis.md#MyBatis/Java/Oracle/MySql数据类型对应关系</a></li><li>Mysql数据类型，参考<a href="/_posts/db/sql-optimization.md#数据类型的优化">sql-optimization.md#数据类型的优化</a><ul><li><code>tinyint</code> <strong>超短整型</strong>，存储长度1个字节(即8位，2^8-1，带符号存储区间：-128~127，不带符号存储区间：0~255)<ul><li>tinyint(x) 中的 x 指定的是此列在数据库中的显示宽度，而不是代表它可以存储的最大值的位数</li><li>当 x 的值大于3时，在 SELECT 语句中将显示到该列的完整宽度。这意味着，即使你定义了 tinyint(4) 或 tinyint(10)，它仍然只能存储-128到127之间的数字。虽然 tinyint(4) 比 tinyint(3) 更常见，但是它表示的范围是相同的</li><li>java可使用Boolean那映射，数据库存储为1/0；此时存储0代表false，存储1-9代表true</li><li>也可以使用Java中int类型来接收，这样可以代表实际值</li></ul></li><li><code>smallint</code> 短整型，存储长度为2个字节(2^16-1，-32768〜32767，0〜65535)；java默认使用Integer接收；也可使用Boolean映射，数据库存储为1/0<ul><li>Navicat设置smallint(2)，默认不勾选无符号(保存后重新修改这个2会不显示)，则可写入数据-32768〜32767(如写入32768就报错)，java可使用Boolean或Integer接收</li></ul></li><li><code>mediumint</code> 中整型，存储长度为3个字节(2^24-1，-8388608〜8388607，0〜16777215)</li><li><code>int</code> 整型(Integer)，<strong>存储长度4个字节</strong>(2^32-1，-2147483647~2147483647，0~4294967295)<ul><li>最大显示11个字节，int(1)和int(4)一样会占用4个字节，只是最大显示长度为1，insert超过1个长度的数字还是可以成功的</li></ul></li><li><code>bigint</code> 长正型(Long)，<strong>存储长度为8个字节</strong><ul><li>oracle中: Long不能使用insert into…select…等带select的模式；且不能通过MOVE来传输。尽量不要用LONG类型</li></ul></li><li><code>double</code> 浮点型(Float)，相当于Oracle里的的 number(X, Y)</li><li><code>decimal</code> 金额(Bigdecimal)，相当于Oracle里的的 decimal(X, Y)。decimal(2,1) 表示总数据长度不能超过2位，且小数要占1位，因此最大为9.9</li><li><code>char</code> 定长字符串(String)，同Oracle的char</li><li><code>varchar</code> 变长字符串(String)，最大65535个字节(n代表字符，最大可存放字符数还和编码有关)，相当于Oracle里的的varchar2<ul><li>varchar(n)长度设置问题：<a href="https://www.jianshu.com/p/08eff7720c6f" target="_blank" rel="noopener">https://www.jianshu.com/p/08eff7720c6f</a></li></ul></li><li><code>datetime</code> 日期(DateTime/LocalDateTime)，相当于Oracle里的date</li><li><code>tinytext</code> 短文本型(String)。最大长度255个字节(2^8-1)，存储可变长度的非Unicode数据，可存储textarea中的换行格式(varchar也可存储换行)</li><li><code>text</code> 文本型(String)。最大长度为65535个字节(2^31-1)，其他同tinytext</li><li><code>longtext</code> 长文本型(String)。最大4G，相当于Oracle里的long，其他同tinytext</li><li><code>tinyblob/blob/longblob</code> 二进制数据(byte[])</li><li><code>json</code> JSON格式(String)。大小基于参数max_allowed_packet，参考<a href="/_posts/db/sql-ext.md#JSON数据类型">JSON数据类型</a></li></ul></li><li>Oracle数据结构<ul><li><code>char</code> 定长字符串；存取时效率高，空间可能会浪费</li><li><code>varchar2</code> 变长字符串，大小可达4Kb(4096个字节)；存取时效率高；varchar2支持世界所有的文字，varchar不支持<ul><li><code>varchar2(10)</code> 代表可以保存 10个字节 data_length:10, char_length:10, char_used:B 代表 byte字节</li><li><code>varchar2(10 char)</code> 代表可以保存 10个字符 data_length:40, char_length:10, char_used:C 代表char 字符</li></ul></li><li><code>long</code> 变长字符串，大小可达到2G</li><li><code>number</code> 数字；number(5, 2)表示此数字有5位，其中小数含有2位</li><li><code>date</code> 日期(插入时，sysdate即表示系统当前时间；select时默认展示年月日，要想展示时分秒则需要to_char转换)</li><li>…还有很多，如用来存字节，可以把一张图片存在数据库（但是实际只是存图片存在硬盘，数据库中存图片路径）</li></ul></li><li>VARCHAR(20)与VARCHAR(200)的区别(Oracle中的VARCHAR2原理是一样的)<ul><li>虽然他们用来存储10个字符的数据，其存储空间相同，但是对于内存的消耗是不同的</li><li>硬盘上的存储空间虽然都是根据实际字符长度来分配存储空间的，但是内存是使用固定大小的内存块(即设置的200个字符大小)来保存值，这对于排序或者临时表(这些内容都需要通过内存来实现)作业会产生比较大的不利影响</li><li>MySql创建临时表（SORT，ORDER等）时，VARCHAR会转换为CHAR，转换后的CHAR的长度就是varchar的长度，在内存中的空间就变大了</li></ul></li></ul><h3 id="创建、删除、复制表、更新"><a href="#创建、删除、复制表、更新" class="headerlink" title="创建、删除、复制表、更新"></a>创建、删除、复制表、更新</h3><ul><li>Mysql表相关约束constraint(起名不能为关键字)<ul><li>字段约束，加在字段的末尾加unique</li><li>表约束，加在所有字段末尾</li><li>约束类型：非空、唯一、主键、外键、check</li><li>主键约束：唯一且非空，主键字段可代表一条单独的记录</li><li>外键约束：外键约束是建立在两个字段上的，某一个字段(stu.class)会参考另一个字段(class.id)的值；且被参考的字段必须主键；当被参考的字段已经被参考了，那么则不能删除这条记录</li></ul></li><li><p>创建class班级表和stu学生表示例</p><ul><li><p>class班级表：创建stu表时需要先创建一个班级class的表</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">class</span></span><br><span class="line">(</span><br><span class="line"><span class="keyword">id</span> <span class="built_in">int</span>(<span class="number">4</span>) primary <span class="keyword">key</span>,</span><br><span class="line"><span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">not</span> <span class="literal">null</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure></li><li><p>stu学生表</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> stu<span class="comment">/*由于使用了外键约束，故创建stu表时需要先创建一个班级class的表*/</span></span><br><span class="line">(</span><br><span class="line"><span class="keyword">id</span> <span class="built_in">int</span>(<span class="number">6</span>) primary <span class="keyword">key</span> auto_increment,<span class="comment">/*主键约束(primary key);自动递增(auto_increment)*/</span></span><br><span class="line"><span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">not</span> <span class="literal">null</span>,<span class="comment">/*非空约束,插数据时不能为null*/</span></span><br><span class="line">sex <span class="built_in">int</span>(<span class="number">1</span>),</span><br><span class="line">age <span class="built_in">int</span>(<span class="number">3</span>),</span><br><span class="line">sdate <span class="keyword">timestamp</span>,</span><br><span class="line">grade <span class="built_in">int</span>(<span class="number">2</span>) <span class="keyword">default</span> <span class="number">1</span>,<span class="comment">/*年级默认为1*/</span></span><br><span class="line"><span class="keyword">class</span> <span class="built_in">int</span>(<span class="number">4</span>),</span><br><span class="line">email <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">unique</span>,<span class="comment">/*字段约束;唯一约束,两个NULL值不算重复*/</span></span><br><span class="line"><span class="keyword">constraint</span> stu_class_fk foreign <span class="keyword">key</span>(<span class="keyword">class</span>) <span class="keyword">references</span> <span class="keyword">class</span>(<span class="keyword">id</span>)<span class="comment">/*外键约束;表约束;可以省略constraint stu_class_fk即自己不命名此约束*/</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure></li></ul></li></ul><h4 id="Oracle创建"><a href="#Oracle创建" class="headerlink" title="Oracle创建"></a>Oracle创建</h4><ul><li><p>创建班级表</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">class</span></span><br><span class="line">(</span><br><span class="line"><span class="keyword">id</span> <span class="built_in">number</span>(<span class="number">4</span>) primary <span class="keyword">key</span>,</span><br><span class="line"><span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">not</span> <span class="literal">null</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure></li><li><p>创建学生表</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> stu</span><br><span class="line">(</span><br><span class="line"><span class="keyword">id</span> <span class="built_in">number</span>(<span class="number">6</span>) primary <span class="keyword">key</span>,<span class="comment">/*主键约束；也可加在表级上，如：constraint stu_id_pk primary key(id)*/</span></span><br><span class="line"><span class="keyword">name</span> varchar2(<span class="number">20</span>) <span class="keyword">constraint</span> stu_name_no <span class="keyword">not</span> <span class="literal">null</span>,<span class="comment">/*constraint给约束条件(非空)起名为stu_name_no；非空约束，插数据时不能为null*/</span></span><br><span class="line">sex <span class="built_in">number</span>(<span class="number">1</span>),</span><br><span class="line">age <span class="built_in">number</span>(<span class="number">3</span>),</span><br><span class="line">sdate <span class="built_in">date</span>,</span><br><span class="line">grade <span class="built_in">number</span>(<span class="number">2</span>) <span class="keyword">default</span> <span class="number">1</span>,</span><br><span class="line"><span class="keyword">class</span> <span class="built_in">number</span>(<span class="number">4</span>) <span class="keyword">references</span> <span class="keyword">class</span>(<span class="keyword">id</span>),<span class="comment">/*外键约束；也可加在表级上，如：constraint stu_class_fk foreign key(class) references class(id)*/</span></span><br><span class="line">email varchar2(<span class="number">50</span>),</span><br><span class="line"><span class="keyword">constraint</span> stu_name_email_uni <span class="keyword">unique</span>(email, <span class="keyword">name</span>)<span class="comment">/*表约束，此时表示email和name的组合不能重复*/</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure></li><li><p>Oracle的sequence序列：唯一的自动递增的一列数</p><ul><li><code>create sequence seq;</code> 创建一个序列</li><li><code>drop sequence seq;</code> 删除一个序列</li><li><code>select seq.nextval from dual;</code> 利用sequence中的nextval字段获取序列中的下一个数</li><li>示例：<br> <code>create sequence seq_stu_id start with 1 increment by 1;</code> 产生一个从1开始每次递增1的序列<br> <code>insert into stu values(seq_stu_id.nextval, &#39;name&#39;, 0, 18, sysdate, 1, 1, &#39;oldinaction@qq.com&#39;);</code> sysdate获取系统时间</li></ul></li></ul><h4 id="删除表"><a href="#删除表" class="headerlink" title="删除表"></a>删除表</h4><ul><li>删除表 <code>drop table table_name;</code> 如果存在外键约束，应该先删除含有外键约束的那个表，再删除被参考的那个表(也会删除表结构)</li></ul><h4 id="复制表"><a href="#复制表" class="headerlink" title="复制表"></a>复制表</h4><ul><li><a href="/_posts/db/mysql/mysql-backup-recover.md#Mysql相关语法">复制表结构参考</a></li></ul><h3 id="修改表结构"><a href="#修改表结构" class="headerlink" title="修改表结构"></a>修改表结构</h3><ul><li>添加一个字段 <code>alter table stu add(addr varchar(100));</code></li><li>修改字段类型 <code>alter table stu modify addr varchar(150);</code><ul><li>修改之后的字段容量必须大于原有数据的大小</li></ul></li><li>修改字段名 <code>alter table stu change addr address varchar(50);</code></li><li>Oracle删除、添加表的约束条件<ul><li>删除外键约束 <code>alter table stu drop constraint stu_class_fk;</code></li><li>增加外键约束 <code>alter table stu add constraint stu_class_fk foreign key(class) references class(id);</code></li></ul></li></ul><h3 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h3><ul><li><a href="/_posts/db/mysql-dba.md#索引维护">Mysql索引</a></li><li>Oracle索引<ul><li>当给表加主键或者唯一约束时，Oracle会自动将此字段建立索引；给字段建立索引后，查询快读取慢</li><li><code>create index idx_stu_email on stu(email);</code> 建立索引idx_stu_email</li><li><code>drop index idx_stu_email;</code> 删除索引idx_stu_email</li></ul></li></ul><h3 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h3><ul><li>视图创建：<code>create view 视图名 as 表(通过select子查询得到);</code></li><li><p>Mysql写法</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">view</span> v1 <span class="keyword">as</span> <span class="keyword">select</span> deptno, <span class="keyword">avg</span>(sal) <span class="string">'avg_sal'</span> <span class="keyword">from</span> emp <span class="keyword">group</span> <span class="keyword">by</span> deptno;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">view</span> v2 <span class="keyword">as</span></span><br><span class="line"><span class="keyword">select</span> deptno, avg_sal, grade <span class="keyword">from</span> v1</span><br><span class="line"><span class="keyword">join</span> salgrade s</span><br><span class="line"><span class="keyword">on</span> (v1.avg_sal <span class="keyword">between</span> s.losal <span class="keyword">and</span> s.hisal)</span><br><span class="line">;</span><br></pre></td></tr></table></figure></li><li><p>Oracle写法</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">create</span> <span class="keyword">view</span> v$_view <span class="keyword">as</span></span><br><span class="line"><span class="keyword">select</span> deptno, avg_sal, grade <span class="keyword">from</span></span><br><span class="line">(<span class="keyword">select</span> deptno, <span class="keyword">avg</span>(sal) <span class="string">'avg_sal'</span> <span class="keyword">from</span> emp <span class="keyword">group</span> <span class="keyword">by</span> deptno) t1</span><br><span class="line"><span class="keyword">join</span> salgrade s</span><br><span class="line"><span class="keyword">on</span> (t1.avg_sal <span class="keyword">between</span> s.losal <span class="keyword">and</span> s.hisal)</span><br><span class="line">;</span><br></pre></td></tr></table></figure></li><li><p>Mysql创建视图的select语句不能包含from子句中的子查询，可以创建两次视图。而Oracle可以包含子查询</p></li><li>视图就相当于一个子查询，建立视图可以简化查询、保护数据，但是增加维护难度</li><li>可以更新视图里面的数据，但是更新的是实际中的表的数据，故一般不这么做</li></ul><h3 id="临时表"><a href="#临时表" class="headerlink" title="临时表"></a>临时表</h3><ul><li>创建临时表并复制数据(oracle)<ul><li><code>create global temporary table ybase_tmptable_storage on commit delete rows as select * from ycross_storage where 1=2;</code><ul><li>其中<code>on commit delete rows</code>表示此临时表每次在事物提交的时候清空数据</li></ul></li></ul></li></ul><h3 id="触发器"><a href="#触发器" class="headerlink" title="触发器"></a>触发器</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- sqlplus dba 登录时需要设置用户名</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">TRIGGER</span> smalle.tib_users</span><br><span class="line"><span class="keyword">BEFORE</span> <span class="keyword">INSERT</span> <span class="keyword">ON</span> smalle.users</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="comment">-- :NEW</span></span><br><span class="line"><span class="keyword">END</span>;           </span><br><span class="line">/</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看表下的触发器</span></span><br><span class="line"><span class="keyword">select</span> trigger_name <span class="keyword">from</span> all_triggers <span class="keyword">where</span> table_name=<span class="string">'USERS'</span>;</span><br><span class="line"><span class="comment">-- 查看触发器内容</span></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">text</span> <span class="keyword">from</span> all_source <span class="keyword">where</span> <span class="keyword">type</span>=<span class="string">'TRIGGER'</span> <span class="keyword">AND</span> <span class="keyword">name</span>=<span class="string">'TIB_USERS'</span>;</span><br><span class="line"><span class="comment">-- 编译触发器(有时候报错 ORA-04098: trigger is invalid and failed re-validation 时可重新编译查看错误)</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TRIGGER</span> smalle.tib_users COMPILE; <span class="comment">-- 此时可能只会提示`Warning: Trigger altered with compilation errors.`，不会显示详细错误</span></span><br><span class="line"><span class="comment">-- plsql下查看错误</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">errors</span>;</span><br><span class="line"><span class="comment">-- 或者查看错误信息表(或user_errors)</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> dba_errors t <span class="keyword">where</span> owner = <span class="string">'SMALLE'</span>;</span><br></pre></td></tr></table></figure><h3 id="Oracle数据字典"><a href="#Oracle数据字典" class="headerlink" title="Oracle数据字典"></a>Oracle数据字典</h3><ul><li>描述系统自带的数据字典表 <code>desc dictionary;</code></li><li><code>select * from dictionary;</code><ul><li><code>select table_name from user_tables;</code> 显示当前用户下有哪些表</li><li><code>select view_name from user_views;</code> 显示当前用户下有哪些视图</li><li><code>select constraint_name, table_name from user_constraints;</code> 显示当前用户下有哪些约束</li><li><code>select index_name from user_indexes;</code> 显示当前用户下有哪些索引</li></ul></li></ul><h2 id="数据库操作语言DML-Data-Manipulation-Language，即CRUD"><a href="#数据库操作语言DML-Data-Manipulation-Language，即CRUD" class="headerlink" title="数据库操作语言DML(Data Manipulation Language，即CRUD)"></a>数据库操作语言DML(Data Manipulation Language，即CRUD)</h2><blockquote><p>数据参考下文【数据库表信息】<br>先登录并选择数据库mysql -uroot -proot sqltest<br>先复制表emp、dept、salgrade，如：create table dept2 as select * from dept;</p></blockquote><h3 id="插入记录"><a href="#插入记录" class="headerlink" title="插入记录"></a>插入记录</h3><ul><li>按字段顺序一一插入值 <code>insert into dept2 values(50, &#39;game&#39;, &#39;bj&#39;);</code></li><li>指定部分字段的值 <code>insert into dept2(deptno, dname) values(60, &#39;game2&#39;);</code> 未指定的字段取默认值</li><li>根据从子查询的值插入 <code>insert into dept2 select * from dept;</code> 子查询拿出来的数据和表结构要一样<ul><li><code>insert into tab1(id, name, status) select t.user_id, t.username, &#39;1&#39; from tab2 t where t.sex = 1</code></li></ul></li><li>产生100w条数据</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 1	2018-02-27 10:45:16	64	7SNNAA85AH375N09Y5II	1</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t_test <span class="keyword">as</span></span><br><span class="line">    <span class="keyword">select</span> </span><br><span class="line">        <span class="keyword">rownum</span> <span class="keyword">as</span> <span class="keyword">id</span>,</span><br><span class="line">        to_char(<span class="keyword">sysdate</span> + <span class="keyword">rownum</span> / <span class="number">24</span> / <span class="number">3600</span>, <span class="string">'yyyy-mm-dd hh24:mi:ss'</span>) <span class="keyword">as</span> input_tm,</span><br><span class="line">        trunc(dbms_random.value(<span class="number">0</span>, <span class="number">100</span>)) <span class="keyword">as</span> random_no,</span><br><span class="line">        dbms_random.string(<span class="string">'x'</span>, <span class="number">20</span>) username,</span><br><span class="line">        <span class="number">1</span> <span class="keyword">as</span> is_valid</span><br><span class="line">    <span class="keyword">from</span> dual</span><br><span class="line">    <span class="keyword">connect</span> <span class="keyword">by</span> <span class="keyword">level</span> &lt;= <span class="number">1000000</span>;</span><br></pre></td></tr></table></figure><h3 id="更新记录"><a href="#更新记录" class="headerlink" title="更新记录"></a>更新记录</h3><ul><li><code>update emp2 set sal = sal*2, ename = concat(ename, &#39;_&#39;) where deptno = 10;</code> 把部门编号为10的工资提一倍，并在名称后面加下划线</li><li>Oracle通过pl/sql更新：<code>select * from table_or_view for update;</code> 开启更新模式，然后进行更新并提交</li></ul><h3 id="删除记录-表结构不会删除"><a href="#删除记录-表结构不会删除" class="headerlink" title="删除记录(表结构不会删除)"></a>删除记录(表结构不会删除)</h3><ul><li><code>delete from emp2;</code> 清空表emp2</li><li><code>delete from dept2 where deptno &lt; 25;</code> 删除deptno &lt; 25的条目</li><li><code>delete from emp2 where deptno in (select deptno from dept2 where deptno &lt; 25)</code> 子查询不能有别名(oracle)</li><li><code>truncate table emp2;</code> oracle清空表数据，适用于表中含有大量数据</li></ul><h3 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h3><h4 id="书写顺序"><a href="#书写顺序" class="headerlink" title="书写顺序"></a>书写顺序</h4><ul><li><strong>书写顺序和执行顺序都是按照<code>select-from-where-group by-having-order by-limit</code>进行的</strong></li></ul><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;select count(num) 	/*注释：组函数(group by时，select中的字段都需要时聚合后的)*/</span><br><span class="line">    -&gt;from emp			/*注释：此语句是不能执行的*/</span><br><span class="line">    -&gt;where sal &gt; 1000		/*注释：对数据进行过滤(group by时，where中的字段无需聚合)*/</span><br><span class="line">    -&gt;group by deptno		/*注释：对过滤后的数据进行分组*/</span><br><span class="line">    -&gt;having avg(sal) &gt; 2000	/*注释：对分组后的数据进行限制(group by时，需要聚合)*/</span><br><span class="line">    -&gt;order by deptno desc	/*注释：对结果进行排序(group by时，需要聚合)*/</span><br><span class="line">    -&gt;limit 2,3			/*注释：从第3条数据开始，取3条数据*/</span><br><span class="line">    -&gt;;</span><br></pre></td></tr></table></figure><h4 id="查询-1"><a href="#查询-1" class="headerlink" title="查询"></a>查询</h4><h5 id="基础查询"><a href="#基础查询" class="headerlink" title="基础查询"></a>基础查询</h5><ul><li><code>select ename, sal*12 from emp;</code> 算年薪</li><li><p><code>select now(), curdate() &#39;current date&#39;, 2*3;</code> 显示系统时间和数学计算</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+---------------------+---------------+-----+</span><br><span class="line">| now()               | current date  | 2*3 |</span><br><span class="line">+---------------------+---------------+-----+</span><br><span class="line">| 2015-10-25 13:21:29 | 2015-10-25    |   6 |</span><br><span class="line">+---------------------+---------------+-----+</span><br></pre></td></tr></table></figure><ul><li>oracle获取当前时间和数学计算：<code>select sysdate, 2*3 from dual;</code> (dual为oracle自带的虚表)<ul><li>别名中不能含有特殊字符（如：空格、下划线等）。如果需要含有，则应在别名上加单双引号；Oracle中下划线不需加引号，但是空格需要加引号</li></ul></li></ul></li><li>字符串连接函数<code>concat(字段1,字段2,或者字符串)</code><ul><li>字符串中有单引号时，使用反斜线转义或者用两个单引号表示一个单引号。如<code>select concat(dname,loc,&#39;A&#39;&#39;AA&#39;) from dept;或者select concat(dname,loc,&#39;A\&#39;AA&#39;) from dept;</code></li><li>Oracle中使用<code>||</code>连接字符串，如<code>select dname||loc from dept;</code>。使用两个单引号用来显示字符串中的单引号，如<code>select dname||&#39;A&#39;&#39;AA&#39; from dept;</code></li></ul></li><li><code>select distinct deptno, job from emp;</code> <code>distinct</code>去掉重复的条目(此时是去掉两个字段重复的组合)</li><li><code>select * from emp where job = &#39;clerk&#39; and sal between 1100 and 1500;</code> where过滤<ul><li>可以使用<code>=、&gt;、&lt;、&lt;&gt;</code>等判断大小，其中&lt;&gt;表示不等于，字符串是比较每个字母的ASCII码</li><li><strong>使用<code>between and</code>相当于 <code>&gt;= and &lt;=</code></strong><ul><li><code>between to_date(&#39;2000-01-01&#39;, &#39;yyyy/mm/dd&#39;) and to_date(&#39;2000-01-31&#39;, &#39;yyyy/mm/dd&#39;)</code> 查询的是<code>2000-01-01 00:00:00</code>到<code>2000-01-31 00:00:00</code>的数据(包含这这两个时间点，但是不包含01-31之后的数据)</li></ul></li></ul></li><li><code>select ename, sal, comm from emp where comm is not null;</code> 使用<code>is null</code>或者<code>is not null</code>找出有关空值的条目<ul><li><code>=、!=</code>默认是查询不为空的数据</li></ul></li><li><code>select ename, sal from emp where ename in(&#39;king&#39;, &#39;allen&#39;, &#39;abc&#39;);</code> 使用<code>in()</code>或者<code>not in()</code>表示相应字段的值是否在这些值里面的条目(本质是循环查询)</li><li><code>select ename from emp where ename like &#39;_a%&#39;;</code> like模糊查询<ul><li><code>_</code>代表任意一个字符，<code>%</code>代表任意个字符</li><li>‘%xxx’左like、’xxx%’右like、’%xxx%’两边like</li><li>如果字段中含有特殊字符，需要用反斜线转义，如：<code>like &#39;a\_%&#39;</code> 表示以<code>a_</code>开头的字符串(Oracle 需为<code>like &#39;a\_%&#39; escape &#39;\&#39;</code>)</li><li>也可以修改转义字符，如：<code>select ename from emp where ename like &#39;_*_a%&#39; escape &#39;*&#39;;</code> 将转义字符设为<code>*</code></li></ul></li><li><p><code>select ename, sal, deptno from emp order by deptno asc, ename desc;</code> order by排序(显示按照deptno升序排序，如果deptno相同，再按照ename降序排序)</p><ul><li>默认是asc升序；desc代表降序</li><li><p>order by 语句对null字段的默认排序（可进行设置）</p><ul><li><p>Oracle 结论</p><ul><li>order by colum asc 时，null默认被放在最后</li><li>order by colum desc 时，null默认被放在最前</li><li>nulls first 时，强制null放在最前，不为null的按声明顺序[asc|desc]进行排序</li><li>nulls last 时，强制null放在最后，不为null的按声明顺序[asc|desc]进行排序</li><li><p>对中文排序 [1]</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">                <span class="comment">-- 按中文拼音进行排序: schinese_pinyin_m</span></span><br><span class="line">                <span class="comment">-- 按中文部首进行排序: schinese_radical_m</span></span><br><span class="line">                <span class="comment">-- 按中文笔画进行排序: schinese_stroke_m</span></span><br><span class="line">                <span class="keyword">select</span> * <span class="keyword">from</span> team <span class="keyword">order</span> <span class="keyword">by</span> nlssort(排序字段名, <span class="string">'nls_sort = schinese_pinyin_m'</span>);</span><br><span class="line">                <span class="comment">-- 也可以设置session的或配置的排序策略</span></span><br><span class="line">                <span class="comment">-- 更改配置文件: </span></span><br><span class="line">                <span class="keyword">alter</span> <span class="keyword">system</span> <span class="keyword">set</span> nls_sort=<span class="string">'schinese_pinyin_m'</span> <span class="keyword">scope</span>=<span class="keyword">spfile</span>;</span><br><span class="line">                <span class="comment">-- 更改session: </span></span><br><span class="line">                <span class="keyword">alter</span> <span class="keyword">session</span> <span class="keyword">set</span> nls_sort = schinese_pinyin_m;</span><br><span class="line">                ``` </span><br><span class="line">        - MySql 结论</span><br><span class="line">            - order by colum asc 时，null默认被放在最前</span><br><span class="line">            - order by colum desc 时，null默认被放在最后</span><br><span class="line">            - ORDER BY IF(ISNULL(update_date),0,1) null被强制放在最前，不为null的按声明顺序[asc|desc]进行排序</span><br><span class="line">            - ORDER BY IF(ISNULL(update_date),1,0) null被强制放在最后，不为null的按声明顺序[asc|desc]进行排序</span><br><span class="line">- `<span class="keyword">select</span> <span class="keyword">upper</span>(dname) <span class="keyword">from</span> dept;` `upper(字段)`和`lower(字段)`将相应字段转换成大小写</span><br><span class="line">- `<span class="keyword">select</span> <span class="keyword">substr</span>(dname, <span class="number">2</span>, <span class="number">3</span>) <span class="keyword">from</span> dept;` 截字符串，从第2个字符截取3个字符(包括第2个字符)</span><br><span class="line">- `<span class="keyword">select</span> <span class="keyword">ascii</span>(<span class="string">'A'</span>);`、`<span class="keyword">select</span> <span class="built_in">char</span>(<span class="number">65</span>);` 字符和ascii码转换</span><br><span class="line">    - Oracle中相应的是：`<span class="keyword">select</span> <span class="keyword">chr</span>(<span class="number">65</span>) <span class="keyword">from</span> dual;` 和 `<span class="keyword">select</span> <span class="keyword">ascii</span>(<span class="string">'A'</span>) <span class="keyword">from</span> dual;`</span><br><span class="line">- `<span class="keyword">select</span> <span class="keyword">round</span>(<span class="number">12.753</span>), <span class="keyword">round</span>(<span class="number">12.753</span>, <span class="number">1</span>), <span class="keyword">round</span>(<span class="number">12.753</span>, <span class="number">-1</span>);` round()四舍五入</span><br><span class="line"></span><br><span class="line">    ```html</span><br><span class="line">    +<span class="comment">---------------+------------------+-------------------+</span></span><br><span class="line">    | round(12.753) | round(12.753, 1) | round(12.753, -1) |</span><br><span class="line">    +<span class="comment">---------------+------------------+-------------------+</span></span><br><span class="line">    |            13 |             12.8 |                10 |</span><br><span class="line">    +<span class="comment">---------------+------------------+-------------------+</span></span><br></pre></td></tr></table></figure></li></ul></li></ul></li><li><p>Oracle中为<code>select round(12.753) from dual;</code></p></li></ul></li><li><p><code>select format(sal, 4) from emp;</code> 格式化数据，format(数字,小数点位数)将数字转换成#,###,###,####的格式，以四舍五入的方式保留小数点位数</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">+----------------+</span><br><span class="line">| format(sal, 4) |</span><br><span class="line">+----------------+</span><br><span class="line">| 800.0000       |</span><br><span class="line">| 1,600.0000     |</span><br><span class="line">| 1,250.0000     |</span><br><span class="line">| 2,975.0000     |</span><br><span class="line">+----------------+</span><br></pre></td></tr></table></figure><ul><li>在数字前面加上$、￥等字符则要为<code>select concat(&#39;￥&#39;, format(sal, 4)) from emp;</code></li><li>Oracle中可直接定义格式，如<code>select to_char(sal, &#39;$99,999.9999&#39;) from emp;和select to_char(sal, &#39;L00000.0000&#39;) from emp;</code> 这时L最终显示为￥。还可以转换日期，如：<code>select to_char(hiredate, &#39;YYYY-MM-DD HH24:MI:SS&#39;) from emp;</code> 其中HH24代表24小时制，不要24则为12小时</li></ul></li><li>select date_format(hiredate, ‘%Y-%m-%d %H:%i:%s’) from emp; 格式化日期，其中的说明符参考《MySQL 5.1参考手册》的12.5章 日期和时间函数，1980-12-17 00:00:00<ul><li>Oracle中要使用<code>select to_char(hiredate, &#39;YYYY-MM-DD HH24:MI:SS&#39;) from emp;</code> 其中HH24代表24小时制，不要24则为12小时</li></ul></li><li><code>select ename, hiredate from emp where hiredate &gt; &#39;1982-01-23 00:00:00&#39;;</code> 注意日期格式要和表中的一致(不要时分秒也可比较)<ul><li>Oracle中要使用<code>select ename, hiredate from emp where hiredate &gt; to_date(&#39;1982-01-23 00:00:00&#39;, &#39;YYYY-MM-DD HH24:MI:SS&#39;);</code>、<code>select ename, sal from emp where sal &gt; to_number(&#39;$2,500.00&#39;, &#39;$9,999,99&#39;);</code> 当然就本例子可直接比较，to_numbre只是将此字符串按照某种格式转换成数字，及将$2,500.00转换为2,500.00</li></ul></li><li><code>select ename, sal*12 + ifnull(comm, 0) from emp;</code> 空值转换<code>ifnull(exp1, exp2)</code>，如果exp1不为null,则取exp1的值，否则取exp2的值<ul><li>空值与任何值运算后都为空</li><li>Oracle中使用<code>nvl(exp1, exp2)</code>判断为空后设置默认值,即：<code>select ename, sal*12 + nvl(comm, 0) from cmp;</code></li></ul></li><li>显示指定行记录：<code>limit X, Y</code>（X表示索引为X的那条记录开始，选取Y条记录。索引默认从0开始）<ul><li><code>select ename from emp limit 2, 3;</code> 从第3条记录开始，显示3条记录</li></ul></li><li><p><code>select ename, sal from emp where sal &gt; 2500 order by sal desc limit 2, 3;</code> 按工资倒序排列，再从第3条记录开始，显示3条记录</p><ul><li><p>Oracle默认会在结果集上加一个隐藏字段rownum，指默认排序的第几行。rownum只能与小于或小于等于号连用，不与大于及单独与等于号连用。</p><ul><li><code>select ename, empno from emp where rownum &lt;= 5;</code> 只显示前5行</li><li><code>select ename from (select rownum, ename from emp where rownum &gt; 10);</code> Oracle非要用子查询才能显示rownum大于或等于某个数的条目</li><li><p>按工资倒序排列，再从第3条记录开始，显示3条记录</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> ename, sal <span class="keyword">from</span></span><br><span class="line">(</span><br><span class="line"><span class="keyword">select</span> ename, sal, <span class="keyword">rownum</span> r <span class="keyword">from</span></span><br><span class="line">(<span class="keyword">select</span> ename, sal <span class="keyword">from</span> emp <span class="keyword">where</span> sal &gt; <span class="number">2500</span> <span class="keyword">order</span> <span class="keyword">by</span> sal <span class="keyword">desc</span>) </span><br><span class="line">)</span><br><span class="line"><span class="keyword">where</span> r &gt;= <span class="number">3</span> <span class="keyword">and</span> r &lt;= <span class="number">5</span>;</span><br></pre></td></tr></table></figure></li></ul></li></ul></li></ul><h5 id="组函数"><a href="#组函数" class="headerlink" title="组函数"></a>组函数</h5><ul><li>组函数指输入多条记录，但是只有一条输出<ul><li><code>select max(sal) from emp;</code> 最大值</li><li><code>min(sal)</code> 最小值</li><li><code>avg(sal)</code> 平均值</li><li><code>sum(sal)</code> 求和</li><li><code>count(*)</code> 计算有多少条记录<ul><li>当count某个字段时，空值不会计算在内；而count(*)会把空值的字段计算在内</li></ul></li><li>组函数可以嵌套，但最多只能嵌套两层</li></ul></li><li>group by分组<ul><li><code>select deptno, avg(sal) from emp group by deptno;</code> 求每个部门的平均工资</li><li><code>select deptno, job, max(sal) from emp group by deptno, job;</code> 按照多个字段进行分组</li><li>出现在select列表中的字段，如果没有出现在组函数里面则必须出现在group by子句里面，<strong>或者group by中有主表的id</strong><ul><li>如：<code>select deptno, max(sal) from emp group by deptno;</code> 求每个部门的最高工资。此时是根据部门分组，所有每个部门都只有一条输出</li><li>如：<code>select w.work_no from d_work w left join d_work_tag wt on wt.work_id = w.id group by w.id</code></li></ul></li><li>部分情况下，Group By跟上唯一主键或者唯一索引，可省略其他字段的group by。参考：<a href="https://blog.csdn.net/weixin_42919267/article/details/105770776" target="_blank" rel="noopener">https://blog.csdn.net/weixin_42919267/article/details/105770776</a></li></ul></li><li>having对group by 分组后的结果进行限制<ul><li><code>select deptno, avg(sal) from emp group by deptno having avg(sal) &gt; 2000;</code> 求部门平均工资大于2000的部门</li></ul></li></ul><h5 id="表连接"><a href="#表连接" class="headerlink" title="表连接"></a>表连接</h5><ul><li>交叉连接(cross join)，又称笛卡尔连接，如果每个表分别具有n和m行，则结果集将具有n*m行。如：<code>select ename, dname from emp cross join dept;</code></li><li>等值连接，如：<code>select ename, dname from emp join dept on (emp.deptno = dept.deptno);</code></li><li><p>多表连接，如：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select ename, dname, grade, e.deptno from emp e</span><br><span class="line">-&gt; join dept d on (e.deptno = d.deptno)</span><br><span class="line">-&gt; join salgrade s on (e.sal between s.losal and s.hisal)</span><br><span class="line">-&gt; where ename like '_l%';</span><br></pre></td></tr></table></figure><ul><li>*注意：此处deptno多个表含有此字段，所有e.deptno必须明确指明字段的表名，否则报错ERROR 1052</li><li><p>结果</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+-------+------------+-------+--------+</span><br><span class="line">| ename | dname      | grade | deptno |</span><br><span class="line">+-------+------------+-------+--------+</span><br><span class="line">| allen | sales      |     3 |     30 |</span><br><span class="line">| blake | sales      |     4 |     30 |</span><br><span class="line">| clark | accounting |     4 |     10 |</span><br><span class="line">+-------+------------+-------+--------+</span><br></pre></td></tr></table></figure></li></ul></li><li><p>自连接，即为同一张表起不同的别名，然后把它当成两种表来用，如求每个人相应经理人的名字。此时没有king，因为king没有经理人，可采用外连接解决：<code>select e1.ename, e2.ename from emp e1 join emp e2 on (e1.mgr = e2.empno);</code></p></li><li>左、右、全外连接，left join、right join、full join。<ul><li>left join和left outer join都表示左外连接，如果两个表进行连接，且连接后左边一个表中的数据不能显示出来，此时可以使用左连接(此时的king)。如：<code>select e1.ename, e2.ename from emp e1 left join emp e2 on (e1.mgr = e2.empno);</code></li></ul></li><li><code>left join</code>(以左边表为主)、<code>right join</code>(以右边表为主)、<code>inner join</code>(只显示on条件成立的)、<code>full join</code>(显示所有数据)、<code>join</code>(默认是inner join)</li><li><strong>关联表时，and的位置</strong><ul><li><code>left join/right join</code> 当<code>and</code>在<code>on</code>的后面只是对关联表的过滤(主表记录默认全部取出。如果能通过on和and关联上副表最好，关联不上则副表对应字段为Null)，当<code>and</code>在<code>where</code>后面则是对关联之后的视图进行过滤(会影响主表记录的条数)</li><li><code>join</code> 不管<code>and</code>在什么位置都会影响主表记录的条数</li></ul></li><li>Oracle <code>select 1 as a, t.b, t.c from dual left join (select 2 as b, 3 as c from dual) t on 1=1</code> 可返回a,b,c三个字段的值。(join必须要有一个on)</li></ul><h5 id="子查询"><a href="#子查询" class="headerlink" title="子查询"></a>子查询</h5><ul><li>可以把子查询当成查询到的一张表（<strong>子查询连接到主查询上时，子查询内部无法拿到主查询数据</strong>）</li><li>求出所有雇员中工资最高的那个人<ul><li>正确写法=&gt;<code>select ename, sal from emp where sal = (select max(sal) from emp);</code> 利用的子查询</li><li>错误写法=&gt;<code>select ename, max(sal) from emp;</code>因为max(sal)只有一行输出，但是可能有很多人的工资都是一样的最高，所以不匹配。此时Oracle会报错，但是Mysql可以显示，但是结果是错误的</li></ul></li><li>哪些人的工资位于所有人平均工资之上<code>select ename, sal from emp where sal &gt; (select avg(sal) from emp);</code></li><li>在from语句中的子查询需要起一个表的别名(Oracle可不写)，否则Mysql报ERROR 1248错误。子查询得到的表接在where语句中不需要别名，但如果把它当做一个值则需要加括号<ul><li>部门平均工资中最高的。此时不起别名(t)则报错，但是Oracle不会报错<code>select max(avg_sal) from (select deptno, avg(sal) &#39;avg_sal&#39; from emp group by deptno) t;</code></li></ul></li></ul><h5 id="子查询和表连接举例"><a href="#子查询和表连接举例" class="headerlink" title="子查询和表连接举例"></a>子查询和表连接举例</h5><ul><li><strong>子查询连接到主查询上时，子查询内部无法拿到主查询数据</strong></li><li><p>按照部门分组之后每个部门工资最高的那个人</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select ename, sal from emp</span><br><span class="line">    -&gt; join (select max(sal) 'max_sal', deptno from emp group by deptno) t	/*注释：将通过子查询得到的一张表命名为t*/</span><br><span class="line">    -&gt; on (emp.sal = t.max_sal and emp.deptno = t.deptno);</span><br></pre></td></tr></table></figure></li><li><p>求每个部门平均薪水的薪水等级</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select deptno, avg_sal, grade from</span><br><span class="line">    -&gt; (select deptno, avg(sal) 'avg_sal' from emp group by deptno) t</span><br><span class="line">    -&gt; join salgrade s on (t.avg_sal between s.losal and s.hisal);</span><br></pre></td></tr></table></figure><ul><li>其中deptno和avg_sal是从(select deptno, avg(sal) ‘avg_sal’ from emp group by deptno)中得到</li></ul></li><li><p>求每个部门平均的薪水等级（每个人的薪水等级的平均）</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select deptno, avg(grade) from</span><br><span class="line">    -&gt; (select deptno, grade from emp join salgrade s on (emp.sal between s.losal and s.hisal)) t group by deptno;</span><br></pre></td></tr></table></figure></li><li><p>求出那些人是经理人<code>select ename from emp where empno in(select distinct mgr from emp);</code></p></li><li>不准用组函数，求工资最高值(面试题) <code>select sal from emp where sal not in (select distinct e1.sal from emp e1 join emp e2 on (e1.sal &lt; e2.sal));</code></li><li><p>求平均工资最高的部门编号</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*正确写法*/</span></span><br><span class="line"><span class="keyword">select</span> deptno, avg_sal <span class="keyword">from</span></span><br><span class="line">(<span class="keyword">select</span> deptno, <span class="keyword">avg</span>(sal) <span class="string">'avg_sal'</span> <span class="keyword">from</span> emp <span class="keyword">group</span> <span class="keyword">by</span> deptno) t1 <span class="comment">/*注释：虽然t1、t2都没有使用也要加别名*/</span></span><br><span class="line"><span class="keyword">where</span> avg_sal =</span><br><span class="line">(<span class="keyword">select</span> <span class="keyword">max</span>(avg_sal) <span class="keyword">from</span> (<span class="keyword">select</span> deptno, <span class="keyword">avg</span>(sal) <span class="string">'avg_sal'</span> <span class="keyword">from</span> emp <span class="keyword">group</span> <span class="keyword">by</span> deptno) t2); <span class="comment">/*注释：此时要加括号，把这段话当成一个最大平均值*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*错误写法*/</span></span><br><span class="line"><span class="keyword">select</span> deptno, <span class="keyword">max</span>(avg_sal) <span class="keyword">from</span> (<span class="keyword">select</span> deptno, <span class="keyword">avg</span>(sal) <span class="string">'avg_sal'</span> <span class="keyword">from</span> emp <span class="keyword">group</span> <span class="keyword">by</span> deptno) t;<span class="comment">/*如果三个部门的平均值一样，则deptno有多个值，而max(sal)只有一个值*/</span></span><br></pre></td></tr></table></figure></li><li><p>求平均工资最高的部门名称</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> dname <span class="keyword">from</span> dept <span class="keyword">where</span> deptno =</span><br><span class="line">(</span><br><span class="line">    <span class="keyword">select</span> deptno <span class="keyword">from</span></span><br><span class="line">        (<span class="keyword">select</span> deptno, <span class="keyword">avg</span>(sal) <span class="string">'avg_sal'</span> <span class="keyword">from</span> emp <span class="keyword">group</span> <span class="keyword">by</span> deptno) t1 <span class="comment">/*注释：虽然t1、t2都没有使用也要加别名*/</span></span><br><span class="line">    <span class="keyword">where</span> avg_sal =</span><br><span class="line">        (<span class="keyword">select</span> <span class="keyword">max</span>(avg_sal) <span class="keyword">from</span> (<span class="keyword">select</span> deptno, <span class="keyword">avg</span>(sal) <span class="string">'avg_sal'</span> <span class="keyword">from</span> emp <span class="keyword">group</span> <span class="keyword">by</span> deptno) t2)</span><br><span class="line">);</span><br></pre></td></tr></table></figure></li><li><p>求平均工资的等级最低的部门的部门名称</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> dname <span class="keyword">from</span> dept <span class="keyword">where</span> deptno =</span><br><span class="line">(<span class="keyword">select</span> deptno <span class="keyword">from</span> </span><br><span class="line">    (<span class="keyword">select</span> deptno, avg_sal, grade <span class="keyword">from</span></span><br><span class="line">        (<span class="keyword">select</span> deptno, <span class="keyword">avg</span>(sal) <span class="string">'avg_sal'</span> <span class="keyword">from</span> emp <span class="keyword">group</span> <span class="keyword">by</span> deptno) t1</span><br><span class="line">        <span class="keyword">join</span> salgrade s</span><br><span class="line">        <span class="keyword">on</span> (t1.avg_sal <span class="keyword">between</span> s.losal <span class="keyword">and</span> s.hisal)</span><br><span class="line">    ) t2 </span><br><span class="line">    <span class="keyword">where</span> grade =</span><br><span class="line">    (<span class="keyword">select</span> <span class="keyword">min</span>(grade) <span class="keyword">from</span> </span><br><span class="line">        (<span class="keyword">select</span> deptno, avg_sal, grade <span class="keyword">from</span></span><br><span class="line">            (<span class="keyword">select</span> deptno, <span class="keyword">avg</span>(sal) <span class="string">'avg_sal'</span> <span class="keyword">from</span> emp <span class="keyword">group</span> <span class="keyword">by</span> deptno) t1</span><br><span class="line">        <span class="keyword">join</span> salgrade s</span><br><span class="line">        <span class="keyword">on</span> (t1.avg_sal <span class="keyword">between</span> s.losal <span class="keyword">and</span> s.hisal)</span><br><span class="line">        ) t2 <span class="comment">/*注释：第二次用到t2这个"表"时，不能只写一个t2，要和前面一样将语句都写出来。但可以使用"视图"简化*/</span></span><br><span class="line">    )</span><br><span class="line">);</span><br></pre></td></tr></table></figure><ul><li><p>使用视图后：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">view</span> v1 <span class="keyword">as</span> <span class="keyword">select</span> deptno, <span class="keyword">avg</span>(sal) <span class="string">'avg_sal'</span> <span class="keyword">from</span> emp <span class="keyword">group</span> <span class="keyword">by</span> deptno;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">view</span> v2 <span class="keyword">as</span></span><br><span class="line"><span class="keyword">select</span> deptno, avg_sal, grade <span class="keyword">from</span> v1</span><br><span class="line"><span class="keyword">join</span> salgrade s</span><br><span class="line"><span class="keyword">on</span> (v1.avg_sal <span class="keyword">between</span> s.losal <span class="keyword">and</span> s.hisal)</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> dname <span class="keyword">from</span> dept <span class="keyword">where</span> deptno =</span><br><span class="line">(<span class="keyword">select</span> deptno <span class="keyword">from</span> v2</span><br><span class="line">    <span class="keyword">where</span> grade =</span><br><span class="line">    (<span class="keyword">select</span> <span class="keyword">min</span>(grade) <span class="keyword">from</span> v2</span><br><span class="line">    )</span><br><span class="line">);</span><br></pre></td></tr></table></figure></li></ul></li><li><p>比普通员工最高工资还要高的经理人名称</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> ename, sal <span class="keyword">from</span> emp</span><br><span class="line"><span class="keyword">where</span> empno <span class="keyword">in</span> (<span class="keyword">select</span> <span class="keyword">distinct</span> mgr <span class="keyword">from</span> emp <span class="keyword">where</span> mgr <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>)</span><br><span class="line"><span class="keyword">and</span> sal &gt;</span><br><span class="line">(<span class="keyword">select</span> <span class="keyword">max</span>(sal) <span class="keyword">from</span> emp <span class="keyword">where</span> empno <span class="keyword">not</span> <span class="keyword">in</span> (<span class="keyword">select</span> <span class="keyword">distinct</span> mgr <span class="keyword">from</span> emp <span class="keyword">where</span> mgr <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>));</span><br></pre></td></tr></table></figure></li><li><p>将薪水大于1200的雇员按照部门进行分组，分组后的平均薪水必须大于1500，查询分组之内的平均工资并按照平均工资的倒序进行排列<br><code>select deptno, avg(sal) from emp where sal &gt; 1200 group by deptno having avg(sal) &gt; 1500 order by avg(sal) desc limit 1,2;</code></p></li></ul><h5 id="oracle分页"><a href="#oracle分页" class="headerlink" title="oracle分页"></a>oracle分页</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 无分页</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> t_customer_line;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 无order by分页</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> </span><br><span class="line">    (<span class="keyword">select</span> <span class="keyword">rownum</span> <span class="keyword">as</span> rowno, t.* <span class="keyword">from</span> emp t <span class="keyword">where</span> <span class="keyword">rownum</span> &lt;= <span class="number">10</span>) a </span><br><span class="line"><span class="keyword">where</span> a.rowno &gt; <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 有order by分页</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> </span><br><span class="line">    (<span class="keyword">select</span> tt.*, <span class="keyword">rownum</span> <span class="keyword">as</span> rowno <span class="keyword">from</span> </span><br><span class="line">        (<span class="keyword">select</span> t.* <span class="keyword">from</span> emp t <span class="keyword">order</span> <span class="keyword">by</span> create_time <span class="keyword">desc</span>) tt </span><br><span class="line">    <span class="keyword">where</span> <span class="keyword">rownum</span> &lt;= <span class="number">20</span>) a </span><br><span class="line"><span class="keyword">where</span> a.rowno &gt; <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 分页并返回总条数</span></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line">    <span class="keyword">from</span> (<span class="keyword">select</span> <span class="keyword">rownum</span> <span class="keyword">as</span> rn, paging_t1.*</span><br><span class="line">            <span class="keyword">from</span> (<span class="keyword">select</span> t.*, <span class="keyword">count</span>(*) <span class="keyword">over</span>() paging_total</span><br><span class="line">                    <span class="keyword">from</span> emp t</span><br><span class="line">                    <span class="keyword">order</span> <span class="keyword">by</span> t.id) paging_t1</span><br><span class="line">            <span class="keyword">where</span> <span class="keyword">rownum</span> &lt;= <span class="number">20</span>) paging_t2</span><br><span class="line">    <span class="keyword">where</span> paging_t2.rn &gt; <span class="number">10</span>;</span><br></pre></td></tr></table></figure><h4 id="union-union-all合集"><a href="#union-union-all合集" class="headerlink" title="union/union all合集"></a>union/union all合集</h4><ul><li>UNION(或 UNION ALL) 操作符用于合并两个或多个 SELECT 语句的结果集，需注意<ul><li>UNION 内部的 SELECT 语句必须拥有<strong>相同数量的列</strong></li><li>列也必须拥有<strong>相似的数据类型</strong></li><li>每条 SELECT 语句中的<strong>列的顺序必须相同</strong></li><li>UNION 结果集中的列名总是等于 UNION 中第一个 SELECT 语句中的列名</li></ul></li><li>UNION ALL 允许重复值，而 UNION 会进行去重。如果业务允许重复值，则优先使用 UNION ALL</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- oracle 得到 a=[1, 2]</span></span><br><span class="line"><span class="keyword">select</span> <span class="number">1</span> <span class="keyword">as</span> a <span class="keyword">from</span> dual <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">2</span> <span class="keyword">as</span> b <span class="keyword">from</span> dual;</span><br></pre></td></tr></table></figure><h4 id="intersect交集"><a href="#intersect交集" class="headerlink" title="intersect交集"></a>intersect交集</h4><h4 id="except差集"><a href="#except差集" class="headerlink" title="except差集"></a>except差集</h4><h2 id="Mysql-事物"><a href="#Mysql-事物" class="headerlink" title="(Mysql)事物"></a>(Mysql)事物</h2><ul><li>事物sql</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--查看是否是自动提交 1表示开启(默认)，0表示关闭</span></span><br><span class="line"><span class="keyword">select</span> @@autocommit;</span><br><span class="line"><span class="comment">--设置关闭</span></span><br><span class="line"><span class="keyword">set</span> autocommit = <span class="number">0</span>;</span><br><span class="line"><span class="comment">-- 开始事物</span></span><br><span class="line"><span class="keyword">start</span> <span class="keyword">transaction</span>;</span><br><span class="line"><span class="comment">-- Mysql和Oracle提交事物`commit;`；Oracle的撤销操作`rollback;`</span></span><br><span class="line"><span class="keyword">commit</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 设置当前session的隔离级别</span></span><br><span class="line"><span class="keyword">set</span> <span class="keyword">session</span> <span class="keyword">transaction</span> <span class="keyword">isolation</span> <span class="keyword">level</span> <span class="keyword">read</span> uncommitted;</span><br></pre></td></tr></table></figure><ul><li>ACID <a href="https://www.cnblogs.com/kismetv/p/10331633.html" target="_blank" rel="noopener">^4</a><ul><li>A原子性：innodb通过undo log实现</li><li>I隔离性：通过锁实现</li><li>D持久性：innodb通过redo log实现</li><li>C一致性：通过上述AID实现</li></ul></li><li>隔离级别<ul><li>产生数据不一致的情况：脏读、不可重复读、幻读<ul><li>脏读：读到了其他事物未提交的数据</li><li>不可重复读：第一次读取记录后，其他事物修改了此记录，再次读取此记录发现数据变化了</li><li>幻读：第一次读取记录发现没有id=10的行，但是在插入id=10时提示已存在此行，尽管再次读取还是没有id=10<ul><li>mysql 的幻读并非指读取两次返回结果集不同；而是事务在插入前会先检测记录是否存在(mysql插入时会隐式读取一次)，惊奇的发现这些数据已经存在了，之前的”检测读”获取到的数据如同鬼影一般。<strong>不可重复读侧重表达<code>读-读</code>，幻读则是说<code>读-写</code>，用写来证实读的是鬼影</strong></li></ul></li></ul></li><li>从上往下，隔离级别越来越高，意味着数据越来越安全<ul><li><code>read uncommitted</code> 读未提交。会出现脏读、不可重复读、幻读</li><li><code>read commited</code> 读已提交(oracle默认级别)。会出现不可重复读、幻读</li><li><code>repeatable read</code> 可重复读(mysql默认级别)。会出现幻读</li><li><code>seariable</code> 序列化执行，串行执行</li></ul></li></ul></li><li>Oracle的transaction(事物)<ul><li>一个transaction起始于一个dml(增删查改)语句</li><li>当执行撤销”rollback;”后，回到最原始状态，相当于此transaction结束；或当执行提交”commit;”后，此transaction结束（此时在撤销则不能回到原始状态）</li><li>当执行一个ddl语句(如：创建表create table)或者一个dcl语句(如：设置权限grant)后，transaction也自动结束</li></ul></li></ul><h2 id="Mysql日志原理"><a href="#Mysql日志原理" class="headerlink" title="Mysql日志原理"></a>Mysql日志原理</h2><ul><li>参考文章 <a href="http://zhongmingmao.me/2019/01/15/mysql-redolog-binlog/" target="_blank" rel="noopener">^2</a></li></ul><h3 id="InnoDB日志-Redo-Undo"><a href="#InnoDB日志-Redo-Undo" class="headerlink" title="InnoDB日志(Redo/Undo)"></a>InnoDB日志(Redo/Undo)</h3><ul><li><code>Redo log</code> (重做日志)和 <code>Undo log</code> 都是innodb存储引擎才有日志文件</li><li><code>Redo Log</code> 是为了实现数据持久性<ul><li><strong>当发生数据修改的时候， innodb引擎会先将数据更新内存并写到redo log(buffer)中，此时更新就算是完成了</strong>；同时innodb引擎会在合适的时机将记录操作到磁盘中</li><li>redo log是<strong>固定大小</strong>的，是<strong>循环写</strong>的过程，空间会用完(可通过参数配置其大小)<ul><li>如果redolog太小，会导致很快被写满，然后就不得不强行刷redolog，这样WAL机制(见下文)的能力就无法发挥出来。如果磁盘能达到几TB，那么可以将redolog设置4个一组，每个日志文件大小为1GB，写到3号文件末尾后就回到0号文件开头。<code>show variables like &#39;%innodb_log_file%&#39;;</code>查看单个文件的大小</li></ul></li><li>redo log是<strong>物理日志</strong>，数据页中为真实二级制数据，恢复速度快</li><li>innodb存储引擎数据的单位是页，redo log也是基于页进行存储，一个默认16K大小的页中存了很多512Byte的log block，log block的存储格式如[log block header 12Byte，log block body 492 Bytes，log block tailer 8 Bytes]</li><li>用途是重做数据页。有了redo log之后，innodb就可以保证即使数据库发生异常重启，之前的记录也不会丢失，系统会自动恢复之前记录，叫做crash-safe(不包含误删数据的恢复)</li><li>参考：<a href="https://zhuanlan.zhihu.com/p/587553430" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/587553430</a></li></ul></li><li><p>既然要避免io，为什么写redo log的时候不会造成io的问题？</p><p> <img src="/data/images/db/mysql-redo-log.png" alt="mysql-redo-log.png"></p><ul><li>如果每次更新操作都需要直接写入磁盘 <strong>(在磁盘中找到相关的记录并更新)</strong>，整个过程的IO成本和查找成本都很高。针对这种情况，MySQL采用的是WAL技术（Write-Ahead Logging）：先写日志，再写磁盘(虽然写日志也是写到磁盘，但是不用考虑原数据的位置)</li><li>内部是基于缓存实现，可先将数据写到log buffer。为了确保每次日志都能写入到事务日志文件中，之后操作系统定期调用fsync(等待写磁盘操作结束，然后返回)写入到磁盘</li><li>图二中<ul><li>控制commit动作是否刷新log buffer到磁盘，可通过变量 <code>innodb_flush_log_at_trx_commit</code> 的值来决定。该变量有3种值：0、1、2，默认为1<ul><li>0：事务提交时仅写到log buffer，然后每秒写入os buffer并调用fsync()写入到log file on disk中。也就是说设置为0时是(大约)每秒刷新写入到磁盘中的，<strong>因此实例crash将最多丢失1秒钟内的事务</strong></li><li>1：<strong>默认值</strong>。事务每次提交都会将log buffer中的日志写入os buffer，并调用fsync()刷到log file on disk中。<strong>这种方式即使宕机也不会丢失任何数据</strong>，但是因为每次提交都写入磁盘，IO的性能较差</li><li>2：直接写入到os buffer(page cache)，由os自己决定什么时候同步到磁盘文件。<strong>因此实例crash不会丢失事务，但宕机则可能丢失事务</strong></li></ul></li><li>另外，InnoDB存储引擎有一个后台线程，每隔1秒，就会把 Redo Log Buffer 中的内容写到文件系统缓存( page cache)，然后调用刷盘操作</li><li>安全性：1 &gt; 2 &gt; 0</li><li>效率：0 &gt; 2 &gt; 1</li></ul></li></ul></li><li>Undo Log是为了实现事务的原子性，在MySQL数据库InnoDB存储引擎中，还用Undo Log来实现多版本并发控制(简称MVCC)<ul><li>在操作任何数据之前，首先将数据备份到一个地方（这个存储数据备份的地方称为Undo Log），然后进行数据的修改。如果出现了错误或者用户执行了ROLLBACK语句，系统可以利用Undo Log中的备份将数据恢复到事务开始之前的状态</li><li>Undo log是<strong>逻辑日志</strong>，可以理解为<ul><li>当insert一条记录时，undo log中会记录一条对应的delete记录</li><li>当update一条记录时，它记录一条对应相反的update记录</li><li>当delete一条记录时，undo log中会记录一条对应的insert记录</li></ul></li></ul></li></ul><h3 id="服务端的日志Binlog"><a href="#服务端的日志Binlog" class="headerlink" title="服务端的日志Binlog"></a>服务端的日志Binlog</h3><ul><li>Binlog(归档日志)是server层的日志，因此和存储引擎无关，其主要做mysql功能层面的事情</li><li>与Redo日志的区别<ul><li>redo是innodb独有的， binlog是所有引擎都可以使用的</li><li>redo是物理日志，记录的是在某个数据页上做了什么修改，<strong>binlog是逻辑日志（也是二进制格式）</strong>，记录的是这个语句的原始逻辑</li><li>redo是循环写的，空间会用完；<strong>binlog是可以追加写的</strong>，不会覆盖之前的日志信息</li></ul></li><li>sync_binlog 参数来控制数据库的binlog刷到磁盘上去方式。参考<a href="/_posts/db/sql-optimization.md#服务器参数设置">服务器参数设置</a></li><li>有两份日志的历史原因<ul><li>一开始并没有InnoDB，采用的是MyISAM，但MyISAM没有crash-safe的能力，binlog日志只能用于归档</li><li>InnoDB是以插件的形式引入到MySQL的，为了实现crash-safe，InnoDB采用了redolog的方案</li></ul></li><li>binlog一开始的设计就是不支持崩溃恢复(原库)的，如果不考虑搭建从库等操作，binlog是可以关闭的(<code>show variables like &#39;%sql_log_bin%&#39;;</code>)<ul><li>redolog主要用于crash-safe(原库恢复)，binlog主要用于恢复成临时库(从库)</li><li>数据从 A-B-C 后，可根据binlog选择恢复的位置</li></ul></li><li>一般在企业中数据库会有备份系统，可以定期执行备份，备份的周期可以自己设置。恢复数据的过程<ul><li>到最近一次的全量备份数据</li><li>从备份的时间点开始，将备份的binlog取出来，重放到要恢复的那个时刻</li></ul></li></ul><h3 id="数据更新的流程-2PC"><a href="#数据更新的流程-2PC" class="headerlink" title="数据更新的流程(2PC)"></a>数据更新的流程(2PC)</h3><p><img src="/data/images/db/mysql-innodb-update.png" alt="mysql-innodb-update.png"></p><ul><li>执行流程<ul><li>执行器先从存储引擎中查找数据。存储引擎查找时，如果在内存中直接返回，如果不在内存中，查询后返回</li><li>执行器拿到数据之后会先修改数据，然后调用引擎接口重新写入数据</li><li>存储引擎将数据更新到内存，同时写数据到redo中，此时处于prepare阶段，并通知执行器执行完成，随时可以操作</li><li>执行器生成这个操作的binlog</li><li>执行器调用引擎的事务提交接口，引擎把刚刚写完的redo改成commit状态，更新完成</li></ul></li><li>Redo log的两阶段提交(2PC)<ul><li>prepare：redolog写入log buffer，并fsync持久化到磁盘，在redolog事务中记录2PC的XID，在redolog事务打上prepare标识</li><li>commit：binlog写入log buffer，并fsync持久化到磁盘，在binlog事务中记录2PC的XID，同时在redolog事务打上commit标识</li><li>其中，prepare和commit阶段所提到的事务，都是指内部XA事务，即2PC。且此事物是包含在begin…commit的内部</li><li>崩溃恢复过程<ul><li>redolog prepare + binlog成功，提交事务</li><li>redolog prepare + binlog失败，回滚事务</li><li>崩溃恢复后是会从checkpoint开始往后主动刷数据<ul><li>checkpoint是当前要擦除的位置，擦除记录前需要先把对应的数据落盘</li><li>write pos到checkpoint之间的部分可以用来记录新的操作。checkpoint到write pos之间的部分等待落盘，恢复数据也是恢复这一部分</li></ul></li></ul></li><li>原因<ul><li>可以使用binlog替代redolog进行数据恢复吗？<ul><li>不可以。innodb利用wal技术进行数据恢复，write ahead logging技术依赖于物理日志进行数据恢复，binlog不是物理日志是逻辑日志，因此无法使用</li></ul></li><li>可以只使用redolog而不使用binlog吗？<ul><li>不可以。redolog是循环写，写到末尾要回到开头继续写，这样的日志无法保留历史记录，无法进行数据复制</li></ul></li><li>为什么redolog和binlog要进行二阶段提交？<ul><li>如果redo log持久化并进行了提交，而binlog未持久化数据库就crash了，则从库从binlog拉取数据会少于主库，造成不一致。因此需要内部事务来保证两种日志的一致性</li></ul></li></ul></li></ul></li></ul><h2 id="SQLServer"><a href="#SQLServer" class="headerlink" title="SQLServer"></a>SQLServer</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><ul><li>SQL Server版本<ul><li>包含Express(完整版)、Develop</li><li>v10=2008, v12=2014, v13=2016, v14=2017</li></ul></li><li><code>SQL Server Management Studio</code> (SSMS) 类似PL/SQL Develop</li><li>安装是可注意下是否有开启”SQLserver 和windows 身份验证模式”，有则勾选，没有则需要通过SSMS之后进行设置</li><li>安装成功后使用<ul><li>安装成功后会提示链接字符串如<code>Server=localhost\SQLEXPRESS;Database=master;Trusted_Connection=True;</code>，此时链接时设置主机=localhost\SQLEXPRESS，初始数据库=master，验证=Windows验证即可连接</li><li>开启sa账号登录<ul><li>使用SSMS，先通过windows 身份验证进行连接</li><li>安全性 - 登录名 - sa - 设置sa的密码 - 取消强制密码策略 - 状态：启动此登录名登录</li><li>设置SQLserver 和windows 身份验证模式：右键连接 - 属性 - 安全性 - 进行设置后重启服务(获取重启机器)</li></ul></li><li>设置内网访问<ul><li>开始菜单中找到SQLServer Configuration Manager(配置管理器) - SQL Server 网络配置 - 选择实例 - TCP/IP右键启用 - TCP/IP双击 - IP地址 - 找到需要开启的IP地址，设置TCP端口为1433，并设置已启动为是 - 修改最下面的IPALL中IP端口为1433</li><li>继续配置管理器 - SQL Server服务 - 选择实例 - 右键重启即可</li></ul></li></ul></li></ul><h3 id="sqlcmd"><a href="#sqlcmd" class="headerlink" title="sqlcmd"></a>sqlcmd</h3><ul><li>sqlcmd命令行执行（是sqlserver自带的命令行工具）</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CMD命令行导入sql文件. windows上文件路径必须用右斜杠</span></span><br><span class="line">sqlcmd -S localhost -U sa -P sa -d fedex -i C:\Users\smalle\Desktop\update20190528.sql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 连接数据库。出现 1&gt; 表示连接成功</span></span><br><span class="line"><span class="comment"># 等同于 `osql -S 192.168.1.100 -U sa -P sa`</span></span><br><span class="line"><span class="comment"># `osql ?/` 查看命令帮助</span></span><br><span class="line">sqlcmd -S localhost -U sa -P sa</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看数据. 在第二行输入 go 回车才会执行</span></span><br><span class="line">select name from master.dbo.sysdatabases</span><br><span class="line">go</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入数据库</span></span><br><span class="line">use master</span><br><span class="line">go</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看数据表</span></span><br><span class="line">select name from sysobjects <span class="built_in">where</span> xtype=<span class="string">'U'</span></span><br><span class="line">go</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看数据表中的列</span></span><br><span class="line">select c.name,c.length from syscolumns c inner join sysobjects t on c.id = t.id and t.name=<span class="string">'spt_monitor'</span></span><br><span class="line">go</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看数据</span></span><br><span class="line">select * from t_test</span><br><span class="line">go</span><br></pre></td></tr></table></figure><h3 id="DBCC"><a href="#DBCC" class="headerlink" title="DBCC"></a>DBCC</h3><ul><li>DBCC是SQL Server提供的一组控制台命令</li><li>常用. 参考：<a href="https://www.cnblogs.com/lilycnblogs/archive/2011/03/31/2001372.html" target="_blank" rel="noopener">https://www.cnblogs.com/lilycnblogs/archive/2011/03/31/2001372.html</a></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## DBCC 帮助类命令</span></span><br><span class="line">DBCC HELP(<span class="string">'?'</span>) <span class="comment"># 查询所有的DBCC命令</span></span><br><span class="line">DBCC HELP(<span class="string">'命令'</span>) <span class="comment"># 查询指定的DBCC命令的语法说明</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## DBCC跟踪标记. 跟踪标志参考：https://www.cnblogs.com/Sungeek/p/11843178.html</span></span><br><span class="line"><span class="comment"># 打开 3604 跟踪标志，会记录到日志，通过 `EXEC master..xp_readerrorlog` 可查看日志</span></span><br><span class="line">DBCC TRACEON (3604)</span><br><span class="line"><span class="comment"># 全局(-1)打开 1204(返回参与死锁的锁的资源和类型，以及受影响的当前命令)、1222(以不符合任何 XSD 架构的 XML 格式，返回参与死锁的锁的资源和类型，以及受影响的当前命令) 类型跟踪标志。开启以后，会打印死锁日志到errorlog</span></span><br><span class="line">DBCC TRACEON(1204,1222,-1)</span><br><span class="line"><span class="comment"># 查看状态</span></span><br><span class="line">DBCC TRACESTATUS(1204,1222,-1)</span><br><span class="line"><span class="comment"># 全局关闭</span></span><br><span class="line">DBCC TRACEOFF(1204,1222,-1)</span><br></pre></td></tr></table></figure><h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><ul><li>表名和字段名均不区分大小写</li></ul><h3 id="运维"><a href="#运维" class="headerlink" title="运维"></a>运维</h3><h4 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查询死锁</span></span><br><span class="line"><span class="keyword">select</span> request_session_id spid, OBJECT_NAME(resource_associated_entity_id) tableName    </span><br><span class="line"><span class="keyword">from</span> sys.dm_tran_locks</span><br><span class="line"><span class="keyword">where</span> resource_type=<span class="string">'OBJECT'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 杀死死锁</span></span><br><span class="line"><span class="keyword">kill</span> spid</span><br></pre></td></tr></table></figure><ul><li>日志分析</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开启死锁日志记录</span></span><br><span class="line">DBCC TRACEON(1204,1222,-1)</span><br><span class="line"><span class="comment"># 查看日志</span></span><br><span class="line">EXEC master..xp_readerrorlog</span><br><span class="line"><span class="comment"># 关闭日志记录</span></span><br><span class="line">DBCC TRACEOFF(1204,1222,-1)</span><br></pre></td></tr></table></figure><ul><li>日志举例</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 死锁列表</span></span><br><span class="line">2021-06-08 18:12:42.270 spid19s      deadlock-list</span><br><span class="line">2021-06-08 18:12:42.270 spid19s       deadlock victim=process3b13cbc28</span><br><span class="line"><span class="comment"># 进程列表</span></span><br><span class="line">2021-06-08 18:12:42.270 spid19s        process-list</span><br><span class="line"><span class="comment"># process id=process3b13cbc28 进程ID; lockMode=U 获取更新锁;</span></span><br><span class="line">2021-06-08 18:12:42.270 spid19s         process id=process3b13cbc28 taskpriority=0 logused=0 waitresource=PAGE: 7:1:2398  waittime=6183 ownerId=497876 transactionname=DELETE lasttranstarted=2021-06-08T18:12:36.060 XDES=0x474bdbbf0 lockMode=U schedulerid=1 kpid=7744 status=suspended spid=55 sb</span><br><span class="line"><span class="comment"># executionStack 执行的堆信息</span></span><br><span class="line">2021-06-08 18:12:42.270 spid19s          executionStack</span><br><span class="line">2021-06-08 18:12:42.270 spid19s           frame procname=adhoc line=1 stmtstart=18 stmtend=134 sqlhandle=0x02000000c0fabf0634d24304a83e22f2b063fc8036237a470000000000000000000000000000000000000000</span><br><span class="line">2021-06-08 18:12:42.270 spid19s      unknown     </span><br><span class="line">2021-06-08 18:12:42.270 spid19s           frame procname=unknown line=1 sqlhandle=0x0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000</span><br><span class="line">2021-06-08 18:12:42.270 spid19s      unknown     </span><br><span class="line">2021-06-08 18:12:42.270 spid19s          inputbuf</span><br><span class="line">2021-06-08 18:12:42.270 spid19s      (@P0 int)delete from tc_declaration_body</span><br><span class="line">        <span class="built_in">where</span> decl_id = @P0            </span><br><span class="line">2021-06-08 18:12:42.270 spid19s         process id=process3b85d64e8 taskpriority=0 logused=632 waitresource=PAGE: 7:1:2398  waittime=3805 ownerId=497821 transactionname=DELETE lasttranstarted=2021-06-08T18:12:35.003 XDES=0x474ae9bf0 lockMode=U schedulerid=4 kpid=4620 status=suspended spid=56 </span><br><span class="line">2021-06-08 18:12:42.270 spid19s          executionStack</span><br><span class="line">2021-06-08 18:12:42.270 spid19s           frame procname=adhoc line=1 stmtstart=18 stmtend=134 sqlhandle=0x02000000c0fabf0634d24304a83e22f2b063fc8036237a470000000000000000000000000000000000000000</span><br><span class="line">2021-06-08 18:12:42.270 spid19s      unknown     </span><br><span class="line">2021-06-08 18:12:42.270 spid19s           frame procname=unknown line=1 sqlhandle=0x0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000</span><br><span class="line">2021-06-08 18:12:42.270 spid19s      unknown     </span><br><span class="line">2021-06-08 18:12:42.270 spid19s          inputbuf</span><br><span class="line">2021-06-08 18:12:42.270 spid19s      (@P0 int)delete from tc_declaration_body</span><br><span class="line">        <span class="built_in">where</span> decl_id = @P0            </span><br><span class="line">2021-06-08 18:12:42.270 spid19s         process id=process3b13cb468 taskpriority=0 logused=10000 waittime=3089 schedulerid=1 kpid=4200 status=suspended spid=56 sbid=0 ecid=0 priority=0 trancount=2 lastbatchstarted=2021-06-08T18:12:35.003 lastbatchcompleted=2021-06-08T18:12:34.990 lastattentio</span><br><span class="line">2021-06-08 18:12:42.270 spid19s          executionStack</span><br><span class="line">2021-06-08 18:12:42.270 spid19s           frame procname=adhoc line=1 stmtstart=18 stmtend=134 sqlhandle=0x02000000c0fabf0634d24304a83e22f2b063fc8036237a470000000000000000000000000000000000000000</span><br><span class="line">2021-06-08 18:12:42.270 spid19s      unknown     </span><br><span class="line">2021-06-08 18:12:42.270 spid19s           frame procname=unknown line=1 sqlhandle=0x0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000</span><br><span class="line">2021-06-08 18:12:42.270 spid19s      unknown     </span><br><span class="line">2021-06-08 18:12:42.270 spid19s          inputbuf</span><br><span class="line">2021-06-08 18:12:42.270 spid19s      (@P0 int)delete from tc_declaration_body</span><br><span class="line">        <span class="built_in">where</span> decl_id = @P0</span><br></pre></td></tr></table></figure><hr><p>参考文章</p></div><div></div><div></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> smalle</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="http://blog.aezo.cn/2017/09/30/db/sql-base/" title="sql基础">http://blog.aezo.cn/2017/09/30/db/sql-base/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/mysql/" rel="tag"># mysql</a> <a href="/tags/oracle/" rel="tag"># oracle</a> <a href="/tags/sql/" rel="tag"># sql</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2017/09/30/db/sql-ext/" rel="next" title="sql进阶"><i class="fa fa-chevron-left"></i> sql进阶</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"> <a href="/2017/10/09/extend/内网穿透/" rel="prev" title="内网穿透">内网穿透<i class="fa fa-chevron-right"></i></a></div></div></footer></article><div class="post-spread"><div> <a target="_blank" href="https://github.com/oldinaction/ChatGPT-MP"><img class="nofancybox" style="width:300px;margin:0 auto" src="https://cdn7.aezo.cn/one/chat/chat-gpt-open-banner.jpg" alt="ChatGPT开源小程序" title="ChatGPT开源小程序"></a></div></div></div></div><div class="comments" id="comments"></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> 文章目录</li><li class="sidebar-nav-overview" data-target="site-overview"> 站点概览</li></ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="https://avatars0.githubusercontent.com/u/15698218?v=3&u=ce740bf0b67ff0d74990ba6fc644d6e92f572dcb&s=400" alt="smalle"><p class="site-author-name" itemprop="name">smalle</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">162</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/index.html"><span class="site-state-item-count">14</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/index.html"><span class="site-state-item-count">149</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"></div><div> 欢迎关注公众号：阿壹族 <img class="nofancybox" style="width:120px;margin:0 auto" src="https://cdn7.aezo.cn/common/qrcode/ayz_qrcode.jpg" alt="欢迎关注公众号：阿壹族" title="欢迎关注公众号：阿壹族"></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#SQL基础"><span class="nav-number">1.</span> <span class="nav-text">SQL基础</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#设计表"><span class="nav-number">2.</span> <span class="nav-text">设计表</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#三范式"><span class="nav-number">2.1.</span> <span class="nav-text">三范式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#常用建表模型"><span class="nav-number">2.2.</span> <span class="nav-text">常用建表模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#案例"><span class="nav-number">2.3.</span> <span class="nav-text">案例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#设计树状结构的存储"><span class="nav-number">2.4.</span> <span class="nav-text">设计树状结构的存储</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据库表信息"><span class="nav-number">3.</span> <span class="nav-text">数据库表信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据库模式定义语言DDL-Data-Definition-Language"><span class="nav-number">4.</span> <span class="nav-text">数据库模式定义语言DDL(Data Definition Language)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建和使用数据库"><span class="nav-number">4.1.</span> <span class="nav-text">创建和使用数据库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数据库基本"><span class="nav-number">4.2.</span> <span class="nav-text">数据库基本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建、删除、复制表、更新"><span class="nav-number">4.3.</span> <span class="nav-text">创建、删除、复制表、更新</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Oracle创建"><span class="nav-number">4.3.1.</span> <span class="nav-text">Oracle创建</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#删除表"><span class="nav-number">4.3.2.</span> <span class="nav-text">删除表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#复制表"><span class="nav-number">4.3.3.</span> <span class="nav-text">复制表</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修改表结构"><span class="nav-number">4.4.</span> <span class="nav-text">修改表结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#索引"><span class="nav-number">4.5.</span> <span class="nav-text">索引</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#视图"><span class="nav-number">4.6.</span> <span class="nav-text">视图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#临时表"><span class="nav-number">4.7.</span> <span class="nav-text">临时表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#触发器"><span class="nav-number">4.8.</span> <span class="nav-text">触发器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Oracle数据字典"><span class="nav-number">4.9.</span> <span class="nav-text">Oracle数据字典</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据库操作语言DML-Data-Manipulation-Language，即CRUD"><span class="nav-number">5.</span> <span class="nav-text">数据库操作语言DML(Data Manipulation Language，即CRUD)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#插入记录"><span class="nav-number">5.1.</span> <span class="nav-text">插入记录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#更新记录"><span class="nav-number">5.2.</span> <span class="nav-text">更新记录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#删除记录-表结构不会删除"><span class="nav-number">5.3.</span> <span class="nav-text">删除记录(表结构不会删除)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查询"><span class="nav-number">5.4.</span> <span class="nav-text">查询</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#书写顺序"><span class="nav-number">5.4.1.</span> <span class="nav-text">书写顺序</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#查询-1"><span class="nav-number">5.4.2.</span> <span class="nav-text">查询</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#基础查询"><span class="nav-number">5.4.2.1.</span> <span class="nav-text">基础查询</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#组函数"><span class="nav-number">5.4.2.2.</span> <span class="nav-text">组函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#表连接"><span class="nav-number">5.4.2.3.</span> <span class="nav-text">表连接</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#子查询"><span class="nav-number">5.4.2.4.</span> <span class="nav-text">子查询</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#子查询和表连接举例"><span class="nav-number">5.4.2.5.</span> <span class="nav-text">子查询和表连接举例</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#oracle分页"><span class="nav-number">5.4.2.6.</span> <span class="nav-text">oracle分页</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#union-union-all合集"><span class="nav-number">5.4.3.</span> <span class="nav-text">union/union all合集</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#intersect交集"><span class="nav-number">5.4.4.</span> <span class="nav-text">intersect交集</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#except差集"><span class="nav-number">5.4.5.</span> <span class="nav-text">except差集</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Mysql-事物"><span class="nav-number">6.</span> <span class="nav-text">(Mysql)事物</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Mysql日志原理"><span class="nav-number">7.</span> <span class="nav-text">Mysql日志原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#InnoDB日志-Redo-Undo"><span class="nav-number">7.1.</span> <span class="nav-text">InnoDB日志(Redo/Undo)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#服务端的日志Binlog"><span class="nav-number">7.2.</span> <span class="nav-text">服务端的日志Binlog</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数据更新的流程-2PC"><span class="nav-number">7.3.</span> <span class="nav-text">数据更新的流程(2PC)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SQLServer"><span class="nav-number">8.</span> <span class="nav-text">SQLServer</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装"><span class="nav-number">8.1.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sqlcmd"><span class="nav-number">8.2.</span> <span class="nav-text">sqlcmd</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DBCC"><span class="nav-number">8.3.</span> <span class="nav-text">DBCC</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#其他"><span class="nav-number">8.4.</span> <span class="nav-text">其他</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#运维"><span class="nav-number">8.5.</span> <span class="nav-text">运维</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#死锁"><span class="nav-number">8.5.1.</span> <span class="nav-text">死锁</span></a></li></ol></li></ol></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright"> &copy; 2016 - <span itemprop="copyrightYear">2024</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">smalle</span>&nbsp;&nbsp;&nbsp;&nbsp;<div class="powered-by"> 由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div><div class="powered-by"> 主题 - <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a></div><div class="theme-info"> <a class="theme-link" target="_blank" href="https://tongji.baidu.com/main/overview/10000542408/overview/index?siteId=18991897">站长统计</a></div></div><div class="ad"> <span style="font-weight:700">AD&nbsp;&nbsp;&nbsp;&nbsp;</span><div class="theme-info"> <a target="_blank" href="https://promotion.aliyun.com/ntms/yunparter/invite.html?userCode=oby5nolb">阿里云大礼包</a></div></div><div class="aezocn"> <span style="font-weight:700">&copy;AEZO.CN&nbsp;&nbsp;&nbsp;&nbsp;</span><div class="powered-by"> <a target="_blank" href="https://shengqitech.aezo.cn/">圣骑科技</a></div><div class="powered-by"> <a target="_blank" href="https://cdn7.aezo.cn/common/qrcode/one_qrcode.jpg">【One能抽屉】小程序</a></div><div class="theme-info"> <a target="_blank" href="http://shop.aezo.cn/">杂货铺(省钱小助手)</a></div></div><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?085f9cd91ef2ad985f791c677472f0d1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script><script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script type="text/javascript" src="/js/src/js.cookie.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/scroll-cookie.js?v=5.1.1"></script></body></html>