<!doctype html><html class="theme-next mist use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css"><meta name="keywords" content="H5,App,mobile,小程序,"><link rel="alternate" href="/atom.xml" title="Smalle's Blog | AEZOCN" type="application/atom+xml"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1"><meta name="description" content="简介 此处微信开发包含微信公众号开发，公众号H5开发，微信小程序开发，微信支付等  小程序开发小程序限制认证/审核/权限 小程序可直接复用同一主体的公众号认证(无需额外费用) 管理员可设置运营者/开发者；运营者可直接发布审核后的版本；开发者可添加体验人员(50人)，开发者可设置域名、发布体验版、提交审核版(但发布线上版则需管理审核) 审核 发布小程序提交审核，不通过会通知发布人和管理员 线上版本发"><meta name="keywords" content="H5,App,mobile,小程序"><meta property="og:type" content="article"><meta property="og:title" content="微信开发"><meta property="og:url" content="http://blog.aezo.cn/2017/10/10/web/mobile/weixin/index.html"><meta property="og:site_name" content="Smalle&#39;s Blog | AEZOCN"><meta property="og:description" content="简介 此处微信开发包含微信公众号开发，公众号H5开发，微信小程序开发，微信支付等  小程序开发小程序限制认证/审核/权限 小程序可直接复用同一主体的公众号认证(无需额外费用) 管理员可设置运营者/开发者；运营者可直接发布审核后的版本；开发者可添加体验人员(50人)，开发者可设置域名、发布体验版、提交审核版(但发布线上版则需管理审核) 审核 发布小程序提交审核，不通过会通知发布人和管理员 线上版本发"><meta property="og:locale" content="zh-Hans"><meta property="og:updated_time" content="2022-01-27T11:07:58.976Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="微信开发"><meta name="twitter:description" content="简介 此处微信开发包含微信公众号开发，公众号H5开发，微信小程序开发，微信支付等  小程序开发小程序限制认证/审核/权限 小程序可直接复用同一主体的公众号认证(无需额外费用) 管理员可设置运营者/开发者；运营者可直接发布审核后的版本；开发者可添加体验人员(50人)，开发者可设置域名、发布体验版、提交审核版(但发布线上版则需管理审核) 审核 发布小程序提交审核，不通过会通知发布人和管理员 线上版本发"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",sidebar:{position:"right",display:"post",offset:12,offset_float:0,b2t:!1,scrollpercent:!1},fancybox:!0,motion:!0,duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"BWD6R9FA4K",apiKey:"3330f3cbaa099dfc30395de5f5b20151",indexName:"blog",hits:{per_page:10},labels:{input_placeholder:"请输入关键字",hits_empty:"我们没有找到任何搜索结果: ${query}",hits_stats:"找到约${hits}条结果（用时${time}ms）"}}}</script><link rel="canonical" href="http://blog.aezo.cn/2017/10/10/web/mobile/weixin/"><title>微信开发 | Smalle's Blog | AEZOCN</title><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?d82223039d601f2f819f8fe140a63468";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><div style="display:none"><script src="//s95.cnzz.com/z_stat.php?id=cnzz_stat_icon_1276691827&web_id=cnzz_stat_icon_1276691827" language="JavaScript"></script></div></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-right page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Smalle's Blog | AEZOCN</span><span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">Better Code, Better Life</h1></div><div class="site-nav-toggle"> <button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br> 首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br> 分类</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br> 关于</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br> 归档</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br> 标签</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i><br> 站点地图</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br> 搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"> <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><link itemprop="mainEntityOfPage" href="http://blog.aezo.cn/2017/10/10/web/mobile/weixin/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="smalle"><meta itemprop="description" content=""><meta itemprop="image" content="https://avatars0.githubusercontent.com/u/15698218?v=3&u=ce740bf0b67ff0d74990ba6fc644d6e92f572dcb&s=400"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Smalle's Blog | AEZOCN"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">微信开发</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-10T21:34:00+08:00">2017-10-10</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/web/" itemprop="url" rel="index"><span itemprop="name">web</span></a></span></span></div></header><div class="post-body" itemprop="articleBody"><div></div><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><ul><li>此处微信开发包含微信公众号开发，公众号H5开发，微信小程序开发，微信支付等</li></ul><h2 id="小程序开发"><a href="#小程序开发" class="headerlink" title="小程序开发"></a>小程序开发</h2><h3 id="小程序限制"><a href="#小程序限制" class="headerlink" title="小程序限制"></a>小程序限制</h3><h4 id="认证-审核-权限"><a href="#认证-审核-权限" class="headerlink" title="认证/审核/权限"></a>认证/审核/权限</h4><ul><li>小程序可直接复用同一主体的公众号认证(无需额外费用)</li><li>管理员可设置运营者/开发者；运营者可直接发布审核后的版本；开发者可添加体验人员(50人)，开发者可设置域名、发布体验版、提交审核版(但发布线上版则需管理审核)</li><li>审核<ul><li>发布小程序提交审核，不通过会通知发布人和管理员</li><li>线上版本发布每次均需审核，官方称1-7天完成<ul><li>实际发现不涉及特殊业务时，快的时候1-2小时即可完成</li><li>涉及如资质类如餐饮、红包等，一般2-7天</li></ul></li><li>审核人员工作时间<ul><li>周末也可提交审核</li><li>小程序如若需要登录，需要提供正确的账号密码供审核人员使用</li></ul></li><li>加急机制<ul><li>最快2小时内完成</li><li>加急时间段：企业是9:00-24:00，个人是9:00-21:00</li><li>非个人主体一年3次机会，个人一年1次机会。如在审核前撤回申请，机会将不会被消耗</li><li>选择了加急审核，但审核单被驳回了。开发者可以在12小时内重新整改并在驳回站内信内的【前往反馈页面】重新提交审核，即可获得相应加急的队列。否则将会直接浪费了一次加急机会</li></ul></li></ul></li></ul><h4 id="域名限制"><a href="#域名限制" class="headerlink" title="域名限制"></a>域名限制</h4><ul><li>API地址：<strong>必须是https域名(可以是非443端口)</strong>，且需在微信后台配置(可配置API、ws、文件上传下载、打开网页域名等)<ul><li><strong>开发环境</strong>可在微信编辑器中设置成不校验此限制(可为ip地址)，体验版则需打开调试模式(在胶囊中设置)</li></ul></li><li>iframe(web-view)地址<ul><li>必须https域名，且需要在微信后台配置业务域名。开发环境同上</li><li>个人小程序不支持业务域名设置</li></ul></li><li>图片网络地址：必须是https域名，且需要在微信后台配置业务域名。开发环境同上</li></ul><h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><ul><li>调试体验版或者正式版：体验版调试直接打开小程序调试模式；正式版调试需要先打开体验版调试模式，再访问正式版</li><li>图片<ul><li>使用background-image属性时，本地小图片(如图标，测试30K左右可以正常显示)可以显示，图片太大则需转base64或使用网络地址(http/https，无需绑定域名)，否则不显示(仅开发版显示)</li><li>使用image图片比background-image快</li></ul></li><li><strong>小程序不支持多环境编译</strong>，对于API地址完全取决于上传到微信平台时代码中的地址(只能为一个，无法获取环境)。因此通过uni-app开发时，需要点击发行才会对应到生产环境API，参考<a href="/_posts/web/uni-app.md#XBuilder">uni-app.md#XBuilder</a></li><li><a href="#web-view开发">web-view限制参考下文</a></li><li>开发版真机调试需手机wifi和API地址处于同一网络</li></ul><h3 id="web-view开发"><a href="#web-view开发" class="headerlink" title="web-view开发"></a>web-view开发</h3><ul><li><strong>web-view</strong>组件(类似iframe，小程序本身是不能使用iframe标签的)，如出现”此网页由xxx提供”均为web-view<ul><li>web-view 不支持推送服务通知(即模板消息)<ul><li>类似下单等页面需要发送通知则需改写成小程序页面</li></ul></li><li><strong>打开的域名需要在小程序管理后台设置业务域名</strong>，打开的页面 302 过去的地址也必须设置过业务域名，web-view嵌入的页面可以包含 iframe，但是 iframe 的地址必须为业务域名，且都需要是https。个人小程序不支持业务域名设置</li><li>小程序内嵌 web-view 跟微信内置浏览器是一套环境，即h5中引入JS-SDK即可使用wx对象，且测试发现Storage等仍然不共享</li></ul></li><li><p>小程序和web-view通信</p><ul><li>可通过小程序web-view标签的url将小程序参数传递给H5页面，从而进行用户验证等操作</li><li>H5传递消息给小程序需要使用 postMessage。不能直接调用windows.postMessage，而是需要使用微信JS-SDK提供的postMessage函数；如果是uni-app开发，可引入uni.webview库在中间做桥接，从而调用微信的postMessage函数</li><li><p>示例(小程序和H5都是基于uni-app开发). 参考：<a href="https://uniapp.dcloud.io/component/web-view" target="_blank" rel="noopener">https://uniapp.dcloud.io/component/web-view</a></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 小程序 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 通过url向h5传递参数 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-view</span> <span class="attr">src</span>=<span class="string">"http://192.168.1.10:8080/#/?token=123"</span> @<span class="attr">message</span>=<span class="string">"onMessage"</span>&gt;</span><span class="tag">&lt;/<span class="name">web-view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">    methods: &#123;</span></span><br><span class="line"><span class="undefined">        onMessage(data) &#123;</span></span><br><span class="line"><span class="javascript">            <span class="comment">// &#123;"data": [&#123;"action": "message..."&#125;]&#125;</span></span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(data);</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 注意：</span></span><br><span class="line"><span class="comment">    1.******如果是h5也是用uni开发，则下文引入uni.webview库容易导致和默认uni对象冲突。******解决：修改下列js文件中的3处uni为uniWebview，再使用uniWebview调用。参考：https://github.com/oldinaction/smweb/blob/master/uni-app/uni.webview.1.5.2.js</span></span><br><span class="line"><span class="comment">    2.jweixin-1.4.0.js和uni.webview.1.5.2.js也支持直接import按需导入</span></span><br><span class="line"><span class="comment">    3.如果此处web-view所在项目非小程序，如uni-app写的H5项目需要通过web-view引入另外一个H5，则不需要引入jweixin，也可实现postMessag(通过window.postMessag)；如果是小程序中使用web-view，则在H5中引入jweixin库后，可直接使用wx.miniProgram.postMessage，不用额外引入uni-webview库</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- H5-基于模板引入库，参考：https://uniapp.dcloud.io/collocation/manifest?id=h5-template。并在模板中引入下列js --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="comment">// 判断环境是否为小程序，如果是则需要引入小程序的JS-SDK。其他类型小程序完整判断参考官方文档</span></span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> userAgent = navigator.userAgent;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">if</span> (<span class="regexp">/miniProgram/i</span>.test(userAgent) &amp;&amp; <span class="regexp">/micromessenger/i</span>.test(userAgent)) &#123;</span></span><br><span class="line"><span class="javascript">        <span class="comment">// 微信小程序 JS-SDK 如果不需要兼容微信小程序，则无需引用此 JS 文件。</span></span></span><br><span class="line"><span class="xml">        document.write('<span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"https://res.wx.qq.com/open/js/jweixin-1.4.0.js"</span>&gt;</span><span class="xml"><span class="tag">&lt;<span class="name">\</span>/<span class="attr">script</span>&gt;</span>');</span></span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- uni 的 SDK，小程序可无需此库，但是需要使用 wx.miniProgram.postMessage 进行调用 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"https://js.cdn.aliyun.dcloud.net.cn/dev/uni-app/uni.webview.1.5.2.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- H5-使用 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="comment">// 注意:</span></span></span><br><span class="line"><span class="javascript">    <span class="comment">// 1.调试H5需要打开小程序编辑器，进入H5页面后右键，编辑器上方会出现一个调试按钮，点击后进入小程序(H5页面会再次刷新)</span></span></span><br><span class="line"><span class="javascript">    <span class="comment">// 2.向小程序传递参数后，小程序端不会立即收到消息，需要在点击返回(到小程序页面)、分享、重定向(原页面被销毁)等情况才会真正发送给小程序；当点击返回小程序原页面，或通过navigateTo跳转到小程序原始页面(可经过多次点击跳转亦可)，或redirectTo跳转到小程序页面(原页面销毁)也会受到消息</span></span></span><br><span class="line"><span class="javascript">    <span class="comment">// uniWebview.postMessag(uniWebview为上文修改过的uni.webview.js)最终是通过调用jweixin#miniProgram.postMessage，最终jweixin库通过调用WeixinJSBridge(由容器提供，如小程序编辑器或微信客户端)实现通信</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="comment">// 向小程序传递参数(uniWebview为上文修改过的uni.webview.js)</span></span></span><br><span class="line"><span class="undefined">    uniWebview.postMessage(&#123;</span></span><br><span class="line"><span class="undefined">        data: &#123;</span></span><br><span class="line"><span class="javascript">            action: <span class="string">'message...'</span></span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">    &#125;);</span></span><br><span class="line"><span class="javascript">    <span class="comment">// 可直接在H5中跳转到小程序的page页面</span></span></span><br><span class="line"><span class="undefined">    uniWebview.navigateTo(&#123;</span></span><br><span class="line"><span class="javascript">        url: <span class="string">'/pages/product/list'</span>  </span></span><br><span class="line"><span class="undefined">    &#125;);</span></span><br><span class="line"><span class="javascript">    <span class="comment">// 切换到菜单页</span></span></span><br><span class="line"><span class="undefined">    uniWebview.switchTab(...)</span></span><br><span class="line"><span class="javascript">    <span class="comment">// 重定向</span></span></span><br><span class="line"><span class="undefined">    uniWebview.redirectTo(...)</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul></li></ul><h4 id="web-view限制"><a href="#web-view限制" class="headerlink" title="web-view限制"></a>web-view限制</h4><ul><li>小程序下方导航可使用h5导航(相当于全部嵌入H5)</li><li>小程序跳转第三方小程序，微信会做非生物识别<ul><li>小程序起始页点击按钮进入第三方小程序，会自动(提示框自动跳出来)提示”即将跳转至xxx小程序”需要用户确定(所有按钮点击的小程序跳转均有此确认)</li><li>小程序起始页直接按钮进入整个H5页面，在H5页面的跳转至第三方小程序，也会自动提示确认</li><li>小程序起始页直接嵌入整个H5页面，此时点击H5页面的跳转至第三方小程序，不会自动提示确认<ul><li>此时可让H5点击跳转一个中间页，在中间页上显示按钮，让用户手动点击跳转，点击后才会跳出提示确认框</li></ul></li><li>对于在界面识别二维码跳转到第三方，因为识别二维码图片后，会从底部弹出一个确认框(对图片操作，还是跳转而二维码对于的小程序)，此时用户点击确认框后不会再出现”即将跳转至xxx小程序”的确认框</li></ul></li></ul><h2 id="微信H5开发"><a href="#微信H5开发" class="headerlink" title="微信H5开发"></a>微信H5开发</h2><ul><li>微信网页开发<ul><li>通过微信浏览器打开网页时的场景。此时可调用<a href="#JS-SDK">JS-SDK</a>获取一些硬件能力</li><li>通过使用微信JS-SDK，网页开发者可借助微信高效地使用拍照、选图、语音、位置等手机系统的能力，同时可以直接使用微信分享、扫一扫、卡券、支付等微信特有的能力，为微信用户提供更优质的网页体验</li></ul></li><li><strong>微信开发者工具可模拟微信内置浏览器进行微信H5页面调试</strong><ul><li>默认打开是小程序模式，可通过”微信开发者工具-更换模式-公众号网页调试”进行切换</li><li>如果在微信内置浏览器打开，则js中可以拿到<code>wx</code>对象(只是一个声明)，但是还需引入JS-SDK(实现)。参考上文JSSDK使用步骤</li></ul></li><li><strong>微信公众号测试账号申请和使用</strong><ul><li>申请：开发者工具 - 公众平台测试帐号</li><li>测试帐号接口权限基本都有；一个微信账号对应一个测试号，和登录的公众号无关</li><li>设置登录验证时的重定向地址：体验接口权限表 - 网页授权获取用户基本信息 - 修改(只需填域名)</li></ul></li></ul><h3 id="JS-SDK"><a href="#JS-SDK" class="headerlink" title="JS-SDK"></a>JS-SDK</h3><ul><li><a href="https://www.weixinsxy.com/jssdk/" target="_blank" rel="noopener">官方Demo(使用微信打开进行测试)</a></li><li><strong>JS-SDK使用步骤</strong>，<a href="https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/JS-SDK.html#0" target="_blank" rel="noopener">参考</a><ul><li>绑定域名(JS接口安全域名)。<strong>注意是域名</strong>(因此测试也需要使用域名)，不需要http协议头(否则报错：invalid url domain)</li><li>引入JS文件(必须)<ul><li>直接引入<code>jweixin-1.6.0.js</code>，则可直接使用<code>wx</code>(等同于<code>jWeixin</code>)对象</li><li>或者通过<a href="https://www.npmjs.com/package/weixin-js-sdk" target="_blank" rel="noopener">npm install -S weixin-js-sdk</a>，然后通过<code>import wx from &#39;weixin-js-sdk&#39;</code>或<code>var wx = require(&#39;weixin-js-sdk&#39;);</code>导入。此包为开发人员将官方 js-sdk 发布到 npm，支持 CommonJS，便于 browserify, webpack 等直接使用</li></ul></li><li>通过config接口注入权限验证配置<ul><li>所有需要使用JS-SDK的页面必须先注入配置信息，否则将无法调用</li><li>同一个url仅需调用一次，对于变化url的SPA的web app可在每次url变化时进行调用。即通过Vue Router进行跳转不需要重复注入配置，可在main.js中注入即可</li><li>需要配合后台服务进行验签，后台主要需要获取微信公众号access_token和jsapi_ticket，然后将加密串返回到前台进行验证。参考：<a href="https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/JS-SDK.html#62" target="_blank" rel="noopener">https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/JS-SDK.html#62</a></li></ul></li><li>通过ready接口处理成功验证，通过error接口处理失败验证</li><li>通过wx对象调用相关接口</li><li><strong>关于测试</strong><ul><li>如果确定线上环境上述流程可正常进行，测试时可进行省略。先直接访问<code>http://demo.open.weixin.qq.com/jssdk</code>可获取所有接口权限，然后访问测试页面，即可进行接口调用。从而减少了测试时域名绑定等步骤</li></ul></li></ul></li><li>使用参考<a href="#微信登录">微信登录</a></li><li>原理<ul><li>jweixin包含对象miniProgram(包含navigateTo、postMessage等功能)，uni-app提供的uni-webview桥接库和此对象功能对应，参考上文<a href="#web-view开发">web-view开发</a></li><li>jweixin库实际是通过调用<code>WeixinJSBridge</code>(由容器提供，如小程序编辑器或微信客户端，且需要一定的加载时间)实现相关</li></ul></li></ul><h3 id="内网穿透"><a href="#内网穿透" class="headerlink" title="内网穿透"></a>内网穿透</h3><ul><li><a href="http://service.oray.com/question/5570.html" target="_blank" rel="noopener">http://service.oray.com/question/5570.html</a></li></ul><h2 id="公众号开发"><a href="#公众号开发" class="headerlink" title="公众号开发"></a>公众号开发</h2><ul><li>菜单管理、用户管理、文章管理均通过自定义服务操作，此时需要配置服务器。配置了服务器之后则不能使用微信公众号后台的菜单管理等功能<ul><li>微信浏览器网页授权(登录)无需绑定此配置(参考下文微信登录)，此配置只是用来管理微信公众号</li></ul></li><li>配置服务器地址<ul><li>配置服务器的URL必须以http://或https://开头，分别支持80端口和443端口</li><li>EncodingAESKey随机生成一个即可</li><li>绑定时会调用后台服务进行验证域名有效性，Java的参考：<a href="https://www.cnblogs.com/zhouwen2017/p/10451427.html" target="_blank" rel="noopener">https://www.cnblogs.com/zhouwen2017/p/10451427.html</a></li><li>验证时提示 <strong>“参数错误，请重新填写”</strong>，可能由于域名被微信屏蔽了。可直接在微信上访问测试，如果屏蔽了会提示”已停止访问该网页”</li></ul></li></ul><h2 id="微信登录"><a href="#微信登录" class="headerlink" title="微信登录"></a>微信登录</h2><h3 id="微信浏览器中获取用户信息"><a href="#微信浏览器中获取用户信息" class="headerlink" title="微信浏览器中获取用户信息"></a>微信浏览器中获取用户信息</h3><ul><li><p><a href="https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/Wechat_webpage_authorization.html" target="_blank" rel="noopener">微信浏览器中获取用户信息</a>。如微信公众号点击菜单H5连接进入网页时获取用户信息</p><ul><li>前提<ul><li><strong>绑定网页授权域名</strong>(和授权回调地址一致。微信公众号 - 开发 - 接口权限 - 网页服务 - 网页帐号 - 网页授权获取用户基本信息)<ul><li><strong>无需绑定微信公众号服务器配置</strong>(该配置是用来管理微信公众号的)</li><li><strong>一定要是域名，不要加http://等协议头，也不要加子路径</strong><ul><li>假设网页运行在/abc目录，此时也要加example.com，而不能是example.com/abc，因此必须是<a href="http://example.com/MP_verify_cm2fJ4wmTLQpvkZr.txt来进行验证" target="_blank" rel="noopener">http://example.com/MP_verify_cm2fJ4wmTLQpvkZr.txt来进行验证</a></li><li>业务域名和JS安全域名是否需要加子路径未测试</li></ul></li></ul></li><li><strong>设置IP白名单</strong>（测试账号无需）<ul><li>为了防止公众号appid和秘钥泄露，在向微信服务器获取access_token请求时，需要限制开发者服务器所在的外网IP（微信服务器获取的请求者IP）</li></ul></li></ul></li><li><p>引导用户访问如<code>https://open.weixin.qq.com/connect/oauth2/authorize?appid=APPID&amp;redirect_uri=REDIRECT_URI&amp;response_type=code&amp;scope=SCOPE&amp;state=STATE#wechat_redirect</code>，如让用户打开网站主页，然后再主页加载后自动跳转到此地址。回调地址必须完整，如果动态协议头，可以使用如<code>window.location.protocol + &#39;//aezo.cn/xxx&#39;</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">redirectWechatForCode(appid, redirectUrl, state) &#123;</span><br><span class="line">    <span class="comment">// https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/Wechat_webpage_authorization.html</span></span><br><span class="line">    <span class="keyword">let</span> path = <span class="string">"https://open.weixin.qq.com/connect/oauth2/authorize?appid="</span></span><br><span class="line">            + appid</span><br><span class="line">            + <span class="string">"&amp;redirect_uri="</span></span><br><span class="line">            + <span class="built_in">encodeURIComponent</span>(redirectUrl)</span><br><span class="line">            + <span class="string">"&amp;response_type=code&amp;scope=snsapi_userinfo&amp;state="</span> + state + <span class="string">"#wechat_redirect"</span>;</span><br><span class="line">    <span class="built_in">window</span>.location.href = path</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>访问上述连接，会进行用户授权验证，用户同意授权，获取code。此时code通过上述链接配置的回调地址会当做参数带回(还会原封不动的带回state参数)</p></li><li>后台通过code换取openid、网页授权access_token(用户的access_token，有效期为2h；不同于公众号的access_token)、网页授权refresh_token(有效期为30天)。由于此接口调用次数不限制，可需要获取access_token时重新调用微信接口，也可存储下来<ul><li><strong>由于后台此时需要调用微信接口，因此需要服务器能访问外网，或开放 api.weixin.qq.com 的白名单(此域名可能对应多个IP，且存在变化的问题)，或使用代理访问(程序中进行代理或nginx代理)</strong></li></ul></li><li>或者刷新access_token</li><li>后台再基于网页授权access_token和openid拉取用户信息</li></ul></li></ul><h2 id="微信支付"><a href="#微信支付" class="headerlink" title="微信支付"></a>微信支付</h2><ul><li>微信支付费率和结算周期明细：<a href="https://kf.qq.com/faq/140225MveaUz1501077rEfqI.html" target="_blank" rel="noopener">https://kf.qq.com/faq/140225MveaUz1501077rEfqI.html</a><ul><li>一般费率为0.60%(千6)，结算周期T+1</li><li>费率根据行业不同，在0.20%至1.00%之间。比如物流公司费率为0.30%，但是注册是需要提交一个”物流《道路运输许可证》”</li></ul></li><li>企业注册资料<ul><li>营业执照：彩色扫描件或数码照片</li><li>组织机构代码证：彩色扫描件或数码照片，若已三证合一，则无需提供</li><li>对公银行账户：包含开户行省市信息，开户账号</li><li>法人身份证：彩色扫描件或数码照片</li></ul></li></ul><hr></div><div></div><div></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> smalle</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="http://blog.aezo.cn/2017/10/10/web/mobile/weixin/" title="微信开发">http://blog.aezo.cn/2017/10/10/web/mobile/weixin/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/H5/" rel="tag"># H5</a> <a href="/tags/App/" rel="tag"># App</a> <a href="/tags/mobile/" rel="tag"># mobile</a> <a href="/tags/小程序/" rel="tag"># 小程序</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2017/10/09/extend/内网穿透/" rel="next" title="内网穿透"><i class="fa fa-chevron-left"></i> 内网穿透</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"> <a href="/2017/10/10/web/mobile/uni-app/" rel="prev" title="uni-app">uni-app<i class="fa fa-chevron-right"></i></a></div></div></footer></article><div class="post-spread"></div></div></div><div class="comments" id="comments"></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> 文章目录</li><li class="sidebar-nav-overview" data-target="site-overview"> 站点概览</li></ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="https://avatars0.githubusercontent.com/u/15698218?v=3&u=ce740bf0b67ff0d74990ba6fc644d6e92f572dcb&s=400" alt="smalle"><p class="site-author-name" itemprop="name">smalle</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">159</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/index.html"><span class="site-state-item-count">13</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/index.html"><span class="site-state-item-count">141</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#简介"><span class="nav-number">1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#小程序开发"><span class="nav-number">2.</span> <span class="nav-text">小程序开发</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#小程序限制"><span class="nav-number">2.1.</span> <span class="nav-text">小程序限制</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#认证-审核-权限"><span class="nav-number">2.1.1.</span> <span class="nav-text">认证/审核/权限</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#域名限制"><span class="nav-number">2.1.2.</span> <span class="nav-text">域名限制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#其他"><span class="nav-number">2.1.3.</span> <span class="nav-text">其他</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#web-view开发"><span class="nav-number">2.2.</span> <span class="nav-text">web-view开发</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#web-view限制"><span class="nav-number">2.2.1.</span> <span class="nav-text">web-view限制</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#微信H5开发"><span class="nav-number">3.</span> <span class="nav-text">微信H5开发</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#JS-SDK"><span class="nav-number">3.1.</span> <span class="nav-text">JS-SDK</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#内网穿透"><span class="nav-number">3.2.</span> <span class="nav-text">内网穿透</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#公众号开发"><span class="nav-number">4.</span> <span class="nav-text">公众号开发</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#微信登录"><span class="nav-number">5.</span> <span class="nav-text">微信登录</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#微信浏览器中获取用户信息"><span class="nav-number">5.1.</span> <span class="nav-text">微信浏览器中获取用户信息</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#微信支付"><span class="nav-number">6.</span> <span class="nav-text">微信支付</span></a></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright"> &copy; 2016 - <span itemprop="copyrightYear">2022</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">smalle</span>&nbsp;&nbsp;&nbsp;&nbsp;<div class="powered-by"> 由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div><div class="powered-by"> 主题 - <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a></div><div class="theme-info cnzz" style="margin:0 0 -5px 10px"><script type="text/javascript">var cnzz_protocol="https:"==document.location.protocol?"https://":"http://";document.write(unescape("%3Cspan id='cnzz_stat_icon_1276691827'%3E%3C/span%3E%3Cscript src='"+cnzz_protocol+"s23.cnzz.com/z_stat.php%3Fid%3D1276691827%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"))</script></div></div><div class="ad"> <span style="font-weight:700">AD&nbsp;&nbsp;&nbsp;&nbsp;</span><div class="theme-info"> <a target="_blank" href="https://promotion.aliyun.com/ntms/yunparter/invite.html?userCode=oby5nolb">阿里云大礼包</a></div></div><div class="aezocn"> <span style="font-weight:700">@AEZO.CN&nbsp;&nbsp;&nbsp;&nbsp;</span><div class="theme-info"> <a target="_blank" href="http://shop.aezo.cn/">杂货铺</a></div></div><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?d82223039d601f2f819f8fe140a63468";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script><script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script type="text/javascript" src="/js/src/js.cookie.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/scroll-cookie.js?v=5.1.1"></script></body></html>