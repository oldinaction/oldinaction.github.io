<!doctype html><html class="theme-next mist use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css"><meta name="keywords" content="spring,mvc,"><link rel="alternate" href="/atom.xml" title="月星墙的博客" type="application/atom+xml"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1"><meta name="description" content="介绍 Spring项目官网：https://spring.io/projects ，其中的spring-framework即是spring框架内容 历史：(1) spring 1.x，xml配置时代 (2) spring 2.x，注解时代 (3) spring 3.x，java配置 Spring模块(每个模块有个jar包)： 核心容器：spring-core, spring-beans, spri"><meta name="keywords" content="spring,mvc"><meta property="og:type" content="article"><meta property="og:title" content="Spring"><meta property="og:url" content="http://blog.aezo.cn/2017/07/01/java/spring/index.html"><meta property="og:site_name" content="月星墙的博客"><meta property="og:description" content="介绍 Spring项目官网：https://spring.io/projects ，其中的spring-framework即是spring框架内容 历史：(1) spring 1.x，xml配置时代 (2) spring 2.x，注解时代 (3) spring 3.x，java配置 Spring模块(每个模块有个jar包)： 核心容器：spring-core, spring-beans, spri"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="http://blog.aezo.cn/data/images/java/springmvc-flow.png"><meta property="og:image" content="http://blog.aezo.cn/data/images/java/Filter-Interceptor.png"><meta property="og:updated_time" content="2025-03-26T06:29:46.103Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Spring"><meta name="twitter:description" content="介绍 Spring项目官网：https://spring.io/projects ，其中的spring-framework即是spring框架内容 历史：(1) spring 1.x，xml配置时代 (2) spring 2.x，注解时代 (3) spring 3.x，java配置 Spring模块(每个模块有个jar包)： 核心容器：spring-core, spring-beans, spri"><meta name="twitter:image" content="http://blog.aezo.cn/data/images/java/springmvc-flow.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",sidebar:{position:"right",display:"post",offset:12,offset_float:0,b2t:!1,scrollpercent:!1},fancybox:!0,motion:!0,duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"BWD6R9FA4K",apiKey:"3330f3cbaa099dfc30395de5f5b20151",indexName:"blog",hits:{per_page:10},labels:{input_placeholder:"请输入关键字",hits_empty:"我们没有找到任何搜索结果: ${query}",hits_stats:"找到约${hits}条结果（用时${time}ms）"}}}</script><link rel="canonical" href="http://blog.aezo.cn/2017/07/01/java/spring/"><title>Spring | 月星墙的博客</title><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?085f9cd91ef2ad985f791c677472f0d1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-right page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">月星墙的博客</span><span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">Better Code, Better Life</h1></div><div class="site-nav-toggle"> <button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br> 首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br> 分类</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br> 关于</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br> 归档</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br> 标签</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i><br> 站点地图</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br> 搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"> <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><link itemprop="mainEntityOfPage" href="http://blog.aezo.cn/2017/07/01/java/spring/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="smalle"><meta itemprop="description" content=""><meta itemprop="image" content="https://avatars0.githubusercontent.com/u/15698218?v=3&u=ce740bf0b67ff0d74990ba6fc644d6e92f572dcb&s=400"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="月星墙的博客"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">Spring</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-01T18:47:00+08:00">2017-07-01</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a></span></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><ul><li>Spring项目官网：<a href="https://spring.io/projects" target="_blank" rel="noopener">https://spring.io/projects</a> ，其中的<code>spring-framework</code>即是spring框架内容</li><li>历史：(1) spring 1.x，xml配置时代 (2) spring 2.x，注解时代 (3) <strong>spring 3.x，java配置</strong></li><li>Spring模块(每个模块有个jar包)：<ul><li>核心容器：<code>spring-core</code>, <code>spring-beans</code>, <code>spring-context</code>(运行时spring容器), <code>spring-context-support</code>(spring对第三方包的集成支持), <code>spring-expression</code>(使用表达式语言在运行时查询和操作对象)</li><li>AOP：spring-aop, spring-aspects</li><li>消息：spring-messaging</li><li>数据访问：<code>spring-jdbc</code>, <code>spring-tx</code>(提供编程式和声明明式事物支持), <code>spring-orm</code>, <code>spring-oxm</code>(提供对对象/xml映射技术支持), <code>spring-jms</code>(提供jms支持)</li><li>Web： <code>spring-web</code>(在web项目中提供spring容器), <code>spring-webmvc</code>(基于Servlet的SpringMVC), <code>spring-websocket</code>, <code>spring-webmvc-portlet</code></li></ul></li><li>Spring生态：<code>Spring Boot</code>(使用默认开发配置来快速开发)、<code>Spring Cloud</code>(为分布式系统开发提供工具集)等</li><li>本文档基于Spring4.3.8</li></ul><h2 id="HelloWorld"><a href="#HelloWorld" class="headerlink" title="HelloWorld"></a>HelloWorld</h2><ul><li><p>maven依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--包含spring-core、spring-beans、spring-aop、spring-expression、spring-instrument--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.8.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>调用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ApplicationContext context = new ClassPathXmlApplicationContext("beans.xml");</span></span><br><span class="line">ApplicationContext context = <span class="keyword">new</span> AnnotationConfigApplicationContext(AppConfig.class); <span class="comment">// AppConfig为定义的java配置类</span></span><br><span class="line"></span><br><span class="line">Hello hello = context.getBean(<span class="string">"hello"</span>, Hello.class);</span><br><span class="line">hello.hello();</span><br></pre></td></tr></table></figure></li></ul><h2 id="常见注解"><a href="#常见注解" class="headerlink" title="常见注解"></a>常见注解</h2><h3 id="往容器中注册Bean-组件"><a href="#往容器中注册Bean-组件" class="headerlink" title="往容器中注册Bean(组件)"></a>往容器中注册Bean(组件)</h3><h4 id="组件注解-包扫描"><a href="#组件注解-包扫描" class="headerlink" title="组件注解+包扫描"></a>组件注解+包扫描</h4><ul><li>组件注解(下面几个注解效果一样)<ul><li><code>@Component</code> 没有明确的角色，或@Component(“sq”)定义别名</li><li><code>@Service</code> 在业务逻辑层(cn.aezo.spring.aop_spel.service)使用</li><li><code>@Repository</code> 在数据访问层(cn.aezo.spring.aop_spel.dao)使用</li><li><code>@Controller</code> 在展现层使用</li></ul></li><li>包扫描<code>@ComponetScan(&quot;cn.aezo&quot;)</code><ul><li>@ComponentScan(basePackages = {“cn.aezo.sqbiz”, “cn.aezo.utils”})</li><li>定义需要扫描的包名，并将里面的<code>@Component</code>、<code>@Service</code>、<code>@Repository</code>、<code>@Controller</code>注解的类注册为Bean</li></ul></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// java8 @Repeatable表示可重复注解 excludeFilters不扫描过滤，includeFilters扫描过滤(需设置useDefaultFilters=false)</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(value = <span class="string">"cn.aezo.demo"</span>, excludeFilters = &#123;</span><br><span class="line">    <span class="comment">// 基于注解</span></span><br><span class="line">    <span class="meta">@ComponentScan</span>.Filter(type = FilterType.ANNOTATION, classes = &#123;Controller.class&#125;)</span><br><span class="line">    <span class="comment">// 基于类全名</span></span><br><span class="line">    <span class="meta">@ComponentScan</span>.Filter(type = FilterType.ASSIGNABLE_TYPE, classes = &#123;cn.aezo.demo.MyTest&#125;)</span><br><span class="line">    <span class="comment">// 基于自定义规则(实现FilterType接口)</span></span><br><span class="line">    <span class="meta">@ComponentScan</span>.Filter(type = FilterType.CUSTOM, classes = &#123;MyFilterType.class&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="meta">@ComponentScan</span>(value = <span class="string">"cn.aezo.demo"</span>, includeFilters = &#123;</span><br><span class="line">    <span class="meta">@ComponentScan</span>.Filter(type = FilterType.REGEX, pattern = <span class="string">"cn\\.aezo\\.test.*"</span>)</span><br><span class="line">&#125;, useDefaultFilters = <span class="keyword">false</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// java8之前可使用@ComponentScans</span></span><br><span class="line"><span class="meta">@ComponentScans</span>(&#123;<span class="meta">@ComponentScan</span>()&#125;)</span><br></pre></td></tr></table></figure><h4 id="Bean导入第三方包里面的组件"><a href="#Bean导入第三方包里面的组件" class="headerlink" title="@Bean导入第三方包里面的组件"></a>@Bean导入第三方包里面的组件</h4><ul><li><code>@Bean</code><ul><li>注解配置类中的方法，表示当前方法的返回值是一个Bean，Bean的名称(id)默认是方法名</li><li><code>@Bean(&quot;newBeanName&quot;)</code> 自定义Bean名称</li><li>Springboot项目，将<code>@Bean</code>加入在test的代码中时无法注入</li></ul></li></ul><h4 id="Import给容器导入一个组件"><a href="#Import给容器导入一个组件" class="headerlink" title="@Import给容器导入一个组件"></a>@Import给容器导入一个组件</h4><ul><li><code>@Import(&quot;cn.aezo.test.MyBean&quot;)</code><ul><li>Spring Boot中大量的EnableXXX都使用了@Import注解</li><li>可以导入普通的POJO类或带有<code>@Configuration</code>注解的配置类，或导入实现了<code>ImportSelector</code>/<code>ImportBeanDefinitionRegistrar</code>/<code>DeferredImportSelector</code>接口的返回的类。功能类似XML配置用来导入配置类<ul><li>DeferredImportSelector 为 ImportSelector 的子接口。区别是他会在所有的@Configuration类加载完成之后再加载返回的配置类，而ImportSelector会在当前Configuration类加载之前去加载返回的配置类</li><li>可以使用@Order注解或者Ordered接口来指定DeferredImportSelector的加载顺序</li></ul></li><li><code>@ImportResource</code> 和@Import类似，区别就是@ImportResource导入的是配置文件。其属性default和locations作用相同，都是用来指定配置文件的位置；reader属性则用来指定配置文件解析器，内置XmlBeanDefinitionReader和GroovyBeanDefinitionReader，也可自定义。Spring还是推荐使用@Import而不是@ImportResource</li></ul></li><li><code>@Import</code>结合<code>ImportSelector</code></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ### 基于导入选择器</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyImportSelector</span> <span class="keyword">implements</span> <span class="title">ImportSelector</span> </span>&#123;</span><br><span class="line">    <span class="comment">// AnnotationMetadata可获取当前注解@Import类的所有注解信息</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String[] selectImports(AnnotationMetadata importingClassMetadata) &#123;</span><br><span class="line">        <span class="comment">// 返回需要的导入的Bean类全名（可以不用是真实类名）</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String[] &#123;<span class="string">"cn.aezo.smjava.javaee.spring5.bean.demo2.MyImportSelectorBean"</span>, MyImportSelectorBean.class.getName()&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ### 使用</span></span><br><span class="line"><span class="meta">@Import</span>(&#123;MyImportSelector.class&#125;)</span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppImport</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">( String[] args )</span> </span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext ctx = <span class="keyword">new</span> AnnotationConfigApplicationContext(AppImport.class);</span><br><span class="line"></span><br><span class="line">        System.out.println(ctx.getBean(MyImportSelectorBean.class));</span><br><span class="line"></span><br><span class="line">        String[] names = ctx.getBeanDefinitionNames();</span><br><span class="line">        <span class="keyword">for</span> (String name : names) &#123;</span><br><span class="line">            System.out.println(name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>@Import</code>结合<code>ImportBeanDefinitionRegistrar</code></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ### 基于ImportBeanDefinitionRegistrar</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SmImportBeanDefinitionRegistrar</span> <span class="keyword">implements</span> <span class="title">ImportBeanDefinitionRegistrar</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> annotationMetadata 当前类的注解信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanDefinitionRegistry BeanDefinition注册类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(AnnotationMetadata annotationMetadata, BeanDefinitionRegistry beanDefinitionRegistry)</span> </span>&#123;</span><br><span class="line">        BeanDefinitionBuilder beanDefinitionBuilder = BeanDefinitionBuilder.genericBeanDefinition(MyBean.class);</span><br><span class="line">        beanDefinitionBuilder.addPropertyValue(<span class="string">"name"</span>, <span class="string">"ImportBeanDefinitionRegistrar#registerBeanDefinitions"</span>);</span><br><span class="line"></span><br><span class="line">        GenericBeanDefinition genericBeanDefinition = (GenericBeanDefinition) beanDefinitionBuilder.getBeanDefinition();</span><br><span class="line"></span><br><span class="line">        beanDefinitionRegistry.registerBeanDefinition(<span class="string">"myBean"</span>, genericBeanDefinition);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ### 使用</span></span><br><span class="line"><span class="meta">@Import</span>(SmImportBeanDefinitionRegistrar.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppConfig</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure><ul><li>可对Import进一步封装</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(&#123;ElementType.TYPE&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@Import</span>(&#123;MyImportSelector.class&#125;)</span><br><span class="line"><span class="keyword">public</span><span class="meta">@interface</span> EnableMyImportSelector &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用</span></span><br><span class="line"><span class="meta">@EnableMyImportSelector</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure><h4 id="使用Spring提供的FactoryBean-工厂Bean"><a href="#使用Spring提供的FactoryBean-工厂Bean" class="headerlink" title="使用Spring提供的FactoryBean(工厂Bean)"></a>使用Spring提供的FactoryBean(工厂Bean)</h4><ul><li>通过<code>id(name)</code>获取的是FactoryBean的getObject返回的对象。使用<code>&amp;name</code>可获取FactoryBean本身</li><li><code>BeanFactory</code>和<code>FactoryBean</code>区别 <a href="https://www.cnblogs.com/aspirant/p/9082858.html" target="_blank" rel="noopener">https://www.cnblogs.com/aspirant/p/9082858.html</a></li><li>模拟mybatis参考源码<code>smjava -&gt; javaee -&gt; springArch -&gt; spring5 -&gt; demo3</code></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ### 实现FactoryBean</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyFactoryBean</span> <span class="keyword">implements</span> <span class="title">FactoryBean</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MyBean <span class="title">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyBean();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; getObjectType() &#123;</span><br><span class="line">        <span class="keyword">return</span> MyBean.class;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// JDK8可提供isSingleton默认实现</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ### 使用</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">( String[] args )</span> </span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext ctx = <span class="keyword">new</span> AnnotationConfigApplicationContext(App.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取的是FactoryBean中getObject返回的对象</span></span><br><span class="line">        MyBean myBean = (MyBean) ctx.getBean(<span class="string">"myFactoryBean"</span>);</span><br><span class="line">        System.out.println(myBean);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取的是FactoryBean本身</span></span><br><span class="line">        MyFactoryBean myFactoryBean = (MyFactoryBean) ctx.getBean(<span class="string">"&amp;myFactoryBean"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MyFactoryBean <span class="title">myFactoryBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyFactoryBean();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="基于Springboot的EnableAutoConfiguration"><a href="#基于Springboot的EnableAutoConfiguration" class="headerlink" title="基于Springboot的EnableAutoConfiguration"></a>基于Springboot的EnableAutoConfiguration</h4><ul><li>第三方类(不在ComponentScan的扫描范围)</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThdClass</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在 META-INF/spring.factories 增加自动配置类</span></span><br><span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration=cn.aezo.test.thd.ThdClass</span><br></pre></td></tr></table></figure><h3 id="自动装配-取出Bean赋值给当前类属性"><a href="#自动装配-取出Bean赋值给当前类属性" class="headerlink" title="自动装配(取出Bean赋值给当前类属性)"></a>自动装配(取出Bean赋值给当前类属性)</h3><ul><li><code>@Autowired</code> Spring提供<ul><li><strong>默认按ByType(根据类型)，如果根据类型找到多个再按照ByName(变量名称)注入(如果此时名称不存在则报错)</strong><ul><li>如果想用by name，Bean定义时如<code>@Bean(name=&quot;my-bean-name&quot;)，再联合使用</code>@Qualifier(“my-bean-name”)<code>。</code>对于默认的Bean可通过添加<code>@Primary</code>(使用时则按照单数据源注入)</li></ul></li><li>可以对<strong>方法、字段、构造器、参数</strong>使用</li><li>注入集合方式<ul><li><code>@Autowired List&lt;Monitor&gt; monitors;</code> 也可以注入集合<ul><li>注意：如果当前类实现了Monitor接口，则注入到集合中会排除当前类（即要注入的类不能是类本身，会触发无限递归注入）</li><li>如果元素增加<code>@Order</code>注解，在注入时会自动进行排序。也可使用 <code>list.sort(AnnotationAwareOrderComparator.INSTANCE)</code> 手动排序list(用于非注入的场景，元素也需要增加 @Order 注解)。<strong>值越小越优先，可以为负值</strong></li></ul></li><li><code>@Autowired Map&lt;String, Monitor&gt; monitorMap;</code> 注入到Map中，此时将 Bean 的 name 作为 key</li></ul></li></ul></li><li><code>@Resource</code> JSR-250提供(常用)<ul><li><strong>先按ByName名称查找(当然类型也必须匹配)，如果找不到再按ByType类型查找(如果根据类型找到多个则报错)</strong></li><li>只能对<strong>方法、字段</strong>使用</li></ul></li><li><code>@Inject</code> JSR-330提供，类似@Autowired</li><li>@Autowired和@Resource推荐用法<ul><li>根据使用场景：@Resource倾向于确定性的单一资源，@Autowired为类型去匹配符合此类型所有资源</li><li>使用@Autowired时，推荐使用构造函数注入和set方法注入</li><li>参考：<a href="https://zhuanlan.zhihu.com/p/615487137" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/615487137</a></li></ul></li><li><strong>各种DI方式的优缺点</strong><ul><li>构造器注入：强依赖性 （即必须使用此依赖），不变性（各依赖不会经常变动）</li><li>Setter注入：可选（没有此依赖也可以工作），可变（依赖会经常变动）</li><li>Field注入：大多数情况下尽量少使用字段注入，一定要使用的话，@Resource相对@Autowired 对IoC容器的耦合更低<ul><li>Field注入的优点<ul><li>使用方便(优先敏捷度再考虑松耦合)</li></ul></li><li>Field注入的缺点<ul><li>不能像构造器那样注入不可变的对象</li><li>依赖对外部不可见 ，外界可以看到构造器和setter，但无法看到私有字段，自然无法了解所需依赖</li><li>会导致组件与IoC容器紧耦合 （这是最重要的原因，离开了IoC容器去使用组件，在注入依赖时就会十分困难）</li><li>导致单元测试也必须使用IoC容器 ，原因同上</li><li>依赖过多时不够明显 ，比如我需要10个依赖，用构造器注入就会显得庞大，这时候应该考虑一下此组件是不是违反了单一职责原则</li></ul></li></ul></li></ul></li></ul><h4 id="获取Bean"><a href="#获取Bean" class="headerlink" title="获取Bean"></a>获取Bean</h4><ul><li>自动注入 <a href="http://www.cnblogs.com/yjbjingcha/p/6752265.html" title="Spring在代码中获取bean的几种方式" target="_blank" rel="noopener">^5</a></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	Mytest mytest = applicationContext.getBean(Mytest.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>实现<code>ApplicationContextAware</code>接口，参考下文<a href="#ApplicationContext">ApplicationContext:SpringU</a><ul><li>下列工具相当于把<code>ApplicationContext</code>存储在属性中，其他类对象可通过此对象属性获取ApplicationContext</li><li>上述其他类对象，如自行new的对象中需要注入其他Bean，此时当前类没有被Spring托管，则可通过SpringU中间缓存获取</li></ul></li></ul><h4 id="Autowired注入给静态属性示例"><a href="#Autowired注入给静态属性示例" class="headerlink" title="@Autowired注入给静态属性示例"></a>@Autowired注入给静态属性示例</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseController</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(BaseController.class);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> CustomObjectMapper customObjectMapper;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">BaseController</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span> <span class="comment">// 类加载时调用此构造方法并赋值给静态属性</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseController</span><span class="params">(CustomObjectMapper customObjectMapper)</span> </span>&#123;</span><br><span class="line">        BaseController.customObjectMapper = customObjectMapper;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="条件注解-Conditional"><a href="#条件注解-Conditional" class="headerlink" title="条件注解@Conditional"></a>条件注解@Conditional</h3><ul><li>根据满足某一特定条件来创建某个特定的Bean. 如某个Bean创建后才会创建另一个Bean(Spring 4.x)</li><li>类似的如<code>@Profile(&quot;dev&quot;)</code>标识仅在开发环境才会注入此Bean</li><li><p>内置条件</p><ul><li><code>@ConditionalOnProperty</code> 要求配置属性匹配条件<ul><li><code>havingValue</code> 表示对应参数值。注解中如果省略此属性，则此参数为false时，条件结果才为false</li><li><code>matchIfMissing</code> 表示缺少该配置属性时是否可以加载。如果为true，即表示没有该配置属性时也会正常加载；反之则不会生效</li><li>eg：@ConditionalOnProperty(value = {“feign.compression.response.enabled”}, matchIfMissing = false) 、@ConditionalOnProperty(name = “zuul.use-filter”, havingValue = “true”, matchIfMissing = false)</li></ul></li><li><p><code>@ConditionalOnMissingBean</code> 当给定的类型/类名/注解在beanFactory中不存在时返回true，各类型间是or的关系(不填参数则表示没有@Bean返回的对象类型时生效)</p><ul><li><p><strong>只能对@Bean生效，如直接注解在@Bean的方法上，或注解在含有@Bean方法的类上；对@Service等类不生效，需要设置成@Bean模式</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// eg：@ConditionalOnMissingBean(type = &#123;"okhttp3.OkHttpClient"&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//可以标注在类和方法上</span></span><br><span class="line"><span class="meta">@Target</span>(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="comment">//使用了@Conditional注解，条件类是OnBeanCondition(逻辑实现)</span></span><br><span class="line"><span class="meta">@Conditional</span>(&#123;OnBeanCondition.class&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ConditionalOnMissingBean &#123;</span><br><span class="line">    <span class="comment">// 需要检查的 bean 的 class 类型。如: @ConditionalOnMissingBean(value = MyService.class)</span></span><br><span class="line">    Class&lt;?&gt;[] value() <span class="keyword">default</span> &#123;&#125;; </span><br><span class="line">    <span class="comment">// 需要检查的 bean 的 class 类型名称。默认。@ConditionalOnMissingBean(type = "MyService") == @ConditionalOnMissingBean</span></span><br><span class="line">    String[] type() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">    <span class="comment">// 识别匹配 bean 时，可以被忽略的 bean 的 class 类型</span></span><br><span class="line">    Class&lt;?&gt;[] ignored() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">    <span class="comment">// 识别匹配 bean 时，可以被忽略的 bean 的 class 类型名称</span></span><br><span class="line">    String[] ignoredType() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">    <span class="comment">// 当 ApplicationContext 不包含带有这些注解的 bean 时条件匹配。如：@ConditionalOnMissingBean(annotation = MyServiceAnno.class)</span></span><br><span class="line">    Class&lt;? extends Annotation&gt;[] annotation() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">    <span class="comment">// 需要检查的 bean 的 name。如: @ConditionalOnMissingBean(name = "myService")</span></span><br><span class="line">    String[] name() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">    <span class="comment">// 搜索容器层级:当前容器/父容器/所有(默认)</span></span><br><span class="line">    <span class="function">SearchStrategy <span class="title">search</span><span class="params">()</span> <span class="keyword">default</span> SearchStrategy.ALL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></li><li><p><code>@ConditionalOnBean</code> 与上相反，在存在某个bean的时候</p><ul><li>eg：@ConditionalOnBean({Client.class})</li></ul></li><li><code>@ConditionalOnMissingClass</code> 当前classpath不可以找到某个类型的类时，各类型间是and的关系</li><li><code>@ConditionalOnClass</code> 与上相反，当前classpath可以找到某个类型的类时<ul><li>eg：@ConditionalOnClass({Feign.class})、@ConditionalOnClass(name = {“feign.hystrix.HystrixFeign”})</li></ul></li><li><code>@ConditionalOnResource</code> 当前classpath是否存在某个资源文件</li><li><code>@ConditionalOnWebApplication</code> 当前spring context是否是web应用程序</li><li><code>@ConditionalOnNotWebApplication</code> web环境不存在时</li><li><code>@ConditionalOnExpression</code> spel表达式执行为true</li><li><code>@ConditionalOnSingleCandidate</code> 当给定类型的bean存在并且指定为Primary的给定类型存在时返回true</li><li><code>@ConditionalOnCloudPlatform</code> 当所配置的CloudPlatform为激活时返回true</li><li><code>@ConditionalOnJava</code> 运行时的java版本号是否包含给定的版本号，如果包含返回匹配，否则返回不匹配</li><li><code>@ConditionalOnJndi</code> 给定的jndi的Location 必须存在一个，否则返回不匹配</li></ul></li><li>自定义条件</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ## 条件判断</span></span><br><span class="line"><span class="meta">@Conditional</span>(&#123;MyWindowsCondition.class&#125;) <span class="comment">// 必须符合所有的条件才会注入此Bean(可以注解在类或方法上)</span></span><br><span class="line"><span class="comment">// @MyWindowsConditionOnCustomProperty("true")</span></span><br><span class="line"><span class="meta">@Bean</span>(<span class="string">"myBean3"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> MyBean <span class="title">myBean3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MyBean();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ## 条件</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyWindowsCondition</span> <span class="keyword">implements</span> <span class="title">Condition</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断是否符合条件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context 判断条件能使用的上下文</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> metadata 注解信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(ConditionContext context, AnnotatedTypeMetadata metadata)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1.可以获取到IOC使用的BeanFactory</span></span><br><span class="line">        ConfigurableListableBeanFactory ctx = context.getBeanFactory();</span><br><span class="line">        <span class="comment">// 2.可以获取类加载器</span></span><br><span class="line">        ClassLoader classLoader = context.getClassLoader();</span><br><span class="line">        <span class="comment">// 3.可以获取当前环境信息</span></span><br><span class="line">        Environment environment = context.getEnvironment();</span><br><span class="line">        <span class="comment">// 4.可以获取Bean定义注册类</span></span><br><span class="line">        BeanDefinitionRegistry registry = context.getRegistry();</span><br><span class="line">        ResourceLoader resourceLoader = context.getResourceLoader();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(environment.getProperty(<span class="string">"os.name"</span>).contains(<span class="string">"Windows"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (可选)自定义参数注解时</span></span><br><span class="line">        Map&lt;String, Object&gt; attributes = metadata.getAnnotationAttributes(MyWindowsConditionOnCustomProperty.class.getName());</span><br><span class="line">        <span class="keyword">if</span> (attributes != <span class="keyword">null</span>) &#123;</span><br><span class="line">            String expectedValue = (String) attributes.get(<span class="string">"value"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义参数注解时</span></span><br><span class="line"><span class="meta">@Target</span>(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Conditional</span>(MyWindowsCondition.class)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> MyWindowsConditionOnCustomProperty &#123;</span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="属性赋值-Value"><a href="#属性赋值-Value" class="headerlink" title="属性赋值(@Value)"></a>属性赋值(@Value)</h3><h4 id="Spring中使用属性赋值"><a href="#Spring中使用属性赋值" class="headerlink" title="Spring中使用属性赋值"></a>Spring中使用属性赋值</h4><ul><li><code>@Value</code> 在其中输入EL表达式(Spring-EL)。可对资源进行注入</li><li><code>@PropertySource</code> 注入外部配置文件值</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @ComponentScan("cn.aezo.spring.base.annotation.el")</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@PropertySource</span>(<span class="string">"classpath:cn/aezo/spring/base/annotation/el/el.properties"</span>) <span class="comment">// 注入配置文件</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ELConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"I Love You"</span>) <span class="comment">// 基本数值赋值</span></span><br><span class="line">    <span class="keyword">private</span> String normal;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;site.url:www.aezo.cn&#125;/index.html"</span>) <span class="comment">// 读取配置文件(需要注入配置文件)，使用$而不是#。冒号后面是缺省值. `$&#123;site.url:&#125;`无则为""，防止未定义此参数值(特别是通过命令行传入的参数)</span></span><br><span class="line">    <span class="keyword">private</span> String siteUrl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对于普通的Boolean(值不要加引号)、Integer、Long、Float、Double均可使用$&#123;xxx&#125;直接导入</span></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"#&#123;$&#123;site.time&#125;&#125;"</span>) <span class="comment">// site.time=24*7，此处进行了计算</span></span><br><span class="line">    <span class="keyword">private</span> Long siteTime;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;site.tags:$&#123;site.tags2:&#125;&#125;"</span>) <span class="comment">// @Value注入的默认值只能通过:指定，不能直接给属性赋值</span></span><br><span class="line">    <span class="keyword">private</span> String[] tags; <span class="comment">// 获取数组，yml中可定义site.tags=a,b,c # 默认会基于`,`分割。(yml中使用`-`则需要定义配置类实体)</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"#&#123;'$&#123;test.array&#125;'.split(',')&#125;"</span>) <span class="comment">// test.array=1,2,3</span></span><br><span class="line">    <span class="keyword">private</span> String[] testArray;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"#&#123;'$&#123;test.list&#125;'.split(',')&#125;"</span>)  <span class="comment">// test.list=1,2,3</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; testList;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"#&#123;'$&#123;test.set&#125;'.split(',')&#125;"</span>)   <span class="comment">// test.set=1,2,3</span></span><br><span class="line">    <span class="keyword">private</span> Set&lt;String&gt; testSet;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"#&#123;$&#123;test.map:&#123;&#125;&#125;&#125;"</span>)             <span class="comment">// test.map=&#123;name:"张三", age:18&#125;，注意是#取值，yml中只定义成字符串(可以用''包裹换行)，且map的值不能包含数组</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; testMap;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"#&#123;systemProperties['os.name']&#125;"</span>) <span class="comment">// 获取系统名称. SpEL: @Value("#&#123;20-2&#125;") =&gt; 18</span></span><br><span class="line">    <span class="keyword">private</span> String osName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"#&#123;T(java.lang.Math).random() * 100.0&#125;"</span>) <span class="comment">// 支持调用静态方法，不支持调用对象方法(会当成map取对象属性)</span></span><br><span class="line">    <span class="keyword">private</span> String randomNumber;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"#&#123;demoService.another&#125;"</span>) <span class="comment">// 读取其他类属性的@Value注解值</span></span><br><span class="line">    <span class="keyword">private</span> String fromAnother;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"classpath:cn/aezo/spring/base/annotation/el/test.txt"</span>)</span><br><span class="line">    <span class="keyword">private</span> Resource testFile;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"http://www.baidu.com"</span>)</span><br><span class="line">    <span class="keyword">private</span> Resource testUrl;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Environment environment; <span class="comment">// org.springframework.core.env.Environment</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 静态熟悉赋值</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String staticKey;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;site.staticKey&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setStaticKey</span><span class="params">(String staticKey)</span> </span>&#123;</span><br><span class="line">        ELConfig.staticKey = staticKey;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">outputResource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"normal = "</span> + normal);</span><br><span class="line">        System.out.println(<span class="string">"osName = "</span> + osName);</span><br><span class="line">        System.out.println(<span class="string">"randomNumber = "</span> + randomNumber);</span><br><span class="line">        System.out.println(<span class="string">"siteUrl = "</span> + siteUrl);</span><br><span class="line">        System.out.println(<span class="string">"fromAnother = "</span> + fromAnother);</span><br><span class="line">        <span class="comment">// 配置文件中的值默认全部赋值到了环境变量中了。也支持多环境配置</span></span><br><span class="line">        System.out.println(<span class="string">"environment = "</span> + environment.getProperty(<span class="string">"site.url"</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 解析yml的map, 未测试</span></span><br><span class="line">        Map&lt;String, String&gt; map = environment.getProperty(<span class="string">"my-map"</span>, Map.class);</span><br><span class="line">        Map&lt;String, Integer&gt; map2 = environment.getProperty(<span class="string">"my-map2"</span>, Map.class, Integer.class);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">"testFile = "</span> + IOUtils.toString(testFile.getInputStream(), <span class="string">"UTF-8"</span>));</span><br><span class="line">            System.out.println(<span class="string">"testUrl = "</span> + IOUtils.toString(testUrl.getInputStream(), <span class="string">"UTF-8"</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// el.properties</span></span><br><span class="line">site.url=www.aezo.cn</span><br></pre></td></tr></table></figure><h4 id="SpringBoot中使用属性赋值"><a href="#SpringBoot中使用属性赋值" class="headerlink" title="SpringBoot中使用属性赋值"></a>SpringBoot中使用属性赋值</h4><ul><li><code>@PropertySource</code> 在springboot应用中注入外部配置文件值，支持如下两种配置方式，如果注入application配置则@PropertySource可省略<ul><li>@PropertySource + @Value</li><li>@PropertySource + @ConfigurationProperties</li></ul></li><li><p>springboot v2.0.1之后，定义自定义参数(MyValue.java)要么写到Application.java同目录，要么加下列依赖。这个依赖会把配置文件的值注入到@Value里面，也可以通过@PropertySource(“classpath:application.yml”)注入</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>定义/调用</p><ul><li>优先级：命令行参数 &gt; application.properties &gt; JavaBean</li><li>说明：命令行参数设置了此属性配置，但属性的值为空，此时可以覆盖<code>application.properties</code>的初始值，但是不会覆盖JavaBean的初始值</li></ul></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ### 方法一</span></span><br><span class="line"><span class="comment">// 设值：在application.properties中设置`myValue.val`的值</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 取值</span></span><br><span class="line"><span class="meta">@Value</span>(<span class="string">"$&#123;myValue.val"</span>)</span><br><span class="line"><span class="keyword">private</span> String val = <span class="string">"smalle"</span>; <span class="comment">// 默认值。在命令行参数给此属性传入空时，此初始值不会被覆盖</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String hello;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Value</span>(<span class="string">"$&#123;myValue.hello&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setHello</span><span class="params">(String h)</span> </span>&#123;</span><br><span class="line">	hello = h;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方法二：定义JavaBean</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"myValue"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyValue</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...Model：所有的属性、get、set方法</span></span><br><span class="line">    <span class="comment">// myField, my-field, my_field等都能识别绑定到myField上</span></span><br><span class="line">    <span class="comment">// 可以给字段设定默认值</span></span><br><span class="line">    <span class="keyword">private</span> String val = <span class="string">"default"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String hello;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; extMap; <span class="comment">// 如 myValue.extMap.a=1 和 myValue.extMap.b=2 可注入进来</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 取值</span></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> MyValue myValue;</span><br></pre></td></tr></table></figure><h4 id="PropertySource分环境读取配置"><a href="#PropertySource分环境读取配置" class="headerlink" title="@PropertySource分环境读取配置"></a>@PropertySource分环境读取配置</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建 minions.yml、minions-dev.yml 等配置文件。可根据环境读取，且支持覆盖</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"minions"</span>)</span><br><span class="line"><span class="meta">@PropertySource</span>(name=<span class="string">"minions.yml"</span>, value = <span class="string">"classpath:minions-$&#123;spring.profiles.active:&#125;.yml"</span>, factory = SqPropertySourceFactory.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MinionsProp</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String projectCode;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DataProp data = <span class="keyword">new</span> DataProp();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataProp</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> String rootPath;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SqPropertySourceFactory</span> <span class="keyword">extends</span> <span class="title">DefaultPropertySourceFactory</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> PropertySource&lt;?&gt; createPropertySource(String name, EncodedResource resource) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        Properties mainProperties = <span class="keyword">new</span> Properties();</span><br><span class="line">        <span class="keyword">if</span>(ValidU.isNotEmpty(name)) &#123;</span><br><span class="line">            <span class="keyword">if</span>(!name.contains(<span class="string">"."</span>)) &#123;</span><br><span class="line">                name += <span class="string">".properties"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            mainProperties = loadProp(name, resource.getEncoding());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Properties envProperties = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span>(resource != <span class="keyword">null</span>) &#123;</span><br><span class="line">            String sourceName = resource.getResource().getFilename();</span><br><span class="line">            <span class="keyword">if</span>(ValidU.isNotEmpty(sourceName) &amp;&amp; resource.getResource().exists()) &#123;</span><br><span class="line">                envProperties = loadProp(sourceName, resource);</span><br><span class="line">                name = sourceName;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(envProperties != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mainProperties.putAll(envProperties);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PropertiesPropertySource(name, mainProperties);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Properties <span class="title">loadProp</span><span class="params">(String sourceName, String encoding)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Resource resource = <span class="keyword">new</span> ClassPathResource(sourceName);</span><br><span class="line">        EncodedResource encodedResource = <span class="keyword">new</span> EncodedResource(resource, encoding);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!encodedResource.getResource().exists()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Properties();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sourceName.endsWith(<span class="string">".yml"</span>) || sourceName.endsWith(<span class="string">".yaml"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> loadYml(encodedResource);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> PropertiesLoaderUtils.loadProperties(resource);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Properties <span class="title">loadProp</span><span class="params">(String sourceName, EncodedResource resource)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (sourceName.endsWith(<span class="string">".yml"</span>) || sourceName.endsWith(<span class="string">".yaml"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> loadYml(resource);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> PropertiesLoaderUtils.loadProperties(resource);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Properties <span class="title">loadYml</span><span class="params">(EncodedResource resource)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        YamlPropertiesFactoryBean factory = <span class="keyword">new</span> YamlPropertiesFactoryBean();</span><br><span class="line">        factory.setResources(resource.getResource());</span><br><span class="line">        factory.afterPropertiesSet();</span><br><span class="line">        <span class="keyword">return</span> factory.getObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="组合注解和元注解"><a href="#组合注解和元注解" class="headerlink" title="组合注解和元注解"></a>组合注解和元注解</h3><ul><li>元注解是指可以注解到其他注解上的注解，被元注解注解之后的注解称之为组合注解</li><li>如<code>@Configuration</code>是包含<code>@Component</code>的组合注解，<code>@Component</code>为元注解</li><li><p>示例，将<code>@Configuration</code>和<code>@ComponentScan</code>组合成一个注解</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> WiselyConfiguration &#123;</span><br><span class="line">    String[] value() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="其他注解"><a href="#其他注解" class="headerlink" title="其他注解"></a>其他注解</h3><ul><li>Http相关<ul><li>@Controller 注解在类上</li><li>@RestController 注解在类上</li><li>@GetMapping</li><li>@PostMapping</li><li>@RequestMapping 同时支持GET/POST</li><li>@PathVariable 读取URL路径参数(/api/user/{id})</li><li>@RequestParam 读取URL地址参数，默认为必传，可配置可选</li><li>@PathParam 类似@RequestParam，默认不必填</li><li>@RequestBody 读取POST数据体</li></ul></li></ul><h2 id="Bean"><a href="#Bean" class="headerlink" title="Bean"></a>Bean</h2><h3 id="作用域-Scope"><a href="#作用域-Scope" class="headerlink" title="作用域@Scope"></a>作用域@Scope</h3><ul><li><code>@Scope(&quot;prototype&quot;)</code> 注解类(配置Bean的作用域，可和<code>@Bean</code>联合使用)<ul><li><code>singleton</code> 整个容器共享一个实例(默认配置). IOC容器启动(<code>new AnnotationConfigApplicationContext()</code>)，就会创建所有的Bean(<code>@Lazy</code>懒加载，仅用于单例模式，只有在第一次获取Bean时才创建此Bean)</li><li><code>prototype</code> 每次调用新建一个实例. IOC容器启动，不会创建Bean，只有在获取的时候创建Bean<ul><li><strong>此对象<code>@Autowired</code>注入几次就会产生几个对象，和调用此对象方法无关</strong></li><li>beanFactory.getBeansOfType 等API获取Bean也会创建</li><li>如果此类型Bean含有有状态字段，则也容易产生并发问题，prototype并不能解决</li></ul></li><li><code>request</code> Web项目中，每一个HttpRequest新建一个实例</li><li><code>session</code> Web项目中，同一个session创建一个实例</li><li><code>globalSession</code> 用于portal应用</li></ul></li><li>SpringBoot的作用域如：<code>@RequestScope</code>、<code>@SessionScope</code>、<code>@ApplicationScope</code>(<code>@Component</code>等默认是<code>singleton</code>)</li></ul><h3 id="Bean生命周期"><a href="#Bean生命周期" class="headerlink" title="Bean生命周期"></a>Bean生命周期</h3><ul><li>初始化和销毁方法实现方式<ul><li>指定@Bean初始化和销毁方法属性：<code>initMethod</code>, <code>destroyMethod</code></li><li>实现<code>InitializingBean</code>, <code>DisposableBean</code>(org.springframework.beans.factory.DisposableBean)</li><li>使用JSR250：<code>@PostConstruct</code> Bean创建完成并完成属性赋值后调用, <code>@PreDestroy</code>(javax.annotation.PreDestroy) 销毁Bean前调用</li></ul></li><li><strong>后置处理器<code>BeanPostProcessor</code></strong> (org.springframework.beans.factory.config.BeanPostProcessor)<ul><li>postProcessBeforeInitialization 在Bean创建完成并完成属性赋值后，且在初始化方法调用之前调用</li><li>postProcessAfterInitialization 在初始化之后调用</li><li><code>@Autowired</code>是基于BeanPostProcessor实现的</li></ul></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">( String[] args )</span> </span>&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        constructor MyBean2...</span></span><br><span class="line"><span class="comment">        postProcessBeforeInitialization...</span></span><br><span class="line"><span class="comment">        init MyBean2...(afterPropertiesSet...)</span></span><br><span class="line"><span class="comment">        postProcessAfterInitialization...</span></span><br><span class="line"><span class="comment">        创建IOC完成...</span></span><br><span class="line"><span class="comment">        destroy MyBean2...</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        AnnotationConfigApplicationContext ctx = <span class="keyword">new</span> AnnotationConfigApplicationContext(App.class);</span><br><span class="line">        System.out.println(<span class="string">"创建IOC完成..."</span>);</span><br><span class="line"></span><br><span class="line">        ctx.close(); <span class="comment">// 容器关闭调用destroyMethod</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(initMethod = <span class="string">"init"</span>, destroyMethod = <span class="string">"destroy"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> MyBean2 <span class="title">myBean2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyBean2();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MyBean3 <span class="title">myBean3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyBean3();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// MyBeanPostProcessor需要实现BeanPostProcessor后置处理器</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MyBeanPostProcessor <span class="title">myBeanPostProcessor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyBeanPostProcessor();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ###</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBean2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyBean2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"constructor MyBean2..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @PostConstruct // Bean创建完成并完成属性赋值后调用（使用JSR250方式需要的代码）</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 此时 Environment 还没初始化，不能使用SpringU</span></span><br><span class="line">        System.out.println(<span class="string">"init MyBean2..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @PreDestroy</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"destroy MyBean2..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ### 基于接口实现</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBean3</span> <span class="keyword">implements</span> <span class="title">InitializingBean</span>, <span class="title">DisposableBean</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Bean创建完成，且属性赋值完成后调用</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"InitializingBean afterPropertiesSet MyBean3..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"DisposableBean destroy MyBean3..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="加载优先级"><a href="#加载优先级" class="headerlink" title="加载优先级"></a>加载优先级</h3><ul><li>同一个类中加载顺序<ul><li>Constructor &gt; @Autowired/@Value &gt; @PostConstruct &gt; @Bean/@Component/setApplicationContext等</li></ul></li><li>@DependsOn控制顺序<ul><li><code>@DepondensOn(&quot;springU&quot;)</code> 如在@PostConstuct方法中使用SpringU等工具类会报空指针。因为@PostConstuct修饰的方法在Spring容器启动时会先于该工具类的setApplicationContext()方法运行。解决方法参考下文 BeanPostProcessor</li><li>控制 bean 之间的实例顺序，需要注意的是 bean 的初始化方法调用顺序无法保证</li></ul></li><li>BeanPostProcessor 扩展优先于其他Bean，参考<a href="#ApplicationContext">ApplicationContext:SpringU</a></li><li><code>@Lazy</code> 和@Autowired结合使用，当两个Bean发生循环依赖时，可将其中一个Bean的注入设置成懒加载</li><li>SpringBoot下可使用<code>@AutoConfigureAfter</code>、<code>@AutoConfigureBefore</code>、<code>@AutoConfigureOrder</code> 控制自动配置类加载优先级<ul><li><code>自定义配置类</code>: 使用@Configuration等注解的类</li><li><code>自动配置类</code>: META-INF下/spring.factories文件中定义的配置类; 此文件一般用于第三方包，也可用于主项目</li><li>SpringBoot会优先加载自定义配置类，再加载自动配置类</li><li>上述3个注解只有在自动配置类下才会生效；如果一个配置类是通过@Configuration扫描加载，那么上述3个注解将无效</li></ul></li></ul><h2 id="AOP"><a href="#AOP" class="headerlink" title="AOP"></a>AOP</h2><ul><li>说明<ul><li>Spring AOP的底层原理就是动态代理，因此局限于方法拦截</li><li>Spring AOP默认是使用JDK动态代理，如果代理的类没有接口则会使用CGLib代理</li><li>JDK动态代理是需要实现某个接口了，而我们类未必全部会有接口，于是CGLib代理就有了，CGLib代理其生成的动态代理对象是目标类的子类。如果是单例的我们最好使用CGLib代理，如果是多例的我们最好使用JDK代理(JDK在创建代理对象时的性能要高于CGLib代理，而生成代理对象的运行性能却比CGLib的低)</li><li>自调用导致<code>@Transactional</code>失效问题，参考上文<a href="#事物支持">事物支持</a></li></ul></li><li>相关注解<ul><li><code>@Aspect</code> 声明一个切面</li><li><code>@Before</code>、<code>@After</code>、<code>@Around</code>、<code>@AfterReturning</code>、<code>@AfterThrowing</code> 定义建言(advice)</li><li><code>@DeclareParents</code> 引介增强</li></ul></li><li>切点表达式<ul><li>args()、this()、target()</li><li>@annotation() 、args()、@args()、target()、@within()、@target()、this()</li></ul></li><li>案例<ul><li>基于注解切面判断用户权限</li></ul></li><li><p>maven依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 基于xml实现aop只需要spring-context，如果基于annotation使用aop则额外需要此依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjweaver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.8.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- springboot项目依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>编写切面(基于xml的参考源码)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 示例一(直接使用execution指定切面)</span></span><br><span class="line"><span class="meta">@Aspect</span> <span class="comment">// 声明一个切面</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogAspect</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 此接口/类中方法</span></span><br><span class="line">    <span class="meta">@Before</span>(<span class="string">"execution(* cn.aezo.spring.base.annotation.aop.DemoMethodService.*(..)) || execution(* cn.aezo.spring.base.annotation.aop.DemoMethodService2.*(..))"</span>)</span><br><span class="line">    <span class="comment">// execution(* cn.aezo.spring.base.annotation.aop.*.*(..)) // 此包中方法(第一个*代替了public void；此表达式也会拦截含throws的方法)</span></span><br><span class="line">    <span class="comment">// execution(public * cn.aezo.spring.base.annotation.aop..*.*(..)) // 此包或者子包中public类型的方法</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// this：方法是在那个类中被调用的；target：目标对象是否是某种类型；within：当前执行代码是否属于某个类(静态植入)</span></span><br><span class="line">    <span class="comment">// within(cn.aezo.spring.base.*) // 任何此包中的方法</span></span><br><span class="line">    <span class="comment">// within(cn.aezo.spring.base..*) // 任何此包或其子包中的方法</span></span><br><span class="line">    <span class="comment">// target(org.springframework.web.client.RestTemplate) // 任何目标对象实现了此接口的方法。**如果使用 execution(* org.springframework.web.client.RestTemplate.execute(..))是无法拦截到的，RestTemplate本身是由代理执行的**</span></span><br><span class="line">    <span class="comment">// this(cn.aezo.spring.base.annotation.aop.DemoMethodService) // 实现了此接口中的方法</span></span><br><span class="line">    <span class="comment">// args(java.io.Serializable) // 有且只有一个Serializable参数</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// @within(org.springframework.transaction.annotation.Transactional) // 任何一个目标对象声明的类型有一个 @Transactional 注解的连接点</span></span><br><span class="line">    <span class="comment">// @target(org.springframework.transaction.annotation.Transactional) // 目标对象中有一个 @Transactional 注解的任意连接点</span></span><br><span class="line">    <span class="comment">// @annotation(org.springframework.transaction.annotation.Transactional) // 任何一个执行的方法有一个 @Transactional 注解的连接点</span></span><br><span class="line">    <span class="comment">// @args(org.springframework.transaction.annotation.Transactional) // 有且仅有一个参数并且参数上类型上有@Transactional注解(注意是参数类型上有@Transactional注解，而不是方法的参数上有注解)</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// bean(simpleSay) // bean名字为simpleSay中的所有方法</span></span><br><span class="line">    <span class="comment">// bean(*Impl) // bean名字匹配*Impl的bean中的所有方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">(JoinPoint joinPoint)</span> </span>&#123;</span><br><span class="line">        MethodSignature methodSignature = (MethodSignature) joinPoint.getSignature();</span><br><span class="line">        Method method = methodSignature.getMethod();</span><br><span class="line">        System.out.println(<span class="string">"方法规则式拦截[@Before-execution]："</span> + method.getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例二(使用@Pointcut指定切面)</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogIntercept</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Pointcut</span>(<span class="string">"execution(public * cn.aezo.spring.base.annotation.aop..*.*(..))"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pointcut</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @annotation(sysLog) 中的 sysLog 指下面函数参数变量名</span></span><br><span class="line">    <span class="meta">@Pointcut</span>(<span class="string">"@annotation(sysLog)"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pointcut2</span><span class="params">(SysLog sysLog)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span>(<span class="string">"pointcut()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">(JoinPoint joinPoint)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.printLog(<span class="string">"execution方法执行前"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around</span>(<span class="string">"pointcut()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">around</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        Object[] args = pjp.getArgs(); <span class="comment">// 获取被切入方法参数值</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.printLog(<span class="string">"execution方法执行前"</span>);</span><br><span class="line">        Object retObj = pjp.proceed();</span><br><span class="line">        <span class="keyword">this</span>.printLog(<span class="string">"execution方法执行后"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> retObj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around</span>(value = <span class="string">"pointCut2(sysLog)"</span>, argNames = <span class="string">"pjp,sysLog"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">around2</span><span class="params">(ProceedingJoinPoint pjp, SysLog sysLog)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span>(<span class="string">"recordLog()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.printLog(<span class="string">"execution方法执行后"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// returning属性指定一个形参名，用于表示Advice方法中可定义与此同名的形参，该形参可用于访问目标方法的返回值</span></span><br><span class="line">    <span class="meta">@AfterReturning</span>(value = <span class="string">"pointcut()"</span>, returning = <span class="string">"result"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterReturning</span><span class="params">(JoinPoint joinPoint, Object result)</span> </span>&#123;</span><br><span class="line">        Object[] args = joinPoint.getArgs(); <span class="comment">// 获取被切入方法参数值</span></span><br><span class="line">        System.out.println(<span class="string">"afterReturning..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterThrowing</span>(value = <span class="string">"pointcut() &amp;&amp; @annotation(myExecption)"</span>, throwing = <span class="string">"ex"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterThrowing</span><span class="params">(JoinPoint joinPoint, MyException myExecption, Exception ex)</span></span>&#123;</span><br><span class="line">        String methodName = joinPoint.getSignature().getName();</span><br><span class="line">        System.out.println(<span class="string">"afterThrowing..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例三</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OptimisticCheckAspect</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"sq.tableName:ds_test"</span>)</span><br><span class="line">    <span class="keyword">private</span> String tableName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; tableList;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JdbcTemplateAspect</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        tableList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span>(tableName != <span class="keyword">null</span>) &#123;</span><br><span class="line">            tableList.addAll(Arrays.asList(tableName.split(<span class="string">","</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查通过 JdbcTemplate 执行的sql语句是否携带session字段</span></span><br><span class="line">    <span class="meta">@Before</span>(<span class="string">"execution(* org.springframework.jdbc.core.JdbcTemplate.update(..)) "</span> +</span><br><span class="line">            <span class="string">" || execution(* org.springframework.jdbc.core.JdbcTemplate.batchUpdate(..))"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">(JoinPoint joinPoint)</span> </span>&#123;</span><br><span class="line">        Object[] args = joinPoint.getArgs();</span><br><span class="line">        <span class="keyword">if</span>(args != <span class="keyword">null</span> &amp;&amp; args.length &gt; <span class="number">0</span> &amp;&amp; args[<span class="number">0</span>] <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">            String sql = ((String) args[<span class="number">0</span>]).trim();</span><br><span class="line">            <span class="keyword">if</span>(sql.toLowerCase().startsWith(<span class="string">"insert"</span>) || sql.toLowerCase().startsWith(<span class="string">"update"</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span>(!sql.matches(<span class="string">"(.*)\\s+((?i)version)\\s*=(.*)"</span>)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"修改此实体需要基于乐观锁实现"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>调用service</p></li></ul><h2 id="Profile"><a href="#Profile" class="headerlink" title="Profile"></a>Profile</h2><ul><li>不同的环境读取不同的配置文件：<code>dev</code>/<code>prod</code></li></ul><h2 id="ApplicationEvent"><a href="#ApplicationEvent" class="headerlink" title="ApplicationEvent"></a>ApplicationEvent</h2><ul><li>事件：一个Bean(A)完成某个任务后，可以给另外一个Bean(B)发送事件，前提是B对A进行了监听</li><li><p>方法：</p><ul><li><p>继承<code>ApplicationEvent</code> 进行事件定义</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoEvent</span> <span class="keyword">extends</span> <span class="title">ApplicationEvent</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DemoEvent</span><span class="params">(Object source, String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(source);</span><br><span class="line">        <span class="keyword">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMessage</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>实现<code>ApplicationListener</code> 进行事件监听</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoListener</span> <span class="keyword">implements</span> <span class="title">ApplicationListener</span>&lt;<span class="title">DemoEvent</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(DemoEvent demoEvent)</span> </span>&#123;</span><br><span class="line">        String message = demoEvent.getMessage();</span><br><span class="line">        System.out.println(<span class="string">"DemoListener.onApplicationEvent=="</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><code>applicationContext.publishEvent(new DemoEvent(this, message));</code> 发布事件</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoPublisher</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publish</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        applicationContext.publishEvent(<span class="keyword">new</span> DemoEvent(<span class="keyword">this</span>, message));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></li></ul><h2 id="SpringAware"><a href="#SpringAware" class="headerlink" title="SpringAware"></a>SpringAware</h2><ul><li>Spring依赖注入最大的亮点就是你所有的Bean对Spring容器的存在是无意识的。即你可以将容器换成其他容器，如Google Guice，这是Bean之间的耦合度很低。</li><li>Spring Aware可以让你的Bean调用Spring提供的资源，缺点是Bean会和Spring框架耦合。</li><li>相关接口<ul><li><code>BeanNameAware</code> 获得容器中Bean的名称</li><li><code>BeanFactoryAware</code> 获得当前BeanFactory，这样就有可以调用容器服务</li><li><code>ApplicationContextAware</code> 获得当前ApplicationContext，这样就有可以调用容器服务</li><li><code>MessageSourceAware</code> 获得当前MessageSource，可以获得文本信息</li><li><code>ApplicationEventPublisherAware</code> 应用事件发布器，可以发布事件</li><li><code>ResourceLoaderAware</code> 获得资源加载器，可以获取外部资源</li></ul></li><li>实例</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AwareService</span> <span class="keyword">implements</span> <span class="title">BeanNameAware</span>, <span class="title">ResourceLoaderAware</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String beanName;</span><br><span class="line">    <span class="keyword">private</span> ResourceLoader loader;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeanName</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.beanName = s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setResourceLoader</span><span class="params">(ResourceLoader resourceLoader)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.loader = resourceLoader;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">outputResult</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"beanName = "</span> + beanName);</span><br><span class="line">        Resource resource = loader.getResource(<span class="string">"classpath:cn/aezo/spring/base/annotation/springaware/test.txt"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String test = IOUtils.toString(resource.getInputStream(), <span class="string">"UTF-8"</span>);</span><br><span class="line">            System.out.println(<span class="string">"test = "</span> + test);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ApplicationContext"><a href="#ApplicationContext" class="headerlink" title="ApplicationContext"></a>ApplicationContext</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringU</span> <span class="keyword">implements</span> <span class="title">ApplicationContextAware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(SpringU.applicationContext == <span class="keyword">null</span>) &#123;</span><br><span class="line">            SpringU.applicationContext = applicationContext;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getBean</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getApplicationContext().getBean(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 向 ApplicationContext 注册一个 Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerBean</span><span class="params">(String beanName, Object singletonObject)</span> </span>&#123;</span><br><span class="line">        GenericApplicationContext genericApplicationContext = (GenericApplicationContext) applicationContext;</span><br><span class="line">        DefaultListableBeanFactory defaultListableBeanFactory = genericApplicationContext.getDefaultListableBeanFactory();</span><br><span class="line">        defaultListableBeanFactory.registerSingleton(beanName, singletonObject);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringUBeanPostProcessor</span> <span class="keyword">extends</span> <span class="title">InstantiationAwareBeanPostProcessorAdapter</span> <span class="keyword">implements</span> <span class="title">BeanFactoryAware</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ConfigurableListableBeanFactory beanFactory;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeanFactory</span><span class="params">(BeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!(beanFactory <span class="keyword">instanceof</span> ConfigurableListableBeanFactory)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                    <span class="string">"AutowiredAnnotationBeanPostProcessor requires a ConfigurableListableBeanFactory: "</span> + beanFactory);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.beanFactory = (ConfigurableListableBeanFactory) beanFactory;</span><br><span class="line">        <span class="comment">// 实现InstantiationAwareBeanPostProcessor接口的类会优先于 Bean 被实例</span></span><br><span class="line">        <span class="comment">// 手动触发 bean 的实例</span></span><br><span class="line">        beanFactory.getBean(SpringU.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Target</span>(&#123;ElementType.TYPE&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@Import</span>(&#123;SpringUBeanPostProcessor.class&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableSqU &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在启动类上增加此配置</span></span><br><span class="line"><span class="meta">@EnableSqU</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(&#123;<span class="string">"cn.aezo.demo"</span>, <span class="string">"cn.aezo.utils.ext.spring"</span>&#125;)</span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure><h2 id="多线程-EnableAsync"><a href="#多线程-EnableAsync" class="headerlink" title="多线程@EnableAsync"></a>多线程@EnableAsync</h2><ul><li>Spring通过任务执行器(TaskExecutor)来实现多线程和并发编程。使用<code>ThreadPoolTaskExecutor</code>可实现一个基于线程池的TaskExecutor。</li><li><code>@EnableAsync</code> 可开启对异步任务的支持。需要对应的配置类实现</li><li><code>@Async</code> 注解执行异步任务的方法</li><li><p>示例</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取线程池</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(<span class="string">"cn.aezo.spring.base.annotation.thread"</span>)</span><br><span class="line"><span class="meta">@EnableAsync</span> <span class="comment">// 开启异步任务支持</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TaskExecutorConfig</span> <span class="keyword">implements</span> <span class="title">AsyncConfigurer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Executor <span class="title">getAsyncExecutor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ThreadPoolTaskExecutor taskExecutor = <span class="keyword">new</span> ThreadPoolTaskExecutor();</span><br><span class="line">        taskExecutor.setCorePoolSize(<span class="number">5</span>);</span><br><span class="line">        taskExecutor.setMaxPoolSize(<span class="number">10</span>);</span><br><span class="line">        taskExecutor.setQueueCapacity(<span class="number">25</span>);</span><br><span class="line">        taskExecutor.initialize();</span><br><span class="line">        <span class="keyword">return</span> taskExecutor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AsyncUncaughtExceptionHandler <span class="title">getAsyncUncaughtExceptionHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义异步方法</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncTaskService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Async</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeAsyncTask</span><span class="params">(Integer i)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"i = "</span> + i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Async</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeAsyncTaskPlus</span><span class="params">(Integer i)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"i+1 = "</span> + (i+<span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h2 id="计划任务-Scheduled"><a href="#计划任务-Scheduled" class="headerlink" title="计划任务@Scheduled"></a>计划任务@Scheduled</h2><ul><li><code>@EnableScheduling</code> 开启定时任务</li><li><p><code>@Scheduled</code> 执行任务的方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(<span class="string">"cn.aezo.spring.base.annotation.scheduled"</span>) <span class="comment">// springboot无需扫描@Scheduled所在包</span></span><br><span class="line"><span class="meta">@EnableScheduling</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TaskScheduledConfig</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 默认同一时刻只会运行一个@Scheduled修饰的方法，时间太长会阻塞其他定时</span></span><br><span class="line">    <span class="comment">// 此时定义成5个线程并发(**被@Scheduled修饰的不同方法可以并发执行，同一个方法不会产生并发**)</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Executor <span class="title">taskScheduler</span><span class="params">()</span> </span>&#123; <span class="comment">// java.util.concurrent.Executor</span></span><br><span class="line">        <span class="keyword">return</span> Executors.newScheduledThreadPool(<span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ScheduledTaskService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> SimpleDateFormat dateFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"HH:mm:ss"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 方法访问权限必须为protected或以下</span></span><br><span class="line">    <span class="meta">@Scheduled</span>(fixedRate = <span class="number">5000</span>) <span class="comment">// 5000毫秒. fixedRate每隔固定时间执行</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reportCurrentTime</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"每隔5秒执行一次："</span> + dateFormat.format(<span class="keyword">new</span> Date()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Scheduled</span>(cron = <span class="string">"0 50 14 ? * *"</span>) <span class="comment">// 每天14.50执行。程序启动并不会立即运行，比如 14:45 启动，只有等到 14:50 才会第一次运行</span></span><br><span class="line">    <span class="comment">// @Scheduled(cron = "$&#123;myVal.cron&#125;") // springboot只需再yml里面定义配置即可，无需创建JavaBean配置</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fixTimeException</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"在指定时间执行："</span> + dateFormat.format(<span class="keyword">new</span> Date()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@MyWindowsConditionOnCustomProperty</span>(<span class="string">"true"</span>) <span class="comment">// 参考上文自定义Condition</span></span><br><span class="line">    <span class="meta">@Component</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Job1</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Scheduled</span>(fixedRate = <span class="number">1000</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"自定义条件下的定时任务正在执行..."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>cron配置说明 <a href="https://www.cnblogs.com/X-World/p/6113910.html" title="cron表达式" target="_blank" rel="noopener">^1</a></p><ul><li><code>{秒} {分} {时} {日} {月} {周} {年(可选)}</code><ul><li>Seconds/Minutes 有效范围为0-59的整数</li><li>Hours 有效范围为0-23的整数</li></ul></li><li>符号说明<ul><li><code>*</code> 代表所有值，每隔1秒/分/时触发</li><li><code>?</code> 表示不指定值<ul><li>如：要在每月的10号触发一个操作，但不关心是周几，所以需要周位置的那个字段设置为”?”，具体设置为<code>0 0 0 10 * ?</code></li><li>如：每周一执行，此时一般不关心”日”，案例如<code>0 0 9 ? * 2</code></li></ul></li><li><code>/</code> 代表触发步进(step)<ul><li>“/“前面的值代表初始值(“*“等同”0”)，后面的值代表偏移量。比如”0/25”或者”*/25”代表从0秒/分/时开始，每隔25秒/分/时触发1次</li></ul></li><li><code>,</code> 代表在指定的秒/分/时触发<ul><li>比如”10,20,40”代表10秒/分/时、20秒/分/时和40秒/分/时时触发任务</li></ul></li><li><code>-</code> 代表在指定的范围内触发<ul><li>比如”5-30”代表从5秒/分/时开始触发到30秒/分/时结束触 发，每隔1秒/分/时触发</li></ul></li></ul></li><li><a href="https://qqe2.com/cron" target="_blank" rel="noopener">cron在线生成</a></li><li><p>常用定时配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"0/10 * * * * ?"</span> 每10秒触发(程序启动后/任务添加后，第一次触发为0/10/20/30/40/50秒中离当前时间最近的时刻。下同) </span><br><span class="line"><span class="string">"0 0/5 * * * ?"</span> **每5分钟执行一次(注意第一个为0)**</span><br><span class="line">    <span class="string">"* 0/5 * * * ?"</span> 每5分钟连续执行60秒，这60秒期间每秒执行一次</span><br><span class="line">    <span class="string">"0 5 * * * ?"</span> 表示每个小时的第5分钟执行</span><br><span class="line"><span class="string">"0 0 12 * * ?"</span> 每天中午12点触发</span><br><span class="line">    <span class="string">"0 0 0/12 * * ?"</span> 每12个小时触发一次</span><br><span class="line">    <span class="string">"0 15 10 ? * *"</span> 每天上午10:15触发 </span><br><span class="line">    <span class="string">"0 15 10 * * ?"</span> 每天上午10:15触发 </span><br><span class="line">    <span class="string">"0 15 10 * * ? *"</span> 每天上午10:15触发 </span><br><span class="line">    <span class="string">"0 0 10,14,16 * * ?"</span> 每天上午10点，下午2点，4点 </span><br><span class="line"><span class="string">"0 0/30 9-17 * * ?"</span> 朝九晚五工作时间内每半小时 </span><br><span class="line"><span class="string">"0 0 9 ? * 2"</span> 表示每个星期一上午9点(1表示这周的第一天，即周日；2则表示周一)</span><br><span class="line">    <span class="string">"0 0 9 ? * MON"</span></span><br><span class="line"><span class="string">"0 15 10 * * ? 2005"</span> 2005年的每天上午10:15触发</span><br><span class="line"></span><br><span class="line"><span class="string">"0 * 14 * * ?"</span> 在每天下午2点到下午2:59期间的每1分钟触发 </span><br><span class="line"><span class="string">"0 0/5 14 * * ?"</span> 在每天下午2点到下午2:55期间的每5分钟触发 </span><br><span class="line"><span class="string">"0 0/5 14,18 * * ?"</span> 在每天下午2点到2:55期间和下午6点到6:55期间的每5分钟触发 </span><br><span class="line"><span class="string">"0 0-5 14 * * ?"</span> 在每天下午2点到下午2:05期间的每1分钟触发 </span><br><span class="line"><span class="string">"0 10,44 14 ? 3 WED"</span> 每年三月的星期三的下午2:10和2:44触发 </span><br><span class="line"><span class="string">"0 15 10 ? * MON-FRI"</span> 周一至周五的上午10:15触发 </span><br><span class="line"><span class="string">"0 15 10 15 * ?"</span> 每月15日上午10:15触发</span><br><span class="line"><span class="string">"0 15 10 L * ?"</span> 每月最后一日的上午10:15触发 </span><br><span class="line"><span class="string">"0 15 10 ? * 6L"</span> 每月的最后一个星期五上午10:15触发(6代表一周中的第6天，即周五)</span><br><span class="line"><span class="string">"0 15 10 ? * 6L 2002-2005"</span> 2002年至2005年的每月的最后一个星期五上午10:15触发 </span><br><span class="line"><span class="string">"0 15 10 ? * 6#3"</span> 每月的第三个星期五上午10:15触发</span><br></pre></td></tr></table></figure></li></ul></li><li><p>手动启动任务和停止任务(基于springboot v2.0.1测试)</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ## Job接口</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Job</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String jobCode;</span><br><span class="line">    <span class="keyword">private</span> String jobName;</span><br><span class="line">    <span class="keyword">private</span> String cron;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> enable;</span><br><span class="line">    <span class="meta">@JsonIgnore</span></span><br><span class="line">    <span class="keyword">private</span> Runnable runnable;</span><br><span class="line">    <span class="meta">@JsonIgnore</span></span><br><span class="line">    <span class="keyword">private</span> ScheduledFuture&lt;?&gt; future;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ## Job管理器</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JobManager</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Lazy</span></span><br><span class="line">    <span class="meta">@Qualifier</span>(<span class="string">"jobManagerThreadPoolTaskScheduler"</span>)</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ThreadPoolTaskScheduler jobManagerThreadPoolTaskScheduler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"jobManagerThreadPoolTaskScheduler"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ThreadPoolTaskScheduler <span class="title">jobManagerThreadPoolTaskScheduler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ThreadPoolTaskScheduler scheduler = <span class="keyword">new</span> ThreadPoolTaskScheduler();</span><br><span class="line">        scheduler.setThreadNamePrefix(<span class="string">"job-manager-"</span>);</span><br><span class="line">        scheduler.setPoolSize(<span class="number">5</span>);</span><br><span class="line">        <span class="keyword">return</span> scheduler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Job&gt; jobMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化定时任务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> job</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> start 是否立即启动任务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addJob</span><span class="params">(Job job, <span class="keyword">boolean</span> start)</span> </span>&#123;</span><br><span class="line">        job.setEnable(<span class="keyword">false</span>);</span><br><span class="line">        jobMap.put(job.getJobCode(), job);</span><br><span class="line">        <span class="keyword">if</span>(start) &#123;</span><br><span class="line">            startJob(job.getJobCode());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startJob</span><span class="params">(String jobCode)</span> </span>&#123;</span><br><span class="line">        Assert.notNull(jobCode, <span class="string">"jobCode can not be null"</span>);</span><br><span class="line">        Job job = jobMap.get(jobCode);</span><br><span class="line">        <span class="keyword">if</span>(job == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"job not found"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        job.setEnable(<span class="keyword">true</span>);</span><br><span class="line">        ScheduledFuture&lt;?&gt; future = jobManagerThreadPoolTaskScheduler.schedule(job.getRunnable(), <span class="keyword">new</span> CronTrigger(job.getCron()));</span><br><span class="line">        job.setFuture(future);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stopJob</span><span class="params">(String jobCode)</span> </span>&#123;</span><br><span class="line">        Assert.notNull(jobCode, <span class="string">"jobCode can not be null"</span>);</span><br><span class="line">        Job job = jobMap.get(jobCode);</span><br><span class="line">        <span class="keyword">if</span>(job == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"job not found"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(job.getFuture() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"job not start"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        job.getFuture().cancel(<span class="keyword">true</span>);</span><br><span class="line">        job.setEnable(<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeJob</span><span class="params">(String jobCode)</span> </span>&#123;</span><br><span class="line">        Assert.notNull(jobCode, <span class="string">"jobCode can not be null"</span>);</span><br><span class="line">        Job job = jobMap.get(jobCode);</span><br><span class="line">        <span class="keyword">if</span>(job != <span class="keyword">null</span> &amp;&amp; job.getFuture() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            stopJob(jobCode);</span><br><span class="line">        &#125;</span><br><span class="line">        jobMap.remove(jobCode);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="事物支持"><a href="#事物支持" class="headerlink" title="事物支持"></a>事物支持</h2><h3 id="事物"><a href="#事物" class="headerlink" title="事物"></a>事物</h3><ul><li>在Spring中，事务有两种实现方式<ul><li>编程式事务管理：使用TransactionTemplate可实现更细粒度的事务控制</li><li>申明式事务管理：基于Spring AOP实现。常用</li></ul></li><li>Spring事务管理是基于接口代理或动态字节码技术，通过AOP实施事务增强的<ul><li><strong>事物生命周期是从AOP调用的目标方法开始的，到该方法执行完成事物环境即消失</strong><ul><li>不一定非要有接口实现，普通Bean只要通过AOP调用即可</li></ul></li><li><strong><code>@Transactional</code>注解只能被应用到 public 可见度的方法上或注解到类上</strong>，注解到类上则该类的所有public方法再进行AOP调用时都存在事物</li><li><strong>默认遇到运行期异常(RuntimeException)会回滚，遇到捕获异常(Exception)时不回滚</strong><ul><li><code>@Transactional(rollbackFor=Exception.class)</code> 指定回滚，遇到(声明上throws出来的)捕获异常Exception时也回滚</li><li><code>@Transactional(noRollbackFor=RuntimeException.class)</code> 指定不回滚</li></ul></li><li><strong>一个带事物的方法调用了另外一个事物方法，第二个方法的事物默认无效(Propagation.REQUIRED)</strong>，具体见下文事物传播行为</li><li>如果事物比较复杂，如当涉及到多个数据源，可使用<code>@Transactional(value=&quot;transactionManagerPrimary&quot;)</code>定义个事物管理器transactionManagerPrimary</li></ul></li><li><strong>常见问题</strong><ul><li><strong>自调用导致<code>@Transactional</code>失效问题</strong><ul><li>同一个类中的方法相互调用，发起方法无<code>@Transactional</code>，则被调用的方法<code>@Transactional</code>无效 <a href="http://tech.lede.com/2017/02/06/rd/server/SpringTransactional/" title="Spring @Transactional原理及使用" target="_blank" rel="noopener">^3</a></li><li>原因：由于@Transactional的实现原理是AOP，AOP的实现原理是动态代理，<strong>自调用时不存在代理对象的调用，这时不会产生注解@Transactional配置的参数</strong>，因此无效</li><li><strong>通过<code>SpringU.getBean(UserService.class);</code>解决</strong>(不需要设置exposeProxy属性)</li><li>通过AopContext解决<ul><li>上述方案及其他方案参考：<a href="https://blog.csdn.net/u012528360/article/details/70336319" target="_blank" rel="noopener">https://blog.csdn.net/u012528360/article/details/70336319</a></li></ul></li></ul></li><li>捕获嵌套事物异常导致报错<code>Transaction rolled back because it has been marked as rollback-only</code>(事务已经被标记为回滚，无法提交)<ul><li>解决方案见下文，参考：<a href="https://blog.csdn.net/f641385712/article/details/80445912" target="_blank" rel="noopener">https://blog.csdn.net/f641385712/article/details/80445912</a></li></ul></li><li>服务内部捕获异常Exception/RuntimeException，统一返回错误结果对象，如自定义<code>Result</code>，此时无法回滚事物，解决方案如下<ul><li><strong><code>TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();</code></strong> 程序内部手动回滚(手动回滚必须当前执行环境有Transactional配置，而不是执行此语句的方法有<code>@Transactional</code>注解就可以回滚，具体见下文示例)。<strong>Debug过程中，发现有问题，可通过执行此语句进行手动回滚。调试时很好用</strong></li><li>或者手动抛出RuntimeException</li><li>或者基于自定义注解统一回滚</li></ul></li></ul></li><li>手动回滚方式(前提是当前有事物)</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 回滚整个方法</span></span><br><span class="line">TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 回滚指定的一段操作</span></span><br><span class="line"><span class="comment">// 设置回滚点</span></span><br><span class="line">Object savePoint = TransactionAspectSupport.currentTransactionStatus().createSavepoint();</span><br><span class="line"><span class="comment">// 回滚到回滚点</span></span><br><span class="line">TransactionAspectSupport.currentTransactionStatus().rollbackToSavepoint(savePoint);</span><br></pre></td></tr></table></figure><ul><li>完全手动管理事物</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> PlatformTransactionManager transactionManager;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 新发起一个事务</span></span><br><span class="line">DefaultTransactionDefinition def = <span class="keyword">new</span> DefaultTransactionDefinition();</span><br><span class="line">def.setPropagationBehavior(TransactionDefinition.PROPAGATION_REQUIRES_NEW);</span><br><span class="line"><span class="comment">// 获得事务状态</span></span><br><span class="line">TransactionStatus transactionStatus = transactionManager.getTransaction(def);</span><br><span class="line"><span class="comment">// 手动提交事务</span></span><br><span class="line">transactionManager.commit(transactionStatus);</span><br><span class="line"><span class="comment">// 手动回滚事物</span></span><br><span class="line">transactionManager.rollback(transactionStatus);</span><br></pre></td></tr></table></figure><ul><li>原理参考<ul><li><a href="https://www.jianshu.com/p/acf84a4ed3a3" target="_blank" rel="noopener">https://www.jianshu.com/p/acf84a4ed3a3</a></li></ul></li></ul><h3 id="隔离级别"><a href="#隔离级别" class="headerlink" title="隔离级别"></a>隔离级别</h3><ul><li><strong>隔离级别</strong> <code>@Transactional(isolation = Isolation.DEFAULT)</code>：<code>org.springframework.transaction.annotation.Isolation</code>枚举类中定义了五个表示隔离级别的值。脏读取、重复读、幻读 <a href="http://blog.didispace.com/springboottransactional/" title="@Transactional" target="_blank" rel="noopener">^2</a><ul><li><code>DEFAULT</code><ul><li>这是默认值，表示使用底层数据库的默认隔离级别。<strong>对大部分数据库而言，通常这值就是<code>READ_COMMITTED</code>；然而mysql的默认值是<code>REPEATABLE_READ</code></strong></li></ul></li><li><code>READ_UNCOMMITTED</code><ul><li>该隔离级别表示一个事务可以读取另一个事务修改但还没有提交的数据</li><li>读操作不加S锁</li><li>该级别不能防止脏读、不可重复读、幻读。因此很少使用该隔离级别</li><li>比如，事务1修改一行，事务2在事务1提交之前读取了这一行。如果事务1回滚，事务2就读取了一行没有提交的数据（读取数据不需要加S锁，这样就不会跟被修改的数据上的X锁冲突）</li></ul></li><li><code>READ_COMMITTED</code> <strong>读已提交</strong><ul><li>该隔离级别表示一个事务只能读取另一个事务已经提交的数据</li><li>读操作需要加S锁，但是在语句执行完以后释放S锁</li><li>该级别可以防止脏读，可能会出现不可重复读、幻读。这也是大多数情况下的推荐值</li><li>Sql Server、Oracle默认为此级别</li><li>比如，事务1读取了一行，事务2修改或者删除这一行并且提交。如果事务1想再一次读取这一行，它将获得修改后的数据或者发现这一样已经被删除，因此事务的第二次读取结果与第一次读取结果不同，因此也叫不可重复读</li></ul></li><li><code>REPEATABLE_READ</code> <strong>可重复读</strong><ul><li>该隔离级别表示一个事务在整个过程中可以多次重复执行某个查询，并且每次返回的记录都相同。即使在多次查询之间有新增的数据满足该查询，这些新增的记录也会被忽略</li><li>读操作需要加S锁，语句执行完并不会释放S锁，必须等待事务执行完毕以后才释放S锁</li><li>该级别可以防止脏读、不可重复读，可能出现幻读</li><li>MySQL默认为此级别</li><li>比如，事务1读取了一行，事务2想修改或者删除这一行并且提交，但是因为事务1尚未提交，数据行中有事务1的锁，事务2无法进行更新操作，因此事务2阻塞。如果这时候事务1想再一次读取这一行，它读取结果与第一次读取结果相同，因此叫可重复读</li></ul></li><li><code>SERIALIZABLE</code><ul><li>所有的事务依次逐个执行，这样事务之间就完全不可能产生干扰</li><li>会在Repeatable Read级别的基础上，添加一个范围锁</li><li>该级别可以防止脏读、不可重复读、幻读。但是这将严重影响程序的性能，通常情况下也不会用到该级别</li></ul></li></ul></li><li>幻读<ul><li>一般出现在事务不是独立执行时发生，如使用REQUIRES_NEW时容易出现(业务逻辑导致)</li><li>如：事务A首先根据条件索引得到10条数据，然后事务B改变了数据库一条数据，导致也符合事务A当时的搜索条件，这样事务A再次搜索发现有9条(B删除了一条)或11条数据(B新增了一条)，就产生了幻读</li></ul></li><li>数据真正入库<ul><li>入库事务有spring事务，数据库事务，只有当这两个事务都结束，才代表数据真正可查</li></ul></li></ul><h3 id="传播行为"><a href="#传播行为" class="headerlink" title="传播行为"></a>传播行为</h3><ul><li><strong>传播行为</strong> <code>@Transactional(propagation = Propagation.REQUIRED)</code>：所谓事务的传播行为是指，如果在开始当前事务之前，一个事务上下文已经存在，此时有若干选项可以指定一个事务性方法的执行行为。<code>org.springframework.transaction.annotation.Propagation</code>枚举类中定义了6个表示传播行为的枚举值<ul><li><code>REQUIRED</code>：这是默认值，如果当前存在事务，则加入该事务；如果当前没有事务，则创建一个新的事务</li><li><code>REQUIRES_NEW</code>：创建一个新的事务，如果当前存在事务，则把当前事务挂起</li><li><code>SUPPORTS</code>：如果当前存在事务，则加入该事务；如果当前没有事务，则以非事务的方式继续运行</li><li><code>NOT_SUPPORTED</code>：以非事务方式运行，如果当前存在事务，则把当前事务挂起</li><li><code>MANDATORY</code>：如果当前存在事务，则加入该事务；如果当前没有事务，则抛出异常</li><li><code>NEVER</code>：以非事务方式运行，如果当前存在事务，则抛出异常</li><li><code>NESTED</code>：(适合总分总结构) 如果当前存在事务，则创建一个事务作为当前事务的嵌套事务来运行；如果当前没有事务，则该取值等价于REQUIRED</li></ul></li><li><p><strong>REQUIRES_NEW 和 NESTED的区别</strong></p><ul><li><code>REQUIRES_NEW</code> 执行到B时，A事物被挂起，B会新开了一个事务进行执行。B发生异常后，B中的修改都会回滚，然后外部事物继续执行；B正常执行提交后，则数据已经持久化了，可能产生脏读，且A如果之后失败回滚时，B是不会回滚的</li><li><code>NESTED</code> 执行到B时，会创建一个savePoint，如果B中执行失败，会将数据回滚到这个savePoint，A可以继续提交；如果B正常执行，此时B中的修改并不会立即提交，而是在A提交时一并提交，如果A失败，则A和B都会回滚(适合总分总结构)</li><li><p>示例(<a href="https://www.jianshu.com/p/339d59f1ecd9" target="_blank" rel="noopener">https://www.jianshu.com/p/339d59f1ecd9</a>)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">NESTED</span></span><br><span class="line"><span class="comment">    (1) B、C为A的子事务，可以读取A未提交的数据。但是REQUIRES_NEW却不行，除非B、C的隔离级别是Read Uncommitted</span></span><br><span class="line"><span class="comment">    (2) 如果A事务在B/C执行完后，还有更改数据库的操作，如果更改失败，那么B/C是要回滚的，但是REQUIRES_NEW则B/C不会回滚，B/C事务已提交</span></span><br><span class="line"><span class="comment">    (3) A与B/C方法中，可以修改同一条数据。但是对于REQUIRES_NEW会造成死锁</span></span><br><span class="line"><span class="comment">REQUIRES_NEW</span></span><br><span class="line"><span class="comment">    (1) B/C作为内部事务，提交后可以被修改，这会造成A的脏读(A读取了金额为100, 然后java代码中+10, 之后B把金额改成0并提交, A最后把计算的金额110进行保存, 从而脏读. 按照顺序此时A应该重新读取B提交的数据则为0, 再进行加10操作)</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line">A.service() &#123;</span><br><span class="line">    insert();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// PROPAGATION_NESTED</span></span><br><span class="line">        B.service();</span><br><span class="line">    &#125; <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">        <span class="comment">// PROPAGATION_NESTED</span></span><br><span class="line">        C.service()；</span><br><span class="line">    &#125;</span><br><span class="line">    update();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></li></ul><h3 id="事物示例"><a href="#事物示例" class="headerlink" title="事物示例"></a>事物示例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.## 在Test测试程序中，通过此Controller相关Bean调用该方法时，正常回滚</span></span><br><span class="line"><span class="comment">// Controller1.java</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/addTest"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">addTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    User user1 = <span class="keyword">new</span> User();</span><br><span class="line">    user1.setId(<span class="string">"1"</span>);</span><br><span class="line">    user1.setUsername(<span class="string">"user1"</span>);</span><br><span class="line">    userMapper.insert(user1);</span><br><span class="line">    <span class="comment">// userService.save(user1); // 同样会回滚</span></span><br><span class="line">    System.out.println(<span class="string">"user1.getId() = "</span> + user1.getId());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 此处报错，会出现回滚</span></span><br><span class="line">    Long.valueOf(<span class="string">"abc"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Test.java(下同)</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextLoads</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    controller1.addTest();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.## 通过此Controller相关Bean调用该方法时，不会出现回滚(浏览器直接访问也不会回滚)</span></span><br><span class="line"><span class="comment">// Controller1.java</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="comment">// @Transactional(rollbackFor=Exception.class) // 加此注解可正常回滚(浏览器访问也会回滚)</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/addTest"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">addTest</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    User user1 = <span class="keyword">new</span> User();</span><br><span class="line">    user1.setId(<span class="string">"1"</span>);</span><br><span class="line">    user1.setUsername(<span class="string">"user1"</span>);</span><br><span class="line">    userMapper.insert(user1);</span><br><span class="line">    System.out.println(<span class="string">"user1.getId() = "</span> + user1.getId());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Long.valueOf("abc"); // 属于RuntimeException</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="number">1</span> == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// 此处报错，不会出现回滚</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"..."</span>); <span class="comment">// 属于Exception</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.## 在Test测试程序中通过此Controller相关Bean调用该方法和浏览器直接访问，都无法正常回滚</span></span><br><span class="line"><span class="comment">// Controller1.java</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/addTest"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">addTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Spring的@Transactional自我调用问题：同一个类中的方法相互调用，发起方法无`@Transactional`，被调用的方法`@Transactional`无效</span></span><br><span class="line">    <span class="keyword">return</span> addTestTransactional();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">addTestTransactional</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 此时没有事物环境(由于是直接调用)</span></span><br><span class="line">    User user1 = <span class="keyword">new</span> User();</span><br><span class="line">    user1.setId(<span class="string">"2"</span>);</span><br><span class="line">    user1.setUsername(<span class="string">"user1"</span>);</span><br><span class="line">    userMapper.insert(user1);</span><br><span class="line">    System.out.println(<span class="string">"user1.getId() = "</span> + user1.getId());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Long.valueOf(<span class="string">"abc"</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        <span class="comment">// 因为没有事物环境，此时手动回滚不会生效，并且会报：org.springframework.transaction.NoTransactionException: No transaction aspect-managed TransactionStatus in scope。*****Debug过程中，发现有问题，可通过执行此语句进行手动回滚。调试时很好用****</span></span><br><span class="line">        TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 此处报错，也不会回滚</span></span><br><span class="line">    Long.valueOf(<span class="string">"abc"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4.## 事物生命周期是从AOP调用开始的</span></span><br><span class="line"><span class="comment">// Controller1.java</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/addTest"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">addTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    User user1 = <span class="keyword">new</span> User();</span><br><span class="line">    user1.setId(<span class="string">"1"</span>);</span><br><span class="line">    user1.setUsername(<span class="string">"user1"</span>);</span><br><span class="line">    userMapper.insert(user1);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 此处没有事物环境</span></span><br><span class="line">        controller2.addTestTransactional(); <span class="comment">// 此时为AOP调用，在调用方法里面才存在事物环境</span></span><br><span class="line">        <span class="comment">// 此处也没有事物环境</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        <span class="comment">// 由于此处没有事物环境，因此执行会报错。上面user1也不会正常回滚</span></span><br><span class="line">        TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Controller2.java</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">addTestTransactional</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 此时有事物环境</span></span><br><span class="line">    User user2 = <span class="keyword">new</span> User();</span><br><span class="line">    user2.setId(<span class="string">"2"</span>);</span><br><span class="line">    user2.setUsername(<span class="string">"user2"</span>);</span><br><span class="line">    userMapper.insert(user2);</span><br><span class="line">    System.out.println(<span class="string">"user2.getId() = "</span> + user2.getId());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 此处报错，会回滚user2(user1不会回滚)</span></span><br><span class="line">    Long.valueOf(<span class="string">"abc"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ## 5.NESTED</span></span><br><span class="line">bean.run(); <span class="comment">// 开启事物</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Transactional</span>(rollbackFor = Exception.class)</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ======&gt;A</span></span><br><span class="line">    Long a = Long.valueOf(<span class="string">"1"</span>);</span><br><span class="line">    <span class="comment">// Long a = Long.valueOf("a"); // 此处报错则直接回滚</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ======&gt;B</span></span><br><span class="line">    <span class="keyword">for</span> (Map&lt;String, Object&gt; item : list) &#123;</span><br><span class="line">        MyBean bean = SpirngU.getBean(MyBean.class);</span><br><span class="line">        <span class="comment">// 开启内部事物</span></span><br><span class="line">        <span class="comment">// bean.runItem(item); // 当前item回滚，B之前的数据也会回滚(由于此处异常直接往外抛出了)</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            bean.runItem(item); <span class="comment">// 当前item回滚，B之前的数据不会回滚</span></span><br><span class="line">        &#125; <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">""</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ======&gt;C</span></span><br><span class="line">    Long c = Long.valueOf(<span class="string">"1"</span>);</span><br><span class="line">    <span class="comment">// Long c = Long.valueOf("c"); // 此处报错则会全部回滚(A、B、C)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Transactional</span>(propagation = Propagation.NESTED, rollbackFor = Exception.class)</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">runItem</span><span class="params">(Map&lt;String, Object&gt; item)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="自调用导致-Transactional失效问题"><a href="#自调用导致-Transactional失效问题" class="headerlink" title="自调用导致@Transactional失效问题"></a>自调用导致@Transactional失效问题</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 假设UserController调用UserService</span></span><br><span class="line">userService.run();</span><br><span class="line">System.out.println(AopContext.currentProxy()); <span class="comment">// IllegalStateException 此处没有AOP上下文</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(params : list) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// this.updateByMap(params); // 无法实现事物</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 法一(简单)</span></span><br><span class="line">                SpringU.getBean(UserService.class).updateByMap(params); <span class="comment">// 可实现事物，即可保证list里面的部分条目可提交成功</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 法二</span></span><br><span class="line">                <span class="comment">// springboot启动项增加注解：@EnableAspectJAutoProxy(exposeProxy = true)开启AOP切面，且支持proxy</span></span><br><span class="line">                UserService userService = (UserService) AopContext.currentProxy();</span><br><span class="line">                userService.updateByMap(params); <span class="comment">// 可实现事物</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="comment">// 此处catch无所谓的</span></span><br><span class="line">                System.out.println(<span class="string">"error..."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span>(rollbackFor = Exception.class)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateByMap</span><span class="params">(params)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(params.get(<span class="string">"name"</span>) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"invalid"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        jdbcTemplate.update(<span class="string">"update t_user set sex = 1 where name = ?"</span>, params.get(<span class="string">"name"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="捕获嵌套事物异常导致报错"><a href="#捕获嵌套事物异常导致报错" class="headerlink" title="捕获嵌套事物异常导致报错"></a>捕获嵌套事物异常导致报错</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Class ServiceA &#123;</span><br><span class="line">    <span class="meta">@Resource</span>(name = <span class="string">"serviceB"</span>)</span><br><span class="line">    <span class="keyword">private</span> ServiceB b;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">a</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            b.b();</span><br><span class="line">            <span class="comment">// 此处editById对应AOP执行完成，由于报错已经将事物标记为回滚状态</span></span><br><span class="line">            <span class="comment">// 且此嵌套事物用的是一个事物，因此addPerson尚未执行完，事物还不会提交，需等addPerson执行完之后再提交</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ignore) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 返回后报错：Transaction rolled back because it has been marked as rollback-only</span></span><br><span class="line">        <span class="comment">// 当addPerson执行完之后，AOP结束，Spring会提交事物</span></span><br><span class="line">        <span class="comment">// 而上文将editById异常捕获掉了，Spring未发现异常因此会提交事物，而上文editById已经将事物标记为回滚状态，从而报错</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Class ServiceB &#123;</span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">b</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>解决方案如下<ul><li>业务允许情况下减少嵌套事物出现，如去掉某一个方法中的@Transactional</li><li>如果希望内层事务抛出异常时中断程序执行，直接在外层事务的catch代码块中抛出e(这样整个事物也不会提交，即a中的不会保存)<ul><li>在catch语句中增加<code>TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();</code>语句，手动回滚。此时a中是否能保存成功？</li></ul></li><li>将嵌套事物开启成新事物，如editById注解成@Transactional(propagation = Propagation.REQUIRES_NEW)</li><li>如果希望内层事务回滚，但不影响外层事务提交，需要将内层事务的传播方式指定为PROPAGATION_NESTED<ul><li>注：PROPAGATION_NESTED基于数据库savepoint实现的嵌套事务，外层事务的提交和回滚能够控制嵌内层事务，而内层事务报错时，可以返回原始savepoint，外层事务可以继续提交</li></ul></li></ul></li></ul><h3 id="在事物中提前关闭了连接"><a href="#在事物中提前关闭了连接" class="headerlink" title="在事物中提前关闭了连接"></a>在事物中提前关闭了连接</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span>(rollbackFor = Exception.class)</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.runSql(...);</span><br><span class="line">    jdbcTemplate.update(...); <span class="comment">// 此处会报错：SQL state [null]; error code [0];</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> List&lt;Map&lt;String, Object&gt;&gt; runSql(String sql, Map&lt;String, Object&gt; parameters) &#123;</span><br><span class="line">    SqlSession sqlSession = sqlSessionFactory.openSession(); <span class="comment">// org.apache.ibatis.session.SqlSession</span></span><br><span class="line">    Connection connection = sqlSession.getConnection();</span><br><span class="line">    ResultSet rs = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        PreparedStatement ps = connection.prepareStatement(sql);</span><br><span class="line">        setParameters(ps, boundSql, parameters, configuration);</span><br><span class="line">        rs = ps.executeQuery();</span><br><span class="line">        <span class="keyword">return</span> resultSetToList(rs);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// rs可以关闭</span></span><br><span class="line">        <span class="keyword">if</span>(rs != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                rs.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//不能直接关闭连接，如果存在事物则有问题。此处只释放连接</span></span><br><span class="line">        <span class="comment">//try &#123;</span></span><br><span class="line">        <span class="comment">//    connection.close();</span></span><br><span class="line">        <span class="comment">//&#125; catch (SQLException e) &#123;</span></span><br><span class="line">        <span class="comment">//    e.printStackTrace();</span></span><br><span class="line">        <span class="comment">//&#125;</span></span><br><span class="line">        DataSource dataSource = SpringUtil.getBean(DataSource.class);</span><br><span class="line">        DataSourceUtils.releaseConnection(connection, dataSource);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// sqlSession也可以关闭</span></span><br><span class="line">        sqlSession.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Spring-XML配置"><a href="#Spring-XML配置" class="headerlink" title="Spring-XML配置"></a>Spring-XML配置</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:p</span>=<span class="string">"http://www.springframework.org/schema/p"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">    <span class="comment">&lt;!-- scope默认singleton --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"p1"</span> <span class="attr">class</span>=<span class="string">"cn.aezo.test.spring.Person"</span> <span class="attr">scope</span>=<span class="string">"singleton"</span> <span class="attr">lazy-init</span>=<span class="string">"true"</span> <span class="attr">init-method</span>=<span class="string">"init"</span> <span class="attr">destroy-method</span>=<span class="string">"over"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 构造方法注入 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">value</span>=<span class="string">"smalle"</span>&gt;</span><span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- set方法注入 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"country"</span> <span class="attr">value</span>=<span class="string">"CN"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- list/set/map/properties --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"arrs"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">list</span>&gt;</span><span class="comment">&lt;!-- 或为set --&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- 如果集合内是简单类型，使用value子标签，如果是POJO类型，则使用bean标签 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>张三<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>李四<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- &lt;bean&gt;&lt;/bean&gt; --&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"map"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">map</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"name"</span> <span class="attr">value</span>=<span class="string">"test"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"age"</span> <span class="attr">value</span>=<span class="string">"18"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"pro"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">props</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"uname"</span>&gt;</span>root<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"pass"</span>&gt;</span>123<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">props</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- p空间名称注入时需要引入 xmlns:p 声明 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"address"</span> <span class="attr">class</span>=<span class="string">"cn.aezo.test.spring.Address"</span> <span class="attr">p:country</span>=<span class="string">"CN"</span> <span class="attr">p:city</span>=<span class="string">"SH"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"person"</span> <span class="attr">class</span>=<span class="string">"cn.aezo.test.spring.Person"</span> <span class="attr">p:name</span>=<span class="string">"smalle"</span> <span class="attr">p:age</span>=<span class="string">"18"</span> <span class="attr">p:address-ref</span>=<span class="string">"address"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="SPEL"><a href="#SPEL" class="headerlink" title="SPEL"></a>SPEL</h2><ul><li>参考<a href="#属性赋值(@Value">属性赋值(@Value)</a>)</li></ul><h3 id="自定义注解结合EL表达式"><a href="#自定义注解结合EL表达式" class="headerlink" title="自定义注解结合EL表达式"></a>自定义注解结合EL表达式</h3><ul><li>自定义简单的SPEL解析工具类，参考<code>@Value</code><ul><li><a href="https://juejin.cn/post/6921491842865299469#heading-14" target="_blank" rel="noopener">https://juejin.cn/post/6921491842865299469#heading-14</a></li><li><a href="https://www.codeleading.com/article/84985969416/" target="_blank" rel="noopener">https://www.codeleading.com/article/84985969416/</a></li><li><a href="https://www.cnblogs.com/itplay/p/12322315.html" target="_blank" rel="noopener">https://www.cnblogs.com/itplay/p/12322315.html</a></li><li><a href="http://www.yanzuoguang.com/article/1022.html" target="_blank" rel="noopener">http://www.yanzuoguang.com/article/1022.html</a></li></ul></li><li>参考项目 <code>report-table-backend</code> 下的 <code>@HasPermission</code></li></ul><h2 id="SpringMVC"><a href="#SpringMVC" class="headerlink" title="SpringMVC"></a>SpringMVC</h2><ul><li>关键类：<strong><code>DispatcherServlet#doDispatch</code></strong></li><li>SpringMVC 的整个请求流程</li></ul><p><img src="/data/images/java/springmvc-flow.png" alt="springmvc-flow"></p><ul><li>前端控制器 - 处理映射器 - 处理适配器 - 处理器 - 视图解析器 - 视图渲染</li></ul><h3 id="映射处理器HandlerMapping"><a href="#映射处理器HandlerMapping" class="headerlink" title="映射处理器HandlerMapping"></a>映射处理器HandlerMapping</h3><ul><li>映射处理器：就是实现了HandlerMapping接口，处理url到bean的映射</li><li>常见的<ul><li><code>RequestMappingHandlerMapping</code> 处理@RequestMapping</li><li><code>BeanNameUrlHandlerMapping</code> 将bean的name作为url进行查找，需要在配置Handler时指定bean name，且必须以 / 开头</li><li><code>SimpleUrlHandlerMapping</code> 可以通过内部参数去配置请求的 url 和 handler 之间的映射关系。springboot中使用此类进行映射的地方(调用其setUrlMap进行注入)<ul><li>ResourceHandlerRegistry</li><li>ViewControllerRegistry</li><li>WebMvcAutoConfiguration.FaviconConfiguration</li><li>DefaultServletHandlerConfigurer 默认没有设置handle，可基于WebMvcConfigurer实现配置(仅使用默认DefaultServletHandlerConfigurer，无法注入自定义的Interceptor，可自定义默认ServletHandler解决)</li></ul></li></ul></li><li>自定义HandlerMapping <a href="https://www.cnblogs.com/hujunzheng/p/9902475.html" target="_blank" rel="noopener">^4</a></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthUserInfoHandlerMapping</span> <span class="keyword">extends</span> <span class="title">SimpleUrlHandlerMapping</span> <span class="keyword">implements</span> <span class="title">HttpRequestHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> AuthManager authManager;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> order = Ordered.LOWEST_PRECEDENCE - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(AuthManager authManager)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.authManager = authManager;</span><br><span class="line">        <span class="keyword">this</span>.setOrder(order);</span><br><span class="line">        <span class="keyword">this</span>.setUrlMap(MiscU.toMap(<span class="string">"/core/user/info"</span>, <span class="keyword">this</span>)); <span class="comment">// 拦截路径</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleRequest</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        <span class="comment">// ...类似 controller 进行处理</span></span><br><span class="line">        SqAuthUserInfo sqAuthUserInfo = authManager.getUserInfo();</span><br><span class="line">        BaseRequest.writeSuccess(response, sqAuthUserInfo);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> AuthUserInfoHandlerMapping <span class="title">mySimpleUrlHandlerMapping</span><span class="params">(AuthManager authManager)</span> </span>&#123;</span><br><span class="line">    AuthUserInfoHandlerMapping auim = <span class="keyword">new</span> AuthUserInfoHandlerMapping();</span><br><span class="line">    auim.init(authManager);</span><br><span class="line">    <span class="keyword">return</span> auim;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="拦截器"><a href="#拦截器" class="headerlink" title="拦截器"></a>拦截器</h3><ul><li><p>Filter 与 Interceptor 区别</p><ul><li><strong>Filter作用在 DispatcherServlet 调用前，Interceptor作用在调用后</strong></li><li>Filter 由 Servlet 标准定义，要求 Filter 需要在 Servlet 被调用之前调用，作用顾名思义，就是用来过滤请求。<strong>在 Spring Web 应用中，DispatcherServlet 就是唯一默认的 Servlet 实现</strong></li><li><p>Interceptor 由 Spring 自己定义，由 DispatcherServlet 调用，可以定义在 Handler 调用前后的行为。这里的 Handler ，在多数情况下，就是我们的 Controller 中对应的方法</p><ul><li>参考 <strong>DispatcherServlet#doDispatch -&gt; mappedHandler.applyPreHandle -&gt; interceptor.preHandle</strong>(只有URL匹配到了对应的Handler，才会调用preHandle方法)</li><li>默认<code>/**</code>路径会被 SimpleUrlHandlerMapping 拦截(静态资源映射使用的类)，因此如果重写了<code>spring.mvc.static-path-pattern</code>则可能有些路径找不到对应Handler，从而不执行preHandle</li></ul><p><img src="/data/images/java/Filter-Interceptor.png" alt="Filter-Interceptor.png"></p></li></ul></li><li>实现方式<ul><li>实现 Filter 或继承 OncePerRequestFilter，并增加注解@Component</li><li>往 FilterRegistrationBean 中注册Filter，可指定拦截某路径。可以创建多个FilterRegistrationBean对象，优先级按照Order属性值来(小的优先)</li><li>实现 WebMvcConfigurer，并加入自定义的HandlerInterceptor，可指定拦截路径和设定Order顺序</li></ul></li></ul><h4 id="基于Filter进行拦截"><a href="#基于Filter进行拦截" class="headerlink" title="基于Filter进行拦截"></a>基于Filter进行拦截</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 暴露即可注入到拦截链中(如果要指定拦截路径，需要手动判断)</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;&#125; <span class="comment">// javax.servlet.Filter</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthFilter2</span> <span class="keyword">extends</span> <span class="title">OncePerRequestFilter</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 往FilterRegistrationBean中注册，可以创建多个FilterRegistrationBean对象（可指定拦截路径）</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> FilterRegistrationBean&lt;AuthFilter&gt; <span class="title">indexFilterRegistration</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    FilterRegistrationBean&lt;AuthFilter&gt; registrationBean = <span class="keyword">new</span> FilterRegistrationBean&lt;&gt;();</span><br><span class="line">    <span class="comment">// 一个registrationBean只能设置一个Filter</span></span><br><span class="line">    registrationBean.setFilter(<span class="keyword">new</span> AuthFilter()); <span class="comment">// 此时Filter无需增加@Component</span></span><br><span class="line">    registrationBean.setUrlPatterns(<span class="string">"/*"</span>); <span class="comment">// 过滤所有路径(只有一个*)</span></span><br><span class="line">    <span class="comment">// Filter的init方法中可获取到此参数值：exclusions = filterConfig.getInitParameter("exclusions");</span></span><br><span class="line">    registrationBean.addInitParameter(<span class="string">"exclusions"</span>, <span class="string">"*.js,*.gif,*.jpg,*.png,*.css,*.ico"</span>);</span><br><span class="line">    registrationBean.setOrder(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> registrationBean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="基于HandlerInterceptor-WebRequestInterceptor进行拦截"><a href="#基于HandlerInterceptor-WebRequestInterceptor进行拦截" class="headerlink" title="基于HandlerInterceptor/WebRequestInterceptor进行拦截"></a>基于HandlerInterceptor/WebRequestInterceptor进行拦截</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义拦截器(且需如下文注入到 WebMvcConfigurer)</span></span><br><span class="line"><span class="comment">// @Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyInterceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line">    <span class="comment">// **如果需要存放额外参数可使用 ThreadLocal**</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Long&gt; startTimeThreadLocal = <span class="keyword">new</span> NamedThreadLocal&lt;Long&gt;(<span class="string">"ThreadLocal StartTime"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;在请求处理之前进行调用（Controller方法调用之前）"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>; <span class="comment">// 只有返回true才会继续向下执行，**返回false取消当前请求**</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 这个方法只会在当前这个Interceptor的preHandle方法返回值为true的时候才会执行。</span></span><br><span class="line"><span class="comment">    * postHandle是进行处理器拦截用的，它的执行时间是在处理器进行处理之后，也就是在Controller的方法调用之后执行，但是它会在DispatcherServlet进行视图的渲染之前执行，也就是说在这个方法中你可以对ModelAndView进行操作。</span></span><br><span class="line"><span class="comment">    * 这个方法的链式结构跟正常访问的方向是相反的，也就是说先声明的Interceptor拦截器，该方法反而会后调用</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler,</span></span></span><br><span class="line"><span class="function"><span class="params">                        ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;请求处理之后进行调用（Controller方法调用之后），但是在视图被渲染之前"</span>);</span><br><span class="line">        System.out.println(response.getStatus()); <span class="comment">// 请求状态</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 该方法也是需要当前对应的Interceptor的preHandle方法的返回值为true时才会执行。</span></span><br><span class="line"><span class="comment">    * 该方法将在整个请求完成之后，也就是DispatcherServlet渲染了视图执行</span></span><br><span class="line"><span class="comment">    * 这个方法的主要作用是用于清理资源的，当然这个方法也只能在当前这个Interceptor的preHandle方法的返回值为true时才会执行。</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;在整个请求结束之后被调用，也就是在DispatcherServlet 渲染了对应的视图之后执行（主要是用于进行资源清理工作）"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// WebMvcConfigurer 可显示拦截器注入、静态资源映射注入、CROS配置、数据格式转换配置等</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomerWebMvcConfig</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 往InterceptorRegistry中注册。或者继承 WebMvcConfigurerAdapter减少不必要接口的实现（Spring5已经废弃，因为 JDK8提供了默认接口）</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 可添加多个组成一个拦截器链；addPathPatterns 用于添加拦截规则，excludePathPatterns 用于排除拦截</span></span><br><span class="line">        <span class="comment">// 此处路径最终会加上spirng.context的值，才是真正的拦截完整路径</span></span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> MyInterceptor()).addPathPatterns(<span class="string">"/**"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="拦截request的body数据"><a href="#拦截request的body数据" class="headerlink" title="拦截request的body数据"></a>拦截request的body数据</h4><ul><li>通过request的body数据（request.getParameter无法获取body）只能通过InputStream获取，而且只能获取一次</li><li>常见问题：可能出现自定义Filter中使用了body，导致Controller中无法再使用@RequestBody获取数据<ul><li><code>request.setAttribute(&quot;body&quot;, body);</code> 灵活度不高，会影响其他Filter</li><li>如果需要多次获取可以使用HttpServletRequestWrapper进行缓存</li><li><code>application/x-www-form-urlencoded</code> 请求类型时，数据会以a=1&amp;b=2的形式保存在body里面。当执行request.getParameterMap()时，会将数据从body中取出进行缓存</li></ul></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomerHttpServletRequestWrapper</span> <span class="keyword">extends</span> <span class="title">HttpServletRequestWrapper</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] body;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ObjectMapper objectMapper;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Map&gt; MAP_THREAD_LOCAL = <span class="keyword">new</span> ThreadLocal&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WarningRequestWrapper</span><span class="params">(HttpServletRequest request, ObjectMapper objectMapper)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(request);</span><br><span class="line">        body = StreamUtils.copyToByteArray(request.getInputStream());</span><br><span class="line">        <span class="keyword">this</span>.objectMapper = objectMapper;</span><br><span class="line">        setBodyMap(<span class="keyword">this</span>.parseBodyMap());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BufferedReader <span class="title">getReader</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(getInputStream()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServletInputStream <span class="title">getInputStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ByteArrayInputStream bais = <span class="keyword">new</span> ByteArrayInputStream(body);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ServletInputStream() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isFinished</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isReady</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setReadListener</span><span class="params">(ReadListener readListener)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> bais.read();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map <span class="title">parseBodyMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span>(body != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span>(body.length != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> objectMapper.readValue(body, Map.class);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    <span class="comment">// do nothing. eg: multipart/form-data</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            map.put(<span class="string">"_SQ_BODY"</span>, <span class="keyword">new</span> String(body, Charset.forName(<span class="string">"UTF-8"</span>)));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setBodyMap</span><span class="params">(Map map)</span> </span>&#123;</span><br><span class="line">        MAP_THREAD_LOCAL.set(map);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title">getBodyMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> MAP_THREAD_LOCAL.get();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">removerBodyMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        MAP_THREAD_LOCAL.remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过filter进行下发（实现 Filter，或继承 OncePerRequestFilter）</span></span><br><span class="line">CustomerHttpServletRequestWrapper warpper = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">boolean</span> multipart = <span class="keyword">false</span>;</span><br><span class="line">String contentType = request.getContentType();</span><br><span class="line"><span class="keyword">if</span> (contentType != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span>(request.getContentType().contains(MediaType.MULTIPART_FORM_DATA_VALUE)) &#123;</span><br><span class="line">        multipart = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(request.getContentType().contains(MediaType.APPLICATION_FORM_URLENCODED_VALUE)) &#123;</span><br><span class="line">        <span class="comment">// 如果是 application/x-www-form-urlencoded, 参数值在request body中以 a=1&amp;b=2&amp;c=3...形式存在</span></span><br><span class="line">        <span class="comment">// 若直接构造 BodyReaderHttpServletRequestWrapper, 在将流读取并存到copy字节数组里之后, request.getParameterMap()将返回空值</span></span><br><span class="line">        <span class="comment">// 若运行一下 request.getParameterMap(), 则会将body中的数据缓存, 并清空body中数据</span></span><br><span class="line">        <span class="comment">// 所以两者是互斥的. https://www.jianshu.com/p/f7f8237861e7</span></span><br><span class="line">        request.getParameterMap();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(multipart)&#123;</span><br><span class="line">    <span class="comment">// 文件上传类型，不做控制</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    wrapper = <span class="keyword">new</span> CustomerHttpServletRequestWrapper(request, objectMapper);</span><br><span class="line">&#125;</span><br><span class="line">filterChain.doFilter(warpper, servletResponse);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 之后获取</span></span><br><span class="line">Map body = warpper.getBodyMap();</span><br></pre></td></tr></table></figure><h4 id="拦截response的数据"><a href="#拦截response的数据" class="headerlink" title="拦截response的数据"></a>拦截response的数据</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InterceptResponse</span> <span class="keyword">implements</span> <span class="title">ResponseBodyAdvice</span>&lt;<span class="title">Object</span>&gt;</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(MethodParameter methodParameter, Class aClass)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 返回true则表示进行拦截</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">beforeBodyWrite</span><span class="params">(Object o, MethodParameter methodParameter, MediaType mediaType, Class aClass, ServerHttpRequest serverHttpRequest, ServerHttpResponse serverHttpResponse)</span> </span>&#123;</span><br><span class="line">        ServletServerHttpRequest req = (ServletServerHttpRequest) serverHttpRequest;</span><br><span class="line">        HttpServletRequest servletRequest = req.getServletRequest();</span><br><span class="line">        <span class="comment">// o 即为返回值，此处临时保存。可结合 HandlerInterceptor，在其 postHandle 方法中再次使用</span></span><br><span class="line">        servletRequest.setAttribute(<span class="string">"_resultBodyObject"</span>, o);</span><br><span class="line">        <span class="keyword">return</span> o;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="WebMvcConfigurer"><a href="#WebMvcConfigurer" class="headerlink" title="WebMvcConfigurer"></a>WebMvcConfigurer</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomerWebMvcConfig</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configurePathMatch</span><span class="params">(PathMatchConfigurer configurer)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// setUseSuffixPatternMatch: 是否启用后缀模式匹配，如 /user 是否匹配 /user.*，默认真即匹配。如果需要完全匹配 /user、/user.html，则设置成false</span></span><br><span class="line">        <span class="comment">// setUseTrailingSlashMatch: 是否自动后缀路径模式匹配，如 /user 是否匹配 /user/，默认真即匹配</span></span><br><span class="line">        configurer.setUseSuffixPatternMatch(<span class="keyword">true</span>)</span><br><span class="line">                .setUseTrailingSlashMatch(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 往InterceptorRegistry中注册。或者继承 WebMvcConfigurerAdapter减少不必要接口的实现（Spring5已经废弃，因为 JDK8提供了默认接口）</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 可添加多个组成一个拦截器链；addPathPatterns 用于添加拦截规则，excludePathPatterns 用于排除拦截</span></span><br><span class="line">        <span class="comment">// 此处路径最终会加上spirng.context的值，才是真正的拦截完整路径</span></span><br><span class="line">        registry.addInterceptor(myInterceptor).addPathPatterns(<span class="string">"/**"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h3><ul><li>处理方式，参考：<a href="https://www.freesion.com/article/86641357119/" target="_blank" rel="noopener">https://www.freesion.com/article/86641357119/</a><ul><li>@Controller + @ExceptionHandler</li><li>@ControllerAdvice + @ExceptionHandler</li><li>实现HandlerExceptionResolver接口</li></ul></li></ul><h2 id="Spring相关类-接口说明"><a href="#Spring相关类-接口说明" class="headerlink" title="Spring相关类/接口说明"></a>Spring相关类/接口说明</h2><h3 id="org-springframework-context"><a href="#org-springframework-context" class="headerlink" title="org.springframework.context"></a>org.springframework.context</h3><ul><li>annotation<ul><li><code>@Import</code> 导入Bean，具体见上文</li><li><code>@ImportResource</code></li><li><code>ImportSelector</code></li><li><code>DeferredImportSelector</code></li><li><code>ImportBeanDefinitionRegistrar</code></li></ul></li></ul><h3 id="org-springframework-boot"><a href="#org-springframework-boot" class="headerlink" title="org.springframework.boot"></a>org.springframework.boot</h3><ul><li>context.properties<ul><li><code>@ConfigurationProperties</code> 将properties配置文件中的属性对应到类上，需要和@EnableConfigurationProperties或@Component等结合使用</li><li><code>@EnableConfigurationProperties</code> 使使用@ConfigurationProperties注解的类生效，可在任何配置类上定义<ul><li>如果一个配置类只配置@ConfigurationProperties注解，而没有使用@Component，那么在IOC容器中是获取不到properties配置文件转化的bean(但是可以通过@Value直接获取properties的值)。说白了@EnableConfigurationProperties相当于把使用@ConfigurationProperties的类进行了一次注入。如：@EnableConfigurationProperties({FeignClientEncodingProperties.class})</li></ul></li></ul></li><li>autoconfigure<ul><li><code>@AutoConfigureBefore</code></li><li><code>@AutoConfigureAfter</code> 在加载某配置的类之后再加载当前类。如：@AutoConfigureAfter({FeignAutoConfiguration.class})</li></ul></li></ul><h3 id="org-springframework-util"><a href="#org-springframework-util" class="headerlink" title="org.springframework.util"></a>org.springframework.util</h3><ul><li><p><code>AntPathMatcher</code> 路径通配符匹配</p></li><li><p>示例</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AntPathMatcher</span></span><br><span class="line">String url = <span class="string">"/blog/detail/get.do"</span>;</span><br><span class="line">AntPathMatcher matcher = <span class="keyword">new</span> AntPathMatcher();</span><br><span class="line">matcher.match(<span class="string">"/blog/**/*.do"</span>, url); <span class="comment">// true</span></span><br></pre></td></tr></table></figure><hr><p>参考文章</p></div><div></div><div></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> smalle</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="http://blog.aezo.cn/2017/07/01/java/spring/" title="Spring">http://blog.aezo.cn/2017/07/01/java/spring/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/spring/" rel="tag"># spring</a> <a href="/tags/mvc/" rel="tag"># mvc</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2017/06/25/devops/docker/" rel="next" title="Docker"><i class="fa fa-chevron-left"></i> Docker</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"> <a href="/2017/07/16/lang/python/scrapy/" rel="prev" title="Scrapy">Scrapy<i class="fa fa-chevron-right"></i></a></div></div></footer></article><div class="post-spread"><div> <a target="_blank" href="https://github.com/oldinaction/ChatGPT-MP"><img class="nofancybox" style="width:300px;margin:0 auto" src="https://cdn7.aezo.cn/one/chat/chat-gpt-open-banner.jpg" alt="ChatGPT开源小程序" title="ChatGPT开源小程序"></a></div></div></div></div><div class="comments" id="comments"></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> 文章目录</li><li class="sidebar-nav-overview" data-target="site-overview"> 站点概览</li></ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="https://avatars0.githubusercontent.com/u/15698218?v=3&u=ce740bf0b67ff0d74990ba6fc644d6e92f572dcb&s=400" alt="smalle"><p class="site-author-name" itemprop="name">smalle</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">167</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/index.html"><span class="site-state-item-count">14</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/index.html"><span class="site-state-item-count">153</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"></div><div> 欢迎关注公众号：阿壹族 <img class="nofancybox" style="width:120px;margin:0 auto" src="https://cdn7.aezo.cn/common/qrcode/ayz_qrcode.jpg" alt="欢迎关注公众号：阿壹族" title="欢迎关注公众号：阿壹族"></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#介绍"><span class="nav-number">1.</span> <span class="nav-text">介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HelloWorld"><span class="nav-number">2.</span> <span class="nav-text">HelloWorld</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#常见注解"><span class="nav-number">3.</span> <span class="nav-text">常见注解</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#往容器中注册Bean-组件"><span class="nav-number">3.1.</span> <span class="nav-text">往容器中注册Bean(组件)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#组件注解-包扫描"><span class="nav-number">3.1.1.</span> <span class="nav-text">组件注解+包扫描</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Bean导入第三方包里面的组件"><span class="nav-number">3.1.2.</span> <span class="nav-text">@Bean导入第三方包里面的组件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Import给容器导入一个组件"><span class="nav-number">3.1.3.</span> <span class="nav-text">@Import给容器导入一个组件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用Spring提供的FactoryBean-工厂Bean"><span class="nav-number">3.1.4.</span> <span class="nav-text">使用Spring提供的FactoryBean(工厂Bean)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#基于Springboot的EnableAutoConfiguration"><span class="nav-number">3.1.5.</span> <span class="nav-text">基于Springboot的EnableAutoConfiguration</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#自动装配-取出Bean赋值给当前类属性"><span class="nav-number">3.2.</span> <span class="nav-text">自动装配(取出Bean赋值给当前类属性)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#获取Bean"><span class="nav-number">3.2.1.</span> <span class="nav-text">获取Bean</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Autowired注入给静态属性示例"><span class="nav-number">3.2.2.</span> <span class="nav-text">@Autowired注入给静态属性示例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#条件注解-Conditional"><span class="nav-number">3.3.</span> <span class="nav-text">条件注解@Conditional</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#属性赋值-Value"><span class="nav-number">3.4.</span> <span class="nav-text">属性赋值(@Value)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Spring中使用属性赋值"><span class="nav-number">3.4.1.</span> <span class="nav-text">Spring中使用属性赋值</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SpringBoot中使用属性赋值"><span class="nav-number">3.4.2.</span> <span class="nav-text">SpringBoot中使用属性赋值</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PropertySource分环境读取配置"><span class="nav-number">3.4.3.</span> <span class="nav-text">@PropertySource分环境读取配置</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#组合注解和元注解"><span class="nav-number">3.5.</span> <span class="nav-text">组合注解和元注解</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#其他注解"><span class="nav-number">3.6.</span> <span class="nav-text">其他注解</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Bean"><span class="nav-number">4.</span> <span class="nav-text">Bean</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#作用域-Scope"><span class="nav-number">4.1.</span> <span class="nav-text">作用域@Scope</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Bean生命周期"><span class="nav-number">4.2.</span> <span class="nav-text">Bean生命周期</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#加载优先级"><span class="nav-number">4.3.</span> <span class="nav-text">加载优先级</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AOP"><span class="nav-number">5.</span> <span class="nav-text">AOP</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Profile"><span class="nav-number">6.</span> <span class="nav-text">Profile</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ApplicationEvent"><span class="nav-number">7.</span> <span class="nav-text">ApplicationEvent</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SpringAware"><span class="nav-number">8.</span> <span class="nav-text">SpringAware</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ApplicationContext"><span class="nav-number">9.</span> <span class="nav-text">ApplicationContext</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#多线程-EnableAsync"><span class="nav-number">10.</span> <span class="nav-text">多线程@EnableAsync</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#计划任务-Scheduled"><span class="nav-number">11.</span> <span class="nav-text">计划任务@Scheduled</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#事物支持"><span class="nav-number">12.</span> <span class="nav-text">事物支持</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#事物"><span class="nav-number">12.1.</span> <span class="nav-text">事物</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#隔离级别"><span class="nav-number">12.2.</span> <span class="nav-text">隔离级别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#传播行为"><span class="nav-number">12.3.</span> <span class="nav-text">传播行为</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#事物示例"><span class="nav-number">12.4.</span> <span class="nav-text">事物示例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#自调用导致-Transactional失效问题"><span class="nav-number">12.5.</span> <span class="nav-text">自调用导致@Transactional失效问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#捕获嵌套事物异常导致报错"><span class="nav-number">12.6.</span> <span class="nav-text">捕获嵌套事物异常导致报错</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#在事物中提前关闭了连接"><span class="nav-number">12.7.</span> <span class="nav-text">在事物中提前关闭了连接</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Spring-XML配置"><span class="nav-number">13.</span> <span class="nav-text">Spring-XML配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SPEL"><span class="nav-number">14.</span> <span class="nav-text">SPEL</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#自定义注解结合EL表达式"><span class="nav-number">14.1.</span> <span class="nav-text">自定义注解结合EL表达式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SpringMVC"><span class="nav-number">15.</span> <span class="nav-text">SpringMVC</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#映射处理器HandlerMapping"><span class="nav-number">15.1.</span> <span class="nav-text">映射处理器HandlerMapping</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#拦截器"><span class="nav-number">15.2.</span> <span class="nav-text">拦截器</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#基于Filter进行拦截"><span class="nav-number">15.2.1.</span> <span class="nav-text">基于Filter进行拦截</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#基于HandlerInterceptor-WebRequestInterceptor进行拦截"><span class="nav-number">15.2.2.</span> <span class="nav-text">基于HandlerInterceptor/WebRequestInterceptor进行拦截</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#拦截request的body数据"><span class="nav-number">15.2.3.</span> <span class="nav-text">拦截request的body数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#拦截response的数据"><span class="nav-number">15.2.4.</span> <span class="nav-text">拦截response的数据</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#WebMvcConfigurer"><span class="nav-number">15.3.</span> <span class="nav-text">WebMvcConfigurer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#异常处理"><span class="nav-number">15.4.</span> <span class="nav-text">异常处理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Spring相关类-接口说明"><span class="nav-number">16.</span> <span class="nav-text">Spring相关类/接口说明</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#org-springframework-context"><span class="nav-number">16.1.</span> <span class="nav-text">org.springframework.context</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#org-springframework-boot"><span class="nav-number">16.2.</span> <span class="nav-text">org.springframework.boot</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#org-springframework-util"><span class="nav-number">16.3.</span> <span class="nav-text">org.springframework.util</span></a></li></ol></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright"> &copy; 2016 - <span itemprop="copyrightYear">2025</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">smalle</span>&nbsp;&nbsp;&nbsp;&nbsp;<div class="powered-by"> 由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div><div class="powered-by"> 主题 - <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a></div><div class="theme-info"> <a class="theme-link" target="_blank" href="https://tongji.baidu.com/main/overview/10000542408/overview/index?siteId=18991897">站长统计</a></div></div><div class="ad"> <span style="font-weight:700">AD&nbsp;&nbsp;&nbsp;&nbsp;</span><div class="theme-info"> <a target="_blank" href="https://promotion.aliyun.com/ntms/yunparter/invite.html?userCode=oby5nolb">阿里云大礼包</a></div></div><div class="aezocn"> <span style="font-weight:700">&copy;AEZO.CN&nbsp;&nbsp;&nbsp;&nbsp;</span><div class="powered-by"> <a target="_blank" href="https://shengqitech.aezo.cn/">圣骑科技</a></div><div class="powered-by"> <a target="_blank" href="https://cdn7.aezo.cn/common/qrcode/one_qrcode.jpg">【One能抽屉】小程序</a></div><div class="theme-info"> <a target="_blank" href="http://shop.aezo.cn/">杂货铺(省钱小助手)</a></div></div><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?085f9cd91ef2ad985f791c677472f0d1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script><script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script type="text/javascript" src="/js/src/js.cookie.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/scroll-cookie.js?v=5.1.1"></script></body></html>