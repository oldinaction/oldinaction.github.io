<!doctype html><html class="theme-next mist use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css"><meta name="keywords" content="docker,arch,"><link rel="alternate" href="/atom.xml" title="月星墙的博客" type="application/atom+xml"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1"><meta name="description" content="镜像 华为开源镜像站: https://mirrors.huaweicloud.com/ 清华大学开源软件镜像站: https://mirror.tuna.tsinghua.edu.cn/  Docker介绍 支持Linux、Windows、Mac等系统 传统虚拟化(虚拟机)是在硬件层面实现虚拟化，需要额外的虚拟机管理应用和虚拟机操作系统层。Docker容器是在操作系统层面实现虚拟化，直接复用本地"><meta name="keywords" content="docker,arch"><meta property="og:type" content="article"><meta property="og:title" content="Docker"><meta property="og:url" content="http://blog.aezo.cn/2017/06/25/devops/docker/index.html"><meta property="og:site_name" content="月星墙的博客"><meta property="og:description" content="镜像 华为开源镜像站: https://mirrors.huaweicloud.com/ 清华大学开源软件镜像站: https://mirror.tuna.tsinghua.edu.cn/  Docker介绍 支持Linux、Windows、Mac等系统 传统虚拟化(虚拟机)是在硬件层面实现虚拟化，需要额外的虚拟机管理应用和虚拟机操作系统层。Docker容器是在操作系统层面实现虚拟化，直接复用本地"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="http://blog.aezo.cn/data/images/linux/network-vxlan.png"><meta property="og:image" content="http://blog.aezo.cn/data/images/devops/docker-overlay-1.png"><meta property="og:updated_time" content="2025-09-08T03:17:32.524Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Docker"><meta name="twitter:description" content="镜像 华为开源镜像站: https://mirrors.huaweicloud.com/ 清华大学开源软件镜像站: https://mirror.tuna.tsinghua.edu.cn/  Docker介绍 支持Linux、Windows、Mac等系统 传统虚拟化(虚拟机)是在硬件层面实现虚拟化，需要额外的虚拟机管理应用和虚拟机操作系统层。Docker容器是在操作系统层面实现虚拟化，直接复用本地"><meta name="twitter:image" content="http://blog.aezo.cn/data/images/linux/network-vxlan.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",sidebar:{position:"right",display:"post",offset:12,offset_float:0,b2t:!1,scrollpercent:!1},fancybox:!0,motion:!0,duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"BWD6R9FA4K",apiKey:"3330f3cbaa099dfc30395de5f5b20151",indexName:"blog",hits:{per_page:10},labels:{input_placeholder:"请输入关键字",hits_empty:"我们没有找到任何搜索结果: ${query}",hits_stats:"找到约${hits}条结果（用时${time}ms）"}}}</script><link rel="canonical" href="http://blog.aezo.cn/2017/06/25/devops/docker/"><title>Docker | 月星墙的博客</title><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?085f9cd91ef2ad985f791c677472f0d1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-right page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">月星墙的博客</span><span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">Better Code, Better Life</h1></div><div class="site-nav-toggle"> <button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br> 首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br> 分类</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br> 关于</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br> 归档</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br> 标签</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i><br> 站点地图</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br> 搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"> <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><link itemprop="mainEntityOfPage" href="http://blog.aezo.cn/2017/06/25/devops/docker/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="smalle"><meta itemprop="description" content=""><meta itemprop="image" content="https://avatars0.githubusercontent.com/u/15698218?v=3&u=ce740bf0b67ff0d74990ba6fc644d6e92f572dcb&s=400"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="月星墙的博客"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">Docker</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-25T14:03:00+08:00">2017-06-25</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/devops/" itemprop="url" rel="index"><span itemprop="name">devops</span></a></span></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="镜像"><a href="#镜像" class="headerlink" title="镜像"></a>镜像</h2><ul><li>华为开源镜像站: <a href="https://mirrors.huaweicloud.com/" target="_blank" rel="noopener">https://mirrors.huaweicloud.com/</a></li><li>清华大学开源软件镜像站: <a href="https://mirror.tuna.tsinghua.edu.cn/" target="_blank" rel="noopener">https://mirror.tuna.tsinghua.edu.cn/</a></li></ul><h2 id="Docker介绍"><a href="#Docker介绍" class="headerlink" title="Docker介绍"></a>Docker介绍</h2><ul><li>支持Linux、Windows、Mac等系统</li><li>传统虚拟化(虚拟机)是在硬件层面实现虚拟化，需要额外的虚拟机管理应用和虚拟机操作系统层。Docker容器是在操作系统层面实现虚拟化，直接复用本地本机的操作系统，因此更加轻量级。</li><li>Docker镜像存在版本和仓库的概念，类似Git。docker官方仓库为<a href="https://hub.docker.com/" target="_blank" rel="noopener">Docker Hub</a></li><li><a href="https://docs.docker.com" target="_blank" rel="noopener">官方文档</a></li><li><a href="https://labs.play-with-docker.com/" target="_blank" rel="noopener">在线docker测试地址</a></li><li>docker基础镜像包含<code>alpine</code>(apk)、<code>centos</code>(yum)、<code>ubuntu</code>(apt-get)三种</li><li>本文基于docker版本<code>Server Version: 1.13.1</code></li><li>国内镜像</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 设置镜像，docker-compose拉取镜像时可生效</span></span><br><span class="line">vi /etc/docker/daemon.json <span class="comment"># 加入下文配置 (windows在用户目录下.docker/daemon.json)</span></span><br><span class="line">&#123;<span class="string">"registry-mirrors"</span>: [<span class="string">"https://registry.cn-hangzhou.aliyuncs.com"</span>]&#125;</span><br><span class="line"><span class="comment"># 重启</span></span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br><span class="line"></span><br><span class="line"><span class="comment">## docker.io镜像加速。参考：https://juejin.im/post/5cd2cf01f265da0374189441</span></span><br><span class="line"><span class="comment"># 阿里云 registry.cn-hangzhou.aliyuncs.com 阿里云私有加速器(只有部分镜像) bzyep49h.mirror.aliyuncs.com</span></span><br><span class="line"><span class="comment"># 华为 swr.cn-north-4.myhuaweicloud.com</span></span><br><span class="line"><span class="comment"># 网易 hub-mirror.c.163.com</span></span><br><span class="line">docker pull xxx:yyy <span class="string">"可替换为"</span> docker pull registry.cn-hangzhou.aliyuncs.com/library/xxx:yyy</span><br><span class="line">docker pull xxx/yyy:zz <span class="string">"可替换为"</span> docker pull registry.cn-hangzhou.aliyuncs.com/xxx/yyy:zz</span><br><span class="line"><span class="comment"># Azure中国镜像 `dockerhub.azk8s.cn`</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## gcr.io镜像加速</span></span><br><span class="line"><span class="comment"># 中科大 `gcr.mirrors.ustc.edu.cn`</span></span><br><span class="line">docker pull gcr.io/xxx/yyy:zzz <span class="string">"可替换为"</span> docker pull gcr.mirrors.ustc.edu.cn/xxx/yyy:zzz</span><br><span class="line"><span class="comment"># Azure中国镜像 `gcr.azk8s.cn`</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## k8s.gcr.io镜像加速。k8s.gcr.io等价于gcr.io/google-containers</span></span><br><span class="line"><span class="comment"># 中科大 `gcr.mirrors.ustc.edu.cn/google-containers`</span></span><br><span class="line">docker pull k8s.gcr.io/xxx:yyy <span class="string">"可替换为"</span> docker pull gcr.mirrors.ustc.edu.cn/google-containers/xxx:yyy</span><br><span class="line"><span class="comment"># Azure中国镜像 `gcr.azk8s.cn/google-containers`</span></span><br><span class="line"><span class="comment"># 阿里云 `registry.aliyuncs.com/google_containers`</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## quay.io镜像加速</span></span><br><span class="line"><span class="comment"># 中科大 `quay.mirrors.ustc.edu.cn`</span></span><br><span class="line"><span class="comment"># Azure中国镜像 `quay.azk8s.cn`</span></span><br><span class="line"><span class="comment"># 七牛镜像 `quay-mirror.qiniu.com`</span></span><br><span class="line">docker pull quay.io/xxx/yyy:zzz <span class="string">"可替换为"</span> docker pull quay.mirrors.ustc.edu.cn/xxx/yyy:zzz</span><br></pre></td></tr></table></figure><ul><li>目前docker必须登录才能拉取镜像</li><li>清理docker<ul><li>mac本地测试环境想要完全重置docker虚拟磁盘文件，可删除 /Users/demo/Library/Containers/com.docker.docker/Data/vms/0/data/Docker.raw (注意会删除所有数据；重新打开docker会自动构建此文件)</li></ul></li></ul><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><ul><li>Windows<ul><li>方案一: <strong>Windows 10直接使用Docker Desktop Installer安装包</strong> <a href="https://hub.docker.com/editions/community/docker-ce-desktop-windows" target="_blank" rel="noopener">https://hub.docker.com/editions/community/docker-ce-desktop-windows</a><ul><li>基于WSL实现，安装可能报错<code>wsl update failed: update failed: updating wsl</code>，由于执行了<code>wsl.exe --update</code>更新失败导致，重新启动几下触发wsl更新</li><li>执行docker命令时提示<code>docker for windows could not read CA certificate</code>，解决<a href="https://blog.csdn.net/qq_35852248/article/details/80925154" target="_blank" rel="noopener">https://blog.csdn.net/qq_35852248/article/details/80925154</a></li><li>使用的网卡为<code>Hyper-V</code>，会导致VMware和DockerToolbox无法运行。可在控制面板 - 程序和功能 - 关闭windows的Hyper-V功能</li><li>Docker Desktop打不开问题: 基于 WSL 安装的一般会后台运行，此时需要先关闭后台才能成功打开</li></ul></li><li>方案二: 通过安装<code>DockerToolbox</code>，<a href="https://docs.docker.com/toolbox/toolbox_install_windows/" target="_blank" rel="noopener">安装文档和下载地址</a><ul><li>安装完成后桌面快捷方式：<code>Docker Quickstart Terminal</code>、<code>kitematic</code>、<code>Oracle VM VirtualBox</code><ul><li><code>Docker Quickstart Terminal</code> 可快速启动docker虚拟机，并进入到bash命令行</li><li><code>kitematic</code>是docker推出的GUI界面工具(启动后，会后台运行docker，即自动运行docker虚拟机)</li><li><code>Oracle VM VirtualBox</code>其实是一个虚拟机管理程序，<strong>docker就运行在此default虚拟机上</strong><ul><li>下载的docker镜像在虚拟硬盘上，<strong>default虚拟机内存默认是1G</strong>，很容易内存溢出导致容器无法运行，可以在VirtualBox中进行调整</li><li>虚拟机启动默认用户为 <strong><code>docker/tcuser</code></strong>，可通过<code>ssh docker@192.168.99.100</code>进入此虚拟机</li></ul></li></ul></li><li>运行<code>Docker Quickstart Terminal</code>，提示找不到<code>bash.exe</code>，可以浏览选择git中包含的bash(或者右键修改此快捷方式启动参数。目标：<code>&quot;D:\software\Git\bin\bash.exe&quot; --login -i &quot;D:\software\Docker Toolbox\start.sh&quot;</code>)。第一次启动较慢，启动成功会显示docker的图标</li><li>如果DockerToolbox运行出错<code>Looks like something went wrong in step ´Checking status on default..</code>，可以单独更新安装<code>VirtualBox</code></li><li>xshell连接docker虚拟机：<a href="/posts/extend/vmware.md#Oracle-VM-VirtualBox">http://blog.aezo.cn/2017/06/24/extend/vmware/</a></li></ul></li><li>方案三: 安装<a href="https://github.com/boot2docker/windows-installer" target="_blank" rel="noopener">Boot2Docker</a></li><li>如果设置了C盘搬家到D盘，容易出现磁盘占满问题。可将虚拟机的disk.vmdk直接移动到D盘，步骤如下<ul><li>复制<code>C:\Users\smalle\.docker\machine\machines\default\disk.vmdk</code>到<code>D:/data/docker/disk.vmdk</code></li><li>进入VirtualBox(4.0.4以上)安装目录，执行<code>VBoxManage internalcommands sethduuid D:/data/docker/vdisk.vmdk</code>重设磁盘UUID</li><li>打开VirtualBox，删除default原有的磁盘，然后添加新磁盘指向D:/data/docker/disk.vmdk</li></ul></li><li>windows命令行运行docker命令提示无此命令，可将<code>D:\software\Docker Toolbox</code>加入到Path中</li></ul></li><li>linux</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">yum install docker <span class="comment"># 安装</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">systemctl start docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据文件默认保存在`/var/lib/docker`下，建议先进行修改，修改后此目录可不用保存</span></span><br><span class="line">vi /etc/docker/daemon.json</span><br><span class="line">&#123;<span class="string">"registry-mirrors"</span>: [<span class="string">"https://registry.cn-hangzhou.aliyuncs.com"</span>], <span class="string">"graph"</span>: <span class="string">"/data/docker"</span>, <span class="string">"dns"</span> : [<span class="string">"114.114.114.114"</span>, <span class="string">"8.8.8.8"</span>]&#125;</span><br><span class="line"><span class="comment"># 重启</span></span><br><span class="line">sudo systemctl daemon-reload &amp;&amp; sudo systemctl restart docker</span><br></pre></td></tr></table></figure><ul><li>ubuntu安装</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install docker.io</span><br><span class="line">sudo gpasswd -a <span class="variable">$&#123;USER&#125;</span> docker <span class="comment"># 把当前用户加入到docker组</span></span><br><span class="line">cat /etc/group | grep ^docker <span class="comment"># 查看是否添加成功</span></span><br></pre></td></tr></table></figure><h2 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h2><h3 id="docker"><a href="#docker" class="headerlink" title="docker"></a>docker</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">docker   <span class="comment"># docker 命令帮助</span></span><br><span class="line"></span><br><span class="line">Management Commands:</span><br><span class="line">  container   Manage containers</span><br><span class="line">  image       Manage images     <span class="comment"># 展示所有镜像</span></span><br><span class="line">  network     Manage networks</span><br><span class="line">    ls			<span class="comment"># docker network ls # 列举网络(使用docker-compose启动，容器默认会加入到一个xxx_default的网络中)</span></span><br><span class="line">	  rm			<span class="comment"># sudo docker network rm my_net1 my_net2 # 移除网络</span></span><br><span class="line">    connect		<span class="comment"># docker network connect my_net my_new_app # 可将启动后的容器my_new_app手动加入到已存在的网络my_net中</span></span><br><span class="line">  node        Manage Swarm nodes</span><br><span class="line">  plugin      Manage plugins</span><br><span class="line">  secret      Manage Docker secrets</span><br><span class="line">  service     Manage services</span><br><span class="line">  stack       Manage Docker stacks</span><br><span class="line">  swarm       Manage Swarm</span><br><span class="line">  system      Manage Docker</span><br><span class="line">    prune <span class="comment"># docker system prune # 清理资源：停止的容器、未被任何容器所使用的卷、未被任何容器所关联的网络、所有悬空镜像</span></span><br><span class="line">    df <span class="comment"># docker system df # 查看所占的硬盘大小</span></span><br><span class="line">    info</span><br><span class="line">    events</span><br><span class="line">  volume      Manage volumes <span class="comment"># 管理容器卷(可理解成就是一个目录)。https://docs.docker.com/storage/volumes/</span></span><br><span class="line">    <span class="comment"># volume绕过container的文件系统，直接将数据写到host机器上(默认存放路径 /var/lib/docker/volumes)</span></span><br><span class="line">    <span class="comment"># 修改默认存储位置，参考：https://blog.51cto.com/nanfeibobo/2091960</span></span><br><span class="line">        <span class="comment"># docker是1.12或以上的版本，可修改`vi /etc/docker/daemon.json`文件（如：`&#123;"graph": "/data/docker"&#125;`），会自动创建此目录，修改后会立即生效，不需重启docker服务。</span></span><br><span class="line">    <span class="comment"># 映射了容器卷之后，实际数据存放再docker默认存储位置下对应的容器卷名下，如：/data/docker/volumes/jenkins-data/_data (/data/docker为docker默认存储路径，jenkins-data为某一个容器卷名)</span></span><br><span class="line">    create  <span class="comment"># docker volume create my-vol # 创建数据卷</span></span><br><span class="line">    ls      <span class="comment"># docker volume ls # 列举数据卷</span></span><br><span class="line">    rm      <span class="comment"># docker volume rm my-vol # 移除数据卷</span></span><br><span class="line"></span><br><span class="line">Commands:</span><br><span class="line">    attach    Attach to a running container                 <span class="comment"># 当前 shell 下 attach 连接指定运行镜像</span></span><br><span class="line">    build     Build an image from a Dockerfile              <span class="comment"># 通过 Dockerfile 定制镜像</span></span><br><span class="line">        -t      <span class="comment"># 定义标签(name:tag)，eg: -t demo:v1、-t demo(此时tag为latest)</span></span><br><span class="line">        -f      <span class="comment"># 指定 Dockerfile 文件路径。默认根目录下Dockerfile文件(此时可省略)</span></span><br><span class="line">        --rm    <span class="comment"># 编译成功后移除中间临时镜像</span></span><br><span class="line">        --build-arg <span class="comment"># 传递外部参数到Dockerfile中(使用ARG接受)</span></span><br><span class="line">        <span class="comment"># docker build --rm -t demo . # 根据当前目录(.)上下文环境编译</span></span><br><span class="line">    commit    Create a new image from a container’s changes <span class="comment"># 提交当前容器为新的镜像</span></span><br><span class="line">    cp        Copy files/folders from the containers filesystem to the host path <span class="comment"># 从容器中拷贝指定文件或者目录到宿主机中</span></span><br><span class="line">        <span class="comment"># docker cp demo.war sq-tomcat:/usr/local/tomcat/webapps    # 向sq-tomcat容器中部署war包</span></span><br><span class="line">        <span class="comment"># docker cp sq-tomcat:/usr/local/tomcat/webapps/demo.war .  # 从sq-tomcat容器中复制文件到宿主机</span></span><br><span class="line">    create    Create a new container                        <span class="comment"># 创建一个新的容器，同 run，但不启动容器</span></span><br><span class="line">    diff      Inspect changes on a container’s filesystem   <span class="comment"># 查看 docker 容器变化</span></span><br><span class="line">    events    Get real time events from the server          <span class="comment"># 从 docker 服务获取容器实时事件</span></span><br><span class="line">    <span class="built_in">exec</span>      Run a <span class="built_in">command</span> <span class="keyword">in</span> an existing container        <span class="comment"># 在已存在的容器上运行命令</span></span><br><span class="line">    <span class="built_in">export</span>    Stream the contents of a container as a tar archive    <span class="comment"># 导出容器的内容流作为一个 tar 归档文件[对应 import ]</span></span><br><span class="line">    <span class="built_in">history</span>   Show the <span class="built_in">history</span> of an image                  <span class="comment"># 展示一个镜像形成历史</span></span><br><span class="line">        <span class="comment"># docker history 5bb181d76b0d --no-trunc # 查看镜像构建历史，相当于Dockerfile步骤</span></span><br><span class="line">    images    List images                                   <span class="comment"># 列出系统当前镜像</span></span><br><span class="line">    import    Create a new filesystem image from the contents of a tarball   <span class="comment"># 从tar包中的内容创建一个新的文件系统映像[对应 export]</span></span><br><span class="line">    info      Display system-wide information               <span class="comment"># 显示系统相关信息</span></span><br><span class="line">        <span class="comment"># "Server Version" 即为docker版本信息</span></span><br><span class="line">    inspect   Return low-level information on a container   <span class="comment"># 查看容器详细信息</span></span><br><span class="line">		<span class="comment"># 下文查看 --format语法</span></span><br><span class="line">        <span class="comment"># docker inspect test:v1 # 查看镜像信息</span></span><br><span class="line">    <span class="built_in">kill</span>      Kill a running container                      <span class="comment"># kill 指定 docker 容器</span></span><br><span class="line">    load      Load an image from a tar archive              <span class="comment"># 从一个 tar 包中加载一个镜像[对应 save]</span></span><br><span class="line">    login     Register or Login to the docker registry server    <span class="comment"># 注册或者登陆一个 docker 源服务器</span></span><br><span class="line">    <span class="built_in">logout</span>    Log out from a Docker registry server         <span class="comment"># 从当前 Docker registry 退出</span></span><br><span class="line">    logs      Fetch the logs of a container                 <span class="comment"># 输出当前容器日志信息</span></span><br><span class="line">        <span class="comment"># 如容器异常退出可通过此命令查询，`docker logs &lt;container_id | container_name&gt;`</span></span><br><span class="line">        <span class="comment"># 或者`docker inspect &lt;container_id | container_name&gt;`获取 LogPath 位置。登录docker宿主机查了对应路径下的日志</span></span><br><span class="line">		<span class="comment"># 或者 docker start my_container sleep 1h # 表示让容器启动进入睡眠，然后exec进入容器查看原因</span></span><br><span class="line">    port      Lookup the public-facing port <span class="built_in">which</span> is NAT-ed to PRIVATE_PORT <span class="comment"># 查看映射端口对应的容器内部源端口</span></span><br><span class="line">    pause     Pause all processes within a container        <span class="comment"># 暂停容器</span></span><br><span class="line">    ps        List containers                               <span class="comment"># 列出容器列表</span></span><br><span class="line">    pull      Pull an image or a repository from the docker registry server <span class="comment"># 不管registry有没有更新，都会重新拉取相应镜像</span></span><br><span class="line">    push      Push an image or a repository to the docker registry server <span class="comment"># 推送指定镜像或者库镜像至docker源服务器</span></span><br><span class="line">    restart   Restart a running container                   <span class="comment"># 重启运行的容器</span></span><br><span class="line">    rm        Remove one or more containers                 <span class="comment"># 移除一个或者多个容器</span></span><br><span class="line">        <span class="comment"># 删除主机上所有容器：docker ps -a | awk '&#123;print $1&#125;' | xargs docker rm -f</span></span><br><span class="line">    rmi       Remove one or more images                     <span class="comment"># 移除一个或多个镜像[无容器使用该镜像才可删除，否则需删除相关容器才可继续或 -f 强制删除]</span></span><br><span class="line">    run       Run a <span class="built_in">command</span> <span class="keyword">in</span> a new container              <span class="comment"># 创建一个新的容器(并启动)并运行一个命令</span></span><br><span class="line">        -i  <span class="comment"># 开启标准输出</span></span><br><span class="line">        -d  <span class="comment"># 运行容器并启动守护进程</span></span><br><span class="line">        -t  <span class="comment"># 开启一个伪终端(进入容器命令行，组合建ctrl+p、ctrl+q退出)</span></span><br><span class="line">        -p  <span class="comment"># 绑定本地端口到容器端口，可使用多个 -p 绑定多组端口. eg: -p 8080:80 (本地8080:容器80)</span></span><br><span class="line">        -v  <span class="comment"># 挂在本地目录或文件到容器中去做数据卷，可以使用多个 -v. eg: -v /home/smalle/logs:/temp/app，也可以使用volume数据卷</span></span><br><span class="line">            <span class="comment"># 目录或者文件映射，需要先在宿主机创建此文件或目录。如果要映射出来的目录中存在文件，则需要新创建对应的文件，docker不会进行初始化这些文件</span></span><br><span class="line">            <span class="comment"># windows的目录则使用 /c/Users/smalle 格式代替 c:</span></span><br><span class="line">        -e  <span class="comment"># 设置环境变量，eg: -e MYSQL_HOST=localhost -e MYSQL_DATABASE=aezocn</span></span><br><span class="line">        -h  <span class="comment"># 指定容器的hostname。eg：-h aezocn</span></span><br><span class="line">        --name          <span class="comment"># 指定启动容器名称(从Docker 1.10 版本开始，docker daemon 实现了一个内嵌的DNS server，使容器可以直接通过"容器名"通信)</span></span><br><span class="line">        --network/--net <span class="comment"># 指定使用的网络（windows的help中并没有说明可简写为--net）</span></span><br><span class="line">        --restart       <span class="comment"># 重启模式：--restart=always失败永远重启(包括宿主主机开机后自启动)</span></span><br><span class="line">        --link          <span class="comment"># 链接其他容器。eg：docker run --link my_nginx my_db -d wordpress # 表示在wordpress中可以放访问被链接容器</span></span><br><span class="line">        --privileged    <span class="comment"># 使用该参数，container内的root拥有真正的root权限。否则container内的root只是外部的一个普通用户权限。privileged启动的容器，可以看到很多host上的设备，并且可以执行mount，甚至允许你在docker容器中启动docker容器</span></span><br><span class="line">    save      Save an image to a tar archive                <span class="comment"># 保存一个镜像为一个 tar 包[对应 load]</span></span><br><span class="line">    search    Search <span class="keyword">for</span> an image on the Docker Hub         <span class="comment"># 在 docker hub 中搜索镜像</span></span><br><span class="line">    start     Start a stopped containers                    <span class="comment"># 启动容器</span></span><br><span class="line">    stop      Stop a running containers                     <span class="comment"># 停止容器</span></span><br><span class="line">    tag       Tag an image into a repository                <span class="comment"># 给源中镜像打标签</span></span><br><span class="line">    top       Lookup the running processes of a container   <span class="comment"># 查看容器中运行的进程信息</span></span><br><span class="line">    unpause   Unpause a paused container                    <span class="comment"># 取消暂停容器</span></span><br><span class="line">    version   Show the docker version information           <span class="comment"># 查看 docker 版本号</span></span><br><span class="line">    <span class="built_in">wait</span>      Block until a container stops, <span class="keyword">then</span> <span class="built_in">print</span> its <span class="built_in">exit</span> code    <span class="comment"># 截取容器停止时的退出状态值</span></span><br><span class="line">Run <span class="string">'docker COMMAND --help'</span> <span class="keyword">for</span> more information on a <span class="built_in">command</span>.</span><br></pre></td></tr></table></figure><h3 id="镜像-1"><a href="#镜像-1" class="headerlink" title="镜像"></a>镜像</h3><ul><li>获取镜像<ul><li><code>docker pull NAME[:TAG]</code> 拉取镜像。如：<code>docker pull nginx:latest</code>(同：<code>docker pull nginx</code>，省略TAG则默认为<code>latest</code>)<ul><li><code>docker pull www.aezo.cn/aezocn/smtools:latest</code> 从私有镜像站下载镜像(<a href="http://www.aezo.cn/aezocn/smtools为repository，latest为tag" target="_blank" rel="noopener">www.aezo.cn/aezocn/smtools为repository，latest为tag</a>)</li></ul></li><li><code>docker images</code> 列出所有本地镜像<ul><li><code>docker inspect c28687f7c6c8</code> 获取某个image ID的详细信息</li></ul></li><li><code>docker search mysql</code> 搜索远程仓库镜像<ul><li>查看某个Name的所有TAG：如centos访问<code>https://hub.docker.com/r/library/centos/tags/</code>查看</li></ul></li></ul></li><li>运行镜像<ul><li><strong><code>docker run -it busybox</code></strong> 运行busybox镜像，并进入容器(本地无此镜像时，会自动pull)。<strong>BusyBox 是一个集成了三百多个最常用Linux命令和工具的软件</strong></li><li><code>docker run -dt -p 8080:80 nginx</code> <strong>后台运行nginx镜像</strong>(包含创建一个容器)</li></ul></li><li>提交镜像<ul><li><code>docker commit -m &#39;commit message&#39; -a &#39;author info&#39; c28687f7c6c8 my_repositor_name</code> 基于某容器ID创建镜像(对该容器进行了改动后的提交)</li><li><code>docker tag 7042885a156a 192.168.17.196:5000/nginx</code> 给某镜像打一个标签，此时不会生成一个新镜像(镜像ID还是原来的). <strong>192.168.17.196:5000/nginx 很重要，之后可以推送到私有仓库192.168.17.196:5000(ip地址一定要一样)，推送上去的镜像为nginx:latest</strong></li></ul></li><li>构建镜像<ul><li><code>docker build --rm -f /path/to/a/Dockerfile .</code> 从Dockerfile构建镜像</li></ul></li><li>删除镜像<ul><li><code>docker image rm c28687f7c6c8</code> 删除镜像(-f 强制删除)</li><li><code>docker rmi $(docker images -f &quot;dangling=true&quot; -q)</code> <strong>清除坏的<code>&lt;none&gt;:&lt;none&gt;</code>镜像</strong><ul><li><code>docker images -a|grep none|awk &#39;{print $3 }&#39;|xargs docker rmi</code></li></ul></li></ul></li></ul><h3 id="容器"><a href="#容器" class="headerlink" title="容器"></a>容器</h3><ul><li><code>docker run -it image_id_c28687f7c6c8 /bin/echo &#39;hello world&#39;</code> 创建并启动容器(如果没有则会从远程仓库下载)</li><li><code>docker create -it c28687f7c6c8</code> 基于镜像创建容器，但不启动</li><li><code>docker start a8f590736b62</code> <strong>启动容器</strong> (不会进入容器，启动后回到shell)</li><li><code>docker stop a8f590736b62</code> 停止容器</li><li><code>docker update --restart=always a8f590736b62</code> 更新运行中的容器配置(包括还可以更新CPU/MEM分配等，此处更新其重启类型restart为always)<ul><li>启动后的容器需要添加新端口可以走端口映射，或者先提交成镜像然后再运行一个容器</li></ul></li><li><code>docker ps</code> 列出运行的容器<ul><li><code>docker ps -a</code> 列举所有容器</li></ul></li><li><code>docker exec -it &lt;container_id | container_name&gt; bash</code> <strong>运行容器中的命令，此时会进入容器shell</strong>；此时容器必须处于启动状态；<code>exit</code>可退出容器命令行(并不会关闭容器)<ul><li><code>docker exec -dt &lt;container_id | container_name&gt; ls</code> 运行容器中的命令，但是不会进入容器</li><li><code>docker exec -it &lt;container_id | container_name&gt; /bin/bash -c &#39;ls&#39;</code> 也不会进入容器</li></ul></li><li><code>docker attach &lt;container_id | container_name&gt;</code> 进入某运行的容器 <strong>(组合建ctrl+p+q退出)</strong>，部分容器无法使用ctrl+p+q退出</li><li><p><code>docker inspect a8f590736b62</code> 查看容器详细(存储、网络等)。详细<code>--format</code>语法如下(Go模板语法) <a href="https://yq.aliyun.com/articles/230067" title="Docker --format 格式化输出概要操作说明" target="_blank" rel="noopener">^8</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 查看nginx绑定的端口</span></span><br><span class="line"><span class="comment"># &#123;&#123;println&#125;&#125;为打印换行</span></span><br><span class="line"><span class="comment"># range相当于循环，需要和&#123;&#123;end&#125;&#125;配合</span></span><br><span class="line"><span class="comment"># $k,$v为自定义变量，用来接收.NetworkSettings.Ports的map</span></span><br><span class="line"><span class="comment"># (index $v 0)表示基于索引获取$v的属性为0的数值，如果是数组则是取$v[0]的值；也可用于map取键含特殊字符的值，如：(index $map "my.key.com.test")</span></span><br><span class="line">sudo docker inspect --format <span class="string">'&#123;&#123;/*注释：通过变量组合展示容器绑定端口列表*/&#125;&#125;已绑定端口列表：&#123;&#123;println&#125;&#125;&#123;&#123;range $k,$v := .NetworkSettings.Ports&#125;&#125;&#123;&#123;$k&#125;&#125; -&gt; &#123;&#123;(index $v 0).HostPort&#125;&#125;&#123;&#123;println&#125;&#125;&#123;&#123;end&#125;&#125;'</span> nginx</span><br><span class="line"><span class="comment"># 已绑定端口列表：</span></span><br><span class="line"><span class="comment"># 443/tcp -&gt; 443</span></span><br><span class="line"><span class="comment"># 4443/tcp -&gt; 4443</span></span><br><span class="line"><span class="comment"># 80/tcp -&gt; 2080</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 查看所有容器使用的网卡信息</span></span><br><span class="line">sudo docker inspect --format=<span class="string">'&#123;&#123;.Name&#125;&#125; =&gt; &#123;&#123;range $k,$v := .NetworkSettings.Networks&#125;&#125;&#123;&#123;$k&#125;&#125;-&gt;&#123;&#123;.IPAddress&#125;&#125;&#123;&#123;end&#125;&#125;'</span> $(sudo docker ps -aq)</span><br><span class="line"><span class="comment"># /nginx =&gt; harbor_harbor-&gt;172.18.0.8</span></span><br><span class="line"><span class="comment"># /jenkins =&gt; bridge-&gt;172.17.0.2</span></span><br></pre></td></tr></table></figure></li><li><p><code>docker rm a8f590736b62</code> 删除容器ID为a8f590736b62的容器</p></li><li><code>docker rename 原容器名 新容器名</code> 重命名容器名(运行也可重命名)</li></ul><h2 id="docker网络"><a href="#docker网络" class="headerlink" title="docker网络"></a>docker网络</h2><ul><li><p>网络类型：host、bridge(默认)、container、none. 使用如：<code>docker run --network=host busybox</code></p><ul><li><code>host</code> 和宿主主机使用相同的网络(包括端口，此时无需-p指定端口映射)</li><li><p><code>bridge</code> 桥接模式。中间通过<code>docker0</code>虚拟网卡(docker默认网卡)进行网络传输。此时与外网连通，需要开启ip转发</p><ul><li>从docker0子网中分配一个IP给容器使用，并设置docker0的IP地址为容器的默认网关。在主机上创建一对虚拟网卡veth pair设备，Docker将veth pair设备的一端放在新创建的容器中，并命名为eth0（容器的网卡），另一端放在主机中，以vethx这样类似的名字命名，并将这个网络设备加入到docker0网桥中。可以通过<code>brctl show</code>命令查看</li><li><p>需开启宿主机IP转发，此时宿主主机相当于一个NAT，容器的<code>eth0</code>通过docker规定的网络接口与<code>docker0</code>连接，<code>docker0</code>又处于宿主主机</p><ul><li><p>当容器向公网发起请求时 -&gt; 容器的<code>eth0</code> -&gt; <code>docker0</code> -&gt; (由于开启ip转发)宿主主机<code>eth0</code> -&gt; 此时原地址会改成宿主主机向公网发送IP包</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 临时开启转发(1是允许转发，0不允许转发)</span></span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/ip_forward</span><br><span class="line"><span class="comment">## 永久修改，加入配置</span></span><br><span class="line"><span class="comment"># net.ipv4.ip_forward=1</span></span><br><span class="line"><span class="comment"># net.ipv6.conf.all.forwarding=1</span></span><br><span class="line">sudo vi /etc/sysctl.conf</span><br><span class="line"><span class="comment"># 使文件生效</span></span><br><span class="line">sudo sysctl -p /etc/sysctl.conf</span><br></pre></td></tr></table></figure></li></ul></li><li><p>无法连接外网分析：<a href="/_posts/linux/network.md#TTL=1导致虚拟机/docker无法访问外网">http://blog.aezo.cn/2019/06/20/linux/network/</a></p></li></ul></li><li><code>container</code> 容器和另外一个容器共享Network namespace。 kubernetes中的pod就是多个容器共享一个Network namespace<ul><li><code>--network=container:web1</code> 指定 jointed 容器为 web1</li></ul></li><li><code>none</code> Docker容器拥有自己的Network Namespace，但是，并不为Docker容器进行任何网络配置。也就是说，这个Docker容器没有网卡、IP、路由等信息。需要我们自己为Docker容器添加网卡、配置IP等。这种网络模式下容器只有lo回环网络，没有其他网卡</li></ul></li><li>docker部署在本地虚拟机上<ul><li>此时docker的宿主主机为虚拟机，虚拟机和本地机器属于同一网络。然后在docker中启动一个容器，docker会自动在宿主主机上创建一个虚拟网络，用于桥接宿主主机和容器内部网络</li><li><strong>容器会继承docker宿主主机的网络</strong>，在容器内部是可以向外访问到宿主主机所在网络，如本地物理机</li><li>在本地物理机中默认是无法访问容器内网络，当开启端口映射8080:80时，可通过访问宿主主机的映射端口(8080)达到访问容器的内部端口(80)</li></ul></li><li>docker部署在内网的其他机器上，同上理。需要注意容器内部访问宿主主机内网其他机器时，需要该机器没有开启VPN，虚拟网卡(会产生多个ip)等</li><li>Docker操纵<code>iptables</code>规则以提供网络隔离(会定时重置iptables规则)。如果需要添加在Docker规则之前加载的规则，需将添加到<code>DOCKER-USER</code>(filter表)链中。也可通过参数关闭docker对iptables的操作</li></ul><h3 id="docker跨容器通信"><a href="#docker跨容器通信" class="headerlink" title="docker跨容器通信"></a>docker跨容器通信</h3><ul><li>host、bridge、container、none解决了单个 Docker Host 内容器通信的问题</li><li>跨(宿主机)容器通信解决方案<ul><li>可通过直接路由方式(NAT)</li><li>桥接方式(如pipework)完成跨容器通信(二层VLAN网络，大二层方式，只适合小于4096节点集群，且存在广播风暴问题)</li><li>docker 内置的 Overlay 和 macvlan 则解决了跨容器通信，第三方方案常用的包括 flannel、weave、calico</li></ul></li><li><p>Overlay网络</p><ul><li>Overlay网络是指在不改变现有网络基础设施的前提下，通过某种约定通信协议，把二层报文封装在IP报文之上的新的数据格式。这样不但能够充分利用成熟的IP路由协议进程数据分发，而且能够突破VLAN的4096数量限制，支持高达16M的用户，并在必要时可将广播流量转化为组播流量，避免广播数据泛滥</li><li><p>三种Overlay的实现标准，分别是：虚拟可扩展LAN(VxLAN)、采用通用路由封装的网络虚拟化(NVGRE)和无状态传输协议(SST)，其中以VxLAN的支持厂商最为雄厚，VxLan数据包格式</p><p> <img src="/data/images/linux/network-vxlan.png" alt="network-vxlan"></p></li></ul></li><li>为支持容器跨主机通信，Docker 提供了 overlay driver。Docerk overlay 网络需要一个 key-value 数据库用于保存网络状态信息，包括 Network、Endpoint、IP 等。Consul、Etcd 和 ZooKeeper 都是 Docker 支持的 key-vlaue 软件</li><li>Overlay方案实践(Host0: 192.168.6.10, Host1: 192.168.6.131, Host2: 192.168.6.132) <a href="https://tonybai.com/2016/02/15/understanding-docker-multi-host-networking/" target="_blank" rel="noopener">^11</a></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 准备 overlay 环境(Linux 3.10.0-957.el7.x86_64 可成功部署)</span></span><br><span class="line"><span class="comment"># Host0 部署 Consul 数据库容器(也可下载tar安装包进行安装，见下文；也可创建集群)。容器启动后，可以通过 http://192.168.6.10:8500 访问 Consul</span></span><br><span class="line">docker run -d -p 8500:8500 -h consul --name consul --restart=always progrium/consul -server -bootstrap</span><br><span class="line"><span class="comment"># 修改各个节点(Host1、Host2) docker daemon 的配置文件 /usr/lib/systemd/system/docker.service，在 ExecStart 最后添加下列配置</span></span><br><span class="line"><span class="comment"># -H 开启本地和远程监听；--cluster-store 指定 consul 的地址；--cluster-advertise 告知 consul 自己的连接地址，ens33为当前节点的ip地址对应的网卡，也可以直接填写ip地址</span></span><br><span class="line">-H unix:///var/run/docker.sock -H 0.0.0.0:6376 --cluster-store=consul://192.168.6.10:8500 --cluster-advertise=ens33:6376</span><br><span class="line"><span class="comment"># 重启docker(必须保证consul是正常运行的，因此Host0通过容器启动consul后则无法加入到跨主机通信中)。host1 和 host2 将自动注册到 Consul 数据库中(Key/Values - docker - nodes)</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br><span class="line"></span><br><span class="line"><span class="comment">## 创建 overlay 网络</span></span><br><span class="line"><span class="comment"># 在 Host1创建网络overlay网络。-d 网络驱动driver使用overlay</span></span><br><span class="line">docker network create -d overlay ov_net1 <span class="comment"># docker network create -d overlay --subnet 10.10.0.0/24 ov_net1 # 指定子网范围(默认为10.0.0.0/24)</span></span><br><span class="line"><span class="comment"># 查看 Host1 和 Host2 网络：此时发现两个节点都有网络 ov_net1，且其 SCOPE 为 global</span></span><br><span class="line"><span class="comment"># 因为创建 ov_net1 时 host1 将 overlay 网络信息存入了 consul，host2 从 consul 读取到了新网络的数据。之后 ov_net 的任何变化都会同步到 host1 和 host2</span></span><br><span class="line">docker network ls</span><br><span class="line"><span class="comment"># 查看详细信息：IPAM 是指 IP Address Management，docker 自动为 ov_net1 分配的 IP 空间为 10.0.0.0/24</span></span><br><span class="line">docker network inspect ov_net1</span><br><span class="line"></span><br><span class="line"><span class="comment">## 在 overlay 中运行容器</span></span><br><span class="line"><span class="comment"># 在 Host1 创建一个 busybox1</span></span><br><span class="line"><span class="comment"># **--name为hostname，此时使用overlay，相当于容器在一个局域网中，应该尽量保证hostname不重复**</span></span><br><span class="line">docker run -itd --name busybox1 --network ov_net1 busybox</span><br><span class="line"><span class="comment"># 查看busybox的网络配置：busybox1 有两个网络接口 eth0 和 eth1</span></span><br><span class="line"><span class="comment"># eth0 IP 为 10.0.0.2，连接的是 overlay 网络 ov_net1</span></span><br><span class="line"><span class="comment"># eth1 IP 为 172.18.0.2，容器的默认路由是走 eth1。其实，docker 会在宿主机上创建一个 bridge 网络"docker_gwbridge"，为所有连接到 overlay 网络的容器提供访问外网的能力</span></span><br><span class="line">docker <span class="built_in">exec</span> busybox1 ip a</span><br><span class="line"><span class="comment"># Host1 上查看网桥网络信息：docker_gwbridge 的 IP 地址范围是 172.18.0.0/16，当前连接的容器就是 busybox1（172.18.0.2）</span></span><br><span class="line">docker network inspect docker_gwbridge</span><br><span class="line"><span class="comment"># Host1 宿主机上查看：而且此网络的网关就是网桥 docker_gwbridge 的 IP 172.18.0.1；这样容器 busybox1 就可以通过 docker_gwbridge 访问外网</span></span><br><span class="line">ifconfig docker_gwbridge</span><br><span class="line"></span><br><span class="line"><span class="comment">## overlay 网络连通性</span></span><br><span class="line"><span class="comment"># Host2 中运行 busybox</span></span><br><span class="line">docker run -itd --name busybox2 --network ov_net1 busybox</span><br><span class="line"><span class="comment"># 互通测试：Host2上容器 ping Host1上容器</span></span><br><span class="line">docker <span class="built_in">exec</span> busybox2 ping -c 2 busybox1</span><br><span class="line"></span><br><span class="line"><span class="comment">## Overlay 网络默认隔离</span></span><br><span class="line"><span class="comment"># 不同overlay网络进行访问。此时busybox3位于Host1的ov_net2网络上</span></span><br><span class="line">docker network connect ov_net1 busybox3</span><br></pre></td></tr></table></figure><ul><li><p>原理说明</p><p> <img src="/data/images/devops/docker-overlay-1.png" alt="docker-overlay-1"></p><ul><li><p>network namespace</p><ul><li>docker 会为每个 overlay 网络创建一个独立的 network namespace(1-da3d1b5fcb)，其中包含一个 linux bridge br0设备。 veth pair 一端连接到容器中(即 容器eth0)，另一端连接到 namespace 的 br0 上(vethx)</li><li>br0 除了连接所有的 veth pair，还会连接一个 vxlan 设备，用于与其他 host 建立 vxlan tunnel，容器之间的数据就是通过这个 tunnel 通信的。vxlan是个特殊设备，收到包后，由vxlan设备创建时注册的设备处理程序对包进行处理，即进行VXLAN封包(这期间会查询consul中存储的net1信息)，将ICMP包整体作为UDP包的payload封装起来，并将UDP包通过宿主机的eth0发送出去</li><li><p>查看 overlay 网络的 namespace(测试为1-e5c4953846)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 查看 overlay 网络的 namespace</span><br><span class="line">ln -s /var/run/docker/netns /var/run/netns</span><br><span class="line"># 如显示的`1-e5c4953846`标识会在 `docker network ls` 找到类似的NETWORK ID(开头一致，可能最后几个字母没有显示)</span><br><span class="line">ip netns</span><br><span class="line"># 查看此命名空间网络接口，包含有：lo、br0、vxlan1、veth2@if455(veth2)</span><br><span class="line">    # vxlan1 为 overlay network的一个 VTEP，即VXLAN Tunnel End Point – VXLAN隧道端点。VXLAN的相关处理都在VTEP上进行，例如识别以太网数据帧所属的VXLAN、基于 VXLAN对数据帧进行二层转发、封装/解封装报文等</span><br><span class="line">    # 同一个overlay网络中，每个docker对应一个vethx(`docker exec -it centos1 ethtool -S eth0` 显示的网卡序号和此时查询到的vethx的序号会相互对应)</span><br><span class="line"># ip netns exec 1-e5c4953846 xxx 相当于基于此 network namespace 运行相关网络命令。也可进行抓包：ip netns exec 1-e5c4953846 tcpdump -i veth2 -n icmp</span><br><span class="line">ip netns exec 1-e5c4953846 ip a</span><br><span class="line"># 查看此命名空间网桥接口</span><br><span class="line">ip netns exec 1-e5c4953846 brctl show</span><br></pre></td></tr></table></figure></li></ul></li><li><p>数据流向</p><ul><li>同一个Overlay网络(net1)不同宿主机(蓝色为宿主机，白色虚框为容器)<ul><li>数据包从容器eth0发出</li><li>经过vxlan1时进行VxLAN封包处理(这期间会查询consul中存储的overlay信息)，将ICMP包(ping)整体作为UDP包的payload封装起来，并将UDP包通过宿主机的eth0发送出去</li><li>宿主机收到UDP包后，发现是VXLAN包，根据VXLAN包中的相关信息(比如Vxlan Network Identifier，VNI=256)找到vxlan设备，并转给该vxlan设备处理</li><li>vxlan设备的处理程序进行解包，并将UDP中的payload取出，整体通过br0转给vethx接口</li></ul></li><li>不同Overlay网络相同宿主机<ul><li>数据包从容器eth1发出，经过docker_gwbrige进行传输。普通网络默认是桥接在docker0网卡上，而所有Overlay网络则桥接在docker_gwbrige网卡上进行通讯</li></ul></li></ul></li></ul></li><li><p>手动安装<a href="https://www.consul.io/" target="_blank" rel="noopener">Consul</a></p><ul><li>Consul是一个分布式高可用的系统，可用于服务发现、Key/Value存储等</li></ul></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">wget https://releases.hashicorp.com/consul/1.5.2/consul_1.5.2_linux_amd64.zip</span><br><span class="line"><span class="comment"># 只有一个consul二进制文件</span></span><br><span class="line">unzip consul_1.5.2_linux_amd64.zip</span><br><span class="line">sudo mv consul /bin</span><br><span class="line"><span class="comment"># 启动server(无ui界面，需要单独下载consul_ui文件，然后使用参数指定界面路径)</span></span><br><span class="line">nohup sudo consul agent -server -bootstrap -data-dir /home/data/consul -<span class="built_in">bind</span>=192.168.6.10 -client 0.0.0.0 &gt; ./nohup.out 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment">## HA(可以启动一个server和多个agent，然后让agent节点join到consul集群中)</span></span><br><span class="line"><span class="comment"># 在另一台机器上启动agent进行HA部署</span></span><br><span class="line">nohup sudo consul agent -data-dir /home/data/consul -<span class="built_in">bind</span>=192.168.6.11 &gt; ./nohup.out 2&gt;&amp;1 &amp;</span><br><span class="line"><span class="comment"># 如果脚本运行，则需要先启动客户端后暂停几秒再执行join命令</span></span><br><span class="line">consul join 192.168.6.10</span><br><span class="line"></span><br><span class="line"><span class="comment">## 其他命令</span></span><br><span class="line"><span class="comment"># 查看个节点状态</span></span><br><span class="line">consul members</span><br></pre></td></tr></table></figure><h2 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h2><ul><li>在大部分情况下，Dockerfile 会和构建所需的文件放在同一个目录中，为了提高构建的性能，应该使用 <code>.dockerignore</code> 来过滤掉不需要的文件和目录</li><li><p><code>docker build --rm -t my-nginx:latest -f /home/smalle/Dockerfile .</code> 从Dockerfile构建镜像 <a href="https://www.cnblogs.com/lienhua34/p/5170335.html" target="_blank" rel="noopener">^4</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This my first nginx Dockerfile</span></span><br><span class="line"><span class="comment"># Version 1.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># FROM 基础镜像</span></span><br><span class="line">FROM bzyep49h.mirror.aliyuncs.com/library/centos</span><br><span class="line"></span><br><span class="line"><span class="comment"># MAINTAINER 维护者信息</span></span><br><span class="line">MAINTAINER smalle</span><br><span class="line"></span><br><span class="line"><span class="comment"># ARG获取外部环境变量，也可以定义默认值，ARG可以在Dockerfile文件第一行接受外部参数</span></span><br><span class="line"><span class="comment"># docker build --build-arg SQ_DOCKER_REGISTRY=192.168.6.131:5000 --build-arg APP_VERSION=v1.1.1 .</span></span><br><span class="line">ARG APP_VERSION=v1.0.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># ENV 设置环境变量。可读取ARG参数内容</span></span><br><span class="line">ENV APP_VERSION=<span class="variable">$&#123;APP_VERSION&#125;</span></span><br><span class="line">ENV PATH /usr/<span class="built_in">local</span>/nginx/sbin:<span class="variable">$PATH</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ADD 从本地当前目录复制文件到容器. 文件放在当前目录下，拷过去会自动解压</span></span><br><span class="line"><span class="comment"># COPY 功能类似ADD，但是是不会自动解压文件，也不能访问网络资源</span></span><br><span class="line"><span class="comment"># 具体说明见下文</span></span><br><span class="line">ADD nginx-1.8.0.tar.gz /usr/<span class="built_in">local</span>/</span><br><span class="line">ADD epel-release-latest-7.noarch.rpm /usr/<span class="built_in">local</span>/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定运行容器时的用户名或 UID，后续的 RUN 也会使用指定用户。可在不同位置进行切换</span></span><br><span class="line">USER root</span><br><span class="line"><span class="comment"># USER user:group</span></span><br><span class="line"><span class="comment"># USER uid:gid</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># RUN 构建镜像时执行的命令。每运行一条RUN，容器会添加一层，并提交</span></span><br><span class="line">RUN rpm -ivh /usr/<span class="built_in">local</span>/epel-release-latest-7.noarch.rpm</span><br><span class="line">RUN yum install -y wget lftp gcc gcc-c++ make openssl-devel pcre-devel pcre &amp;&amp; yum clean all</span><br><span class="line">RUN useradd -s /sbin/nologin -M www</span><br><span class="line"></span><br><span class="line"><span class="comment"># WORKDIR 相当于cd</span></span><br><span class="line">WORKDIR /usr/<span class="built_in">local</span>/nginx-1.8.0 </span><br><span class="line"></span><br><span class="line">RUN ./configure --prefix=/usr/<span class="built_in">local</span>/nginx --user=www --group=www --with-http_ssl_module --with-pcre &amp;&amp; make &amp;&amp; make install</span><br><span class="line">RUN <span class="built_in">echo</span> <span class="string">"daemon off;"</span> &gt;&gt; /etc/nginx.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># EXPOSE 映射端口</span></span><br><span class="line">EXPOSE 80</span><br><span class="line"></span><br><span class="line"><span class="comment">## ENTRYPOINT和CMD</span></span><br><span class="line">    <span class="comment"># 共同点：都可以指定shell或exec函数调用的方式执行命令；当存在多个时，都是只有最后一个生效</span></span><br><span class="line">    <span class="comment"># 不同点：CMD指令指定的容器启动时命令可以被docker run指定的命令覆盖，而ENTRYPOINT指令指定的命令不能被覆盖，而是将docker run指定的参数当做ENTRYPOINT指定命令的参数；CMD指令可以为ENTRYPOINT指令设置默认参数，而且可以被docker run指定的参数覆盖</span></span><br><span class="line"><span class="comment"># ENTRYPOINT ["executable", "param1", "param2"] # 如果需要执行shell命令，可为：ENTRYPOINT ["sh", "-c", "echo $PATH"]</span></span><br><span class="line"><span class="comment"># ENTRYPOINT command param1 param2 # 执行shell命令</span></span><br><span class="line"><span class="comment"># CMD ["executable","param1","param2"] # 使用 exec 执行，推荐方式</span></span><br><span class="line"><span class="comment"># CMD command param1 param2 # 在 /bin/sh 中执行，提供给需要交互的应用</span></span><br><span class="line"><span class="comment"># CMD ["param1","param2"] # 提供给 ENTRYPOINT 的默认参数</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># CMD 构建容器后调用，也就是在容器启动时才进行调用</span></span><br><span class="line"><span class="comment"># CMD ["/bin/bash", "-c", "npm start &amp;&amp; node ./server/server.js"]</span></span><br><span class="line">CMD [<span class="string">"nginx"</span>]</span><br></pre></td></tr></table></figure></li></ul><h3 id="ADD-COPY"><a href="#ADD-COPY" class="headerlink" title="ADD/COPY"></a>ADD/COPY</h3><ul><li>语法：<code>ADD &lt;src&gt;… &lt;dest&gt;</code> 或者 <code>ADD [&quot;&lt;src&gt;&quot;,… &quot;&lt;dest&gt;&quot;]</code></li><li><p>每个<code>&lt;src&gt;</code>可以包含通配符并且使用Go的<code>filepath.Match</code>规则匹配</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ADD hom* /mydir/        <span class="comment"># adds all files starting with "hom"</span></span><br><span class="line">ADD hom?.txt /mydir/    <span class="comment"># ? is replaced with any single character, e.g., "home.txt"</span></span><br></pre></td></tr></table></figure></li><li><p>ADD遵守如下规则</p><ul><li><code>&lt;src&gt;</code>路径必须在构建上下文内。<strong>不能<code>ADD ../something /something</code>，因为docker build的第一步已经把上下文目录和子目录发送到docker daemon了</strong></li><li>如果<code>&lt;src&gt;</code>是一个目录，目录的所有内容都将复制，包括文件系统元数据，但是不包括目录本身</li><li><code>ADD http://example.com/foobar /test</code> 将创建文件 <code>/test/foobar</code></li><li>如果<code>&lt;src&gt;</code>是一个本地的可识别的tar压缩文件(如gzip、bzip2或xz)，那么将在容器内解压为目录。远程URL的压缩文件将不会解压</li><li>如果<code>&lt;src&gt;</code>是多个资源，不管是直接指定或使用通配符，那么<code>&lt;dest&gt;</code>必须是一个目录，并且要以斜杠/结尾</li><li>如果<code>&lt;dest&gt;</code>不以斜杠/结尾，将视其为一个普通文件，<code>&lt;src&gt;</code>的内容将写到这个文件</li><li>如果<code>&lt;dest&gt;</code>不存在，则会与其路径中的所有缺少的目录一起创建</li></ul></li><li>COPY 功能类似ADD，但是是不会自动解压文件，也不能访问网络资源</li></ul><h2 id="docker-compose-多容器控制-1"><a href="#docker-compose-多容器控制-1" class="headerlink" title="docker-compose 多容器控制 ^1"></a>docker-compose 多容器控制 <a href="https://www.cnblogs.com/neptunemoon/p/6512121.html" target="_blank" rel="noopener">^1</a></h2><ul><li><a href="https://docs.docker.com/compose/compose-file/" target="_blank" rel="noopener">docker-compose</a> 是用来做docker的多容器控制，默认基于<code>docker-compose.yml</code>来进行配置</li><li><code>pip install docker-compose</code> 安装(为python实现)，可能需要提前安装pip：<code>yum install python-pip</code></li><li><p>命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 非管理员运行docker-compose命令(sudo执行)，可能会提示ERROR: Couldn't connect to Docker daemon at http+docker://localhost - is it running?</span></span><br><span class="line">Usage:</span><br><span class="line">  docker-compose [-f &lt;arg&gt;...] [options] [COMMAND] [ARGS...]</span><br><span class="line">  docker-compose -h|--<span class="built_in">help</span></span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  -f, --file FILE             Specify an alternate compose file (default: docker-compose.yml)</span><br><span class="line">      <span class="comment"># eg: docker-compose -f my_docker-compose.yml up -d # 指定配置文件启动</span></span><br><span class="line">  -p, --project-name NAME     Specify an alternate project name (default: directory name)</span><br><span class="line">  --verbose                   Show more output</span><br><span class="line">  --no-ansi                   Do not <span class="built_in">print</span> ANSI control characters</span><br><span class="line">  -v, --version               Print version and <span class="built_in">exit</span></span><br><span class="line">  -H, --host HOST             Daemon socket to connect to</span><br><span class="line"></span><br><span class="line">  --tls                       Use TLS; implied by --tlsverify</span><br><span class="line">  --tlscacert CA_PATH         Trust certs signed only by this CA</span><br><span class="line">  --tlscert CLIENT_CERT_PATH  Path to TLS certificate file</span><br><span class="line">  --tlskey TLS_KEY_PATH       Path to TLS key file</span><br><span class="line">  --tlsverify                 Use TLS and verify the remote</span><br><span class="line">  --skip-hostname-check       Don<span class="string">'t check the daemon'</span>s hostname against the name specified</span><br><span class="line">                              <span class="keyword">in</span> the client certificate (<span class="keyword">for</span> example <span class="keyword">if</span> your docker host</span><br><span class="line">                              is an IP address)</span><br><span class="line">  --project-directory PATH    Specify an alternate working directory (default: the path of the Compose file)</span><br><span class="line"></span><br><span class="line">Commands:</span><br><span class="line">  build              Build or rebuild services</span><br><span class="line">  bundle             Generate a Docker bundle from the Compose file</span><br><span class="line">  config             Validate and view the Compose file <span class="comment"># 校验配置文件语法格式</span></span><br><span class="line">  create             Create services</span><br><span class="line">    <span class="comment"># 创建容器，之后执行start启动容器(docker-compose up -d则会自动创建和启动)</span></span><br><span class="line">  down               Stop and remove containers, networks, images, and volumes</span><br><span class="line">  events             Receive real time events from containers</span><br><span class="line">  <span class="built_in">exec</span>               Execute a <span class="built_in">command</span> <span class="keyword">in</span> a running container</span><br><span class="line">  <span class="built_in">help</span>               Get <span class="built_in">help</span> on a <span class="built_in">command</span></span><br><span class="line">  images             List images <span class="comment"># 查看使用的镜像信息</span></span><br><span class="line">  <span class="built_in">kill</span>               Kill containers</span><br><span class="line">  logs               View output from containers</span><br><span class="line">    <span class="comment"># 获取日志（docker-compose logs [my_service_name]）. **比docker logs的日志多一些，包含compose解析相关日志。只有容器重新创建日志才会清除**</span></span><br><span class="line">  pause              Pause services</span><br><span class="line">  port               Print the public port <span class="keyword">for</span> a port binding</span><br><span class="line">  ps                 List containers  <span class="comment"># 查看运行的容器</span></span><br><span class="line">  pull               Pull service images <span class="comment"># 不管registry有没有更新，都会重新拉取此compose中镜像，历史镜像标签将会变成&lt;none&gt;，下次up启动则是使用新镜像</span></span><br><span class="line">  push               Push service images</span><br><span class="line">  restart            Restart services  <span class="comment"># 重启服务。**不管compose配置文件是否修改，重启都不会重新创建容器**</span></span><br><span class="line">  rm                 Remove stopped containers <span class="comment"># 删除老旧的服务（docker-compose rm my_service_name）</span></span><br><span class="line">  run                Run a one-off <span class="built_in">command</span></span><br><span class="line">    <span class="comment"># docker-compose run my_service_name bash # 可进入到容器中，对于一些启动失败的可以通过此方式调试</span></span><br><span class="line">  scale              Set number of containers <span class="keyword">for</span> a service</span><br><span class="line">  start              Start services <span class="comment"># 启动服务(如docker-compose.yml有多个服务时，可以只运行其中一个，docker-compose start my_service_name)</span></span><br><span class="line">  stop               Stop services <span class="comment"># 停止服务，类似启动</span></span><br><span class="line">  top                Display the running processes</span><br><span class="line">  unpause            Unpause services</span><br><span class="line">  up                 Create and start containers</span><br><span class="line">      <span class="comment"># 创建并启动容器(在docker-compose.yml文件所在目录执行)。-d 表示后台运行。当前用户需要在docker组或者使用root用户启动(如sudo)</span></span><br><span class="line">      <span class="comment"># 多次执行up启动只会启动services中未运行的服务。如果修改了compose配置重新执行则会重新创建容器</span></span><br><span class="line">      <span class="comment"># 重新启动容器不会有产生多的镜像或容器</span></span><br><span class="line">      -d</span><br><span class="line">      <span class="comment"># docker-compose pull &amp;&amp; docker-compose up -d # 强制更新镜像并重启</span></span><br><span class="line">  version            Show the Docker-Compose version information</span><br></pre></td></tr></table></figure></li></ul><h3 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h3><ul><li><code>docker-compose.yml</code>示例</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3'</span> <span class="comment"># 表示使用第3代语法来构建</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="attr">  my_nginx:</span> <span class="comment"># 服务名（可当成hostname进行网络访问）</span></span><br><span class="line"><span class="attr">    container_name:</span> <span class="string">sq-nginx</span> <span class="comment"># 创建的容器名(默认是是`服务名_1`)。**可在其他compose文件中直接当hostname使用(并且对应的端口需要为容器中的端口)**</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">bitnami/nginx:latest</span> <span class="comment"># 镜像名(如果本地没有此镜像，会默认从中央仓库拉取镜像)</span></span><br><span class="line">    <span class="comment"># 网络类型使用host模式(即使用宿主主机的网络，此时不能配置ports信息，端口也全部使用的是主机的端口)</span></span><br><span class="line">    <span class="comment"># network_mode: host</span></span><br><span class="line"><span class="attr">    ports:</span> <span class="comment"># 端口映射(本地端口:容器端口的映射。windows的本地端口为运行docker的虚拟机端口。只是监听此端口，并不会占用此端口)</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">80</span><span class="string">:80</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">1443</span><span class="string">:443</span></span><br><span class="line"><span class="attr">    volumes:</span> <span class="comment"># 数据卷映射(本地路径:容器路径。windows的本地路径为运行docker的虚拟机路径。不要把 docker 当做数据容器来使用，数据一定要用 volumes 放在容器外面。如日志文件需要进行映射)</span></span><br><span class="line">      <span class="comment"># 官方nginx镜像为 /usr/share/nginx/html</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/home/smalle/data/nginx/:/bitnami/nginx/</span></span><br><span class="line">      <span class="comment"># 共享主机时区和时间</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/etc/timezone:/etc/timezone:ro</span> <span class="comment"># echo 'Asia/Shanghai' &gt; /etc/timezone</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/etc/localtime:/etc/localtime:ro</span></span><br><span class="line">	<span class="attr">environment:</span></span><br><span class="line">	  <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span> <span class="comment"># 设置容器时区。参考：https://www.jianshu.com/p/004ddf941aac</span></span><br><span class="line"><span class="attr">    restart:</span> <span class="string">always</span> <span class="comment"># 启动模式，always表示失败永远重启（包括宿主主机开机后自启动）</span></span><br><span class="line"><span class="attr">  sq-mysql:</span></span><br><span class="line"><span class="attr">    container_name:</span> <span class="string">sq-mysql</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">mysql/mysql-server:5.7</span> <span class="comment"># 如果本地没有此镜像，会默认从中央仓库拉取镜像</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">13307</span><span class="string">:3306</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line">      <span class="comment"># 用于保存数据文件。虚拟机中无此/home/smalle/data/test目录时，会自动创建</span></span><br><span class="line">	  <span class="bullet">-</span> <span class="string">/home/smalle/data/test:/var/lib/mysql</span></span><br><span class="line">    <span class="comment"># entrypoint会覆盖Dockerfile中的ENTRYPOINT(可为字符串或数组)，command会覆盖CMD(可为字符串或数组)。参考Dockerfile中的ENTRYPOINT和CMD比较。docker-compose restart也会执行此命令</span></span><br><span class="line">    <span class="comment"># entrypoint: ["/my-script.sh","/entrypoint.sh"] # 如果想在容器启动前执行命令，可覆盖此参数</span></span><br><span class="line">	<span class="attr">command:</span> </span><br><span class="line">	  <span class="bullet">--character-set-server=utf8mb4</span>            <span class="comment"># 设置数据库表的数据集</span></span><br><span class="line">	  <span class="bullet">--collation-server=utf8mb4_unicode_ci</span>     <span class="comment"># 设置数据库表的数据集</span></span><br><span class="line">	  <span class="bullet">--lower_case_table_names=1</span>				<span class="comment"># 表名不区分大小写</span></span><br><span class="line"><span class="bullet">      -</span><span class="bullet">-max_allowed_packet=1000M</span></span><br><span class="line">	  <span class="bullet">--default-time-zone=+8:00</span>                 <span class="comment"># 设置mysql数据库的时区，而不是设置容器的时区</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="attr">      TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="comment"># MYSQL_ROOT_HOST: '%'</span></span><br><span class="line">      <span class="comment"># MYSQL_ROOT_PASSWORD: root</span></span><br><span class="line"><span class="attr">      MYSQL_HOST:</span> <span class="string">localhost</span></span><br><span class="line">      <span class="comment"># 创建容器时会自动创建此数据库和用户</span></span><br><span class="line"><span class="attr">      MYSQL_DATABASE:</span> <span class="string">shengqi</span></span><br><span class="line"><span class="attr">      MYSQL_USER:</span> <span class="string">shengqi</span></span><br><span class="line">	  <span class="attr">MYSQL_PASSWORD:</span> <span class="string">shengqi</span></span><br><span class="line"><span class="attr">    restart:</span> <span class="string">always</span> <span class="comment"># 启动失败这重复启动（并且当docker虚拟机启动后，会自动启动此容器）</span></span><br><span class="line"><span class="attr">  wordpress:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">bitnami/wordpress:latest</span></span><br><span class="line"><span class="attr">    depends_on:</span> <span class="comment"># **依赖的服务名(compose文件中的services名)**。并不能控制等依赖启动完成才启动此服务</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">mariadb</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">my_nginx</span></span><br><span class="line">    <span class="comment"># links: # 依赖的镜像</span></span><br><span class="line"><span class="attr">    environment:</span> <span class="comment"># 当做环境变量传入容器（Dockerfile中无需定义/接收此环境变量）</span></span><br><span class="line"><span class="attr">      TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line"><span class="attr">      WORDPRESS_USERNAME:</span> <span class="string">smalle</span> <span class="comment"># 自定义属性</span></span><br><span class="line"><span class="attr">      WORDPRESS_PASSWORD:</span> <span class="string">aezocn</span></span><br><span class="line">      <span class="comment"># 或者使用列表</span></span><br><span class="line">      <span class="comment"># - WORDPRESS_USERNAME=smalle</span></span><br><span class="line">      <span class="comment"># - WORDPRESS_PASSWORD=aezocn</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">8080</span><span class="string">:80</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">8081</span><span class="string">:443</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/home/smalle/data/wordpress:/bitnami/wordpress</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/home/smalle/data/apache:/bitnami/apache</span></span><br><span class="line">	  <span class="bullet">-</span> <span class="string">/home/smalle/data/php:/bitnami/php</span></span><br><span class="line"><span class="attr">  my_app:</span></span><br><span class="line">    <span class="comment"># 基于Dockerfile文件构建镜像时使用的属性。可以基于某镜像进行扩展，如ENV,CMD,ENTRYPOINT都可以进行覆盖，不定义则使用FROM基础镜像</span></span><br><span class="line"><span class="attr">    build:</span></span><br><span class="line">      <span class="comment"># Dockerfile文件目录，此时为当前目录，也可以指定绝对路径[/path/test/Dockerfile]或相对路径[../test/Dockerfile]</span></span><br><span class="line"><span class="attr">      context:</span> <span class="string">.</span></span><br><span class="line">      <span class="comment"># 指定Dockerfile文件名，如果context指定了文件名，这里就不用本属性了。默认是`Dockerfile`</span></span><br><span class="line"><span class="attr">      dockerfile:</span> <span class="string">Dockerfile-swapping</span></span><br><span class="line">      <span class="comment">#env_file:</span></span><br><span class="line">      <span class="comment">#  - ./env # 如果是当前目录存在.env文件则默认可省略</span></span><br><span class="line">      <span class="comment"># environment:</span></span><br><span class="line">      <span class="comment">#   MYSQL_ROOT_PASSWORD_FILE: /run/secrets/db_root_password</span></span><br><span class="line">      <span class="comment"># secrets: # secrets 存储敏感数据，例如 mysql 服务密码</span></span><br><span class="line">      <span class="comment">#   - db_root_password</span></span><br><span class="line">      <span class="comment">#   - my_other_secret</span></span><br><span class="line">      <span class="comment"># 控制容器连接</span></span><br><span class="line"><span class="attr">      environment:</span></span><br><span class="line"><span class="attr">        TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line"><span class="attr">        MYSQL_HOST:</span> <span class="string">my_mysql</span> <span class="comment">#使用links进来的别名，或者可直接使用容器名(使用容器名时，该容器可以在另外一个compose文件中)</span></span><br><span class="line">        <span class="comment"># MYSQL_PORT: 3306 # 如果MYSQL_HOST使用了容器名/别名，则此处需要使用对应容器中的端口，而不是映射到宿主机的端口</span></span><br><span class="line"><span class="attr">      links:</span></span><br><span class="line">        <span class="comment"># 值可以是 `- 服务名`，也可以是`- "服务名:别名"`</span></span><br><span class="line"><span class="attr">        - sq-mysql:</span><span class="string">my_mysql</span></span><br></pre></td></tr></table></figure><ul><li><code>$VARIABLE</code>和<code>${VARIABLE}</code>两种写法都支持，<strong>可以使用双美元符号(<code>$$</code>)来转义美元符号</strong>。如果使用的是2.1文件格式，还可以在一行中设置默认的值：<ul><li><code>${VARIABLE:-default}</code> 当VARIABLE没有设置或为空值时使用default值</li><li><code>${VARIABLE-default}</code> 仅当VARIABLE没有设置时使用default值</li></ul></li><li><p>容器启动先后顺序问题 <a href="https://blog.csdn.net/wuzhong8809/article/details/82500722" target="_blank" rel="noopener">^7</a></p><ul><li><code>depends_on</code>表示再启动容器时会先启动依赖的服务，但并不能控制等依赖启动完成才启动此服务</li><li>基于<code>wait-for-it.sh</code>解决先后启动。<a href="https://raw.githubusercontent.com/vishnubob/wait-for-it/master/wait-for-it.sh" target="_blank" rel="noopener">脚本代码</a><ul><li>需要将<code>wait-for-it.sh</code>打包到容器中，即在Dockerfile中将文件从本地目录复制到容器目录，如/app目录</li><li>docker-compose.yml中基于command命令配置启动命令，command会覆盖Dockerfile文件中的默认启动命令(CMD)。如：<code>command: [&quot;/app/wait-for-it.sh&quot;, &quot;sq-eureka:9810&quot;, &quot;--&quot;, &quot;/app/runboot.sh&quot;]</code><h3 id="容器网络"><a href="#容器网络" class="headerlink" title="容器网络"></a>容器网络</h3></li></ul></li></ul></li><li><p>同一 docker-compose 配置文件中的多个容器默认处于统一网络，不同 docker-compose 配置文件处于不同网络</p></li><li>每个 docker-compose 配置文件会产生一个xxx_default的网络(查看网络：docker network ls)</li><li>如果 docker-compose 配置文件(假如所在目录为mydir)中只有一个服务则默认生成<code>mydir_服务名_default</code>，如果有多个服务则会生成一个<code>123456789_default</code>的网络</li><li>自定义网络、共用一个网络</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果此yml文件所在目录为mydir</span></span><br><span class="line"><span class="comment">## 示例1</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">'3'</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="attr">  test1:</span></span><br><span class="line"><span class="attr">    container_name:</span> <span class="string">sq_test1</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">sq-net</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line"><span class="attr">  sq-net:</span></span><br><span class="line">    <span class="comment"># 使用已存在的网络sq-net。系统不会自动创建网络，需要先手动创建网络：`docker network create sq-net`。这样多个 docker-compose 配置文件可以共用一个网络</span></span><br><span class="line"><span class="attr">    external:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 不使用已存在的网络。最终会生成一个mydir_sq-net的网络</span></span><br><span class="line">    <span class="comment"># external: false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 示例2</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">'3'</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="attr">  test1:</span></span><br><span class="line">	<span class="comment"># ... 无需定义networks，即使用默认(default)网络 -&gt; 使用自定义网络(sq-net)</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line"><span class="attr">  default:</span></span><br><span class="line">	  <span class="comment"># 默认使用已存在的网络，需要先创建此网络`docker network create sq-net`</span></span><br><span class="line">	  <span class="comment"># 如果加入了sq-net，则可以ping同sq-net所有的服务和容器名。如ping test1、ping sq_test1都是可以访问到的</span></span><br><span class="line"><span class="attr">    external:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">sq-net</span></span><br></pre></td></tr></table></figure><ul><li>volumes使用同networks</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3'</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="attr">  test1:</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line">      <span class="comment"># 基于容器卷映射</span></span><br><span class="line"><span class="attr">      - jenkins-data:</span><span class="string">/var/jenkins_home</span></span><br><span class="line">      <span class="comment"># 基于普通目录映射。映射主机的docker到容器里面，这样在容器里面就可以使用主机安装的 docker了(如可以在Jenkins容器里操作宿主机的其他容器)</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/var/run/docker.sock:/var/run/docker.sock</span></span><br><span class="line"><span class="attr">    user:</span> <span class="string">root</span> <span class="comment"># 定义启动用户</span></span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line"><span class="attr">  jenkins-data:</span></span><br><span class="line">    <span class="comment"># 需提前创建此容器卷，如果无external: true则会自动创建容器卷</span></span><br><span class="line"><span class="attr">    external:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h3 id="配置参数"><a href="#配置参数" class="headerlink" title="配置参数"></a>配置参数</h3><ul><li>Compose和Docker兼容性：Compose 文件格式有3个版本,分别为1, 2.x 和 3.x，目前主流的为 3.x 其支持 docker 1.13.0 及其以上的版本</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3'</span>           <span class="comment"># 指定 compose 文件的版本</span></span><br><span class="line"><span class="string">services</span>          <span class="comment"># 定义所有的 service 信息, services 下面的第一级别的 key 既是一个 service 的名称</span></span><br><span class="line">    <span class="string">build</span>                 <span class="comment"># 指定包含构建上下文的路径, 或作为一个对象，该对象具有 context 和指定的 dockerfile 文件以及 args 参数值</span></span><br><span class="line">        <span class="string">context</span>               <span class="comment"># context: 指定 Dockerfile 文件所在的路径</span></span><br><span class="line">        <span class="string">dockerfile</span>            <span class="comment"># dockerfile: 指定 context 指定的目录下面的 Dockerfile 的名称(默认为 Dockerfile)</span></span><br><span class="line">        <span class="string">args</span>                  <span class="comment"># args: Dockerfile 在 build 过程中需要的参数 (等同于 docker container build --build-arg 的作用)</span></span><br><span class="line">        <span class="string">cache_from</span>            <span class="comment"># v3.2中新增的参数, 指定缓存的镜像列表 (等同于 docker container build --cache_from 的作用)</span></span><br><span class="line">        <span class="string">labels</span>                <span class="comment"># v3.3中新增的参数, 设置镜像的元数据 (等同于 docker container build --labels 的作用)</span></span><br><span class="line">        <span class="string">shm_size</span>              <span class="comment"># v3.5中新增的参数, 设置容器 /dev/shm 分区的大小 (等同于 docker container build --shm-size 的作用)</span></span><br><span class="line">    <span class="string">command</span>               <span class="comment"># 覆盖容器启动后默认执行的命令, 支持 shell 格式和 [] 格式</span></span><br><span class="line">    <span class="string">configs</span>               <span class="comment"># 不知道怎么用</span></span><br><span class="line">    <span class="string">cgroup_parent</span>         <span class="comment"># 不知道怎么用</span></span><br><span class="line">    <span class="string">container_name</span>        <span class="comment"># 指定容器的名称 (等同于 docker run --name 的作用)</span></span><br><span class="line">    <span class="string">credential_spec</span>       <span class="comment"># 不知道怎么用</span></span><br><span class="line">    <span class="string">deploy</span>                <span class="comment"># v3 版本以上, 指定与部署和运行服务相关的配置, deploy 部分是 docker stack 使用的, docker stack 依赖 docker swarm</span></span><br><span class="line">        <span class="string">endpoint_mode</span>         <span class="comment"># v3.3 版本中新增的功能, 指定服务暴露的方式</span></span><br><span class="line">            <span class="string">vip</span>                   <span class="comment"># Docker 为该服务分配了一个虚拟 IP(VIP), 作为客户端的访问服务的地址</span></span><br><span class="line">            <span class="string">dnsrr</span>                 <span class="comment"># DNS轮询, Docker 为该服务设置 DNS 条目, 使得服务名称的 DNS 查询返回一个 IP 地址列表, 客户端直接访问其中的一个地址</span></span><br><span class="line">        <span class="string">labels</span>                <span class="comment"># 指定服务的标签，这些标签仅在服务上设置</span></span><br><span class="line">        <span class="string">mode</span>                  <span class="comment"># 指定 deploy 的模式</span></span><br><span class="line">            <span class="string">global</span>                <span class="comment"># 每个集群节点都只有一个容器</span></span><br><span class="line">            <span class="string">replicated</span>            <span class="comment"># 用户可以指定集群中容器的数量(默认)</span></span><br><span class="line">        <span class="string">placement</span>             <span class="comment"># 不知道怎么用</span></span><br><span class="line">        <span class="string">replicas</span>              <span class="comment"># deploy 的 mode 为 replicated 时, 指定容器副本的数量</span></span><br><span class="line">        <span class="string">resources</span>             <span class="comment"># 资源限制</span></span><br><span class="line">            <span class="string">limits</span>                <span class="comment"># 设置容器的资源限制</span></span><br><span class="line"><span class="attr">                cpus:</span> <span class="string">"0.5"</span>           <span class="comment"># 设置该容器最多只能使用 50% 的 CPU </span></span><br><span class="line"><span class="attr">                memory:</span> <span class="number">50</span><span class="string">M</span>           <span class="comment"># 设置该容器最多只能使用 50M 的内存空间 </span></span><br><span class="line">            <span class="string">reservations</span>          <span class="comment"># 设置为容器预留的系统资源(随时可用)</span></span><br><span class="line"><span class="attr">                cpus:</span> <span class="string">"0.2"</span>           <span class="comment"># 为该容器保留 20% 的 CPU</span></span><br><span class="line"><span class="attr">                memory:</span> <span class="number">20</span><span class="string">M</span>           <span class="comment"># 为该容器保留 20M 的内存空间</span></span><br><span class="line">        <span class="string">restart_policy</span>        <span class="comment"># 定义容器重启策略, 用于代替 restart 参数</span></span><br><span class="line">            <span class="string">condition</span>             <span class="comment"># 定义容器重启策略(接受三个参数)</span></span><br><span class="line">                <span class="string">none</span>                  <span class="comment"># 不尝试重启</span></span><br><span class="line">                <span class="string">on-failure</span>            <span class="comment"># 只有当容器内部应用程序出现问题才会重启</span></span><br><span class="line">                <span class="string">any</span>                   <span class="comment"># 无论如何都会尝试重启(默认)</span></span><br><span class="line">            <span class="string">delay</span>                 <span class="comment"># 尝试重启的间隔时间(默认为 0s)</span></span><br><span class="line">            <span class="string">max_attempts</span>          <span class="comment"># 尝试重启次数(默认一直尝试重启)</span></span><br><span class="line">            <span class="string">window</span>                <span class="comment"># 检查重启是否成功之前的等待时间(即如果容器启动了, 隔多少秒之后去检测容器是否正常, 默认 0s)</span></span><br><span class="line">        <span class="string">update_config</span>         <span class="comment"># 用于配置滚动更新配置</span></span><br><span class="line">            <span class="string">parallelism</span>           <span class="comment"># 一次性更新的容器数量</span></span><br><span class="line">            <span class="string">delay</span>                 <span class="comment"># 更新一组容器之间的间隔时间</span></span><br><span class="line">            <span class="string">failure_action</span>        <span class="comment"># 定义更新失败的策略</span></span><br><span class="line">                <span class="string">continue</span>              <span class="comment"># 继续更新</span></span><br><span class="line">                <span class="string">rollback</span>              <span class="comment"># 回滚更新</span></span><br><span class="line">                <span class="string">pause</span>                 <span class="comment"># 暂停更新(默认)</span></span><br><span class="line">            <span class="string">monitor</span>               <span class="comment"># 每次更新后的持续时间以监视更新是否失败(单位: ns|us|ms|s|m|h) (默认为0)</span></span><br><span class="line">            <span class="string">max_failure_ratio</span>     <span class="comment"># 回滚期间容忍的失败率(默认值为0)</span></span><br><span class="line">            <span class="string">order</span>                 <span class="comment"># v3.4 版本中新增的参数, 回滚期间的操作顺序</span></span><br><span class="line">                <span class="string">stop-first</span>            <span class="comment">#旧任务在启动新任务之前停止(默认)</span></span><br><span class="line">                <span class="string">start-first</span>           <span class="comment">#首先启动新任务, 并且正在运行的任务暂时重叠</span></span><br><span class="line">        <span class="string">rollback_config</span>       <span class="comment"># v3.7 版本中新增的参数, 用于定义在 update_config 更新失败的回滚策略</span></span><br><span class="line">            <span class="string">parallelism</span>           <span class="comment"># 一次回滚的容器数, 如果设置为0, 则所有容器同时回滚</span></span><br><span class="line">            <span class="string">delay</span>                 <span class="comment"># 每个组回滚之间的时间间隔(默认为0)</span></span><br><span class="line">            <span class="string">failure_action</span>        <span class="comment"># 定义回滚失败的策略</span></span><br><span class="line">                <span class="string">continue</span>              <span class="comment"># 继续回滚</span></span><br><span class="line">                <span class="string">pause</span>                 <span class="comment"># 暂停回滚</span></span><br><span class="line">            <span class="string">monitor</span>               <span class="comment"># 每次回滚任务后的持续时间以监视失败(单位: ns|us|ms|s|m|h) (默认为0)</span></span><br><span class="line">            <span class="string">max_failure_ratio</span>     <span class="comment"># 回滚期间容忍的失败率(默认值0)</span></span><br><span class="line">            <span class="string">order</span>                 <span class="comment"># 回滚期间的操作顺序</span></span><br><span class="line">                <span class="string">stop-first</span>            <span class="comment"># 旧任务在启动新任务之前停止(默认)</span></span><br><span class="line">                <span class="string">start-first</span>           <span class="comment"># 首先启动新任务, 并且正在运行的任务暂时重叠</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 注意：</span></span><br><span class="line">            <span class="comment"># 支持 docker-compose up 和 docker-compose run 但不支持 docker stack deploy 的子选项</span></span><br><span class="line">            <span class="comment"># security_opt  container_name  devices  tmpfs  stop_signal  links    cgroup_parent</span></span><br><span class="line">            <span class="comment"># network_mode  external_links  restart  build  userns_mode  sysctls</span></span><br><span class="line"></span><br><span class="line">    <span class="string">devices</span>               <span class="comment"># 指定设备映射列表 (等同于 docker run --device 的作用)</span></span><br><span class="line"></span><br><span class="line">    <span class="string">depends_on</span>            <span class="comment"># 定义容器启动顺序 (此选项解决了容器之间的依赖关系， 此选项在 v3 版本中 使用 swarm 部署时将忽略该选项)</span></span><br><span class="line">        <span class="comment"># docker-compose up 以依赖顺序启动服务，下面例子中 redis 和 db 服务在 web 启动前启动</span></span><br><span class="line">        <span class="comment"># 默认情况下使用 docker-compose up web 这样的方式启动 web 服务时，也会启动 redis 和 db 两个服务，因为在配置文件中定义了依赖关系</span></span><br><span class="line">    <span class="string">dns</span>                   <span class="comment"># 设置 DNS 地址(等同于 docker run --dns 的作用)</span></span><br><span class="line">    <span class="string">dns_search</span>            <span class="comment"># 设置 DNS 搜索域(等同于 docker run --dns-search 的作用)</span></span><br><span class="line">    <span class="string">tmpfs</span>                 <span class="comment"># v2 版本以上, 挂载目录到容器中, 作为容器的临时文件系统(等同于 docker run --tmpfs 的作用, 在使用 swarm 部署时将忽略该选项)</span></span><br><span class="line">    <span class="string">entrypoint</span>            <span class="comment"># 覆盖容器的默认 entrypoint 指令 (等同于 docker run --entrypoint 的作用)</span></span><br><span class="line">    <span class="string">env_file</span>              <span class="comment"># 从指定文件中读取变量设置为容器中的环境变量, 可以是单个值或者一个文件列表, 如果多个文件中的变量重名则后面的变量覆盖前面的变量, environment 的值覆盖 env_file 的值. 文件格式：RACK_ENV=development </span></span><br><span class="line">    <span class="string">environment</span>           <span class="comment"># 设置环境变量， environment 的值可以覆盖 env_file 的值 (等同于 docker run --env 的作用)</span></span><br><span class="line">    <span class="string">expose</span>                <span class="comment"># 暴露端口, 但是不能和宿主机建立映射关系, 类似于 Dockerfile 的 EXPOSE 指令</span></span><br><span class="line">    <span class="string">external_links</span>        <span class="comment"># 连接不在 docker-compose.yml 中定义的容器或者不在 compose 管理的容器(docker run 启动的容器, 在 v3 版本中使用 swarm 部署时将忽略该选项)</span></span><br><span class="line">    <span class="string">extra_hosts</span>           <span class="comment"># 添加 host 记录到容器中的 /etc/hosts 中 (等同于 docker run --add-host 的作用)</span></span><br><span class="line">    <span class="string">healthcheck</span>           <span class="comment"># v2.1 以上版本, 定义容器健康状态检查, 类似于 Dockerfile 的 HEALTHCHECK 指令</span></span><br><span class="line">        <span class="string">test</span>                  <span class="comment"># 检查容器检查状态的命令, 该选项必须是一个字符串或者列表, 第一项必须是 NONE, CMD 或 CMD-SHELL, 如果其是一个字符串则相当于 CMD-SHELL 加该字符串</span></span><br><span class="line">            <span class="comment"># NONE                  # 禁用容器的健康状态检测</span></span><br><span class="line">            <span class="comment"># CMD                   # test: ["CMD", "curl", "-f", "http://localhost"]</span></span><br><span class="line">            <span class="comment"># CMD-SHELL             # test: ["CMD-SHELL", "curl -f http://localhost || exit 1"] 或者　test: curl -f https://localhost || exit 1</span></span><br><span class="line"><span class="attr">        interval:</span> <span class="number">1</span><span class="string">m30s</span>       <span class="comment"># 每次检查之间的间隔时间</span></span><br><span class="line"><span class="attr">        timeout:</span> <span class="number">10</span><span class="string">s</span>          <span class="comment"># 运行命令的超时时间</span></span><br><span class="line"><span class="attr">        retries:</span> <span class="number">3</span>            <span class="comment"># 重试次数</span></span><br><span class="line"><span class="attr">        start_period:</span> <span class="number">40</span><span class="string">s</span>     <span class="comment"># v3.4 以上新增的选项, 定义容器启动时间间隔</span></span><br><span class="line"><span class="attr">        disable:</span> <span class="literal">true</span>         <span class="comment"># true 或 false, 表示是否禁用健康状态检测和　test: NONE 相同</span></span><br><span class="line"></span><br><span class="line">    <span class="string">image</span>                 <span class="comment"># 指定 docker 镜像, 可以是远程仓库镜像、本地镜像</span></span><br><span class="line">    <span class="string">init</span>                  <span class="comment"># v3.7 中新增的参数, true 或 false 表示是否在容器中运行一个 init, 它接收信号并传递给进程</span></span><br><span class="line">    <span class="string">isolation</span>             <span class="comment"># 隔离容器技术, 在 Linux 中仅支持 default 值</span></span><br><span class="line">    <span class="string">labels</span>                <span class="comment"># 使用 Docker 标签将元数据添加到容器, 与 Dockerfile 中的 LABELS 类似</span></span><br><span class="line">    <span class="string">links</span>                 <span class="comment"># 链接到其它服务中的容器, 该选项是 docker 历史遗留的选项, 目前已被用户自定义网络名称空间取代, 最终有可能被废弃 (在使用 swarm 部署时将忽略该选项)</span></span><br><span class="line">    <span class="string">logging</span>               <span class="comment"># 设置容器日志服务</span></span><br><span class="line">        <span class="string">driver</span>                <span class="comment"># 指定日志记录驱动程序, 默认 json-file (等同于 docker run --log-driver 的作用)</span></span><br><span class="line">        <span class="string">options</span>               <span class="comment"># 指定日志的相关参数 (等同于 docker run --log-opt 的作用)</span></span><br><span class="line">            <span class="string">max-size</span>              <span class="comment"># 设置单个日志文件的大小, 当到达这个值后会进行日志滚动操作</span></span><br><span class="line">            <span class="string">max-file</span>              <span class="comment"># 日志文件保留的数量</span></span><br><span class="line">    <span class="string">network_mode</span>          <span class="comment"># 指定网络模式 (等同于 docker run --net 的作用, 在使用 swarm 部署时将忽略该选项)         </span></span><br><span class="line">    <span class="string">networks</span>              <span class="comment"># 将容器加入指定网络 (等同于 docker network connect 的作用), networks 可以位于 compose 文件顶级键和 services 键的二级键</span></span><br><span class="line">        <span class="string">aliases</span>               <span class="comment"># 同一网络上的容器可以使用服务名称或别名连接到其中一个服务的容器</span></span><br><span class="line">        <span class="string">ipv4_address</span>      <span class="comment"># IP V4 格式</span></span><br><span class="line">        <span class="string">ipv6_address</span>      <span class="comment"># IP V6 格式</span></span><br><span class="line"><span class="attr">    pid:</span> <span class="string">'host'</span>           <span class="comment"># 共享宿主机的 进程空间(PID)</span></span><br><span class="line">    <span class="string">ports</span>                 <span class="comment"># 建立宿主机和容器之间的端口映射关系, ports 支持两种语法格式</span></span><br><span class="line">        <span class="comment"># SHORT 语法格式示例:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">"3000"</span>                            <span class="comment"># 暴露容器的 3000 端口, 宿主机的端口由 docker 随机映射一个没有被占用的端口</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">"3000-3005"</span>                       <span class="comment"># 暴露容器的 3000 到 3005 端口, 宿主机的端口由 docker 随机映射没有被占用的端口</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">"8000:8000"</span>                       <span class="comment"># 容器的 8000 端口和宿主机的 8000 端口建立映射关系</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">"9090-9091:8080-8081"</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">"127.0.0.1:8001:8001"</span>             <span class="comment"># 指定映射宿主机的指定地址的</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">"127.0.0.1:5000-5010:5000-5010"</span>   </span><br><span class="line"><span class="bullet">            -</span> <span class="string">"6060:6060/udp"</span>                   <span class="comment"># 指定协议</span></span><br><span class="line">        <span class="comment"># LONG 语法格式示例:(v3.2 新增的语法格式)</span></span><br><span class="line"><span class="attr">            - target:</span> <span class="number">80</span>                      <span class="comment"># 容器端口</span></span><br><span class="line"><span class="attr">                published:</span> <span class="number">8080</span>               <span class="comment"># 宿主机端口</span></span><br><span class="line"><span class="attr">                protocol:</span> <span class="string">tcp</span>                 <span class="comment"># 协议类型</span></span><br><span class="line"><span class="attr">                mode:</span> <span class="string">host</span>                    <span class="comment"># host 在每个节点上发布主机端口,  ingress 对于群模式端口进行负载均衡</span></span><br><span class="line">    <span class="string">secrets</span>               <span class="comment"># 不知道怎么用</span></span><br><span class="line">    <span class="string">security_opt</span>          <span class="comment"># 为每个容器覆盖默认的标签 (在使用 swarm 部署时将忽略该选项)</span></span><br><span class="line">    <span class="string">stop_grace_period</span>     <span class="comment"># 指定在发送了 SIGTERM 信号之后, 容器等待多少秒之后退出(默认 10s)</span></span><br><span class="line">    <span class="string">stop_signal</span>           <span class="comment"># 指定停止容器发送的信号 (默认为 SIGTERM 相当于 kill PID; SIGKILL 相当于 kill -9 PID; 在使用 swarm 部署时将忽略该选项)</span></span><br><span class="line">    <span class="string">sysctls</span>               <span class="comment"># 设置容器中的内核参数 (在使用 swarm 部署时将忽略该选项)</span></span><br><span class="line">    <span class="string">ulimits</span>               <span class="comment"># 设置容器的 limit</span></span><br><span class="line">    <span class="string">userns_mode</span>           <span class="comment"># 如果Docker守护程序配置了用户名称空间, 则禁用此服务的用户名称空间 (在使用 swarm 部署时将忽略该选项)</span></span><br><span class="line">    <span class="string">volumes</span>               <span class="comment"># 定义容器和宿主机的卷映射关系, 其和 networks 一样可以位于 services 键的二级键和 compose 顶级键, 如果需要跨服务间使用则在顶级键定义, 在 services 中引用</span></span><br><span class="line">        <span class="comment"># 语法格式示例:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">/var/lib/mysql</span>                <span class="comment"># 映射容器内的 /var/lib/mysql 到宿主机的一个随机目录中</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">/opt/data:/var/lib/mysql</span>      <span class="comment"># 映射容器内的 /var/lib/mysql 到宿主机的 /opt/data</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">./cache:/tmp/cache</span>            <span class="comment"># 映射容器内的 /var/lib/mysql 到宿主机 compose 文件所在的位置</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">~/configs:/etc/configs/:ro</span>    <span class="comment"># 映射容器宿主机的目录到容器中去, 权限只读</span></span><br><span class="line"><span class="attr">        - datavolume:</span><span class="string">/var/lib/mysql</span>     <span class="comment"># datavolume 为 volumes 顶级键定义的目录, 在此处直接调用</span></span><br><span class="line">    <span class="string">restart</span>               <span class="comment"># 定义容器重启策略(在使用 swarm 部署时将忽略该选项, 在 swarm 使用 restart_policy 代替 restart)</span></span><br><span class="line">        <span class="literal">no</span>                    <span class="comment"># 禁止自动重启容器(默认)</span></span><br><span class="line">        <span class="string">always</span>                <span class="comment"># 无论如何容器都会重启</span></span><br><span class="line">        <span class="string">on-failure</span>            <span class="comment"># 当出现 on-failure 报错时, 容器重新启动</span></span><br><span class="line">    <span class="comment"># 其他选项：</span></span><br><span class="line">        <span class="string">domainname,</span> <span class="string">hostname,</span> <span class="string">ipc,</span> <span class="string">mac_address,</span> <span class="string">privileged,</span> <span class="string">read_only,</span> <span class="string">shm_size,</span> <span class="string">stdin_open,</span> <span class="string">tty,</span> <span class="string">user,</span> <span class="string">working_dir</span></span><br><span class="line">        <span class="string">上面这些选项都只接受单个值和</span> <span class="string">docker</span> <span class="string">run</span> <span class="string">的对应参数类似</span></span><br><span class="line">    <span class="comment"># 对于值为时间的可接受的值：</span></span><br><span class="line">        <span class="number">2.5</span><span class="string">s</span></span><br><span class="line">        <span class="number">10</span><span class="string">s</span></span><br><span class="line">        <span class="number">1</span><span class="string">m30s</span></span><br><span class="line">        <span class="number">2</span><span class="string">h32m</span></span><br><span class="line">        <span class="number">5</span><span class="string">h34m56s</span></span><br><span class="line">        <span class="string">时间单位:</span> <span class="string">us,</span> <span class="string">ms,</span> <span class="string">s,</span> <span class="string">m，</span> <span class="string">h</span></span><br><span class="line">    <span class="comment"># 对于值为大小的可接受的值：</span></span><br><span class="line">        <span class="number">2</span><span class="string">b</span></span><br><span class="line">        <span class="number">1024</span><span class="string">kb</span></span><br><span class="line">        <span class="number">2048</span><span class="string">k</span></span><br><span class="line">        <span class="number">300</span><span class="string">m</span></span><br><span class="line">        <span class="number">1</span><span class="string">gb</span></span><br><span class="line">        <span class="string">单位:</span> <span class="string">b,</span> <span class="string">k,</span> <span class="string">m,</span> <span class="string">g</span> <span class="string">或者</span> <span class="string">kb,</span> <span class="string">mb,</span> <span class="string">gb</span></span><br><span class="line"><span class="string">networks</span>          <span class="comment"># 定义 networks 信息</span></span><br><span class="line">    <span class="string">driver</span>                <span class="comment"># 指定网络模式, 大多数情况下, 它 bridge 于单个主机和 overlay Swarm 上</span></span><br><span class="line">        <span class="string">bridge</span>                <span class="comment"># Docker 默认使用 bridge 连接单个主机上的网络</span></span><br><span class="line">        <span class="string">overlay</span>               <span class="comment"># overlay 驱动程序创建一个跨多个节点命名的网络</span></span><br><span class="line">        <span class="string">host</span>                  <span class="comment"># 共享主机网络名称空间(等同于 docker run --net=host)</span></span><br><span class="line">        <span class="string">none</span>                  <span class="comment"># 等同于 docker run --net=none</span></span><br><span class="line">    <span class="string">driver_opts</span>           <span class="comment"># v3.2以上版本, 传递给驱动程序的参数, 这些参数取决于驱动程序</span></span><br><span class="line">    <span class="string">attachable</span>            <span class="comment"># driver 为 overlay 时使用, 如果设置为 true 则除了服务之外，独立容器也可以附加到该网络; 如果独立容器连接到该网络，则它可以与其他 Docker 守护进程连接到的该网络的服务和独立容器进行通信</span></span><br><span class="line">    <span class="string">ipam</span>                  <span class="comment"># 自定义 IPAM 配置. 这是一个具有多个属性的对象, 每个属性都是可选的</span></span><br><span class="line">        <span class="string">driver</span>                <span class="comment"># IPAM 驱动程序, bridge 或者 default</span></span><br><span class="line">        <span class="string">config</span>                <span class="comment"># 配置项</span></span><br><span class="line">            <span class="string">subnet</span>                <span class="comment"># CIDR格式的子网，表示该网络的网段</span></span><br><span class="line">    <span class="string">external</span>              <span class="comment"># 外部网络, 如果设置为 true 则 docker-compose up 不会尝试创建它, 如果它不存在则引发错误</span></span><br><span class="line">    <span class="string">name</span>                  <span class="comment"># v3.5 以上版本, 为此网络设置名称</span></span><br></pre></td></tr></table></figure><h2 id="常用docker镜像"><a href="#常用docker镜像" class="headerlink" title="常用docker镜像"></a>常用docker镜像</h2><h3 id="docker-hub"><a href="#docker-hub" class="headerlink" title="docker hub"></a>docker hub</h3><blockquote><p><a href="https://hub.docker.com" target="_blank" rel="noopener">https://hub.docker.com</a></p></blockquote><ul><li><code>centos</code><ul><li><code>docker run -itd --name centos centos:7</code> 官方提供的centos镜像，无netstat、sshd等服务，测试可进行安装</li><li>安装netstat：<code>yum install net-tools</code></li><li>安装sshd：<code>yum install openssh-server</code>，启动如下：<ul><li><code>mkdir -p /var/run/sshd</code></li><li><code>/usr/sbin/sshd -D &amp;</code></li></ul></li></ul></li><li><code>ubuntu</code><ul><li><code>docker run -itd --name ubuntu ubuntu:14.04</code></li></ul></li><li><code>java:8-jre</code> 一般是docker-compose中引入</li><li><code>python:3.6</code></li><li><code>busybox</code></li><li><code>maven:3.6.0-jdk-8-alpine</code></li><li><code>docker:18.06.2-dind</code></li></ul><h3 id="自行编译jdk"><a href="#自行编译jdk" class="headerlink" title="自行编译jdk"></a>自行编译jdk</h3><ul><li>如ofbiz等项目容器化，需要在容器中编译运行，自行编译jdk作为基础容器</li><li>在文件夹test下创建文件<code>Dockerfile</code>，并将<code>jdk-7u80-linux-x64.tar.gz</code>复制进去</li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> bzyep49h.mirror.aliyuncs.com/library/centos:<span class="number">7</span></span><br><span class="line"><span class="keyword">MAINTAINER</span> smalle</span><br><span class="line"><span class="comment"># ADD https://github.com/frekele/oracle-java/releases/download/7u80-b15/jdk-7u80-linux-x64.tar.gz /usr/local</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> jdk-7u80-linux-x64.tar.gz /usr/<span class="built_in">local</span></span></span><br><span class="line"><span class="bash">ENV JAVA_HOME /usr/<span class="built_in">local</span>/jdk1.7.0_80</span></span><br><span class="line"><span class="bash">ENV JRE_HOME /usr/<span class="built_in">local</span>/jdk1.7.0_80/jre</span></span><br><span class="line"><span class="bash">ENV CLASSPATH .:<span class="variable">$JAVA_HOME</span>/lib:<span class="variable">$JRE_HOME</span>/lib:<span class="variable">$CLASSPATH</span></span></span><br><span class="line"><span class="bash">ENV PATH <span class="variable">$PATH</span>:<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$JRE_HOME</span>/bin</span></span><br></pre></td></tr></table></figure><ul><li>打包及推送</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 打包生成镜像(大概508M)</span></span><br><span class="line">docker build --rm -t jdk:1.7 -f ./Dockerfile .</span><br><span class="line"><span class="comment"># docker run ae4c031a5cb6 java -version # 本地运行镜像，查看java版本</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 推送</span></span><br><span class="line"><span class="comment"># 输入registry(harbor)账号密码登录。[https证书配置参考上文Harbor](#Harbor)</span></span><br><span class="line">docker login 192.168.17.196:10010</span><br><span class="line">docker tag ae4c031a5cb6 192.168.17.196:10010/library/jdk:1.7</span><br><span class="line">docker push 192.168.17.196:10010/library/jdk:1.7</span><br></pre></td></tr></table></figure><h3 id="nginx"><a href="#nginx" class="headerlink" title="nginx"></a>nginx</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3'</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="attr">  sq-nginx:</span></span><br><span class="line"><span class="attr">    container_name:</span> <span class="string">sq-nginx</span></span><br><span class="line"><span class="attr">    image:</span> <span class="attr">nginx:1.17.0</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">7000</span><span class="string">:80</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">7443</span><span class="string">:443</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line">      <span class="comment"># $PWD表示当前目录</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/home/smalle/html:/usr/share/nginx/html</span></span><br><span class="line">      <span class="comment"># 需要在当前目录创建conf.d目录。nginx.conf的http模块中引入了conf.d目录，只需要在此目录添加xxx.conf的配置文件对server进行配置即可（或覆盖http模块配置）</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./conf.d:/etc/nginx/conf.d</span></span><br><span class="line">      <span class="comment"># - ./nginx.conf:/etc/nginx/nginx.conf # 将主配置文件也放在宿主机中进行维护，需要向在宿主机中放入此配置文件才能启动容器</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./log:/var/log/nginx</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="attr">      TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line"><span class="attr">    restart:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line"><span class="attr">  default:</span></span><br><span class="line">    <span class="comment"># 默认使用已存在的网网络，需要先创建此网络`docker network create sq-net`</span></span><br><span class="line"><span class="attr">    external:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">sq-net</span></span><br></pre></td></tr></table></figure><ul><li>docker默认的nginx.conf配置为<a href="/data/src/arch/nginx.conf.docker">nginx.conf</a></li><li>宿主机上配置<code>$PWD/conf.d/test.conf</code></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80; <span class="comment"># 此处必须是容器中的端口</span></span><br><span class="line">    listen  [::]:80;</span><br><span class="line">    <span class="comment"># server_name  localhost;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># **启用后响应头中会包含`Content-Encoding: gzip`**</span></span><br><span class="line">    gzip on; <span class="comment">#开启gzip压缩输出</span></span><br><span class="line">    <span class="comment"># 压缩类型，默认就已经包含text/html(但是vue打包出来的js需要下列定义才会压缩)</span></span><br><span class="line">    gzip_types text/plain application/x-javascript application/javascript text/javascript text/css application/xml text/xml;</span><br><span class="line"></span><br><span class="line">    access_log /var/<span class="built_in">log</span>/nginx/test.access.log main;</span><br><span class="line"></span><br><span class="line">    location = /index.html &#123;</span><br><span class="line">        root   /usr/share/nginx/html;</span><br><span class="line">        add_header Cache-Control <span class="string">"no-cache, no-store"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ^~ /oa-dev-center/ &#123;</span><br><span class="line">		root /usr/share/nginx/html;</span><br><span class="line">		try_files <span class="variable">$uri</span> <span class="variable">$uri</span>/ /oa-dev-center/index.html;</span><br><span class="line">		<span class="keyword">if</span> (<span class="variable">$request_filename</span> ~* .*\.(?:htm|html)$) &#123;</span><br><span class="line">			add_header Cache-Control <span class="string">"private, no-store, no-cache, must-revalidate, proxy-revalidate"</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        <span class="comment"># $PWD/html/test 目录下添加一个index.html文件，即可通过 `宿主机IP:7000` 访问</span></span><br><span class="line">        root   /usr/share/nginx/html/<span class="built_in">test</span>; <span class="comment"># 此处必须是容器中的目录</span></span><br><span class="line">        <span class="comment"># 出现过再部分机器上运行docker无法访问index.html文件(报错：/etc/nginx/html/index.html" failed (2: No such file or directory))？但是可以访问index.htm等其他文件，可以考虑将打包主页文件生成为index.html</span></span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>更新配置说明<ul><li>如果仅更新配置文件需要执行nginx加载命令重新加载配置文件<ul><li><code>docker exec -it sq-nginx /usr/sbin/nginx -t</code></li><li><code>docker exec -it sq-nginx /usr/sbin/nginx -s reload</code>(未测试成功，但是进入到容器中重启可成功)</li></ul></li><li>如果修改了compose配置文件执行上述命令会重新创建容器(不会拉取新的镜像)</li></ul></li></ul><h3 id="mysql-mysql-server-5-7"><a href="#mysql-mysql-server-5-7" class="headerlink" title="mysql/mysql-server:5.7"></a>mysql/mysql-server:5.7</h3><ul><li>容器中默认数据文件路径：<code>/var/lib/mysql</code>(下面配置已进行修改)</li><li>下列配置产生的root用户为root@localhost，修改MYSQL_HOST/MYSQL_ROOT_HOST也无效。可进入容器后执行<code>mysql -hlocalhost -uroot -p</code>再进行修改</li><li>下列配置 <a href="https://blog.csdn.net/hjxzb/article/details/84927567" target="_blank" rel="noopener">^9</a><ul><li>需要先在docker-compose.yml所在目录创建好配置文件<code>my.cnf</code></li><li>如需执行初始化sql语句需先在docker-compose.yml所在目录创建好<code>init/init.sql</code></li><li>第一次初始化容器，会先启动mysql进行初始化，然后重新启动mysql。稍等片刻可通过<code>sudo docker logs sq-mysql</code>查看日志</li><li>第一次初始化容器完成后，可删掉容器重新初始化一次(无需清除mysql数据卷)，防止MYSQL_ROOT_PASSWORD等敏感信息显示在容器信息中</li></ul></li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker-compose.yml</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">'3'</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="attr">  sq-mysql:</span></span><br><span class="line"><span class="attr">    container_name:</span> <span class="string">sq-mysql</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">mysql/mysql-server:5.7</span> <span class="comment"># 如果本地没有此镜像，会默认从中央仓库拉取镜像</span></span><br><span class="line">	<span class="attr">ports:</span></span><br><span class="line">	  <span class="comment"># 映射宿主机端口13307，**但是和mysql处于相同网络中的容器配置的数据库端口仍然需要是3306**</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">13307</span><span class="string">:3306</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line">      <span class="comment"># 外部数据卷。docker宿主机中无此/home/data/mysql目录时，会自动创建</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/home/data/mysql:/var/lib/mysql</span></span><br><span class="line">      <span class="comment"># 外部配置文件</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./my.cnf:/etc/my.cnf</span></span><br><span class="line">      <span class="comment"># 外部初始化文件（文件名必须以.sh或者.sql结尾）</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./init:/docker-entrypoint-initdb.d/</span></span><br><span class="line">	<span class="attr">environment:</span></span><br><span class="line">	  <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="comment"># MYSQL_ROOT_PASSWORD: root # 不定义root密码则会自动生成密码，稍等片刻可查看生成密码：sudo docker logs sq-mysql</span></span><br><span class="line"><span class="attr">      MYSQL_HOST:</span> <span class="string">localhost</span></span><br><span class="line">      <span class="comment"># 创建容器时会自动创建此数据库和用户</span></span><br><span class="line"><span class="attr">      MYSQL_DATABASE:</span> <span class="string">shengqi</span></span><br><span class="line"><span class="attr">      MYSQL_USER:</span> <span class="string">shengqi</span></span><br><span class="line">	  <span class="attr">MYSQL_PASSWORD:</span> <span class="string">shengqi</span></span><br><span class="line"><span class="attr">    restart:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line"><span class="attr">  default:</span></span><br><span class="line">    <span class="comment"># 默认使用已存在的网网络，需要先创建此网络`docker network create sq-net`</span></span><br><span class="line"><span class="attr">    external:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">sq-net</span></span><br></pre></td></tr></table></figure><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /home/data/etc/mysql/my.cnf</span></span><br><span class="line"><span class="section">[client]</span></span><br><span class="line"><span class="attr">default-character-set</span>=utf8mb4</span><br><span class="line"></span><br><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="comment">## copy的docker镜像中的默认配置</span></span><br><span class="line"><span class="comment"># 防止连接缓慢问题</span></span><br><span class="line">skip-host-cache</span><br><span class="line">skip-name-resolve</span><br><span class="line"><span class="attr">datadir</span>=/var/lib/mysql</span><br><span class="line"><span class="attr">socket</span>=/var/lib/mysql/mysql.sock</span><br><span class="line"><span class="attr">secure-file-priv</span>=/var/lib/mysql-files</span><br><span class="line"><span class="comment"># 防止报错：[ERROR] Fatal error: Please read "Security" section of the manual to find out how to run mysqld as root!</span></span><br><span class="line"><span class="attr">user</span>=mysql</span><br><span class="line"><span class="comment"># Disabling symbolic-links is recommended to prevent assorted security risks</span></span><br><span class="line"><span class="attr">symbolic-links</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">log-error</span>=/var/log/mysqld.log</span><br><span class="line"><span class="attr">pid-file</span>=/var/run/mysqld/mysqld.pid</span><br><span class="line"></span><br><span class="line"><span class="comment">## 添加的额外配置</span></span><br><span class="line"><span class="comment"># 表名大小写：0是大小写敏感，1是大小写不敏感. linux默认是0，windows默认是1(建议设置成1)</span></span><br><span class="line"><span class="attr">lower_case_table_names</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">character-set-server</span>=utf8mb4</span><br><span class="line"><span class="attr">collation-server</span>=utf8mb4_bin</span><br><span class="line"><span class="attr">init-connect</span>=<span class="string">'SET NAMES utf8mb4'</span></span><br><span class="line"><span class="comment"># 防止导入数据时数据太大报错</span></span><br><span class="line"><span class="attr">max_allowed_packet</span>=<span class="number">1000</span>M</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- /home/data/etc/mysql/init/init.sql</span></span><br><span class="line"><span class="keyword">use</span> mysql;</span><br><span class="line"><span class="keyword">grant</span> all <span class="keyword">privileges</span> <span class="keyword">on</span> *.* <span class="keyword">to</span> <span class="string">'root'</span>@<span class="string">'%'</span> <span class="keyword">identified</span> <span class="keyword">by</span> <span class="string">'Hello1234!'</span> <span class="keyword">with</span> <span class="keyword">grant</span> <span class="keyword">option</span>;</span><br><span class="line"><span class="keyword">flush</span> <span class="keyword">privileges</span>;</span><br></pre></td></tr></table></figure><h3 id="tomcat"><a href="#tomcat" class="headerlink" title="tomcat"></a>tomcat</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker-compose.yml</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">'3'</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="attr">  sq-tomcat:</span></span><br><span class="line"><span class="attr">    container_name:</span> <span class="string">sq-tomcat</span></span><br><span class="line"><span class="attr">    image:</span> <span class="attr">tomcat:jdk8</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">8888</span><span class="string">:8080</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="attr">      TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">    <span class="comment"># command: /bin/sh -c "sed -i 's/&lt;Connector/&lt;Connector URIEncoding=\"UTF-8\"/' $$CATALINA_HOME/conf/server.xml &amp;&amp; $$CATALINA_HOME/bin/catalina.sh run"</span></span><br><span class="line"><span class="attr">    restart:</span> <span class="string">always</span></span><br></pre></td></tr></table></figure><ul><li>部署war <code>docker cp demo.war sq-tomcat:/usr/local/tomcat/webapps</code></li><li>重启容器 <code>docker restart sq-tomcat</code></li></ul><h3 id="ftp服务器"><a href="#ftp服务器" class="headerlink" title="ftp服务器"></a>ftp服务器</h3><ul><li><p><a href="https://hub.docker.com/r/stilliard/pure-ftpd" target="_blank" rel="noopener">stilliard/pure-ftpd</a> ftp服务器 <a href="https://blog.csdn.net/gc889900/article/details/80319050" target="_blank" rel="noopener">^6</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 安装启动</span></span><br><span class="line"><span class="comment"># 创建容器。默认数据端口30000-30009，只能满足5个用户同时FTP登陆。计算方式为"(最大端口号-最小端口号) / 2"。里修改为可以满足100个用户同时连接登陆</span></span><br><span class="line"><span class="comment"># /home/ftpusers为默认的用户数据目录；/etc/pure-ftpd为配置数据，包括用户登录信息(/etc/pure-ftpd/pureftpd.passwd)；增加环境变量`-e "ADDED_FLAGS ..."`表示生成日志(未测试成功)</span></span><br><span class="line">docker run -dt --name ftpd_server \</span><br><span class="line">    -p 21:21 -p 30000-30209:30000-30209 \</span><br><span class="line">    -v /home/data/docker/pure-ftpd/ftpusers:/home/ftpusers \</span><br><span class="line">    -v /home/data/docker/pure-ftpd/etc:/etc/pure-ftpd \</span><br><span class="line">    -e <span class="string">"ADDED_FLAGS=-d -d"</span> \</span><br><span class="line">    stilliard/pure-ftpd:hardened bash</span><br><span class="line"><span class="comment"># 进入容器(exec在运行的容器中执行一条命令)</span></span><br><span class="line">docker <span class="built_in">exec</span> -it ftpd_server bash</span><br><span class="line"><span class="comment"># 创建用户输入密码并保存（会自动创建用户目录test，用户默认可在此目录增删改文件或文件夹）。ftpd运行时，可以进入容器添加用户，无需再重新启动</span></span><br><span class="line">pure-pw useradd <span class="built_in">test</span> -u ftpuser -d /home/ftpusers/<span class="built_in">test</span></span><br><span class="line">pure-pw mkdb <span class="comment"># 可添加完所有用户一次性保存</span></span><br><span class="line"><span class="comment"># 在容器中运行FTP。`-c 100`为允许同时连接的客户端数列100, `-C 100`为同一IP最大的连接数100, 这两个数值与端口号30000:30209对应上</span></span><br><span class="line">/usr/sbin/pure-ftpd -c 100 -C 100 -l puredb:/etc/pure-ftpd/pureftpd.pdb -E -j -R -P <span class="variable">$PUBLICHOST</span> -p 30000:30209 &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment">## 管理相关</span></span><br><span class="line"><span class="comment"># 查看用户</span></span><br><span class="line">cat /etc/pure-ftpd/pureftpd.passwd</span><br><span class="line"><span class="comment"># 更改test户名密码(pure-pw需要在容器中运行)</span></span><br><span class="line">pure-pw passwd <span class="built_in">test</span></span><br><span class="line">pure-pw mkdb <span class="comment"># 保存</span></span><br><span class="line"><span class="comment"># 删除用户</span></span><br><span class="line">pure-pw userdel <span class="built_in">test</span> -f /etc/pure-ftpd/pureftpd.passwd</span><br><span class="line">pure-pw mkdb</span><br><span class="line"></span><br><span class="line"><span class="comment">## 添加用户sh脚本</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">USER=<span class="variable">$1</span></span><br><span class="line">docker <span class="built_in">exec</span> -dt ftpd_server pure-pw useradd <span class="variable">$USER</span> -u ftpuser -d /home/ftpusers/<span class="variable">$USER</span></span><br><span class="line">docker <span class="built_in">exec</span> -dt ftpd_server pure-pw mkdb</span><br></pre></td></tr></table></figure><ul><li>需要使用主动模式连接</li><li>常见问题<ul><li>在文件管理其中连接服务器是，提示<code>打开ftp服务器上的文件夹时发生错误，请检查是否有权限访问该文件夹</code>：IE浏览器 - Internet选项 - 高级 - 去勾选”使用被动 FTP”</li><li>xftp 提示无法显示远程文件夹：点击属性-&gt;选项-&gt;将使用被动模式选项去掉即可</li></ul></li></ul></li></ul><h2 id="安装私有仓库服务器-2"><a href="#安装私有仓库服务器-2" class="headerlink" title="安装私有仓库服务器 ^2"></a>安装私有仓库服务器 <a href="https://blog.csdn.net/boling_cavalry/article/details/78818462" title="docker私有仓库搭建与使用实战" target="_blank" rel="noopener">^2</a></h2><ul><li>Registry：docker仓库注册服务器，用于管理镜像仓库，起到的是服务器的作用</li><li>Repository：docker镜像仓库，用于存储具体的docker镜像，起到的是仓库存储作用</li></ul><h3 id="命令安装方式"><a href="#命令安装方式" class="headerlink" title="命令安装方式"></a>命令安装方式</h3><ul><li>docker-server(也可使用Harbor代替)</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 在docker-server上安装私有仓库</span></span><br><span class="line">docker run -d -p 5000:5000 -v /data/aezo:/var/lib/registry --restart=always --name registry-aezocn registry <span class="comment"># 初始化并启动私有仓库（会自动创建/data/aezo，且在此文件下创建docker目录）</span></span><br><span class="line"><span class="comment"># crul -X GET http://192.168.17.196:5000/v2/_catalog # 返回json格式数据(私有仓库镜像信息)表示启动成功</span></span><br><span class="line"><span class="comment"># http://192.168.17.196:5000/v2/nginx/tags/list 显示某镜像标签</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭私有仓库</span></span><br><span class="line">docker stop registry</span><br></pre></td></tr></table></figure><ul><li>docker-client</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 修改docker-client仓库地址</span></span><br><span class="line"><span class="comment"># docker pull registry.docker-cn.com/myname/myrepo:mytag # 执行命令时指定</span></span><br><span class="line"><span class="comment"># 永久修改仓库地址(修改后可能需要重启docker服务)</span></span><br><span class="line">vi /etc/docker/daemon.json <span class="comment"># 无则新增</span></span><br><span class="line"><span class="comment"># 并加入下列内容(docker客户端默认使用https访问仓库)</span></span><br><span class="line">&#123;<span class="string">"insecure-registries"</span>: [<span class="string">"192.168.17.196:5000"</span>]&#125; <span class="comment"># insecure-registries可使用http访问</span></span><br><span class="line"><span class="comment"># 重启docker-client</span></span><br><span class="line"><span class="comment">## 在docker-client保存镜像(基于镜像7042885a156a打tag)。如果是基于harbor则应该为harbor的主端口(站点访问端口)</span></span><br><span class="line"><span class="comment"># 192.168.17.196:5000/nginx 很重要，之后可以推送到私有仓库192.168.17.196:5000(ip地址一定要一样)，推送上去的镜像为nginx:sm_1</span></span><br><span class="line">docker tag 7042885a156a 192.168.17.196:5000/nginx:sm_1 </span><br><span class="line"><span class="comment">## 在docker-client上推送镜像到docker-server(推送成功后，在docker-server上通过docker images也是无法看到镜像的)</span></span><br><span class="line">docker push 192.168.17.196:5000/nginx</span><br><span class="line"><span class="comment"># 此时删除docker-client上关于nginx的镜像，再运行下列命令时，会检查本地没有则从私服上获取并运行</span></span><br><span class="line">docker run -itd -p 8080:80 192.168.17.196:5000/nginx:sm_1</span><br></pre></td></tr></table></figure><h3 id="Harbor"><a href="#Harbor" class="headerlink" title="Harbor"></a>Harbor</h3><ul><li><a href="https://goharbor.io/" target="_blank" rel="noopener">Harbor</a>、<a href="https://github.com/goharbor/harbor" target="_blank" rel="noopener">github</a></li><li>Harbor是基于GO开发的一个用于存储和分发Docker镜像的企业级Registry服务器(私有仓库)，提供web界面访问，角色控制。其提供镜像复制功能：镜像可以在多个Registry实例中复制（同步），尤其适合于负载均衡，高可用，混合云和多云的场景 <a href="https://www.cnblogs.com/pangguoping/p/7650014.html" title="搭建Harbor企业级docker仓库" target="_blank" rel="noopener">^3</a></li><li>安装(内部包含一个registry服务器的安装)。基于helm安装参考<a href="/_posts/devops/helm.md#Harbor">helm.md#Harbor</a></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 安装docker-compose</span></span><br><span class="line">yum install python-pip</span><br><span class="line">pip install docker-compose</span><br><span class="line">docker-compose --version</span><br><span class="line"></span><br><span class="line"><span class="comment">## 在线安装Harbor</span></span><br><span class="line"><span class="comment"># https://storage.googleapis.com/harbor-releases/release-1.8.0/harbor-online-installer-v1.8.0.tgz</span></span><br><span class="line">wget -P /opt/src/ https://github.com/vmware/harbor/releases/download/v1.2.0/harbor-online-installer-v1.2.0.tgz</span><br><span class="line"><span class="built_in">cd</span> /opt/src/</span><br><span class="line">tar zxf harbor-online-installer-v1.2.0.tgz -C /opt/</span><br><span class="line"><span class="built_in">cd</span> /opt/harbor/</span><br><span class="line"><span class="comment"># 修改配置文件。如修改harbor默认使用的数据存储位置/data目录</span></span><br><span class="line"><span class="comment"># 备份</span></span><br><span class="line">cp /opt/harbor/harbor.cfg /opt/harbor/harbor.cfg.bak</span><br><span class="line">cp /opt/harbor/docker-compose.yml /opt/harbor/docker-compose.yml.bak</span><br><span class="line"><span class="comment"># 修改存储位置(sed命令修改下列文件中所有的/data为/data/barbor)</span></span><br><span class="line">sed -i <span class="string">'s#/data#/data/harbor#g'</span> harbor.cfg</span><br><span class="line">sed -i <span class="string">'s#/data#/data/harbor#g'</span> docker-compose.yml</span><br><span class="line"><span class="comment"># 修改配置。最少修改其中的hostname(如hostname=192.168.17.196:10010)，也可修改admin账户密码(默认Harbor12345)</span></span><br><span class="line">vi /opt/harbor/harbor.cfg</span><br><span class="line"><span class="comment"># 修改了docker-compose.yml中80的映射端口为10010:80</span></span><br><span class="line">vi docker-compose.yml</span><br><span class="line">/opt/harbor/install.sh</span><br><span class="line"></span><br><span class="line"><span class="comment">## 启动</span></span><br><span class="line">docker-compose up -d <span class="comment"># 启动Harbor(/opt/harbor/)</span></span><br><span class="line">docker-compose ps <span class="comment"># 查看启动状态(需要都是UP)</span></span><br><span class="line">docker-compose stop <span class="comment"># 停止Harbor</span></span><br><span class="line"><span class="comment"># 访问(默认用户密码：admin/Harbor12345。第一次需要等一会再访问)。可修改docker-compose.yml中的映射端口来配置主页地址</span></span><br><span class="line"><span class="comment"># 此处修改了harbor.cfg中的hostname=192.168.17.196:10010</span></span><br><span class="line">http://192.168.17.196:10010/harbor/sign-in</span><br><span class="line"></span><br><span class="line"><span class="comment">## 将镜像7042885a156a推送数据到私有仓库（默认含有一个library公共项目，也可自行创建其他项目）</span></span><br><span class="line">docker tag 7042885a156a 192.168.17.196:10010/library/nginx:sm_1</span><br><span class="line"><span class="comment"># 登录(admin/Harbor12345)。登录成功后会保存秘钥到`~/.docker/config.json`，**下次则无需登录**</span></span><br><span class="line"><span class="comment"># 此处端口应该为10010。harbor内部默认也启动了一个registry，端口为5000，并通过nginx做了转发，因此对外端口只有10010。可参看上文修改/etc/docker/daemon.json的配置为：&#123;"insecure-registries": ["192.168.17.196:10010"]&#125;</span></span><br><span class="line"><span class="comment"># docker login 192.168.17.196:10010 -u $HARBOR_U -p $HARBOR_P</span></span><br><span class="line">docker login 192.168.17.196:10010</span><br><span class="line">docker push 192.168.17.196:10010/library/nginx:sm_1</span><br><span class="line"><span class="comment"># 如果是私有仓库pull也需要登录</span></span><br><span class="line">docker pull 192.168.17.196:10010/sq-eureka/sq-eureka:0.0.1-SNAPSHOT</span><br><span class="line"></span><br><span class="line"><span class="comment">## harbor为https时，也可配置TLS证书进行登录(docker命令的--tls的参数是docker客户端和服务器通信的加密配置，此处无法使用)</span></span><br><span class="line"><span class="comment"># 首先新建 `/etc/docker/certs.d/192.168.17.196:10010`目录</span></span><br><span class="line"><span class="comment"># 然后将ca.crt拷贝到该目录(如基于k8s运行的harbor v1.9.1，其ca.cert可在配置管理-系统设置中下载)</span></span><br><span class="line"><span class="comment"># 最后再docker login</span></span><br></pre></td></tr></table></figure><ul><li>harbor日志目录默认在<code>/var/log/harbor</code>，默认数据存储路径为<code>/data</code></li><li><code>harbor.cfg</code>修改后，需要执行<code>./prepare</code>(会在当前目录重新生成common文件夹。主要是配置信息，如nginx.conf，为docker-compose.yml中相关配置文件的映射)</li><li>常见问题<ul><li>registry服务一直处于<code>restarting</code>，且日志/var/log/harbor/xxx/registry.log报错<code>open /etc/registry/root.crt: no such file or directory</code>。主要是prepare源码有问题导致时没有生成文件/etc/registry/root.crt，具体参考<a href="https://www.cnblogs.com/breezey/p/9111894.html" target="_blank" rel="noopener">https://www.cnblogs.com/breezey/p/9111894.html</a></li></ul></li></ul><h2 id="Docker集群管理"><a href="#Docker集群管理" class="headerlink" title="Docker集群管理"></a>Docker集群管理</h2><ul><li>轻量级的开源 docker 管理工具有 <code>portainer</code>，重量级的有 <code>rancher</code>。如果服务不多，集群节点不多的话一般 portainer 足以胜任；如果是大型集群的话可以考虑 rancher</li></ul><h3 id="Docker远程TLS管理"><a href="#Docker远程TLS管理" class="headerlink" title="Docker远程TLS管理"></a>Docker远程TLS管理</h3><ul><li>docker进程<ul><li>docker 容器进程：就是运行在 docker 容器中的应用进程，比如你用 docker 启动的 web 应用，数据库等</li><li>docker 守护进程：docker 的设计是 C/S 模式，docker 守护进程运行在宿主机上，它默认监听<code>/var/run.docker.sock</code>(unix 域套接字)文件，本机的 docker 客户端是默认通过 /var/run.docker.sock 来与 docker 守护进程进行通信的</li></ul></li><li>直接开启远程访问，无安全措施<ul><li><code>dockerd -H 0.0.0.0</code> 监听所有tcp连接，默认端口是6375。在systemd下，则需要修改docker.service的ExecStart</li><li>在当前容器上可以执行另一容器的命令 <code>docker -H tcp://192.168.6.131:6375 ps</code></li></ul></li><li>安全的Docker访问(TLS)</li></ul><h2 id="启动SpringCloud应用"><a href="#启动SpringCloud应用" class="headerlink" title="启动SpringCloud应用"></a>启动SpringCloud应用</h2><ul><li><p>配置如下，需要启动的所有maven子项目都需要加下列配置 <a href="https://blog.csdn.net/aixiaoyang168/article/details/77453974" target="_blank" rel="noopener">^5</a></p><ul><li><p>依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">docker_plugin_version</span>&gt;</span>0.4.13<span class="tag">&lt;/<span class="name">docker_plugin_version</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 此路径为如Harbor站点路径 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">docker_registry</span>&gt;</span>192.168.17.196:10010<span class="tag">&lt;/<span class="name">docker_registry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">registry_project_name</span>&gt;</span>shengqi<span class="tag">&lt;/<span class="name">registry_project_name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--利用maven插件构建docker镜像--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.spotify<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>docker-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;docker_plugin_version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--设置在执行maven的package时构建镜像--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>build-image<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!--执行此插件的build指令，进行docker镜像构建--&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>build<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--私有仓库配置，默认使用localhost:2375--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">serverId</span>&gt;</span>my-docker-registry<span class="tag">&lt;/<span class="name">serverId</span>&gt;</span><span class="comment">&lt;!-- 对应maven/setting.xml中的server，用于登录私有服务器 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">registryUrl</span>&gt;</span>$&#123;docker_registry&#125;<span class="tag">&lt;/<span class="name">registryUrl</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--build完成后进行推送--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pushImage</span>&gt;</span>true<span class="tag">&lt;/<span class="name">pushImage</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 镜像名称。必须要先(在Harbor中)创建此项目且有对应项目的权限 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">imageName</span>&gt;</span>$&#123;docker_registry&#125;/$&#123;registry_project_name&#125;/$&#123;project.artifactId&#125;:$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">imageName</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">imageTags</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">imageTag</span>&gt;</span>latest<span class="tag">&lt;/<span class="name">imageTag</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">imageTag</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">imageTag</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">imageTags</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 基于Dockerfile进行编译镜像(Dockerfile放在对应/src/main/docker目录下，如果放在父项目根目录则无法编译成功) --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dockerDirectory</span>&gt;</span>$&#123;project.basedir&#125;/src/main/docker<span class="tag">&lt;/<span class="name">dockerDirectory</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">targetPath</span>&gt;</span>/<span class="tag">&lt;/<span class="name">targetPath</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">directory</span>&gt;</span>$&#123;project.build.directory&#125;<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">include</span>&gt;</span>$&#123;project.build.finalName&#125;.jar<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>使用私有仓库时，需要配置登录私有仓库信息。配置maven的setting.xml文件</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servers</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>my-docker-registry<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">username</span>&gt;</span>admin<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">password</span>&gt;</span>Harbor12345<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">email</span>&gt;</span>test@aezo.cn<span class="tag">&lt;/<span class="name">email</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servers</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>src/main/docker/runboot.sh</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line"></span><br><span class="line">sleep 15 <span class="comment"># 按照先后顺序进行适当睡眠</span></span><br><span class="line"><span class="comment"># 此处不能通过 nohup 命令执行。nohup执行完成后会退出命令，此时容器会自动关闭掉</span></span><br><span class="line">java -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/app/logs/jvmlogs/ -XX:+CrashOnOutOfMemoryError -Xmx512m -jar /app/app.jar</span><br></pre></td></tr></table></figure><ul><li>必须在src/main目录，如果在项目源码目录之外则基于Dockerfile的ADD等命令会出错(Dockerfile中ADD命令写相对路径，会出现找不到文件)</li><li><strong>sh等文件需要是linux格式，否则容易报类似错误：<code>: No such file or directory: bash</code></strong></li></ul></li><li><p>src/main/docker/Dockerfile</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">FROM java:8-jre</span><br><span class="line">MAINTAINER smalle &lt;oldinaction@qq.com&gt;</span><br><span class="line"><span class="comment"># 无app文件夹时，会自动创建</span></span><br><span class="line">ADD sq-eureka-0.0.1-SNAPSHOT.jar /app/app.jar</span><br><span class="line"><span class="comment"># ADD wait-for-it.sh /app/</span></span><br><span class="line">ADD runboot.sh /app/</span><br><span class="line"><span class="comment"># RUN chmod +x /app/wait-for-it.sh</span></span><br><span class="line">RUN chmod +x /app/runboot.sh</span><br><span class="line">CMD /app/runboot.sh</span><br><span class="line"><span class="comment"># EXPOSE 9800 # 基于docker-compose则不需要</span></span><br></pre></td></tr></table></figure></li></ul></li><li><p>执行maven的package命令(会触发镜像build指令)。</p><ul><li><strong>需要本地(打包镜像的机器)启动docker服务</strong>，否则报错：<code>Exception caught: Timeout: GET https://192.168.99.100:2376/version</code>(此地址为windows环境变量<code>DOCKER_HOST</code>配置的docker虚拟机地址)</li><li><strong>需要本地(打包镜像的机器)docker配置insecure-registries中加入registry路径</strong>，编辑文件<code>vi /etc/docker/daemon.json</code>。docker默认是基于https进行验证的，如果是http服务则需要配置此参数</li></ul></li><li><code>docker-compose.yml</code>镜像管理文件<ul><li>其中<code>EUREKA_HOST=sq-eureka</code>是因为服务运行在不同的容器中(尽管在一台docker虚拟机上)，此处不能使用localhost，必须使用服务名进行通信。(docker-compose.yml写入中文会报错)</li><li><code>${COMPOSE_PROJECT_NAME:-local/shengqi/}</code>表示取环境变量COMPOSE_PROJECT_NAME的值，无则使用默认值<code>local/shengqi/</code>(注意前面的<code>-</code>)，且默认值只适用于<code>version: &#39;3&#39;</code><ul><li>或者在<code>docker-compose.yml</code>文件所在目录创建<code>.env</code>文件，里面定义环境变量如<code>COMPOSE_PROJECT_NAME=192.168.17.196:10010/shengqi/</code>(.env文件适用于<code>version: &#39;2&#39;</code>设置默认值。命令行中的环境变量 &gt; .env文件中的环境变量 &gt; Dockerfile文件)</li><li>此时<code>COMPOSE_PROJECT_NAME</code>正好是docker-compose内置的环境变量，也可以通过<code>docker-compose up -p my_project_name</code>的方式传入COMPOSE_PROJECT_NAME值</li></ul></li></ul></li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3'</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="attr">  sq-eureka:</span></span><br><span class="line"><span class="attr">    container_name:</span> <span class="string">sq-eureka</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">local/shengqi/sq-eureka:0.0.1-SNAPSHOT</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">9800</span><span class="string">:9800</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line">      <span class="comment"># 测试发现如果数据保存在容器的/tmp/app/logs目录则日志映射失败</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./logs/sq-eureka:/app/logs</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="attr">      TZ:</span> <span class="string">Asia/Shanghai</span> <span class="comment"># 设置时区</span></span><br><span class="line"><span class="attr">      SPRING_PROFILES_ACTIVE:</span> <span class="string">test</span> <span class="comment"># springboot内置环境变量</span></span><br><span class="line"><span class="attr">      LOG_PATH:</span> <span class="string">/app/logs</span> <span class="comment"># logback.xml中定义的环境变量LOG_PATH</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  sq-config:</span></span><br><span class="line"><span class="attr">    container_name:</span> <span class="string">sq-config</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">$&#123;COMPOSE_PROJECT_NAME:-local/shengqi/&#125;sq-config:0.0.1-SNAPSHOT</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">9810</span><span class="string">:9810</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./logs/sq-config:/app/logs</span></span><br><span class="line"><span class="attr">    depends_on:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">sq-eureka</span></span><br><span class="line">    <span class="comment"># command会覆盖Dockerfile文件中的默认启动命令(CMD)</span></span><br><span class="line">    <span class="comment"># command: ["/app/wait-for-it.sh", "sq-eureka:9810", "--", "/app/runboot.sh"]</span></span><br><span class="line">    <span class="comment"># command: ["sleep", "1h"] # 调试容器启动</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="attr">      TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line"><span class="attr">      SPRING_PROFILES_ACTIVE:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">      EUREKA_HOST:</span> <span class="string">sq-eureka</span></span><br><span class="line"><span class="attr">      LOG_PATH:</span> <span class="string">/app/logs</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  sq-gateway:</span></span><br><span class="line"><span class="attr">    container_name:</span> <span class="string">sq-gateway</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">$&#123;COMPOSE_PROJECT_NAME:-local/shengqi/&#125;sq-gateway:0.0.1-SNAPSHOT</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">8000</span><span class="string">:8000</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./logs/sq-gateway:/app/logs</span></span><br><span class="line"><span class="attr">    depends_on:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">sq-config</span></span><br><span class="line">    <span class="comment"># command: ["/app/wait-for-it.sh", "sq-config:9810", "--", "/app/runboot.sh"]</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="attr">      TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line"><span class="attr">      SPRING_PROFILES_ACTIVE:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">      EUREKA_HOST:</span> <span class="string">sq-eureka</span></span><br><span class="line"><span class="attr">      LOG_PATH:</span> <span class="string">/app/logs</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  sq-auth:</span></span><br><span class="line"><span class="attr">    container_name:</span> <span class="string">sq-auth</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">$&#123;COMPOSE_PROJECT_NAME:-local/shengqi/&#125;sq-auth:0.0.1-SNAPSHOT</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./logs/sq-auth:/app/logs</span></span><br><span class="line"><span class="attr">    depends_on:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">sq-config</span></span><br><span class="line">    <span class="comment"># command: ["/app/wait-for-it.sh", "sq-config:9810", "--", "/app/runboot.sh"]</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="attr">      TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line"><span class="attr">      SPRING_PROFILES_ACTIVE:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">      EUREKA_HOST:</span> <span class="string">sq-eureka</span></span><br><span class="line"><span class="attr">      MYSQL_HOST:</span> <span class="string">sq-mysql</span></span><br><span class="line"><span class="attr">      MYSQL_DATABASE:</span> <span class="string">shengqi</span></span><br><span class="line"><span class="attr">      MYSQL_USER:</span> <span class="string">shengqi</span></span><br><span class="line"><span class="attr">      MYSQL_PASSWORD:</span> <span class="string">shengqi</span></span><br><span class="line"><span class="attr">      LOG_PATH:</span> <span class="string">/app/logs</span></span><br></pre></td></tr></table></figure><ul><li>启动：在<code>docker-compose.yml</code>目录下执行<code>docker-compose up -d</code></li><li>访问：<a href="http://docker-host:9800" target="_blank" rel="noopener">http://docker-host:9800</a></li></ul><hr><p>参考文章</p></div><div></div><div></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> smalle</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="http://blog.aezo.cn/2017/06/25/devops/docker/" title="Docker">http://blog.aezo.cn/2017/06/25/devops/docker/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/docker/" rel="tag"># docker</a> <a href="/tags/arch/" rel="tag"># arch</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2017/06/24/linux/vmware/" rel="next" title="vmware"><i class="fa fa-chevron-left"></i> vmware</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"> <a href="/2017/07/01/java/spring/" rel="prev" title="Spring">Spring<i class="fa fa-chevron-right"></i></a></div></div></footer></article><div class="post-spread"><div> <a target="_blank" href="https://github.com/oldinaction/ChatGPT-MP"><img class="nofancybox" style="width:300px;margin:0 auto" src="https://cdn7.aezo.cn/one/chat/chat-gpt-open-banner.jpg" alt="ChatGPT开源小程序" title="ChatGPT开源小程序"></a></div></div></div></div><div class="comments" id="comments"></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> 文章目录</li><li class="sidebar-nav-overview" data-target="site-overview"> 站点概览</li></ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="https://avatars0.githubusercontent.com/u/15698218?v=3&u=ce740bf0b67ff0d74990ba6fc644d6e92f572dcb&s=400" alt="smalle"><p class="site-author-name" itemprop="name">smalle</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">168</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/index.html"><span class="site-state-item-count">14</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/index.html"><span class="site-state-item-count">153</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"></div><div> 欢迎关注公众号：阿壹族 <img class="nofancybox" style="width:120px;margin:0 auto" src="https://cdn7.aezo.cn/common/qrcode/ayz_qrcode.jpg" alt="欢迎关注公众号：阿壹族" title="欢迎关注公众号：阿壹族"></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#镜像"><span class="nav-number">1.</span> <span class="nav-text">镜像</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Docker介绍"><span class="nav-number">2.</span> <span class="nav-text">Docker介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装"><span class="nav-number">3.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#命令"><span class="nav-number">4.</span> <span class="nav-text">命令</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#docker"><span class="nav-number">4.1.</span> <span class="nav-text">docker</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#镜像-1"><span class="nav-number">4.2.</span> <span class="nav-text">镜像</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#容器"><span class="nav-number">4.3.</span> <span class="nav-text">容器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#docker网络"><span class="nav-number">5.</span> <span class="nav-text">docker网络</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#docker跨容器通信"><span class="nav-number">5.1.</span> <span class="nav-text">docker跨容器通信</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Dockerfile"><span class="nav-number">6.</span> <span class="nav-text">Dockerfile</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ADD-COPY"><span class="nav-number">6.1.</span> <span class="nav-text">ADD/COPY</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#docker-compose-多容器控制-1"><span class="nav-number">7.</span> <span class="nav-text">docker-compose 多容器控制 ^1</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#案例"><span class="nav-number">7.1.</span> <span class="nav-text">案例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#容器网络"><span class="nav-number">7.2.</span> <span class="nav-text">容器网络</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置参数"><span class="nav-number">7.3.</span> <span class="nav-text">配置参数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#常用docker镜像"><span class="nav-number">8.</span> <span class="nav-text">常用docker镜像</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#docker-hub"><span class="nav-number">8.1.</span> <span class="nav-text">docker hub</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#自行编译jdk"><span class="nav-number">8.2.</span> <span class="nav-text">自行编译jdk</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nginx"><span class="nav-number">8.3.</span> <span class="nav-text">nginx</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mysql-mysql-server-5-7"><span class="nav-number">8.4.</span> <span class="nav-text">mysql/mysql-server:5.7</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tomcat"><span class="nav-number">8.5.</span> <span class="nav-text">tomcat</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ftp服务器"><span class="nav-number">8.6.</span> <span class="nav-text">ftp服务器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装私有仓库服务器-2"><span class="nav-number">9.</span> <span class="nav-text">安装私有仓库服务器 ^2</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#命令安装方式"><span class="nav-number">9.1.</span> <span class="nav-text">命令安装方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Harbor"><span class="nav-number">9.2.</span> <span class="nav-text">Harbor</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Docker集群管理"><span class="nav-number">10.</span> <span class="nav-text">Docker集群管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Docker远程TLS管理"><span class="nav-number">10.1.</span> <span class="nav-text">Docker远程TLS管理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#启动SpringCloud应用"><span class="nav-number">11.</span> <span class="nav-text">启动SpringCloud应用</span></a></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright"> &copy; 2016 - <span itemprop="copyrightYear">2025</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">smalle</span>&nbsp;&nbsp;&nbsp;&nbsp;<div class="powered-by"> 由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div><div class="powered-by"> 主题 - <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a></div><div class="theme-info"> <a class="theme-link" target="_blank" href="https://tongji.baidu.com/main/overview/10000542408/overview/index?siteId=18991897">站长统计</a></div></div><div class="ad"> <span style="font-weight:700">AD&nbsp;&nbsp;&nbsp;&nbsp;</span><div class="theme-info"> <a target="_blank" href="https://promotion.aliyun.com/ntms/yunparter/invite.html?userCode=oby5nolb">阿里云大礼包</a></div></div><div class="aezocn"> <span style="font-weight:700">&copy;AEZO.CN&nbsp;&nbsp;&nbsp;&nbsp;</span><div class="powered-by"> <a target="_blank" href="https://shengqitech.aezo.cn/">圣骑科技</a></div><div class="powered-by"> <a target="_blank" href="https://cdn7.aezo.cn/common/qrcode/one_qrcode.jpg">【One能抽屉】小程序</a></div><div class="theme-info"> <a target="_blank" href="http://shop.aezo.cn/">杂货铺(省钱小助手)</a></div></div><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?085f9cd91ef2ad985f791c677472f0d1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script><script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script type="text/javascript" src="/js/src/js.cookie.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/scroll-cookie.js?v=5.1.1"></script></body></html>