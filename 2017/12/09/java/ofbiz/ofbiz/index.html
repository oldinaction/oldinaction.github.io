<!doctype html><html class="theme-next mist use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css"><meta name="keywords" content="ofbiz,"><link rel="alternate" href="/atom.xml" title="Smalle's Blog | AEZOCN" type="application/atom+xml"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1"><meta name="description" content="简介安装编译启动安装下载 下载：http://ofbiz.apache.org （http://www.apache.org/dyn/closer.lua/ofbiz/apache-ofbiz-13.07.02.zip） 解压：apache-ofbiz-13.07.02.zip到D:\java\apache-ofbiz-13.07.02（路径可自己更改） 使用版本apache-ofbiz-13.0"><meta name="keywords" content="ofbiz"><meta property="og:type" content="article"><meta property="og:title" content="OFBiz"><meta property="og:url" content="http://blog.aezo.cn/2017/12/09/java/ofbiz/ofbiz/index.html"><meta property="og:site_name" content="Smalle&#39;s Blog | AEZOCN"><meta property="og:description" content="简介安装编译启动安装下载 下载：http://ofbiz.apache.org （http://www.apache.org/dyn/closer.lua/ofbiz/apache-ofbiz-13.07.02.zip） 解压：apache-ofbiz-13.07.02.zip到D:\java\apache-ofbiz-13.07.02（路径可自己更改） 使用版本apache-ofbiz-13.0"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="http://blog.aezo.cn/data/images/java/ofbiz-note1.png"><meta property="og:image" content="http://blog.aezo.cn/data/images/java/ofbiz-note2.png"><meta property="og:updated_time" content="2021-08-31T06:07:20.357Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="OFBiz"><meta name="twitter:description" content="简介安装编译启动安装下载 下载：http://ofbiz.apache.org （http://www.apache.org/dyn/closer.lua/ofbiz/apache-ofbiz-13.07.02.zip） 解压：apache-ofbiz-13.07.02.zip到D:\java\apache-ofbiz-13.07.02（路径可自己更改） 使用版本apache-ofbiz-13.0"><meta name="twitter:image" content="http://blog.aezo.cn/data/images/java/ofbiz-note1.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",sidebar:{position:"right",display:"post",offset:12,offset_float:0,b2t:!1,scrollpercent:!1},fancybox:!0,motion:!0,duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"BWD6R9FA4K",apiKey:"3330f3cbaa099dfc30395de5f5b20151",indexName:"blog",hits:{per_page:10},labels:{input_placeholder:"请输入关键字",hits_empty:"我们没有找到任何搜索结果: ${query}",hits_stats:"找到约${hits}条结果（用时${time}ms）"}}}</script><link rel="canonical" href="http://blog.aezo.cn/2017/12/09/java/ofbiz/ofbiz/"><title>OFBiz | Smalle's Blog | AEZOCN</title><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?d82223039d601f2f819f8fe140a63468";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><div style="display:none"><script src="//s95.cnzz.com/z_stat.php?id=cnzz_stat_icon_1276691827&web_id=cnzz_stat_icon_1276691827" language="JavaScript"></script></div></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-right page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Smalle's Blog | AEZOCN</span><span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">Better Code, Better Life</h1></div><div class="site-nav-toggle"> <button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br> 首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br> 分类</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br> 关于</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br> 归档</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br> 标签</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i><br> 站点地图</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br> 搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"> <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><link itemprop="mainEntityOfPage" href="http://blog.aezo.cn/2017/12/09/java/ofbiz/ofbiz/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="smalle"><meta itemprop="description" content=""><meta itemprop="image" content="https://avatars0.githubusercontent.com/u/15698218?v=3&u=ce740bf0b67ff0d74990ba6fc644d6e92f572dcb&s=400"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Smalle's Blog | AEZOCN"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">OFBiz</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-09T10:17:00+08:00">2017-12-09</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a></span></span></div></header><div class="post-body" itemprop="articleBody"><div></div><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><h2 id="安装编译启动"><a href="#安装编译启动" class="headerlink" title="安装编译启动"></a>安装编译启动</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><h4 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h4><ul><li>下载：<a href="http://ofbiz.apache.org" target="_blank" rel="noopener">http://ofbiz.apache.org</a> （<a href="http://www.apache.org/dyn/closer.lua/ofbiz/apache-ofbiz-13.07.02.zip）" target="_blank" rel="noopener">http://www.apache.org/dyn/closer.lua/ofbiz/apache-ofbiz-13.07.02.zip）</a></li><li>解压：apache-ofbiz-13.07.02.zip到D:\java\apache-ofbiz-13.07.02（路径可自己更改）</li><li>使用版本apache-ofbiz-13.07.02的要求是JDK版本至少1.7以上（ofbiz已经封装好了tomcat，在framework-catalina-lib下）</li></ul><h4 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h4><ul><li><p>命令行启动</p><ul><li>先cmd进入到命令行模式下，cd到你当前的OFBiz的工作环境(D:\java\apache-ofbiz-13.07.02)，也就是你的解压环境。</li><li>然后运行 ant load-demo。第一次编译大概需要10分钟。提示”BUILD SUCCESSFUL”即表示部署成功</li><li>再运行ant start 。出现类似“finished in [1328] milliseconds”就表示启动服务器成功</li><li>访问前台<a href="http://localhost:8080/ecommerce" target="_blank" rel="noopener">http://localhost:8080/ecommerce</a> 可设置语言为中文，现点击几个链接体验一下。</li><li><p>访问后台<a href="https://localhost:8443/ordermgr" target="_blank" rel="noopener">https://localhost:8443/ordermgr</a></p><ul><li>提示：此网站的安全证书存在问题。点击“继续浏览此网站(不推荐)。”</li><li>默认用户名密码：admin/ofbiz</li></ul></li><li><p>管理员工具页面：<a href="https://localhost:8443/webtools" target="_blank" rel="noopener">https://localhost:8443/webtools</a></p></li><li>停止服务：定位到OFBiz启动的shell，按下Ctrl+C。我们将看到shell显示提示： 终止批处理操作吗(Y/N)? 输入Y来终止服务</li><li>还有一种就是重新打开shell，并定位到该文件夹，使用命名：ant stop</li><li>获取可用命令列表：ant –p</li><li>启动乱码<ul><li>Windows：修改tools/startofbiz.bat文件中的代码为（主要设置了UTF-8）”%JAVA_HOME%\bin\java” -Xms128M -Xmx512M -XX:MaxPermSize=512m -Dfile.encoding=UTF-8 -jar ofbiz.jar</li><li>Linux：修改tools/startofbiz.sh文件中代码MEMIF=”-Xms128M -Xmx512M -XX:MaxPermSize=512m” 为 MEMIF=”-Xms128M -Xmx512M -XX:MaxPermSize=512m -Dfile.encoding=UTF-8”</li></ul></li></ul></li><li>部署到eclipse<ul><li>从svn检出（速度可能有点慢）：在页面<a href="http://ofbiz.apache.org/source-repositories.html" target="_blank" rel="noopener">http://ofbiz.apache.org/source-repositories.html</a> 找到相应的svn地址，如“release13.07: $ svn co <a href="http://svn.apache.org/repos/asf/ofbiz/branches/release13.07" target="_blank" rel="noopener">http://svn.apache.org/repos/asf/ofbiz/branches/release13.07</a> ofbiz.13.07”<br>表示版本ofbiz.13.07的svn地址为<a href="http://svn.apache.org/repos/asf/ofbiz/branches/release13.07" target="_blank" rel="noopener">http://svn.apache.org/repos/asf/ofbiz/branches/release13.07</a> ，检出的项目命名为testOFBiz13.07</li><li>直接从svn上检出的代码会有错误，这是因为有的代码是编译后才生成的，所以我们需要运行ant.bat进行编译，编译完毕后刷新工程即可清除错误</li><li>在ant窗口-add buildfiles-找到项目testOFBiz13.07-选择根目录下的build.xml-完成</li><li>第一次访问，要先在ant窗口双击load-demo，显示BUILD SUCCESSFUL则表示项目安装成功(第一次部署时间很长且有很多警告)。以后在ant窗口双击build[default]部署一下项目即可</li><li>然后双击build目录下的start启动服务（控制台显示No crashed jobs to re-schedule则启动成功）。使用stop终止服务</li><li>在浏览器访问<a href="http://localhost:8080/ecommerce" target="_blank" rel="noopener">http://localhost:8080/ecommerce</a> 和 <a href="https://localhost:8443/ordermgr" target="_blank" rel="noopener">https://localhost:8443/ordermgr</a> 用户名/密码 admin/ofbiz</li><li>第二种部署到eclipse中的方法是先将压缩包下载下来，再导入到eclipse中</li></ul></li></ul><h3 id="OFBiz目录结构"><a href="#OFBiz目录结构" class="headerlink" title="OFBiz目录结构"></a>OFBiz目录结构</h3><p><img src="/data/images/java/ofbiz-note1.png" alt="ofbiz目录结构"></p><ul><li>Applications目录<ul><li>Applications目录包含了OFBiz核心的应用程序组件，如订单管理，电子商务存储等。</li><li>component-load.xml文件配置需要载入哪几个应用程序组件。这里的每一个组件，都是一个基于OFBIZ构建的Web应用程序。</li></ul></li><li>framework目录<ul><li>Framework框架目录，包含OFBiz框架的组件，例如实体引擎和服务引擎。这是OFBiz框架的核心，其他应用程序都是基于它来构建的。</li><li>component-load.xml文件配置需要载入哪几个框架组件。</li></ul></li><li>specialpurpose目录<ul><li>specialpurpose专门目录，包含一些其他的应用程序，不是OFBiz核心的一部分。包含更多的OFBiz打包的应用程序和组件。</li></ul></li><li><p>hot-deploy热部署目录，以后创建的项目，都需要在这个目录下进行部署。结构如下：</p><p> <img src="/data/images/java/ofbiz-note2.png" alt="hot-deploy目录结构"></p><ul><li>build.xml：Ant编译使用，不需要修改</li><li>ofbiz-component.xml：加载当前组件中所有的内容和文件使用</li><li>config目录：该文件夹内主要是配置文件(.properties)及国际化标签信息(.xml)</li><li>data目录：该文件夹内主要是存放下拉/字典类数据；Demo数据；权限数据；操作帮助数据在ofbiz-component.xml中引用</li><li>document目录：该文件夹内主要是存放文档数据，比如调用data中的helpdata下的帮助文档数据</li><li>dtd目录：dtd文件用于定义合法的XML文档构建模块，如上图中引用的dtd中xsd规范</li><li>entitydef目录：包含两种文件实体定义文件和eca文件</li><li>lib目录：存放jar包</li><li>script目录：存放基于minilang编写的方法，调用方式如下；可以传入和输出参数</li><li>servicedef目录：存放业务系统所需要执行的所有服务，而服务可以通过各种方式实现（java，webservice，minilang等等）同时这个文件夹和entity一样会存放服务对应的eca文件，实现也是同样，用作捆绑服务操作的行为</li><li>src目录：存放系统所需要执行的java方法，而服务可以调用java实现（java，webservice，minilang等等）</li><li>testdef目录：存放单元测试方法的地方，详细见ofbiz单元测试</li><li>webapp目录：如同其他web项目<ul><li>存放web.xml</li><li>前端页面（ftl为主，被widget中的screen.xml调用）</li><li>action内存放groovy方法</li><li>controller.xml 控制请求</li></ul></li><li>widget目录：存放XXXscreen.xml，被controller调用，XXXscreen.xml做两件事，一个是拼接html页面，通过嵌套，等方式最终引用webapp中的ftl或者jsp或者XXXscreen.xml中直接编写页面；另外一个就是赋值，通过action方法对前端的model或者参数赋值。</li></ul></li></ul><h3 id="build-xml命令"><a href="#build-xml命令" class="headerlink" title="build.xml命令"></a>build.xml命令</h3><ul><li><code>load-demo</code> 加载所有组件中的data数据(data文件夹中xml配置文件, 以<code>&lt;entity-engine-xml&gt;</code>开头)，<strong>每次load时不会删除原来的数据，只会新增，且不会重复新增</strong></li><li><code>clean-all</code> 删除所有runtime 文件夹中下的logs、data文件夹中的数据。(derby数据库在data文件夹中)</li></ul><h3 id="编译扩展"><a href="#编译扩展" class="headerlink" title="编译扩展"></a>编译扩展</h3><ul><li><p>设置hot-deploy下组件(component)编译顺序</p><ul><li><p><code>hot-deploy/build.xml</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">name</span>=<span class="string">"OFBiz hot-deploy Build"</span> <span class="attr">default</span>=<span class="string">"build"</span> <span class="attr">basedir</span>=<span class="string">"."</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filelist</span> <span class="attr">id</span>=<span class="string">"hot-deploy-builds"</span> <span class="attr">dir</span>=<span class="string">"."</span></span></span><br><span class="line"><span class="tag">        <span class="attr">files</span>=<span class="string">"ubase/build.xml,</span></span></span><br><span class="line"><span class="tag"><span class="string">        aplcodecenter/build.xml"</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--运行build命令时--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">target</span> <span class="attr">name</span>=<span class="string">"build"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">iterate</span> <span class="attr">target</span>=<span class="string">"jar"</span> <span class="attr">filelist</span>=<span class="string">"hot-deploy-builds"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--除去不需编译的组件--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">        &lt;externalsubant target="jar"&gt;</span></span><br><span class="line"><span class="comment">            &lt;filelist refid="hot-deploy-builds"/&gt;</span></span><br><span class="line"><span class="comment">        &lt;/externalsubant&gt;</span></span><br><span class="line"><span class="comment">        --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">externalsubant</span> <span class="attr">target</span>=<span class="string">"build"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">filelist</span> <span class="attr">dir</span>=<span class="string">"."</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">file</span> <span class="attr">name</span>=<span class="string">"umetro/build.xml"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">filelist</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">externalsubant</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--运行clean命令时执行--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">target</span> <span class="attr">name</span>=<span class="string">"clean"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">iterate</span> <span class="attr">target</span>=<span class="string">"clean"</span> <span class="attr">filelist</span>=<span class="string">"hot-deploy-builds"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--除去不需clean的组件--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">externalsubant</span> <span class="attr">target</span>=<span class="string">"clean"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">filelist</span> <span class="attr">dir</span>=<span class="string">"."</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">file</span> <span class="attr">name</span>=<span class="string">"umetro/build.xml"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">filelist</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">externalsubant</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li></li></ul></li><li><p>设置hot-deloy下组件单独clean：在项目根目录下的<code>build.xml</code>中加入</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">  <span class="tag">&lt;<span class="name">target</span> <span class="attr">name</span>=<span class="string">"_clean-hot-deploy"</span> <span class="attr">description</span>=<span class="string">"clean hot-deploy jar"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">hotdeployant</span> <span class="attr">target</span>=<span class="string">"clean"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="创建模块"><a href="#创建模块" class="headerlink" title="创建模块"></a>创建模块</h3><ul><li>Ant界面双击create-component</li><li>弹出如下对话框，输入项目名”aezo”，点击OK</li><li>点击OK后又会出现类似一个这样的对话框，继续输入”aezo”（注意大小写，按照他提示的命名示例进行命名），点击OK。加上上个步骤一共输入4次。</li><li>输入4次后会弹出一个对话框，选择Y，点击OK即可</li><li>刷新hot-deploy目录就会看到”aezo”的项目</li></ul><h3 id="Debug"><a href="#Debug" class="headerlink" title="Debug"></a>Debug</h3><h4 id="一般的Debug"><a href="#一般的Debug" class="headerlink" title="一般的Debug"></a>一般的Debug</h4><ul><li>项目右键-配置debug</li><li>new一个debug调试</li><li>配置运行类org.ofbiz.base.start.Start</li><li>设置内存大小：arguments-VM arguments 为 -Xms256m -Xmx512m -XX:MaxPermSize=256m</li><li>新增源码位置</li><li>配置好后直接在项目想右键运行debug as</li><li>常见错误<ul><li>乱码：刚才debug配置的最后一项common有设置编码的，和项目一样</li><li>如果不能使用，尝试再配置一个东西。Environment-New-Name设为LC_ALL，Value设为C，报存</li><li>报错：Admin socket configured on - /127.0.0.1:10523 Can’t load ESAPI properties。在Build Path 里加上base/config、base/cert、base/dtd几个目录</li></ul></li><li>扩展：使用IntelliJ-IDEA注意事项<ul><li>通过Edit Configurations进入，点击 + 号，新建一个application</li><li>Main Class：org.ofbiz.base.start.Start</li><li>Before launch里面将make动作去掉。原因是我们通过ant进行build，所以无需make再次编译</li><li>点击Debug启动</li></ul></li></ul><h4 id="远程Debug"><a href="#远程Debug" class="headerlink" title="远程Debug"></a>远程Debug</h4><ul><li>启动本地项目和远程项目<ul><li>Eclipse中，在ant窗口找到该项目的build目录，再执行start-debug命令</li><li>直接运行tools文件夹中的startofbiz.bat或者startofbiz.sh（linux平台），运行前先修改startofbiz.bat中的<code>&quot;%JAVA_HOME%\bin\java&quot; -Xms128M -Xmx512M -XX:MaxPermSize=512m -jar ofbiz.jar</code> 为 <code>&quot;%JAVA_HOME%\bin\java&quot; -Xms128M -Xmx512M -XX:MaxPermSize=512m -Xdebug -Xnoagent -Djava.compiler=NONE -Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=8091 -Dfile.encoding=UTF-8 -jar ofbiz.jar</code></li><li>以上只是修改了启动时的参数，startofbiz.sh同理</li></ul></li><li>是打开Run-Debug Configurations-Remote Java Application-右键new</li><li>Name随便取；Project选择需要调试的项目(不是hot-deploy目录下的组件，而是ofbiz顶级目录，如ofbiz-release13.07)；Connection Type选择Standard(Socket Attach)；Host为远程服务器的ip地址（如果是本地项目可以为127.0.0.1），Port为8091（端口可以修改，但要和build.xml中配置的start-debug参数中的端口一样）。</li><li>点击Applay，再点击Debug即可</li><li>看到此图 第四个图标变亮则表示启动成功，即可进行断点测试；如果测试完成再次点击此图标即可关闭debug，项目仍可正常运行，下次再次点击 此debug按钮即可进入debug环境。</li><li>如果提示错误”Failed to connect to remote VM. Connection refused.Connection refused: connect”，可以勾选Debug配置中的”Allow termination of remote VM”再次尝试</li><li>注意：只要选择的Project中的本地代码的源码文件和远程服务器一样便可以准确的定位到每一行；当使用远程调试ofbiz项目时，修改java文件不需要重新启动或部署（他会实时编译），但是如果修改了service.xml或者entitymodel.xml相关的文件则需要重启。由此可见远程调试较为方便。</li><li>如出现错误提示：<code>Failed to connect to remote VM. Connection timed out.</code> 解决办法：关掉服务器的防火墙，在eclipse配置里面将连接的时间设置长点</li><li>在DOS命令行输入jps –v查看远程端口情况</li><li>扩展：使用IntelliJ-IDEA注意事项<ul><li>通过Edit Configurations进入，点击 + 号，新建一个remote</li><li>Before launch里面将make动作去掉。原因是我们通过ant进行build，所以无需make再次编译</li><li>classpath选择整个项目</li><li>ant运行start-debug</li><li>点击Debug连接远程</li></ul></li></ul><h2 id="相关配置"><a href="#相关配置" class="headerlink" title="相关配置"></a>相关配置</h2><h3 id="端口配置"><a href="#端口配置" class="headerlink" title="端口配置"></a>端口配置</h3><p>一台机器上运行两个ofbiz项目（主要是设置不同的端口）。修改以下端口，不和现有的重复即可。使用netstat –ano查看使用中的端口</p><ul><li><code>OFBIZ_HOME/framework/catalina/ofbiz-component.xml</code>中的ajp默认端口8009，http默认端口8080，https默认端口8443</li><li><code>OFBIZ_HOME\framework\webapp\config\url.properties</code>中port.https和port.http的值</li><li><code>/framework/start/src/org/ofbiz/base/start/start.properties</code>（会生成ofbiz.jar）ofbiz.admin.port默认为10523</li><li><p><code>/framework/base/ofbiz-component.xml</code>中默认的端口是1099</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">container</span> <span class="attr">name</span>=<span class="string">"naming-container"</span> <span class="attr">loaders</span>=<span class="string">"rmi"</span> <span class="attr">class</span>=<span class="string">"org.ofbiz.base.container.NamingServiceContainer"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"host"</span> <span class="attr">value</span>=<span class="string">"0.0.0.0"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"port"</span> <span class="attr">value</span>=<span class="string">"1099"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">container</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p><code>framework/service/ofbiz-component.xml</code></p><ul><li><code>&lt;container name=&quot;rmi-dispatcher&quot; loaders=&quot;rmi&quot; class=&quot;org.ofbiz.service.rmi.RmiServiceContainer&quot;&gt;</code> 下的 <code>&lt;property name=&quot;bound-port&quot; value=&quot;1099&quot;/&gt;</code> 默认为1099</li></ul></li></ul><h3 id="主题定制"><a href="#主题定制" class="headerlink" title="主题定制"></a>主题定制</h3><ul><li>VisualTheme为主题表</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 往视觉风格选项中新增此主题-需要load一下或者将这两段代码在webtools的xml导入中运行一下 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">VisualTheme</span> <span class="attr">visualThemeId</span>=<span class="string">"ADMINLTE"</span> <span class="attr">visualThemeSetId</span>=<span class="string">"BACKOFFICE"</span> <span class="attr">description</span>=<span class="string">"主题描述"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">VisualThemeResource</span> <span class="attr">visualThemeId</span>=<span class="string">"ADMINLTE"</span> <span class="attr">resourceTypeEnumId</span>=<span class="string">"VT_NAME"</span> <span class="attr">resourceValue</span>=<span class="string">"ADMINLTE"</span> <span class="attr">sequenceId</span>=<span class="string">"01"</span>/&gt;</span></span><br></pre></td></tr></table></figure><ul><li>每个用户可以自己设置样式，新注册或者在团体里新建的用户有一个默认样式：配置文件在/framework/common/config/general.properties</li><li>用户配置表为USER_PREFERENCE，中的USER_PREF_TYPE_ID字段为VISUAL_THEME对应的USER_PREF_VALUE的值即为该用户的主题</li></ul><h3 id="编码问题"><a href="#编码问题" class="headerlink" title="编码问题"></a>编码问题</h3><ul><li>首先要保证数据库编码一致<ul><li>entityengine.xml文件的datasource的character-set和collate的属性设置一致。</li><li>character-set=”utf8”</li><li>collate=”utf8_general_ci”</li><li>在链接数据库时，链接数据格式应该为 <code>jdbc-uri=&quot;jdbc:mysql://127.0.0.1/ofbizolap?autoReconnect=true&amp;amp;characterEncoding=UTF-8&quot;</code></li></ul></li><li>还有就是虚拟机的启动参数加上 <code>-Dfile.encoding=UTF-8</code></li><li><p>Build.xml中的修改如下</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">target</span> <span class="attr">name</span>=<span class="string">"start"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">description</span>=<span class="string">"Start OFBiz (use -Dportoffset=portNumber to shift all ports with the portNumber value)"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java</span> <span class="attr">jar</span>=<span class="string">"ofbiz.jar"</span> <span class="attr">fork</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">jvmarg</span> <span class="attr">value</span>=<span class="string">"$&#123;memory.initial.param&#125;"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">jvmarg</span> <span class="attr">value</span>=<span class="string">"$&#123;memory.max.param&#125;"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">jvmarg</span> <span class="attr">value</span>=<span class="string">"$&#123;memory.maxpermsize.param&#125;"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">jvmarg</span> <span class="attr">value</span>=<span class="string">"-Dfile.encoding=UTF-8"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">arg</span> <span class="attr">value</span>=<span class="string">"start"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">arg</span> <span class="attr">value</span>=<span class="string">"-portoffset=$&#123;portoffset&#125;"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">java</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>Startofbiz.bat启动乱码，最后几行修改为</p></li></ul><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> on</span><br><span class="line">"<span class="variable">%JAVA_HOME%</span>\bin\java" -Xms128M -Xmx512M -XX:MaxPermSize=<span class="number">512</span>m -Dfile.encoding=UTF-<span class="number">8</span> -jar ofbiz.jar</span><br><span class="line"><span class="built_in">echo</span> off</span><br></pre></td></tr></table></figure><h3 id="在ofbiz启动和关闭时进行相关操作"><a href="#在ofbiz启动和关闭时进行相关操作" class="headerlink" title="在ofbiz启动和关闭时进行相关操作"></a>在ofbiz启动和关闭时进行相关操作</h3><h4 id="随Ofbiz启动"><a href="#随Ofbiz启动" class="headerlink" title="随Ofbiz启动"></a>随Ofbiz启动</h4><ul><li>参考 <a href="http://blog.sina.com.cn/s/blog_47eb6d9b01000a8w.html" target="_blank" rel="noopener">http://blog.sina.com.cn/s/blog_47eb6d9b01000a8w.html</a></li><li>在/framework/base/config/ofbiz-containers.xml中注册跟随启动的服务，如在末尾加入<code>&lt;container name=&quot;message-service-container&quot; loaders=&quot;main&quot; class=&quot;org.ofbiz.message.StartMessageService&quot;/&gt;</code></li><li>继承org.ofbiz.base.container.Container类，重写init、start、stop、getName方法，项目启动时先会运行init，后会运行start，当项目停止时，默认不会运行stop方法的</li></ul><h4 id="随Ofbiz关闭"><a href="#随Ofbiz关闭" class="headerlink" title="随Ofbiz关闭"></a>随Ofbiz关闭</h4><ul><li>参考文章 <a href="http://lf6627926.iteye.com/blog/1843104" target="_blank" rel="noopener">http://lf6627926.iteye.com/blog/1843104</a></li><li>修改framework/start/src/org/ofbiz/base/start/start.properties的ofbiz.enable.hook=true</li><li>在自定义启动的container类的init方法中加入如下代码（如org.ofbiz.message.StartMessageService的init方法中）</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义关闭线程</span></span><br><span class="line">Thread shutdownThread = <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"===============shut================="</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">new</span> StartMessageService().stop();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ContainerException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// jvm关闭的时候先执行该线程钩子</span></span><br><span class="line">Runtime.getRuntime().addShutdownHook(shutdownThread);</span><br></pre></td></tr></table></figure><h3 id="邮件配置"><a href="#邮件配置" class="headerlink" title="邮件配置"></a>邮件配置</h3><ul><li>参考 <a href="http://lamadong.blog.163.com/blog/static/207085720093226432980/" target="_blank" rel="noopener">http://lamadong.blog.163.com/blog/static/207085720093226432980/</a></li><li>修改配置文件<code>framework/common/config/general.properties</code></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">defaultFromEmailAddress=默认邮件地址</span><br><span class="line">mail.notifications.enabled=Y <span class="comment"># 启用邮箱服务</span></span><br><span class="line">mail.smtp.relay.host=smtp.sina.com <span class="comment"># 邮箱服务地址</span></span><br><span class="line">mail.smtp.auth.user=邮箱帐号</span><br><span class="line">mail.smtp.auth.password=邮箱密码</span><br><span class="line">mail.smtp.port=25 <span class="comment"># 端口</span></span><br></pre></td></tr></table></figure><ul><li>调用framework/common/servicedef/services_email.xml中的sendMail服务(此文件中的其他服务也可以调用)</li></ul><h2 id="实体"><a href="#实体" class="headerlink" title="实体"></a>实体</h2><h3 id="基本说明"><a href="#基本说明" class="headerlink" title="基本说明"></a>基本说明</h3><ul><li><p>实体与数据组(逻辑数据库)的关联</p><ul><li><p>entity-group一般被定义在模块<code>entitydef\entitygroupXXX.xml</code>中，对实体进行分组，使不同的实体分属不同的entity-group。不是所有的entity都进行了entity-group分组，如果没有被分组，系统启动的时候会将实体默认归类到<code>org.ofbiz</code>中</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">entity-group</span> <span class="attr">group</span>=<span class="string">"org.ofbiz.olap"</span> <span class="attr">entity</span>=<span class="string">"CurrencyDimension"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">entity-group</span> <span class="attr">group</span>=<span class="string">"org.ofbiz.olap"</span> <span class="attr">entity</span>=<span class="string">"DateDimension"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">entity-group</span> <span class="attr">group</span>=<span class="string">"org.ofbiz.tenant"</span> <span class="attr">entity</span>=<span class="string">"Tenant"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">entity-group</span> <span class="attr">group</span>=<span class="string">"org.ofbiz.tenant"</span> <span class="attr">entity</span>=<span class="string">"TenantDataSource"</span>/&gt;</span></span><br></pre></td></tr></table></figure></li></ul></li><li><p>查看数据库定义文件<code>%ofbiz_home%/framework/entity/config/entityengine.xml</code></p><ul><li><p>delegator将多个group-name组织到一起并将group-name与datasource对应起来。而Datasource定义了数据库驱动，数据库用户名、密码等，所以datasource就是我们说的数据库</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">delegator</span> <span class="attr">name</span>=<span class="string">"default"</span> <span class="attr">entity-model-reader</span>=<span class="string">"main"</span> <span class="attr">entity-group-reader</span>=<span class="string">"main"</span> <span class="attr">entity-eca-reader</span>=<span class="string">"main"</span> <span class="attr">distributed-cache-clear-enabled</span>=<span class="string">"false"</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">group-map</span> <span class="attr">group-name</span>=<span class="string">"org.ofbiz"</span> <span class="attr">datasource-name</span>=<span class="string">"localpostnew"</span>/&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">group-map</span> <span class="attr">group-name</span>=<span class="string">"org.ofbiz.olap"</span> <span class="attr">datasource-name</span>=<span class="string">"localpostolap"</span>/&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">group-map</span> <span class="attr">group-name</span>=<span class="string">"org.ofbiz.tenant"</span> <span class="attr">datasource-name</span>=<span class="string">"localposttenant"</span>/&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">delegator</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul></li><li><p>通过entity-group将各个实体和数据组之间关联起来，然后将一个或多个数据组归属到一个delegator中。注入delegator则在<code>web.xml</code>中</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context-param</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>entityDelegatorName<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>default<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>The Name of the Entity Delegator to use, defined in entityengine.xml<span class="tag">&lt;/<span class="name">description</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="Tenant多租户-SaaS"><a href="#Tenant多租户-SaaS" class="headerlink" title="Tenant多租户(SaaS)"></a>Tenant多租户(SaaS)</h3><h4 id="基本说明-1"><a href="#基本说明-1" class="headerlink" title="基本说明"></a>基本说明</h4><ul><li>OFBiz提供Tenant多租户配置，开启后用户需要输入一个数据源(TenantId)，从而根据此TanantId从默认数据源获取Tenant、TenantDataSource数据库连接等信息，从而根据对应的数据库连接初始化一个Delegator(“default#tanantId”)，之后使用Delegator则是对相应数据源进行操作</li><li>默认数据源必须要，如用户登录是根据主数据源来的。还需提前创建好Tanant数据源</li><li>Tanant数据源默认是在第一次查询时(<code>delegator = DelegatorFactory.getDelegator(delegatorName);</code>)进行初始化(会看到控制台检查Tanant数据源表结构日志)，此时需要较长时间<ul><li>可考虑在项目重启时初始化所有的Tenant数据源</li></ul></li><li>开启<code>TenantUserLogin</code>，可限制某个用户可使用的数据源</li><li>获取默认Delegator <code>Delegator baseDelegator = DelegatorFactory.getDelegator(delegator.getDelegatorBaseName());</code></li><li><p>流程</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.org/ofbiz/webapp/control/ContextFilter.java 基于域名(domainName)进行Tenant数据源分流(即不同的域名可配置不同的数据源)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig config)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// initialize the delegator</span></span><br><span class="line">    getDelegator(config.getServletContext());</span><br><span class="line">    <span class="comment">// initialize security</span></span><br><span class="line">    getSecurity();</span><br><span class="line">    <span class="comment">// initialize the services dispatcher</span></span><br><span class="line">    getDispatcher(config.getServletContext());</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    List&lt;GenericValue&gt; tenants = delegator.findList(<span class="string">"Tenant"</span>, EntityCondition.makeCondition(<span class="string">"domainName"</span>, serverName), <span class="keyword">null</span>, UtilMisc.toList(<span class="string">"-createdStamp"</span>), <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (UtilValidate.isNotEmpty(tenants)) &#123;</span><br><span class="line">        String tenantDelegatorName = delegator.getDelegatorBaseName() + <span class="string">"#"</span> + tenantId;</span><br><span class="line">        httpRequest.getSession().setAttribute(<span class="string">"delegatorName"</span>, tenantDelegatorName);</span><br><span class="line">        delegator = DelegatorFactory.getDelegator(tenantDelegatorName);</span><br><span class="line">        config.getServletContext().setAttribute(<span class="string">"delegator"</span>, delegator);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.XXXFilter.java 可拦截登录进行数据分流，并写入session</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.org/ofbiz/webapp/control/ControlServlet.java 基于用户session进行数据分流</span></span><br><span class="line">String delegatorName = (String) session.getAttribute(<span class="string">"delegatorName"</span>);</span><br><span class="line"><span class="keyword">if</span> (UtilValidate.isNotEmpty(delegatorName)) &#123;</span><br><span class="line">    delegator = DelegatorFactory.getDelegator(delegatorName);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (delegator == <span class="keyword">null</span>) &#123;</span><br><span class="line">    delegator = (Delegator) getServletContext().getAttribute(<span class="string">"delegator"</span>);</span><br><span class="line">&#125;</span><br><span class="line">request.setAttribute(<span class="string">"delegator"</span>, delegator);</span><br><span class="line">session.setAttribute(<span class="string">"delegatorName"</span>, delegator.getDelegatorName());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4.org/ofbiz/webapp/control/LoginWorker.java 登录成功，将数据分流信息存入session</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">login</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">    String tenantId = request.getParameter(<span class="string">"tenantId"</span>);</span><br><span class="line">    <span class="keyword">if</span> (UtilValidate.isNotEmpty(tenantId)) &#123;</span><br><span class="line">        String delegatorName = delegator.getDelegatorBaseName() + <span class="string">"#"</span> + tenantId;</span><br><span class="line">        delegator = DelegatorFactory.getDelegator(delegatorName); <span class="comment">// default#T1</span></span><br><span class="line">        dispatcher = ContextFilter.makeWebappDispatcher(servletContext, delegator); <span class="comment">// webtools#T1、test/T1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    setWebContextObjects(...);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setWebContextObjects</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Delegator delegator, LocalDispatcher dispatcher)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    request.setAttribute(<span class="string">"delegator"</span>, delegator);</span><br><span class="line">    request.setAttribute(<span class="string">"dispatcher"</span>, dispatcher);</span><br><span class="line">    request.setAttribute(<span class="string">"security"</span>, security);</span><br><span class="line"></span><br><span class="line">    session.setAttribute(<span class="string">"delegatorName"</span>, delegator.getDelegatorName());</span><br><span class="line">    session.setAttribute(<span class="string">"delegator"</span>, delegator);</span><br><span class="line">    session.setAttribute(<span class="string">"dispatcher"</span>, dispatcher);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><ul><li><p>配置好OFBiz的主数据库和tenant多租户数据库</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- framework/entity/config/entityengine.xml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">delegator</span> <span class="attr">name</span>=<span class="string">"default"</span> <span class="attr">entity-model-reader</span>=<span class="string">"main"</span> <span class="attr">entity-group-reader</span>=<span class="string">"main"</span> <span class="attr">entity-eca-reader</span>=<span class="string">"main"</span> <span class="attr">distributed-cache-clear-enabled</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 主数据库 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">group-map</span> <span class="attr">group-name</span>=<span class="string">"org.ofbiz"</span> <span class="attr">datasource-name</span>=<span class="string">"localoracle"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">group-map</span> <span class="attr">group-name</span>=<span class="string">"org.ofbiz.olap"</span> <span class="attr">datasource-name</span>=<span class="string">"localoracle"</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 多租户配置库(一般也存放再主数据库中)：里面存放的是每个tenant的数据库配置、默认的模块等信息 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">group-map</span> <span class="attr">group-name</span>=<span class="string">"org.ofbiz.tenant"</span> <span class="attr">datasource-name</span>=<span class="string">"localoracletenant"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">delegator</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>配置tenant数据库连接等信息</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- framework/entity/data/TenantDemoData.xml --&gt;</span></span><br><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="tag">&lt;<span class="name">entity-engine-xml</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Tenant</span> <span class="attr">tenantId</span>=<span class="string">"T1"</span> <span class="attr">tenantName</span>=<span class="string">"测试1"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">TenantDataSource</span> <span class="attr">tenantId</span>=<span class="string">"T1"</span> <span class="attr">entityGroupName</span>=<span class="string">"org.ofbiz"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">jdbcUri</span>=<span class="string">"jdbc:oracle:thin:@192.168.1.100:1521:orcl"</span> <span class="attr">jdbcUsername</span>=<span class="string">"test1"</span> <span class="attr">jdbcPassword</span>=<span class="string">"test1"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">TenantDataSource</span> <span class="attr">tenantId</span>=<span class="string">"T1"</span> <span class="attr">entityGroupName</span>=<span class="string">"org.ofbiz.olap"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">jdbcUri</span>=<span class="string">"jdbc:oracle:thin:@192.168.1.100:1521:orcl"</span> <span class="attr">jdbcUsername</span>=<span class="string">"test1"</span> <span class="attr">jdbcPassword</span>=<span class="string">"test1"</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- See comments on entity def: &lt;TenantUserLogin tenantId="DEMO1" userLoginId="admin" fromDate="2001-05-13 00:00:00.000" thruDate="" isManager="Y"/&gt; --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">Tenant</span> <span class="attr">tenantId</span>=<span class="string">"T2"</span> <span class="attr">tenantName</span>=<span class="string">"测试2"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">TenantDataSource</span> <span class="attr">tenantId</span>=<span class="string">"T2"</span> <span class="attr">entityGroupName</span>=<span class="string">"org.ofbiz"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">jdbcUri</span>=<span class="string">"jdbc:oracle:thin:@192.168.1.100:1521:orcl"</span> <span class="attr">jdbcUsername</span>=<span class="string">"test2"</span> <span class="attr">jdbcPassword</span>=<span class="string">"test2"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">TenantDataSource</span> <span class="attr">tenantId</span>=<span class="string">"T2"</span> <span class="attr">entityGroupName</span>=<span class="string">"org.ofbiz.olap"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">jdbcUri</span>=<span class="string">"jdbc:oracle:thin:@192.168.1.100:1521:orcl"</span> <span class="attr">jdbcUsername</span>=<span class="string">"test2"</span> <span class="attr">jdbcPassword</span>=<span class="string">"test2"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">entity-engine-xml</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>执行<code>ant load-demo</code>将此数据添加到<code>group-name=&quot;org.ofbiz.tenant&quot;</code>对应的数据库中，或者执行<code>ant create-tenant</code>添加配置到Tenant配置库中，也可以直接进行数据库操作</li></ul></li><li>修改配置文件<code>framework/common/config/general.properties</code>中，把<code>multitenant</code>属性改成<code>Y</code>。此时登录页面会显示TenantId输入(具体可查看<code>framework/common/webcommon/login.ftl</code>中multitenant相关代码)</li><li>此时用户输入用户名密码，并输入一个有效的TenantId即可以访问此TenantId相关数据(如果不输入TenantId则为主数据库)<ul><li>此时(框架)使用的是主数据源中的<code>USER_LOGIN</code>等用户表相关信息</li><li>此处并没有限制那个用户可以访问那个TenantId，具体配置可见下文</li></ul></li><li><p>使用说明</p><ul><li>通过<code>request.getAttribute(&quot;delegator&quot;)</code>获取的Delegator已经是带有Tenant信息的Delegator(Tenant数据源)</li><li><p>自行获取数据源</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">      <span class="comment">// 正确做法(delegator中包含Tenant信息，因此获取GenericHelperInfo也包含Tenant信息)</span></span><br><span class="line">      GenericHelperInfo helperInfo = delegator.getGroupHelperInfo(<span class="string">"org.ofbiz"</span>);</span><br><span class="line">      Connection connection = ConnectionFactory.getConnection(groupHelperName);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 错误做法(此时无法获取到Tenant数据源)</span></span><br><span class="line">      String groupHelperName = delegator.getGroupHelperName(<span class="string">"org.ofbiz"</span>);</span><br><span class="line">Connection connection = ConnectionFactory.getConnection(helperInfo);</span><br></pre></td></tr></table></figure></li><li><p>delegator基于entity查询数据时，实体引擎生成的表结构默认带有主数据源的schame</p><ul><li>如果Oracle使用的是一个数据库，并使用的是不同表空间来完成Tenant，就会导致查询确实连接的是Tenant数据库，但是sql语句包含schame(select * from a.my_table)<ul><li>解决办法，去掉<code>entityengine.xml</code>中主数据的schame参数配置，从而生成的sql语句默认使用当前数据库连接用户的schame(select * from my_table)</li></ul></li><li>或使用不同的数据库，使用相同表空间</li></ul></li></ul></li></ul><h4 id="使用扩展"><a href="#使用扩展" class="headerlink" title="使用扩展"></a>使用扩展</h4><ul><li>开启<code>TenantUserLogin</code>，可指定某个用户只能使用某数据源(可选)<ul><li>打开<code>framework/entity/entitydef/entitymodel.xml</code>中TenantUserLogin的注释</li><li>打开<code>framework/entity/entitydef/entitygroup.xml</code>中TenantUserLogin的注释</li><li>打开<code>framework/webapp/src/org/ofbiz/webapp/control/LoginWorker.java</code>中TenantUserLogin的注释</li><li>在<code>framework/entity/data/TenantDemoData.xml</code>中添加每个用户对应的tenantId，如<code>&lt;TenantUserLogin tenantId=&quot;T1&quot; userLoginId=&quot;admin&quot; fromDate=&quot;2001-05-13 00:00:00.000&quot; thruDate=&quot;&quot; isManager=&quot;Y&quot;/&gt;</code>(执行<code>ant load-demo</code>)</li></ul></li><li><p>基于用户名自动进行数据分流(可选)</p><ul><li><p>保证<code>TenantUserLogin</code>中普通用户只能对应一个数据源，管理用户可以对应多个(如admin)，则登录时需要输入数据源</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TenantFilter</span> <span class="keyword">extends</span> <span class="title">ContextFilter</span> </span>&#123;</span><br><span class="line">     <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest servletrequest, ServletResponse servletresponse, FilterChain chain)</span></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">         HttpSession session = request.getSession();</span><br><span class="line">         GenericValue userLogin = (GenericValue) session.getAttribute(<span class="string">"userLogin"</span>);</span><br><span class="line">         String username = request.getParameter(<span class="string">"USERNAME"</span>);</span><br><span class="line">         <span class="comment">// admin为超级管理员账号，必须输入tenantId</span></span><br><span class="line">         <span class="keyword">if</span>(userLogin != <span class="keyword">null</span></span><br><span class="line">             || UtilValidate.isEmpty(username)</span><br><span class="line">             || <span class="string">"admin"</span>.equals(username)</span><br><span class="line">             || !<span class="string">"default"</span>.equals(session.getAttribute(<span class="string">"delegatorName"</span>))) &#123;</span><br><span class="line">             <span class="keyword">return</span>;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         String useMultitenant = UtilProperties.getPropertyValue(<span class="string">"general.properties"</span>, <span class="string">"multitenant"</span>);</span><br><span class="line">         <span class="keyword">if</span> (<span class="string">"Y"</span>.equals(useMultitenant)) &#123;</span><br><span class="line">             Delegator delegator = getDelegator(config.getServletContext());</span><br><span class="line">             List&lt;GenericValue&gt; tenantUserLoginList = <span class="keyword">null</span>;</span><br><span class="line">             <span class="keyword">try</span> &#123;</span><br><span class="line">                 tenantUserLoginList = delegator.findByAnd(<span class="string">"TenantUserLogin"</span>,</span><br><span class="line">                         UtilMisc.toMap(<span class="string">"userLoginId"</span>, username), <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">                 <span class="keyword">if</span>(tenantUserLoginList == <span class="keyword">null</span> || tenantUserLoginList.size() != <span class="number">1</span>) &#123;</span><br><span class="line">                     request.setAttribute(<span class="string">"_ERROR_MESSAGE_"</span>, <span class="string">"用户数据源信息存在异常"</span>);</span><br><span class="line">                     response.sendRedirect(<span class="string">"main"</span>);</span><br><span class="line">                     <span class="keyword">return</span>;</span><br><span class="line">                 &#125;</span><br><span class="line"></span><br><span class="line">                 GenericValue tenant = tenantUserLoginList.get(<span class="number">0</span>);</span><br><span class="line">                 String tenantId = tenant.getString(<span class="string">"tenantId"</span>);</span><br><span class="line">                 String tenantDelegatorName = delegator.getDelegatorBaseName() + <span class="string">"#"</span> + tenantId;</span><br><span class="line"></span><br><span class="line">                 <span class="comment">// 将数据源信息放到session，供前端界面显示`$&#123;(sessionAttributes._tenantName_)!&#125;` (可选)</span></span><br><span class="line">                 List&lt;GenericValue&gt; tenants = delegator.findByAnd(<span class="string">"Tenant"</span>,</span><br><span class="line">                         UtilMisc.toMap(<span class="string">"tenantId"</span>, tenantId), <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">                 <span class="keyword">if</span>(UtilValidate.isNotEmpty(tenants)) &#123;</span><br><span class="line">                     session.setAttribute(<span class="string">"_tenantName_"</span>, tenants.get(<span class="number">0</span>).get(<span class="string">"tenantName"</span>));</span><br><span class="line">                 &#125;</span><br><span class="line"></span><br><span class="line">                 <span class="comment">// 登录成功后将 delegator、dispatcher、security放入到session中</span></span><br><span class="line">                 delegator = DelegatorFactory.getDelegator(tenantDelegatorName);</span><br><span class="line">                 LocalDispatcher dispatcher = ContextFilter.makeWebappDispatcher(config.getServletContext(), delegator);</span><br><span class="line">                 Security security = SecurityFactory.getInstance(delegator);</span><br><span class="line">                 session.setAttribute(<span class="string">"delegatorName"</span>, delegator.getDelegatorName());</span><br><span class="line">                 session.setAttribute(<span class="string">"delegator"</span>, delegator);</span><br><span class="line">                 session.setAttribute(<span class="string">"dispatcher"</span>, dispatcher);</span><br><span class="line">                 session.setAttribute(<span class="string">"security"</span>, security);</span><br><span class="line">             &#125; <span class="keyword">catch</span> (GenericEntityException | SecurityConfigurationException e) &#123;</span><br><span class="line">                 e.printStackTrace();</span><br><span class="line">                 request.setAttribute(<span class="string">"_ERROR_MESSAGE_"</span>, <span class="string">"获取用户数据源信息出错"</span>);</span><br><span class="line">                 response.sendRedirect(<span class="string">"main"</span>);</span><br><span class="line">                 <span class="keyword">return</span>;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;    </span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></li></ul></li><li><p>将数据源信息放到session，供前端界面显示<code>${(sessionAttributes._tenantName_)!}</code>。配合上文<code>TenantFilter</code>使用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org/ofbiz/webapp/control/LoginWorker.java</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setWebContextObjects</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Delegator delegator, LocalDispatcher dispatcher)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 登录成功调用此方法</span></span><br><span class="line">    String tenantId = delegator.getDelegatorTenantId();</span><br><span class="line">    <span class="keyword">if</span>(UtilValidate.isNotEmpty(tenantId)) &#123;</span><br><span class="line">        <span class="comment">// 获取默认数据源</span></span><br><span class="line">        Delegator baseDelegator = DelegatorFactory.getDelegator(delegator.getDelegatorBaseName());</span><br><span class="line">        List&lt;GenericValue&gt; tenants = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            tenants = baseDelegator.findByAnd(<span class="string">"Tenant"</span>,</span><br><span class="line">                    UtilMisc.toMap(<span class="string">"tenantId"</span>, tenantId), <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span>(UtilValidate.isNotEmpty(tenants)) &#123;</span><br><span class="line">                session.setAttribute(<span class="string">"_tenantName_"</span>, tenants.get(<span class="number">0</span>).get(<span class="string">"tenantName"</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (GenericEntityException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h2 id="服务"><a href="#服务" class="headerlink" title="服务"></a>服务</h2><h3 id="OFBiz定时服务（Job）"><a href="#OFBiz定时服务（Job）" class="headerlink" title="OFBiz定时服务（Job）"></a>OFBiz定时服务（Job）</h3><blockquote><p>不推荐使用</p></blockquote><ul><li>要实现的功能：每隔一分钟在表sm_person中产生一条记录</li><li><p>配置实体</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">entity</span> <span class="attr">entity-name</span>=<span class="string">"SmPerson"</span> <span class="attr">package-name</span>=<span class="string">"cn.aezo.test"</span> <span class="attr">title</span>=<span class="string">"实体SmPerson"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">"id"</span> <span class="attr">type</span>=<span class="string">"id-ne"</span>&gt;</span><span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">type</span>=<span class="string">"id-ne"</span>&gt;</span><span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">type</span>=<span class="string">" id-ne"</span>&gt;</span><span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">"description"</span> <span class="attr">type</span>=<span class="string">"description"</span>&gt;</span><span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">prim-key</span> <span class="attr">field</span>=<span class="string">"id"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">entity</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>先写一个service（java/minilang）</p><ul><li><p>利用java写服务</p><ul><li><p>service.xml中的配置</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">service</span> <span class="attr">name</span>=<span class="string">"createSmPersonService"</span> <span class="attr">engine</span>=<span class="string">"java"</span> <span class="attr">location</span>=<span class="string">"cn.aezo.service.MyJobTest"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">invoke</span>=<span class="string">"createSmPerson"</span> <span class="attr">default-entity-name</span>=<span class="string">"SmPerson"</span> <span class="attr">auth</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>定时服务：产生一条SmPerson记录<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">service</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>cn.aezo.service - MyJobTest.java写该服务的实现</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, Object&gt; <span class="title">createSmPerson</span><span class="params">(DispatchContext dctx, Map&lt;String, ? extends Object&gt; context )</span> </span>&#123;</span><br><span class="line">    Delegator delegator = dctx.getDelegator();</span><br><span class="line">    Map&lt;String, Object&gt; map = FastMap.newInstance();</span><br><span class="line">    map.put(<span class="string">"username"</span>, <span class="string">"smalle"</span>);</span><br><span class="line">    map.put(<span class="string">"password"</span>, <span class="string">"123456"</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        delegator.create(<span class="string">"SmPerson"</span>, map);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (GenericEntityException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ServiceUtil.returnSuccess();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></li><li><p>利用minilang写服务</p><ul><li><p>service.xml中的配置</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">service</span> <span class="attr">name</span>=<span class="string">"createSmPersonService"</span> <span class="attr">engine</span>=<span class="string">"simple"</span> <span class="attr">location</span>=<span class="string">"component://aezo/script/MyJobService.xml"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">invoke</span>=<span class="string">"createSmPerson"</span> <span class="attr">default-entity-name</span>=<span class="string">"SmPerson"</span> <span class="attr">auth</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>定时服务：产生一条SmPerson记录<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">service</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>hot-deploy/aezo/script/MyJobService.xml配置</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span> <span class="meta">?&gt;</span></span></span><br><span class="line"><span class="tag">&lt;<span class="name">simple-methods</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag"><span class="attr">xsi:noNamespaceSchemaLocation</span>=<span class="string">"http://ofbiz.apache.org/dtds/simple-methods-v2.xsd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">simple-method</span> <span class="attr">method-name</span>=<span class="string">"createSmPerson"</span> <span class="attr">short-description</span>=<span class="string">"产生一条SmPerson记录"</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">make-value</span> <span class="attr">entity-name</span>=<span class="string">"SmPerson"</span> <span class="attr">value-field</span>=<span class="string">"newEntity"</span>/&gt;</span><span class="comment">&lt;!-- 创建一个SmPerson实体对象 --&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">sequenced-id</span> <span class="attr">sequence-name</span>=<span class="string">"SmPerson"</span> <span class="attr">field</span>=<span class="string">"newEntity.id"</span>/&gt;</span><span class="comment">&lt;!-- 递增的主键 --&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">set</span> <span class="attr">field</span>=<span class="string">"newEntity.username"</span> <span class="attr">value</span>=<span class="string">"smalle"</span>/&gt;</span><span class="comment">&lt;!-- 设置实体相应字段的值 --&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">set</span> <span class="attr">field</span>=<span class="string">"newEntity.password"</span> <span class="attr">value</span>=<span class="string">"123456"</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">create-value</span> <span class="attr">value-field</span>=<span class="string">"newEntity"</span>/&gt;</span><span class="comment">&lt;!-- 往数据库新增一条记录 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">simple-method</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">simple-methods</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul></li></ul></li><li><p>设置定时并启动</p><ul><li><p>利用dispatcher.schedule()方法</p><ul><li><p>配置controller.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">request-map</span> <span class="attr">uri</span>=<span class="string">"startMyJobTest "</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">security</span> <span class="attr">https</span>=<span class="string">"false"</span> <span class="attr">auth</span>=<span class="string">"false"</span>/&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">event</span> <span class="attr">type</span>=<span class="string">"java"</span> <span class="attr">path</span>=<span class="string">"cn.aezo.service.MyJobTest"</span> <span class="attr">invoke</span>=<span class="string">"startMyJobTest "</span>/&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">response</span> <span class="attr">name</span>=<span class="string">"success"</span> <span class="attr">type</span>=<span class="string">"none"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">request-map</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>cn.aezo.service - MyJobTest.java启动该服务的方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">startMyJobTest</span> <span class="params">(HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">LocalDispatcher dispatcher = (LocalDispatcher) request.getAttribute(<span class="string">"dispatcher"</span>); </span><br><span class="line">String jobName = <span class="string">"myJobTest"</span>; <span class="comment">//计划名</span></span><br><span class="line"> 		String poolName = <span class="string">"pool"</span>; <span class="comment">//默认方式</span></span><br><span class="line"> 		String serviceName = <span class="string">"createSmPersonService"</span>; <span class="comment">//计划执行的服务名称</span></span><br><span class="line"> 		Map&lt;String, Object&gt; serviceContext = FastMap.newInstance(); <span class="comment">//服务需要的初始数据</span></span><br><span class="line">			<span class="keyword">long</span> startTime = System.currentTimeMillis(); <span class="comment">//开始时间</span></span><br><span class="line"> 		<span class="keyword">long</span> endTime = System.currentTimeMillis() + <span class="number">1000</span>*<span class="number">60</span>*<span class="number">60L</span>; <span class="comment">//结束时间</span></span><br><span class="line"> 		<span class="keyword">int</span> frequency = <span class="number">1</span>; <span class="comment">//频率(单位；RecurrenceRule.SECONDLY=1)</span></span><br><span class="line"> 		<span class="keyword">int</span> interval = <span class="number">60</span>; <span class="comment">//间隔(如果频率为RecurrenceRule.SECONDLY=1，则此处表示每60秒执行一次)</span></span><br><span class="line"> 		<span class="keyword">int</span> count = <span class="number">10</span>; <span class="comment">//次数</span></span><br><span class="line"> 		<span class="keyword">int</span> maxRetry = <span class="number">5</span>; <span class="comment">//最大重试次数</span></span><br><span class="line"> 		<span class="keyword">try</span> &#123;</span><br><span class="line">     		dispatcher.schedule(jobName, poolName, serviceName, serviceContext,</span><br><span class="line">             	startTime, frequency, interval, count, endTime, maxRetry);</span><br><span class="line"> 		&#125; <span class="keyword">catch</span> (GenericServiceException e) &#123;</span><br><span class="line">       	    e.printStackTrace();</span><br><span class="line"> 		&#125;</span><br><span class="line">    		<span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></li><li><p>启动服务：在浏览器访问 <a href="https://127.0.0.1:8443/aezo/control/startMyJobTest" target="_blank" rel="noopener">https://127.0.0.1:8443/aezo/control/startMyJobTest</a></p></li></ul></li><li>利用ofbiz的webtools工具，在浏览器访问<a href="https://127.0.0.1:8443/webtools/control/scheduleJob" target="_blank" rel="noopener">https://127.0.0.1:8443/webtools/control/scheduleJob</a> 默认用户名和密码：admin/ofbiz，还可以在此处查询到要运行的服务。起始时间必须是未来的某个时间点</li><li><p>通过配置文件设置定时</p><ul><li><p>配置定时文件：hot-deploy/aezo/data/ScheduledJobs.xml(更多的配置规则请查看：framework/service/data/ServiceSeedData.xml)</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">TemporalExpression</span> <span class="attr">tempExprId</span>=<span class="string">"MINUTE_0_59"</span> <span class="attr">tempExprTypeId</span>=<span class="string">"MINUTE_RANGE"</span> <span class="attr">integer1</span>=<span class="string">"0"</span> <span class="attr">integer2</span>=<span class="string">"59"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">JobSandbox</span> <span class="attr">jobName</span>=<span class="string">"myJobTest"</span> <span class="attr">runTime</span>=<span class="string">"2000-01-01 00:00:00.000"</span> <span class="attr">serviceName</span>=<span class="string">"createSmPersonService"</span> <span class="attr">poolId</span>=<span class="string">"pool"</span> <span class="attr">runAsUser</span>=<span class="string">"system"</span> <span class="attr">tempExprId</span>=<span class="string">"MINUTE_0_59"</span> <span class="attr">maxRecurrenceCount</span>=<span class="string">"5"</span>/&gt;</span></span><br></pre></td></tr></table></figure><ul><li>TemporalExpression标签表示往数据表TemporalExpression（定时规则表）中插入数据。如果为tempExprId=”MINUTE_0_59” 为此定时规则id，tempExprTypeId=”MINUTE_RANGE”则表示分钟级别，如果是分钟级别integer1=”0” integer2=”59”表示从第0秒开始计时，59秒后计时完成并执行一次任务，即每分钟执行一次。<temporalexpression tempexprid="myTempExprId" tempexprtypeid="FREQUENCY" integer1="12" integer2="5">根据配置规则可知此段代码表示按分钟计算，每5分钟执行一次</temporalexpression></li><li>JobSandbox标签表示往数据表JobSandbox（定时任务表）中插入数据。其中jobId最好不要指定(他为数据表的主键，该任务下一次运行是根据上次运行的jobId来的)；jobName为任务名称；runTime为任务运行时间（需要指定）；serviceName任务运行时调用的服务名称；tempExprId为TemporalExpression（定时规则表）中的主键；maxRecurrenceCount表示定时任务执行次数(-1表示一直执行)。更多字段可以查看相应的数据表或者model配置文件。</li></ul></li><li>注册此配置文件到ofbiz-component.xml中 <code>&lt;entity-resource type=&quot;data&quot; reader-name=&quot;seed-initial&quot; loader=&quot;main&quot; location=&quot;data/ScheduledJobs.xml&quot;/&gt;</code></li><li>Load刚刚写的配置文件<ul><li>法一：使用build.xml的load-demo等加载数据的命令(不推荐)</li><li>法二：登录到webtools：web管理工具 - 实体XML工具 – XML数据导入，在”完成xml文档”的”<entity-engine-xml></entity-engine-xml>”节点内部插入ScheduledJobs.xml中配置的定时信息 – 导入文本。</li></ul></li></ul></li></ul></li><li>关闭定时<ul><li>登录webtools：web管理工具 - 服务引擎工具 – 任务列表 – 找到需要关闭的定时任务 – 将等待中的任务取消掉即可</li></ul></li><li>说明：只要定时任务没有完成，计时系统重新启动了，也会继续运行(因为数据库中JobSandbox存有该任务的信息)。但是如果将某个为完成的任务取消掉后，下次重启则不会再运行。<br>如果运行失败（找不到服务，但是确实又存在），可能是多个开发，有未及时更新代码导致的</li></ul><h2 id="权限"><a href="#权限" class="headerlink" title="权限"></a>权限</h2><ul><li>参考 <a href="http://blog.csdn.net/yanghua_kobe/article/details/21324627" target="_blank" rel="noopener">^1</a></li><li>设计思想简述：OFBiz采用的”安全组”（Security Group）来将”权限”跟”用户”联系起来。系统中有若干种权限，比如系统预置的权限、用户自定义的权限、资源的权限、操作的权限等等，这些权限会跟安全组建立关系（多对多的关系），而用户又与安全组建立关系（也是多对多的关系）。其中，系统预置权限，是以XML配置的方式导入数据表的。这些配置文件通常的路径为{Component | Application baseDir}/data/XXXSecurityData.xml。这里有对整个权限设计相关表的初始化数据。</li><li>如果新建的component的权限有OFBTOOLS，则新建权限组的时候，注意要给这个组加OFBTOOLS_VIEW权限 <code>&lt;SecurityGroupPermission groupId=&quot;PLATFORM_ADMIN&quot; permissionId=&quot;OFBTOOLS_VIEW&quot;/&gt;</code></li><li><p>权限的定义方法</p><ul><li>Action是指对某一对象的权限操作如：_view、_create、_update、_delete</li><li><p>实体权限：实体权限是由实体+Action构成，比如对product实体可以定义product_admin、product_view、product_create、product_update、product_delete等。且系统规定如果拥有XXX_ADMIN权限，则拥有XXX_VIEW、XXX_CREATE、XXX_UPDATE、XXX_DELETE权限。如新建一个组件AEZO默认会生成文件</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="tag">&lt;<span class="name">entity-engine-xml</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">SecurityPermission</span> <span class="attr">description</span>=<span class="string">"View operations in the Aezo Component."</span> <span class="attr">permissionId</span>=<span class="string">"AEZO_VIEW"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">SecurityPermission</span> <span class="attr">description</span>=<span class="string">"Create operations in the Aezo Component."</span> <span class="attr">permissionId</span>=<span class="string">"AEZO_CREATE"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">SecurityPermission</span> <span class="attr">description</span>=<span class="string">"Update operations in the Aezo Component."</span> <span class="attr">permissionId</span>=<span class="string">"AEZO_UPDATE"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">SecurityPermission</span> <span class="attr">description</span>=<span class="string">"Delete operations in the Aezo Component."</span> <span class="attr">permissionId</span>=<span class="string">"AEZO_DELETE"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">SecurityPermission</span> <span class="attr">description</span>=<span class="string">"ALL operations in the Aezo Component."</span> <span class="attr">permissionId</span>=<span class="string">"AEZO_ADMIN"</span>/&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">SecurityGroupPermission</span> <span class="attr">groupId</span>=<span class="string">"SUPER"</span> <span class="attr">permissionId</span>=<span class="string">"AEZO_ADMIN"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">entity-engine-xml</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>角色权限：角色权限要用到应用(application)的概念，比如在ofbiz中定义了三种应用ORDERMGR、FACILITY、MARKETING，角色权限的定义方法为：ORDERMGR_ROLE_ADMIN、ORDERMGR_ROLE_CLERK等</p></li></ul></li></ul><h3 id="权限控制级别"><a href="#权限控制级别" class="headerlink" title="权限控制级别"></a>权限控制级别</h3><ul><li><p>登录级别</p><ul><li><p>在每个Component的根目录下的ofbiz-component.xml文件下，有对于访问该component的最基本的权限定义。所谓最基本的权限，就是登录该component的用户需要至少拥有该文件内定义的权限才可以访问。示例：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">webapp</span> <span class="attr">name</span>=<span class="string">"order"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">title</span>=<span class="string">"Order"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">description</span>=<span class="string">"OrderComponentDescription"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">server</span>=<span class="string">"default-server"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">location</span>=<span class="string">"webapp/ordermgr"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">base-permission</span>=<span class="string">"OFBTOOLS,ORDERMGR"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">mount-point</span>=<span class="string">"/ordermgr"</span>/&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>见其中的”base-permission”属性。可以看到它包含了两个权限值——OFBTOOLS、ORDERMGR，这也意味着你必须同时拥有这两个权限（OFBTOOLS_VIEW和ORDERMGR_VIEW）才能访问该组件。而通常一个Component也会同时包含权限“OFBTOOLS”以及权限“COMPONNENT-NAME_VIEW”，这样配置的目的是OFBTOOLS用于对web app的访问进行控制，而COMPONNENT-NAME_VIEW用于控制浏览web app的信息</p></li></ul></li><li>request(controller.xml)级别<ul><li>这里有两个重要的参数，所有component的webapp目录下controller.xml中的每个request（<code>&lt;request-map&gt;</code>）标签有一个security（<code>&lt;security&gt;</code>）标签，包含了两个属性<ul><li>https：定义是否对该请求应用SSL加密</li><li>auth：定义是否需要登录才能执行该请求，因此只有在登录成功以后，并且在其他级别上的安全检查也通过了，该请求才会被执行</li></ul></li></ul></li><li><p>component 菜单级别</p><ul><li>component的顶级菜单显示的组件将只对登录过的用户（并且这些用户至少具有”WEBAPP-NAME_VIEW”或者”COMPONENT-NAME_ADMIN”权限）显示。这种级别的访问控制实现在”appbar.ftl”（themes/flatgrey/includes/ appbar.ftl）中用以控制显示哪些应用程序的tabbar（顶级菜单）。Eg：admin属于安全组FULLADMIN，而如果将SECURITY_GROUP_PERMISSION中的groupId=FULLADMIN，permissionId=WEBTOOLS_VIEW的那条记录改为groupId=FULLADMIN，permissionId留空。则访问后台时顶级菜单中将不显示webtools组件的菜单项</li><li><p>当然如果修改appbar.ftl也可以控制哪些菜单不显示哪些显示。appbar.ftl默认遍历所有的组件，如果该登录用户有上面提到的两个权限中的一个就将他显示出来。appbar.ftl部分代码如下</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">#assign</span> <span class="attr">permission</span> = <span class="string">true</span>&gt;</span></span><br><span class="line">...</span><br><span class="line"><span class="tag">&lt;<span class="name">#assign</span> <span class="attr">permissions</span> = <span class="string">display.getBasePermission()</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">#list</span> <span class="attr">permissions</span> <span class="attr">as</span> <span class="attr">perm</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">#if</span> (<span class="attr">perm</span> != <span class="string">"NONE"</span> &amp;&amp; !<span class="attr">security.hasEntityPermission</span>(<span class="attr">perm</span>, "<span class="attr">_VIEW</span>", <span class="attr">session</span>))&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">#--</span> <span class="attr">User</span> <span class="attr">must</span> <span class="attr">have</span> <span class="attr">ALL</span> <span class="attr">permissions</span> <span class="attr">in</span> <span class="attr">the</span> <span class="attr">base-permission</span> <span class="attr">list</span> <span class="attr">--</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">#assign</span> <span class="attr">permission</span> = <span class="string">false</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">#if</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">#list</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">#if</span> <span class="attr">permission</span> == <span class="string">true</span>&gt;</span></span><br><span class="line">    ...将此component菜单显示出来</span><br><span class="line"><span class="tag">&lt;/<span class="name">#if</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul></li><li><p>screen级别</p><ul><li>在每个component下的widget文件夹下的screen配置文件中，section节点下的condition子节点，存在一个名为if-has-permission的节点，它有两个属性：<ul><li>permission：标识位于哪个component</li><li>action：标识执行的动作（包含下划线）</li></ul></li><li><p>permission_action正好构成一个权限，示例</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">screen</span> <span class="attr">name</span>=<span class="string">"screenPermission"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">section</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 如果此登陆用户拥有ACCOUNTING_VIEW的权限则先执行actions中的代码，再显示widgets中的页面；如果没有权限则直接显示fail-widgets中的页面；即时在controller.xml中设置auth=false，此处未登陆的用户则视为没有权限 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">condition</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if-has-permission</span> <span class="attr">permission</span>=<span class="string">"ACCOUNTING"</span> <span class="attr">action</span>=<span class="string">"_VIEW"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">condition</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">actions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">set</span> <span class="attr">field</span>=<span class="string">"hello"</span> <span class="attr">value</span>=<span class="string">"hello ofbiz!"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">actions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">widgets</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">platform-specific</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">html</span>&gt;</span><span class="tag">&lt;<span class="name">html-template</span> <span class="attr">location</span>=<span class="string">"component://aezo/webapp/aezo/html/security.ftl"</span>/&gt;</span><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">platform-specific</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">widgets</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">fail-widgets</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">platform-specific</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">html</span>&gt;</span><span class="tag">&lt;<span class="name">html-template</span> <span class="attr">location</span>=<span class="string">"component://aezo/webapp/aezo/error/error.ftl"</span>/&gt;</span><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">platform-specific</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">fail-widgets</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">screen</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul></li><li><p>Freemarker模板片段级别</p><ul><li>security对象总是存在于screen的上下文对象——context中，你可以在模板中使用已定义的Java方法：hasPermission、hasEntityPermission、hasRolePermission</li></ul></li><li>ervice定义级别<ul><li>你可以定义专门的”Permission service”在不同的安全模式、不同的component中进行复用，这里你可以通过扩展ECA的规则来在其中插入权限验证。具体超出了本篇的范文可以参考示例<code>exampleGenericPermission</code>（example component下）</li></ul></li><li><p>service编程级别</p><ul><li>Minilanguage：使用check-permission 标签，注：Minilanguage是OFBiz特有的基于XML的语言</li><li><p>Java：使用org.ofbiz.security.Security.API</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">simple-method</span> <span class="attr">method-name</span>=<span class="string">"createSmPerson"</span> <span class="attr">short-description</span>=<span class="string">"产生一条SmPerson记录"</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">check-permission</span> <span class="attr">permission</span>=<span class="string">"AEZO"</span> <span class="attr">action</span>=<span class="string">"_CREATE"</span> <span class="attr">error-list-name</span>=<span class="string">"errorList"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">alt-permission</span> <span class="attr">permission</span>=<span class="string">"AEZO"</span> <span class="attr">action</span>=<span class="string">"_UPDATE"</span>/&gt;</span><span class="comment">&lt;!-- 备用权限检查 --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 给当前登录用户分配的备用权限, 若&lt;check-permission&gt;权限校验为false, 继续校验此标签配置权限, 若为true, 则权限校验通过; &lt;alt-permission&gt;可以多个 --&gt;</span>  </span><br><span class="line">        <span class="comment">&lt;!-- check-permission 和 alt-permission 两者的关系是or的关系，即只要两者有一个满足权限要求即可。 --&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="tag">&lt;<span class="name">fail-message</span> <span class="attr">message</span>=<span class="string">"您没有操作权限"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- &lt;fail-property resource="AezoUiLabels" property="AezoPermissionError"/&gt; --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">check-permission</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 不管check-permission检验的结果是true/false，最终后面的代码仍然会执行。如果为false就会将fail-message或者fail-property的值放到error-list-name中 --&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">if-has-permission</span> <span class="attr">permission</span>=<span class="string">"AEZO"</span> <span class="attr">action</span>=<span class="string">"_ADMIN"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">make-value</span> <span class="attr">entity-name</span>=<span class="string">"SmPerson"</span> <span class="attr">value-field</span>=<span class="string">"newEntity"</span>/&gt;</span><span class="comment">&lt;!-- 创建一个SmPerson实体对象 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sequenced-id</span> <span class="attr">sequence-name</span>=<span class="string">"SmPerson"</span> <span class="attr">field</span>=<span class="string">"newEntity.id"</span>/&gt;</span><span class="comment">&lt;!-- 递增的主键 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">set</span> <span class="attr">field</span>=<span class="string">"newEntity.username"</span> <span class="attr">value</span>=<span class="string">"smalle"</span>/&gt;</span><span class="comment">&lt;!-- 设置实体相应字段的值 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">set</span> <span class="attr">field</span>=<span class="string">"newEntity.password"</span> <span class="attr">value</span>=<span class="string">"123456"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">create-value</span> <span class="attr">value-field</span>=<span class="string">"newEntity"</span>/&gt;</span><span class="comment">&lt;!-- 往数据库新增一条记录 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">else</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">log</span> <span class="attr">message</span>=<span class="string">"您没有管理权限"</span> <span class="attr">level</span>=<span class="string">"info"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">else</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">if-has-permission</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">if-not-empty</span> <span class="attr">field</span>=<span class="string">"errorList[0]"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">log</span> <span class="attr">message</span>=<span class="string">"$&#123;errorList[0]&#125;"</span> <span class="attr">level</span>=<span class="string">"info"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">if-not-empty</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">log</span> <span class="attr">message</span>=<span class="string">"执行完毕"</span> <span class="attr">level</span>=<span class="string">"info"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">simple-method</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul></li><li><p>记录级别</p><ul><li>比如对于一个有特定约束的实体，一个基于它的查询，必须要具有特定的权限才能取得相应的结果</li></ul></li><li>角色受限的（或者基于角色）权限（又称Party Roles）<ul><li>同如上的记录级别，通过使用RoleType、PartyRole以及相关的实体（如ContentAndRole）来进行控制。注：这里的角色倾向于业务规则，而完全不同于下面谈到的角色</li></ul></li><li>安全角色<ul><li>安全角色提供一个手段来将一个登录用户与一个特殊的OFBiz元素建立关联，举个例子，如果一个用户被分配有ORDERMGR_VIEW权限，而该用户又与一个特殊的团体有关联（假设称之为XYZ公司，该公司具有ORDERMGR_ROLE_UPDATE安全角色）。那么这么一组合将允许该用户浏览所有属于该公司的权限，并且可以只为该公司更新订单</li></ul></li></ul><h3 id="表结构设计"><a href="#表结构设计" class="headerlink" title="表结构设计"></a>表结构设计</h3><ul><li>OFBiz对于权限这块的表结构设计，这里一共牵扯到6个数据表：<ul><li>SECURITY_GROUP</li><li>SECURITY_PERMISSION</li><li>SECURITY_GROUP_PERMISSION</li><li>USER_LOGIN_SECURITY_GROUP</li><li>PARTY_RELATIONSHIP</li><li>SECURITY_PERMISSION_AUTO_GRANT</li></ul></li><li>SECURITY_GROUP：这就是上面提到的安全组对应的数据表，用户通过从属于某个安全组来间接与权限产生关系。一个安全组可以简单得认为是包含有N个权限的集合。</li><li>SECURITY_PERMISSION：权限表，这里定义了系统中的所有权限。其中最主要需要关注的就是前两个字段：<ul><li>PERMISSION_ID 权限名称：通常以形如“Application_Operate”的形式进行定义（其中，Application表示具体的应用名称，Operate表示操作名称，常用的有CREATE/UPDATE/…）。当然了，也有一些特殊的命名方式比如：“MARKETING_VIEW”表示对MARKETING应用的页面拥有查看权限；”MANUAL_PAYMENT”表示人工支付的事务操作权限；”MARKETING_ADMIN”这里ADMIN作为后缀是一个特殊，表示它具有对MARKETING应用的所有操作权限。</li><li>DESCRIPTION 对于PERMISSION_ID的简短描述</li></ul></li><li>SECURITY_GROUP_PERMISSION：如上面在设计思路中所述，这是Group与Permission的多对多关系表。从语义上也不难理解：一个安全组可以拥有多个权限，一个权限也可以从属于多个安全组。</li><li>USER_LOGIN_SECURITY_GROUP：登录用户安全组，从表的命名方式上也不难看出，这也是一个多对多的关系表（注意观察主键定义）。我们可以看到，这张表并不只是将两张表的主键合起来作为联合主键，而是联合了FROM_DATE，三者联合作为主键。这里我们需要关注OFBiz数据表中普遍采用的一个设计模式——过期而非删除。也就是说，很多关系是有时效性的，这些时效性表现在”FROM_DATE”跟”THRU_DATE”两个字段上。如果发现当前记录已过期，那么就认为其无效，这就相当于我们传统意义上的删除记录操作。这种设计方式在关系庞杂的企业应用中可以避免在删除时被外键困扰而导致的各种异常以及数据一致性约束。</li><li>PARTY_RELATIONSHIP：可以看到该表中包含有一个SECURITY_GROUP_ID字段，用来关联一个安全组（该字段通常都为null）。因为之前安全组只是跟用户产生关联，而用户也是Party的一种，Party可以包含任何的个人、用户、机构等。PARTY_RELATIONSHIP可以用于描述任何两个事物之间的关系，而这种关系有时不仅仅是人，因此他们有时可能也需要拥有权限，而不仅仅是登录用户才需要拥有权限。</li><li><p>关键代码解读</p><ul><li><p>位于{Base_dir}/framework/security/src文件夹下，主要操作被抽象在名为Security的接口中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Iterator&lt;GenericValue&gt; <span class="title">findUserLoginSecurityGroupByUserLoginId</span><span class="params">(String userLoginId)</span></span>;  </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">securityGroupPermissionExists</span><span class="params">(String groupId, String permission)</span></span>;  </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasPermission</span><span class="params">(String permission, HttpSession session)</span></span>;  </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasEntityPermission</span><span class="params">(String entity, String action, HttpSession session)</span></span>;  </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasRolePermission</span><span class="params">(String application, String action, String primaryKey, String role, HttpSession session)</span></span>;  </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clearUserData</span><span class="params">(GenericValue userLogin)</span></span>;</span><br></pre></td></tr></table></figure></li><li><p>再来看看OFBiz中的默认实现（OFBizSecurity.java）中的关键代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasEntityPermission</span><span class="params">(String entity, String action, GenericValue userLogin)</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">if</span> (userLogin == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">false</span>;  </span><br><span class="line"></span><br><span class="line">    <span class="comment">// if (Debug.infoOn()) Debug.logInfo("hasEntityPermission: entity=" + entity + ", action=" + action, module);  </span></span><br><span class="line">    Iterator&lt;GenericValue&gt; iterator = findUserLoginSecurityGroupByUserLoginId(userLogin.getString(<span class="string">"userLoginId"</span>));  </span><br><span class="line">    GenericValue userLoginSecurityGroup = <span class="keyword">null</span>;  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">        userLoginSecurityGroup = iterator.next();  </span><br><span class="line">        <span class="comment">// if (Debug.infoOn()) Debug.logInfo("hasEntityPermission: userLoginSecurityGroup=" + userLoginSecurityGroup.toString(), module);  </span></span><br><span class="line">        <span class="comment">// always try _ADMIN first so that it will cache first, keeping the cache smaller  </span></span><br><span class="line">        <span class="keyword">if</span> (securityGroupPermissionExists(userLoginSecurityGroup.getString(<span class="string">"groupId"</span>), entity + <span class="string">"_ADMIN"</span>))  </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;  </span><br><span class="line">        <span class="keyword">if</span> (securityGroupPermissionExists(userLoginSecurityGroup.getString(<span class="string">"groupId"</span>), entity + action))  </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>这是对于hasEntityPermission的最终实现，我们可以看到，它会首先尝试在entity中追加“ADMIN”字符串，也就是说，先查看超级权限，如果拥有超级权限，则直接认为拥有权限，否则才会去查看细粒度的具体权限</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasRolePermission</span><span class="params">(String application, String action, String primaryKey, List&lt;String&gt; roles, GenericValue userLogin)</span> </span>&#123;  </span><br><span class="line">    String entityName = <span class="keyword">null</span>;  </span><br><span class="line">    EntityCondition condition = <span class="keyword">null</span>;  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (userLogin == <span class="keyword">null</span>)  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;  </span><br><span class="line"></span><br><span class="line">    <span class="comment">// quick test for special cases where were just want to check the permission (find screens)  </span></span><br><span class="line">    <span class="keyword">if</span> (primaryKey.equals(<span class="string">""</span>) &amp;&amp; roles == <span class="keyword">null</span>) &#123;  </span><br><span class="line">        <span class="keyword">if</span> (hasEntityPermission(application, action, userLogin)) <span class="keyword">return</span> <span class="keyword">true</span>;  </span><br><span class="line">        <span class="keyword">if</span> (hasEntityPermission(application + <span class="string">"_ROLE"</span>, action, userLogin)) <span class="keyword">return</span> <span class="keyword">true</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line"></span><br><span class="line">    Map&lt;String, String&gt; simpleRoleMap = OFBizSecurity.simpleRoleEntity.get(application);  </span><br><span class="line">    <span class="keyword">if</span> (simpleRoleMap != <span class="keyword">null</span> &amp;&amp; roles != <span class="keyword">null</span>) &#123;  </span><br><span class="line">        entityName = simpleRoleMap.get(<span class="string">"name"</span>);  </span><br><span class="line">        String pkey = simpleRoleMap.get(<span class="string">"pkey"</span>);  </span><br><span class="line">        <span class="keyword">if</span> (pkey != <span class="keyword">null</span>) &#123;  </span><br><span class="line">            List&lt;EntityExpr&gt; expressions = <span class="keyword">new</span> ArrayList&lt;EntityExpr&gt;();  </span><br><span class="line">            <span class="keyword">for</span> (String role: roles) &#123;  </span><br><span class="line">                expressions.add(EntityCondition.makeCondition(<span class="string">"roleTypeId"</span>, EntityOperator.EQUALS, role));  </span><br><span class="line">            &#125;  </span><br><span class="line">            EntityConditionList&lt;EntityExpr&gt; exprList = EntityCondition.makeCondition(expressions, EntityOperator.OR);  </span><br><span class="line">            EntityExpr keyExpr = EntityCondition.makeCondition(pkey, primaryKey);  </span><br><span class="line">            EntityExpr partyExpr = EntityCondition.makeCondition(<span class="string">"partyId"</span>, userLogin.getString(<span class="string">"partyId"</span>));  </span><br><span class="line">            condition = EntityCondition.makeCondition(exprList, keyExpr, partyExpr);  </span><br><span class="line">        &#125; </span><br><span class="line">    &#125;  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> hasRolePermission(application, action, entityName, condition, userLogin);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>上面的代码可以看到，在方法内部会先尝试调用hasEntityPermission，如果没有权限，则尝试在application后面追加”_ROLE”字符串来查看角色权限是否拥有，如果拥有则，直接返回，否则才会根据相关的Entity-NameRole表继续查找</p></li></ul></li></ul><h3 id="Security-Group-vs-RBAC"><a href="#Security-Group-vs-RBAC" class="headerlink" title="Security Group vs RBAC"></a>Security Group vs RBAC</h3><ul><li>在OFBiz中弱化了角色的概念，强化了安全组的概念</li><li>RBAC常见于单一的系统设计，在单一的系统中，角色这个词定位准确而清晰；而在OFBiz中，它的目标是构建出一套ERP的平台（包含多个异构系统）</li><li>在跨越多个系统之上谈角色，反而变得模糊不清，导致混乱，但采用安全组的概念却不至于，安全组的概念使得权限的载体的粒度更细、更灵活，但同时也更为繁杂，</li><li>其实OFBiz中还是有角色这个概念的（体现在权限中包含_ROLE的权限，可将其视为角色权限）</li><li>而常用的RBAC中通常也用到这种安全组的概念（一个特殊用户，需要分配有跨越多个角色的权限时，这时需要对该用户的权限进行定制化，这是就用得上类似的安全组的概念）</li></ul><h2 id="渲染引擎"><a href="#渲染引擎" class="headerlink" title="渲染引擎"></a>渲染引擎</h2><ul><li><p>此处的form表中最终会渲染成html中的form标签。如</p><ul><li><p>此文件包含一个forms标签，然后forms标签中可以包含多个form标签，每一个form标签代表一个表单，在XXXScreens.xml中通过其name属性进行引用。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="tag">&lt;<span class="name">forms</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> </span></span><br><span class="line"><span class="tag">        <span class="attr">xsi:noNamespaceSchemaLocation</span>=<span class="string">"http://ofbiz.apache.org/dtds/widget-form.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">type</span>=<span class="string">"single"</span> <span class="attr">name</span>=<span class="string">"autoAttributes"</span> <span class="attr">default-entity-name</span>=<span class="string">"SmPerson"</span> <span class="attr">target</span>=<span class="string">"autoAttributesTarget"</span> <span class="attr">target-type</span>=<span class="string">"intra-app"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">"username"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">text</span>&gt;</span><span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">field</span>&gt;</span>		</span><br><span class="line">        <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">"password"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">text</span>&gt;</span><span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">field</span>&gt;</span>		</span><br><span class="line">        <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">"description"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">text</span>&gt;</span><span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">"submit"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">submit</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">field</span>&gt;</span>		</span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">forms</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul></li><li><p>页面显示流程：Handle - Request-map - View-map</p></li><li><code>&lt;property-map resource=&quot;CommonUiLabels&quot; map-name=&quot;uiLabelMap&quot; global=&quot;true&quot;/&gt;</code> 中的resource=”CommonUiLabels”指的是该项目下的config目录下的CommonUiLabels.xml文件</li><li>Decorator是一个页面模板，该模板也是一个screen元素</li><li>Screen，暂时理解为展示屏。一个我们可以浏览的网页，能够包含一个或多个Screen</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Screens</span><br><span class="line">	Screen（在controller.xml里面的view-map要展示的xxxScreens.xml#yyy，其中的yyy就是此标签的name属性，即决定展示那个展示屏）</span><br><span class="line">		Section（一个screen可以包含n个section）</span><br><span class="line">			Action</span><br><span class="line">                Widgets（condition、fail-widgets）</span><br><span class="line">                    (1)	直接展示一个或多个ftl页面碎片</span><br><span class="line">                    (2)	使用Decorator模板</span><br><span class="line">                        decorator-screen（name指明使用哪个模板）</span><br><span class="line">                        decorator-section（如果decorator-section的name=xxx。此模板或者其父模板如果包含某个decorator-section-include标签，其name=xxx。则此处就是填充到该模板的name=xxx的那个位置。）</span><br><span class="line">                    ......</span><br><span class="line">        Section（一个Widgets可以包含n个section）</span><br><span class="line">            Action</span><br><span class="line">					Widgets（一个section可以包含n个widgets）</span><br><span class="line">					......</span><br></pre></td></tr></table></figure><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><h3 id="零散"><a href="#零散" class="headerlink" title="零散"></a>零散</h3><ul><li>修改xml文件一般不需要重新部署，何时需要重启OFBiz<ul><li>下更改时需要重新启动OFBiz服务器<ul><li>Java文件（记得要重新编译）</li><li>配置/.properties文件</li><li>entitymodel或entitygroup XML定义文件</li><li>服务或secas XML文件</li><li>JPublish XML文件</li></ul></li><li>下修改时无需重新启动OFBiz服务器，但有可能你需要在浏览器中清除缓存<ul><li>freemarker FTL模版</li><li>beanshell BSH模版</li><li>Screens XML文件</li><li>Forms XML文件</li><li>控制器XML文件（注意：在opentaps-0.8和OFBiz 3.x及更早版本中，你在更改控制器时需要重启）</li><li>groovy文件</li><li>script文件夹中与service实现相关的xml文件</li></ul></li><li>远程调试，修改了service和entitymodel需要重启</li></ul></li><li>request-map中的uri区分大小写，即在浏览器中输入的url也区分大小写</li><li>登录进了PLSQL Developer，但是还是不显示数据库中存在的表，重新选择一下当前用户</li><li>如果改变了entity中字段类型，需要删除表或者手动修改字段。重新部署是更新不了的</li><li>ofbiz在配置的controller.xml中uri调用的java方法必须是static</li><li>不要把sevice当event用，service就应该是无状态的，只能从上下文获取数据，service中不能访问session 或 request</li><li><code>\framework\entity\config\entityengine.xml</code>中的schema-name需要填写数据库用户名（不区分大小写）</li><li><p>entitymodel.xml</p><ul><li><p>view-entity 视图，一般只用于查询</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view-entity</span> <span class="attr">entity-name</span>=<span class="string">"YtQuoteAdjustmentView"</span> <span class="attr">package-name</span>=<span class="string">"x.y.z"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">member-entity</span> <span class="attr">entity-alias</span>=<span class="string">"QA"</span> <span class="attr">entity-name</span>=<span class="string">"QuoteAdjustment"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">member-entity</span> <span class="attr">entity-alias</span>=<span class="string">"QAT"</span> <span class="attr">entity-name</span>=<span class="string">"OrderAdjustmentType"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">alias-all</span> <span class="attr">entity-alias</span>=<span class="string">"QA"</span> /&gt;</span><span class="comment">&lt;!-- alias-all 将某个实体的全部字段定义进来 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">alias</span> <span class="attr">entity-alias</span>=<span class="string">"QAT"</span> <span class="attr">name</span>=<span class="string">"quoteAdjustmentType"</span> <span class="attr">field</span>=<span class="string">"description"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view-link</span> <span class="attr">entity-alias</span>=<span class="string">"QA"</span> <span class="attr">rel-entity-alias</span>=<span class="string">"QAT"</span> <span class="attr">rel-optional</span>=<span class="string">"true"</span>&gt;</span><span class="comment">&lt;!-- rel-optional="true"内连接 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">key-map</span> <span class="attr">field-name</span>=<span class="string">"quoteAdjustmentTypeId"</span> <span class="attr">rel-field-name</span>=<span class="string">"orderAdjustmentTypeId"</span> /&gt;</span><span class="comment">&lt;!-- 表连接(join)：根据(on)QuoteAdjustment的字段quoteAdjustmentTypeId和参考表OrderAdjustmentType的字段orderAdjustmentTypeId --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view-link</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view-entity</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul></li><li><p>screen.xml中查询数据</p><ul><li>查询一条记录entity-one</li><li>查询多条记录entity-and</li><li><p>查询条件field-map</p><ul><li>field-name数据库中的字段</li><li>from-field请求穿过来的数据，通过<code>parameters.字段</code>获取当前上下文数据，或者通过value传入固定值</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">actions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">set</span> <span class="attr">field</span>=<span class="string">"headerItem"</span> <span class="attr">value</span>=<span class="string">"main"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">entity-one</span> <span class="attr">value-field</span>=<span class="string">"pr_buyer"</span> <span class="attr">entity-name</span>=<span class="string">"PartyRole"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">field-map</span> <span class="attr">field-name</span>=<span class="string">"partyId"</span> <span class="attr">from-field</span>=<span class="string">"userLogin.partyId"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">field-map</span> <span class="attr">field-name</span>=<span class="string">"roleTypeId"</span> <span class="attr">value</span>=<span class="string">"YT_BUYER"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">entity-one</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">entity-and</span> <span class="attr">list</span>=<span class="string">"orderBaseFeeList"</span> <span class="attr">entity-name</span>=<span class="string">"OrderAdjustment"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">field-map</span> <span class="attr">field-name</span>=<span class="string">"orderId"</span> <span class="attr">from-field</span>=<span class="string">"parameters.orderId"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">field-map</span> <span class="attr">field-name</span>=<span class="string">"orderAdjustmentCategoryId"</span> <span class="attr">value</span>=<span class="string">"BASE_FEE"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">entity-and</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">actions</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul></li><li><p>controller.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">   <span class="tag">&lt;<span class="name">request-map</span> <span class="attr">uri</span>=<span class="string">"main"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">security</span> <span class="attr">https</span>=<span class="string">"false"</span> <span class="attr">auth</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line">       <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">           type="request" url不变，内部请求</span></span><br><span class="line"><span class="comment">           type="request-redirect" url改变，重定向，基于相对目录(/controller/myapp/)</span></span><br><span class="line"><span class="comment">               &lt;redirect-parameter name="orderId"/&gt; name要和service返回的字段一样，他会自动附上值</span></span><br><span class="line"><span class="comment">           type="cross-redirect" rul改变，内部重定向，基于根目录(127.0.0.1:8080)</span></span><br><span class="line"><span class="comment">       --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">response</span> <span class="attr">name</span>=<span class="string">"success"</span> <span class="attr">type</span>=<span class="string">"request-redirect"</span> <span class="attr">value</span>=<span class="string">"hello"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">request-map</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h3><ul><li>默认日志生成策略<ul><li>访问日志每天生成一个文件，堆场项目每天会生成一个大小为300M的文件</li><li>普通日志每天最多生成10个文件，每个文件大小为1M（超过文件数量会覆盖当天较早的日志）</li><li>错误日志每天最多生成3个文件，每个文件大小为1M</li></ul></li><li>日志生成策略配置：<code>framework/base/config/log4j2.xml</code></li><li>日志生成级别配置：<code>framework/base/config/debug.properties</code></li></ul><h3 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h3><ul><li>同样的代码部分机器出现启动成功但是页面无法显示。出现场景：使用ofbiz-13.07，windows安装jdk1.8，访问地址是可以进入到event，如果渲染的视图中包含ftl或者多个汉字则无法显示(很简短的一段html代码可正常显示)，通过curl可以返回html代码，火狐浏览器提示编码格式不正确，此时降低jdk版本为jdk1.7(ofbiz-13.07官方提交jdk1.7)可正常访问.(部分机器jdk1.8也可正常运行)</li><li><code>Couldn&#39;t create server socket(/127.0.0.1:10523)</code> 原因是服务已经启动，再点击start就提示端口占用。解决办法：先stop一下，再start</li></ul><h3 id="类加载顺序调试"><a href="#类加载顺序调试" class="headerlink" title="类加载顺序调试"></a>类加载顺序调试</h3><ul><li>引入jvminspect.jar</li><li>将下列代码加到启动参数，即build.xml的start-debug中</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">    jvminspect.jar查看类加载对应的jar包。其中：</span></span><br><span class="line"><span class="comment">    jvminspect.jar是下载得到的工具jar包，所在目录和build.xml文件同级</span></span><br><span class="line"><span class="comment">    jvm.inspect.output是输出的文件地址，</span></span><br><span class="line"><span class="comment">    flushIntervalSecond参数指定的是定时刷新的时间间隔。</span></span><br><span class="line"><span class="comment">    增加了这个参数之后重启，就可以在jvm.inspect.output文件中查看这个jvm进程加载类的情况了。</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">jvmarg</span> <span class="attr">value</span>=<span class="string">"-javaagent:jvminspect.jar=outputfile=jvm.inspect.output,flushIntervalSecond=300"</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!--&lt;jvmarg value="-DHtmlFlusher.enableHyperlink=false"/&gt;--&gt;</span></span><br></pre></td></tr></table></figure><h3 id="打包docker镜像"><a href="#打包docker镜像" class="headerlink" title="打包docker镜像"></a>打包docker镜像</h3><ul><li>Dockerfile</li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ARG</span> AEZO_DOCKER_REGISTRY=<span class="number">192.168</span>.<span class="number">1.100</span>:<span class="number">5000</span></span><br><span class="line"><span class="keyword">FROM</span> $&#123;AEZO_DOCKER_REGISTRY&#125;/java-base/jdk:<span class="number">1.7</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">MAINTAINER</span> smalle</span><br><span class="line"></span><br><span class="line"><span class="keyword">ARG</span> APP_VERSION</span><br><span class="line"><span class="keyword">ENV</span> APP_VERSION=$&#123;APP_VERSION&#125;</span><br><span class="line"><span class="keyword">ARG</span> PROFILES_NAME</span><br><span class="line"><span class="keyword">ENV</span> PROFILES_NAME=$&#123;PROFILES_NAME&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> . /app</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">RUN chmod +x /app/ant.sh</span></span><br><span class="line"><span class="bash">RUN chmod +x /app/tools/startofbiz.sh</span></span><br><span class="line"><span class="bash">RUN chmod +x /app/tools/stopofbiz.sh</span></span><br><span class="line"><span class="bash">RUN chmod +x /app/docker/docker-build.sh</span></span><br><span class="line"><span class="bash">RUN /app/docker/docker-build.sh</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">CMD [<span class="string">"/bin/bash"</span>, <span class="string">"-c"</span>, <span class="string">"cd /app &amp;&amp; ./ant.sh &amp;&amp; ./tools/startofbiz.sh"</span>]</span></span><br><span class="line"><span class="bash"><span class="comment"># CMD ["/bin/bash", "-c", "sleep 1h"]</span></span></span><br></pre></td></tr></table></figure><ul><li>docker-build.sh</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ ! <span class="variable">$PROFILES_NAME</span> ]]; <span class="keyword">then</span></span><br><span class="line">    PROFILES_NAME=<span class="string">'dev'</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">mv /app/framework/entity/config/entityengine.<span class="variable">$&#123;PROFILES_NAME&#125;</span>.xml /app/framework/entity/config/entityengine.xml</span><br></pre></td></tr></table></figure><ul><li><code>.dockerignore</code> 类似 <code>.gitignore</code> 进行配置</li><li>build.xml</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"projectDir"</span> <span class="attr">value</span>=<span class="string">"$&#123;basedir&#125;/.."</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">tstamp</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">format</span> <span class="attr">property</span>=<span class="string">"nowTm"</span> <span class="attr">pattern</span>=<span class="string">"yyMMdd-HHmmss"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tstamp</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">environment</span>=<span class="string">"env"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">condition</span> <span class="attr">property</span>=<span class="string">"appName"</span> <span class="attr">value</span>=<span class="string">"$&#123;env.APP_NAME&#125;"</span> <span class="attr">else</span>=<span class="string">"demo-test"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">isset</span> <span class="attr">property</span>=<span class="string">"env.APP_NAME"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">condition</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">target</span> <span class="attr">name</span>=<span class="string">"docker-deploy"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exec</span> <span class="attr">executable</span>=<span class="string">"cmd.exe"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">arg</span> <span class="attr">line</span>=<span class="string">"/c &amp;quot; docker login 192.168.1.100:5000 -u $&#123;env.MY_HARBOR_U&#125; -p $&#123;env.MY_HARBOR_P&#125; &amp;quot; "</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exec</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exec</span> <span class="attr">executable</span>=<span class="string">"cmd.exe"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">arg</span> <span class="attr">line</span>=<span class="string">"/c &amp;quot; cd $&#123;projectDir&#125;/ &amp;amp;&amp;amp; docker build --rm -t $&#123;appName&#125;:$&#123;nowTm&#125; --build-arg APP_VERSION=$&#123;nowTm&#125; -f ./docker/Dockerfile . &amp;quot; "</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exec</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exec</span> <span class="attr">executable</span>=<span class="string">"cmd.exe"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">arg</span> <span class="attr">line</span>=<span class="string">"/c &amp;quot; docker tag $&#123;appName&#125;:$&#123;nowTm&#125; 192.168.1.100:5000/library/$&#123;appName&#125;:$&#123;nowTm&#125; &amp;quot; "</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exec</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exec</span> <span class="attr">executable</span>=<span class="string">"cmd.exe"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">arg</span> <span class="attr">line</span>=<span class="string">"/c &amp;quot; docker push 192.168.1.100:5000/library/$&#123;appName&#125;:$&#123;nowTm&#125; &amp;quot; "</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exec</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br></pre></td></tr></table></figure><hr><p>参考文章</p></div><div></div><div></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> smalle</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="http://blog.aezo.cn/2017/12/09/java/ofbiz/ofbiz/" title="OFBiz">http://blog.aezo.cn/2017/12/09/java/ofbiz/ofbiz/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/ofbiz/" rel="tag"># ofbiz</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2017/12/09/java/ofbiz/ofbiz进阶/" rel="next" title="OFBiz进阶"><i class="fa fa-chevron-left"></i> OFBiz进阶</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"> <a href="/2017/12/12/java/java-base/" rel="prev" title="Java基础">Java基础<i class="fa fa-chevron-right"></i></a></div></div></footer></article><div class="post-spread"></div></div></div><div class="comments" id="comments"></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> 文章目录</li><li class="sidebar-nav-overview" data-target="site-overview"> 站点概览</li></ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="https://avatars0.githubusercontent.com/u/15698218?v=3&u=ce740bf0b67ff0d74990ba6fc644d6e92f572dcb&s=400" alt="smalle"><p class="site-author-name" itemprop="name">smalle</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">155</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/index.html"><span class="site-state-item-count">13</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/index.html"><span class="site-state-item-count">140</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#简介"><span class="nav-number">1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装编译启动"><span class="nav-number">2.</span> <span class="nav-text">安装编译启动</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装"><span class="nav-number">2.1.</span> <span class="nav-text">安装</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#下载"><span class="nav-number">2.1.1.</span> <span class="nav-text">下载</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#启动"><span class="nav-number">2.1.2.</span> <span class="nav-text">启动</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#OFBiz目录结构"><span class="nav-number">2.2.</span> <span class="nav-text">OFBiz目录结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#build-xml命令"><span class="nav-number">2.3.</span> <span class="nav-text">build.xml命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#编译扩展"><span class="nav-number">2.4.</span> <span class="nav-text">编译扩展</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建模块"><span class="nav-number">2.5.</span> <span class="nav-text">创建模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Debug"><span class="nav-number">2.6.</span> <span class="nav-text">Debug</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#一般的Debug"><span class="nav-number">2.6.1.</span> <span class="nav-text">一般的Debug</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#远程Debug"><span class="nav-number">2.6.2.</span> <span class="nav-text">远程Debug</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#相关配置"><span class="nav-number">3.</span> <span class="nav-text">相关配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#端口配置"><span class="nav-number">3.1.</span> <span class="nav-text">端口配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#主题定制"><span class="nav-number">3.2.</span> <span class="nav-text">主题定制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#编码问题"><span class="nav-number">3.3.</span> <span class="nav-text">编码问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#在ofbiz启动和关闭时进行相关操作"><span class="nav-number">3.4.</span> <span class="nav-text">在ofbiz启动和关闭时进行相关操作</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#随Ofbiz启动"><span class="nav-number">3.4.1.</span> <span class="nav-text">随Ofbiz启动</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#随Ofbiz关闭"><span class="nav-number">3.4.2.</span> <span class="nav-text">随Ofbiz关闭</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#邮件配置"><span class="nav-number">3.5.</span> <span class="nav-text">邮件配置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实体"><span class="nav-number">4.</span> <span class="nav-text">实体</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#基本说明"><span class="nav-number">4.1.</span> <span class="nav-text">基本说明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Tenant多租户-SaaS"><span class="nav-number">4.2.</span> <span class="nav-text">Tenant多租户(SaaS)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#基本说明-1"><span class="nav-number">4.2.1.</span> <span class="nav-text">基本说明</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用"><span class="nav-number">4.2.2.</span> <span class="nav-text">使用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用扩展"><span class="nav-number">4.2.3.</span> <span class="nav-text">使用扩展</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#服务"><span class="nav-number">5.</span> <span class="nav-text">服务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#OFBiz定时服务（Job）"><span class="nav-number">5.1.</span> <span class="nav-text">OFBiz定时服务（Job）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#权限"><span class="nav-number">6.</span> <span class="nav-text">权限</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#权限控制级别"><span class="nav-number">6.1.</span> <span class="nav-text">权限控制级别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#表结构设计"><span class="nav-number">6.2.</span> <span class="nav-text">表结构设计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Security-Group-vs-RBAC"><span class="nav-number">6.3.</span> <span class="nav-text">Security Group vs RBAC</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#渲染引擎"><span class="nav-number">7.</span> <span class="nav-text">渲染引擎</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#其他"><span class="nav-number">8.</span> <span class="nav-text">其他</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#零散"><span class="nav-number">8.1.</span> <span class="nav-text">零散</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#日志"><span class="nav-number">8.2.</span> <span class="nav-text">日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#常见问题"><span class="nav-number">8.3.</span> <span class="nav-text">常见问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#类加载顺序调试"><span class="nav-number">8.4.</span> <span class="nav-text">类加载顺序调试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#打包docker镜像"><span class="nav-number">8.5.</span> <span class="nav-text">打包docker镜像</span></a></li></ol></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright"> &copy; 2016 - <span itemprop="copyrightYear">2021</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">smalle</span>&nbsp;&nbsp;&nbsp;&nbsp;<div class="powered-by"> 由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div><div class="powered-by"> 主题 - <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a></div><div class="theme-info cnzz" style="margin:0 0 -5px 10px"><script type="text/javascript">var cnzz_protocol="https:"==document.location.protocol?"https://":"http://";document.write(unescape("%3Cspan id='cnzz_stat_icon_1276691827'%3E%3C/span%3E%3Cscript src='"+cnzz_protocol+"s23.cnzz.com/z_stat.php%3Fid%3D1276691827%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"))</script></div></div><div class="ad"> <span style="font-weight:700">AD&nbsp;&nbsp;&nbsp;&nbsp;</span><div class="theme-info"> <a target="_blank" href="https://promotion.aliyun.com/ntms/yunparter/invite.html?userCode=oby5nolb">阿里云大礼包</a></div></div><div class="aezocn"> <span style="font-weight:700">@AEZO.CN&nbsp;&nbsp;&nbsp;&nbsp;</span><div class="theme-info"> <a target="_blank" href="http://shop.aezo.cn/">杂货铺</a></div></div><script>"use strict";!function(){var n=window.driftt=window.drift=window.driftt||[];if(!n.init){if(n.invoked)return window.console&&console.error&&console.error("Drift snippet included twice.");n.invoked=!0,n.methods=["identify","config","track","reset","debug","show","ping","page","hide","off","on"],n.factory=function(e){return function(){var t=Array.prototype.slice.call(arguments);return t.unshift(e),n.push(t),n}},n.methods.forEach(function(t){n[t]=n.factory(t)}),n.load=function(t){var e=3e5*Math.ceil(new Date/3e5),n=document.createElement("script");n.type="text/javascript",n.async=!0,n.crossorigin="anonymous",n.src="https://js.driftt.com/include/"+e+"/"+t+".js";var r=document.getElementsByTagName("script")[0];r.parentNode.insertBefore(n,r)}}}(),drift.SNIPPET_VERSION="0.3.1",drift.load("e4wbzuxev4zt")</script><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?d82223039d601f2f819f8fe140a63468";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script><script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script type="text/javascript" src="/js/src/js.cookie.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/scroll-cookie.js?v=5.1.1"></script></body></html>