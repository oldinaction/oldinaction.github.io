<!doctype html><html class="theme-next mist use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css"><meta name="keywords" content="vue,springboot,"><link rel="alternate" href="/atom.xml" title="月星墙的博客" type="application/atom+xml"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1"><meta name="description" content="默认配置 后端返回数据字段驼峰(如果通过ObjectMapper字段名转成下划线，前台做好下划线命名的字段映射后传回给后台，此时后台pojo都是驼峰，导致无法转换) 前后台url都以/开头方便全局搜索 url地址和linux文件路径/和//效果是一样的；windows路径则必须是/或者\  Spring 表单操作的dto应该基于业务模式进行解耦，不要耦合到一个dto中 出错场景：使用dto(数据传"><meta name="keywords" content="vue,springboot"><meta property="og:type" content="article"><meta property="og:title" content="基于Springboot和Vue前后分离"><meta property="og:url" content="http://blog.aezo.cn/2017/12/25/arch/springboot-vue/index.html"><meta property="og:site_name" content="月星墙的博客"><meta property="og:description" content="默认配置 后端返回数据字段驼峰(如果通过ObjectMapper字段名转成下划线，前台做好下划线命名的字段映射后传回给后台，此时后台pojo都是驼峰，导致无法转换) 前后台url都以/开头方便全局搜索 url地址和linux文件路径/和//效果是一样的；windows路径则必须是/或者\  Spring 表单操作的dto应该基于业务模式进行解耦，不要耦合到一个dto中 出错场景：使用dto(数据传"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="http://blog.aezo.cn/data/images/arch/web-cache.png"><meta property="og:updated_time" content="2025-09-22T01:23:09.329Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="基于Springboot和Vue前后分离"><meta name="twitter:description" content="默认配置 后端返回数据字段驼峰(如果通过ObjectMapper字段名转成下划线，前台做好下划线命名的字段映射后传回给后台，此时后台pojo都是驼峰，导致无法转换) 前后台url都以/开头方便全局搜索 url地址和linux文件路径/和//效果是一样的；windows路径则必须是/或者\  Spring 表单操作的dto应该基于业务模式进行解耦，不要耦合到一个dto中 出错场景：使用dto(数据传"><meta name="twitter:image" content="http://blog.aezo.cn/data/images/arch/web-cache.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",sidebar:{position:"right",display:"post",offset:12,offset_float:0,b2t:!1,scrollpercent:!1},fancybox:!0,motion:!0,duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"BWD6R9FA4K",apiKey:"3330f3cbaa099dfc30395de5f5b20151",indexName:"blog",hits:{per_page:10},labels:{input_placeholder:"请输入关键字",hits_empty:"我们没有找到任何搜索结果: ${query}",hits_stats:"找到约${hits}条结果（用时${time}ms）"}}}</script><link rel="canonical" href="http://blog.aezo.cn/2017/12/25/arch/springboot-vue/"><title>基于Springboot和Vue前后分离 | 月星墙的博客</title><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?085f9cd91ef2ad985f791c677472f0d1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-right page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">月星墙的博客</span><span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">Better Code, Better Life</h1></div><div class="site-nav-toggle"> <button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br> 首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br> 分类</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br> 关于</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br> 归档</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br> 标签</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i><br> 站点地图</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br> 搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"> <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><link itemprop="mainEntityOfPage" href="http://blog.aezo.cn/2017/12/25/arch/springboot-vue/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="smalle"><meta itemprop="description" content=""><meta itemprop="image" content="https://avatars0.githubusercontent.com/u/15698218?v=3&u=ce740bf0b67ff0d74990ba6fc644d6e92f572dcb&s=400"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="月星墙的博客"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">基于Springboot和Vue前后分离</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-25T21:16:00+08:00">2017-12-25</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/arch/" itemprop="url" rel="index"><span itemprop="name">arch</span></a></span></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="默认配置"><a href="#默认配置" class="headerlink" title="默认配置"></a>默认配置</h2><ul><li>后端返回数据字段驼峰(如果通过ObjectMapper字段名转成下划线，前台做好下划线命名的字段映射后传回给后台，此时后台pojo都是驼峰，导致无法转换)</li><li>前后台url都以<code>/</code>开头方便全局搜索</li><li>url地址和linux文件路径<code>/</code>和<code>//</code>效果是一样的；windows路径则必须是<code>/</code>或者<code>\</code></li></ul><h2 id="Spring"><a href="#Spring" class="headerlink" title="Spring"></a>Spring</h2><ul><li>表单操作的dto应该基于业务模式进行解耦，不要耦合到一个dto中<ul><li>出错场景：使用dto(数据传输对象)接受前端数据后，并<code>BeanUtils.copyProperties</code>将dto复制到po(持久化对象)中，且前端有清除数据库部分字段的需求(此时dto中该字段传入的值为null，并使用mybatis生成的<code>updateByPrimaryKey</code>进行更新)。但是内部字段(一般不会让用户直接修改的)初始化后不应该置空。后来在修改某些需求时(如基于客户直接创建拜访)，不小心简单将内部字段(创建拜访时会从客户中查询到CRM_ID并创建拜访记录)加入到dto中加入了部分其他字段导致，此时普通修改时前端并没有传入CRM_ID，导致将内部字段置空</li></ul></li><li><a href="/_posts/db/oracle-dba.md#记录数据变动日志">记录数据变动日志</a></li></ul><h2 id="Mybatis"><a href="#Mybatis" class="headerlink" title="Mybatis"></a>Mybatis</h2><ul><li>使用<code>mybatis plus</code>进行通用代码生成</li><li><code>Mybatis Generator</code>生成通用代码<ul><li>可通过自定义Mapper继承生成的Mapper。(如UserMapperExt extend UserMapper, 可防止因修改生成代码导致无法再次生成)</li><li>生成接口中<code>selective</code>含义：表示根据字段值判断，如果为空则不插入或更新<ul><li><code>insert</code>(不会考虑数据库默认值)、<code>insertSelective</code>(考虑数据库默认值)</li><li><code>updateByPrimaryKey</code>(根据对象查询出来后全部按照传入对象更新，如果传入对象的值为空则会将数据库该字段置空)、<code>updateByPrimaryKeySelective</code>(如果出入对象值为空则不修改数据库该字段值)</li></ul></li></ul></li><li>接口中使用<code>@Select</code>定义实现中，使用<code>&lt;if&gt;</code>代替<code>&lt;when&gt;</code></li></ul><h2 id="Token相关"><a href="#Token相关" class="headerlink" title="Token相关"></a>Token相关</h2><ul><li>前端实现token无感刷新的几种方式: <a href="https://blog.csdn.net/u010952787/article/details/121655780" target="_blank" rel="noopener">https://blog.csdn.net/u010952787/article/details/121655780</a></li><li><strong>token过期后刷新token并重新发起请求</strong>：<a href="https://blog.csdn.net/weixin_44886911/article/details/124992704" target="_blank" rel="noopener">https://blog.csdn.net/weixin_44886911/article/details/124992704</a></li></ul><h2 id="跨域和session"><a href="#跨域和session" class="headerlink" title="跨域和session"></a>跨域和session</h2><h3 id="http-https"><a href="#http-https" class="headerlink" title="http/https"></a>http/https</h3><ul><li>http进行访问无限制</li><li>https进行访问时，不能使用http，包括请求后台/加载静态资源/iframe-src<ul><li>主页面为http访问，主页面嵌入的iframe页面src为https(ip和端口同主页面)，在iframe嵌入的系统内通过<code>window.parent.frames[&#39;iframe-id&#39;]</code>获取时，会产生跨域(因为iframe为主页面元素，在嵌入的系统内通过<code>window.location.href</code>获取的是浏览器地址)</li></ul></li></ul><h3 id="同源政策"><a href="#同源政策" class="headerlink" title="同源政策"></a>同源政策</h3><ul><li><strong>网络协议(http/https)、ip、端口三者都相同就是同一个域(同源)</strong><ul><li>如<code>http://localhsot</code>和<code>http://localhsot:8080</code>之间进行数据交互就存在跨域问题（localhost 和 127.0.0.1 不一样）</li></ul></li><li>浏览器”同源政策”限制(针对不同源情况) <a href="https://mp.weixin.qq.com/s/LV7qziMyrMt0_EJWo05qkA" title="九种跨域方式实现原理" target="_blank" rel="noopener">^2</a><ul><li><code>Cookie、LocalStorage 和 IndexDB 无法读取</code></li><li><code>DOM 无法获得</code></li><li><code>AJAX 请求不能发送</code></li></ul></li></ul><h3 id="跨域通信"><a href="#跨域通信" class="headerlink" title="跨域通信"></a>跨域通信</h3><ul><li><code>JSONP</code>(只能发送GET请求)</li><li><code>CORS</code>(服务器端进行设置即可)</li><li><code>WebSocket</code></li><li><p><code>postMessage</code></p><ul><li>可以实现页面和里面iframe页面之间的通讯</li><li>可以实现窗口和通过window.open的窗口间的通讯</li><li>可以实现窗口和通过a标签(<code>&lt;a href=&quot;B页面&quot; target=&quot;_blank&quot;&gt;新打开B页面&lt;/a&gt;</code>)新打开的窗口间的通讯</li><li><p>示例：将b页面嵌入在a页面中</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- ======a给b发送消息send-from-a，然后b给a回复消息send-from-b======= --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- a.html 其中onload表示iframe加载(iframe项目代码已经加载到浏览器)后执行，如果将iframe隐藏也不会影响其加载 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">"http://localhost:4000/b.html"</span> <span class="attr">frameborder</span>=<span class="string">"0"</span> <span class="attr">id</span>=<span class="string">"iframe"</span> <span class="attr">onload</span>=<span class="string">"load()"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">    /*</span></span><br><span class="line"><span class="undefined">    someWindow.postMessage(message, targetOrigin, [transfer]);</span></span><br><span class="line"><span class="javascript">        message: 将要发送到其他 <span class="built_in">window</span> 的数据</span></span><br><span class="line"><span class="javascript">        targetOrigin: 通过窗口的 origin 属性来指定哪些窗口能接收到消息事件，其值可以是字符串<span class="string">"*"</span>(表示无限制)或者一个 URI。在发送消息的时候，如果目标窗口的协议、主机地址或端口这三者的任意一项不匹配 targetOrigin 提供的值，那么消息就不会被发送；只有三者完全匹配，消息才会被发送</span></span><br><span class="line"><span class="undefined">        transfer(可选): 是一串和 message 同时传递的 Transferable 对象. 这些对象的所有权将被转移给消息的接收方，而发送一方将不再保有所有权</span></span><br><span class="line"><span class="undefined">    */</span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">load</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="comment">// 给子页面(嵌入的iframe)发送消息。此时targetOrigin为'http://localhost:4000'或者'*'均可，http://localhost:4000/ 也可以</span></span></span><br><span class="line"><span class="javascript">        <span class="built_in">document</span>.getElementById(<span class="string">'iframe'</span>).contentWindow.postMessage(&#123;<span class="attr">from</span>: <span class="string">'send-from-a'</span>, <span class="attr">request</span>: <span class="string">'get-name'</span>&#125;, <span class="string">'http://localhost:4000'</span>)</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">        <span class="comment">// 接受数据</span></span></span><br><span class="line"><span class="javascript">        <span class="built_in">window</span>.onmessage = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(e.data) <span class="comment">// send-from-b</span></span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- b.html --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="built_in">window</span>.onmessage = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(e.data) <span class="comment">// send-from-a</span></span></span><br><span class="line"><span class="javascript">        e.source.postMessage(&#123;<span class="attr">from</span>: <span class="string">'send-from-b'</span>, <span class="attr">response</span>: <span class="string">'get-name'</span>, <span class="attr">name</span>: <span class="string">'smalle'</span>&#125;, e.origin) <span class="comment">// 使用e.origin表示回复源窗口消息</span></span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="javascript">    <span class="comment">// 或者监听事件</span></span></span><br><span class="line"><span class="undefined">    /*</span></span><br><span class="line"><span class="undefined">    e.data: 指的是从其他窗口发送过来的消息对象</span></span><br><span class="line"><span class="undefined">    e.type: 指的是发送消息的类型</span></span><br><span class="line"><span class="undefined">    e.source: 指的是发送消息的窗口对象</span></span><br><span class="line"><span class="undefined">    e.origin 指的是发送消息的窗口的源</span></span><br><span class="line"><span class="undefined">    */</span></span><br><span class="line"><span class="javascript">    <span class="built_in">window</span>.addEventListener(<span class="string">"message"</span>,  <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(e)</span></span><br><span class="line"><span class="javascript">    &#125;, <span class="literal">false</span>)</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="comment">// 主动给父页面发送消息</span></span></span><br><span class="line"><span class="javascript">    <span class="built_in">window</span>.parent.postMessage(<span class="string">'hello...'</span>, <span class="string">'*'</span>)</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul></li><li><p>架设服务器代理(浏览器请求同源服务器，再由后者请求外部服务)。如基于<code>nginx</code>做中转</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen   80;               </span><br><span class="line">    server_name localhost;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 后端服务根端点</span></span><br><span class="line">    location /api/ &#123;</span><br><span class="line">        proxy_set_header X-Forward-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        proxy_set_header Host <span class="variable">$http_host</span>;</span><br><span class="line">        proxy_redirect off;</span><br><span class="line">        <span class="keyword">if</span> (!-f <span class="variable">$request_filename</span>) &#123;</span><br><span class="line">            proxy_pass http://127.0.0.1:8080;</span><br><span class="line">            <span class="built_in">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 前端</span></span><br><span class="line">    location / &#123;</span><br><span class="line">        root   D:/demo/vue/dist;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="跨域资源共享-CORS-Cross-origin-resource-sharing-1"><a href="#跨域资源共享-CORS-Cross-origin-resource-sharing-1" class="headerlink" title="跨域资源共享(CORS, Cross-origin resource sharing) ^1"></a>跨域资源共享(CORS, Cross-origin resource sharing) <a href="http://www.ruanyifeng.com/blog/2016/04/cors.html" title="跨域资源共享CORS详解" target="_blank" rel="noopener">^1</a></h3><ul><li><strong><code>CORS</code>需要浏览器和服务器同时支持。</strong>目前，所有浏览器都支持该功能，IE浏览器不能低于IE10。</li><li><strong>浏览器会自动完成CORS通信过程，开发只需配置服务器同源限制</strong><ul><li>开发只需要将<code>Access-Control-Allow-Origin</code>字段添加到响应的头部中即可(如果响应头中无此参数，则说明存在跨域: 允许A访问则有此响应头，不允许B访问则访问后无此响应头)</li><li>客户端 - nginx1 - nginx2 - java，此时2个nginx或者java任意一个写出响应头头即可(如果每级都写出则会重复，此时客户端也会报错)</li><li><strong>JS测试<code>let xhr = new XMLHttpRequest(); xhr.open(&#39;GET&#39;, &#39;https://www.baidu.com/sugrec&#39;); xhr.send();</code></strong></li></ul></li><li><strong>如果CORS通信过程中，响应的头信息没有包含<code>Access-Control-Allow-Origin</code>字段，浏览器则认为无法请求</strong>，便会抛出异常被XHR的onerror捕获</li><li><code>Spring</code>对CORS的支持<a href="https://spring.io/blog/2015/06/08/cors-support-in-spring-framework" target="_blank" rel="noopener">cors-support-in-spring-framework</a><ul><li>可在方法级别进行控制，使用注解<code>@CrossOrigin</code></li><li>全局CORS配置，声明一个<code>WebMvcConfigurer</code>的bean</li><li>基于<code>Filter</code>，声明一个<code>CorsFilter</code>的bean</li></ul></li></ul><h4 id="SpringBoot解决跨域"><a href="#SpringBoot解决跨域" class="headerlink" title="SpringBoot解决跨域"></a>SpringBoot解决跨域</h4><ul><li><strong>使用了下列方法如果仍然出现跨域时</strong><ul><li>如果是使用Filter解决跨域，<strong>检查是否在进入此跨域Filter之前，请求已经返回</strong>，从而没有将<code>Access-Control-Allow-Origin</code>字段加入到请求头中，导致前台浏览器报错跨域</li><li><strong>如果请求参数出现错误或者请求的路径不存在</strong>，此时都还未进入到Cros处理环节，从而没有将<code>Access-Control-Allow-Origin</code>字段加入到请求头中，导致前台浏览器报错跨域<ul><li>如GET请求URL中包含<code>[]</code>等特殊字符，状态码返回400等情况(如果出现跨域，OPTIONS请求返回的应该是403)</li></ul></li></ul></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">优先级?: WebMvcConfigurer &gt; CorsFilter</span><br><span class="line"></span><br><span class="line"><span class="comment">// 法一：基于 CorsFilter(控制过滤器的级别最高, 防止其他Filter已经返回了此请求)</span></span><br><span class="line"><span class="meta">@Order</span>(Ordered.HIGHEST_PRECEDENCE)</span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Filter <span class="title">corsFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// org.springframework.web.cors</span></span><br><span class="line">    UrlBasedCorsConfigurationSource source = <span class="keyword">new</span> UrlBasedCorsConfigurationSource();</span><br><span class="line">    CorsConfiguration config = <span class="keyword">new</span> CorsConfiguration();</span><br><span class="line">    <span class="comment">// config.addAllowedOrigin("*");</span></span><br><span class="line">    config.addAllowedOriginPattern(<span class="string">"*"</span>); <span class="comment">// 匹配所有域名，但仍需配合 allowCredentials(true)</span></span><br><span class="line">    config.addAllowedHeader(<span class="string">"*"</span>);</span><br><span class="line">    config.addAllowedMethod(<span class="string">"*"</span>);</span><br><span class="line">    <span class="comment">// allowedOrigins("*") 会和 allowCredentials(true) 冲突。当允许携带凭证（如 Cookie、HTTP 认证）时，Access-Control-Allow-Origin 不能使用通配符 *，必须指定具体的域名，可使用 CorsFilter addAllowedOriginPattern 代替</span></span><br><span class="line">    config.setAllowCredentials(<span class="keyword">true</span>);</span><br><span class="line">    source.registerCorsConfiguration(<span class="string">"/**"</span>, config);</span><br><span class="line">    <span class="comment">// org.springframework.web.filter.CorsFilter extends OncePerRequestFilter</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> CorsFilter(source);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 法二</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> FilterRegistrationBean&lt;?&gt; filterRegistrationBean() &#123;</span><br><span class="line">    CorsConfiguration configuration = <span class="keyword">new</span> CorsConfiguration();</span><br><span class="line">    configuration.setAllowedOrigins(Arrays.asList(<span class="string">"*"</span>));</span><br><span class="line">    configuration.setAllowedMethods(Arrays.asList(<span class="string">"*"</span>)); <span class="comment">// GET, POST, HEAD, OPTIONS</span></span><br><span class="line">    configuration.setAllowedHeaders(Arrays.asList(<span class="string">"*"</span>));</span><br><span class="line">    <span class="comment">// 接受cookie. 当前端设置了携带cookie，则需要后端配合加入下列代码(前端代码如: axios.defaults.withCredentials = true;)</span></span><br><span class="line">    <span class="comment">// allowedOrigins("*") 会和 allowCredentials(true) 冲突。当允许携带凭证（如 Cookie、HTTP 认证）时，Access-Control-Allow-Origin 不能使用通配符 *，必须指定具体的域名，可使用 CorsFilter addAllowedOriginPattern 代替</span></span><br><span class="line">    configuration.setAllowCredentials(<span class="keyword">true</span>); </span><br><span class="line">    <span class="comment">// 设置可被客户端缓存时间(s)，可不设置</span></span><br><span class="line">    configuration.setMaxAge(<span class="number">3600L</span>);</span><br><span class="line"></span><br><span class="line">    UrlBasedCorsConfigurationSource source = <span class="keyword">new</span> UrlBasedCorsConfigurationSource();</span><br><span class="line">    source.registerCorsConfiguration(<span class="string">"/**"</span>, configuration);</span><br><span class="line"></span><br><span class="line">    FilterRegistrationBean&lt;?&gt; bean = <span class="keyword">new</span> FilterRegistrationBean&lt;&gt;(<span class="keyword">new</span> CorsFilter(source));</span><br><span class="line">    <span class="comment">// 利用FilterRegistrationBean，将拦截器注册靠前，避免被其它拦截器首先执行</span></span><br><span class="line">    bean.setOrder(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 也可直接返回CorsConfigurationSource(但是容易出现被其他拦截器提前拦截的问题)</span></span><br><span class="line"><span class="comment">// public CorsConfigurationSource corsConfigurationSource() &#123;</span></span><br><span class="line"><span class="comment">//     return new UrlBasedCorsConfigurationSource;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 法三(不推荐): 可能会被shiro等框架拦截；如果还实现了WebMvcConfigurer.addInterceptors方法，则也可能会失效</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> WebMvcConfigurer <span class="title">corsConfigurer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> WebMvcConfigurerAdapter() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addCorsMappings</span><span class="params">(CorsRegistry registry)</span> </span>&#123;</span><br><span class="line">            registry.addMapping(<span class="string">"/**"</span>)</span><br><span class="line">                    .allowedHeaders(<span class="string">"*"</span>)</span><br><span class="line">                    .allowedMethods(<span class="string">"*"</span>)</span><br><span class="line">                    .allowedOrigins(<span class="string">"*"</span>)</span><br><span class="line">                    <span class="comment">// allowedOrigins("*") 会和 allowCredentials(true) 冲突。当允许携带凭证（如 Cookie、HTTP 认证）时，Access-Control-Allow-Origin 不能使用通配符 *，必须指定具体的域名，可使用 CorsFilter addAllowedOriginPattern 代替</span></span><br><span class="line">                    .allowCredentials(<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 法四：在@GetMapping处再增加下面注解</span></span><br><span class="line"><span class="meta">@CrossOrigin</span>(origins = [<span class="string">"http://localhost:8080"</span>])</span><br></pre></td></tr></table></figure><h4 id="SpringSecurity的cors配置"><a href="#SpringSecurity的cors配置" class="headerlink" title="SpringSecurity的cors配置"></a>SpringSecurity的cors配置</h4><ul><li><p>开启cors <a href="https://docs.spring.io/spring-security/site/docs/4.2.x/reference/html/cors.html" title="spring-security-cors" target="_blank" rel="noopener">^3</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    http.csrf().disable(); <span class="comment">// 开启cors需要关闭csrf</span></span><br><span class="line">    http.cors();</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置cors，或使用上文其他方式</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> CorsConfigurationSource <span class="title">corsConfigurationSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    CorsConfiguration configuration = <span class="keyword">new</span> CorsConfiguration();</span><br><span class="line">    <span class="comment">// configuration.setAllowedOrigins(Arrays.asList("*"));</span></span><br><span class="line">    configuration.setAllowedOrigins(Arrays.asList(<span class="string">"http://192.168.1.1:8088"</span>, <span class="string">"http://www.aezo.cn:80"</span>, <span class="string">"https://www.aezo.cn:80"</span>));</span><br><span class="line">    configuration.setAllowedMethods(Arrays.asList(<span class="string">"*"</span>));</span><br><span class="line">    configuration.setAllowedHeaders(Arrays.asList(<span class="string">"*"</span>));</span><br><span class="line">    configuration.setAllowCredentials(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    UrlBasedCorsConfigurationSource source = <span class="keyword">new</span> UrlBasedCorsConfigurationSource();</span><br><span class="line">    source.registerCorsConfiguration(<span class="string">"/**"</span>, configuration);</span><br><span class="line">    <span class="keyword">return</span> source;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>CSRF</code> 跨站请求伪造(Cross-Site Request Forgery). <a href="https://docs.spring.io/spring-security/site/docs/4.2.x/reference/html/csrf.html" target="_blank" rel="noopener">csrf</a></li></ul></li></ul><h3 id="iframe相关问题"><a href="#iframe相关问题" class="headerlink" title="iframe相关问题"></a>iframe相关问题</h3><ul><li><p>父页面和iframe页面https关系</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">page - iframe - status</span><br><span class="line"></span><br><span class="line">http - http - allowed</span><br><span class="line">http - https - allowed</span><br><span class="line">https- http - not allowed https嵌套http不支持</span><br><span class="line">https- https - allowed</span><br><span class="line">https - https - insecure scripts - not allowed</span><br><span class="line">https - https - insecure images - allowed but the browser will warn</span><br></pre></td></tr></table></figure></li><li><p>iframe页面获取父页面地址</p><ul><li>如果iframe与父页面遵循同源策略(属于同一个域名)，可通过<code>parent.location</code>或<code>top.location</code>获取父页面url；如果不遵循同源策略，则无法获取</li><li>不同源可使用<code>document.referrer</code>获取</li></ul></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getParentUrl</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> url = <span class="literal">null</span>; <span class="keyword">if</span> (parent !== <span class="built_in">window</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            url = parent.location.href;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            url = <span class="built_in">document</span>.referrer;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> url;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>localStorage和sessionStorage<ul><li>A项目通过iframe嵌入B项目，并将token拼接在url上。此时不管是否跨域，B项目可以获取到url中的参数，也可在B项目中操作localStorage保存数据到B项目所在域</li><li>同一浏览器的非跨域(相同域名和端口)的不同页面间可以共享相同localStorage，但是不同页面间无法共享sessionStorage的信息；跨域则不能共享localStorage，跨域共享localStorage方案<ul><li>postMessage和iframe相结合的方法，参考上文<ul><li>由于safari浏览器的默认限制，父页面无法向iframe里的跨域页面传递信息，此时可使用url传参</li></ul></li><li>用url传值的方法来实现跨域存储功能<ul><li>url的长度极限是由两方面决定的，一个是浏览器本身的限制，另一个就是服务器的限制。safari浏览器可以支持超过64k个字符的长度，一般服务器默认支持2~3万个字符长度的url不成问题</li></ul></li></ul></li></ul></li><li>cookie<ul><li>A项目通过iframe嵌入B项目，并将token拼接在url上。此时如果跨域，B项目可以获取到url中的参数，但是在B项目无法操作cookie保存数据到B项目所在域</li></ul></li></ul><h2 id="Http请求及响应"><a href="#Http请求及响应" class="headerlink" title="Http请求及响应"></a>Http请求及响应</h2><ul><li><a href="/_posts/java/springboot.md#请求参数字段映射">springboot请求参数字段映射</a></li><li>spring-security登录只能接受<code>x-www-form-urlencoded</code>(简单键值对)类型的数据，<code>form-data</code>(表单类型，可以含有文件)类型的请求获取不到参数值</li><li>重定向问题：<code>server.tomcat.use-relative-redirects=true</code> 对于复杂的网络环境，如前置网关可能会导致前端重定向到内网地址，此时设置此参数，从而sendRedirect重定向时写入的Header Location响应头为相对路径</li><li>axios和qs使用参考<a href="/_posts/web/js-tools.md#axios">js-tools.md#axios</a></li></ul><h3 id="文件上传案例"><a href="#文件上传案例" class="headerlink" title="文件上传案例"></a>文件上传案例</h3><ul><li>用户上传文件后，没有上传表单数据，造成无效文件堆积问题<ul><li>可将文件上传到服务器，并记录文件表，状态未生效，当表单提交后修改状态；之后定时根据状态清理服务器垃圾文件</li><li>参考: <a href="https://blog.csdn.net/cocogogogo/article/details/124360240" target="_blank" rel="noopener">https://blog.csdn.net/cocogogogo/article/details/124360240</a></li></ul></li><li><strong>请求类型必须是<code>multipart/form-data</code>，因此数据是在body体中，当通过拦截器拦截body时，不要拦截此类型的请求，否则后面controller将获取不到数据。</strong>参考<a href="/_posts/java/spring.md#拦截response的数据">spring.md#拦截response的数据</a></li><li>相关配置</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  servlet:</span> <span class="comment"># http</span></span><br><span class="line">    <span class="comment"># 也可以利用Bean实现</span></span><br><span class="line"><span class="attr">    multipart:</span></span><br><span class="line">      <span class="comment">#enabled: true           # 启用http上传</span></span><br><span class="line"><span class="attr">      max-file-size:</span> <span class="number">10</span><span class="string">MB</span>     <span class="comment"># 设置支持的单个上传文件的大小限制，默认1M</span></span><br><span class="line"><span class="attr">      max-request-size:</span> <span class="number">20</span><span class="string">MB</span>  <span class="comment"># 设置最大的请求的文件大小，设置总体大小请求(多文件上传)，默认10M</span></span><br><span class="line">      <span class="comment">#file-size-threshold: 512KB   # 当上传文件达到指定配置量的时候会将文件内容写入磁盘</span></span><br><span class="line">      <span class="comment">#location: /             # 设置上传的临时目录</span></span><br></pre></td></tr></table></figure><ul><li>手动上传，和其他Bean字段一起提交</li><li>前台代码(vue + iview)</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">FormItem</span> <span class="attr">label</span>=<span class="string">"文件上传"</span> <span class="attr">prop</span>=<span class="string">"cvReceiptNo"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Upload</span> <span class="attr">:before-upload</span>=<span class="string">"handleUpload"</span> <span class="attr">action</span>=<span class="string">""</span> <span class="attr">:max-size</span>=<span class="string">"10*1024"</span> <span class="attr">style</span>=<span class="string">"display: inline-block;margin-right: 16px;"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span></span></span><br><span class="line"><span class="tag">        <span class="attr">href</span>=<span class="string">"javascript:;"</span>&gt;</span>&#123;&#123; file &amp;&amp; file.name ? file.name : '点击上传' &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">Upload</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">v-if</span>=<span class="string">"editForm.filePath"</span> <span class="attr">target</span>=<span class="string">"_blank"</span> <span class="attr">:href</span>=<span class="string">"that.$staticPath + editForm.filePath"</span>&gt;</span>点击查看<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">FormItem</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Button</span> <span class="attr">type</span>=<span class="string">"info"</span> @<span class="attr">click</span>=<span class="string">"doUpload"</span>&gt;</span>提交<span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">lang</span>=<span class="string">"ts"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="javascript">    data: &#123;&#125;, <span class="comment">// 省略</span></span></span><br><span class="line"><span class="undefined">    methods: &#123;</span></span><br><span class="line"><span class="undefined">        handleUpload(file) &#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> maxSize = <span class="number">10</span> * (<span class="number">1024</span> * <span class="number">1000</span>)</span></span><br><span class="line"><span class="javascript">            <span class="keyword">if</span> (file.size &gt; maxSize) &#123;</span></span><br><span class="line"><span class="javascript">                alert(<span class="string">'当前文件超过10MB，不允许上传'</span>)</span></span><br><span class="line"><span class="javascript">                <span class="keyword">return</span> <span class="literal">false</span></span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">this</span>.file = file;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// 返回false可防止Upload自定上传文件，此时可交由程序控制</span></span></span><br><span class="line"><span class="undefined">        &#125;,</span></span><br><span class="line"><span class="undefined">        doUpload() &#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">this</span>.editForm = &#123;</span></span><br><span class="line"><span class="undefined">                id: 1,</span></span><br><span class="line"><span class="javascript">                feeAmount: <span class="literal">null</span>,</span></span><br><span class="line"><span class="javascript">                createTm: <span class="string">'2000-01-01 00:00:00'</span>,</span></span><br><span class="line"><span class="javascript">                file: <span class="keyword">this</span>.file, <span class="comment">// 之后不能对 editForm 进行序列化，否则会丢失文件信息</span></span></span><br><span class="line"><span class="undefined">                items: [&#123;itemId: 1&#125;,&#123;itemId: 2&#125;],</span></span><br><span class="line"><span class="javascript">                files: [<span class="keyword">this</span>.file, <span class="keyword">this</span>.file],</span></span><br><span class="line"><span class="javascript">                fileList: [<span class="keyword">this</span>.file, <span class="keyword">this</span>.file]</span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> formData = <span class="keyword">this</span>.convertToFormData(<span class="keyword">this</span>.editForm) <span class="comment">// 将json格式转成FormData格式，见下文。或者使用 qs 插件格式化</span></span></span><br><span class="line"><span class="javascript">            formData.append(<span class="string">"myFile"</span>, <span class="keyword">this</span>.file)</span></span><br><span class="line"><span class="javascript">            formData.append(<span class="string">"myFiles"</span>, <span class="keyword">this</span>.file)</span></span><br><span class="line"><span class="javascript">            formData.append(<span class="string">"myFiles"</span>, <span class="keyword">this</span>.file)</span></span><br><span class="line"><span class="javascript">            formData.append(<span class="string">"myFileList"</span>, <span class="keyword">this</span>.file)</span></span><br><span class="line"><span class="javascript">            formData.append(<span class="string">"myFileList"</span>, <span class="keyword">this</span>.file)</span></span><br><span class="line"><span class="javascript">            <span class="comment">// 这种方式后台无法通过普通的 MultipartFile 参数接受（但是如果Bean的字段类型是 MultipartFile, 则可以接受此格式）</span></span></span><br><span class="line"><span class="javascript">            <span class="comment">// formData.append("myFiles[0]", this.file)</span></span></span><br><span class="line"><span class="javascript">            <span class="comment">// formData.append("myFiles[1]", this.file)</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">            /*</span></span><br><span class="line"><span class="javascript">                <span class="comment">// 或重新定义一个axios实例，并挂载到Vue原型上。此处重新定义是防止使用项目中默认的axios实例(一般会通过axios.interceptors.request.use进行处理，而处理后的实例在上传时后台会报错：no multipart boundary was found，然而后台本身是没有问题)</span></span></span><br><span class="line"><span class="javascript">                <span class="keyword">export</span> <span class="keyword">const</span> uploadAxios = axios.create(&#123;</span></span><br><span class="line"><span class="undefined">                    headers: &#123;</span></span><br><span class="line"><span class="javascript">                        <span class="string">'Content-Type'</span>: <span class="string">'multipart/form-data'</span>,</span></span><br><span class="line"><span class="javascript">                        <span class="string">'access_token'</span>: Cookies.get(<span class="string">'access_token'</span>),</span></span><br><span class="line"><span class="undefined">                    &#125;</span></span><br><span class="line"><span class="undefined">                &#125;)</span></span><br><span class="line"><span class="javascript">                <span class="keyword">this</span>.$uploadAxios.post(<span class="string">"http://localost:8080/order/upload"</span>, formData).then(<span class="function">(<span class="params">resp</span>) =&gt;</span> &#123;&#125;) </span></span><br><span class="line"><span class="undefined">            */</span></span><br><span class="line"><span class="javascript">            <span class="keyword">this</span>.$axios.post(url, param, &#123; <span class="string">'Content-Type'</span>: <span class="string">'multipart/form-data'</span> &#125;);</span></span><br><span class="line"><span class="javascript">            <span class="comment">// 或</span></span></span><br><span class="line"><span class="javascript">            <span class="keyword">this</span>.$axios(&#123;</span></span><br><span class="line"><span class="javascript">                url: <span class="string">"http://localost:8080/order/upload"</span>,</span></span><br><span class="line"><span class="javascript">                method: <span class="string">'post'</span>,</span></span><br><span class="line"><span class="javascript">                <span class="comment">// 全局定义的headers(access_token)最终也会注入</span></span></span><br><span class="line"><span class="undefined">                headers: &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="string">'Content-Type'</span>: <span class="string">'multipart/form-data'</span></span></span><br><span class="line"><span class="undefined">                &#125;,</span></span><br><span class="line"><span class="undefined">                data: formData</span></span><br><span class="line"><span class="javascript">            &#125;).then(<span class="function">(<span class="params">resp</span>) =&gt;</span> &#123;&#125;)</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">            /*</span></span><br><span class="line"><span class="javascript">                <span class="comment">// 如果是multipart/form-data，请求参数会自动增加 boundary=...</span></span></span><br><span class="line"><span class="javascript">                <span class="comment">// Content-Type: multipart/form-data; boundary=----WebKitFormBoundarybSHF77IaICmNerQk</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">                <span class="comment">// 请求时 formData 在chrome中格式化显示成</span></span></span><br><span class="line"><span class="undefined">                id: 1</span></span><br><span class="line"><span class="undefined">                feeAmount: </span></span><br><span class="line"><span class="undefined">                createTm: 2000-01-01 00:00:00</span></span><br><span class="line"><span class="undefined">                file: (binary)</span></span><br><span class="line"><span class="undefined">                items[0].itemId: 1</span></span><br><span class="line"><span class="undefined">                items[1].itemId: 2</span></span><br><span class="line"><span class="undefined">                files[0]: (binary)</span></span><br><span class="line"><span class="undefined">                files[1]: (binary)</span></span><br><span class="line"><span class="undefined">                fileList[0]: (binary)</span></span><br><span class="line"><span class="undefined">                fileList[1]: (binary)</span></span><br><span class="line"><span class="undefined">                myFile: (binary)</span></span><br><span class="line"><span class="undefined">                myFiles: (binary)</span></span><br><span class="line"><span class="undefined">                myFiles: (binary)</span></span><br><span class="line"><span class="undefined">                myFileList: (binary)</span></span><br><span class="line"><span class="undefined">                myFileList: (binary)</span></span><br><span class="line"><span class="undefined">                </span></span><br><span class="line"><span class="javascript">                <span class="comment">// 请求时 formData 在chrome中部分源码显示</span></span></span><br><span class="line"><span class="undefined">                ------WebKitFormBoundarybSHF77IaICmNerQk</span></span><br><span class="line"><span class="javascript">                Content-Disposition: form-data; name=<span class="string">"id"</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">                1</span></span><br><span class="line"><span class="undefined">                ------WebKitFormBoundarybSHF77IaICmNerQk</span></span><br><span class="line"><span class="javascript">                Content-Disposition: form-data; name=<span class="string">"files[0]"</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">                ------WebKitFormBoundarybSHF77IaICmNerQk</span></span><br><span class="line"><span class="javascript">                Content-Disposition: form-data; name=<span class="string">"files[1]"</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">                ------WebKitFormBoundarybSHF77IaICmNerQk</span></span><br><span class="line"><span class="javascript">                Content-Disposition: form-data; name=<span class="string">"myFile"</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">                <span class="literal">null</span></span></span><br><span class="line"><span class="undefined">                ------WebKitFormBoundarybSHF77IaICmNerQk</span></span><br><span class="line"><span class="javascript">                Content-Disposition: form-data; name=<span class="string">"myFiles"</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">                <span class="literal">null</span></span></span><br><span class="line"><span class="undefined">                ------WebKitFormBoundarybSHF77IaICmNerQk</span></span><br><span class="line"><span class="javascript">                Content-Disposition: form-data; name=<span class="string">"myFiles"</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">                <span class="literal">null</span></span></span><br><span class="line"><span class="undefined">            */</span></span><br><span class="line"><span class="undefined">        &#125;,</span></span><br><span class="line"><span class="undefined">        convertToFormData(data) &#123;</span></span><br><span class="line"><span class="javascript">            <span class="function"><span class="keyword">function</span> <span class="title">buildFormData</span>(<span class="params">formData, data, parentKey</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">if</span> (data &amp;&amp; <span class="keyword">typeof</span> data === <span class="string">'object'</span> &amp;&amp; !(data <span class="keyword">instanceof</span> <span class="built_in">Date</span>) &amp;&amp; !(data <span class="keyword">instanceof</span> File)) &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="built_in">Object</span>.keys(data).forEach(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">const</span> parentKeyFormat = parentKey ? (data <span class="keyword">instanceof</span> <span class="built_in">Array</span> ? <span class="string">`<span class="subst">$&#123;parentKey&#125;</span>[<span class="subst">$&#123;key&#125;</span>]`</span> : <span class="string">`<span class="subst">$&#123;parentKey&#125;</span>.<span class="subst">$&#123;key&#125;</span>`</span>) : key</span></span><br><span class="line"><span class="undefined">                        buildFormData(formData, data[key], parentKeyFormat);</span></span><br><span class="line"><span class="undefined">                    &#125;);</span></span><br><span class="line"><span class="javascript">                &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">const</span> value = data == <span class="literal">null</span> ? <span class="string">''</span> : data;</span></span><br><span class="line"><span class="undefined">                    formData.append(parentKey, value);</span></span><br><span class="line"><span class="undefined">                &#125;</span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="undefined">            </span></span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> formData = <span class="keyword">new</span> FormData();</span></span><br><span class="line"><span class="undefined">            buildFormData(formData, data);</span></span><br><span class="line"><span class="javascript">            <span class="keyword">return</span> formData;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>后台代码</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/order"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderController</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 以下参数全部可以获取到值。由于请求类型为 multipart/form-data(是基于@RequestParam的方式接受参数), ***因此无法通过 Map 来接受参数***</span></span><br><span class="line">    <span class="comment">// 不能接收 List&lt;Order&gt;, 如果需要可将List&lt;Order&gt;包装到OrderWrapper等对象中. (会报错: `No primary or default constructor found for interface java.util.List`)</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/upload"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">upload</span><span class="params">(MultipartFile myFile, MultipartFile[] myFiles, List&lt;MultipartFile&gt; myFileList, Order order)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.success();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 扩展说明</span></span><br><span class="line">    <span class="comment">// 1.效果同上。多文件上传时Layui会重复请求此接口多次. MultipartFile 并非 File对象，可通过 InputStream/OutputStream 将 MultipartFile 转换成 File</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">uploading</span><span class="params">(@RequestParam(<span class="string">"file"</span>)</span> MultipartFile file, String otherFiled) </span>&#123;&#125;</span><br><span class="line">    <span class="comment">// 2.使用`List&lt;MultipartFile&gt; files = ((MultipartHttpServletRequest) request).getFiles("file");`获取多个文件</span></span><br><span class="line">    <span class="comment">// 此时User会根据前台参数和User类的set方法自动填充(调用的是User类的set方法)，前端可以使用js对象FormData进行文件和普通参数的传输，请求类型仍然为 multipart/form-data</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(path = <span class="string">"/editUser"</span>, method = RequestMethod.POST)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">editUser</span><span class="params">(HttpServletRequest request, User user, @RequestParam(<span class="string">"hello"</span>)</span> String hello) </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; result = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"hello = "</span> + hello); <span class="comment">// hello world</span></span><br><span class="line">        System.out.println(<span class="string">"user.getName() = "</span> + user.getName()); <span class="comment">// smalle</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 为了获取文件项。或者使用Spring提供的MultipartFile进行文件接收</span></span><br><span class="line">            Collection&lt;Part&gt; parts = request.getParts();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// part中包含了所有数据(参数和文件)</span></span><br><span class="line">            <span class="keyword">for</span> (Part part: parts) &#123;</span><br><span class="line">                String originName = part.getSubmittedFileName(); <span class="comment">// 上传文件对应的文件名</span></span><br><span class="line">                System.out.println(<span class="string">"originName = "</span> + originName);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(<span class="keyword">null</span> != originName) &#123;</span><br><span class="line">                    <span class="comment">// 此part为文件</span></span><br><span class="line">                    InputStream inputStream = part.getInputStream();</span><br><span class="line">                    <span class="comment">// ...</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;  <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 必须要实现 Serializable 接口</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Order</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> BigDecimal feeAmount;</span><br><span class="line">    <span class="keyword">private</span> LocalDateTime createTm; <span class="comment">// LocalDateTime格式化参考 [springboot.md#请求参数字段映射](/_posts/java/springboot.md#请求参数字段映射)</span></span><br><span class="line">    <span class="keyword">private</span> MultipartFile file; <span class="comment">// 也可获取到文件，下同</span></span><br><span class="line">    <span class="keyword">private</span> String filePath; <span class="comment">// 用于保存文件后，回传文件路径</span></span><br><span class="line">    List&lt;OrderItem&gt; items; <span class="comment">// OrderItem 略</span></span><br><span class="line">    <span class="keyword">private</span> MultipartFile[] files;</span><br><span class="line">    <span class="keyword">private</span> List&lt;MultipartFile&gt; fileList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="文件下载案例"><a href="#文件下载案例" class="headerlink" title="文件下载案例"></a>文件下载案例</h3><ul><li>前台代码</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义下载的axios实例，并附加到vue原型上</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> download = <span class="function">(<span class="params">url, params</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> axios.create(&#123;</span><br><span class="line">    baseURL: baseUrl,</span><br><span class="line">    timeout: <span class="number">1000</span> * <span class="number">60</span> * <span class="number">3</span>,</span><br><span class="line">    headers: &#123;</span><br><span class="line">      <span class="string">'Authorization'</span>: getToken()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;).request(&#123;</span><br><span class="line">    url: url,</span><br><span class="line">    method: <span class="string">'post'</span>,</span><br><span class="line">    data: params,</span><br><span class="line">    responseType: <span class="string">'blob'</span> <span class="comment">// 后台返回数据格式为Blob对象(不可变的类文件对象): https://developer.mozilla.org/zh-CN/docs/Web/API/Blob</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">methods: &#123;</span><br><span class="line">    exportData (row) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!row.id) <span class="keyword">return</span></span><br><span class="line">      <span class="keyword">this</span>.$download(<span class="string">"/reportConfiguration/runExport/"</span> + row.id, <span class="keyword">this</span>.searchForm)</span><br><span class="line">        .then(<span class="function">(<span class="params">resp</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">this</span>.downFile2(resp)</span><br><span class="line">          </span><br><span class="line">          <span class="comment">// 方式二</span></span><br><span class="line">          <span class="keyword">let</span> res = resp.data</span><br><span class="line">          <span class="comment">// 如果是普通文本文件则不需要设置type</span></span><br><span class="line">          <span class="keyword">const</span> blob = <span class="keyword">new</span> Blob([res], &#123; <span class="attr">type</span>: <span class="string">'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'</span> &#125;)</span><br><span class="line">          <span class="keyword">this</span>.downFile(blob, row.reportName + <span class="string">".xlsx"</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    downFile (blob, fileName) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">window</span>.navigator.msSaveOrOpenBlob) &#123;</span><br><span class="line">        navigator.msSaveBlob(blob, fileName)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> link = <span class="built_in">document</span>.createElement(<span class="string">'a'</span>)</span><br><span class="line">        link.href = <span class="built_in">window</span>.URL.createObjectURL(blob)</span><br><span class="line">        link.download = fileName</span><br><span class="line">        link.click()</span><br><span class="line">        <span class="built_in">window</span>.URL.revokeObjectURL(link.href)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    downFile2 (res) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!res.headers[<span class="string">'content-disposition'</span>]) &#123;</span><br><span class="line">          <span class="keyword">var</span> reader = <span class="keyword">new</span> FileReader()</span><br><span class="line">          reader.onload = <span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> content = reader.result</span><br><span class="line">            <span class="keyword">this</span>.$Message.error(<span class="built_in">JSON</span>.parse(content).metaMessage)</span><br><span class="line">            <span class="keyword">this</span>.exportDocumentsLoading = <span class="literal">false</span></span><br><span class="line">          &#125;</span><br><span class="line">          reader.readAsText(res.data)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> fileName = res.headers[<span class="string">'content-disposition'</span>].split(<span class="string">'='</span>)[<span class="number">1</span>]</span><br><span class="line">          <span class="keyword">const</span> data = res.data</span><br><span class="line">          <span class="comment">// 视情况</span></span><br><span class="line">          <span class="keyword">const</span> url = <span class="built_in">window</span>.URL.createObjectURL(<span class="keyword">new</span> Blob([data], &#123; <span class="attr">type</span>: <span class="string">'application/zip'</span> &#125;))</span><br><span class="line">          <span class="keyword">const</span> link = <span class="built_in">document</span>.createElement(<span class="string">'a'</span>)</span><br><span class="line">          link.style.display = <span class="string">'none'</span></span><br><span class="line">          link.href = url</span><br><span class="line">          link.setAttribute(<span class="string">'download'</span>, fileName)</span><br><span class="line">          <span class="built_in">document</span>.body.appendChild(link)</span><br><span class="line">          link.click()</span><br><span class="line">          URL.revokeObjectURL(link.href)</span><br><span class="line">          <span class="built_in">document</span>.body.removeChild(link)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>后端代码</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/runExport/&#123;id&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runExport</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> Integer id, @RequestBody Map&lt;String, Object&gt; params, HttpServletResponse response) </span>&#123;</span><br><span class="line">    String fileName = reportConfiguration.getReportName() + <span class="string">"_"</span> + System.currentTimeMillis() + <span class="string">".xls"</span>;</span><br><span class="line">    response.setContentType(<span class="string">"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=utf-8"</span>);</span><br><span class="line">    response.setHeader(<span class="string">"Content-Disposition"</span>,<span class="string">"attachment;filename="</span>+ fileName +<span class="string">".xlsx"</span>);</span><br><span class="line"></span><br><span class="line">    OutputStream os = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">byte</span>[] body = ...</span><br><span class="line"></span><br><span class="line">        os = response.getOutputStream();</span><br><span class="line">        os.write(body);</span><br><span class="line">        os.flush();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(os != <span class="keyword">null</span>) &#123;</span><br><span class="line">            os.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="基于commons-fileupload上传文件"><a href="#基于commons-fileupload上传文件" class="headerlink" title="基于commons.fileupload上传文件"></a>基于commons.fileupload上传文件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取上传文件及表单其他字段</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, Object&gt; <span class="title">getData</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    Map&lt;String, Object&gt; retMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断enctype属性是否为multipart/form-data</span></span><br><span class="line">    <span class="comment">// boolean isMultipart = ServletFileUpload.isMultipartContent(request);</span></span><br><span class="line">    <span class="comment">// org.apache.commons.fileupload.disk.DiskFileItemFactory;</span></span><br><span class="line">    DiskFileItemFactory factory = <span class="keyword">new</span> DiskFileItemFactory();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当上传文件太大时，因为虚拟机能使用的内存是有限的，所以此时要通过临时文件来实现上传文件的保存，此方法是设置是否使用临时文件的临界值（单位：字节）   </span></span><br><span class="line">    factory.setSizeThreshold(<span class="number">1024</span>*<span class="number">1024</span>);</span><br><span class="line">    <span class="comment">// 与上一个结合使用，设置临时文件的路径（绝对路径） </span></span><br><span class="line">    File tempFolderFile = <span class="keyword">new</span> File(<span class="string">"/tmp"</span>);</span><br><span class="line">    <span class="keyword">if</span>(!tempFolderFile.isDirectory()) &#123;</span><br><span class="line">        tempFolderFile.mkdirs();</span><br><span class="line">    &#125;</span><br><span class="line">    factory.setRepository(tempFolderFile);  </span><br><span class="line"></span><br><span class="line">    <span class="comment">// org.apache.commons.fileupload.servlet.ServletFileUpload;</span></span><br><span class="line">    ServletFileUpload upload = <span class="keyword">new</span> ServletFileUpload(factory);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 设置上传内容的大小限制（单位：字节） </span></span><br><span class="line">    <span class="comment">// upload.setSizeMax(yourMaxRequestSize); </span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        List&lt;?&gt; items = upload.parseRequest(request);</span><br><span class="line">        Iterator&lt;?&gt; iter = items.iterator();  </span><br><span class="line">        <span class="keyword">while</span> (iter.hasNext()) &#123;  </span><br><span class="line">            FileItem item = (FileItem) iter.next();  </span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (item.isFormField()) &#123;  </span><br><span class="line">                <span class="comment">// 如果是普通表单字段  </span></span><br><span class="line">                String name = item.getFieldName();  </span><br><span class="line">                String value = item.getString();  </span><br><span class="line">                retMap.put(name, value);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                <span class="comment">// 如果是文件字段/列名(可直接读流)</span></span><br><span class="line">                String fileName = item.getName();</span><br><span class="line">                File file1 = <span class="keyword">new</span> File(<span class="string">"/home/test/"</span> + fileName);</span><br><span class="line">                item.write(file1);</span><br><span class="line">                retMap.put(<span class="string">"file1"</span>, file1);</span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;  </span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> retMap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="模拟Form提交下载文件"><a href="#模拟Form提交下载文件" class="headerlink" title="模拟Form提交下载文件"></a>模拟Form提交下载文件</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">submitForm (row) &#123;</span><br><span class="line">    <span class="keyword">let</span> form = <span class="built_in">document</span>.createElement(<span class="string">'form'</span>)</span><br><span class="line">    form.action = <span class="string">'http://localhost:8080/test/download'</span></span><br><span class="line">    form.method = <span class="string">'post'</span></span><br><span class="line">    <span class="keyword">let</span> inputOne = <span class="built_in">document</span>.createElement(<span class="string">'input'</span>)</span><br><span class="line">    inputOne.type = <span class="string">'hidden'</span></span><br><span class="line">    inputOne.name = <span class="string">'id'</span></span><br><span class="line">    inputOne.value = row.id</span><br><span class="line">    <span class="comment">// 多个参数可继续添加</span></span><br><span class="line">    form.appendChild(inputOne)</span><br><span class="line">    <span class="built_in">document</span>.body.appendChild(form)</span><br><span class="line">    <span class="comment">// 后台response设置ContentType,Header(Content-Disposition)将文件直接以流写出；此时提交后会自动下载文件</span></span><br><span class="line">    form.submit()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h2><h3 id="用户浏览器缓存问题"><a href="#用户浏览器缓存问题" class="headerlink" title="用户浏览器缓存问题"></a>用户浏览器缓存问题</h3><ul><li>浏览器缓存包括强制缓存、协商缓存 <a href="https://blog.csdn.net/qq_32340877/article/details/80338271" title="使用vue框架开发，版本更新，解决用户浏览器缓存问题" target="_blank" rel="noopener">^5</a></li><li>浏览器在请求某一资源时，会先获取该资源缓存的header信息，判断是否命中强缓存(<code>Cache-control</code>和<code>expires</code>信息)<ul><li>若命中直接从缓存中获取资源信息，包括缓存header信息。本次请求根本就不会与服务器进行通信(显示<code>200 OK (from disk/memory cache)</code>)</li><li>若没有命中强缓存<ul><li>浏览器会发送请求到服务器，请求会携带第一次请求返回的有关缓存的header字段信息(<code>Last-Modified/If-Modified-Since</code>和<code>Etag/If-None-Match</code>)，由服务器根据请求中的相关header信息来比对结果是否协商缓存命中<ul><li>若命中，则服务器返回新的响应header信息更新缓存中的对应header信息，但是并不返回资源内容，它会告知浏览器可以直接从缓存获取(状态码<code>304</code>)</li><li>否则返回最新的资源内容(状态码<code>200</code>)</li></ul></li></ul></li></ul></li><li>强制缓存由<code>Expires</code>和<code>Cache-Control</code>控制<ul><li><code>Pragma和Expires</code>(HTTP 1.0) 控制缓存开关的字段有两个<ul><li>Pragma的值为no-cache时，表示禁用缓存</li><li>Expires：response header里的过期时间，浏览器再次加载资源时，如果在这个过期时间内，则命中强缓存</li></ul></li><li><code>Cache-Control</code>(HTTP 1.1)<ul><li>当值设为max-age=300时，则代表在这个请求正确返回时间的5分钟内再次加载资源，就会命中强缓存</li><li>Cache-control其他常用的设置值(haeder中可包含多个Cache-control)<ul><li><code>no-cache</code>：<strong>不使用本地缓存，但是需要使用协商缓存</strong></li><li><code>no-store</code>：直接禁止浏览器缓存数据，每次用户请求该资源，都会向服务器发送一个请求，每次都会下载完整的资源</li><li><code>public</code>：可以被所有的用户缓存，包括终端用户和CDN等中间代理服务器</li><li><code>private</code>：只能被终端用户的浏览器缓存，不允许CDN等中继缓存服务器对其缓存</li></ul></li></ul></li><li><code>Expires</code>和<code>max-age</code><ul><li><code>Expires = 时间</code>，HTTP 1.0 版本，缓存的载止时间，允许客户端在这个时间之前不去检查(发请求)</li><li><code>Cache-Control: max-age = 秒</code>，HTTP 1.1版本，资源在本地缓存多少秒，此时<code>Expires = max-age + &quot;每次下载时的当前的request时间&quot;</code>。主要解决Expires表示的是时间，但是服务器和客户端之前的时间可能相差很大</li><li>如果max-age和Expires同时存在，则Expires被Cache-Control的max-age覆盖</li></ul></li></ul></li><li><p>协商缓存由<code>Etag/If-None-Match</code>、<code>Last-Modified/If-Modified-Since</code>控制，流程及相关字段说明如下 <a href="https://juejin.im/post/5c09cbb1f265da617006ee83" target="_blank" rel="noopener">^9</a></p><p> <img src="/data/images/arch/web-cache.png" alt="web-cache"></p><ul><li><code>Last-Modified/If-Modified-Since</code><ul><li>当浏览器第一次请求一个url时，服务器端的返回状态码为200，同时HTTP响应头会有一个Last-Modified标记着文件在服务器端最后被修改的时间</li><li>浏览器第二次请求上次请求过的url时，浏览器会在HTTP请求头添加一个If-Modified-Since的标记，用来询问服务器该时间之后文件是否被修改过</li></ul></li><li><code>Etag/If-None-Match</code><ul><li>当浏览器第一次请求一个url时，服务器端的返回状态码为200，同时HTTP响应头会有一个Etag，存放着服务器端生成的一个序列值</li><li>浏览器第二次请求上次请求过的url时，浏览器会在HTTP请求头添加一个If-None-Match的标记</li></ul></li><li>Etag 主要为了解决 Last-Modified 无法解决的一些问题<ul><li>Etag的值通常为文件内容的哈希值；而Last-Modified为最后修改的时间</li><li>Last-Modified只能精确到秒，秒之内的内容更新Etag才能检测</li><li>Etag每次服务端生成都需要进行读写操作，而Last-Modified只需要读取操作，Etag的消耗是更大的</li></ul></li></ul></li><li>缓存特殊值说明<ul><li><code>response no-cahce</code>并不是表示无缓存，而是指使用缓存一定要先经过验证</li><li><code>response header</code>的<code>no-cache</code>、<code>max-age=0</code>和<code>request header</code>的<code>max-age=0</code>的作用是一样的：都要求在使用缓存之前进行验证</li><li><code>request header</code>的<code>no-cache</code>，则表示要重新获取请求，其作用类似于<code>no-store</code></li></ul></li><li>用户操作与缓存<ul><li>地址栏回车、页面链接跳转、新窗口打开、前进后退：Expires/Cache-Control、Last-Modified/Etag均可正常缓存</li><li><code>F5</code>刷新：仅Expires/Cache-Control无法正常缓存</li><li><code>Ctrl+F5</code>强制刷新：Expires/Cache-Control、Last-Modified/Etag均无法正常缓存</li></ul></li><li><p>nginx 配置，让vue项目的index.html不缓存</p><ul><li><p>vue-cli里的默认配置，css和js的名字都加了哈希值，所以新版本css、js和就旧版本的名字是不同的，只要index.html不被缓存，则css、js不会有缓存问题</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment"># 推荐</span></span><br><span class="line"> location / &#123;</span><br><span class="line">   root   /www/dist;</span><br><span class="line">   index  index.html index.htm;</span><br><span class="line">try_files <span class="variable">$uri</span> <span class="variable">$uri</span>/ /index.html;</span><br><span class="line">   </span><br><span class="line">   <span class="comment"># 禁止缓存index.html文件</span></span><br><span class="line">   <span class="keyword">if</span> (<span class="variable">$request_filename</span> ~* .*\.(?:htm|html)$) &#123;</span><br><span class="line">     add_header Cache-Control <span class="string">"private, no-store, no-cache, must-revalidate, proxy-revalidate"</span>;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="comment"># nginx 配置，让index.html不缓存。此处的路径不一定要是index.html，只要某路径A返回的是index.html文件，则此处匹配A路径即可</span></span><br><span class="line"> location = /index.html &#123;</span><br><span class="line">     <span class="comment">#- nginx的expires指令：`expires [time|epoch|max|off(默认)]`。可以控制 HTTP 应答中的Expires和Cache-Control的值</span></span><br><span class="line">     <span class="comment">#   - time控制Cache-Control：负数表示no-cache，正数或零表示max-age=time</span></span><br><span class="line">     <span class="comment">#   - epoch指定Expires的值为`1 January,1970,00:00:01 GMT`</span></span><br><span class="line">     expires -1s; <span class="comment"># 对于不支持http1.1的浏览器，还是需要expires来控制</span></span><br><span class="line">     add_header Cache-Control <span class="string">"no-cache, no-store"</span>; <span class="comment"># 会加在 response headers</span></span><br><span class="line">     <span class="comment"># ...</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></li></ul></li><li><p>设置页面A不进行缓存，直接浏览器访问页面A不会缓存；但是把此页面A以iframe方式嵌入到其他页面B时，A会进行缓存，且Request Header提示<code>Provisional headers are shown</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 在A页面增加meta标签：可正常使用。但是如果之前无此标签，加上此标签后仍然无法让已经缓存的页面(无此meta标签)刷新。只会影响此html的缓存效果，不会影响页面js的 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-Equiv</span>=<span class="string">"Cache-Control"</span> <span class="attr">Content</span>=<span class="string">"no-cache"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-Equiv</span>=<span class="string">"Pragma"</span> <span class="attr">Content</span>=<span class="string">"no-cache"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-Equiv</span>=<span class="string">"Expires"</span> <span class="attr">Content</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 解决方案：未测试成功 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> _time = <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random()*<span class="number">100000</span>)</span></span><br><span class="line"><span class="javascript">    <span class="built_in">document</span>.write(<span class="string">'&lt;iframe src="http://localhost:8080/test.php?_time='</span>+ _time +<span class="string">'"&gt;&lt;iframe&gt;'</span>)</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>出现<code>Provisional headers are shown</code>的常见情况<ul><li>跨域，请求被浏览器拦截</li><li>请求被浏览器插件拦截</li><li>服务器出错或者超时，没有真正的返回</li><li>强缓存from disk cache或者from memory cache，此时也不会显示</li></ul></li></ul></li></ul><h3 id="压缩"><a href="#压缩" class="headerlink" title="压缩"></a>压缩</h3><ul><li>如果前端放在nginx上则需要开启nginx的压缩；如果中间通过了多个nginx，必需开启离用户最近(对外服务器)的服务器的压缩(后面的nginx无所谓)；前后不分离时一般可通过tomcat进行页面压缩</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 开启gzip压缩输出。**启用后响应头中会包含`Content-Encoding: gzip`**</span></span><br><span class="line">    gzip on;</span><br><span class="line">    <span class="comment"># 压缩类型，默认就已经包含text/html(但是vue打包出来的js需要下列定义才会压缩)</span></span><br><span class="line">    gzip_types text/plain application/x-javascript application/javascript text/javascript text/css application/xml text/xml;</span><br><span class="line">    <span class="comment"># 其优先级高于动态的gzip。可通过webapck插件 compression-webpack-plugin 提前将dist文件打包成 .gz 格式，从而减少服务器压缩</span></span><br><span class="line">    gzip_static on;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>Vue首页加载慢问题，一般为<code>main.js</code>打包出来的体积太大，可以考虑减少main.js中的import包</li></ul><h2 id="国际化-时区-币制"><a href="#国际化-时区-币制" class="headerlink" title="国际化/时区/币制"></a>国际化/时区/币制</h2><ul><li>如果是SaaS系统，这3个应该保存到用户配置信息中</li><li>时区<ul><li>时区网站: <a href="https://www.zeitverschiebung.net/cn/" target="_blank" rel="noopener">https://www.zeitverschiebung.net/cn/</a></li><li>修复服务器时区，参考<a href="/_posts/linux/CentOS服务器使用说明.md#新服务器初始化">新服务器初始化</a></li><li>修改数据库时区，参考<a href="/_posts/db/sql-ext.md#日期">日期-时区相关</a><ul><li>方式一: 全部采用TIMESTAMP不含时区进行存储<ul><li>此时，代码中可正常使用sysdate和new Date()，不用转换</li><li>然后，在代码中对接收前台时间数据需做处理，查询数据库也要进行转换后再返回前台</li><li>且sql中将时间转成to_char的时候需要转换时区</li></ul></li><li>方式二: 使用TIMESTAMP WITH LOCAL TIME ZONE<ul><li>此时，保存时数据库会自动将时间转成服务器时区，查询时数据库自动转成客户端session时区</li><li>然后，代码中new Date()需要做处理</li></ul></li></ul></li><li>代码层面处理<ul><li>Java时间说明: <a href="/_posts/java/java-base.md#时间">java-base.md#时间</a></li></ul></li></ul></li></ul><h2 id="后端其他"><a href="#后端其他" class="headerlink" title="后端其他"></a>后端其他</h2><h3 id="Bean名称冲突"><a href="#Bean名称冲突" class="headerlink" title="Bean名称冲突"></a>Bean名称冲突</h3><ul><li>解决方法<ul><li><code>@RestController(&quot;myBeanName&quot;)</code>、<code>@Services(&quot;myBeanName&quot;)</code>等方式<ul><li>默认是类名称首字母小写</li><li><code>@RequestMapping</code>映射的URL路径也不能冲突</li></ul></li><li>Mapper对应Bean是mybatis自动生成的(类无需注解@Repository)<ul><li>修改类名称，注入的变量也需要修改(默认bean名称为类名称首字母小写)</li></ul></li></ul></li></ul><h2 id="前端其他"><a href="#前端其他" class="headerlink" title="前端其他"></a>前端其他</h2><ul><li>使用nginx导致部分地址直接浏览器访问报404(如基于<code>quasar</code>的项目)。可修改nginx配置如下</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 本地查找，如果没有就跳转到index.html(实际访问的还是源地址)</span></span><br><span class="line">location / &#123;</span><br><span class="line">	try_files <span class="variable">$uri</span> <span class="variable">$uri</span>/ /index.html;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Vue去掉-号"><a href="#Vue去掉-号" class="headerlink" title="Vue去掉#号"></a>Vue去掉#号</h3><ul><li>路由使用history模式。参考<a href="/_posts/web/vue.md#hash和history路由模式">hash和history路由模式</a></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> Router(&#123;</span><br><span class="line">    mode: <span class="string">'history'</span>, <span class="comment">// H5新特性，需要浏览器支持：https://developer.mozilla.org/zh-CN/docs/Web/API/History</span></span><br><span class="line">    routes: []</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><ul><li>可配合nginx(后端)，开发vue时的静态服务器默认支持去掉<code>#</code>号</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    try_files <span class="variable">$uri</span> <span class="variable">$uri</span>/ /index.html;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Vue多项目配置"><a href="#Vue多项目配置" class="headerlink" title="Vue多项目配置"></a>Vue多项目配置</h3><ul><li><strong>路由使用hash模式和history模式均可</strong>，参考 <a href="/_posts/web/vue.md#hash和history路由模式">hash和history路由模式</a></li><li>vue.config.js，参考<a href="/_posts/web/vue.md#vue-cli%20v3">vue-cli v3</a> <a href="https://juejin.im/post/5cfe23b3e51d4556f76e8073" target="_blank" rel="noopener">^7</a></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    baseUrl: process.env.NODE_ENV === <span class="string">'production'</span> ? <span class="string">'/'</span> : <span class="string">'/'</span>,</span><br><span class="line">    <span class="comment">// 表示index.html中引入的静态文件地址。如生成 `/my-app/js/app.28dc7003.js`</span></span><br><span class="line">    publicPath: <span class="string">'/my-app/'</span>, <span class="comment">// 多环境配置时可自定义变量(VUE_APP_BASE_URL = /my-app/)到 .env.xxx 文件中，如：publicPath: process.env.VUE_APP_VUE_ROUTER_BASE</span></span><br><span class="line">    <span class="comment">// 打包后的文件生成在此项目的my-app根文件夹。一般是把此文件夹下的文件(index.html和一些静态文件)放到服务器 www 目录，此时多项目需要放到 /www/my-app 目录下</span></span><br><span class="line">    outputDir: <span class="string">'my-app-dist'</span>, <span class="comment">// 也可以是其他命名，但是最终要把index.html放在服务器的 /www/my-app-dist 目录下</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>router/index.js (非必须)</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> Router(&#123;</span><br><span class="line">    <span class="comment">// 路由的基础路径，类似publicPath。只不过publicPath是针对静态文件，而此处是将&lt;router-link&gt;中的路径添加此基础路径</span></span><br><span class="line">    base: <span class="string">'/my-app/'</span>, <span class="comment">// 多环境配置时可自定义变量(VUE_APP_BASE_URL = /my-app/)到 .env.xxx 文件中，如：publicPath: process.env.VUE_APP_VUE_ROUTER_BASE</span></span><br><span class="line">    <span class="comment">// mode: 'history', // H5新特性，需要浏览器支持；***hash模式也支持多项目***</span></span><br><span class="line">    routes: []</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><ul><li>nginx</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 此处的两个my-app需要和上文的base、publicPath保持一致</span></span><br><span class="line">location = /my-app &#123;</span><br><span class="line">    rewrite . http://<span class="variable">$server_name</span>/my-app/ <span class="built_in">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">location ^~ /my-app/ &#123;</span><br><span class="line">    <span class="comment"># 在/www目录放项目文件夹my-app(index.html在此文件夹根目录)。只能用于 outputDir 和 publicPath 一致的情况</span></span><br><span class="line">    <span class="comment"># root /www;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果 outputDir 和 publicPath 不一致，则此处需使用alias；如果一致也可使用root</span></span><br><span class="line">    <span class="built_in">alias</span> /www/my-app-dist/;</span><br><span class="line"></span><br><span class="line">    try_files <span class="variable">$uri</span> <span class="variable">$uri</span>/ /my-app/index.html;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># index  index.html index.htm; # hash模式</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 禁止缓存index.html文件</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$request_filename</span> ~* .*\.(?:htm|html)$) &#123;</span><br><span class="line">        add_header Cache-Control <span class="string">"private, no-store, no-cache, must-revalidate, proxy-revalidate"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>浏览器访问<code>http://localhost/my-app/</code></li></ul><h3 id="https路径"><a href="#https路径" class="headerlink" title="https路径"></a>https路径</h3><ul><li>浏览器使用的协议(http/https)必须和请求后台的协议一致，否则Chrome进行拦截掉了</li><li>静态资源使用<code>//aezo.cn/xxx</code>，它会判断当前的页面协议是http还是https来决定资源请求url的协议，可用于处理网站使用的协议和网页中请求的外网资源不一致的问题</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"//aezo.cn/images/jquery/jquery-1.10.2.min.js"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- &lt;script src="/images/jquery/jquery-1.10.2.min.js" type="text/javascript"&gt;&lt;/script&gt; --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"//aezo.cn/umetro/maincss.css"</span> <span class="attr">type</span>=<span class="string">"text/css"</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- &lt;link rel="stylesheet" href="/umetro/maincss.css" type="text/css"/&gt; --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="css"><span class="selector-class">.my-img</span> &#123; </span></span><br><span class="line"><span class="undefined">    background: url(//aezo.cn/images/smalle.jpg);</span></span><br><span class="line"><span class="css">    <span class="comment">/* background: url(/images/smalle.jpg); */</span></span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>js中使用<code>//aezo.cn/api</code>进行动态请求后端地址，会动态获取document的协议</li><li>或者使用 <code>window.location.protocol + &#39;//aezo.cn/api&#39;</code> 得到完整地址，如微信网页授权需要将重定向地址当成参数传递，则应该传入完整地址</li></ul><h3 id="页面弹框管理"><a href="#页面弹框管理" class="headerlink" title="页面弹框管理"></a>页面弹框管理</h3><ul><li>基于发布订阅+后台统一管理弹框显隐逻辑 <a href="https://github.com/accforgit/blog-data/tree/master/%E8%B7%9F%E6%B7%B7%E4%B9%B1%E7%9A%84%E9%A1%B5%E9%9D%A2%E5%BC%B9%E7%AA%97%E8%AF%B4%E5%86%8D%E8%A7%81" target="_blank" rel="noopener">https://github.com/accforgit/blog-data/tree/master/%E8%B7%9F%E6%B7%B7%E4%B9%B1%E7%9A%84%E9%A1%B5%E9%9D%A2%E5%BC%B9%E7%AA%97%E8%AF%B4%E5%86%8D%E8%A7%81</a></li></ul><h3 id="项目打包后动态修改配置文件"><a href="#项目打包后动态修改配置文件" class="headerlink" title="项目打包后动态修改配置文件"></a>项目打包后动态修改配置文件</h3><ul><li>抽取单独的config.js: <a href="https://blog.csdn.net/mygoes/article/details/105691399" target="_blank" rel="noopener">https://blog.csdn.net/mygoes/article/details/105691399</a></li><li>提供运维人员脚本生成config.js: <a href="https://blog.csdn.net/samberina/article/details/122110027" target="_blank" rel="noopener">https://blog.csdn.net/samberina/article/details/122110027</a></li><li>后端为node时，将前端设置为服务端渲染：<a href="https://blog.csdn.net/samberina/article/details/122110253" target="_blank" rel="noopener">https://blog.csdn.net/samberina/article/details/122110253</a></li></ul><h3 id="前端常用插件"><a href="#前端常用插件" class="headerlink" title="前端常用插件"></a>前端常用插件</h3><ul><li>参考<a href="/_posts/web/node-dev-tools.md">node-dev-tools.md</a></li><li>参考<a href="/_posts/web/js-tools.md">js-tools.md</a></li></ul><h3 id="前端其他-1"><a href="#前端其他-1" class="headerlink" title="前端其他"></a>前端其他</h3><ul><li>避免输入中文拼音时触发input事件<ul><li>使用input + compositionstart + compositionend. 参考: <a href="https://blog.csdn.net/owo_ovo/article/details/136949288" target="_blank" rel="noopener">https://blog.csdn.net/owo_ovo/article/details/136949288</a></li></ul></li></ul><h2 id="移动端其他"><a href="#移动端其他" class="headerlink" title="移动端其他"></a>移动端其他</h2><h3 id="常用图片尺寸"><a href="#常用图片尺寸" class="headerlink" title="常用图片尺寸"></a>常用图片尺寸</h3><ul><li>微信小程序分享图: 750*1334 (9:16)</li></ul><h2 id="常用脚本"><a href="#常用脚本" class="headerlink" title="常用脚本"></a>常用脚本</h2><ul><li>通过脚本部署项目(deploy.sh)</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置源服务器信息</span></span><br><span class="line">host=<span class="variable">$CORP_AL_JAVA_HOST</span></span><br><span class="line">username=<span class="variable">$CORP_AL_JAVA_USERNAME</span></span><br><span class="line">ssh_file=<span class="variable">$CORP_AL_JAVA_SSH_FILE</span></span><br><span class="line">dir=<span class="variable">$CORP_AL_JAVA_RT_DIR</span></span><br><span class="line">now=`date +%Y%m%d%H%M%S`</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打包</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"=====&gt; build docs..."</span></span><br><span class="line">npm run build:docs</span><br><span class="line"></span><br><span class="line"><span class="comment"># 备份目录</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"=====&gt; backup file..."</span></span><br><span class="line">expect&lt;&lt;-EOF</span><br><span class="line">  spawn ssh -i <span class="variable">$ssh_file</span> <span class="variable">$&#123;username&#125;</span>@<span class="variable">$&#123;host&#125;</span></span><br><span class="line">  expect <span class="string">"]$ "</span></span><br><span class="line">  send <span class="string">"cp -r <span class="variable">$dir</span>/dist <span class="variable">$dir</span>/dist.<span class="variable">$now</span>\r"</span></span><br><span class="line">  expect <span class="string">"]$ "</span></span><br><span class="line">  send <span class="string">"rm -rf <span class="variable">$dir</span>/dist\r"</span></span><br><span class="line">  expect <span class="string">"]$ "</span></span><br><span class="line">  send <span class="string">"exit\r"</span></span><br><span class="line">  expect eof</span><br><span class="line">  <span class="comment"># 将命令行交还给用户</span></span><br><span class="line">  <span class="comment"># interact</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 上传文件</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"=====&gt; upload file..."</span></span><br><span class="line">scp -i <span class="variable">$ssh_file</span> -r docs/.vuepress/dist <span class="variable">$username</span>@<span class="variable">$host</span>:<span class="variable">$dir</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"=====&gt; deploy end..."</span></span><br><span class="line"></span><br><span class="line">:&lt;&lt;COMMENTBLOCK</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">'注释代码块，不会打印'</span></span><br><span class="line">COMMENTBLOCK</span><br></pre></td></tr></table></figure><h2 id="浏览器"><a href="#浏览器" class="headerlink" title="浏览器"></a>浏览器</h2><h3 id="常见兼容性问题"><a href="#常见兼容性问题" class="headerlink" title="常见兼容性问题"></a>常见兼容性问题</h3><ul><li>Chrome和Firefox查看请求结果时preview和response显示数据不一致问题 <a href="https://www.oschina.net/question/2405524_2154029?sort=time" target="_blank" rel="noopener">^6</a><ul><li>原因可能是因为数据为Long型，返回给浏览器以后，浏览器转换数据格式的时候出现问题。解决方案：在返回数据之前就将数据转换为字符串</li></ul></li><li>Chrome 84默认启用了SameSite=Lax属性 <a href="https://web.dev/samesite-cookies-explained/" target="_blank" rel="noopener">^11</a><ul><li>SameSite 可取值: Strict (所有情况都不发送Cookies给第三方)、Lax (少部分情况发送)、None (发送，但是必须设置Secure属性，即需要为HTTPS访问)</li><li>如果A网页嵌入B网页时，用户打开A网页。如A与B属于同一域名，则B网站可在（前后端）对Cookies进行操作，也可传递(B网页下的)Cookies给B后端；如果不是，则认为B网站为第三方页面，此时只对其开放部分情况（如a标签跳转、get类型的form提交）的Cookies传递</li><li>Cookies参数说明<ul><li>HttpOnly 只能通过HTTP访问Cookie, 如果设置成true后则无法通过 JavaScript 等客户端脚本读取和传递</li><li>Secure 只能通过Https访问</li><li>SameSite 如上文</li></ul></li></ul></li></ul><h2 id="设计"><a href="#设计" class="headerlink" title="设计"></a>设计</h2><ul><li>免费商用中文字体：<a href="https://zhuanlan.zhihu.com/p/640840656" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/640840656</a></li></ul><h2 id="思维"><a href="#思维" class="headerlink" title="思维"></a>思维</h2><ul><li>由于某些原因，需对学生信息，复制出一条数据出来，并打上新数据的标记(在学生表中，同一学生，会有两条数据，除了ID和此标记，其他字段要求一致)。增删查改时，如何修改其中一条数据时，也同步另外一条数据<ul><li>解决：查询时根据学号将两个ID同时返回到前台，然后基于ID修改</li></ul></li></ul><h3 id="接口设计原则"><a href="#接口设计原则" class="headerlink" title="接口设计原则"></a>接口设计原则</h3><ul><li>假设A系统调用B系统</li><li>全部是查询接口则很简单</li><li>如果存在增删改数据，则一般需要有撤销接口/修改后结果查询</li><li>解决执行超时/网络超时<ul><li>请求增加请求流水号参数<ul><li>B系统(单机)<ul><li>进入方法，先判断内存中是否存在此流水号，存在则返回正在执行中</li><li>不存在，则将流水号记录到内存</li><li>再判断表中是否存在，存在则报错(不允许重复请求)，不存在则正常执行</li><li>执行完成后finally将流水号移除</li><li>此执行最好设置成超时线程，一定时间没执行成功则报错，防止AB系统无限制调用</li></ul></li><li>A系统<ul><li>请求设置超时时间，如果超时则用同一流水号继续请求，直到返回结果(成功 | 重复请求)</li><li>如果返回正在执行，可考虑重复请求，或者调用查询接口是否请求操作成功</li></ul></li><li>此模式需要一直调用直到有结果，如何探知B系统是否还在继续执行，或者打断其执行<ul><li>B系统设置执行超时机制</li></ul></li></ul></li></ul></li></ul><hr><p>参考文章</p></div><div></div><div></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> smalle</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="http://blog.aezo.cn/2017/12/25/arch/springboot-vue/" title="基于Springboot和Vue前后分离">http://blog.aezo.cn/2017/12/25/arch/springboot-vue/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/vue/" rel="tag"># vue</a> <a href="/tags/springboot/" rel="tag"># springboot</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2017/12/12/java/java-base/" rel="next" title="Java基础"><i class="fa fa-chevron-left"></i> Java基础</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"> <a href="/2017/12/26/lang/regex/" rel="prev" title="正则(Regex)">正则(Regex)<i class="fa fa-chevron-right"></i></a></div></div></footer></article><div class="post-spread"><div> <a target="_blank" href="https://github.com/oldinaction/ChatGPT-MP"><img class="nofancybox" style="width:300px;margin:0 auto" src="https://cdn7.aezo.cn/one/chat/chat-gpt-open-banner.jpg" alt="ChatGPT开源小程序" title="ChatGPT开源小程序"></a></div></div></div></div><div class="comments" id="comments"></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> 文章目录</li><li class="sidebar-nav-overview" data-target="site-overview"> 站点概览</li></ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="https://avatars0.githubusercontent.com/u/15698218?v=3&u=ce740bf0b67ff0d74990ba6fc644d6e92f572dcb&s=400" alt="smalle"><p class="site-author-name" itemprop="name">smalle</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">168</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/index.html"><span class="site-state-item-count">14</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/index.html"><span class="site-state-item-count">153</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"></div><div> 欢迎关注公众号：阿壹族 <img class="nofancybox" style="width:120px;margin:0 auto" src="https://cdn7.aezo.cn/common/qrcode/ayz_qrcode.jpg" alt="欢迎关注公众号：阿壹族" title="欢迎关注公众号：阿壹族"></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#默认配置"><span class="nav-number">1.</span> <span class="nav-text">默认配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Spring"><span class="nav-number">2.</span> <span class="nav-text">Spring</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Mybatis"><span class="nav-number">3.</span> <span class="nav-text">Mybatis</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Token相关"><span class="nav-number">4.</span> <span class="nav-text">Token相关</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#跨域和session"><span class="nav-number">5.</span> <span class="nav-text">跨域和session</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#http-https"><span class="nav-number">5.1.</span> <span class="nav-text">http/https</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#同源政策"><span class="nav-number">5.2.</span> <span class="nav-text">同源政策</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#跨域通信"><span class="nav-number">5.3.</span> <span class="nav-text">跨域通信</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#跨域资源共享-CORS-Cross-origin-resource-sharing-1"><span class="nav-number">5.4.</span> <span class="nav-text">跨域资源共享(CORS, Cross-origin resource sharing) ^1</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#SpringBoot解决跨域"><span class="nav-number">5.4.1.</span> <span class="nav-text">SpringBoot解决跨域</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SpringSecurity的cors配置"><span class="nav-number">5.4.2.</span> <span class="nav-text">SpringSecurity的cors配置</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#iframe相关问题"><span class="nav-number">5.5.</span> <span class="nav-text">iframe相关问题</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Http请求及响应"><span class="nav-number">6.</span> <span class="nav-text">Http请求及响应</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#文件上传案例"><span class="nav-number">6.1.</span> <span class="nav-text">文件上传案例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#文件下载案例"><span class="nav-number">6.2.</span> <span class="nav-text">文件下载案例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#基于commons-fileupload上传文件"><span class="nav-number">6.3.</span> <span class="nav-text">基于commons.fileupload上传文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#模拟Form提交下载文件"><span class="nav-number">6.4.</span> <span class="nav-text">模拟Form提交下载文件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#性能优化"><span class="nav-number">7.</span> <span class="nav-text">性能优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#用户浏览器缓存问题"><span class="nav-number">7.1.</span> <span class="nav-text">用户浏览器缓存问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#压缩"><span class="nav-number">7.2.</span> <span class="nav-text">压缩</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#国际化-时区-币制"><span class="nav-number">8.</span> <span class="nav-text">国际化/时区/币制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#后端其他"><span class="nav-number">9.</span> <span class="nav-text">后端其他</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Bean名称冲突"><span class="nav-number">9.1.</span> <span class="nav-text">Bean名称冲突</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#前端其他"><span class="nav-number">10.</span> <span class="nav-text">前端其他</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Vue去掉-号"><span class="nav-number">10.1.</span> <span class="nav-text">Vue去掉#号</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Vue多项目配置"><span class="nav-number">10.2.</span> <span class="nav-text">Vue多项目配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#https路径"><span class="nav-number">10.3.</span> <span class="nav-text">https路径</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#页面弹框管理"><span class="nav-number">10.4.</span> <span class="nav-text">页面弹框管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#项目打包后动态修改配置文件"><span class="nav-number">10.5.</span> <span class="nav-text">项目打包后动态修改配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#前端常用插件"><span class="nav-number">10.6.</span> <span class="nav-text">前端常用插件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#前端其他-1"><span class="nav-number">10.7.</span> <span class="nav-text">前端其他</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#移动端其他"><span class="nav-number">11.</span> <span class="nav-text">移动端其他</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#常用图片尺寸"><span class="nav-number">11.1.</span> <span class="nav-text">常用图片尺寸</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#常用脚本"><span class="nav-number">12.</span> <span class="nav-text">常用脚本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#浏览器"><span class="nav-number">13.</span> <span class="nav-text">浏览器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#常见兼容性问题"><span class="nav-number">13.1.</span> <span class="nav-text">常见兼容性问题</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#设计"><span class="nav-number">14.</span> <span class="nav-text">设计</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#思维"><span class="nav-number">15.</span> <span class="nav-text">思维</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#接口设计原则"><span class="nav-number">15.1.</span> <span class="nav-text">接口设计原则</span></a></li></ol></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright"> &copy; 2016 - <span itemprop="copyrightYear">2025</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">smalle</span>&nbsp;&nbsp;&nbsp;&nbsp;<div class="powered-by"> 由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div><div class="powered-by"> 主题 - <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a></div><div class="theme-info"> <a class="theme-link" target="_blank" href="https://tongji.baidu.com/main/overview/10000542408/overview/index?siteId=18991897">站长统计</a></div></div><div class="ad"> <span style="font-weight:700">AD&nbsp;&nbsp;&nbsp;&nbsp;</span><div class="theme-info"> <a target="_blank" href="https://promotion.aliyun.com/ntms/yunparter/invite.html?userCode=oby5nolb">阿里云大礼包</a></div></div><div class="aezocn"> <span style="font-weight:700">&copy;AEZO.CN&nbsp;&nbsp;&nbsp;&nbsp;</span><div class="powered-by"> <a target="_blank" href="https://shengqitech.aezo.cn/">圣骑科技</a></div><div class="powered-by"> <a target="_blank" href="https://cdn7.aezo.cn/common/qrcode/one_qrcode.jpg">【One能抽屉】小程序</a></div><div class="theme-info"> <a target="_blank" href="http://shop.aezo.cn/">杂货铺(省钱小助手)</a></div></div><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?085f9cd91ef2ad985f791c677472f0d1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script><script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script type="text/javascript" src="/js/src/js.cookie.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/scroll-cookie.js?v=5.1.1"></script></body></html>