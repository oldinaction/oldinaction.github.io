<!doctype html><html class="theme-next mist use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css"><meta name="keywords" content="lang,linux,shell,"><link rel="alternate" href="/atom.xml" title="月星墙的博客" type="application/atom+xml"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1"><meta name="description" content="简介 shell是解释性语言，解释器如bash、sh Shell教程  基本语法基本概念 程序有两类返回值：执行结果、执行状态(即 $? 的值，0 表示正确，1-255 错误)  特殊符号 注释：#单行注释，&amp;lt;&amp;lt;COMMENT xxx COMMENT多行注释 linux 引号 反引号：`cmd` 命令替换，类似$(cmd) 双引号: “” 变量替换 单引号：‘’ 字符串   命令替换："><meta name="keywords" content="lang,linux,shell"><meta property="og:type" content="article"><meta property="og:title" content="Shell编程"><meta property="og:url" content="http://blog.aezo.cn/2017/01/10/linux/shell/index.html"><meta property="og:site_name" content="月星墙的博客"><meta property="og:description" content="简介 shell是解释性语言，解释器如bash、sh Shell教程  基本语法基本概念 程序有两类返回值：执行结果、执行状态(即 $? 的值，0 表示正确，1-255 错误)  特殊符号 注释：#单行注释，&amp;lt;&amp;lt;COMMENT xxx COMMENT多行注释 linux 引号 反引号：`cmd` 命令替换，类似$(cmd) 双引号: “” 变量替换 单引号：‘’ 字符串   命令替换："><meta property="og:locale" content="zh-Hans"><meta property="og:updated_time" content="2024-09-26T06:35:59.932Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Shell编程"><meta name="twitter:description" content="简介 shell是解释性语言，解释器如bash、sh Shell教程  基本语法基本概念 程序有两类返回值：执行结果、执行状态(即 $? 的值，0 表示正确，1-255 错误)  特殊符号 注释：#单行注释，&amp;lt;&amp;lt;COMMENT xxx COMMENT多行注释 linux 引号 反引号：`cmd` 命令替换，类似$(cmd) 双引号: “” 变量替换 单引号：‘’ 字符串   命令替换："><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",sidebar:{position:"right",display:"post",offset:12,offset_float:0,b2t:!1,scrollpercent:!1},fancybox:!0,motion:!0,duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"BWD6R9FA4K",apiKey:"3330f3cbaa099dfc30395de5f5b20151",indexName:"blog",hits:{per_page:10},labels:{input_placeholder:"请输入关键字",hits_empty:"我们没有找到任何搜索结果: ${query}",hits_stats:"找到约${hits}条结果（用时${time}ms）"}}}</script><link rel="canonical" href="http://blog.aezo.cn/2017/01/10/linux/shell/"><title>Shell编程 | 月星墙的博客</title><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?085f9cd91ef2ad985f791c677472f0d1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-right page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">月星墙的博客</span><span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">Better Code, Better Life</h1></div><div class="site-nav-toggle"> <button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br> 首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br> 分类</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br> 关于</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br> 归档</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br> 标签</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i><br> 站点地图</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br> 搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"> <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><link itemprop="mainEntityOfPage" href="http://blog.aezo.cn/2017/01/10/linux/shell/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="smalle"><meta itemprop="description" content=""><meta itemprop="image" content="https://avatars0.githubusercontent.com/u/15698218?v=3&u=ce740bf0b67ff0d74990ba6fc644d6e92f572dcb&s=400"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="月星墙的博客"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">Shell编程</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-01-10T13:19:00+08:00">2017-01-10</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a></span></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><ul><li>shell是解释性语言，解释器如<code>bash</code>、<code>sh</code></li><li><a href="http://c.biancheng.net/cpp/shell/" target="_blank" rel="noopener">Shell教程</a></li></ul><h2 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h2><h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><ul><li>程序有两类返回值：执行结果、执行状态(即 <strong><code>$?</code></strong> 的值，<code>0</code> 表示正确，<code>1-255</code> 错误)</li></ul><h3 id="特殊符号"><a href="#特殊符号" class="headerlink" title="特殊符号"></a>特殊符号</h3><ul><li>注释：<code>#</code>单行注释，<code>&lt;&lt;COMMENT xxx COMMENT</code>多行注释</li><li>linux 引号<ul><li>反引号：<strong>`cmd`</strong> 命令替换，类似<code>$(cmd)</code></li><li>双引号: <strong>“”</strong> 变量替换</li><li>单引号：<strong>‘’</strong> 字符串</li></ul></li><li>命令替换：使用 <strong>`cmd`</strong>(反引号)包裹或 <strong>$(cmd)</strong>(美元括号)<ul><li><code>wall</code>date<code></code> 所有人都收到当前时间</li><li><code>wall date</code> 所有人都收到date这个字符串</li></ul></li><li><p>管道符<code>|</code></p><ul><li>将一个命令的输出传送给另外一个命令，作为另外一个命令的输入。如：<code>命令1|命令2|...|命令n</code></li><li><strong>使用管道符连接的左右两边的命令都是运行在子shell中，存在变量无法传递的问题($变量无法传递，但是$$可以传递)；此时可通过export导出变量，通过export导出的变量在创建子进程的时候相当于快照一份给子进程，即父子进行修改export变量不会相互影响</strong><ul><li><code>copy on write</code> 写时复制，fork()创建子进程时即通过此方式。当创建子进程时，不复制变量(此时是不同的指针指向相同物理内存，这样创建子进程速度会很快)；当出现变量发生修改时，再复制出一个新的物理内存</li><li>当运行脚本时也相当于创建了一个子进程(脚本文件头为<code>#!/bin/bash</code>)</li></ul></li><li><p>示例(管道符和父子进程)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">        <span class="comment"># 显示文件第2行</span></span><br><span class="line">        head -2 fd-file | tail -1 <span class="comment"># 管道为把左边的输出给右边作为输入</span></span><br><span class="line">        ls -l * | grep <span class="string">"^_"</span> | wc -l <span class="comment"># 统计当前目录有多少个文件</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 父子进程</span></span><br><span class="line">        x=100</span><br><span class="line">        /bin/bash <span class="comment"># 创建并进入子进程</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$x</span> <span class="comment"># 此时无法获取父进程的变量，可以使用export x导出到环境变量（导出的环境变量，子进程第一次可以读取到，之后修改并不会修改父进程的此变量）</span></span><br><span class="line">        <span class="built_in">exit</span> <span class="comment"># 退出子进程</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 管道符的父子进程</span></span><br><span class="line">        x=100</span><br><span class="line">        &#123; x=101; <span class="built_in">echo</span> <span class="variable">$x</span>; &#125; <span class="comment"># 打印101. 花括号为代码块，可执行多条指令</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$x</span> <span class="comment"># 打印101，此时x被重新赋值</span></span><br><span class="line">        &#123; x=102; <span class="built_in">echo</span> <span class="variable">$x</span>; &#125; | cat <span class="comment"># 打印102. 由于管道进行连接，因此左边是一个子进程，x是在子进程中进行操作的，并没有修改到父进程的x</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$x</span> <span class="comment"># 打印101</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 在管道中获取进程id</span></span><br><span class="line">        <span class="built_in">echo</span> $$ <span class="comment"># 9287</span></span><br><span class="line">        <span class="built_in">echo</span> $$ | cat <span class="comment"># 9287. 由于$$的优先级高于|，因此在执行子进程之前就已经把父进程的pid替换了$$，然后在在子进程中执行</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$BASHPID</span> | cat <span class="comment"># 10101. 此时获取的是子进程的pid</span></span><br><span class="line">        ``` </span><br><span class="line">- 重定向：将命令的结果重定向到某个地方</span><br><span class="line">    - `&gt;`、`&gt;&gt;`　输出重定向(`&gt;`覆盖，`&gt;&gt;`追加)</span><br><span class="line">        - `ls &gt; ls.txt` 将ls的输出保存到ls.txt中</span><br><span class="line">        - `&gt;` 如果文件不存在，就创建文件；如果文件存在，就将其清空。`&gt;&gt;` 如果文件不存在，就创建文件；如果文件存在，则将新的内容追加到那个文件的末尾</span><br><span class="line">        - `2&gt;` 错误重定向，如：`lsss　2&gt; ls.txt`</span><br><span class="line">        - `&amp;&gt;` 全部重定向：`ls &amp;&gt; /dev/null` 将结果全部传给数据黑洞</span><br><span class="line">    - `&lt;`、`&lt;&lt;` 输入重定向</span><br><span class="line">        - `wall &lt; notice.txt` 将notice.txt中的数据发送给所有登录人</span><br><span class="line">    - 标准输入(stdin)代码为 `0`，实际映射关系：/dev/stdin -&gt; /proc/self/fd/0 </span><br><span class="line">    - 标准输出(stdout)代码为 `1`，实际映射关系：/dev/stdout -&gt; /proc/self/fd/1</span><br><span class="line">        - `<span class="built_in">echo</span> xxx` 将输出放到标准输出中</span><br><span class="line">    - 标准错误输出(stderr)代码为 2 ，实际映射关系： /dev/stderr -&gt;/pro/self/fd/2</span><br><span class="line">- 转义符`\`，或者使用引号</span><br><span class="line"></span><br><span class="line">```bash</span><br><span class="line"><span class="comment"># 一般特殊符号要出现必须用转义字符：' " * ? \ ~ ` ! # $ &amp; | &#123; &#125; ; &lt; &gt; ^</span></span><br><span class="line"><span class="comment">## 对于特殊字符可使用转义符`\`，或者使用引号</span></span><br><span class="line"><span class="built_in">echo</span> 9 * 9 = 81 <span class="comment"># 报错</span></span><br><span class="line"><span class="built_in">echo</span> 9 <span class="string">'*'</span> 9 = 81 <span class="comment"># 9 * 9 = 81</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'9 * 9 = 81'</span> <span class="comment"># 9 * 9 = 81</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"9 * 9 = 81"</span> <span class="comment"># 9 * 9 = 81</span></span><br><span class="line"><span class="built_in">echo</span> 9 \* 9 = 81  <span class="comment"># 9 * 9 = 81</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 在一对引号中不允许出现单引号，转义字符也不行</span></span><br><span class="line"><span class="comment"># 以下因为第一个引号和第二个引号自动配成一对，最后一个单引号在没得配的情况下，bash认为输入尚未完成，出现&gt;等待命令继续输入</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'it is wolf'</span>s book<span class="string">' # 进入待输入 &gt; ^C '</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'it is wolf\'</span>s book<span class="string">' # 进入待输入 &gt; ^C '</span></span><br><span class="line"><span class="comment"># 解决如下</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"it is wolf's book"</span></span><br><span class="line"><span class="built_in">echo</span> it is wolf\<span class="string">'s book</span></span><br><span class="line"><span class="string">echo '</span>it is wolf<span class="string">'\'</span><span class="string">'s book'</span></span><br></pre></td></tr></table></figure></li></ul></li></ul><h3 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h3><ul><li><p>变量类型</p><ul><li>环境变量(作用于可跨bash)：<code>export &lt;var_name&gt;=&lt;var_value&gt;</code></li><li>本地变量(作用于当前bash)：<code>&lt;var_name&gt;=&lt;var_value&gt;</code> (<strong>注意：=前后不要有空格</strong>)</li><li>局部变量(作用于当前代码段)：<code>local &lt;var_name&gt;=&lt;var_value&gt;</code></li><li>位置变量(作用于脚本执行的参数)：<code>$1</code> 表示第一个参数，以次类推<code>$2</code>、<code>$3</code></li><li><p>特殊变量</p><ul><li><strong><code>$?</code></strong> 上一个命令的执行状态返回值(<code>0</code> 表示正确，其他为错误)</li><li><strong><code>$#</code></strong> 传递到脚本的<strong>参数个数</strong></li><li><strong><code>$@</code></strong> 使用时加引号，并在引号中返回所有参数(用空格分割)</li><li><code>$*</code> 传递到脚本的参数，与位置变量不同，此选项参数可超过9个</li><li><code>$$</code> 脚本运行时当前进程的ID号，常用作临时变量的后缀，如 haison.$$</li><li><code>$!</code> 后台运行的(&amp;)最后一个进程的ID号</li><li><code>$-</code> 上一个命令的最后一个参数</li><li><p><code>$0</code> 当前Shell程序的文件名(只在脚本文件里才有作用)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 返回这个脚本文件放置的目录，这个命令写在脚本文件里才有作用。如`dirname /usr/local/bin` 结果为`/usr/local`</span></span><br><span class="line">dirname <span class="variable">$0</span></span><br><span class="line"><span class="comment"># 进入当前Shell程序的目录</span></span><br><span class="line"><span class="built_in">cd</span> `dirname <span class="variable">$0</span>`</span><br><span class="line"><span class="comment"># 定义当前脚本目录，并执行jar。cd -P表示基于物理路径</span></span><br><span class="line">APP_HOME=<span class="string">"<span class="variable">$(cd -P "$(dirname "$0")</span>"</span> &amp;&amp; <span class="built_in">pwd</span>)<span class="string">"/..</span></span><br><span class="line"><span class="string">(cd "</span><span class="variable">$APP_HOME</span><span class="string">" &amp;&amp; java -jar app.jar)</span></span><br></pre></td></tr></table></figure></li></ul></li></ul></li><li><p><code>set</code> 查看shell中变量</p></li><li><code>printenv</code>/<code>env</code> 查看shell中环境变量</li><li><code>unset &lt;var_name&gt;</code> 撤销变量</li><li>引用变量 <code>${var_name}</code>，一般可以省略{}</li></ul><h3 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 字符串替换</span></span><br><span class="line">string=123.abc.234 <span class="comment"># 必须基于变量进行替换</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;string/12/ab&#125;</span> <span class="comment"># 替换一次：ab3.abc.234</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;string//23/bc&#125;</span> <span class="comment"># 双斜杠替换所有匹配：1bc.abc.bc4</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;string/#ab/&#125;</span> <span class="comment"># 以什么开头来匹配：123.abc.234(匹配是吧)</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;string/%34/df&#125;</span> <span class="comment"># %以什么结尾来匹配：123.abc.2df</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 统计单词个数</span></span><br><span class="line">s=<span class="string">'one two three four five'</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$s</span> | tr <span class="string">' '</span> <span class="string">'\n'</span> | wc -l</span><br></pre></td></tr></table></figure><h3 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h3><ul><li>Bash Shell 只支持一维数组（不支持多维数组），初始化时不需要定义数组大小，数组元素的下标由 0 开始，元素用”空格”符号分割开</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 初始化</span></span><br><span class="line">name=(value1 value2 value3) <span class="comment"># 对于 index array</span></span><br><span class="line">name=([key1]=value1 [key2]=value2 [key3]=value3) <span class="comment"># 对于 associative array</span></span><br><span class="line">name[0]=value0 <span class="comment"># 也可这样定义数组</span></span><br><span class="line"><span class="comment"># 获取数组元素个数</span></span><br><span class="line">elem_count=<span class="variable">$&#123;@name[@]&#125;</span></span><br><span class="line"><span class="comment"># 引用数组中的元素</span></span><br><span class="line">value=<span class="variable">$&#123;name[$key]&#125;</span></span><br><span class="line"><span class="comment"># 数组元素赋值</span></span><br><span class="line">name[<span class="variable">$key</span>]=value</span><br><span class="line"><span class="comment"># 输出所有的键(都可)</span></span><br><span class="line">keys=<span class="variable">$&#123;!name[*]&#125;</span></span><br><span class="line">keys=<span class="variable">$&#123;!name[@]&#125;</span></span><br><span class="line"><span class="comment"># 输出所有的值</span></span><br><span class="line">values=<span class="variable">$&#123;name[*]&#125;</span></span><br><span class="line">values=<span class="variable">$&#123;name[@]&#125;</span></span><br><span class="line"><span class="comment"># 删除数组元素</span></span><br><span class="line"><span class="built_in">unset</span> name[<span class="variable">$index</span>] <span class="comment"># 删除某个元素</span></span><br><span class="line"><span class="built_in">unset</span> name <span class="comment"># 删除整个数组</span></span><br><span class="line"><span class="comment"># 获取数组的一部分，注意这个功能只有 index array 适用</span></span><br><span class="line"><span class="comment"># 0是起始下标，3是元素个数。获取从下标0开始的3个元素</span></span><br><span class="line"><span class="comment"># 如果起始下标超过元素个数，则什么也不会输出</span></span><br><span class="line"><span class="comment"># 如果起始下标是负数，则会输出错误的字符串</span></span><br><span class="line"><span class="variable">$&#123;name:0:3&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 * 和 @，只有二者被双引号包围起来的时候才会有区别</span></span><br><span class="line"><span class="comment"># 可以使用 * 的时候，解释出的东西会被当成一个字符串，可以看到遍历的时候数组中所有的键被IFS的第一个字符（空格）隔开，并当成一个字符串输了出来</span></span><br><span class="line"><span class="comment"># 但是使用@，每个键则会被单独解释。这个规则对于数组的值来说也是一样的</span></span><br><span class="line"><span class="comment"># **将所有的值换行显示**</span></span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> <span class="string">"<span class="variable">$&#123;name[@]&#125;</span>"</span> ; <span class="keyword">do</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="variable">$item</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="comment"># 将所有的值用空格分开显示成一行(一个字符串)</span></span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> <span class="string">"<span class="variable">$&#123;name[*]&#125;</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># declare 命令对变量设置属性</span></span><br><span class="line"><span class="comment"># 也可以和数组配合起来使用，declare设置的变量属性会作用于数组的每一个值上</span></span><br><span class="line"><span class="comment"># -a 设置index array</span></span><br><span class="line"><span class="comment"># -A 设置associative array</span></span><br><span class="line"><span class="comment"># -r 只读</span></span><br><span class="line"><span class="comment"># -i 值必须为整数</span></span><br><span class="line"><span class="comment"># -u 值里面所有的字母都必须为大写</span></span><br><span class="line"><span class="built_in">declare</span> -ari name=(1 2 3)</span><br></pre></td></tr></table></figure><ul><li>案例</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">my_array=(A B <span class="string">"C"</span> D)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"第一个元素为: <span class="variable">$&#123;my_array[0]&#125;</span>"</span>     <span class="comment"># A</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"数组元素个数为: <span class="variable">$&#123;#my_array[*]&#125;</span>"</span>  <span class="comment"># 4</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"数组元素个数为: <span class="variable">$&#123;#my_array[@]&#125;</span>"</span>  <span class="comment"># 4</span></span><br></pre></td></tr></table></figure><h3 id="运算"><a href="#运算" class="headerlink" title="运算"></a>运算</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 $(( ))</span></span><br><span class="line"><span class="built_in">echo</span> $(($(date +%Y)-1)) <span class="comment"># 获取去年的年份</span></span><br><span class="line"><span class="comment"># 使用expr</span></span><br><span class="line">expr 4 + 5 <span class="comment"># +中间需要有空格</span></span><br><span class="line">expr 4 \* 5</span><br><span class="line"><span class="comment"># 使用 $[]</span></span><br><span class="line"><span class="built_in">echo</span> $[ 4 + 5 ]</span><br></pre></td></tr></table></figure><h3 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h3><ul><li>函数定义、调用、返回</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## test.sh</span></span><br><span class="line"><span class="comment"># 定义函数</span></span><br><span class="line"><span class="function"><span class="title">func</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"start"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"hello<span class="variable">$1</span>"</span> <span class="comment"># $1 获取的是此函数的第一个参数，而不是脚本参数</span></span><br><span class="line">    <span class="built_in">return</span> 0 <span class="comment"># 函数中使用return返回时，返回值的数据类型必须是数字</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func <span class="string">", your name is <span class="variable">$1</span>"</span> <span class="comment"># 调用函数。$1 获取的是脚本的第一个参数</span></span><br><span class="line"><span class="keyword">if</span> [ $? == 0 ] ; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"func return=$?"</span> <span class="comment"># 函数中使用return返回函数值时，通过 echo $? 来捕获函数返回值</span></span><br><span class="line">    <span class="built_in">echo</span> $(func <span class="variable">$1</span>) <span class="comment"># 函数中使用echo返回函数值时，通过 $(func_name arg1 arg2 …) 来捕获函数返回值</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 执行结果</span></span><br><span class="line">./test.sh smalle <span class="comment"># 当传递参数也不会报错，脚本中通过$1获取到一个空字符串</span></span><br><span class="line"><span class="comment"># 打印</span></span><br><span class="line">start</span><br><span class="line">hello, your name is smalle</span><br><span class="line">func <span class="built_in">return</span>=0</span><br><span class="line">start hello smalle</span><br></pre></td></tr></table></figure><ul><li>函数结合<code>xargs</code>(参考下文)</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## test.sh</span></span><br><span class="line"><span class="built_in">exec</span> 2&gt;&amp;1 <span class="comment"># 设置重定向</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">c</span></span>() &#123;</span><br><span class="line">    wc -c <span class="variable">$1</span> <span class="comment"># 统计文件字节数</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">export</span> -f c</span><br><span class="line">ls | xargs -I&#123;&#125; bash -c <span class="string">'c &#123;&#125;'</span></span><br><span class="line"><span class="built_in">echo</span> ret_code is $?</span><br><span class="line"></span><br><span class="line"><span class="comment">## 执行</span></span><br><span class="line">./test.sh</span><br></pre></td></tr></table></figure><h3 id="控制语句"><a href="#控制语句" class="headerlink" title="控制语句"></a>控制语句</h3><ul><li>控制语句也可在命令行中需要使用</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># if</span></span><br><span class="line">[[ <span class="string">"2005 03.01"</span> &gt; <span class="string">"2004 05.23.00"</span> ]] &amp;&amp; <span class="built_in">echo</span> gt || <span class="built_in">echo</span> lt</span><br><span class="line"><span class="keyword">if</span> [ 1 = 2 ]; <span class="keyword">then</span> <span class="built_in">echo</span> <span class="literal">true</span>; <span class="keyword">else</span> <span class="built_in">echo</span> <span class="literal">false</span>; <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># for</span></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> a.yaml b.yaml ; <span class="keyword">do</span> wget http://xxx/<span class="variable">$file</span>; <span class="keyword">done</span></span><br></pre></td></tr></table></figure><h4 id="条件判断"><a href="#条件判断" class="headerlink" title="条件判断"></a>条件判断</h4><ul><li>参考<ul><li><a href="https://www.cnblogs.com/liudianer/p/12071476.html" target="_blank" rel="noopener">https://www.cnblogs.com/liudianer/p/12071476.html</a></li></ul></li><li>条件表达式 <code>[ expression ]</code> <strong>注意其中的空格</strong><ul><li><code>[[</code>，是关键字；<code>[</code>是一条命令，与<code>test</code>等价，大多数shell都支持；推荐使用<code>[[]]</code></li><li><code>[[ ]]</code>内是不能使用 -a 或者 -o 进行比较，<code>[ ]</code>内可以</li><li>使用<code>[]</code>和<code>[[]]</code>的时候不要吝啬空格，每一项两边都要有空格，<code>[[ 1 == 2 ]]</code>的结果为“假”，但<code>[[ 1==2 ]]</code>的结果为“真”！</li></ul></li><li>条件表达式的逻辑关系<ul><li><strong>在linux中命令执行状态：0 为真，其他为假</strong></li><li><code>&amp;&amp;</code>(第一个表达式为true才会运行第二个)、<code>||</code>、<code>!</code></li><li><code>-a</code> 逻辑与，如：<code>[ $# -gt 1 –a $# -lt 3 –o $# -eq 2 ]</code></li><li><code>-o</code> 或</li></ul></li><li>整数比较<ul><li><code>-eq</code>、<code>==</code> 相等，比如：<code>[ $A -eq $B ]</code></li><li><code>-ne</code>、<code>!=</code> 不等</li><li><code>-gt</code>、<code>&gt;</code> 大于</li><li><code>-lt</code>、<code>&lt;</code> 小于</li><li><code>-ge</code> 大于等于</li><li><code>-le</code> 小于等于</li></ul></li><li>文件测试(需要中括号)<ul><li><code>-e &lt;file&gt;</code> 测试文件是否存在</li><li><code>-f &lt;file&gt;</code> 测试文件是否为普通文件</li><li><code>-d &lt;file&gt;</code> 测试文件(linux是基于文件进行编程的)是否为目录</li><li><code>-r</code> 权限判断</li><li><code>-w</code></li><li><code>-x</code></li></ul></li><li>字符串测试<ul><li><code>==</code> 或 <code>=</code> <strong>等号两端需要空格</strong><ul><li>如：<code>[[ $res == *&quot;yes&quot;* ]]</code>(通配符判断是否包含)</li></ul></li><li><code>=~</code> 正则比较<ul><li>如：<code>[[ /bin/bash =~ sh$ ]]</code>、<code>[[ &quot;$var&quot; =~ $reg ]]</code>(<code>reg=&#39;^hello&#39;</code>其中$reg不能加双引号)</li></ul></li><li><code>!=</code></li><li><code>&gt;</code>、<code>&lt;</code> 字符串大小比较，字符串有空格则不能使用<code>-gt</code><ul><li>如：<code>[[ &quot;2005 03.01&quot; &gt; &quot;2004 05.23.00&quot; ]] &amp;&amp; echo gt || echo lt</code></li></ul></li><li><code>-z</code> 判断变量的值是否为空。为空，返回0，即true</li><li><code>-n</code> 判断变量的值是否不为空。非空，返回0，即true</li><li><code>-s &lt;string&gt;</code> 判非空</li><li><code>[[ $str != h* ]]</code> 判断字符串是否不是以h开头</li><li><code>[[ &quot;$str&quot; =~ ^he.* ]]</code> 判断字符串是否以he开头</li><li><code>[ &quot;$item&quot; \&lt; /home/smalle/demo/$lastMon ]</code> 判断字符串小于(需要转义)</li></ul></li><li>常用判断<ul><li><code>[[ $JAVA_HOME ]]</code> 判断是否存在此变量/环境变量</li><li><code>[[ -z $JAVA_HOME ]]</code> 判断此变量是否为空</li></ul></li><li>算术运算(其中任意一种即可)<ul><li><code>let C=$A+$B</code> <strong>(=、+附近不能有空格，下同。此时C不能有$，使用变量的使用才需要加$)</strong></li><li><code>C=$[$A+$B]</code></li><li><code>C=$(($A+$B))</code></li><li>C=`expr $A + $B` (表达式中各操作数及运算符之间要有空格，而且要使用命令引用)</li></ul></li><li>控制结构</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 控制结构</span></span></span><br><span class="line">if [ 条件表达式 ] ; then</span><br><span class="line">    语句</span><br><span class="line">elif [ 条件表达式 ] ; then</span><br><span class="line">    语句</span><br><span class="line">else</span><br><span class="line">    语句</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 案例</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 判断字符串是否为空</span></span><br><span class="line">STRING=</span><br><span class="line">if [ -z "$STRING" ]; then</span><br><span class="line">    echo "STRING is empty"</span><br><span class="line">fi</span><br><span class="line">if [ -n "$STRING" ]; then</span><br><span class="line">    echo "STRING is not empty"</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 判断目录不存在则创建</span></span><br><span class="line">if [ ! -d "/myfolder" ]; then</span><br><span class="line">  mkdir /myfolder</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><h4 id="循环"><a href="#循环" class="headerlink" title="循环"></a>循环</h4><ul><li>控制结构</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># for</span></span></span><br><span class="line">for 变量 in 列表 ; do</span><br><span class="line">    语句</span><br><span class="line">done</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 多行时，do后面需要加分号</span></span></span><br><span class="line">for file in a.yaml b.yaml c.yaml  ; do wget https://github.com/test/test/raw/test/$file; done</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 计次循环</span></span></span><br><span class="line">for ((i=1; i&lt;=100; i++))</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..100&#125;</span></span><br><span class="line">do</span><br><span class="line">    echo $i</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># while(注意此处和下列的 ; 对比)</span></span></span><br><span class="line">while 条件 ; do</span><br><span class="line">    语句</span><br><span class="line">    [break|continue]</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">while</span>死循环(<span class="literal">true</span>可以替换为[ 0 ]或[ 1 ])</span></span><br><span class="line">while true</span><br><span class="line">do</span><br><span class="line">    语句</span><br><span class="line">done</span><br></pre></td></tr></table></figure><ul><li>如何生成列表<ul><li><code>{1..100}</code></li><li><code>seq [起始数] [跨度数] 结束数</code> 如：<code>seq 10</code>、<code>seq 1 2 10</code></li><li><code>ls /etc 文件列表</code></li></ul></li></ul><h4 id="case语句"><a href="#case语句" class="headerlink" title="case语句"></a>case语句</h4><ul><li>控制结构</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">case 变量 in</span><br><span class="line">	value1)</span><br><span class="line">		语句</span><br><span class="line">		;;</span><br><span class="line">	value2)</span><br><span class="line">		语句</span><br><span class="line">		;;</span><br><span class="line">	*)</span><br><span class="line">		语句</span><br><span class="line">		;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure><h3 id="脚本说明"><a href="#脚本说明" class="headerlink" title="脚本说明"></a>脚本说明</h3><h4 id="脚本基本使用"><a href="#脚本基本使用" class="headerlink" title="脚本基本使用"></a>脚本基本使用</h4><ul><li>注意文件格式必须是Unix格式(否则执行报错：<code>: No such file or directory</code>)<ul><li>解决办法：<code>vim my.sh</code> - <code>:set ff=unix</code> - <code>:x</code></li></ul></li><li><code>#!/bin/bash</code> 脚本第一行建议以此开头</li><li><code>exit</code> 退出脚本<ul><li>退出脚本可以指定脚本执行的状态：<code>exit 0</code> 成功退出，<code>exit 1</code>/<code>exit 2</code>/… 失败退出</li><li>退出码<ul><li><code>0</code> 成功</li><li><code>2</code> shell内建命令使用错误</li><li><code>124</code> 执行命令超时，如<code>timeout 10 sleep 30</code></li><li><code>126</code> 程序或命令的权限是不可执行的</li><li><code>127</code> 命令不存在command not found(估计是$PATH不对)</li><li><code>128</code> exit的参数错误(exit只能以整数作为参数，范围是0-255)</li><li><code>128+n</code> 信号n的致命错误(kill -9 $PPID，$? 返回137=128 + 9)</li><li><code>130</code> 用Control-C来结束脚本</li><li><code>255*</code> 超出范围的退出状态(exit -1)</li></ul></li></ul></li><li>脚本中使用<code>set -x</code> 是开启代码执行显示，<code>set +x</code>是关闭，<code>set -o</code>是查看(xtrace)。执行<code>set -x</code>后，对整个脚本有效</li><li>执行脚本方式</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 执行命令</span></span><br><span class="line"><span class="comment"># 在当前shell内去读取、执行a.sh，而a.sh不需要有"执行权限"。`source/./exec/eval`命令执行脚本都不会产生子进程</span></span><br><span class="line"><span class="built_in">source</span> a.sh</span><br><span class="line">. a.sh <span class="comment"># source命令可以简写为"."</span></span><br><span class="line"><span class="comment"># (注意)如果脚本中有`source`命令，则需要使用 source/. 来执行脚本，否则脚本中source命令不会生效</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 都是打开一个subshell去读取、执行a.sh，而a.sh不需要有"执行权限"。通常在subshell里运行的脚本里设置变量，不会影响到父shell的</span></span><br><span class="line"><span class="built_in">source</span> /etc/profile <span class="comment"># 在一个脚本中使用sh、bash、nohup等运行其他命令或脚本，会开启子shell，因此需要加载一下环境变量，否则可能会出现127找不到命令的问题</span></span><br><span class="line">sh a.sh</span><br><span class="line">bash a.sh</span><br><span class="line"><span class="comment"># 打开一个subshell去读取、执行a.sh，但a.sh需要有"执行权限"(chmod +x a.sh)</span></span><br><span class="line">./a.sh</span><br><span class="line"></span><br><span class="line"><span class="comment">## 调试</span></span><br><span class="line"><span class="comment"># 检查文件是否有语法错误(`sh -n`亦可)</span></span><br><span class="line">bash -n a.sh</span><br><span class="line"><span class="comment"># debug 执行文件</span></span><br><span class="line">bash -x a.sh</span><br></pre></td></tr></table></figure><ul><li>脚本中使用nohup命令</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">!<span class="comment">#/bin/bash</span></span><br><span class="line">nohup <span class="built_in">echo</span> <span class="string">"hello world"</span> <span class="comment"># nohup执行命令不生效，原因是找不到环境变量，所以要先source一下</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br><span class="line">nohup <span class="built_in">echo</span> <span class="string">"hello world"</span></span><br></pre></td></tr></table></figure><ul><li>远程执行脚本 <a href="https://www.cnblogs.com/softidea/p/6855045.html" target="_blank" rel="noopener">^4</a><ul><li>简单执行远程命令：<code>ssh user@remoteNode &quot;cd /home ; ls&quot;</code> 双引号必须有，两个命令直接用分号分割</li><li>脚本内执行远程命令</li></ul></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># `&gt; /dev/null 2&gt;&amp;1` 表示远程命令不在本地显示，如果需要显示可以省略</span></span><br><span class="line"><span class="comment"># `&lt;&lt; eeooff`和最后的`eeooff`需要对应，可以换成其他任何标识符，如`&lt;&lt; remotessh`</span></span><br><span class="line"><span class="comment"># 在远程命令的脚本最后需要exit退出远程服务器</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -x</span><br><span class="line">ssh user@remoteNode &gt; /dev/null 2&gt;&amp;1 &lt;&lt; eeooff</span><br><span class="line"><span class="built_in">cd</span> /home</span><br><span class="line">touch abcdefg.txt</span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">eeooff</span><br><span class="line"><span class="built_in">set</span> +x</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="keyword">done</span>!</span><br></pre></td></tr></table></figure><h4 id="简单示例"><a href="#简单示例" class="headerlink" title="简单示例"></a>简单示例</h4><ul><li>添加用户：<code>./test1.sh user1</code></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 判断是否有且只有一个传入参数，否则退出(linux返回状态不为0都认为出错)</span></span><br><span class="line">[ ! $# -eq 1 ] &amp;&amp; echo "Args is error." &amp;&amp; exit 3</span><br><span class="line"><span class="meta">#</span><span class="bash"> 判断是否存在某个用户</span></span><br><span class="line">id $1 &amp;&gt;/dev/null &amp;&amp; echo "User $1 exist" &amp;&amp; exit 2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加用户</span></span><br><span class="line">id $1 &amp;&gt;/dev/null || useradd $1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果用户添加成功，将此用户名当作密码传递给标准输出，passwd通过--stdin从标准输出中读取密码进行密码修改</span></span><br><span class="line">id $1 &amp;&gt;/dev/null &amp;&amp;  echo "$1" | passwd --stdin  $1 &amp;&gt;/dev/null</span><br><span class="line">echo "Add user $1 success."</span><br><span class="line"><span class="meta">#</span><span class="bash"> 统计系统用户数(或者`wc -l /etc/passwd | cut -d<span class="string">' '</span> -f1`)</span></span><br><span class="line">COUNT=`wc -l /etc/passwd | awk '&#123;print $1&#125;'`</span><br><span class="line">echo "Total Users is $COUNT"</span><br></pre></td></tr></table></figure><ul><li>获取某目录下最大的文件：<code>./test2.sh /home/smalle</code></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 必须传入一个参数，其值为目录</span></span><br><span class="line">if [ -f $1 ];then</span><br><span class="line">  echo "Arg is error."</span><br><span class="line">  exit 2</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ -d $1 ];then</span><br><span class="line"><span class="meta">  #</span><span class="bash"> 查看目录下所有文件大小，并降序排列，再统计个数</span></span><br><span class="line">  c=`du -a $1 | sort -nr | wc -l`</span><br><span class="line"><span class="meta">  #</span><span class="bash"> seq <span class="variable">$c</span>为一个序列 </span></span><br><span class="line">  for I in `seq $c`;do</span><br><span class="line">    # 降序排列，并显示前几行(head -$I)，再过滤出最后一行(tail -1)</span><br><span class="line">    f_size=`du -a $1 | sort -nr | head -$I | tail -1 | awk '&#123;print $1&#125;'`</span><br><span class="line">    f_path=`du -a $1 | sort -nr | head -$I | tail -1 | awk '&#123;print $2&#125;'`</span><br><span class="line">    if [ -f $f_path ];then</span><br><span class="line">      # 如果是文件则停止循环(du也会统计根目录)</span><br><span class="line">      echo -e "the biggest file is $f_path \t $f_size"</span><br><span class="line">      break</span><br><span class="line">    fi</span><br><span class="line">  done</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><h4 id="接受参数"><a href="#接受参数" class="headerlink" title="接受参数"></a>接受参数</h4><h5 id="POSIX-和-GUN-规范"><a href="#POSIX-和-GUN-规范" class="headerlink" title="POSIX 和 GUN 规范"></a>POSIX 和 GUN 规范</h5><ul><li>POSIX(可移植操作系统接口)<ul><li>以一个横杠开头的为选项，选项名是单字符的英文字母或者数字</li><li>如果不带参数的话，多个选项可以写在一个横杠后面，如 <code>-abc</code> 与 <code>-a -b -c</code> 的含义相同</li><li>如果带参数的话，选项和它的参数既可以分开写也可以在一起，grep选项中的 <code>-A 10</code> 与 <code>-A10</code> 都是合乎规范的<ul><li>如果选项接受的参数有多个值，那么程序应该将参数作为一个字符串接收进来，字符串中的这些值用逗号或空白符分隔开</li></ul></li><li>选项参数写在非选项参数之前</li><li>特殊参数 <code>--</code> 指明所有参数都结束了。命令行中后面的任何参数都被认为是操作数，即使它们以 <code>-</code> 开始</li><li>同一参数可以重复出现，一般程序应该这么却解析：当一个选项覆盖其他选项的设置时，那么最后一个选项起作用。如果带参数的选项出现重复，那么程序应该按顺序处理这些选项参数。例如 <code>myprog -u arnold -u jane</code> 和 <code>myprog -u &quot;arnold,jane&quot;</code> 应该被解释为相同</li></ul></li><li>GNU(自由的操作系统)<ul><li>GNU鼓励使用<code>--help</code>、<code>--verbose</code>等形式的长选项。这些选项不仅不与POSIX约定冲突，而且容易记忆</li><li>选项参数与长选项之间或通过空白字符或通过一个<code>=</code>来分隔</li></ul></li></ul><h5 id="常见参数如"><a href="#常见参数如" class="headerlink" title="常见参数如"></a>常见参数如</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># [-?hvVtTq] 表示接受 -? -h -v等参数</span></span><br><span class="line"><span class="comment"># -s signal表示 -s 后面需要再接一个参数</span></span><br><span class="line">Usage: nginx [-?hvVtTq] [-s signal] [-c filename] [-p prefix] [-g directives]</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  -?,-h         : this <span class="built_in">help</span></span><br><span class="line">  -v            : show version and <span class="built_in">exit</span></span><br><span class="line">  -V            : show version and configure options <span class="keyword">then</span> <span class="built_in">exit</span></span><br><span class="line">  -t            : <span class="built_in">test</span> configuration and <span class="built_in">exit</span></span><br><span class="line">  -T            : <span class="built_in">test</span> configuration, dump it and <span class="built_in">exit</span></span><br><span class="line">  -q            : suppress non-error messages during configuration testing</span><br><span class="line">  -s signal     : send signal to a master process: stop, quit, reopen, reload</span><br><span class="line">  -p prefix     : <span class="built_in">set</span> prefix path (default: /etc/nginx/)</span><br><span class="line">  -c filename   : <span class="built_in">set</span> configuration file (default: /etc/nginx/nginx.conf)</span><br><span class="line">  -g directives : <span class="built_in">set</span> global directives out of configuration file</span><br></pre></td></tr></table></figure><h5 id="顺序参数"><a href="#顺序参数" class="headerlink" title="顺序参数"></a>顺序参数</h5><ul><li><p>如<code>./test.sh 1 2</code> 执行下面脚本</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># test.sh</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"脚本<span class="variable">$0</span>"</span> <span class="comment"># test.sh</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"第一个参数<span class="variable">$1</span>"</span> <span class="comment"># 1</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"第二个参数<span class="variable">$2</span>"</span> <span class="comment"># 2</span></span><br><span class="line"><span class="comment"># 超过10个的参数需要使用$&#123;10&#125;, $&#123;11&#125;来接收</span></span><br></pre></td></tr></table></figure><ul><li><p>示例</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">start</span></span>() &#123;</span><br><span class="line">	<span class="built_in">echo</span> <span class="string">'start...'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">stop</span></span>() &#123;</span><br><span class="line">	<span class="built_in">echo</span> <span class="string">'stop...'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">"<span class="variable">$1</span>"</span> <span class="keyword">in</span></span><br><span class="line">	<span class="string">'start'</span>)</span><br><span class="line">	  	start</span><br><span class="line">		;;</span><br><span class="line">	<span class="string">'stop'</span>)</span><br><span class="line">	  	stop</span><br><span class="line">		;;</span><br><span class="line">	*)</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"[info] Usage: <span class="variable">$0</span> &#123;start|stop&#125;"</span></span><br><span class="line">      <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"><span class="built_in">exit</span> $?</span><br></pre></td></tr></table></figure></li></ul></li></ul><h5 id="getopt-与-getopts"><a href="#getopt-与-getopts" class="headerlink" title="getopt 与 getopts"></a>getopt 与 getopts</h5><ul><li>getopts 接收命令行选项和参数。语法：<code>getopts OptionString Name [ Argument ...]</code></li><li>OptionString 选项名称，Name选项值变量</li><li>一个字符是一个选项，如个某字符<code>:</code>表示选项后面有传值。当getopts命令发现冒号后，会从命令行该选项后读取该值。如该值存在，将保存在特殊的变量OPTARG中</li><li>每次调用 getopts 命令时，它将下一个选项的值放置在 Name 内，并将下一个要处理的参数的索引置于 shell 变量 OPTIND 中。每当调用 shell 时，都会将 OPTIND 初始化为 1</li><li>当OptionString用<code>:</code>开头，getopts会区分invalid option错误(Name值会被设成<code>?</code>)和miss option argument错误(Name会被设成<code>:</code>)；否则出现错误，Name都会被设成<code>?</code></li><li>getopts示例(b.sh) <a href="https://www.cnblogs.com/yxzfscg/p/5338775.html" target="_blank" rel="noopener">^3</a></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">echo</span> 初始 OPTIND: <span class="variable">$OPTIND</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">while</span> <span class="built_in">getopts</span> <span class="string">"a:b:c"</span> arg <span class="comment">#选项后面的冒号表示该选项需要参数</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="keyword">case</span> <span class="variable">$arg</span> <span class="keyword">in</span></span><br><span class="line">        a)</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">"a's arg:<span class="variable">$OPTARG</span>"</span> <span class="comment">#参数存在$OPTARG中</span></span><br><span class="line">            ;;</span><br><span class="line">        b)</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">"b's arg:<span class="variable">$OPTARG</span>"</span></span><br><span class="line">            ;;</span><br><span class="line">        c)</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">"c's arg:<span class="variable">$OPTARG</span>"</span></span><br><span class="line">            ;;</span><br><span class="line">        ?)  <span class="comment">#当有不认识的选项的时候arg为?</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">"unkonw argument"</span></span><br><span class="line">            <span class="built_in">exit</span> 1</span><br><span class="line">        ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">    </span><br><span class="line"><span class="built_in">echo</span> 处理完参数后的 OPTIND：<span class="variable">$OPTIND</span></span><br><span class="line"><span class="built_in">echo</span> 移除已处理参数个数：$((OPTIND-1))</span><br><span class="line"><span class="built_in">shift</span> $((OPTIND-1)) <span class="comment"># 上一条命令 $((OPTIND-1)) 对参数位置进行了修改，此时shift可以回置参数位置</span></span><br><span class="line"><span class="built_in">echo</span> 参数索引位置：<span class="variable">$OPTIND</span></span><br><span class="line"><span class="built_in">echo</span> 准备处理余下的参数：</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Other Params: <span class="variable">$@</span>"</span></span><br></pre></td></tr></table></figure><ul><li>getopts示例结果</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- bash b.sh -a 1 -b 2 -c 3 test -oo xx -test --&gt;</span></span><br><span class="line">初始 OPTIND: 1</span><br><span class="line">a's arg:1</span><br><span class="line">b's arg:2</span><br><span class="line">c's arg:</span><br><span class="line"><span class="comment">&lt;!-- 处理`-a 1 -b 2 -c 3 test -oo xx -test`，可以解析到`-c`，相当于移动5次，此时OPTIND=5+1 --&gt;</span></span><br><span class="line">处理完参数后的 OPTIND：6</span><br><span class="line">移除已处理参数个数：5</span><br><span class="line">参数索引位置：6</span><br><span class="line">准备处理余下的参数：</span><br><span class="line">Other Params: 3 test -oo xx -test</span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- bash b.sh -a 1 -c 3 -b 2 test -oo xx -test # 非参数选项注意顺序与值，不要多传 --&gt;</span></span><br><span class="line">初始 OPTIND: 1</span><br><span class="line">a's arg:1</span><br><span class="line">c's arg:</span><br><span class="line"><span class="comment">&lt;!-- 处理`-a 1 -c 3 -b 2 test -oo xx -test`，可以解析到`-c`，相当于移动3次，此时OPTIND=3+1. 当解析到3的时候发现无法解析，则不再往后解析，全部归到其他参数 --&gt;</span></span><br><span class="line">处理完参数后的 OPTIND：4</span><br><span class="line">移除已处理参数个数：3</span><br><span class="line">参数索引位置：4</span><br><span class="line">准备处理余下的参数：</span><br><span class="line">Other Params: 3 -b 2 test -oo xx -test</span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- bash b.sh -a 1 -c -b 2 test -oo xx -test --&gt;</span></span><br><span class="line">初始 OPTIND: 1</span><br><span class="line">a's arg:1</span><br><span class="line">c's arg:</span><br><span class="line">b's arg:2</span><br><span class="line">处理完参数后的 OPTIND：6</span><br><span class="line">移除已处理参数个数：5</span><br><span class="line">参数索引位置：6</span><br><span class="line">准备处理余下的参数：</span><br><span class="line">Other Params: test -oo xx -test</span><br></pre></td></tr></table></figure><ul><li>getopt示例</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -o: 表示短选项，一个冒号表示该选项有一个参数；两个冒号表示该选项有一个可选参数，可选参数必须紧贴选项，如-carg 而不能是-c arg</span></span><br><span class="line"><span class="comment"># --long: 表示长选项</span></span><br><span class="line"><span class="comment"># -n: 出错时的信息</span></span><br><span class="line"><span class="comment"># --: 用途举例，创建一个名字为 "-f"的目录，当`mkdir -f`时不成功，因为-f会被mkdir当作选项来解析; 这时就可以使用 `mkdir -- -f` 这样-f就不会被作为选项。</span></span><br><span class="line"><span class="comment"># $@: 从命令行取出参数列表(不能用用 $* 代替，因为 $* 将所有的参数解释成一个字符串，而 $@ 是一个参数数组)</span></span><br><span class="line">TEMP=`getopt -o ab:c:: --long a-long,b-long:,c-long:: \</span><br><span class="line">    -n <span class="string">"<span class="variable">$0</span>"</span> -- <span class="string">"<span class="variable">$@</span>"</span>`</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 上面一条命令执行出错则退出程序</span></span><br><span class="line"><span class="keyword">if</span> [ $? != 0 ] ; <span class="keyword">then</span> <span class="built_in">echo</span> <span class="string">"Error..."</span> &gt;&amp;2 ; usage ; <span class="built_in">exit</span> 1 ; <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Note the quotes around `$TEMP': they are essential!</span></span><br><span class="line"><span class="comment">#set 会重新排列参数的顺序，也就是改变$1,$2...$n的值，这些值在getopt中重新排列过了。所有不包含选项的命令行参数都排到最后</span></span><br><span class="line"><span class="built_in">eval</span> <span class="built_in">set</span> -- <span class="string">"<span class="variable">$TEMP</span>"</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">usage</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"Usage: <span class="variable">$0</span> &#123;-a|--a-long&#125; &#123;-b|--b-long&#125; &#123;-c|--c-long&#125;"</span> ; </span><br><span class="line">    <span class="built_in">exit</span> 1 ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果一个参数都没有则则执行</span></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="variable">$2</span> ] ; <span class="keyword">then</span> <span class="built_in">echo</span> <span class="string">"None-argument..."</span> ; usage ; <span class="built_in">exit</span> 1 ; <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#经过getopt的处理，下面处理具体选项。</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span> ; <span class="keyword">do</span></span><br><span class="line"><span class="keyword">case</span> <span class="string">"<span class="variable">$1</span>"</span> <span class="keyword">in</span></span><br><span class="line"><span class="comment"># `shift ;` 相当于 `shift 1 ;`，即将OPTIND回置1位</span></span><br><span class="line"><span class="comment"># 如 `run.sh -a -b 2`</span></span><br><span class="line"><span class="comment"># 第一次循环：$1=-a $2=-b $3=2, 匹配到`-a`，此时`shift ;`回置1位</span></span><br><span class="line"><span class="comment"># 第二次循环：$1=-b $2=2，匹配到`-b`</span></span><br><span class="line">-a|--a-long) <span class="built_in">echo</span> <span class="string">"Option a"</span> ; <span class="built_in">shift</span> ;;</span><br><span class="line"><span class="comment"># 将OPTIND回置2位，因为b参数名和b的参数值占命令行2位。-b为必填项，如果不填写则执行getopt命令时会报错</span></span><br><span class="line">-b|--b-long) <span class="built_in">echo</span> <span class="string">"Option b, argument \`<span class="variable">$2</span>\`"</span> ; <span class="built_in">shift</span> 2 ;;</span><br><span class="line">-c|--c-long)</span><br><span class="line">    <span class="comment"># c has an optional argument. As we are in quoted mode,</span></span><br><span class="line">    <span class="comment"># an empty parameter will be generated if its optional</span></span><br><span class="line">    <span class="comment"># argument is not found.</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">"<span class="variable">$2</span>"</span> <span class="keyword">in</span></span><br><span class="line">    <span class="string">""</span>) <span class="built_in">echo</span> <span class="string">"Option c, no argument"</span>; <span class="built_in">shift</span> 2 ;;</span><br><span class="line">    *)  <span class="built_in">echo</span> <span class="string">"Option c, argument \`<span class="variable">$2</span>\`"</span> ; <span class="built_in">shift</span> 2 ;;</span><br><span class="line">    <span class="keyword">esac</span> ;;</span><br><span class="line"><span class="comment"># break 停止循环</span></span><br><span class="line">--) <span class="built_in">shift</span> ; <span class="built_in">break</span> ;;</span><br><span class="line">*) <span class="built_in">echo</span> <span class="string">"Internal error!"</span> ; <span class="built_in">exit</span> 1 ;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># $@为getopt表达式解析提取后剩余的其他参数数组</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Remaining arguments:"</span></span><br><span class="line"><span class="keyword">for</span> arg <span class="keyword">in</span> <span class="variable">$@</span> </span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'--&gt; '</span><span class="string">"\`<span class="variable">$arg</span>\`"</span> ;</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> $?</span><br></pre></td></tr></table></figure><ul><li>getopt示例结果</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ./run.sh</span></span><br><span class="line">None-argument...</span><br><span class="line">Usage: ./run.sh &#123;-a|--a-long&#125; &#123;-b|--b-long&#125; &#123;-c|--c-long&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ./run.sh 123</span></span><br><span class="line">Remaining arguments:</span><br><span class="line">--&gt; `123`</span><br><span class="line"></span><br><span class="line"><span class="comment"># ./run.sh --</span></span><br><span class="line">None-argument...</span><br><span class="line">Usage: ./run.sh &#123;-a|--a-long&#125; &#123;-b|--b-long&#125; &#123;-c|--c-long&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ./run.sh -- 123 456</span></span><br><span class="line">Remaining arguments:</span><br><span class="line">--&gt; `123`</span><br><span class="line">--&gt; `456`</span><br><span class="line"></span><br><span class="line"><span class="comment"># ./run.sh -a --b-long 2</span></span><br><span class="line">Option a</span><br><span class="line">Option b, argument `2`</span><br><span class="line">Remaining arguments:</span><br><span class="line"></span><br><span class="line"><span class="comment"># ./run.sh -a -b 2 -c3 # 可选参数必须紧跟选项</span></span><br><span class="line">Option a</span><br><span class="line">Option b, argument `2`</span><br><span class="line">Option c, argument `3`</span><br><span class="line">Remaining arguments:</span><br><span class="line"></span><br><span class="line"><span class="comment"># ./run.sh -a -b 2 -c 3</span></span><br><span class="line">Option a</span><br><span class="line">Option b, argument `2`</span><br><span class="line">Option c, no argument</span><br><span class="line">Remaining arguments:</span><br><span class="line">--&gt; `3`</span><br><span class="line"></span><br><span class="line"><span class="comment"># ./run.sh -a 1 --b-long 2</span></span><br><span class="line">Option a</span><br><span class="line">Option b, argument `2`</span><br><span class="line">Remaining arguments:</span><br><span class="line">--&gt; `1`</span><br><span class="line"></span><br><span class="line"><span class="comment"># ./run.sh -a -b 2 -c3 -- 4 5</span></span><br><span class="line">Option a</span><br><span class="line">Option b, argument `2`</span><br><span class="line">Option c, argument `3`</span><br><span class="line">Remaining arguments:</span><br><span class="line">--&gt; `4`</span><br><span class="line">--&gt; `5`</span><br></pre></td></tr></table></figure><h4 id="多行输入"><a href="#多行输入" class="headerlink" title="多行输入"></a>多行输入</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># EOF之间的数据覆盖/home/smalle/test文件；如果需要追加则为 `cat &gt;&gt; /home/smalle/test &lt;&lt; EOF...EOF`</span></span><br><span class="line">cat &gt; /home/smalle/<span class="built_in">test</span> &lt;&lt; EOF</span><br><span class="line"><span class="comment"># 注释</span></span><br><span class="line">sleep 1</span><br><span class="line">ehco hello...</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># EOF中有特殊符号，使用 "EOF" 进行转义</span></span><br><span class="line">cat &gt; /home/smalle/<span class="built_in">test</span> &lt;&lt; <span class="string">"EOF"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$test</span></span><br><span class="line"><span class="comment"># echo \$test # 此方法也可转义</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="functions模块"><a href="#functions模块" class="headerlink" title="functions模块"></a>functions模块</h3><ul><li>位于<code>/etc/rc.d/init.d/functions</code>文件中</li><li>在shell脚本中引用只需加入<code>. /etc/rc.d/init.d/functions</code>即可</li></ul><h4 id="方法介绍"><a href="#方法介绍" class="headerlink" title="方法介绍"></a>方法介绍</h4><ul><li><code>killproc</code> 杀死进程</li></ul><h2 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h2><h3 id="零散"><a href="#零散" class="headerlink" title="零散"></a>零散</h3><ul><li>如果脚本中有<code>vi</code>等操作，当用户保存该文件后会继续执行脚本</li><li><p>直接执行github等网站脚本</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 法1(需要是raw类型的连接)。tee 实时重定向日志(同时也会在控制台打印，并且可进行交互)</span></span><br><span class="line">bash &lt;(curl -L https://raw.githubusercontent.com/sprov065/v2-ui/master/install.sh) 2&gt;&amp;1 | tee my.log <span class="comment"># 此处 bash 也可改成 source</span></span><br><span class="line"><span class="comment"># 法2(需要是raw类型的连接)</span></span><br><span class="line">wget --no-check-certificate https://github.com/sprov065/blog/raw/master/bbr.sh &amp;&amp; bash bbr.sh 2&gt;&amp;1 | tee my.log</span><br></pre></td></tr></table></figure></li><li><p>命令执行失败后，是否执行后续命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">command</span> || <span class="literal">true</span>     <span class="comment"># 此command执行失败后继续执行后续命令</span></span><br><span class="line"><span class="built_in">command</span> || <span class="built_in">exit</span> 0   <span class="comment"># 此command执行失败后不执行后续命令</span></span><br></pre></td></tr></table></figure></li><li><p><code>cp</code>命令强制覆盖不提示 <code>\cp test test.bak</code></p></li><li><p>为shell命令设置超时时间</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">timeout 10 ./test.sh <span class="comment"># 设置执行脚本超时时间为10s</span></span><br><span class="line"><span class="built_in">echo</span> $? <span class="comment"># 如果超时则返回 124</span></span><br></pre></td></tr></table></figure></li><li><p>脚本中执行nohup命令不生效(主要是找不到环境变量)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> /etc/profile</span><br><span class="line">nohup <span class="built_in">echo</span> <span class="string">"hello world"</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="json处理"><a href="#json处理" class="headerlink" title="json处理"></a>json处理</h3><ul><li>使用内置的 awk/sed 来获取指定的 JSON 键值，缺点需要根据实际情况写对于的正则表达式 <a href="https://www.tomczhen.com/2017/10/15/parsing-json-with-shell-script/" target="_blank" rel="noopener">^7</a></li><li>使用<code>jq</code>软件获取<ul><li><code>yum install jq</code> 安装jq</li><li><code>jq .subjects[0].genres[0] douban.json</code></li><li><code>curl -s https://douban.uieee.com/v2/movie/top250?count=1 | jq .subjects[0].genres[0]</code></li></ul></li><li><p>调用其他脚本解释器(python/php/js)，<strong>推荐</strong></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## python2(服务器一般会安装)</span></span><br><span class="line">export PYTHONIOENCODING=utf8 &amp;&amp; curl -s <span class="string">'https://douban.uieee.com/v2/movie/top250?count=1'</span> | python -c <span class="string">"import sys, json; print json.load(sys.stdin)['subjects'][0]['genres'][0]"</span></span><br><span class="line"></span><br><span class="line">echo <span class="string">'&#123;"instance": "smalle'</span>\<span class="string">''</span>aezo<span class="string">"&#125;' | python -c "</span><span class="keyword">import</span> sys, json; <span class="keyword">print</span> json.load(sys.stdin)[<span class="string">'instance'</span>]<span class="string">"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## python3</span></span><br><span class="line"><span class="string">curl -s 'https://douban.uieee.com/v2/movie/top250?count=1' | \</span></span><br><span class="line"><span class="string">python3 -c "</span><span class="keyword">import</span> sys, json; print(json.load(sys.stdin)[<span class="string">'subjects'</span>][<span class="number">0</span>][<span class="string">'genres'</span>][<span class="number">0</span>])<span class="string">"</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="expect"><a href="#expect" class="headerlink" title="expect"></a>expect</h3><ul><li>expect 工具是一个根据脚本与其他交互式程序进行交互</li><li>相关命令<ul><li>spawn: 启动进程，并跟踪后续交互信息</li><li>expect: expect的一个内部命令，判断上次输出结果里是否包含指定的字符串，<strong>如果有则立即返回，否则就等待超时时间后返回</strong>(无法控制不执行后面的语句)。只能捕捉由spawn启动的进程的输出expect</li><li>send: 向进程发送字符串，用于模拟用户的输入，该命令不能自动回车换行，一般要加<code>\r</code>（回车）</li><li>interact: 执行完成后保存交互状态，把控制权交给控制台<ul><li>单位是：秒；timeout -1 为永不超时；默认情况下，timeout是10秒</li></ul></li><li>set timeout 30: 设置超时时间为30秒(默认的超时时间是 10 秒，通过 set 命令可以设置会话超时时间, 若不限制超时时间则应设置为-1)</li><li>exp_continue: 允许expect继续向下执行指令meout：指定超时时间，过期则继续执行后续指令</li><li>send_user: 回显命令，相当于echo</li><li>$argv 参数数组: Expect脚本可以接受从bash传递的参数，可以使用 [lindex $argv n] 获得，n从0开始，分别表示第一个$1，第二个$2，第三个$3……参数 ($argvn没有空格则表示脚本名称；$argv n有空格则代表下标)</li></ul></li><li>一般流程: spawn 启动追踪 —&gt; expect 匹配捕捉关键字 ——&gt; 捕捉到将触发send代替人为输入指令(一般是一个spawn登录命令行，之后全部为send模拟执行命令) —&gt; interact / expect eof<ul><li>Expect脚本必须以interact或expect eof 结束，执行自动化任务通常expect eof就够了<ul><li><strong><code>expect eof</code> 是在等待结束标志。</strong>由spawn启动的命令在结束时会产生一个eof标记，expect eof 即在等待这个标记</li></ul></li></ul></li><li>Expect语法</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 单一分支语法("password: "后面包含空格也可以匹配到)</span></span><br><span class="line">expect <span class="string">"password:"</span> &#123;send <span class="string">"mypassword\r"</span>;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 多分支模式语法</span></span><br><span class="line">expect <span class="string">"aaa"</span> &#123;send <span class="string">"AAA\r"</span>&#125;</span><br><span class="line">expect <span class="string">"bbb"</span> &#123;send <span class="string">"BBB\r"</span>&#125;</span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line">expect &#123;</span><br><span class="line">    <span class="string">"aaa"</span> &#123;send <span class="string">"AAA\r"</span>&#125;</span><br><span class="line">    <span class="string">"bbb"</span> &#123;send <span class="string">"BBB\r"</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line">exoect &#123;</span><br><span class="line">    <span class="string">"aaa"</span> &#123;send <span class="string">"AAA\r"</span>;exp_continue&#125;</span><br><span class="line">    <span class="string">"bbb"</span> &#123;send <span class="string">"BBB\r"</span>&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>零散案例<ul><li>参考: <a href="https://zhuanlan.zhihu.com/p/338770413" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/338770413</a></li></ul></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/expect</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 判断传入参数</span></span><br><span class="line"><span class="keyword">if</span> &#123; <span class="variable">$argc</span> &lt; 2 &#125; &#123;</span><br><span class="line">  send_user <span class="string">"usage: <span class="variable">$argv0</span> file user1 user2 ... "</span></span><br><span class="line">  <span class="built_in">exit</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> nofile 0</span><br><span class="line"><span class="comment"># get filename via the Tcl lindex function</span></span><br><span class="line"><span class="built_in">set</span> filename [lindex <span class="variable">$argv</span> 0]</span><br><span class="line"><span class="comment"># 如果脚本的第一个参数是小写的"test"，那么变量nofile被设置为1</span></span><br><span class="line"><span class="keyword">if</span> &#123; <span class="variable">$filename</span> == <span class="string">"test"</span> &#125; &#123;</span><br><span class="line">  <span class="built_in">set</span> nofile 1</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment"># 通过调用Tcl的函数isfile来验证参数指定的文件存在</span></span><br><span class="line">  <span class="keyword">if</span> &#123; [ file isfile <span class="variable">$filename</span> ] != 1 &#125; &#123;</span><br><span class="line">    send_user <span class="string">"<span class="variable">$argv0</span>: file <span class="variable">$file</span> not found. "</span></span><br><span class="line">    <span class="built_in">exit</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>直接执行案例：登录(login.exp)<ul><li><code>./login.exp 22 root 192.168.1.100 mypass</code> 即可自动登录服务器</li></ul></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/expect</span></span><br><span class="line"><span class="comment"># expect的解析器，与shell中的#!/bin/bash类似</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置超时时间n秒</span></span><br><span class="line"><span class="built_in">set</span> timeout 30</span><br><span class="line"><span class="comment"># 执行命令. 获得脚本的执行参数(其保存在数组$argv中，从0号开始是参数)</span></span><br><span class="line">spawn ssh -p [lindex <span class="variable">$argv</span> 0] [lindex <span class="variable">$argv</span> 1]@[lindex <span class="variable">$argv</span> 2]</span><br><span class="line"><span class="comment"># 接受执行命令返回的信息</span></span><br><span class="line">expect &#123;</span><br><span class="line">    <span class="comment"># 匹配到不同返回，执行不同命令；发送 yes 并 \n 回车执行，exp_continue表示继续循环匹配</span></span><br><span class="line">    <span class="string">"(yes/no)?"</span> &#123;send <span class="string">"yes\n"</span>; exp_continue&#125;</span><br><span class="line">    <span class="comment"># expect脚本可以接受bash的外部传参，可以使用[ lindex $argv n ]n为0表示第一个传参</span></span><br><span class="line">    <span class="string">"password:"</span> &#123;send <span class="string">"[lindex <span class="variable">$argv</span> 3]\n"</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 执行完代码后保持交互状态，将控制权交给用户</span></span><br><span class="line">interact</span><br><span class="line"><span class="comment"># 退出expect脚本</span></span><br><span class="line"><span class="comment"># exit</span></span><br></pre></td></tr></table></figure><ul><li>嵌入执行案例：登录(login.sh)<ul><li><code>./login.sh 192.168.1.1 root</code></li></ul></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">hostname=<span class="variable">$1</span></span><br><span class="line">password=<span class="variable">$2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载expect文件路径</span></span><br><span class="line">/usr/bin/expect&lt;&lt;-EOF</span><br><span class="line"><span class="built_in">set</span> timeout 60</span><br><span class="line">spawn ssh root@<span class="variable">$hostname</span></span><br><span class="line">expect &#123;</span><br><span class="line">  <span class="string">"(yes/no)"</span> &#123;</span><br><span class="line">    send <span class="string">"yes\r"</span>;exp_continue</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="string">"*password"</span> &#123;</span><br><span class="line">    send <span class="string">"<span class="variable">$password</span>\r"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># *表示任意字符，也可以省略</span></span><br><span class="line">expect <span class="string">"*]# "</span></span><br><span class="line">send <span class="string">"exit\r"</span></span><br><span class="line">expect eof</span><br><span class="line">EOF</span><br><span class="line"><span class="comment"># expect结束标志，EOF前后不能有空格</span></span><br></pre></td></tr></table></figure><ul><li>FTP登录案例<ul><li><code>./ftp.sh 192.168.1.1</code> 本机要开启ftp，对方也要开启</li></ul></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">hostname=<span class="variable">$1</span></span><br><span class="line">expect&lt;&lt;-EOF</span><br><span class="line">spawn ftp <span class="variable">$hostname</span></span><br><span class="line">expect &#123;</span><br><span class="line"><span class="string">"Name"</span> &#123;send <span class="string">"ftp\r"</span>;exp_continue&#125;</span><br><span class="line"><span class="string">"Password"</span> &#123;send <span class="string">"\r"</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line">expect eof</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><ul><li>其他案例参考<ul><li><a href="/_posts/arch/springboot-vue.md#常用脚本">常用脚本(通过脚本部署项目)</a></li></ul></li></ul><h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><h3 id="jar包运行-停止示例"><a href="#jar包运行-停止示例" class="headerlink" title="jar包运行/停止示例"></a>jar包运行/停止示例</h3><ul><li>OFBiz自动启动脚本参考<a href="/_posts/java/ofbiz/ofbiz进阶.md#自定义启动脚本">ofbiz进阶.md#自定义启动脚本</a></li><li>自启动脚本可参考<code>/etc/init.d</code>目录下的文件如<code>network</code>，假设下列脚本文件名为<code>my_script</code> <a href="http://blog.csdn.net/clerk0324/article/details/50593882" target="_blank" rel="noopener">^1</a></li><li>将脚本加入到开机启动<code>chkconfig --add my_script</code></li><li>以非root用户启动java程序<ul><li><code>useradd app</code> 创建用户</li><li>JDK不能安装在/root目录(此目录其他用户无执行权限)，可安装在<code>/opt</code>等目录</li><li><code>chown app:app -R /www/app/</code> 设置目录所属权限</li><li><code>su - app</code>切换到用户进行启动，或者通过root执行<code>runuser -l app -c &quot;nohup bash /www/app/start.sh &gt; /dev/null 2&gt;&amp;1 &amp;&quot;</code>进行启动</li></ul></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">警告!!!：该脚本stop部分使用系统<span class="built_in">kill</span>命令来强制终止指定的java程序进程。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">在杀死进程前，未作任何条件检查。在某些情况下，如程序正在进行文件或数据库写操作，</span></span><br><span class="line"><span class="meta">#</span><span class="bash">可能会造成数据丢失或数据不完整。如果必须要考虑到这类情况，则需要改写此脚本，</span></span><br><span class="line"><span class="meta">#</span><span class="bash">增加在执行<span class="built_in">kill</span>命令前的一系列检查。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">##################################</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 以下这些注释设置可以被chkconfig命令读取</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> chkconfig: 2345 50 50</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> description: Java程序启动脚本</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> processname: my_script_name</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> config: 如果需要的话，可以配置</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">##################################</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## 一般需要修改的配置</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">需要启动的Java主程序（main方法类）</span></span><br><span class="line">APP_JAR="app-0.0.1-SNAPSHOT.jar"</span><br><span class="line"><span class="meta">#</span><span class="bash"> springboot参数</span></span><br><span class="line">SPRING_PROFILES="--spring.profiles.active=test"</span><br><span class="line"><span class="meta">#</span><span class="bash"> SpringBoot分离Lib时需要，未分包则直接注释即可</span></span><br><span class="line">DLOADER_PATH="-Dloader.path=./lib"</span><br><span class="line"><span class="meta">#</span><span class="bash">执行程序启动所使用的系统用户，考虑到安全，推荐不使用root帐号; 如果不是root账号，则下面的执行命令都需要加上sudo，否则执行命令的时候会提示输入密码</span></span><br><span class="line">RUNNING_USER=root</span><br><span class="line"><span class="meta">#</span><span class="bash"> 内存溢出后dump文件存放位置，需要先创建此文件夹</span></span><br><span class="line">JVM_LOG_PATH="/home/"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查找到此APP的grep字符串(基于APP_JAR的基础上继续查找，可用于多实例启动)</span></span><br><span class="line">APP_GREP_STR=$APP_JAR</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">JDK所在路径(需要配置好<span class="variable">$JAVA_HOME</span>环境变量)，<span class="variable">$JAVA_HOME</span>=也可不使用系统jdk</span></span><br><span class="line"><span class="meta">#</span><span class="bash">JAVA_HOME=</span></span><br><span class="line">if [ -f "$JAVA_HOME/bin/java" ]; then</span><br><span class="line">  JAVA="$JAVA_HOME/bin/java"</span><br><span class="line">else</span><br><span class="line">  JAVA=java</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">Java程序所在的目录（将此文件和jar放在统一目录）</span></span><br><span class="line">APP_HOME="$( cd -P "$( dirname "$0" )" &amp;&amp; pwd )"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">java虚拟机启动参数</span></span><br><span class="line"><span class="meta">#</span><span class="bash">MEMIF=<span class="string">"-Xms3g -Xmx3g -Xmn1g -XX:MaxPermSize=512m"</span></span></span><br><span class="line">OOME="-XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=$JVM_LOG_PATH -XX:+CrashOnOutOfMemoryError"</span><br><span class="line"><span class="meta">#</span><span class="bash">IPADDR=`/sbin/ifconfig eth0 | grep <span class="string">'inet addr:'</span> | cut -d: -f2 | awk <span class="string">'&#123; print $1&#125;'</span>` <span class="comment"># automatic IP address for linux（内网地址）</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">RMIIF=<span class="string">"-Djava.rmi.server.hostname=<span class="variable">$IPADDR</span>"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">JMX=<span class="string">"-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port=33333 -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.authenticate=false"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">DEBUG=<span class="string">"-Xdebug -Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=5005"</span></span></span><br><span class="line">VM_ARGS="$MEMIF $OOME $RMIIF $JMX $DEBUG $DLOADER_PATH -Dfile.encoding=UTF-8 -DLog4j2.formatMsgNoLookups=true"</span><br><span class="line"></span><br><span class="line">JAR_ARGS="$SPRING_PROFILES"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">初始化psid变量（全局）</span></span><br><span class="line">psid=0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">(函数)判断程序是否已启动</span></span><br><span class="line">checkpid() &#123;</span><br><span class="line">    ps_pid=`ps -ef | grep $APP_JAR | grep $APP_GREP_STR | grep -v grep`</span><br><span class="line"></span><br><span class="line">    if [ -n "$ps_pid" ]; then</span><br><span class="line">        psid=`echo $ps_pid | awk '&#123;print $2&#125;'`</span><br><span class="line">    else</span><br><span class="line">        psid=0</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">(函数)启动程序</span></span><br><span class="line">start() &#123;</span><br><span class="line">    checkpid</span><br><span class="line"></span><br><span class="line">    if [ $psid -ne 0 ]; then</span><br><span class="line">        echo "[warn] $APP_JAR already started! (pid=$psid)"</span><br><span class="line">    else</span><br><span class="line">        echo -n "[info] Starting $APP_HOME/$APP_JAR ..."</span><br><span class="line">        if [ $1 -eq 1 ]; then</span><br><span class="line">          # nohup java -jar /home/test-0.0.1-SNAPSHOT.jar --spring.profiles.active=prod &gt; test-$(date +%Y_%m_%d).log 2&gt;&amp;1 &amp;</span><br><span class="line">          JAVA_CMD="( cd $APP_HOME &amp;&amp; nohup $JAVA $VM_ARGS -jar $APP_JAR $JAR_ARGS &gt; /dev/null 2&gt;&amp;1 &amp; )"</span><br><span class="line">        else</span><br><span class="line">          JAVA_CMD="( cd $APP_HOME &amp;&amp; $JAVA $VM_ARGS -jar $APP_JAR $JAR_ARGS )"</span><br><span class="line">        fi</span><br><span class="line">        su - $RUNNING_USER -c "$JAVA_CMD"</span><br><span class="line">        checkpid</span><br><span class="line">        if [ $psid -ne 0 ]; then</span><br><span class="line">            echo "[info] OK (pid=$psid)"</span><br><span class="line">        else</span><br><span class="line">            echo "[warn] Failed"</span><br><span class="line">        fi</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">(函数)停止程序。以下为强制<span class="built_in">kill</span>，可配合timeout前软性停止服务</span></span><br><span class="line">stop() &#123;</span><br><span class="line">    # 首先调用checkpid函数，刷新$psid全局变量</span><br><span class="line">    checkpid</span><br><span class="line"></span><br><span class="line">    # 如果程序已经启动（$psid不等于0），则开始执行停止，否则，提示程序未运行</span><br><span class="line">    if [ $psid -ne 0 ]; then</span><br><span class="line">        # echo -n 表示打印字符后，不换行</span><br><span class="line">        echo -n "[info] Stopping $APP_HOME/$APP_JAR ...(pid=$psid) "</span><br><span class="line">        # 使用kill -s 9 pid命令进行强制杀死进程</span><br><span class="line">        su - $RUNNING_USER -c "kill -s 9 $psid"</span><br><span class="line">        # 执行kill命令行紧接其后，马上查看上一句命令的返回值: $? 。在shell编程中，"$?" 表示上一句命令或者一个函数的返回值</span><br><span class="line">        if [ $? -eq 0 ]; then</span><br><span class="line">            echo "[info] OK"</span><br><span class="line">        else</span><br><span class="line">            echo "[warn] Failed"</span><br><span class="line">        fi</span><br><span class="line"></span><br><span class="line">        # 为了防止java程序被启动多次，这里增加反复检查进程，反复杀死的处理（递归调用stop）</span><br><span class="line">        checkpid</span><br><span class="line">        if [ $psid -ne 0 ]; then</span><br><span class="line">            stop</span><br><span class="line">        fi</span><br><span class="line">    else</span><br><span class="line">        echo "[warn] $APP_HOME/$APP_JAR is not running"</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">(函数)检查程序运行状态</span></span><br><span class="line">status() &#123;</span><br><span class="line">    checkpid</span><br><span class="line"></span><br><span class="line">    if [ $psid -ne 0 ];  then</span><br><span class="line">        echo "[info] $APP_HOME/$APP_JAR is running! (pid=$psid)"</span><br><span class="line">    else</span><br><span class="line">        echo "[warn] $APP_HOME/$APP_JAR is not running"</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">(函数)打印系统环境参数</span></span><br><span class="line">info() &#123;</span><br><span class="line">    echo "System Information:"</span><br><span class="line">    echo "****************************"</span><br><span class="line">    echo `head -n 1 /etc/issue`</span><br><span class="line">    echo `uname -a`</span><br><span class="line">    echo</span><br><span class="line">    echo "JAVA_HOME=$JAVA_HOME"</span><br><span class="line">    echo `$JAVA -version`</span><br><span class="line">    echo</span><br><span class="line">    echo "APP_HOME=$APP_HOME"</span><br><span class="line">    echo "APP_JAR=$APP_JAR"</span><br><span class="line">    echo "****************************"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">读取脚本的第一个参数(<span class="variable">$1</span>)，进行判断. 参数取值范围：&#123;run|start|stop|restart|status|info&#125;. 如参数不在指定范围之内，则打印帮助信息</span></span><br><span class="line">case "$1" in</span><br><span class="line">    'run')</span><br><span class="line">		start 0</span><br><span class="line">		;;</span><br><span class="line">    'start')</span><br><span class="line">		start 1</span><br><span class="line">		;;</span><br><span class="line">    'stop')</span><br><span class="line">		stop</span><br><span class="line">		;;</span><br><span class="line">    'restart')</span><br><span class="line">		stop</span><br><span class="line">		start 1</span><br><span class="line">		;;</span><br><span class="line">    'status')</span><br><span class="line">		status</span><br><span class="line">		;;</span><br><span class="line">    'info')</span><br><span class="line">		info</span><br><span class="line">		;;</span><br><span class="line">  	*)</span><br><span class="line">		echo "[info] Usage: $0 &#123;run|start|stop|restart|status|info&#125;"</span><br><span class="line">		exit 1</span><br><span class="line">esac</span><br><span class="line">exit $?</span><br></pre></td></tr></table></figure><h3 id="备份Mysql"><a href="#备份Mysql" class="headerlink" title="备份Mysql"></a>备份Mysql</h3><p>脚本具体参考：<a href="/_posts/db/mysql-dba.md#linux脚本备份(mysqldump">http://blog.aezo.cn/2016/10/12/db/mysql-dba/</a>)</p><h3 id="备份Oracle"><a href="#备份Oracle" class="headerlink" title="备份Oracle"></a>备份Oracle</h3><ul><li>配置定时任务参考<a href="/_posts/linux/linux.md#corn定时任务">linux.md#corn定时任务</a></li><li>/home/oracle/script/backup-oracle.sh</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># export ORACLE_BASE=/u01/app/oracle</span></span><br><span class="line"><span class="comment"># export ORACLE_HOME=$ORACLE_BASE/product/11.2.0/orcl</span></span><br><span class="line"><span class="comment"># export ORACLE_SID=orcl</span></span><br><span class="line"><span class="comment"># export TNS_ADMIN=$ORACLE_HOME/network/admin</span></span><br><span class="line"><span class="comment"># export PATH=$PATH:/usr/local/bin:/usr/bin:$ORACLE_HOME/bin</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Oracle数据库服务器IP、端口、SID</span></span><br><span class="line">db_sid=`192.168.1.100:1521/orcl`</span><br><span class="line"><span class="comment"># 执行备份的账号、密码，必须要有备份操作的权限</span></span><br><span class="line">db_user=scott</span><br><span class="line">db_pass=111111</span><br><span class="line"><span class="comment"># 备份下列用户下面的数据</span></span><br><span class="line">db_bak_users=(scott <span class="built_in">test</span>)</span><br><span class="line"><span class="comment"># 备份文件路径，需要提前创建好</span></span><br><span class="line">bakdir=/home/oracle/backup</span><br><span class="line"><span class="comment"># 设置删除3天之前的备份文件</span></span><br><span class="line">days=3</span><br><span class="line"></span><br><span class="line">date=`date +%Y_%m_%d`</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Starting bakup..."</span></span><br><span class="line"><span class="keyword">for</span> user <span class="keyword">in</span> <span class="string">"<span class="variable">$&#123;db_bak_users[@]&#125;</span>"</span>; <span class="keyword">do</span></span><br><span class="line">  bakdata=<span class="variable">$user</span><span class="string">"_"</span><span class="variable">$date</span>.dmp</span><br><span class="line">  baklog=<span class="variable">$user</span><span class="string">"_"</span><span class="variable">$date</span>.<span class="built_in">log</span></span><br><span class="line">  bakfile=<span class="variable">$user</span><span class="string">"_"</span><span class="variable">$date</span>.tar.gz</span><br><span class="line">  mkdir -p <span class="variable">$bakdir</span>/<span class="variable">$user</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"Bakup file path <span class="variable">$bakdir</span>/<span class="variable">$user</span>/<span class="variable">$bakdata</span>"</span></span><br><span class="line">  <span class="comment"># 执行备份命令(用户模式)</span></span><br><span class="line">  exp <span class="variable">$db_user</span>/<span class="variable">$db_pass</span>@<span class="variable">$db_sid</span> grants=y owner=<span class="variable">$user</span> file=<span class="variable">$bakdir</span>/<span class="variable">$user</span>/<span class="variable">$bakdata</span> <span class="built_in">log</span>=<span class="variable">$bakdir</span>/<span class="variable">$user</span>/<span class="variable">$baklog</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"Bakup completed, file: <span class="variable">$bakdir</span>/<span class="variable">$user</span>/<span class="variable">$bakdata</span>"</span></span><br><span class="line">  tar -zcvf <span class="variable">$bakdir</span>/<span class="variable">$user</span>/<span class="variable">$bakfile</span> <span class="variable">$bakdir</span>/<span class="variable">$user</span>/<span class="variable">$bakdata</span> <span class="variable">$bakdir</span>/<span class="variable">$user</span>/<span class="variable">$baklog</span></span><br><span class="line">  <span class="comment"># 删除备份文件和日志文件</span></span><br><span class="line">  find <span class="variable">$bakdir</span>/<span class="variable">$user</span> -<span class="built_in">type</span> f -name <span class="string">"*.log"</span> -<span class="built_in">exec</span> rm &#123;&#125; \;</span><br><span class="line">  find <span class="variable">$bakdir</span>/<span class="variable">$user</span> -<span class="built_in">type</span> f -name <span class="string">"*.dmp"</span> -<span class="built_in">exec</span> rm &#123;&#125; \;</span><br><span class="line">  <span class="comment"># 删除n天前的备份</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"Delete <span class="variable">$bakdir</span>/<span class="variable">$user</span> bakup before <span class="variable">$days</span> days..."</span></span><br><span class="line">  find <span class="variable">$bakdir</span>/<span class="variable">$user</span> -<span class="built_in">type</span> f -name <span class="string">"*.tar.gz"</span> -mtime +<span class="variable">$days</span> -<span class="built_in">exec</span> rm -rf &#123;&#125; \;</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"Backup completed <span class="variable">$user</span>"</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Bakup completed all !!!"</span></span><br></pre></td></tr></table></figure><h3 id="实现交互"><a href="#实现交互" class="headerlink" title="实现交互"></a>实现交互</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">read</span> -p <span class="string">"you are sure you wang to xxxxxx?[y/n, default:y]"</span> input</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"you input [<span class="variable">$input</span>]"</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$input</span> = <span class="string">"y"</span> ];<span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"ok"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$action</span> <span class="keyword">in</span></span><br><span class="line">	<span class="string">'y'</span>)</span><br><span class="line">		<span class="built_in">echo</span> <span class="string">"ok"</span></span><br><span class="line">		;;</span><br><span class="line">	<span class="string">'n'</span>)</span><br><span class="line">		<span class="built_in">echo</span> <span class="string">"no"</span></span><br><span class="line">		;;</span><br><span class="line">	*)</span><br><span class="line">		<span class="built_in">echo</span> <span class="string">"ok"</span></span><br><span class="line">		;;</span><br><span class="line"><span class="keyword">esac</span></span><br></pre></td></tr></table></figure><h3 id="定时判断"><a href="#定时判断" class="headerlink" title="定时判断"></a>定时判断</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># this is a function to find whether the docker is run.</span></span><br><span class="line"><span class="variable">$proc_name</span>=<span class="string">'docker'</span></span><br><span class="line"><span class="function"><span class="title">has_started</span></span>() &#123;</span><br><span class="line">    ionum=`ps -ef | grep <span class="variable">$proc_name</span> | grep -v grep | wc -l`</span><br><span class="line">    <span class="built_in">return</span> <span class="variable">$ionum</span> </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    has_started</span><br><span class="line">    processnum=$?</span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$processnum</span> -eq 0 ]</span><br><span class="line">    <span class="keyword">then</span> </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"<span class="variable">$proc_name</span> has not been started!"</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"<span class="variable">$proc_name</span> has been started"</span></span><br><span class="line">        <span class="built_in">break</span> </span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    sleep 5</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'to do what...'</span></span><br></pre></td></tr></table></figure><h3 id="删除日志文件"><a href="#删除日志文件" class="headerlink" title="删除日志文件"></a>删除日志文件</h3><ul><li>定时删除<ul><li><code>crontab -e</code> 编辑定时任务配置，参考<a href="/_posts/linux/linux.md#corn定时任务">linux.md#corn定时任务</a></li><li><code>00 02 * * * /home/smalle/script/clear-log.sh</code> 添加配置，每天凌晨2点执行定时</li><li><code>systemctl restart crond</code> 重启定时任务</li></ul></li><li>clear-log.sh</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># clear-log.sh</span></span><br><span class="line">LOG_FILE=~/script/clear-log.log</span><br><span class="line">LOG_SAVE_DAYS=30 <span class="comment"># 日志保留天数</span></span><br><span class="line">NOW=$(date +<span class="string">'%y/%m/%d %H:%M:%S'</span>)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"===============START <span class="variable">$(date +'%y/%m/%d %H:%M:%S')</span>=================="</span> &gt;&gt; <span class="variable">$LOG_FILE</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除数据库日志(主备库会产生my_db_name-log-bin.0的日志)</span></span><br><span class="line">rm -rfv /home/data/mysql/my_db_name-log-bin.0* &gt;&gt; <span class="variable">$LOG_FILE</span> <span class="comment"># 待考虑？</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除日志文件</span></span><br><span class="line">find /home/smalle/demo/ -name <span class="string">'*.log'</span> -<span class="built_in">type</span> f -mtime +<span class="variable">$LOG_SAVE_DAYS</span> -<span class="built_in">exec</span> rm -fv &#123;&#125; \; &gt;&gt; <span class="variable">$LOG_FILE</span></span><br><span class="line"><span class="comment"># 删除日志目录(日志文件基于日期分类)</span></span><br><span class="line">lastMon=$(date -d<span class="string">"-<span class="variable">$LOG_SAVE_DAYS</span> day"</span> +<span class="string">'%Y%m%d'</span>) <span class="comment"># 获取30天前的日期</span></span><br><span class="line"><span class="keyword">for</span> dir <span class="keyword">in</span> module1 module2 ; <span class="keyword">do</span> </span><br><span class="line">  <span class="keyword">for</span> item <span class="keyword">in</span> $(find /home/smalle/demo/<span class="variable">$dir</span>/ -mindepth 1 -<span class="built_in">type</span> d | xargs) ; <span class="keyword">do</span> <span class="comment"># -mindepth 1 查询的最小深度为1(相当于去掉当前目录)</span></span><br><span class="line">    <span class="comment"># 字符串比较，\&lt; 进行转义</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">"<span class="variable">$item</span>"</span> \&lt; /home/smalle/demo/<span class="variable">$dir</span>/<span class="variable">$lastMon</span> ]; <span class="keyword">then</span></span><br><span class="line">      rmdir -v <span class="variable">$item</span> &gt;&gt; <span class="variable">$LOG_FILE</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除jvm日志(保留近3天的)</span></span><br><span class="line">find /home/smalle/jvmlogs/ -<span class="built_in">type</span> f -mtime +3 -<span class="built_in">exec</span> rm -rfv &#123;&#125; \; &gt;&gt; <span class="variable">$LOG_FILE</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"===============END <span class="variable">$(date +'%y/%m/%d %H:%M:%S')</span>=================="</span> &gt;&gt; <span class="variable">$LOG_FILE</span></span><br></pre></td></tr></table></figure><h3 id="压缩历史日志"><a href="#压缩历史日志" class="headerlink" title="压缩历史日志"></a>压缩历史日志</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份2019开头的文件或文件夹到his-2019.tar.gz文件中，并删除原文件</span></span><br><span class="line">HIS_YEAR=2019</span><br><span class="line"><span class="keyword">for</span> dir <span class="keyword">in</span> test1/<span class="built_in">log</span> test2/<span class="built_in">log</span> ; <span class="keyword">do</span> </span><br><span class="line">  tar -zcvf /home/smalle/demo/<span class="variable">$dir</span>/his-<span class="variable">$HIS_YEAR</span>.tar.gz /home/smalle/demo/<span class="variable">$dir</span>/<span class="variable">$HIS_YEAR</span>*</span><br><span class="line">  <span class="comment"># rm -rf /home/smalle/demo/$dir/$HIS_YEAR*</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><h3 id="生成随机数和字符串"><a href="#生成随机数和字符串" class="headerlink" title="生成随机数和字符串"></a>生成随机数和字符串</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## $RANDOM 的范围是 [0, 32767]</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$RANDOM</span></span><br><span class="line"><span class="comment">## 获取uuid: 3ebbdb15-7ee6-4e30-97ac-643d41bbf9d6</span></span><br><span class="line">cat /proc/sys/kernel/random/uuid</span><br><span class="line">date +%s%N</span><br><span class="line"></span><br><span class="line"><span class="comment">## 生成随机字符串，`head -c 10`表示取前10位</span></span><br><span class="line">cat /dev/urandom | head -n 10 | md5sum | head -c 10</span><br><span class="line">date +%s%N | md5sum | head -c 10</span><br></pre></td></tr></table></figure><ul><li>或者创建shell文件</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">rand</span></span>() &#123;</span><br><span class="line">    min=<span class="variable">$1</span></span><br><span class="line">    max=$((<span class="variable">$2</span>-<span class="variable">$min</span>+1))</span><br><span class="line">    <span class="comment"># num=$(($RANDOM+1000000000)) #增加一个10位的数再求余</span></span><br><span class="line">    <span class="comment"># num=$(date +%s%N)</span></span><br><span class="line">    <span class="comment"># num=$(cat /proc/sys/kernel/random/uuid | cksum | awk -F ' ' '&#123;print $1&#125;')</span></span><br><span class="line">    num=$(cat /dev/urandom | head -n 10 | cksum | awk -F <span class="string">' '</span> <span class="string">'&#123;print $1&#125;'</span>)</span><br><span class="line">    <span class="built_in">echo</span> $((<span class="variable">$num</span>%<span class="variable">$max</span>+<span class="variable">$min</span>))</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 生成1~50的随机数</span></span><br><span class="line">rnd=$(rand 1 50)</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$rnd</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure><h3 id="分割字符串"><a href="#分割字符串" class="headerlink" title="分割字符串"></a>分割字符串</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 参考：https://blog.csdn.net/u010003835/article/details/80750003</span></span><br><span class="line"><span class="comment">## 1.用string来替换parameter变量中所有匹配的pattern</span></span><br><span class="line"><span class="comment"># $&#123;parameter//pattern/string&#125; </span></span><br><span class="line">string=<span class="string">"hello,shell"</span>  </span><br><span class="line">array=(<span class="variable">$&#123;string//,/ &#125;</span>) <span class="comment"># 将,替换成空格，从而形成数组</span></span><br><span class="line"><span class="keyword">for</span> var <span class="keyword">in</span> <span class="variable">$&#123;array[@]&#125;</span> <span class="comment"># $&#123;array[@]&#125; 输出数组所有的值</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">   <span class="built_in">echo</span> <span class="variable">$var</span> <span class="comment"># 换行打印 hello、shell</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 2.使用IFS</span></span><br><span class="line"><span class="comment"># Shell 脚本中有个变量叫 IFS(Internal Field Seprator) ，内部域分隔符</span></span><br><span class="line"><span class="comment"># Shell 的环境变量分为 set, env 两种，其中 set 变量可以通过 export 工具导入到 env 变量中。其中，set 是显示设置shell变量，仅在本 shell 中有效；env 是显示设置用户环境变量 ，仅在当前会话中有效</span></span><br><span class="line"><span class="comment"># 而 IFS 是一种 set 变量，当 shell 处理"命令替换"和"参数替换"时，shell 根据 IFS 的值，默认是 space, tab, newline 来拆解读入的变量，然后对特殊字符进行处理，最后重新组合赋值给该变量</span></span><br><span class="line"><span class="comment"># 查看变量 IFS 的值(需要-b转成二进制才看的到)</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$IFS</span>"</span> | od -b <span class="comment"># 打印中 "040"是空格，"011"是Tab，"012"是换行符"\n"，最后一个 012 是因为 echo 默认是会换行的</span></span><br><span class="line"><span class="comment"># 测试</span></span><br><span class="line">string=<span class="string">"hello,shell"</span></span><br><span class="line">OLD_IFS=<span class="string">"<span class="variable">$IFS</span>"</span> <span class="comment">#对IFS变量进行替换处理</span></span><br><span class="line">IFS=<span class="string">","</span></span><br><span class="line">array=(<span class="variable">$string</span>) <span class="comment"># 执行参数替换，会使用IFS</span></span><br><span class="line">IFS=<span class="string">"<span class="variable">$OLD_IFS</span>"</span></span><br><span class="line"><span class="keyword">for</span> var <span class="keyword">in</span> <span class="variable">$&#123;array[@]&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">   <span class="built_in">echo</span> <span class="variable">$var</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 3.利用tr指令实现字符替换</span></span><br><span class="line"><span class="comment"># tr命令可以对来自标准输入的字符进行替换、压缩和删除。它可以将一组字符变成另一组字符，经常用来编写优美的单行命令</span></span><br><span class="line"><span class="comment"># tr [OPTION]... SET1 [SET2]</span></span><br><span class="line"><span class="comment"># SET1: 参数1，指定要转换或删除的原字符集</span></span><br><span class="line"><span class="comment"># SET2: 参数2，转换时才需要，指定要转换成的目标字符集</span></span><br><span class="line">string=<span class="string">"hello,shell"</span></span><br><span class="line">array=(`<span class="built_in">echo</span> <span class="variable">$string</span> | tr <span class="string">','</span> <span class="string">' '</span>`)</span><br><span class="line"><span class="keyword">for</span> var <span class="keyword">in</span> <span class="variable">$&#123;array[@]&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">   <span class="built_in">echo</span> <span class="variable">$var</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><h3 id="使用表格显示结果"><a href="#使用表格显示结果" class="headerlink" title="使用表格显示结果"></a>使用表格显示结果</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">local</span> line=<span class="string">"+-------------------------------------------+\n"</span></span><br><span class="line"><span class="built_in">local</span> string=%20s</span><br><span class="line"><span class="built_in">printf</span> <span class="string">"<span class="variable">$&#123;line&#125;</span>|<span class="variable">$&#123;string&#125;</span> |<span class="variable">$&#123;string&#125;</span> |\n<span class="variable">$&#123;line&#125;</span>"</span> Username Password</span><br><span class="line">grep -v <span class="string">"^#"</span> /etc/ppp/chap-secrets | awk <span class="string">'&#123;printf "|'</span><span class="variable">$&#123;string&#125;</span><span class="string">' |'</span><span class="variable">$&#123;string&#125;</span><span class="string">' |\n", $1,$3&#125;'</span></span><br><span class="line"><span class="built_in">printf</span> <span class="variable">$&#123;line&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## /etc/ppp/chap-secrets文件数据如下</span></span><br><span class="line"><span class="comment"># Secrets for authentication using CHAP</span></span><br><span class="line"><span class="comment"># client    server    secret    IP addresses</span></span><br><span class="line"><span class="built_in">test</span>    l2tpd    ok123456       *</span><br><span class="line">test2    pptpd    ok123456    *</span><br><span class="line"></span><br><span class="line"><span class="comment">## 上述脚本打印结果如下</span></span><br><span class="line">+-------------------------------------------+</span><br><span class="line">|            Username |            Password |</span><br><span class="line">+-------------------------------------------+</span><br><span class="line">|                <span class="built_in">test</span> |            ok123456 |</span><br><span class="line">|               test2 |            ok123456 |</span><br><span class="line">+-------------------------------------------+</span><br></pre></td></tr></table></figure><h3 id="创建vsftpd虚拟账号"><a href="#创建vsftpd虚拟账号" class="headerlink" title="创建vsftpd虚拟账号"></a>创建vsftpd虚拟账号</h3><ul><li>vsftpd虚拟账号设置见 <a href="/_posts/arch/ftp.md#vsftpd">http://blog.aezo.cn/2019/03/19/arch/ftp/</a></li><li>脚本使用如：<code>sudo ./vsftp_user.sh -u s_test1,s_test2</code>，以sudo执行脚本，则脚本中的命令都为sudo权限执行</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># getopt表达式</span></span><br><span class="line">TEMP=`getopt -o u: -n <span class="string">"<span class="variable">$0</span>"</span> -- <span class="string">"<span class="variable">$@</span>"</span>`</span><br><span class="line"><span class="keyword">if</span> [ $? != 0 ] ; <span class="keyword">then</span> <span class="built_in">echo</span> <span class="string">"Error..."</span> &gt;&amp;2 ; usage ; <span class="built_in">exit</span> 1 ; <span class="keyword">fi</span></span><br><span class="line"><span class="built_in">eval</span> <span class="built_in">set</span> -- <span class="string">"<span class="variable">$TEMP</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">usage</span></span>() &#123;</span><br><span class="line">	<span class="built_in">echo</span> <span class="string">"usage: <span class="variable">$0</span> -u &lt;ftp_user_name&gt;"</span> ;</span><br><span class="line">	<span class="built_in">echo</span> <span class="string">"eg: <span class="variable">$0</span> -u s_test1,s_test2"</span> ;</span><br><span class="line">	<span class="built_in">exit</span> 1 ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 判断脚本是否未传任何参数</span></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$2</span>"</span> ] ; <span class="keyword">then</span> <span class="built_in">echo</span> <span class="string">"(error) None-argument..."</span> ; usage ; <span class="built_in">exit</span> 1 ; <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">create_user</span></span>() &#123;</span><br><span class="line">	u=<span class="variable">$1</span></span><br><span class="line">    <span class="comment"># 判断字符串不以xxx开头; 双引号中的变量可以识别，单引号中的变量无法识别; `return 1` 为函数返回值</span></span><br><span class="line">	<span class="keyword">if</span> [[ <span class="variable">$u</span> != s_* ]] ; <span class="keyword">then</span> <span class="built_in">echo</span> <span class="string">"(warn) 用户名 <span class="variable">$user</span> 不以 s_ 开头, 不进行操作."</span> ; <span class="built_in">return</span> 1; <span class="keyword">fi</span></span><br><span class="line">	</span><br><span class="line">	pass=$(sed -n <span class="string">"/<span class="variable">$u</span>/&#123;n;p;&#125;"</span> <span class="variable">$vuser_file</span>)</span><br><span class="line">    <span class="comment"># -n 判断文本是否不为空; [ ] 中的变量必须加双引号，[[ ]] 中的变量可以不使用双引号</span></span><br><span class="line">	<span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$pass</span>"</span> ] ; <span class="keyword">then</span></span><br><span class="line">		<span class="built_in">echo</span> <span class="string">"(warn) 存在登录名: <span class="variable">$u</span>, 密码: <span class="variable">$pass</span>"</span> ;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="comment"># 去掉文末空行</span></span><br><span class="line">		sed -i -e <span class="string">'/^$/d'</span> <span class="variable">$vuser_file</span> ;</span><br><span class="line">		</span><br><span class="line">		<span class="built_in">echo</span> <span class="variable">$u</span> &gt;&gt; <span class="variable">$vuser_file</span> ;</span><br><span class="line">		pass=$(cat /dev/urandom | head -n 8 | md5sum | head -c 8)</span><br><span class="line">		<span class="built_in">echo</span> <span class="variable">$pass</span> &gt;&gt; <span class="variable">$vuser_file</span> ;</span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line">	</span><br><span class="line">	touch <span class="variable">$etc_dir</span>/<span class="variable">$u</span> ;</span><br><span class="line">    <span class="comment"># 添加多行文本到文件 `&lt;&lt; EOF`表示遇到 `EOF` 则停止. 此时可以识别变量 $u</span></span><br><span class="line">	cat &gt; <span class="variable">$etc_dir</span>/<span class="variable">$u</span> &lt;&lt; EOF</span><br><span class="line">local_root=/home/vsftp/<span class="variable">$u</span></span><br><span class="line">anon_umask=022</span><br><span class="line">anon_world_readable_only=NO</span><br><span class="line">anon_upload_enable=YES</span><br><span class="line">anon_mkdir_write_enable=NO</span><br><span class="line">anon_other_write_enable=YES</span><br><span class="line">EOF</span><br><span class="line">	</span><br><span class="line">	mkdir -p <span class="variable">$vuser_dir</span>/<span class="variable">$u</span> ;</span><br><span class="line">	chown -R vsftp.vsftp <span class="variable">$vuser_dir</span>/<span class="variable">$u</span> ;</span><br><span class="line">	</span><br><span class="line">    <span class="comment"># 打印的字符串不加单双引号亦可，且字符串连接无需任何符号</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">"(info)"</span> 登录名: <span class="variable">$u</span>, 密码: <span class="variable">$pass</span> ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">user_array=</span><br><span class="line">vuser_dir=/home/vsftp</span><br><span class="line">etc_dir=/etc/vsftpd/vuser_conf.d</span><br><span class="line">vuser_file=/etc/vsftpd/vuser</span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span> ; <span class="keyword">do</span></span><br><span class="line">	<span class="keyword">case</span> <span class="string">"<span class="variable">$1</span>"</span> <span class="keyword">in</span></span><br><span class="line">		-u) </span><br><span class="line">			user_str=<span class="variable">$2</span></span><br><span class="line">            <span class="comment"># 以 , 进行分割字符串为数组</span></span><br><span class="line">			user_array=(<span class="variable">$&#123;user_str//,/ &#125;</span>)</span><br><span class="line">			<span class="built_in">shift</span> 2 ;;</span><br><span class="line">		--) <span class="built_in">shift</span> ; <span class="built_in">break</span> ;;</span><br><span class="line">		*) <span class="built_in">echo</span> <span class="string">"(error) Internal error!"</span> ; <span class="built_in">exit</span> 1 ;;</span><br><span class="line">	<span class="keyword">esac</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">cp <span class="variable">$vuser_file</span> <span class="variable">$vuser_file</span><span class="string">'_bak_'</span>$(cat /dev/urandom | head -n 8 | md5sum | head -c 8) ; <span class="comment"># 备份文件</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> user <span class="keyword">in</span> <span class="variable">$&#123;user_array[@]&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  <span class="comment"># 调用函数并传参数</span></span><br><span class="line">	create_user <span class="variable">$user</span> ;</span><br><span class="line">	<span class="built_in">echo</span> ---------------------------------- ;</span><br><span class="line"><span class="keyword">done</span> </span><br><span class="line"></span><br><span class="line">db_load -T -t <span class="built_in">hash</span> -f <span class="variable">$vuser_file</span> <span class="variable">$vuser_file</span><span class="string">'.db'</span> ; <span class="comment"># 重新生成vsftpd虚拟用户数据库</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> $?</span><br></pre></td></tr></table></figure><h3 id="日期"><a href="#日期" class="headerlink" title="日期"></a>日期</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 带日期的日志输出</span></span><br><span class="line"><span class="function"><span class="title">date_echo</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> `date <span class="string">"+%Y-%m-%d %H:%M:%S"</span>` <span class="variable">$1</span></span><br><span class="line">    logger -it my_script -p local1.info <span class="variable">$1</span></span><br><span class="line">&#125;</span><br><span class="line">date_echo <span class="string">"Starting ..."</span> <span class="comment"># 输出：2019-12-05 11:46:43 Starting ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 创建日期目录</span></span><br><span class="line">mkdir <span class="string">"<span class="variable">$(date +"%Y-%m-%d")</span>"</span> <span class="comment"># 目录为 2000-01-01，多次执行报错</span></span><br><span class="line">mkdir -p <span class="string">"<span class="variable">$(date +"%Y/%m/%d")</span>"</span> <span class="comment"># 为2020/01/01的多级目录，可多次执行不报错</span></span><br></pre></td></tr></table></figure><h3 id="执行telnet命令"><a href="#执行telnet命令" class="headerlink" title="执行telnet命令"></a>执行telnet命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line">addr=<span class="string">"localhost 1234"</span></span><br><span class="line">biz_a=<span class="string">"biz -a"</span></span><br><span class="line"></span><br><span class="line">biz_i_magic_api=<span class="string">"biz -i file:///home/sq/project/sqbiz-api/plugins/sqbiz-plugin-demo-0.0.1-ark-biz.jar"</span></span><br><span class="line"></span><br><span class="line">(sleep 3;</span><br><span class="line">  <span class="built_in">echo</span> <span class="variable">$biz_a</span>;</span><br><span class="line">  sleep 1;</span><br><span class="line">  <span class="built_in">echo</span> <span class="variable">$biz_i_magic_api</span>;</span><br><span class="line">  sleep 10;</span><br><span class="line">  <span class="built_in">echo</span> <span class="variable">$biz_a</span>;</span><br><span class="line">  sleep 1;</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"quit"</span></span><br><span class="line">)|telnet <span class="variable">$addr</span></span><br></pre></td></tr></table></figure><h2 id="C-源码脚本"><a href="#C-源码脚本" class="headerlink" title="C 源码脚本"></a>C 源码脚本</h2><h3 id="简单示例-1"><a href="#简单示例-1" class="headerlink" title="简单示例"></a>简单示例</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编写源码</span></span><br><span class="line">vi test.c</span><br><span class="line"><span class="comment"># 编译源码</span></span><br><span class="line"><span class="comment"># yum -y install gcc # 安装编译器</span></span><br><span class="line">gcc test.c -o <span class="built_in">test</span> -std=c99 <span class="comment"># 源码中的for需要在C99 mode中才可使用，因此需要加`-std=c99`</span></span><br><span class="line"><span class="comment"># 运行，结果为：连续输出10次hello world后，等待30s程序结束，回到命令行</span></span><br><span class="line">./<span class="built_in">test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 缓冲流测试</span></span><br><span class="line">./<span class="built_in">test</span> &gt; out <span class="comment"># 启动</span></span><br><span class="line">tail -f out <span class="comment"># 另起一个shell观察out文件数据变化：此时out文件刚开始无数据，30s后输出所有的hello world。如果希望启动后每打印一次则out文件中立刻出现则需要通过下列方式实现</span></span><br><span class="line"><span class="comment"># 第一种方式：修改源码，使用setvbuf函数</span></span><br><span class="line"><span class="comment"># 第二种方式：使用stdbuf函数运行。o表示输出流，L表示行缓冲。这样只要遇到换行符，就会将缓冲输出到指定对象</span></span><br><span class="line">stdbuf -oL ./<span class="built_in">test</span> &gt; out</span><br></pre></td></tr></table></figure><ul><li>test.c (参考：Linux 输出流重定向缓冲设置 <a href="https://blog.csdn.net/frank_liuxing/article/details/54017813" target="_blank" rel="noopener">^5</a>)</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// setvbuf(stdout, NULL, _IOLBF, 0); // 设置stdout的缓冲类型为行缓冲</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"hello world\n"</span>);</span><br><span class="line"></span><br><span class="line">     sleep(<span class="number">30</span>); <span class="comment">// 睡眠30秒</span></span><br><span class="line">     <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><p>参考文章</p></div><div></div><div></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> smalle</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="http://blog.aezo.cn/2017/01/10/linux/shell/" title="Shell编程">http://blog.aezo.cn/2017/01/10/linux/shell/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/lang/" rel="tag"># lang</a> <a href="/tags/linux/" rel="tag"># linux</a> <a href="/tags/shell/" rel="tag"># shell</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2017/01/10/linux/CentOS服务器使用说明/" rel="next" title="CentOS服务器使用说明"><i class="fa fa-chevron-left"></i> CentOS服务器使用说明</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"> <a href="/2017/01/16/arch/nginx/" rel="prev" title="Nginx">Nginx<i class="fa fa-chevron-right"></i></a></div></div></footer></article><div class="post-spread"><div> <a target="_blank" href="https://github.com/oldinaction/ChatGPT-MP"><img class="nofancybox" style="width:300px;margin:0 auto" src="https://cdn7.aezo.cn/one/chat/chat-gpt-open-banner.jpg" alt="ChatGPT开源小程序" title="ChatGPT开源小程序"></a></div></div></div></div><div class="comments" id="comments"></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> 文章目录</li><li class="sidebar-nav-overview" data-target="site-overview"> 站点概览</li></ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="https://avatars0.githubusercontent.com/u/15698218?v=3&u=ce740bf0b67ff0d74990ba6fc644d6e92f572dcb&s=400" alt="smalle"><p class="site-author-name" itemprop="name">smalle</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">162</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/index.html"><span class="site-state-item-count">14</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/index.html"><span class="site-state-item-count">150</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"></div><div> 欢迎关注公众号：阿壹族 <img class="nofancybox" style="width:120px;margin:0 auto" src="https://cdn7.aezo.cn/common/qrcode/ayz_qrcode.jpg" alt="欢迎关注公众号：阿壹族" title="欢迎关注公众号：阿壹族"></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#简介"><span class="nav-number">1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#基本语法"><span class="nav-number">2.</span> <span class="nav-text">基本语法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#基本概念"><span class="nav-number">2.1.</span> <span class="nav-text">基本概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#特殊符号"><span class="nav-number">2.2.</span> <span class="nav-text">特殊符号</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#变量"><span class="nav-number">2.3.</span> <span class="nav-text">变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#字符串"><span class="nav-number">2.4.</span> <span class="nav-text">字符串</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数组"><span class="nav-number">2.5.</span> <span class="nav-text">数组</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#运算"><span class="nav-number">2.6.</span> <span class="nav-text">运算</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#函数"><span class="nav-number">2.7.</span> <span class="nav-text">函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#控制语句"><span class="nav-number">2.8.</span> <span class="nav-text">控制语句</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#条件判断"><span class="nav-number">2.8.1.</span> <span class="nav-text">条件判断</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#循环"><span class="nav-number">2.8.2.</span> <span class="nav-text">循环</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#case语句"><span class="nav-number">2.8.3.</span> <span class="nav-text">case语句</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#脚本说明"><span class="nav-number">2.9.</span> <span class="nav-text">脚本说明</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#脚本基本使用"><span class="nav-number">2.9.1.</span> <span class="nav-text">脚本基本使用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#简单示例"><span class="nav-number">2.9.2.</span> <span class="nav-text">简单示例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#接受参数"><span class="nav-number">2.9.3.</span> <span class="nav-text">接受参数</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#POSIX-和-GUN-规范"><span class="nav-number">2.9.3.1.</span> <span class="nav-text">POSIX 和 GUN 规范</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#常见参数如"><span class="nav-number">2.9.3.2.</span> <span class="nav-text">常见参数如</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#顺序参数"><span class="nav-number">2.9.3.3.</span> <span class="nav-text">顺序参数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#getopt-与-getopts"><span class="nav-number">2.9.3.4.</span> <span class="nav-text">getopt 与 getopts</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#多行输入"><span class="nav-number">2.9.4.</span> <span class="nav-text">多行输入</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#functions模块"><span class="nav-number">2.10.</span> <span class="nav-text">functions模块</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#方法介绍"><span class="nav-number">2.10.1.</span> <span class="nav-text">方法介绍</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Tips"><span class="nav-number">3.</span> <span class="nav-text">Tips</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#零散"><span class="nav-number">3.1.</span> <span class="nav-text">零散</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#json处理"><span class="nav-number">3.2.</span> <span class="nav-text">json处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#expect"><span class="nav-number">3.3.</span> <span class="nav-text">expect</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#示例"><span class="nav-number">4.</span> <span class="nav-text">示例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#jar包运行-停止示例"><span class="nav-number">4.1.</span> <span class="nav-text">jar包运行/停止示例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#备份Mysql"><span class="nav-number">4.2.</span> <span class="nav-text">备份Mysql</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#备份Oracle"><span class="nav-number">4.3.</span> <span class="nav-text">备份Oracle</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#实现交互"><span class="nav-number">4.4.</span> <span class="nav-text">实现交互</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#定时判断"><span class="nav-number">4.5.</span> <span class="nav-text">定时判断</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#删除日志文件"><span class="nav-number">4.6.</span> <span class="nav-text">删除日志文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#压缩历史日志"><span class="nav-number">4.7.</span> <span class="nav-text">压缩历史日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#生成随机数和字符串"><span class="nav-number">4.8.</span> <span class="nav-text">生成随机数和字符串</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分割字符串"><span class="nav-number">4.9.</span> <span class="nav-text">分割字符串</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用表格显示结果"><span class="nav-number">4.10.</span> <span class="nav-text">使用表格显示结果</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建vsftpd虚拟账号"><span class="nav-number">4.11.</span> <span class="nav-text">创建vsftpd虚拟账号</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#日期"><span class="nav-number">4.12.</span> <span class="nav-text">日期</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#执行telnet命令"><span class="nav-number">4.13.</span> <span class="nav-text">执行telnet命令</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#C-源码脚本"><span class="nav-number">5.</span> <span class="nav-text">C 源码脚本</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#简单示例-1"><span class="nav-number">5.1.</span> <span class="nav-text">简单示例</span></a></li></ol></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright"> &copy; 2016 - <span itemprop="copyrightYear">2024</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">smalle</span>&nbsp;&nbsp;&nbsp;&nbsp;<div class="powered-by"> 由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div><div class="powered-by"> 主题 - <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a></div><div class="theme-info"> <a class="theme-link" target="_blank" href="https://tongji.baidu.com/main/overview/10000542408/overview/index?siteId=18991897">站长统计</a></div></div><div class="ad"> <span style="font-weight:700">AD&nbsp;&nbsp;&nbsp;&nbsp;</span><div class="theme-info"> <a target="_blank" href="https://promotion.aliyun.com/ntms/yunparter/invite.html?userCode=oby5nolb">阿里云大礼包</a></div></div><div class="aezocn"> <span style="font-weight:700">&copy;AEZO.CN&nbsp;&nbsp;&nbsp;&nbsp;</span><div class="powered-by"> <a target="_blank" href="https://shengqitech.aezo.cn/">圣骑科技</a></div><div class="powered-by"> <a target="_blank" href="https://cdn7.aezo.cn/common/qrcode/one_qrcode.jpg">【One能抽屉】小程序</a></div><div class="theme-info"> <a target="_blank" href="http://shop.aezo.cn/">杂货铺(省钱小助手)</a></div></div><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?085f9cd91ef2ad985f791c677472f0d1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script><script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script type="text/javascript" src="/js/src/js.cookie.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/scroll-cookie.js?v=5.1.1"></script></body></html>