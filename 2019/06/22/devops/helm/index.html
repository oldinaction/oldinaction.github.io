<!doctype html><html class="theme-next mist use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css"><meta name="keywords" content="k8s,"><link rel="alternate" href="/atom.xml" title="月星墙的博客" type="application/atom+xml"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1"><meta name="description" content="简介 Helm 、Helm Docs、Helm 指南(中文) 是 Kubernetes 上的包管理器 Helm组成：Helm客户端、Tiller服务器、Charts仓库 原理：Helm客户端从远程Charts仓库(Repository)拉取Chart(应用程序配置模板)，并添加Chart安装运行时所需要的Config(配置信息)，然后将此Chart和Config提交到Tiller服务器，Tille"><meta name="keywords" content="k8s"><meta property="og:type" content="article"><meta property="og:title" content="Helm | K8s包管理器"><meta property="og:url" content="http://blog.aezo.cn/2019/06/22/devops/helm/index.html"><meta property="og:site_name" content="月星墙的博客"><meta property="og:description" content="简介 Helm 、Helm Docs、Helm 指南(中文) 是 Kubernetes 上的包管理器 Helm组成：Helm客户端、Tiller服务器、Charts仓库 原理：Helm客户端从远程Charts仓库(Repository)拉取Chart(应用程序配置模板)，并添加Chart安装运行时所需要的Config(配置信息)，然后将此Chart和Config提交到Tiller服务器，Tille"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="http://blog.aezo.cn/data/images/devops/cert-manager.png"><meta property="og:updated_time" content="2024-10-14T02:34:07.654Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Helm | K8s包管理器"><meta name="twitter:description" content="简介 Helm 、Helm Docs、Helm 指南(中文) 是 Kubernetes 上的包管理器 Helm组成：Helm客户端、Tiller服务器、Charts仓库 原理：Helm客户端从远程Charts仓库(Repository)拉取Chart(应用程序配置模板)，并添加Chart安装运行时所需要的Config(配置信息)，然后将此Chart和Config提交到Tiller服务器，Tille"><meta name="twitter:image" content="http://blog.aezo.cn/data/images/devops/cert-manager.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",sidebar:{position:"right",display:"post",offset:12,offset_float:0,b2t:!1,scrollpercent:!1},fancybox:!0,motion:!0,duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"BWD6R9FA4K",apiKey:"3330f3cbaa099dfc30395de5f5b20151",indexName:"blog",hits:{per_page:10},labels:{input_placeholder:"请输入关键字",hits_empty:"我们没有找到任何搜索结果: ${query}",hits_stats:"找到约${hits}条结果（用时${time}ms）"}}}</script><link rel="canonical" href="http://blog.aezo.cn/2019/06/22/devops/helm/"><title>Helm | K8s包管理器 | 月星墙的博客</title><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?085f9cd91ef2ad985f791c677472f0d1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-right page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">月星墙的博客</span><span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">Better Code, Better Life</h1></div><div class="site-nav-toggle"> <button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br> 首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br> 分类</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br> 关于</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br> 归档</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br> 标签</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i><br> 站点地图</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br> 搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"> <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><link itemprop="mainEntityOfPage" href="http://blog.aezo.cn/2019/06/22/devops/helm/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="smalle"><meta itemprop="description" content=""><meta itemprop="image" content="https://avatars0.githubusercontent.com/u/15698218?v=3&u=ce740bf0b67ff0d74990ba6fc644d6e92f572dcb&s=400"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="月星墙的博客"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">Helm | K8s包管理器</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-22T12:38:00+08:00">2019-06-22</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/devops/" itemprop="url" rel="index"><span itemprop="name">devops</span></a></span></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><ul><li><a href="https://github.com/helm/helm" target="_blank" rel="noopener">Helm</a> 、<a href="https://helm.sh/docs/" target="_blank" rel="noopener">Helm Docs</a>、<a href="https://whmzsu.github.io/helm-doc-zh-cn/" target="_blank" rel="noopener">Helm 指南(中文)</a><ul><li>是 Kubernetes 上的包管理器</li><li>Helm组成：<code>Helm</code>客户端、<code>Tiller</code>服务器、<code>Charts</code>仓库</li><li>原理：Helm客户端从远程Charts仓库(Repository)拉取Chart(应用程序配置模板)，并添加Chart安装运行时所需要的Config(配置信息)，然后将此Chart和Config提交到Tiller服务器，Tiller服务器则在k8s生成<code>Release</code>，并完成部署</li></ul></li><li><a href="https://github.com/helm/charts" target="_blank" rel="noopener">官方Charts仓库</a>、<a href="https://hub.helm.sh/" target="_blank" rel="noopener">官方Charts仓库展示</a>、<a href="https://hub.kubeapps.com/charts" target="_blank" rel="noopener">Kubeapps Charts仓库(速度较快)</a></li><li><a href="/_posts/devops/docker.md#国内镜像">国内docker镜像</a></li></ul><h2 id="安装Helm客户端及服务"><a href="#安装Helm客户端及服务" class="headerlink" title="安装Helm客户端及服务"></a>安装Helm客户端及服务</h2><ul><li><p>安装Helm客户端</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载helm命令行工具到master节点</span></span><br><span class="line">curl -O https://get.helm.sh/helm-v2.14.2-linux-amd64.tar.gz</span><br><span class="line">tar -zxvf helm-v2.14.2-linux-amd64.tar.gz</span><br><span class="line">mv linux-amd64/helm /usr/<span class="built_in">local</span>/bin/</span><br><span class="line"><span class="comment"># 查看帮助</span></span><br><span class="line">helm</span><br><span class="line">rm -rf linux-amd64 <span class="comment"># 删除下载文件</span></span><br></pre></td></tr></table></figure></li><li><p>安装Tiller服务器(安装在k8s集群中) <a href="https://jimmysong.io/kubernetes-handbook/practice/helm.html" target="_blank" rel="noopener">^1</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 为了安装服务端tiller，还需要在这台机器上配置好kubectl工具和kubeconfig文件，确保kubectl工具可以在这台机器上访问apiserver且正常使用。一般安装在master</span></span><br><span class="line"><span class="comment"># 因为Kubernetes APIServer开启了RBAC访问控制，所以需要创建tiller使用的`service account: tiller`，并分配合适的角色给它</span></span><br><span class="line">kubectl create serviceaccount --namespace kube-system tiller</span><br><span class="line">kubectl create clusterrolebinding tiller-cluster-rule --clusterrole=cluster-admin --serviceaccount=kube-system:tiller</span><br><span class="line"><span class="comment"># 使用helm部署tiller。-i指定自己的镜像，因为官方的镜像因为某些原因无法拉取，官方镜像地址是：gcr.io/kubernetes-helm/tiller:v2.14.2</span></span><br><span class="line">helm init --upgrade -i registry.cn-hangzhou.aliyuncs.com/google_containers/tiller:v2.14.2 --stable-repo-url https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</span><br><span class="line"><span class="comment"># 为应用程序设置serviceAccount</span></span><br><span class="line">kubectl patch deploy --namespace kube-system tiller-deploy -p <span class="string">'&#123;"spec":&#123;"template":&#123;"spec":&#123;"serviceAccount":"tiller"&#125;&#125;&#125;&#125;'</span></span><br><span class="line"><span class="comment"># 检查是否安装成功</span></span><br><span class="line">kubectl -n kube-system get pods|grep tiller</span><br><span class="line"><span class="comment"># Client 和 Server 都显示各自版本，即表示 Client 和 Server 均正常</span></span><br><span class="line">helm version</span><br><span class="line"><span class="comment"># (可选)查看并修改远程仓库地址。上文默认使用了阿里的镜像</span></span><br><span class="line">helm repo add stable http://mirror.azure.cn/kubernetes/charts</span><br><span class="line">helm repo update</span><br><span class="line">helm repo list</span><br><span class="line"></span><br><span class="line"><span class="comment"># 卸载tiller</span></span><br><span class="line">heml reset</span><br></pre></td></tr></table></figure></li></ul><h2 id="Helm命令-2"><a href="#Helm命令-2" class="headerlink" title="Helm命令 ^2"></a>Helm命令 <a href="https://www.cnblogs.com/linuxk/p/10607805.html" target="_blank" rel="noopener">^2</a></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># helm</span></span><br><span class="line">completion  <span class="comment"># 为指定的shell生成自动补全脚本（bash或zsh）</span></span><br><span class="line">create      <span class="comment"># 创建一个新的charts</span></span><br><span class="line">delete      <span class="comment"># 删除指定版本的release</span></span><br><span class="line">    <span class="comment"># helm delete --purge my-dev # **删除 release，也会删除相应k8s资源**</span></span><br><span class="line">dependency  <span class="comment"># 管理charts的依赖</span></span><br><span class="line">fetch       <span class="comment"># 下载charts到当前目录。eg：helm fetch stable/prometheus --version 9.0.0</span></span><br><span class="line">get         <span class="comment"># 下载一个release</span></span><br><span class="line"><span class="built_in">history</span>     <span class="comment"># release历史信息</span></span><br><span class="line">home        <span class="comment"># 显示helm的家目录</span></span><br><span class="line">init        <span class="comment"># 在客户端和服务端初始化helm</span></span><br><span class="line">    --client-only <span class="comment"># 只初始化客户端</span></span><br><span class="line">    --stable-repo-url <span class="comment"># 修改stable默认仓库地址(需要公开地址)。如：https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</span></span><br><span class="line">inspect     <span class="comment"># 查看charts的详细配置信息(values.yaml)</span></span><br><span class="line">    <span class="comment"># helm inspect stable/nginx-ingress # 查看此chart说明信息</span></span><br><span class="line">    <span class="comment"># helm inspect values stable/nginx-ingress # 查看此chart的values.yaml信息</span></span><br><span class="line">install     <span class="comment"># 安装charts</span></span><br><span class="line">    <span class="comment"># helm install stable/nginx</span></span><br><span class="line">    <span class="comment"># helm install ./nginx-1.2.3.tgz</span></span><br><span class="line">    <span class="comment"># helm install ./nginx</span></span><br><span class="line">    <span class="comment"># helm install https://example.com/charts/nginx-1.2.3.tgz</span></span><br><span class="line">    <span class="comment"># helm install --dry-run --debug mychart # **模拟执行**</span></span><br><span class="line">lint        <span class="comment"># 检测包的存在问题</span></span><br><span class="line">list        <span class="comment"># 列出release(结果中CHART字段一般带了CHART的版本，APP VERSION则为相关镜像如nginx-ingress版本)</span></span><br><span class="line">    <span class="comment"># helm list --all</span></span><br><span class="line">package     <span class="comment"># 将chart目录进行打包</span></span><br><span class="line">plugin      <span class="comment"># add(增加), list（列出）, or remove（移除） Helm 插件</span></span><br><span class="line">repo        <span class="comment"># add(增加), list（列出）, remove（移除）, update（更新）, and index（索引） chart仓库</span></span><br><span class="line">    <span class="comment"># helm repo add stable http://mirror.azure.cn/kubernetes/charts # 替换原有 stable(使用微软镜像，阿里镜像有中断更新)</span></span><br><span class="line">    <span class="comment"># helm repo add incubator http://mirror.azure.cn/kubernetes/charts-incubator/</span></span><br><span class="line">    <span class="comment"># helm repo add fabric8 https://fabric8.io/helm</span></span><br><span class="line">    <span class="comment"># helm repo update</span></span><br><span class="line">reset       <span class="comment"># 卸载tiller</span></span><br><span class="line">rollback    <span class="comment"># release版本回滚</span></span><br><span class="line">search      <span class="comment"># 关键字搜索chart。eg: helm search mysql</span></span><br><span class="line">serve       <span class="comment"># 启动一个本地的http server用于展示本地charts和提供下载</span></span><br><span class="line">    <span class="comment"># helm serve --address=192.168.6.131:8879</span></span><br><span class="line">status      <span class="comment"># 查看release状态信息</span></span><br><span class="line">    <span class="comment"># helm status grafana # 重新展示安装完成后的状态信息</span></span><br><span class="line">template    <span class="comment"># 本地模板</span></span><br><span class="line"><span class="built_in">test</span>        <span class="comment"># release测试</span></span><br><span class="line">upgrade     <span class="comment"># 更新release</span></span><br><span class="line">            <span class="comment"># **如nginx示例**</span></span><br><span class="line">                <span class="comment"># 初始化时会自动创建一个 Deployment、ReplicaSet、Pod、Service</span></span><br><span class="line">                <span class="comment"># 每次更新仅会产生一个新的ReplicaSet，而后此ReplicaSet会创建一个新的Pod，如果使用RollingUpdate滚动更新模式，在新Pod进入到readiness就绪状态之前，仍然由旧Pod提供服务，当新Pod就绪后，则移除旧Pod</span></span><br><span class="line">                <span class="comment"># 对于旧的ReplicaSet是不会删除的，当系统自动移除旧Pod后，那些旧的ReplicaSet控制的容器组就为0/0，并且也不会还原旧的Pod</span></span><br><span class="line">                <span class="comment"># 更新或删除部署时，该部署使用的pv所在目录不能被占用(即不能处于相应pv所在目录)</span></span><br><span class="line">verify      <span class="comment"># 验证chart的签名和有效期</span></span><br><span class="line">version     <span class="comment"># 打印客户端和服务端的版本信息</span></span><br></pre></td></tr></table></figure><ul><li><p>Helm传递参数</p><ul><li>通过 <code>--set</code> 直接传入参数值，如：<code>helm install stable/mysql --set mysqlRootPassword=Hello1234! -n my-dev</code></li><li><p>生成自定义 values 文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成 values 文件</span></span><br><span class="line">helm inspect values stable/mysql &gt; myvalues.yaml</span><br><span class="line"><span class="comment"># 修改参数值</span></span><br><span class="line">vi myvalues.yaml</span><br><span class="line"><span class="comment"># 基于某个 values 文件进行安装，此文件和默认文件会进行值合并覆盖</span></span><br><span class="line">helm install stable/mysql -f myvalues.yaml</span><br><span class="line">helm install --values=myvalues.yaml stable/mysql</span><br></pre></td></tr></table></figure></li><li><p><code>values.yaml</code> 和 <code>--set</code> 联合使用时，–set的优先级更高</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm upgrade --install oa-dev-center --namespace devops -f oa-dev-center-api/devops/values.yaml --<span class="built_in">set</span> <span class="string">'image.repository=192.168.10.130/devops/oa-dev-center,image.tag=1.0.0-SNAPSHOT'</span> aezo/springboot --version 1.0.0 --dry-run --debug</span><br></pre></td></tr></table></figure></li></ul></li></ul><h2 id="Chart使用-手动创建"><a href="#Chart使用-手动创建" class="headerlink" title="Chart使用(手动创建)"></a>Chart使用(手动创建)</h2><ul><li>安装某个 Chart 后，可在 <code>~/.helm/cache/archive</code> 中找到 Chart 的 tar 包，可解压查看 Chart 文件信息(<code>tar -zxvf nginx-ingress-0.9.5.tgz</code>)</li><li><p>创建 Chart 案例 <a href="https://jimmysong.io/kubernetes-handbook/practice/helm.html" target="_blank" rel="noopener">^1</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建名为 mychart 的 Chart. 此时会创建一个包含nginx相关配置的的模板包</span></span><br><span class="line">helm create mychart</span><br><span class="line"><span class="comment"># tree mychart</span></span><br><span class="line"><span class="comment"># 检测 chart 的语法</span></span><br><span class="line">helm lint mychart</span><br><span class="line"><span class="comment"># **模拟安装 chart**，并输出每个模板生成的 YAML 内容(--dry-run 实际没有部署到k8s)</span></span><br><span class="line">helm install --dry-run --debug mychart</span><br><span class="line"><span class="comment"># 部署到k8s</span></span><br><span class="line">helm install ./mychart --name mychart --namespace <span class="built_in">test</span></span><br><span class="line">helm upgrade mychart ./mychart</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试</span></span><br><span class="line"><span class="built_in">export</span> POD_NAME=$(kubectl get pods --namespace default -l <span class="string">"app.kubernetes.io/name=mychart,app.kubernetes.io/instance=test-chart"</span> -o jsonpath=<span class="string">"&#123;.items[0].metadata.name&#125;"</span>)</span><br><span class="line">kubectl port-forward --address 0.0.0.0 <span class="variable">$POD_NAME</span> 8080:80</span><br><span class="line"><span class="comment"># 在本地访问http://127.0.0.1:8080即可访问到nginx</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改配置文件(也可同时配合--set修改配置)后更新部署</span></span><br><span class="line"><span class="comment"># 此处image.tag不能使用过长的数字(yyyyMMddHHmmss生成的数字)，过长传递到k8s则变成了科学计数导致出错</span></span><br><span class="line">helm upgrade --<span class="built_in">set</span> image.tag=20190902 mychart ./mychart</span><br><span class="line">helm <span class="built_in">history</span> mychart <span class="comment"># 查看更新历史</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 复制后修改项目名</span></span><br><span class="line">sed -i <span class="string">'s/mychart/mychart2/g'</span> `grep mychart -rl ./mychart2`</span><br></pre></td></tr></table></figure></li><li><p><code>tree mychart</code> 显示目录信息如下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 其中 Chart.yaml 和 values.yaml 必须，其他可选</span></span><br><span class="line">mychart</span><br><span class="line">├── charts                          <span class="comment"># 依赖的chart。如 https://hub.kubeapps.com/charts/bitnami/elasticsearch，elasticsearch依赖了kibana</span></span><br><span class="line">├── requirements.yaml               <span class="comment"># 该chart的依赖配置(create创建的无此文件)</span></span><br><span class="line">├── Chart.yaml                      <span class="comment"># Chart本身的版本和配置信息。其中的name是chart的名称，并不一定是release的名称</span></span><br><span class="line">├── templates                       <span class="comment"># 配置模板目录，下是yaml文件的模板，遵循Go template语法</span></span><br><span class="line">│   ├── deployment.yaml             <span class="comment"># kubernetes Deployment object</span></span><br><span class="line">│   ├── _helpers.tpl                <span class="comment"># 定义了一些基础模板（一般是一些全局变量），如`&#123;&#123;- define "harbor.fullname" -&#125;&#125;`</span></span><br><span class="line">│   ├── ingress.yaml                <span class="comment"># kubernetes Ingress(默认未启用)</span></span><br><span class="line">│   ├── NOTES.txt</span><br><span class="line">│   ├── service.yaml                <span class="comment"># kubernetes Serivce</span></span><br><span class="line">│   └── tests</span><br><span class="line">│       └── <span class="built_in">test</span>-connection.yaml</span><br><span class="line">└── values.yaml                     <span class="comment"># kubernetes object configuration</span></span><br></pre></td></tr></table></figure><ul><li><p>比如在<code>deployment.yaml</code>中定义的容器镜像</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 其中`.Values`代表后面属性获取`values.yaml`文件中的数据，如`.Values.image.repository`就是`nginx`，`.Values.image.tag`就是`stable`</span></span><br><span class="line"><span class="comment"># Values为内置对象。更多内置对象参考：https://whmzsu.github.io/helm-doc-zh-cn/chart_template_guide/builtin_objects-zh_cn.html</span></span><br><span class="line">image: <span class="string">"&#123;&#123; .Values.image.repository &#125;&#125;:&#123;&#123; .Values.image.tag &#125;&#125;"</span></span><br></pre></td></tr></table></figure></li></ul></li><li><p>打包分享</p><ul><li><p>chart 通过测试后可以将其添加到仓库，团队其他成员就能够使用。任何 HTTP Server 都可以用作 chart 仓库</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 在node2启动一个 HTTP Server，如果已有可忽略。此处node2服务地址为 http://192.168.6.132:8080/</span></span><br><span class="line">docker run -d -p 8080:80 -v /var/www/:/usr/<span class="built_in">local</span>/apache2/htdocs/ httpd</span><br><span class="line"></span><br><span class="line"><span class="comment">## 在node1操作</span></span><br><span class="line"><span class="comment"># 生成压缩包 mychart-0.1.0.tgz，并同步到 local 的仓库</span></span><br><span class="line">helm package mychart</span><br><span class="line"><span class="comment"># 生成仓库的 index 文件</span></span><br><span class="line">mkdir myrepo</span><br><span class="line">mv mychart-0.1.0.tgz myrepo/</span><br><span class="line"><span class="comment"># Helm 会扫描 myrepo 目录中的所有 tgz 包并生成 index.yaml</span></span><br><span class="line">helm repo index myrepo/ --url http://192.168.6.132:8080/charts</span><br><span class="line">cat myrepo/index.yaml</span><br><span class="line"><span class="comment"># 需要提前在node2创建 /var/www/charts/</span></span><br><span class="line">scp myrepo/* root@node2:/var/www/charts/</span><br><span class="line">helm repo add newrepo http://192.168.6.132:8080/charts</span><br><span class="line">helm repo list</span><br><span class="line">helm search mychart</span><br><span class="line"><span class="comment"># 如果以后仓库添加了新的 chart，需要用 helm repo update 更新本地的 index</span></span><br><span class="line">helm repo update</span><br></pre></td></tr></table></figure></li></ul></li><li><p>chart语法参考<a href="#Go%20template语法">Go template语法</a></p></li><li>chart参考文章<a href="https://whmzsu.github.io/helm-doc-zh-cn/chart_template_guide/index-zh_cn.html" target="_blank" rel="noopener">chart_template_guide</a><ul><li><a href="https://whmzsu.github.io/helm-doc-zh-cn/chart_template_guide/builtin_objects-zh_cn.html" target="_blank" rel="noopener">chart内置对象</a><ul><li><code>Release.Name</code></li><li><code>Release.Namespace</code></li></ul></li></ul></li></ul><h2 id="使用案例"><a href="#使用案例" class="headerlink" title="使用案例"></a>使用案例</h2><h3 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h3><blockquote><p><a href="https://hub.kubeapps.com/charts/stable/mysql" target="_blank" rel="noopener">https://hub.kubeapps.com/charts/stable/mysql</a></p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; mysql-values.yaml &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">image: hub-mirror.c.163.com/library/mysql</span><br><span class="line">persistence:</span><br><span class="line">  storageClass: <span class="string">'nfs-client'</span></span><br><span class="line">timezone: Asia/Shanghai</span><br><span class="line"><span class="comment"># 需要登录到服务器手动给此用户设置权限</span></span><br><span class="line">mysqlUser: devops</span><br><span class="line">mysqlPassword: devops1234!</span><br><span class="line"><span class="comment"># 此时k8s看到的是Init1234!的密码，但是实际是被下文init.sql中修改后的密码</span></span><br><span class="line"><span class="comment"># mysqlRootPassword: Init1234!</span></span><br><span class="line"><span class="comment"># 原节点挂掉后，无法创建新的pod，提示 rbd image xxx is still being used。此解决方法待验证</span></span><br><span class="line"><span class="comment"># strategy:</span></span><br><span class="line"><span class="comment">#   type: RollingUpdate</span></span><br><span class="line"><span class="comment">#   rollingUpdate:</span></span><br><span class="line"><span class="comment">#     maxSurge: 0</span></span><br><span class="line">service:</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  nodePort: 30000</span><br><span class="line">configurationFiles:</span><br><span class="line">  mysql_custom.cnf: |-</span><br><span class="line">    [mysqld]</span><br><span class="line">    skip-host-cache</span><br><span class="line">    skip-name-resolve</span><br><span class="line">    symbolic-links=0</span><br><span class="line">    lower_case_table_names=1</span><br><span class="line">    character-set-server=utf8mb4</span><br><span class="line">    collation-server=utf8mb4_bin</span><br><span class="line">    init-connect=<span class="string">'SET NAMES utf8mb4'</span></span><br><span class="line">    max_allowed_packet=1000M</span><br><span class="line">initializationFiles:</span><br><span class="line">  init.sql: |-</span><br><span class="line">    use mysql;</span><br><span class="line">    grant all privileges on *.* to <span class="string">'root'</span>@<span class="string">'%'</span> identified by <span class="string">'Hello1234!'</span> with grant option;</span><br><span class="line">    flush privileges;</span><br><span class="line">EOF</span><br><span class="line">helm install --name mysql-devops --namespace devops stable/mysql --version 1.4.0 -f mysql-values.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新报错</span></span><br><span class="line">helm upgrade mysql-devops stable/mysql --version 1.4.0 -f mysql-values.yaml</span><br><span class="line"><span class="comment"># helm upgrade mysql-devops stable/mysql --version 1.6.3 -f mysql-values.yaml # 基于新版本进行更新，不会删除此helm，只是做更新</span></span><br><span class="line">helm del --purge mysql-devops</span><br></pre></td></tr></table></figure><ul><li>k8s集群内部连接的主机名为 <code>mysql-devops.devops.svc.cluster.local</code></li></ul><h4 id="练手Helm"><a href="#练手Helm" class="headerlink" title="练手Helm"></a>练手Helm</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 准备</span></span><br><span class="line">helm repo update</span><br><span class="line"><span class="comment"># 查询 mysql 对应 Charts</span></span><br><span class="line">helm search mysql</span><br><span class="line"><span class="comment"># 查看charts的详细信息</span></span><br><span class="line">helm inspect values stable/mysql</span><br><span class="line"><span class="comment"># 创建PV. chart 定义了一个 PersistentVolumeClaim，申请 8G 的 PersistentVolume。如果不支持动态供给，可预先创建好相应的 PV。配置文件 mysql-pv.yaml 见下文</span></span><br><span class="line">kubectl create -f mysql-pv.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">## 安装</span></span><br><span class="line"><span class="comment"># 基于Charts安装k8s pods等。回显中说明如下</span></span><br><span class="line">    <span class="comment"># NAME：release 的名字，此时为 -n 参数指定，否则 Helm 随机生成一个</span></span><br><span class="line">    <span class="comment"># NAMESPACE：release 部署的 namespace(k8s的namespace)，**默认是 default，也可以通过 --namespace 指定**</span></span><br><span class="line">    <span class="comment"># STATUS：为 DEPLOYED 时，表示已经将 chart 部署到集群</span></span><br><span class="line">    <span class="comment"># RESOURCES：当前 release 包含的资源，命名的格式为 ReleasName-ChartName</span></span><br><span class="line">    <span class="comment"># NOTES：部分显示的是 release 的使用方法</span></span><br><span class="line">helm install stable/mysql -n my-dev --version 1.3.0 --<span class="built_in">set</span> mysqlRootPassword=Hello1234!</span><br><span class="line"><span class="comment"># 查看mysql信息资源信息(ReleasName-ChartName)，如下(此时可能没有PV导致pod处于Pending状态)</span></span><br><span class="line">kubectl get service my-dev-mysql</span><br><span class="line">kubectl get deployment my-dev-mysql</span><br><span class="line">kubectl get pvc my-dev-mysql</span><br><span class="line"><span class="comment"># 查看root密码</span></span><br><span class="line">kubectl get secret --namespace default my-dev-mysql -o jsonpath=<span class="string">"&#123;.data.mysql-root-password&#125;"</span> | base64 --decode; <span class="built_in">echo</span></span><br><span class="line"><span class="comment"># 显示已经部署的 release</span></span><br><span class="line">helm list --all</span><br><span class="line"></span><br><span class="line"><span class="comment">## 删除 release，也会删除相应k8s资源</span></span><br><span class="line">helm delete --purge my-dev</span><br><span class="line"></span><br><span class="line"><span class="comment">## 升级和回滚release</span></span><br><span class="line"><span class="comment"># 通过 --values 或 --set 应用新的配置</span></span><br><span class="line">helm upgrade --<span class="built_in">set</span> imageTag=5.7.15 my-dev stable/mysql</span><br><span class="line">helm upgrade --<span class="built_in">set</span> mysqlRootPassword=Hello1234! my-dev stable/mysql</span><br><span class="line"><span class="comment"># 查看 release 所有的版本</span></span><br><span class="line">helm <span class="built_in">history</span> my-dev</span><br><span class="line"><span class="comment"># 回滚到任何版本</span></span><br><span class="line">helm rollback my-dev 1</span><br></pre></td></tr></table></figure><ul><li>mysql-pv.yaml</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">mysql-pv1</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">mysql-pv1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  nfs:</span></span><br><span class="line"><span class="attr">    server:</span> <span class="number">192.168</span><span class="number">.6</span><span class="number">.10</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">/data/volumes/v1</span></span><br><span class="line"><span class="attr">  accessModes:</span> <span class="string">["ReadWriteOnce"]</span></span><br><span class="line"><span class="attr">  capacity:</span></span><br><span class="line"><span class="attr">    storage:</span> <span class="number">8</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">  persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br></pre></td></tr></table></figure><h3 id="cert-manager"><a href="#cert-manager" class="headerlink" title="cert-manager"></a>cert-manager</h3><blockquote><p><a href="https://hub.kubeapps.com/charts/jetstack/cert-manager" target="_blank" rel="noopener">https://hub.kubeapps.com/charts/jetstack/cert-manager</a></p></blockquote><p><img src="/data/images/devops/cert-manager.png" alt="cert-manager"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 安装</span></span><br><span class="line"><span class="comment"># 0.5.2安装成功后一直无法自动创建secret</span></span><br><span class="line"><span class="comment"># 0.6.7需要提前创建自定义资源，且在创建ClusterIssuer时还会报错 `Error creating ClusterIssuer: the server is currently unable to handle the request`</span></span><br><span class="line">helm repo add jetstack https://charts.jetstack.io</span><br><span class="line">helm repo update</span><br><span class="line"><span class="comment"># 创建自定义资源(issuer、clusterissuer、certificate等)</span></span><br><span class="line">kubectl apply --validate=<span class="literal">false</span> -f https://raw.githubusercontent.com/jetstack/cert-manager/release-0.12/deploy/manifests/00-crds.yaml</span><br><span class="line">kubectl get crd <span class="comment"># 查看Cert manager还提供的一些Kubernetes custom resources</span></span><br><span class="line"><span class="comment"># 安装，cert-manager-values.yaml参考下文</span></span><br><span class="line">helm install jetstack/cert-manager --version v0.12.0 --name cert-manager --namespace kube-system -f cert-manager-values.yaml</span><br><span class="line"><span class="comment"># helm upgrade cert-manager jetstack/cert-manager --version=v0.12.0 -f cert-manager-values.yaml # 更新</span></span><br><span class="line"><span class="comment"># 查看</span></span><br><span class="line">kubectl get pod -n kube-system --selector=app=cert-manager</span><br><span class="line"></span><br><span class="line"><span class="comment">## 创建证书签发机构。cert-manager 提供了 Issuer 和 ClusterIssuer 这两种用于创建签发机构的自定义资源对象。Issuer 只能用来签发自己所在 namespace 下的证书，ClusterIssuer 可以签发任意 namespace 下的证书</span></span><br><span class="line">vi cluster-issuer.yaml</span><br><span class="line">kubectl apply -f cluster-issuer.yaml</span><br><span class="line">kubectl get clusterissuer</span><br><span class="line"><span class="comment"># 或者如下述进行编辑后创建</span></span><br><span class="line"><span class="comment"># 创建 letsencrypt-staging(测试) 、letsencrypt-prod(正式，有频率限制，https://letsencrypt.org/docs/rate-limits/) 签发机构。必须修改里面的邮箱</span></span><br><span class="line"><span class="comment"># kubectl create --edit -f https://raw.githubusercontent.com/jetstack/cert-manager/release-0.12/docs/tutorials/acme/quick-start/example/staging-issuer.yaml</span></span><br><span class="line"><span class="comment"># 自定义此 Issuer 对应的命名空间</span></span><br><span class="line"><span class="comment"># kubectl create --edit -f https://raw.githubusercontent.com/jetstack/cert-manager/release-0.12/docs/tutorials/acme/quick-start/example/production-issuer.yaml --namespace=aezocn-prod</span></span><br><span class="line"><span class="comment"># kubectl get issuer</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 以k8s-dashboard测试</span></span><br><span class="line"><span class="comment"># **在ingress配置的annotation上加 `kubernetes.io/tls-acme: "true"`，则会自动创建 ingress.tls.secretName 对应的证书(Certificate)，且将此证书保存到secret中供ingress使用**</span></span><br><span class="line">kubectl get certificate -o wide -n kube-system <span class="comment">#  Certificate 为cert-manager自定义资源对象</span></span><br><span class="line">kubectl get secret -n kube-system <span class="comment"># 当删除对应的helm-release时，此秘钥不会被删除</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 卸载</span></span><br><span class="line">helm del --purge cert-manager</span><br><span class="line"><span class="comment"># 上述删除不会删除自定义资源，需手动删除。否则再次安装报错：Error: customresourcedefinitions.apiextensions.k8s.io "certificates.cert-manager.io" already exists</span></span><br><span class="line">kubectl delete -f https://raw.githubusercontent.com/jetstack/cert-manager/release-0.12/deploy/manifests/00-crds.yaml</span><br><span class="line"><span class="comment"># 删除对应的issuer，kubectl get &lt;issuer | clusterissuer&gt;</span></span><br></pre></td></tr></table></figure><ul><li>cert-manager-values.yaml</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">image:</span></span><br><span class="line"><span class="attr">  repository:</span> <span class="string">quay.mirrors.ustc.edu.cn/jetstack/cert-manager-controller</span></span><br><span class="line"><span class="comment"># webhook验证组件</span></span><br><span class="line"><span class="attr">webhook:</span></span><br><span class="line"><span class="attr">  image:</span></span><br><span class="line"><span class="attr">    repository:</span> <span class="string">quay.mirrors.ustc.edu.cn/jetstack/cert-manager-webhook</span></span><br><span class="line"><span class="attr">cainjector:</span></span><br><span class="line"><span class="attr">  image:</span></span><br><span class="line"><span class="attr">    repository:</span> <span class="string">quay.mirrors.ustc.edu.cn/jetstack/cert-manager-cainjector</span></span><br><span class="line"><span class="attr">ingressShim:</span></span><br><span class="line">  <span class="comment"># 配置一个缺省的cluster issuer，当部署Cert manager的时候，用于支持 `kubernetes.io/tls-acme: "true"` 的 annotation 来自动化 TLS</span></span><br><span class="line"><span class="attr">  defaultIssuerName:</span> <span class="string">letsencrypt-prod</span></span><br><span class="line"><span class="attr">  defaultIssuerKind:</span> <span class="string">ClusterIssuer</span></span><br></pre></td></tr></table></figure><ul><li>cluster-issuer.yaml</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">cert-manager.io/v1alpha2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterIssuer</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="comment"># 签发机构的名称，创建证书的时候会引用它</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">letsencrypt-staging</span></span><br><span class="line">  <span class="comment">#namespace: default # 上面kind为Issuer时可定义，ClusterIssuer表示整个集群通用</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># 使用acme协议。acme 协议的目的是证明这台机器和域名都是属于你的，然后才准许给你颁发证书</span></span><br><span class="line"><span class="attr">  acme:</span></span><br><span class="line">    <span class="comment"># acme 协议的服务端，这里用 Let’s Encrypt</span></span><br><span class="line"><span class="attr">    server:</span> <span class="attr">https://acme-staging-v02.api.letsencrypt.org/directory</span> <span class="comment"># letsencrypt-prod 对应的服务地址为 https://acme-v02.api.letsencrypt.org/directory</span></span><br><span class="line">    <span class="comment"># 证书快过期的时候会有邮件提醒。不过 cert-manager 会利用 acme 协议自动重新颁发证书来续期</span></span><br><span class="line"><span class="attr">    email:</span> <span class="string">admin@aezo.cn</span></span><br><span class="line"><span class="attr">    privateKeySecretRef:</span></span><br><span class="line">      <span class="comment"># 指示此签发机构的私钥将要存储到哪个 Secret 对象中</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">letsencrypt-staging</span></span><br><span class="line">    <span class="comment"># 这里指示签发机构使用 HTTP-01 的方式进行 acme 协议 (还可以用 DNS 方式，acme 协议的目的是证明这台机器和域名都是属于你的，然后才准许给你颁发证书)</span></span><br><span class="line"><span class="attr">    solvers:</span></span><br><span class="line"><span class="attr">    - http01:</span></span><br><span class="line"><span class="attr">        ingress:</span></span><br><span class="line"><span class="attr">          class:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure><ul><li>或者手动创建Certificate资源</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cert.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">cert-manager.io/v1alpha2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Certificate</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">dashboard-cert</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># 指示证书最终存到哪个 Secret 中</span></span><br><span class="line"><span class="attr">  secretName:</span> <span class="string">dashboard-cert</span></span><br><span class="line"><span class="attr">  issuerRef:</span></span><br><span class="line">    <span class="comment"># 我们创建的签发机构的名称 (ClusterIssuer.metadata.name)</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">letsencrypt-staging</span></span><br><span class="line">    <span class="comment"># 值为 ClusterIssuer 说明签发机构不在本 namespace 下，而是在全局</span></span><br><span class="line"><span class="attr">    kind:</span> <span class="string">ClusterIssuer</span></span><br><span class="line">  <span class="comment"># 指示该证书的可以用于哪些域名</span></span><br><span class="line"><span class="attr">  dnsNames:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">dashboard.k8s.aezo.cn</span></span><br><span class="line"><span class="attr">  acme:</span></span><br><span class="line"><span class="attr">    config:</span></span><br><span class="line"><span class="attr">    - http01:</span></span><br><span class="line">        <span class="comment"># 使用 HTTP-01 方式校验该域名和机器时，cert-manager 会尝试创建Ingress 对象来实现该校验，如果指定该值，会给创建的 Ingress 加上 kubernetes.io/ingress.class 这个 annotation，如果我们的 Ingress Controller 是 Nginx Ingress Controller，指定这个字段可以让创建的 Ingress 被 Nginx Ingress Controller 处理</span></span><br><span class="line"><span class="attr">        ingressClass:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="comment"># 指示该证书的可以用于哪些域名</span></span><br><span class="line"><span class="attr">      domains:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">dashboard.k8s.aezo.cn</span></span><br></pre></td></tr></table></figure><ul><li>使用参考<a href="#Kubernetes%20Dashboard">Kubernetes Dashboard</a></li><li>常见问题<ul><li>https网站在浏览器上仍然提示不安全，查看证书路径为<code>Fake LE Root X1 -&gt; Fake LE Intermediate X1 -&gt; dashboard.k8s.aezo.cn</code>，说明letsencrypt的环境为测试环境，<code>Fake LE Intermediate X1</code>为测试环境CA，参考：<a href="https://letsencrypt.org/zh-cn/docs/staging-environment/" target="_blank" rel="noopener">https://letsencrypt.org/zh-cn/docs/staging-environment/</a></li><li>进入pod查看nginx-ingress-controller的nginx.conf配置发现ssl_certificate和ssl_certificate_key都为<code>/etc/ingress-controller/ssl/default-fake-certificate.pem;</code>，这个只是一个占位为了让nginx不产生警告，实际nginx-ingress-controller是使用的动态ssl，通过lua脚本实现(对应参数ssl_certificate_by_lua_block)</li><li>查看cert-manager容器日志，提示<code>server misbehaving</code>，通过busybox测试pod发现容器无法访问外网</li><li>提示<code>dial tcp: lookup dashboard.k8s.aezo on 10.96.0.10:53: no such host</code>，将自定义域名的解析加入到corndns对应的configmap</li><li><strong>清除谷歌证书缓存</strong>：访问<code>chrome://net-internals/#hsts</code>，在<code>Delete domain security policies</code>中输入域名删除证书，然后重新打开浏览器</li></ul></li></ul><h3 id="ingress-nginx"><a href="#ingress-nginx" class="headerlink" title="ingress-nginx"></a>ingress-nginx</h3><blockquote><p><a href="https://hub.kubeapps.com/charts/stable/nginx-ingress" target="_blank" rel="noopener">https://hub.kubeapps.com/charts/stable/nginx-ingress</a> (基于kubernetes维护的ingress-nginx仓库实现)</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">helm repo update</span><br><span class="line"><span class="comment"># https://kubernetes.github.io/ingress-nginx</span></span><br><span class="line">helm inspect values stable/nginx-ingress --version 1.15.1</span><br><span class="line"><span class="comment"># (可选，如有单独的机器作为边缘节点) 选择边缘节点，并打上自定义标签(node-role.kubernetes.io/edge='')</span></span><br><span class="line">kubectl label node node1 node-role.kubernetes.io/edge=</span><br><span class="line"><span class="comment"># 修改参数启用RBAC. 否则报错：`User "system:serviceaccount:ingress-nginx:default" cannot get resource "services"`</span></span><br><span class="line">cat &gt; ingress-nginx.yaml &lt;&lt; EOF</span><br><span class="line">controller:</span><br><span class="line">  image:</span><br><span class="line">    repository: quay.mirrors.ustc.edu.cn/kubernetes-ingress-controller/nginx-ingress-controller</span><br><span class="line">  replicaCount: 1</span><br><span class="line">  <span class="comment"># 使用VIP地址达到负载均衡的效果(将域名绑定到此VIP，如果不设置可能无法通过域名访问。删除需要重新创建ingress-nginx-pod才会生效)</span></span><br><span class="line">  service:</span><br><span class="line">    <span class="comment"># 服务类型使用默认值LoadBalancer，此时需要指定externalIPs</span></span><br><span class="line">    <span class="built_in">type</span>: LoadBalancer</span><br><span class="line">    externalIPs:</span><br><span class="line">    - 192.168.6.129</span><br><span class="line">    <span class="comment"># # 服务类型使用NodePort，此时需要指定监听的节点端口nodePorts</span></span><br><span class="line">    <span class="comment"># type: NodePort</span></span><br><span class="line">    <span class="comment"># nodePorts:</span></span><br><span class="line">    <span class="comment">#   http: 30080</span></span><br><span class="line">    <span class="comment">#   https: 30443</span></span><br><span class="line">    <span class="comment">#   tcp: # 进行tcp代理的时候才需要，对应下文配置的tcp</span></span><br><span class="line">    <span class="comment">#     9000: 31000</span></span><br><span class="line">  <span class="comment"># 临时可使用宿主机网络测试(如果使用externalIPs则不能使用此属性)</span></span><br><span class="line">  <span class="comment">#hostNetwork: true</span></span><br><span class="line">  config:</span><br><span class="line">    <span class="comment"># 取消HSTS配置</span></span><br><span class="line">    hsts: <span class="string">"false"</span></span><br><span class="line">    <span class="comment"># 设置日志格式(此处使用json格式)</span></span><br><span class="line">    <span class="built_in">log</span>-format-upstream: <span class="string">'&#123;"time": "$time_iso8601", "remote_addr": "$remote_addr", "x-forward-for": "$proxy_add_x_forwarded_for",</span></span><br><span class="line"><span class="string">        "the_real_ip": $the_real_ip, "request_id": "$req_id", "remote_user": "$remote_user",</span></span><br><span class="line"><span class="string">        "bytes_sent": "$bytes_sent", "request_time": "$request_time", "status": "$status", "vhost": "$host",</span></span><br><span class="line"><span class="string">        "request_proto": "$server_protocol", "path": "$uri", "request_query": "$args", "request_length": "$request_length",</span></span><br><span class="line"><span class="string">        "duration": "$request_time", "method": "$request_method", "http_referrer": "$http_referer", "http_user_agent": "$http_user_agent"&#125;'</span></span><br><span class="line">    <span class="comment"># 允许跨域配置</span></span><br><span class="line">    <span class="comment"># 获取客户端真实IP(未成功)</span></span><br><span class="line">    <span class="comment">#use-forwarded-headers: "true"</span></span><br><span class="line">    <span class="comment">#proxy-real-ip-cidr: 10.244.0.0/0</span></span><br><span class="line">    <span class="comment">#compute-full-forwarded-for: "true"</span></span><br><span class="line">    <span class="comment">#forwarded-for-header: "X-Forwarded-For"</span></span><br><span class="line">    <span class="comment">## use-proxy-protocol: "true"</span></span><br><span class="line">  <span class="comment"># 选择含边缘标签的节点(上文有边缘节点才需要)</span></span><br><span class="line">  nodeSelector:</span><br><span class="line">    node-role.kubernetes.io/edge: <span class="string">''</span></span><br><span class="line">defaultBackend:</span><br><span class="line">  nodeSelector:</span><br><span class="line">    node-role.kubernetes.io/edge: <span class="string">''</span></span><br><span class="line">  image:</span><br><span class="line">    repository: registry.aliyuncs.com/google_containers/defaultbackend</span><br><span class="line">    tag: 1.3</span><br><span class="line"><span class="comment">## Enable RBAC</span></span><br><span class="line">rbac:</span><br><span class="line">  create: <span class="literal">true</span></span><br><span class="line"><span class="comment"># 进行tcp代理的时候才需要，9000为nginx-controller中开启的代理端口，后面表示代理的namespace/svc:port</span></span><br><span class="line">tcp:</span><br><span class="line">  9000: <span class="string">"monitoring/cat:2280"</span></span><br><span class="line">EOF</span><br><span class="line"><span class="comment"># 安装</span></span><br><span class="line">helm install stable/nginx-ingress --version 1.15.1 -n nginx-ingress --namespace ingress-nginx -f ingress-nginx.yaml</span><br><span class="line">kubectl get pod -n ingress-nginx -o wide</span><br><span class="line"><span class="comment"># 访问 curl https://192.168.6.131/ ，显示 `default backend - 404`/`404 page not found` 则正常</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># （注意：会导致集群的对外端点暂时不可用）更新部署的release（修改配置文件后执行）</span></span><br><span class="line">helm upgrade nginx-ingress stable/nginx-ingress --version 1.15.1 -f ingress-nginx.yaml</span><br><span class="line">helm del --purge nginx-ingress</span><br></pre></td></tr></table></figure><ul><li><p>开启TCP/UDP代理（暴露相应服务）</p><ul><li>参考：<a href="https://kubernetes.github.io/ingress-nginx/user-guide/exposing-tcp-udp-services/" target="_blank" rel="noopener">https://kubernetes.github.io/ingress-nginx/user-guide/exposing-tcp-udp-services/</a></li><li>说明：Ingress默认只能代理http，nginx却可以代理http/tcp/udp</li><li>配置参考上文的 <code>tcp</code> 和 <code>controller.service.nodePorts.tcp</code>。具体可参考stable/nginx-ingress中的chart文件</li><li><p>创建成功后，生成nginx.conf中如下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">stream &#123;</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    <span class="comment"># TCP services</span></span><br><span class="line">    server &#123;</span><br><span class="line">        preread_by_lua_block &#123;</span><br><span class="line">                ngx.var.proxy_upstream_name=<span class="string">"tcp-monitoring-cat-2280"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        listen                  9000;</span><br><span class="line"></span><br><span class="line">        proxy_timeout           600s;</span><br><span class="line">        proxy_pass              upstream_balancer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></li></ul><h3 id="Kubernetes-Dashboard"><a href="#Kubernetes-Dashboard" class="headerlink" title="Kubernetes Dashboard"></a>Kubernetes Dashboard</h3><blockquote><p><a href="https://hub.kubeapps.com/charts/stable/kubernetes-dashboard" target="_blank" rel="noopener">https://hub.kubeapps.com/charts/stable/kubernetes-dashboard</a></p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 提前创建tls类型的secret，名称为k8s-dashboard-tls。否则无法访问，会显示`default backend - 404`。下文 kubernetes-dashboard.yaml 配置中使用 certmanager 自动创建证书</span></span><br><span class="line"><span class="comment"># 手动创建证书(或者采用certmanager自动生成证书)</span></span><br><span class="line"><span class="comment">#openssl genrsa -out aezocn.key 2048</span></span><br><span class="line"><span class="comment">#openssl req -new -x509 -key aezocn.key -out aezocn.crt -subj /C=CN/ST=Beijing/L=Beijing/O=DevOps/CN=k8s.aezo.cn # 此处CN=k8s.aezo.cn一定要对应</span></span><br><span class="line"><span class="comment">#kubectl create secret tls k8s-dashboard-tls --cert=aezocn.crt --key=aezocn.key</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 安装</span></span><br><span class="line"><span class="comment"># 如下文创建配置文件</span></span><br><span class="line">vi kubernetes-dashboard.yaml</span><br><span class="line">helm install stable/kubernetes-dashboard --version 1.8.0 -n kubernetes-dashboard --namespace kube-system -f kubernetes-dashboard.yaml</span><br><span class="line"><span class="comment">## 更新/删除</span></span><br><span class="line">helm upgrade kubernetes-dashboard stable/kubernetes-dashboard --version 1.8.0 -f kubernetes-dashboard.yaml</span><br><span class="line">helm del --purge kubernetes-dashboard</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看状态和登录token</span></span><br><span class="line">kubectl -n kube-system get pods</span><br><span class="line">kubectl get secret $(kubectl get secret -n kube-system|grep kubernetes-dashboard-token|awk <span class="string">'&#123;print $1&#125;'</span>) -n kube-system -o jsonpath=&#123;.data.token&#125;|base64 -d |xargs <span class="built_in">echo</span></span><br><span class="line"><span class="comment"># 修改token过期时间(session过期时间)，默认是15分钟(900秒)：在 `- --auto-generate-certificates` 下加一行参数 `- --token-ttl=31536000‬` (1年有效)</span></span><br><span class="line">kubectl edit deployment kubernetes-dashboard -n kube-system</span><br><span class="line"><span class="comment"># 创建只能访问某命名空间的sa账户参考[kubernetes](/_posts/devops/kubernetes.md)</span></span><br></pre></td></tr></table></figure><ul><li>kubernetes-dashboard.yaml</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">image:</span></span><br><span class="line"><span class="attr">  repository:</span> <span class="string">registry.aliyuncs.com/google_containers/kubernetes-dashboard-amd64</span> </span><br><span class="line"><span class="attr">  tag:</span> <span class="string">v1.10.1</span></span><br><span class="line"><span class="attr">ingress:</span></span><br><span class="line"><span class="attr">  enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  hosts:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">k8s.aezo.cn</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="comment">## https</span></span><br><span class="line">    <span class="comment"># 是否强制跳转https</span></span><br><span class="line">    <span class="string">nginx.ingress.kubernetes.io/ssl-redirect:</span> <span class="string">"true"</span></span><br><span class="line">    <span class="comment"># 如kubernetes-dashboard需要实现tls访问，则需要加入此注解。否则提示"无法访问此网页"，且ingress-nginx容器日志报错"ingress dashboard upstream sent no valid HTTP/1.0 header while reading response header from upstream". </span></span><br><span class="line">        <span class="comment"># This annotation was deprecated in 0.18.0 and removed after the release of 0.20.0，之前为 `nginx.ingress.kubernetes.io/secure-backends: "true"`</span></span><br><span class="line">        <span class="comment"># 参考：http://bbs.bugcode.cn/t/18544 、https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#backend-protocol</span></span><br><span class="line">    <span class="string">nginx.ingress.kubernetes.io/backend-protocol:</span> <span class="string">"HTTPS"</span></span><br><span class="line">    <span class="comment">## certmanager</span></span><br><span class="line">    <span class="comment"># 加上此注解cert-manager会自动生成k8s-dashboard-tls对应的证书和secret。如果未安装cert-manager，则需要提前手动创建好证书和secret。如果无证书则使用默认证书</span></span><br><span class="line">    <span class="string">kubernetes.io/tls-acme:</span> <span class="string">"true"</span></span><br><span class="line">    <span class="comment"># 如果设置了默认的cluster-issuer，且kubernetes.io/tls-acme: "true"时，则此参数可省略。如默认设置为letsencrypt-prod，为了测试，可将手动指定为letsencrypt-staging</span></span><br><span class="line">    <span class="comment"># cert-manager.io/cluster-issuer: letsencrypt-staging</span></span><br><span class="line"><span class="attr">  tls:</span></span><br><span class="line"><span class="attr">  - secretName:</span> <span class="string">k8s-dashboard-tls</span></span><br><span class="line"><span class="attr">    hosts:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">k8s.aezo.cn</span></span><br><span class="line"><span class="comment"># 选择运行在master节点上</span></span><br><span class="line"><span class="attr">nodeSelector:</span></span><br><span class="line">  <span class="string">node-role.kubernetes.io/master:</span> <span class="string">''</span></span><br><span class="line"><span class="attr">tolerations:</span></span><br><span class="line"><span class="attr">- key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line"><span class="attr">  operator:</span> <span class="string">Exists</span></span><br><span class="line"><span class="attr">  effect:</span> <span class="string">NoSchedule</span></span><br><span class="line"><span class="attr">- key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line"><span class="attr">  operator:</span> <span class="string">Exists</span></span><br><span class="line"><span class="attr">  effect:</span> <span class="string">PreferNoSchedule</span></span><br><span class="line"><span class="attr">rbac:</span></span><br><span class="line"><span class="attr">  clusterAdminRole:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h3 id="nfs-client-provisioner"><a href="#nfs-client-provisioner" class="headerlink" title="nfs-client-provisioner"></a>nfs-client-provisioner</h3><blockquote><p><a href="https://hub.kubeapps.com/charts/stable/nfs-client-provisioner" target="_blank" rel="noopener">https://hub.kubeapps.com/charts/stable/nfs-client-provisioner</a></p></blockquote><ul><li>nfs默认无法自动申请PV；在对应命名空间安装nfs-client-provisioner，则会自动申请并创建PV</li><li>nfs服务器设置如<code>rw,sync,no_subtree_check,no_root_squash</code>，如果不设置成no_root_squash会导致像基于Chart安装mysql会失败(无法修改文件所属者)</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 安装</span></span><br><span class="line">helm install --name nfs-client-provisioner --namespace <span class="built_in">test</span> stable/nfs-client-provisioner --version=1.2.6 \</span><br><span class="line">--<span class="built_in">set</span> image.repository=quay.mirrors.ustc.edu.cn/external_storage/nfs-client-provisioner \</span><br><span class="line">--<span class="built_in">set</span> nfs.server=192.168.6.130 \</span><br><span class="line">--<span class="built_in">set</span> nfs.path=/home/data/nfs </span><br><span class="line"><span class="comment"># --set storageClass.reclaimPolicy=Retain</span></span><br><span class="line"><span class="comment"># 安装成功后，会创建StorageClass为nfs-client</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># helm upgrade nfs-client-provisioner stable/nfs-client-provisioner --version=1.2.6</span></span><br><span class="line">helm del --purge nfs-client-provisioner</span><br><span class="line"></span><br><span class="line"><span class="comment">## 使用</span></span><br><span class="line"><span class="comment"># 在PVC中定义 storageClassName 为 nfs-client，则会自动申请并创建PV</span></span><br><span class="line"><span class="comment"># 会在NFS服务器对应目录生成 `$&#123;namespace&#125;-$&#123;pvcName&#125;-$&#123;pvName&#125;`的子目录；如果该PV解绑了，则改目录会重命名为 `archived-$&#123;namespace&#125;-$&#123;pvcName&#125;-$&#123;pvName&#125;`</span></span><br></pre></td></tr></table></figure><h3 id="Prometheus"><a href="#Prometheus" class="headerlink" title="Prometheus"></a>Prometheus</h3><ul><li>Prometheus相关参考<a href="/_posts/devops/prometheus.md">prometheus</a></li></ul><blockquote><p>参考：<a href="https://hub.kubeapps.com/charts/stable/prometheus" target="_blank" rel="noopener">https://hub.kubeapps.com/charts/stable/prometheus</a></p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line">helm repo update</span><br><span class="line"><span class="comment"># helm inspect values stable/prometheus --version 9.0.0</span></span><br><span class="line"><span class="comment"># helm fetch stable/prometheus --version 9.0.0 &amp;&amp; tar -zxvf prometheus-9.0.0.tgz</span></span><br><span class="line"></span><br><span class="line">cat &gt; prometheus-values.yaml &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line"><span class="comment"># server会自动拉取kubernetes-service-endpoints和pushgateway节点</span></span><br><span class="line">server:</span><br><span class="line">  persistentVolume:</span><br><span class="line">    <span class="comment"># 如通过rook创建的sc，会自动创建pvc和pv</span></span><br><span class="line">    storageClass: <span class="string">"monitoring-sc-01"</span></span><br><span class="line">  ingress:</span><br><span class="line">    <span class="comment">#enabled: true</span></span><br><span class="line">    hosts:</span><br><span class="line">    - prometheus.k8s.aezo.cn</span><br><span class="line">pushgateway:</span><br><span class="line">  persistentVolume:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">    storageClass: <span class="string">"monitoring-sc-01"</span></span><br><span class="line">  ingress:</span><br><span class="line">    <span class="comment"># 可设置白名单，如下文alertmanager配置</span></span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">    hosts:</span><br><span class="line">    - pushgateway.prometheus.k8s.aezo.cn</span><br><span class="line">    annotations:</span><br><span class="line">      kubernetes.io/tls-acme: <span class="string">"true"</span></span><br><span class="line">    tls:</span><br><span class="line">    - secretName: prometheus-pushgateway-tls</span><br><span class="line">      hosts:</span><br><span class="line">      - pushgateway.prometheus.k8s.aezo.cn</span><br><span class="line"><span class="comment"># 扩展监控的node_export。如果使用 serverFiles.prometheus.yml.scrape_configs 参数则会覆盖value.yaml所有的scrape_configs</span></span><br><span class="line"><span class="comment"># extraScrapeConfigs后面必须跟字符串，此处必须使用 | 进行转换；且此时`- job_name`前必须保留2个空格</span></span><br><span class="line">extraScrapeConfigs: |</span><br><span class="line">  - job_name: <span class="string">'node-test'</span></span><br><span class="line">    <span class="comment"># metrics_path: /metrics</span></span><br><span class="line">    scrape_interval: 5s</span><br><span class="line">    static_configs:</span><br><span class="line">    - targets: [<span class="string">'192.168.6.130:9100'</span>]</span><br><span class="line">  <span class="comment"># 需要安装Prometheus Blackbox Exporter，参考下文。详细配置参考 [http://blog.aezo.cn/2019/09/19/devops/prometheus/](/_posts/devops/prometheus.md#blackbox_exporter%20网络探测-黑盒监控(官方))</span></span><br><span class="line">  - job_name: <span class="string">'blackbox_http_2xx_prod'</span></span><br><span class="line">    scrape_interval: 30s</span><br><span class="line">    metrics_path: /probe</span><br><span class="line">    params:</span><br><span class="line">      module: [http_2xx]</span><br><span class="line">    static_configs:</span><br><span class="line">    - targets:</span><br><span class="line">      - https://www.baidu.com/</span><br><span class="line">      - 172.0.0.1:9090</span><br><span class="line">    relabel_configs:</span><br><span class="line">    - source_labels: [__address__]</span><br><span class="line">      target_label: __param_target</span><br><span class="line">    - source_labels: [__param_target]</span><br><span class="line">      target_label: instance</span><br><span class="line">    - target_label: __address__</span><br><span class="line">      replacement: prometheus-blackbox-exporter:9115</span><br><span class="line">alertmanager:</span><br><span class="line">  persistentVolume:</span><br><span class="line">    storageClass: <span class="string">"monitoring-sc-01"</span></span><br><span class="line">  ingress:</span><br><span class="line">    <span class="comment">#enabled: true</span></span><br><span class="line">    annotations:</span><br><span class="line">      <span class="comment"># 设置可访问的白名单</span></span><br><span class="line">      nginx.ingress.kubernetes.io/whitelist-source-range: 192.168.6.0/24</span><br><span class="line">    hosts:</span><br><span class="line">    - alertmanager.prometheus.k8s.aezo.cn</span><br><span class="line">alertmanagerFiles:</span><br><span class="line">  alertmanager.yml:</span><br><span class="line">    global:</span><br><span class="line">      smtp_smarthost: <span class="string">'smtp.163.com:25'</span></span><br><span class="line">      smtp_from: <span class="string">'aezo-prometheus&lt;aezocn@163.com&gt;'</span></span><br><span class="line">      smtp_auth_username: <span class="string">'aezocn@163.com'</span></span><br><span class="line">      smtp_auth_password: <span class="string">'XXX'</span></span><br><span class="line">    route:</span><br><span class="line">      receiver: <span class="string">'default-receiver'</span></span><br><span class="line">      routes:</span><br><span class="line">      - match:</span><br><span class="line">          aezo_env: prod</span><br><span class="line">          aezo_webhook: pybiz</span><br><span class="line">        receiver: pybiz-webhook</span><br><span class="line">        group_wait: 5s</span><br><span class="line">        group_interval: 3m</span><br><span class="line">        repeat_interval: 15m</span><br><span class="line">        <span class="built_in">continue</span>: <span class="literal">true</span></span><br><span class="line">      - match:</span><br><span class="line">          severity: warning</span><br><span class="line">        receiver: slack-receiver</span><br><span class="line">    receivers:</span><br><span class="line">    - name: <span class="string">'default-receiver'</span></span><br><span class="line">      email_configs:</span><br><span class="line">      - to: <span class="string">'aezocn@163.com'</span></span><br><span class="line">        send_resolved: <span class="literal">true</span></span><br><span class="line">    - name: <span class="string">'slack-receiver'</span></span><br><span class="line">      slack_configs:</span><br><span class="line">      - send_resolved: <span class="literal">true</span></span><br><span class="line">        api_url: https://hooks.slack.com/services/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</span><br><span class="line">        channel: <span class="string">'monitor'</span></span><br><span class="line">        text: <span class="string">"&#123;&#123; .CommonAnnotations.description &#125;&#125;"</span></span><br><span class="line">    - name: <span class="string">'pybiz-webhook'</span></span><br><span class="line">      webhook_configs:</span><br><span class="line">      - url: <span class="string">'https://192.168.1.100/api/v1/monitor/script/call_run/?Token=f80deca4095accae753f23913a65e7256a855345'</span></span><br><span class="line">serverFiles:</span><br><span class="line">  <span class="comment"># 常用报警规则，可选</span></span><br><span class="line">  alerts:</span><br><span class="line">    groups:</span><br><span class="line">    - name: node-resource</span><br><span class="line">      rules:</span><br><span class="line">      - alert: node-cpu-higher</span><br><span class="line">        expr: (100 - avg (irate(node_cpu_seconds_total&#123;mode=<span class="string">"idle"</span>&#125;[5m])) by (instance) * 100) &gt; 90</span><br><span class="line">        <span class="keyword">for</span>: 2m</span><br><span class="line">        labels:</span><br><span class="line">          severity: warning</span><br><span class="line">        annotations:</span><br><span class="line">          summary: <span class="string">'&#123;&#123;$labels.instance&#125;&#125;: CPU使用过高'</span></span><br><span class="line">          description: <span class="string">'详细信息：&#123;&#123;$labels.instance&#125;&#125; 在 2 分钟内，CPU使用率一直超过 90% (当前值为: &#123;&#123; $value &#125;&#125;)'</span></span><br><span class="line">      - alert: node-mem-higher</span><br><span class="line">        expr: (node_memory_MemTotal_bytes - (node_memory_MemFree_bytes+node_memory_Buffers_bytes+node_memory_Cached_bytes )) / node_memory_MemTotal_bytes * 100 &gt; 90</span><br><span class="line">        <span class="keyword">for</span>: 2m</span><br><span class="line">        labels:</span><br><span class="line">          severity: warning</span><br><span class="line">        annotations:</span><br><span class="line">          summary: <span class="string">'&#123;&#123;$labels.instance&#125;&#125;: 内存使用过高'</span></span><br><span class="line">          description: <span class="string">'详细信息：&#123;&#123;$labels.instance&#125;&#125; 在 2 分钟内，内存使用率一直超过 90% (当前值为: &#123;&#123; $value &#125;&#125;)'</span></span><br><span class="line">      - alert: node-disk-higher</span><br><span class="line">        expr: ((node_filesystem_size_bytes&#123;mountpoint=<span class="string">"/"</span>&#125; - node_filesystem_free_bytes&#123;mountpoint=<span class="string">"/"</span>&#125;) / node_filesystem_size_bytes&#123;mountpoint=<span class="string">"/"</span>&#125; * 100) &gt; 85</span><br><span class="line">        <span class="keyword">for</span>: 1m</span><br><span class="line">        labels:</span><br><span class="line">          severity: warning</span><br><span class="line">        annotations:</span><br><span class="line">          summary: <span class="string">'&#123;&#123;$labels.instance&#125;&#125;: 磁盘空间不足'</span></span><br><span class="line">          description: <span class="string">'详细信息：&#123;&#123;$labels.instance&#125;&#125; 磁盘 &#123;&#123; $labels.device &#125;&#125; 使用率超过 85% (当前值为: &#123;&#123; $value &#125;&#125;)'</span></span><br><span class="line">    - name: prometheus</span><br><span class="line">      rules:</span><br><span class="line">      - alert: prometheus-job-down</span><br><span class="line">        expr: up&#123;job=<span class="string">"node-test"</span>&#125; == 0 or up&#123;job=<span class="string">"blackbox_http_k8s"</span>&#125; == 0 or up&#123;job=<span class="string">"blackbox_http_external"</span>&#125; == 0</span><br><span class="line">        <span class="keyword">for</span>: 10s</span><br><span class="line">        labels:</span><br><span class="line">          severity: warning</span><br><span class="line">        annotations:</span><br><span class="line">          summary: <span class="string">"Prometheus 任务 &#123;&#123; <span class="variable">$labels</span>.job &#125;&#125; 执行异常"</span></span><br><span class="line">    - name: probe-http</span><br><span class="line">      rules:</span><br><span class="line">      - alert: probe-http-prod</span><br><span class="line">        expr: probe_success == 0</span><br><span class="line">        <span class="keyword">for</span>: 20s</span><br><span class="line">        annotations:</span><br><span class="line">          summary: <span class="string">"网站 &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; 访问异常"</span></span><br><span class="line">EOF</span><br><span class="line">helm install --name prometheus --namespace monitoring stable/prometheus --version 9.0.0 -f prometheus-values.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新后会自动重新加载prometheus配置文件。如果配置文件应用更新出错，不会有报错提示，看看prometheus-server的日志即可</span></span><br><span class="line">helm upgrade prometheus stable/prometheus --version 9.0.0 -f prometheus-values.yaml</span><br><span class="line">helm del --purge prometheus</span><br><span class="line"></span><br><span class="line"><span class="comment"># k8s内部server地址(Grafana添加数据源需要)：prometheus-server.monitoring.svc.cluster.local</span></span><br><span class="line"><span class="comment"># k8s内部重新创建 prometheus-server-pod 绑定的 PV 并不会丢失</span></span><br></pre></td></tr></table></figure><h3 id="Grafana"><a href="#Grafana" class="headerlink" title="Grafana"></a>Grafana</h3><blockquote><p>参考：<a href="https://hub.kubeapps.com/charts/stable/grafana" target="_blank" rel="noopener">https://hub.kubeapps.com/charts/stable/grafana</a></p></blockquote><ul><li>安装</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl create secret generic grafana-secret -n monitoring --from-literal=admin-user=admin --from-literal=admin-password=Hello1234</span></span><br><span class="line">cat &gt; grafana-values.yaml &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">image:</span><br><span class="line">  repository: docker.mirrors.ustc.edu.cn/grafana/grafana</span><br><span class="line">admin:</span><br><span class="line">  existingSecret: <span class="string">'grafana-secret'</span> <span class="comment"># 可自定义admin Secret(参考上文)。默认会自动生成名为grafana的Secret(包含admin账号和密码)</span></span><br><span class="line">  <span class="comment"># userKey: 'admin-user' # 指定admin Secret(map)文件中获取admin账号对应的key，默认key为admin-user。passwordKey同理</span></span><br><span class="line">  <span class="comment"># passwordKey: 'admin-password'</span></span><br><span class="line">persistence:</span><br><span class="line">  enabled: <span class="literal">true</span></span><br><span class="line">  <span class="built_in">type</span>: <span class="string">'pvc'</span></span><br><span class="line">  storageClassName: <span class="string">'nfs-client'</span></span><br><span class="line">env:</span><br><span class="line">  <span class="comment"># 强制使用go进行dns解析，解决前台界面随机出现502问题，具体参考下文</span></span><br><span class="line">  GODEBUG: netdns=go</span><br><span class="line">ingress:</span><br><span class="line">  enabled: <span class="literal">true</span></span><br><span class="line">  hosts:</span><br><span class="line">  - grafana.k8s.aezo.cn</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/tls-acme: <span class="string">"true"</span></span><br><span class="line">  tls:</span><br><span class="line">  - secretName: grafana-tls</span><br><span class="line">    hosts:</span><br><span class="line">    - grafana.k8s.aezo.cn</span><br><span class="line"><span class="comment"># https://grafana.com/docs/installation/configuration/</span></span><br><span class="line">grafana.ini:</span><br><span class="line">  smtp:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">    host: <span class="string">"smtp.gmail.com:587"</span></span><br><span class="line">    user: <span class="string">"test@gmail.com"</span></span><br><span class="line">    password: <span class="string">"pass"</span></span><br><span class="line"><span class="comment"># 使用NFS存储时，初始化容器chown运行出错，此处禁用初始化过程。另可参考：https://github.com/helm/charts/issues/1071</span></span><br><span class="line"><span class="comment"># 可能由于NFS权限没有设置成no_root_squash</span></span><br><span class="line">initChownData:</span><br><span class="line">  enabled: <span class="literal">false</span></span><br><span class="line">EOF</span><br><span class="line">helm install --name grafana --namespace monitoring stable/grafana --version 3.10.2 -f grafana-values.yaml <span class="comment"># Grafana v6.4.2</span></span><br><span class="line"></span><br><span class="line">helm upgrade grafana stable/grafana --version 3.10.2 -f grafana-values.yaml</span><br><span class="line">helm del --purge grafana</span><br></pre></td></tr></table></figure><ul><li>使用<ul><li>增加数据源，数据源地址如<code>http://prometheus-server.monitoring.svc.cluster.local</code></li><li>具体参考<a href="/_posts/devops/prometheus.md#Grafana">Grafana</a></li></ul></li><li>常见问题<ul><li>管理面板会随机出现有些请求不成功，提示502，grafana日志显示<code>http: proxy error: dial tcp: lookup prometheus-server.monitoring.svc.cluster.local: no such host</code>。参考 <a href="https://github.com/linkerd/linkerd2/pull/4600" target="_blank" rel="noopener">^4</a><ul><li>在6.4版中，Grafana将其基本映像从Ubuntu切换到了Alpine，从而部分机器会出现DNS解析失败的问题。因此从Grafana 6.5开始，他们提供了两个图像，一个基于Alpine，另一个基于Ubuntu。<a href="https://github.com/linkerd/linkerd2/pull/4600#issuecomment-645012122" target="_blank" rel="noopener">https://github.com/linkerd/linkerd2/pull/4600#issuecomment-645012122</a></li><li>解决方案（使用方法一解决成功）：(1) 增加<code>GODEBUG: netdns=go</code>的环境变量，可强制使用go DNS解析器而不是OS的解析器，参考上文yaml文件 (2) 或者换成Ubuntu的镜像</li></ul></li></ul></li></ul><h3 id="Prometheus-Blackbox-Exporter"><a href="#Prometheus-Blackbox-Exporter" class="headerlink" title="Prometheus Blackbox Exporter"></a>Prometheus Blackbox Exporter</h3><blockquote><p>参考：<a href="https://hub.kubeapps.com/charts/stable/prometheus-blackbox-exporter" target="_blank" rel="noopener">https://hub.kubeapps.com/charts/stable/prometheus-blackbox-exporter</a></p></blockquote><ul><li>网络异常/性能监控，常见的是http_get,http_post,tcp,icmp监控模式</li><li>安装 <a href="https://www.cnblogs.com/aguncn/p/9933204.html" target="_blank" rel="noopener">^3</a></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; prometheus-blackbox-exporter-values.yaml &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">config:</span><br><span class="line">  modules:</span><br><span class="line">    http_2xx:</span><br><span class="line">      timeout: 10s</span><br><span class="line">EOF</span><br><span class="line">helm install --name prometheus-blackbox-exporter --namespace monitoring stable/prometheus-blackbox-exporter --version 1.5.1 -f prometheus-blackbox-exporter-values.yaml</span><br><span class="line"></span><br><span class="line">helm upgrade prometheus-blackbox-exporter stable/prometheus-blackbox-exporter --version 1.5.1 -f prometheus-blackbox-exporter-values.yaml</span><br><span class="line">helm del --purge prometheus-blackbox-exporter</span><br></pre></td></tr></table></figure><h3 id="Postgresql"><a href="#Postgresql" class="headerlink" title="Postgresql"></a>Postgresql</h3><blockquote><p><a href="https://hub.kubeapps.com/charts/stable/postgresql" target="_blank" rel="noopener">https://hub.kubeapps.com/charts/stable/postgresql</a></p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; postgresql-values.yaml &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">global:</span><br><span class="line">  postgresql:</span><br><span class="line">    <span class="comment"># postgres 账户密码</span></span><br><span class="line">    postgresqlPassword: Hello1234!</span><br><span class="line">persistence:</span><br><span class="line">  storageClass: <span class="string">'nfs-client'</span></span><br><span class="line">service:</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  nodePort: 30000</span><br><span class="line">EOF</span><br><span class="line">helm install --name postgresql-devops --namespace devops stable/postgresql --version=6.5.3 -f postgresql-values.yaml</span><br><span class="line"></span><br><span class="line">helm upgrade postgresql-devops stable/postgresql --version=6.5.3 -f postgresql-values.yaml</span><br><span class="line">helm del --purge postgresql-devops</span><br></pre></td></tr></table></figure><h4 id="数据迁移-成功"><a href="#数据迁移-成功" class="headerlink" title="数据迁移(成功)"></a>数据迁移(成功)</h4><ul><li>ceph存储使用说明<ul><li>基于helm部署，如果删除helm-release则会与原PV关联断开，即使重新部署也会产生新的PV</li><li>如果仅仅删除pod，则原PV是继续使用的(RS会重新创建)</li></ul></li><li>数据迁移</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 备份数据到新pv(此处将文件整体备份，还可导出数据库配置进行备份)</span></span><br><span class="line"><span class="comment"># 1.tar打包原数据；创建新pvc(会自动创建新pv)省略</span></span><br><span class="line">rbd map --name client.admin kube/kubernetes-dynamic-pvc-64748f59-92ce-11ea-bc8c-3e7edb1ad634 <span class="comment"># 映射，生成原镜像设备名称，输出如 `/dev/rbd0`</span></span><br><span class="line">mount /dev/rbd0 /mnt <span class="comment"># 临时挂载，打包原数据</span></span><br><span class="line">umount /mnt <span class="comment"># 卸载设备</span></span><br><span class="line">rbd unmap /dev/rbd0 <span class="comment"># 取消映射</span></span><br><span class="line"><span class="comment"># 2.(此处使用ceph存储)映射-创建文件系统-临时挂载</span></span><br><span class="line">rbd map --name client.admin kube/kubernetes-dynamic-pvc-4c04b64e-09c0-11ea-89b1-5aa8347da671 <span class="comment"># 输出 `/dev/rbd2`</span></span><br><span class="line">mkfs.ext4 -m2 /dev/rbd/kube/kubernetes-dynamic-pvc-4c04b64e-09c0-11ea-89b1-5aa8347da671</span><br><span class="line">mount /dev/rbd2 /mnt</span><br><span class="line"><span class="comment"># 3.复制tar包数据到临时挂载目录</span></span><br><span class="line"><span class="comment"># 4.卸载原挂载目录(卸载目录时不能有用户处于/mnt目录)</span></span><br><span class="line">umount /dev/rbd2</span><br><span class="line">rbd unmap /dev/rbd2</span><br><span class="line"><span class="comment"># 5.注释掉原 persistence.storageClass 配置，增加 persistence.existingClaim 配置为新的pvc</span></span><br><span class="line"><span class="comment"># 6.重新创建chart</span></span><br><span class="line"><span class="comment"># 7.删除原镜像</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 或者先创建好pod，然后再将原数据复制到自动挂载的目录</span></span><br></pre></td></tr></table></figure><h3 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h3><blockquote><p><a href="https://hub.kubeapps.com/charts/stable/redis" target="_blank" rel="noopener">https://hub.kubeapps.com/charts/stable/redis</a></p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; redis-values.yaml &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">password: Hello1234!</span><br><span class="line">master:</span><br><span class="line">  persistence:</span><br><span class="line">    storageClass: <span class="string">'nfs-client'</span></span><br><span class="line">  service:</span><br><span class="line">    <span class="built_in">type</span>: NodePort</span><br><span class="line">    nodePort: 30000</span><br><span class="line">  configmap: |-</span><br><span class="line">    appendfsync everysec</span><br><span class="line">slave:</span><br><span class="line">  persistence:</span><br><span class="line">    storageClass: <span class="string">'nfs-client'</span></span><br><span class="line">  service:</span><br><span class="line">    <span class="built_in">type</span>: NodePort</span><br><span class="line">    nodePort: 30001</span><br><span class="line">EOF</span><br><span class="line">helm install --name redis-devops --namespace devops stable/redis --version=9.5.0 -f redis-values.yaml</span><br><span class="line"></span><br><span class="line">helm upgrade redis-devops stable/redis --version=9.5.0 -f redis-values.yaml</span><br><span class="line">helm del --purge redis-devops</span><br></pre></td></tr></table></figure><ul><li>数据迁移(试用)<ul><li>备份master数据到新pv(如果是ceph创建的pv可先进行映射、创建文件系统、临时挂载，然后复制原数据到新pv)</li><li>增加<code>persistence.existingClaim</code>参数指向新的创建好的pvc(master会使用此pvc)，因此master无需指定<code>master.persistence.storageClass</code>，但slave仍需指定<code>slave.persistence.storageClass</code></li><li>重新创建chart，在创建master-pod时提示<code>Bad file format reading the append only file: make a backup of your AOF file, then use ./redis-check-aof --fix &lt;filename&gt;</code><ul><li>先将pod启动参数设置成<code>sleep 1h</code>进行调试</li><li>进入pod后，先执行<code>cp data/appendonly.aof data/appendonly.aof.bak</code>，然后执行<code>redis-check-aof --fix data/appendonly.aof</code>输入Y进行AOF文件修复(一般为redis突然掉电导致aof文件损坏，此前由于直接删除原pod导致)</li><li>还原pod原始启动参数并重新启动</li></ul></li><li>测试时数据貌似有丢失?? 0.0</li></ul></li></ul><h3 id="MongoDB"><a href="#MongoDB" class="headerlink" title="MongoDB"></a>MongoDB</h3><blockquote><p><a href="https://github.com/bitnami/charts/blob/master/bitnami/mongodb/README.md" target="_blank" rel="noopener">https://github.com/bitnami/charts/blob/master/bitnami/mongodb/README.md</a></p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">helm repo add bitnami https://charts.bitnami.com/bitnami</span><br><span class="line"></span><br><span class="line">cat &gt; mongodb-values.yaml &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">image:</span><br><span class="line">  <span class="comment"># registry: docker.mirrors.ustc.edu.cn # 国内镜像下载不成功</span></span><br><span class="line">  tag: 4.2.6</span><br><span class="line">mongodbRootPassword: Hello1234!</span><br><span class="line">service:</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  nodePort: 30000</span><br><span class="line">persistence:</span><br><span class="line">  storageClass: <span class="string">'nfs-client'</span></span><br><span class="line">EOF</span><br><span class="line">helm install --name mongodb-devops --namespace devops bitnami/mongodb --version=7.12.0 -f mongodb-values.yaml</span><br><span class="line"><span class="comment"># 使用root账号连接默认数据库(admin): `mongo --host 192.168.6.130 --port 30000 --authenticationDatabase admin -u root -p Hello1234!` 使用 Robo 3T 1.3 客户端连接时，秘钥方式选择SCRAM-SHA-1</span></span><br><span class="line"></span><br><span class="line">helm upgrade mongodb-devops bitnami/mongodb --version=7.12.0 -f mongodb-values.yaml</span><br><span class="line">helm del --purge mongodb-devops</span><br></pre></td></tr></table></figure><h3 id="Harbor"><a href="#Harbor" class="headerlink" title="Harbor"></a>Harbor</h3><blockquote><p><a href="https://hub.kubeapps.com/charts/harbor/harbor" target="_blank" rel="noopener">https://hub.kubeapps.com/charts/harbor/harbor</a> 、 <a href="https://www.qikqiak.com/post/harbor-quick-install/" target="_blank" rel="noopener">https://www.qikqiak.com/post/harbor-quick-install/</a></p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 安装(访问上述仓库需要梯子，可考虑下文源码安装)</span></span><br><span class="line">helm repo add harbor https://helm.goharbor.io</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义配置</span></span><br><span class="line">cat &gt; harbor-values.yaml &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">expose:</span><br><span class="line">  <span class="built_in">type</span>: ingress</span><br><span class="line">  tls:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">    secretName: registry-harbor-tls</span><br><span class="line">    notarySecretName: notary-harbor-tls</span><br><span class="line">  ingress:</span><br><span class="line">    hosts:</span><br><span class="line">      core: registry.harbor.k8s.aezo.cn</span><br><span class="line">      notary: notary.harbor.k8s.aezo.cn</span><br><span class="line">    annotations:</span><br><span class="line">      kubernetes.io/ingress.class: <span class="string">"nginx"</span></span><br><span class="line">      ingress.kubernetes.io/ssl-redirect: <span class="string">"true"</span></span><br><span class="line">      ingress.kubernetes.io/proxy-body-size: <span class="string">"0"</span></span><br><span class="line">      nginx.ingress.kubernetes.io/backend-protocol: <span class="string">"HTTPS"</span></span><br><span class="line">      <span class="comment"># certmanager自动证书</span></span><br><span class="line">      kubernetes.io/tls-acme: <span class="string">"true"</span></span><br><span class="line">externalURL: https://registry.harbor.k8s.aezo.cn</span><br><span class="line"><span class="comment"># 用户名默认为 admin</span></span><br><span class="line">harborAdminPassword: Hello1234</span><br><span class="line"><span class="comment"># 使用外部mysql数据库(需提前创建数据库，见下文sql语句)</span></span><br><span class="line">database:</span><br><span class="line">  <span class="built_in">type</span>: external</span><br><span class="line">  external:</span><br><span class="line">    host: postgresql-devops</span><br><span class="line">    port: 5432</span><br><span class="line">    username: postgres</span><br><span class="line">    password: Hello1234!</span><br><span class="line">    coreDatabase: harbor_registry</span><br><span class="line">    clairDatabase: harbor_clair</span><br><span class="line">    notaryServerDatabase: harbor_notary_server</span><br><span class="line">    notarySignerDatabase: harbor_notary_signer</span><br><span class="line"><span class="comment"># 使用外部redis数据库(默认使用0-3下标的数据库)</span></span><br><span class="line">redis:</span><br><span class="line">  <span class="built_in">type</span>: external</span><br><span class="line">  external: </span><br><span class="line">    host: redis-devops-master</span><br><span class="line">    port: 6379</span><br><span class="line">    password: Hello1234!</span><br><span class="line">persistence:</span><br><span class="line">  enabled: <span class="literal">true</span></span><br><span class="line">  resourcePolicy: <span class="string">"keep"</span></span><br><span class="line">  persistentVolumeClaim:</span><br><span class="line">    <span class="comment"># registry存放镜像</span></span><br><span class="line">    registry:</span><br><span class="line">      storageClass: <span class="string">"nfs-client"</span></span><br><span class="line">      size: <span class="string">"20Gi"</span> <span class="comment"># 默认是5Gi，放5个项目就要进场清理</span></span><br><span class="line">    chartmuseum:</span><br><span class="line">      storageClass: <span class="string">"nfs-client"</span></span><br><span class="line">    jobservice:</span><br><span class="line">      storageClass: <span class="string">"nfs-client"</span></span><br><span class="line">    <span class="comment"># 如果使用外部数据库则不需要(上面已配置外部数据库)</span></span><br><span class="line">    <span class="comment">#database:</span></span><br><span class="line">    <span class="comment">#  storageClass: "nfs-client"</span></span><br><span class="line">EOF</span><br><span class="line"><span class="comment"># 大概需要3分钟所有的Pod才会全部运行正常</span></span><br><span class="line">helm install --name harbor --namespace devops harbor/harbor --version=1.2.1 -f harbor-values.yaml</span><br><span class="line"><span class="comment"># 访问 https://registry.harbor.k8s.aezo.cn</span></span><br><span class="line"></span><br><span class="line">helm upgrade harbor harbor/harbor --version=1.2.1 -f harbor-values.yaml</span><br><span class="line">helm del --purge harbor</span><br><span class="line"><span class="comment"># 然后删除对应的PVC(会顺带自动删除PV，但是对于实际的存储文件需要到存储服务中删除)，否则下次安装会提示存储对应PVC</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 基于源码安装</span></span><br><span class="line">wget https://github.com/goharbor/harbor-helm/archive/v1.2.1.tar.gz</span><br><span class="line">tar -xvzf v1.2.1.tar.gz</span><br><span class="line">helm install --name harbor --namespace devops ./harbor-helm-1.2.1 -f harbor-values.yaml</span><br><span class="line">helm upgrade harbor ./harbor-helm-1.2.1 -f harbor-values.yaml</span><br></pre></td></tr></table></figure><ul><li>数据库初始化语句如</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">database</span> harbor_registry;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">database</span> harbor_clair;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">database</span> harbor_notary_server;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">database</span> harbor_notary_signer;</span><br></pre></td></tr></table></figure><ul><li>命令行镜像推送参考：<a href="/_posts/devops/docker.md#Harbor">http://blog.aezo.cn/2017/06/25/devops/docker/</a></li><li><p>说明</p><ul><li><p>此版本支持docker registry和helm charts仓库。其功能类似开源项目chartmuseum</p><ul><li>可单独创建一个仓库来放charts或将charts放在每个项目中，如此处单独创建harbor项目charts</li><li><p>上传chart</p><ul><li>进入charts项目，在Helm Charts标签页下，可以上传chart压缩包(注意需要是使用.tar或.tar.gz压缩文件，rar是不可以的)</li><li><p>或者通过命令上传</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加helm push命令</span></span><br><span class="line">helm plugin install https://github.com/chartmuseum/helm-push</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将对应charts仓库添加到helm。其中用户名和密码为harbor账号，且此账户要有charts仓库的权限；此处charts是指上述的harbor项目名</span></span><br><span class="line">helm repo add myrepo https://xx.xx.xx.xx/chartrepo/charts --username &lt;username&gt; --password &lt;password&gt;</span><br><span class="line">helm push <span class="built_in">test</span>-1.0.0.tar.gz myrepo <span class="comment"># 推送镜像到仓库</span></span><br></pre></td></tr></table></figure></li></ul></li></ul></li><li><p>出现过一次异常：upgrade后，导致harbor-harbor-jobservice和harbor-harbor-chartmuseum的历史副本集无法自动删除，导致新的副本集提示启动失败(占用了pvc)，可手动删除历史副本集解决</p></li></ul></li><li>常见问题<ul><li>日志提示<code>failed to initialize database: register db Ping default, pq: could not open file &quot;base/16384/2601&quot;: Read-only file system</code>，原因可能为postgresql无法正常访问；且发现集群中postgresql正常运行，但是通过其他桌面客户端无法连接，报类似错误。解决：通过重新创建postgresql容器解决</li></ul></li></ul><h3 id="Jenkins"><a href="#Jenkins" class="headerlink" title="Jenkins"></a>Jenkins</h3><blockquote><p><a href="https://hub.kubeapps.com/charts/stable/jenkins" target="_blank" rel="noopener">https://hub.kubeapps.com/charts/stable/jenkins</a></p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 安装</span></span><br><span class="line">cat &gt; jenkins-values.yaml &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">master:</span><br><span class="line">  tag: 2.190.2</span><br><span class="line">  adminUser: admin</span><br><span class="line">  adminPassword: Hello1234</span><br><span class="line">  ingress:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">    hostName: jenkins.k8s.aezo.cn</span><br><span class="line">    annotations:</span><br><span class="line">      kubernetes.io/tls-acme: <span class="string">"true"</span></span><br><span class="line">    tls:</span><br><span class="line">    - secretName: jenkins-master-tls</span><br><span class="line">      hosts:</span><br><span class="line">      - jenkins.k8s.aezo.cn</span><br><span class="line">  <span class="comment"># 如jenkins编译docker进行，如果对应harbor为https，则需要提前在宿主机添加证书。此时只允许master运行在相应节点上</span></span><br><span class="line">  affinity:</span><br><span class="line">    nodeAffinity:</span><br><span class="line">      requiredDuringSchedulingIgnoredDuringExecution:</span><br><span class="line">        nodeSelectorTerms:</span><br><span class="line">        - matchExpressions:</span><br><span class="line">          - &#123;key: kubernetes.io/hostname, operator: In, values: [<span class="string">"node1"</span>, <span class="string">"node2"</span>]&#125;</span><br><span class="line">  <span class="comment"># installPlugins: [] # 设置默认安装的插件，如果为[]则一个插件都不会安装</span></span><br><span class="line">persistence:</span><br><span class="line">  enabled: <span class="literal">true</span></span><br><span class="line">  storageClass: <span class="string">'nfs-client'</span></span><br><span class="line">  <span class="comment"># 挂载宿主机docker程序，供容器内使用</span></span><br><span class="line">  volumes:</span><br><span class="line">  - name: docker-sock</span><br><span class="line">    hostPath:</span><br><span class="line">      <span class="built_in">type</span>: Socket</span><br><span class="line">      path: /var/run/docker.sock</span><br><span class="line">  - name: docker-bin</span><br><span class="line">    hostPath:</span><br><span class="line">      <span class="built_in">type</span>: File</span><br><span class="line">      path: /usr/bin/docker</span><br><span class="line">  mounts:</span><br><span class="line">  - mountPath: /var/run/docker.sock</span><br><span class="line">    name: docker-sock</span><br><span class="line">  - mountPath: /usr/bin/docker:ro</span><br><span class="line">    name: docker-bin</span><br><span class="line">agent:</span><br><span class="line">  image: docker.mirrors.ustc.edu.cn/jenkins/jnlp-slave</span><br><span class="line">EOF</span><br><span class="line">helm install --name jenkins --namespace devops stable/jenkins --version=1.7.8 -f jenkins-values.yaml</span><br><span class="line"></span><br><span class="line">helm upgrade jenkins stable/jenkins --version=1.7.8 -f jenkins-values.yaml</span><br><span class="line">helm del --purge jenkins <span class="comment"># 如果删除部署后重新部署，会重新创建新PV</span></span><br></pre></td></tr></table></figure><ul><li>说明<ul><li>多次部署更新jenkins，历史安装的插件不会丢失。如果删除部署后重新部署，会重新创建新PV</li><li>jenkins pod重启创建需要初始化，初始化会安装插件(可在日志-初始容器copy-default-config查看安装日志)。此过程耗时较长，测试时达到40分钟(可使用插件的国内镜像)</li><li>会默认安装插件Kubernetes：可基于k8s创建agent，即构建时会自动创建子pod(slave节点，镜像jenkins/jnlp-slave)，workspace目录则保存在执行任务的slave节点上，当构建完成后会自动删除子pod(包括任务的工作空间)。更多参考<a href="/_posts/devops/jenkins.md#Kubernetes(连接k8s创建jenkins-agent">jenkins</a>)<ul><li>默认安装的插件配置：/var/jenkins_home/plugins.txt</li></ul></li><li>容器中jenkins数据目录为 <code>/var/jenkins_home</code></li></ul></li></ul><h3 id="ELK"><a href="#ELK" class="headerlink" title="ELK"></a>ELK</h3><h4 id="elasticsearch-kibana"><a href="#elasticsearch-kibana" class="headerlink" title="elasticsearch+kibana"></a>elasticsearch+kibana</h4><blockquote><p><a href="https://hub.kubeapps.com/charts/bitnami/elasticsearch" target="_blank" rel="noopener">https://hub.kubeapps.com/charts/bitnami/elasticsearch</a></p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">helm repo add bitnami https://charts.bitnami.com/bitnami</span><br><span class="line"></span><br><span class="line">cat &gt; elasticsearch-values.yaml &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">global:</span><br><span class="line">  imageRegistry: docker.mirrors.ustc.edu.cn</span><br><span class="line">  storageClass: <span class="string">'nfs-client'</span></span><br><span class="line">  <span class="comment"># 引入内嵌的kibana，配置见下文</span></span><br><span class="line">  kibanaEnabled: <span class="literal">true</span></span><br><span class="line"><span class="comment"># 可使用`kubectl -n monitoring delete job -l app=elasticsearch,role=curator`移除</span></span><br><span class="line">curator:</span><br><span class="line">  enabled: <span class="literal">true</span></span><br><span class="line"><span class="comment"># 开启Prometheus(启动了一个Prometheus-exporter)</span></span><br><span class="line">metrics:</span><br><span class="line">  enabled: <span class="literal">true</span></span><br><span class="line"><span class="comment"># kibana配置，所有参数可参考(elasticsearch文档中列举了部分)：https://hub.kubeapps.com/charts/bitnami/kibana</span></span><br><span class="line">kibana:</span><br><span class="line">  ingress:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">    certManager: <span class="literal">true</span></span><br><span class="line">    annotations:</span><br><span class="line">      kubernetes.io/tls-acme: <span class="string">"true"</span></span><br><span class="line">    hosts:</span><br><span class="line">    - name: kibana.k8s.aezo.cn</span><br><span class="line">      tls: <span class="literal">true</span></span><br><span class="line">      tlsSecret: kibana-tls</span><br><span class="line">EOF</span><br><span class="line">helm install --name elasticsearch-monitoring --namespace monitoring bitnami/elasticsearch --version=12.6.2 -f elasticsearch-values.yaml</span><br><span class="line"></span><br><span class="line">helm upgrade elasticsearch-monitoring bitnami/elasticsearch --version=12.6.2 -f elasticsearch-values.yaml</span><br><span class="line">helm del --purge elasticsearch-monitoring</span><br></pre></td></tr></table></figure><ul><li>说明<ul><li>elasticsearch-master 的容器初始化会自动执行 <code>sysctl -w vm.max_map_count=262144 &amp;&amp; sysctl -w fs.file-max=65536</code></li><li>k8s中对应的elasticsearch服务地址<code>http://elasticsearch-monitoring-coordinating-only.monitoring.svc.cluster.local:9200</code></li></ul></li></ul><h4 id="logstash"><a href="#logstash" class="headerlink" title="logstash"></a>logstash</h4><blockquote><p><a href="https://hub.kubeapps.com/charts/bitnami/logstash" target="_blank" rel="noopener">https://hub.kubeapps.com/charts/bitnami/logstash</a></p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; logstash-values.yaml &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">global:</span><br><span class="line">  imageRegistry: docker.mirrors.ustc.edu.cn</span><br><span class="line">  storageClass: <span class="string">'nfs-client'</span></span><br><span class="line">ingress:</span><br><span class="line">  enabled: <span class="literal">true</span></span><br><span class="line">  certManager: <span class="literal">true</span></span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/tls-acme: <span class="string">"true"</span></span><br><span class="line">  hosts:</span><br><span class="line">  - name: logstash.k8s.aezo.cn</span><br><span class="line">  tls:</span><br><span class="line">  - hosts:</span><br><span class="line">    - logstash.k8s.aezo.cn</span><br><span class="line">    secretName: logstash-tls</span><br><span class="line">service:</span><br><span class="line">  ports:</span><br><span class="line">    syslog-tcp:</span><br><span class="line">      port: 5000</span><br><span class="line">      targetPort: syslog-tcp</span><br><span class="line">      protocol: TCP</span><br><span class="line">    http:</span><br><span class="line">      port: 8080</span><br><span class="line">      targetPort: http</span><br><span class="line">      protocol: TCP</span><br><span class="line">containerPorts:</span><br><span class="line">  - name: syslog-tcp</span><br><span class="line">    containerPort: 5000</span><br><span class="line">    protocol: TCP</span><br><span class="line">  - name: http</span><br><span class="line">    containerPort: 8080</span><br><span class="line">    protocol: TCP</span><br><span class="line">  - name: monitoring</span><br><span class="line">    containerPort: 9600</span><br><span class="line">    protocol: TCP</span><br><span class="line">extraEnvVars:</span><br><span class="line">- name: ELASTICSEARCH_HOST</span><br><span class="line">  value: <span class="string">"elasticsearch-monitoring-coordinating-only.monitoring.svc.cluster.local"</span></span><br><span class="line">- name: ELASTICSEARCH_PORT</span><br><span class="line">  value: <span class="string">"9200"</span></span><br><span class="line"><span class="comment"># ref: https://www.elastic.co/guide/en/logstash/current/input-plugins.html</span></span><br><span class="line">input: |-</span><br><span class="line">  <span class="comment"># 需要设置tcp代理，参考上文基于helm安装ingress-nginx</span></span><br><span class="line">  tcp &#123;</span><br><span class="line">    port =&gt; 5000</span><br><span class="line">    codec =&gt; <span class="string">"json"</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment"># http &#123; port =&gt; 8080 &#125; # logback通过http发送日志未测试成功(直接curl通过http发送请求到logstash成功)</span></span><br><span class="line"><span class="comment"># ref: https://www.elastic.co/guide/en/logstash/current/filter-plugins.html</span></span><br><span class="line"><span class="comment"># filter: |-</span></span><br><span class="line"><span class="comment"># ref: https://www.elastic.co/guide/en/logstash/current/output-plugins.html</span></span><br><span class="line">output: |-</span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    hosts =&gt; [<span class="string">"<span class="variable">$&#123;ELASTICSEARCH_HOST&#125;</span>:<span class="variable">$&#123;ELASTICSEARCH_PORT&#125;</span>"</span>]</span><br><span class="line">    <span class="comment"># 动态获取数据中spring_application_name的值组成index(最终如：sq-demo-2020.01)</span></span><br><span class="line">    index =&gt; <span class="string">"%&#123;spring_application_name&#125;-%&#123;+YYYY.MM&#125;"</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment"># 开启控制台打印</span></span><br><span class="line">  <span class="comment"># stdout &#123;&#125;</span></span><br><span class="line">EOF</span><br><span class="line">helm install --name logstash-monitoring --namespace monitoring bitnami/logstash --version=0.4.7 -f logstash-values.yaml</span><br><span class="line"></span><br><span class="line">helm upgrade logstash-monitoring bitnami/logstash --version=0.4.7 -f logstash-values.yaml</span><br><span class="line">helm del --purge logstash-monitoring</span><br></pre></td></tr></table></figure><h3 id="OpenLDAP"><a href="#OpenLDAP" class="headerlink" title="OpenLDAP"></a>OpenLDAP</h3><ul><li>使用参考<a href="/_posts/db/LDAP.md#基于k8s安装">LDAP</a></li></ul><h3 id="Nexus-未测试"><a href="#Nexus-未测试" class="headerlink" title="Nexus(未测试)"></a>Nexus(未测试)</h3><blockquote><p><a href="https://hub.kubeapps.com/charts/sonatype/nexus-repository-manager" target="_blank" rel="noopener">https://hub.kubeapps.com/charts/sonatype/nexus-repository-manager</a></p></blockquote><ul><li>参考<a href="/_posts/java/maven.md#maven私服搭建(nexus">maven私服搭建(nexus)</a>)</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">helm repo add sonatype https://sonatype.github.io/helm3-charts/</span><br><span class="line"></span><br><span class="line">cat &gt; nexus-values.yaml &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">statefulset:</span><br><span class="line">  enabled: <span class="literal">true</span></span><br><span class="line">image:</span><br><span class="line">  repository: docker.mirrors.ustc.edu.cn/sonatype/nexus3</span><br><span class="line">persistence:</span><br><span class="line">  storageClass: <span class="string">'nfs-client'</span></span><br><span class="line">ingress:</span><br><span class="line">  enabled: <span class="literal">true</span></span><br><span class="line">  hosts:</span><br><span class="line">  - host: nexus.k8s.aezo.cn</span><br><span class="line">    paths: [/]</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/tls-acme: <span class="string">"true"</span></span><br><span class="line">  tls:</span><br><span class="line">  - secretName: nexus-tls</span><br><span class="line">    hosts:</span><br><span class="line">    - nexus.k8s.aezo.cn</span><br><span class="line">EOF</span><br><span class="line">helm install --name nexus-devops --namespace devops sonatype/nexus-repository-manager --version 25.0.2 -f nexus-values.yaml</span><br><span class="line"></span><br><span class="line">helm upgrade nexus-devops sonatype/nexus-repository-manager --version 25.0.2 -f nexus-values.yaml</span><br><span class="line">helm del --purge nexus-devops</span><br></pre></td></tr></table></figure><h3 id="skydive-网络分析"><a href="#skydive-网络分析" class="headerlink" title="skydive(网络分析)"></a>skydive(网络分析)</h3><ul><li><a href="http://skydive.network/index.html" target="_blank" rel="noopener">官网</a></li><li>Skydive 是一款开放式源代码的实时网络拓扑和协议分析器，并可通过WEB界面展示<ul><li>Skydive agent，运行在各个节点上，捕捉该节点的拓扑和流量信息。会占用每个节点的8081端口，如果访问<a href="http://192.168.6.131:8081可访问此节点的网络拓扑" target="_blank" rel="noopener">http://192.168.6.131:8081可访问此节点的网络拓扑</a></li><li>Skydive analyzer，收集所有agents捕获的信息</li></ul></li></ul><blockquote><p><a href="https://hub.kubeapps.com/charts/ibm-charts/ibm-skydive-dev" target="_blank" rel="noopener">https://hub.kubeapps.com/charts/ibm-charts/ibm-skydive-dev</a></p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ibm仓库(skydive测试版)</span></span><br><span class="line">helm repo add ibm-charts https://raw.githubusercontent.com/IBM/charts/master/repo/stable/</span><br><span class="line"></span><br><span class="line">cat &gt; skydive-values.yaml &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">image:</span><br><span class="line">  repository: docker.mirrors.ustc.edu.cn/ibmcom/skydive</span><br><span class="line">EOF</span><br><span class="line">helm install --name skydive --namespace monitoring ibm-charts/ibm-skydive-dev --version=1.1.2 -f skydive-values.yaml</span><br><span class="line"></span><br><span class="line">helm upgrade skydive ibm-charts/ibm-skydive-dev --version=1.1.2 -f skydive-values.yaml</span><br><span class="line">helm del --purge skydive</span><br><span class="line"></span><br><span class="line"><span class="comment"># 管理端，可获取全局拓扑。等待pod正常运行后获取访问ip</span></span><br><span class="line"><span class="built_in">export</span> UI_IP=$(kubectl get nodes --namespace monitoring -o jsonpath=<span class="string">"&#123;.items[0].status.addresses[0].address&#125;"</span>)</span><br><span class="line"><span class="built_in">export</span> UI_PORT=$(kubectl get --namespace monitoring -o jsonpath=<span class="string">"&#123;.spec.ports[0].nodePort&#125;"</span> services skydive-ibm-skydive-dev-service)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"skydive end-point: http://<span class="variable">$UI_IP</span>:<span class="variable">$UI_PORT</span>"</span></span><br></pre></td></tr></table></figure><ul><li>管理端界面使用<ul><li>Filter 过滤网络。基于<code>Gremlin</code>语法，参考：<a href="http://skydive.network/documentation/cli、http://tinkerpop.apache.org/gremlin.html、http://tang.love/2018/11/15/gremlin_traversal_language/" target="_blank" rel="noopener">http://skydive.network/documentation/cli、http://tinkerpop.apache.org/gremlin.html、http://tang.love/2018/11/15/gremlin_traversal_language/</a><ul><li><code>G.V()</code> 获取所有节点级别网络</li><li><code>G.V().Has(&quot;Manager&quot;,NE(&quot;k8s&quot;))</code> 获取docker级别（Manager != k8s）网络拓扑</li></ul></li></ul></li></ul><h2 id="Go-template语法"><a href="#Go-template语法" class="headerlink" title="Go template语法"></a>Go template语法</h2><h3 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h3><ul><li><a href="https://golang.org/pkg/text/template/" target="_blank" rel="noopener">Go template语法</a></li><li>相关函数：<a href="https://blog.gmem.cc/gotpl" target="_blank" rel="noopener">https://blog.gmem.cc/gotpl</a></li></ul><h3 id="基本"><a href="#基本" class="headerlink" title="基本"></a>基本</h3><ul><li>基本</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="comment">/* comment */</span>&#125;&#125;</span><br><span class="line">&#123;&#123;- xxxx -&#125;&#125; <span class="comment">// 前后的 `-` 表示去除前后的空白(包括换行符、制表符、空格等)，可只去其中一个</span></span><br></pre></td></tr></table></figure><ul><li><strong>管道符 <code>|</code></strong> (类似unix)。helm-chart中常使用<code>|-</code>载入配置文件(<code>|-</code>后面按照原配置文件书写，不用考虑<code>yaml</code>格式)</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; .Values | quote &#125;&#125; <span class="comment">// 等价于 `quote .Values`</span></span><br><span class="line">&#123;&#123; .Values | upper | quote &#125;&#125;</span><br></pre></td></tr></table></figure><h3 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; $how_long := (<span class="built_in">len</span> <span class="string">"output"</span>) &#125;&#125; <span class="comment">// 定义变量</span></span><br><span class="line">&#123;&#123; <span class="built_in">println</span> $how_long &#125;&#125; <span class="comment">// 输出6</span></span><br><span class="line"></span><br><span class="line">&#123;&#123; $name := <span class="keyword">default</span> .Chart.Name .Values.nameOverride &#125;&#125; <span class="comment">// 赋值多个值，此时$name相当于一个数组</span></span><br><span class="line">&#123;&#123; .Values.name | <span class="keyword">default</span> <span class="string">"applogs"</span> &#125;&#125; <span class="comment">// 字符串需要加双引号，否则会被认为是变量</span></span><br><span class="line">&#123;&#123; .Values.name | <span class="keyword">default</span> (printf <span class="string">"%s-%s"</span> (include <span class="string">"cat.fullname"</span> .) <span class="string">"applogs"</span>) &#125;&#125; <span class="comment">// 如果没有则默认取如 cat-applogs</span></span><br><span class="line">&#123;&#123; <span class="keyword">if</span> contains $name .Release.Name &#125;&#125; ... &#123;&#123; end &#125;&#125; <span class="comment">// $name为上文定义，判断$name中是否包含.Release.Name的值</span></span><br><span class="line"></span><br><span class="line">&#123;&#123;.&#125;&#125; <span class="comment">// 表示当前对象，如user对象</span></span><br><span class="line">&#123;&#123;.Username&#125;&#125; <span class="comment">// 表示对象的Username字段值</span></span><br></pre></td></tr></table></figure><h3 id="控制语句"><a href="#控制语句" class="headerlink" title="控制语句"></a>控制语句</h3><ul><li><strong>if</strong></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="keyword">if</span> exp&#125;&#125; T1 &#123;&#123;end&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;<span class="keyword">if</span> exp&#125;&#125; T1 &#123;&#123;<span class="keyword">else</span>&#125;&#125; T0 &#123;&#123;end&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 控制语句块在渲染后生成模板会多出空行。可使用&#123;&#123;- if ...&#125;&#125;的方式消除此空行</span></span><br><span class="line">&#123;&#123;- <span class="keyword">if</span> and .Values.fooString (eq .Values.fooString <span class="string">"foo"</span>) &#125;&#125; <span class="comment">// eq ne(!) lt le(&lt;=) gt ge</span></span><br><span class="line">    &#123;&#123; ... &#125;&#125;</span><br><span class="line">&#123;&#123;- end &#125;&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>with</strong> 按条件设置 . 值</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 当exp不为0值时，点"."设置为exp运算的值，并执行T1；否则跳过</span></span><br><span class="line">&#123;&#123;with exp&#125;&#125; T1 &#123;&#123;end&#125;&#125;</span><br><span class="line"><span class="comment">// &#123;&#123;with "xx"&#125;&#125;&#123;&#123;println .&#125;&#125;&#123;&#123;end&#125;&#125; // 打印"xx"(此时 . 设置成了 xx)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 当exp不为0值时，则"."设置为exp运算的值，并执行T1；否则执行else语句块</span></span><br><span class="line">&#123;&#123;with exp&#125;&#125; T1 &#123;&#123;<span class="keyword">else</span>&#125;&#125; T0 &#123;&#123;end&#125;&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>range</strong>、<strong>index</strong></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// range循环来遍历map(将所有k-v依次展示)</span></span><br><span class="line">&#123;&#123; <span class="keyword">range</span> $k, $v := .Map &#125;&#125; <span class="comment">// 不加-时，每次循环会产生一个空行</span></span><br><span class="line">    &#123;&#123; $k &#125;&#125;:&#123;&#123; $v &#125;&#125;</span><br><span class="line">&#123;&#123; end &#125;&#125; <span class="comment">// 每次循环会产生一个空行</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// grafana chart configmap.yaml示例</span></span><br><span class="line">data:</span><br><span class="line">  grafana.ini: |</span><br><span class="line">&#123;&#123;- <span class="keyword">range</span> $key, $value := index .Values <span class="string">"grafana.ini"</span> &#125;&#125;</span><br><span class="line">    [&#123;&#123; $key &#125;&#125;] <span class="comment">// 此处转换成 [smtp]，为实际grafana.ini的配置格式</span></span><br><span class="line">    &#123;&#123;- <span class="keyword">range</span> $elem, $elemVal := $value &#125;&#125;</span><br><span class="line">    &#123;&#123; $elem &#125;&#125; = &#123;&#123; $elemVal &#125;&#125; <span class="comment">// 主要是将 : 转成 =</span></span><br><span class="line">    &#123;&#123;- end &#125;&#125;</span><br><span class="line">&#123;&#123;- end &#125;&#125;</span><br><span class="line"><span class="string">`</span></span><br><span class="line"><span class="string"># value.yaml中配置</span></span><br><span class="line"><span class="string">grafana.ini:</span></span><br><span class="line"><span class="string">  smtp:</span></span><br><span class="line"><span class="string">    enabled: true</span></span><br><span class="line"><span class="string">    host: "smtp.gmail.com:587"</span></span><br><span class="line"><span class="string">    user: "test@gmail.com"</span></span><br><span class="line"><span class="string">    password: "pass"</span></span><br><span class="line"><span class="string">`</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// index 返回第一个参数的索引值，如"index x 1 2 3" 相当于 x[1][2][3]</span></span><br><span class="line">&#123;&#123;- <span class="keyword">range</span> $key, $value := .Values.tcp &#125;&#125;</span><br><span class="line">- name: <span class="string">"&#123;&#123; $key &#125;&#125;-tcp"</span></span><br><span class="line">  port: &#123;&#123; $key &#125;&#125;</span><br><span class="line">  protocol: TCP</span><br><span class="line">  targetPort: <span class="string">"&#123;&#123; $key &#125;&#125;-tcp"</span></span><br><span class="line">  &#123;&#123;- <span class="keyword">if</span> $.Values.nodePorts.tcp &#125;&#125;</span><br><span class="line">  &#123;&#123;- <span class="keyword">if</span> index $.Values.nodePorts.tcp $key &#125;&#125; <span class="comment">// 相当于获取 $.Values.nodePorts.tcp[$key]</span></span><br><span class="line">  nodePort: &#123;&#123; index $.Values.nodePorts.tcp $key &#125;&#125;</span><br><span class="line">  &#123;&#123;- end &#125;&#125;</span><br><span class="line">  &#123;&#123;- end &#125;&#125;</span><br><span class="line">&#123;&#123;- end &#125;&#125;</span><br><span class="line"><span class="string">`</span></span><br><span class="line"><span class="string"># value.yaml中配置</span></span><br><span class="line"><span class="string">nodePorts:</span></span><br><span class="line"><span class="string">  tcp:</span></span><br><span class="line"><span class="string">    9000: 31000</span></span><br><span class="line"><span class="string">tcp:</span></span><br><span class="line"><span class="string">  9000: "monitoring/cat:2280"</span></span><br><span class="line"><span class="string">`</span></span><br></pre></td></tr></table></figure><h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><ul><li>模板嵌套</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; define <span class="string">"module_name"</span> &#125;&#125;content&#123;&#123; end &#125;&#125; <span class="comment">//声明</span></span><br><span class="line">&#123;&#123; template <span class="string">"module_name"</span> &#125;&#125; <span class="comment">//调用</span></span><br></pre></td></tr></table></figure><ul><li>内置函数</li></ul><h3 id="Charts"><a href="#Charts" class="headerlink" title="Charts"></a>Charts</h3><ul><li><code>toYaml</code></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 示例1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="string">blackbox.yaml:</span> <span class="string">|</span></span><br><span class="line"><span class="string"><span class="template-variable">&#123;&#123; toYaml .Values.config | indent 4 &#125;&#125;</span> # indent 4，所有都缩进4个空格</span></span><br><span class="line"><span class="string"># Values</span></span><br><span class="line"><span class="string"></span><span class="attr">config:</span> </span><br><span class="line"><span class="attr">  key:</span> <span class="string">'val'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例2</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="string">&#123;&#123;-</span> <span class="string">with</span> <span class="string">.Values.ingress.annotations</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="string">&#123;&#123;-</span> <span class="string">toYaml</span> <span class="string">.</span> <span class="string">| nindent 4 &#125;&#125;</span></span><br><span class="line"><span class="string">  <span class="template-variable">&#123;&#123;- end &#125;&#125;</span></span></span><br><span class="line"><span class="string"># Values</span></span><br><span class="line"><span class="string"></span><span class="attr">ingress:</span> </span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line"><span class="attr">    key1:</span> <span class="string">'val1'</span></span><br><span class="line"><span class="attr">    key2:</span> <span class="string">'val2'</span></span><br></pre></td></tr></table></figure><hr><p>参考文章</p></div><div></div><div></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> smalle</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="http://blog.aezo.cn/2019/06/22/devops/helm/" title="Helm | K8s包管理器">http://blog.aezo.cn/2019/06/22/devops/helm/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/k8s/" rel="tag"># k8s</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2019/06/20/linux/network/" rel="next" title="网络"><i class="fa fa-chevron-left"></i> 网络</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"> <a href="/2019/06/28/devops/cat/" rel="prev" title="CAT">CAT<i class="fa fa-chevron-right"></i></a></div></div></footer></article><div class="post-spread"><div> <a target="_blank" href="https://github.com/oldinaction/ChatGPT-MP"><img class="nofancybox" style="width:300px;margin:0 auto" src="https://cdn7.aezo.cn/one/chat/chat-gpt-open-banner.jpg" alt="ChatGPT开源小程序" title="ChatGPT开源小程序"></a></div></div></div></div><div class="comments" id="comments"></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> 文章目录</li><li class="sidebar-nav-overview" data-target="site-overview"> 站点概览</li></ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="https://avatars0.githubusercontent.com/u/15698218?v=3&u=ce740bf0b67ff0d74990ba6fc644d6e92f572dcb&s=400" alt="smalle"><p class="site-author-name" itemprop="name">smalle</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">167</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/index.html"><span class="site-state-item-count">14</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/index.html"><span class="site-state-item-count">153</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"></div><div> 欢迎关注公众号：阿壹族 <img class="nofancybox" style="width:120px;margin:0 auto" src="https://cdn7.aezo.cn/common/qrcode/ayz_qrcode.jpg" alt="欢迎关注公众号：阿壹族" title="欢迎关注公众号：阿壹族"></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#简介"><span class="nav-number">1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装Helm客户端及服务"><span class="nav-number">2.</span> <span class="nav-text">安装Helm客户端及服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Helm命令-2"><span class="nav-number">3.</span> <span class="nav-text">Helm命令 ^2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Chart使用-手动创建"><span class="nav-number">4.</span> <span class="nav-text">Chart使用(手动创建)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用案例"><span class="nav-number">5.</span> <span class="nav-text">使用案例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#MySQL"><span class="nav-number">5.1.</span> <span class="nav-text">MySQL</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#练手Helm"><span class="nav-number">5.1.1.</span> <span class="nav-text">练手Helm</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#cert-manager"><span class="nav-number">5.2.</span> <span class="nav-text">cert-manager</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ingress-nginx"><span class="nav-number">5.3.</span> <span class="nav-text">ingress-nginx</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Kubernetes-Dashboard"><span class="nav-number">5.4.</span> <span class="nav-text">Kubernetes Dashboard</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nfs-client-provisioner"><span class="nav-number">5.5.</span> <span class="nav-text">nfs-client-provisioner</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Prometheus"><span class="nav-number">5.6.</span> <span class="nav-text">Prometheus</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Grafana"><span class="nav-number">5.7.</span> <span class="nav-text">Grafana</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Prometheus-Blackbox-Exporter"><span class="nav-number">5.8.</span> <span class="nav-text">Prometheus Blackbox Exporter</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Postgresql"><span class="nav-number">5.9.</span> <span class="nav-text">Postgresql</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#数据迁移-成功"><span class="nav-number">5.9.1.</span> <span class="nav-text">数据迁移(成功)</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis"><span class="nav-number">5.10.</span> <span class="nav-text">Redis</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MongoDB"><span class="nav-number">5.11.</span> <span class="nav-text">MongoDB</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Harbor"><span class="nav-number">5.12.</span> <span class="nav-text">Harbor</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Jenkins"><span class="nav-number">5.13.</span> <span class="nav-text">Jenkins</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ELK"><span class="nav-number">5.14.</span> <span class="nav-text">ELK</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#elasticsearch-kibana"><span class="nav-number">5.14.1.</span> <span class="nav-text">elasticsearch+kibana</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#logstash"><span class="nav-number">5.14.2.</span> <span class="nav-text">logstash</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#OpenLDAP"><span class="nav-number">5.15.</span> <span class="nav-text">OpenLDAP</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Nexus-未测试"><span class="nav-number">5.16.</span> <span class="nav-text">Nexus(未测试)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#skydive-网络分析"><span class="nav-number">5.17.</span> <span class="nav-text">skydive(网络分析)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Go-template语法"><span class="nav-number">6.</span> <span class="nav-text">Go template语法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#简介-1"><span class="nav-number">6.1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#基本"><span class="nav-number">6.2.</span> <span class="nav-text">基本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数据类型"><span class="nav-number">6.3.</span> <span class="nav-text">数据类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#控制语句"><span class="nav-number">6.4.</span> <span class="nav-text">控制语句</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#其他"><span class="nav-number">6.5.</span> <span class="nav-text">其他</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Charts"><span class="nav-number">6.6.</span> <span class="nav-text">Charts</span></a></li></ol></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright"> &copy; 2016 - <span itemprop="copyrightYear">2025</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">smalle</span>&nbsp;&nbsp;&nbsp;&nbsp;<div class="powered-by"> 由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div><div class="powered-by"> 主题 - <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a></div><div class="theme-info"> <a class="theme-link" target="_blank" href="https://tongji.baidu.com/main/overview/10000542408/overview/index?siteId=18991897">站长统计</a></div></div><div class="ad"> <span style="font-weight:700">AD&nbsp;&nbsp;&nbsp;&nbsp;</span><div class="theme-info"> <a target="_blank" href="https://promotion.aliyun.com/ntms/yunparter/invite.html?userCode=oby5nolb">阿里云大礼包</a></div></div><div class="aezocn"> <span style="font-weight:700">&copy;AEZO.CN&nbsp;&nbsp;&nbsp;&nbsp;</span><div class="powered-by"> <a target="_blank" href="https://shengqitech.aezo.cn/">圣骑科技</a></div><div class="powered-by"> <a target="_blank" href="https://cdn7.aezo.cn/common/qrcode/one_qrcode.jpg">【One能抽屉】小程序</a></div><div class="theme-info"> <a target="_blank" href="http://shop.aezo.cn/">杂货铺(省钱小助手)</a></div></div><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?085f9cd91ef2ad985f791c677472f0d1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script><script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script type="text/javascript" src="/js/src/js.cookie.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/scroll-cookie.js?v=5.1.1"></script></body></html>