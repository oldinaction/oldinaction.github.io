<!doctype html><html class="theme-next mist use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css"><meta name="keywords" content="docker,linux,network,"><link rel="alternate" href="/atom.xml" title="月星墙的博客" type="application/atom+xml"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1"><meta name="description" content="Linux网络brctl网桥操作 集线器、网桥、交换机、路由器、网关等术语参考 ^12 brctl 网桥操作  123yum install -y bridge-utils# 显示所有网桥brctl show ip信息/路由信息 ip a ip信息 ip a/ip addr 可以查看网卡的ip、mac等，即使网卡处于down状态，也能显示出网卡状态，但是ifconfig查看就看不到 ip addr"><meta name="keywords" content="docker,linux,network"><meta property="og:type" content="article"><meta property="og:title" content="网络"><meta property="og:url" content="http://blog.aezo.cn/2019/06/20/linux/network/index.html"><meta property="og:site_name" content="月星墙的博客"><meta property="og:description" content="Linux网络brctl网桥操作 集线器、网桥、交换机、路由器、网关等术语参考 ^12 brctl 网桥操作  123yum install -y bridge-utils# 显示所有网桥brctl show ip信息/路由信息 ip a ip信息 ip a/ip addr 可以查看网卡的ip、mac等，即使网卡处于down状态，也能显示出网卡状态，但是ifconfig查看就看不到 ip addr"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="http://blog.aezo.cn/data/images/linux/报文流向.png"><meta property="og:image" content="http://blog.aezo.cn/data/images/linux/iptables-route.png"><meta property="og:image" content="http://blog.aezo.cn/data/images/linux/Netfilter-Packet-Flow.png"><meta property="og:updated_time" content="2025-03-31T13:33:34.129Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="网络"><meta name="twitter:description" content="Linux网络brctl网桥操作 集线器、网桥、交换机、路由器、网关等术语参考 ^12 brctl 网桥操作  123yum install -y bridge-utils# 显示所有网桥brctl show ip信息/路由信息 ip a ip信息 ip a/ip addr 可以查看网卡的ip、mac等，即使网卡处于down状态，也能显示出网卡状态，但是ifconfig查看就看不到 ip addr"><meta name="twitter:image" content="http://blog.aezo.cn/data/images/linux/报文流向.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",sidebar:{position:"right",display:"post",offset:12,offset_float:0,b2t:!1,scrollpercent:!1},fancybox:!0,motion:!0,duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"BWD6R9FA4K",apiKey:"3330f3cbaa099dfc30395de5f5b20151",indexName:"blog",hits:{per_page:10},labels:{input_placeholder:"请输入关键字",hits_empty:"我们没有找到任何搜索结果: ${query}",hits_stats:"找到约${hits}条结果（用时${time}ms）"}}}</script><link rel="canonical" href="http://blog.aezo.cn/2019/06/20/linux/network/"><title>网络 | 月星墙的博客</title><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?085f9cd91ef2ad985f791c677472f0d1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-right page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">月星墙的博客</span><span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">Better Code, Better Life</h1></div><div class="site-nav-toggle"> <button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br> 首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br> 分类</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br> 关于</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br> 归档</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br> 标签</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i><br> 站点地图</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br> 搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"> <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><link itemprop="mainEntityOfPage" href="http://blog.aezo.cn/2019/06/20/linux/network/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="smalle"><meta itemprop="description" content=""><meta itemprop="image" content="https://avatars0.githubusercontent.com/u/15698218?v=3&u=ce740bf0b67ff0d74990ba6fc644d6e92f572dcb&s=400"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="月星墙的博客"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">网络</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-20T09:58:00+08:00">2019-06-20</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a></span></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="Linux网络"><a href="#Linux网络" class="headerlink" title="Linux网络"></a>Linux网络</h2><h3 id="brctl网桥操作"><a href="#brctl网桥操作" class="headerlink" title="brctl网桥操作"></a>brctl网桥操作</h3><ul><li>集线器、网桥、交换机、路由器、网关等术语参考 <a href="https://www.tianmaying.com/tutorial/NetWorkInstrument" title="集线器、网桥、交换机、路由器、网关大解析" target="_blank" rel="noopener">^12</a></li><li><code>brctl</code> 网桥操作</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install -y bridge-utils</span><br><span class="line"><span class="comment"># 显示所有网桥</span></span><br><span class="line">brctl show</span><br></pre></td></tr></table></figure><h3 id="ip信息-路由信息"><a href="#ip信息-路由信息" class="headerlink" title="ip信息/路由信息"></a>ip信息/路由信息</h3><ul><li><code>ip a</code> ip信息<ul><li><code>ip a</code>/<code>ip addr</code> 可以查看网卡的ip、mac等，即使网卡处于down状态，也能显示出网卡状态，但是<code>ifconfig</code>查看就看不到</li><li><code>ip addr show eth0</code> 查看指定网卡eth0的信息</li><li>显示结果中作用域说明：<code>scope {global|link|host}]</code><ul><li>global: 全局可用，即两个接口进来的数据都可以响应，是默认状态</li><li>link: 仅链接可用，进来的数据只有直接相连的那个接口能够响应</li><li>host: 本机可用，即只能自己访问</li></ul></li></ul></li><li><p><code>ip r</code> 路由信息</p><ul><li>查看路由信息 <code>ip r</code>/<code>ip route</code>；</li><li><p><code>route</code>也可显示路由信息</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ip r <span class="comment"># 显示如下</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 表示去任何地方，都发送给网卡eth0，并经过网关192.168.17.103发出；metric 100表示路由距离，到达指定网络所需的中转数</span></span><br><span class="line">default via 192.168.17.103 dev eth0 proto static metric 100</span><br><span class="line"><span class="comment"># 表示发往 172.16.0.0/16 这个网段的包，都由网卡docker0发出，src 172.17.0.1为网卡docker0的ip</span></span><br><span class="line">172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1 </span><br><span class="line">172.18.0.0/16 dev br-190a4d9330bd proto kernel scope link src 172.18.0.1 </span><br><span class="line">192.168.17.0/24 dev eth0 proto kernel scope link src 192.168.17.73 metric 100</span><br></pre></td></tr></table></figure></li></ul></li><li><p><code>ip rule</code> 路由策略信息 <a href="https://www.cnblogs.com/sammyliu/p/4713562.html" title="ip rule，ip route，iptables 三者之间的关系" target="_blank" rel="noopener">^5</a></p></li><li><code>ip link</code> 链路层信息(看不到ip地址)</li></ul><h3 id="curl-wget测试"><a href="#curl-wget测试" class="headerlink" title="curl/wget测试"></a>curl/wget测试</h3><ul><li>curl命令</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl [options] [URL...]</span><br><span class="line">    -d <span class="comment"># 传递普通参数</span></span><br><span class="line">    -v <span class="comment"># 显示日志信息</span></span><br><span class="line">    -s <span class="comment"># 将不输出错误和进度信息</span></span><br><span class="line">    -k <span class="comment"># 不考虑https证书验证</span></span><br><span class="line">    -X <span class="comment"># 请求类型 POST/GET(默认)</span></span><br><span class="line">    -H <span class="comment"># header参数</span></span><br><span class="line">    -L <span class="comment"># 让 HTTP 请求跟随服务器的重定向。curl 默认不跟随重定向</span></span><br></pre></td></tr></table></figure><ul><li>curl案例</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># GET请求</span></span><br><span class="line">curl localhost:8080</span><br><span class="line"><span class="comment"># POST请求，-v显示日志信息，-d传递普通参数</span></span><br><span class="line">curl -X POST -v -d <span class="string">"username=smalle&amp;password=aezocn"</span> localhost:8080/login</span><br><span class="line"><span class="comment"># POST请求，-H指定header，此时指定Content-Type:application/json，-d中的数据会放到body中</span></span><br><span class="line">curl -H <span class="string">"Content-Type:application/json"</span> -H <span class="string">"Authorization: aezocn"</span> -X POST -d <span class="string">'&#123;"orderId": "1"&#125;'</span> http://localhost:8000/order/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新内核脚本。下载脚本并运行</span></span><br><span class="line">bash &lt;(curl -L https://raw.githubusercontent.com/oldinaction/scripts/master/shell/prod/centos7-update-kernel.sh) 2&gt;&amp;1 | tee kernel.log</span><br></pre></td></tr></table></figure><h3 id="ping"><a href="#ping" class="headerlink" title="ping"></a>ping</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只向192.168.1.1发送1个包</span></span><br><span class="line">ping -c 1 192.168.1.1</span><br></pre></td></tr></table></figure><h3 id="arp"><a href="#arp" class="headerlink" title="arp"></a>arp</h3><ul><li>ARP：地址解析协议(Address Resolution Protocol)，其基本功能为透过目标设备的IP地址，查询目标设备的MAC地址，以保证通信的顺利进行。它是IPv4中网络层必不可少的协议，不过在IPv6中已不再适用，并被邻居发现协议(NDP)所替代</li><li>ARP表：设备通过ARP解析到目的MAC地址后，将会在自己的ARP表中增加IP地址到MAC地址的映射表项，以用于后续到同一目的地报文的转发</li><li><code>arp -a</code> 查看地址表</li></ul><h3 id="DNS查询"><a href="#DNS查询" class="headerlink" title="DNS查询"></a>DNS查询</h3><ul><li><code>dig</code></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">yum install <span class="built_in">bind</span>-utils <span class="comment"># 安装dig工具</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用</span></span><br><span class="line">dig baidu.com</span><br><span class="line"><span class="comment"># 向10.96.0.10的DNS服务器查询hostname=nginx.default.svc.cluster.local的A记录(IP信息)</span></span><br><span class="line">dig -t A nginx.default.svc.cluster.local @10.96.0.10</span><br></pre></td></tr></table></figure><ul><li><code>nslookup</code></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># type可以是：A、CNAME、MX、NS、TXT等（默认为A记录）；如果没指定dns-server，用系统默认的dns服务器</span></span><br><span class="line">nslookup -qt=<span class="built_in">type</span> domain [dns-server]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例</span></span><br><span class="line">nslookup baidu.com</span><br><span class="line">nslookup -qt=mx baidu.com 8.8.8.8</span><br></pre></td></tr></table></figure><h3 id="tcpdump"><a href="#tcpdump" class="headerlink" title="tcpdump"></a>tcpdump</h3><ul><li><code>yum -y install tcpdump</code></li><li>命令参数</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum -y install tcpdump</span></span><br><span class="line"><span class="comment"># 观察流经 docker0 网卡的 icmp 类型(ping/telnet)流量</span></span><br><span class="line">tcpdump -i docker0 -n icmp</span><br><span class="line"><span class="comment"># -e可显示ttl信息</span></span><br><span class="line">tcpdump -i docker0 -n -vv -e icmp</span><br><span class="line"><span class="comment"># 监控 icmp or arp or udp。协议如：arp、ip、tcp、udp、icmp</span></span><br><span class="line">tcpdump -n -s 0 -e -i ens33 -v <span class="string">"icmp or arp or udp"</span></span><br><span class="line"><span class="comment"># 过滤来源/目的端口</span></span><br><span class="line">tcpdump -i eth1 port 21 <span class="comment"># tcpdump -i eth1 src/dst port 21 # 精确指定来源/目的端口</span></span><br><span class="line"><span class="comment"># 抓取所有经过eth1，目的地址是192.168.1.254或192.168.1.200端口是80的TCP数据(src - dst)</span></span><br><span class="line">tcpdump -i eth1 <span class="string">'((tcp) and (port 80) and ((dst host 192.168.1.254) or (dst host 192.168.1.200)))'</span></span><br><span class="line"><span class="comment"># 抓取所有经过eth1，目标MAC地址是00:01:02:03:04:05的ICMP数据</span></span><br><span class="line">tcpdump -i eth1 <span class="string">'((icmp) and ((ether dst host 00:01:02:03:04:05)))'</span></span><br><span class="line"><span class="comment"># 抓取所有经过eth1，目的网络是192.168，但目的主机不是192.168.1.200的TCP数据</span></span><br><span class="line">tcpdump -i eth1 <span class="string">'((tcp) and ((dst net 192.168) and (not dst host 192.168.1.200)))'</span></span><br><span class="line"><span class="comment"># 只抓SYN包，第十四字节是二进制的00000010，也就是十进制的2</span></span><br><span class="line">tcpdump -i eth1 <span class="string">'tcp[13] = 2'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 参数：</span></span><br><span class="line"><span class="comment"># -i &lt;网络接口&gt;：使用指定的网络接口经过的数据包</span></span><br><span class="line"><span class="comment"># -n ：不把主机的网络地址转换成名字</span></span><br><span class="line"><span class="comment"># -e ：在每列倾倒资料上显示连接层级的文件头(可显示ttl信息)</span></span><br><span class="line"><span class="comment"># -s &lt;数据包大小&gt;：设置每个数据包的大小</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 常用表达式</span></span><br><span class="line"><span class="comment"># 非：! 或 not；且：&amp;&amp; 或 and；或：|| 或 or</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 高级包头过滤(操作符：&gt;、&lt;、&gt;=、&lt;=、=、!=)</span></span><br><span class="line"><span class="comment"># proto[x]            ：如：tcp[13] = 2，过滤tcp包中第14个字节为2(对应二进制为00000010)的(即SYN包)</span></span><br><span class="line"><span class="comment"># proto[x:y]          ：过滤从x字节开始的y字节数。比如ip[2:2]过滤出3、4字节（第一字节从0开始排）</span></span><br><span class="line"><span class="comment"># proto[x:y] &amp; z = 0  ：proto[x:y]和z的与操作为0</span></span><br><span class="line"><span class="comment"># proto[x:y] &amp; z !=0  ：proto[x:y]和z的与操作不为0</span></span><br><span class="line"><span class="comment"># proto[x:y] &amp; z = z  ：proto[x:y]和z的与操作为z</span></span><br><span class="line"><span class="comment"># proto[x:y] = z      ：proto[x:y]等于z</span></span><br></pre></td></tr></table></figure><ul><li>示例说明</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 监控arp(每ping 一次会产生一个arp寻址报文，尽管网桥等设备已经保存了mac地址，也存在此报文)</span></span><br><span class="line"><span class="comment"># tcpdump -i docker0 -n -e arp</span></span><br><span class="line"><span class="comment"># 请求报文、响应报文1(当第一次arp时，由于不知道目标机器mac地址，是发送多播Broadcast报文)</span></span><br><span class="line">16:51:59.919605 00:0c:29:c2:53:b5 &gt; Broadcast, ethertype ARP (0x0806), length 42: Request who-has 192.168.6.132 tell 192.168.6.131, length 28</span><br><span class="line">16:51:59.919657 00:0c:29:21:bb:99 &gt; 00:0c:29:c2:53:b5, ethertype ARP (0x0806), length 42: Reply 192.168.6.132 is-at 00:0c:29:21:bb:99, length 28</span><br><span class="line"><span class="comment"># 请求报文、响应报文2(第二次arp时，arp表中存在相应mac地址，则发送单播报文)</span></span><br><span class="line">16:52:24.039775 00:0c:29:c2:53:b5 &gt; 00:0c:29:21:bb:99, ethertype ARP (0x0806), length 60: Request who-has 192.168.6.132 tell 192.168.6.131, length 46</span><br><span class="line">16:52:24.039798 00:0c:29:21:bb:99 &gt; 00:0c:29:c2:53:b5, ethertype ARP (0x0806), length 42: Reply 192.168.6.132 is-at 00:0c:29:21:bb:99, length 28</span><br></pre></td></tr></table></figure><h3 id="traceroute-tracert"><a href="#traceroute-tracert" class="headerlink" title="traceroute/tracert"></a>traceroute/tracert</h3><ul><li><code>traceroute/tracert</code> 程序的主要目的是获取从当前主机到目的主机所经过的路由，其中tracert为windows的命令 <a href="https://www.cnblogs.com/iiiiher/p/8513748.html" title="完全理解icmp协议" target="_blank" rel="noopener">^11</a></li><li>官方方案(TCP/IP详解里提供的基于 UDP 的方案)<ul><li>通过封装一份 UDP 数据报（指定一个不可能使用的端口，30000以上），依次将数据报的 TTL 值置为 1、2、3…，并发送给目的主机</li><li><strong>当路径上第一个路由器收到 TTL 值为 1 的数据报时，首先将该数据报的 TTL 值减 1，发现 TTL 值为 0，而自己并非该数据报的目的主机，就会向源主机发送一个 ICMP 超时报文</strong>，traceroute 收到该超时报文，就得到了路径上第一台路由器的地址</li><li>然后照此原理，traceroute 发送 TTL 为 2 的数据报时，会收到路径上第二台路由器返回的 ICMP 超时报文，记录第二台路由器的地址</li><li>直到报文到达目的主机，目的主机不会返回 ICMP 超时，但由于端口无法使用(但是存在正好该端口可使用的情况，只是可能性较小)，就会返回一份端口不可达报文给源主机，源主机收到端口不可达报文，证明数据报已经到达了目的地，停止后续的 UDP 数据报发送，将记录的路径依次打印出来，结束任务<ul><li>目的主机端口号最开始设置为 33435，且每发送一个数据报加 1，可以通过命令行选项来改变开始的端口号</li></ul></li></ul></li><li>TTL说明<ul><li><strong>TTL是数据包的发送主机设置的</strong>，发送主机指的是ping后面IP对应的主机(ping返回的TTL是指接收到响应数据包的TTL)。一般linux服务器为64，windows服务器为128，一般设置为255以下数值</li><li>TTL每经过一个路由器或代理服务器都会减1，如果TTL=0则中间路由设备或目的主机都会扔掉此包</li></ul></li></ul><h3 id="iptables"><a href="#iptables" class="headerlink" title="iptables"></a>iptables</h3><ul><li><a href="http://ipset.netfilter.org/iptables.man.html" target="_blank" rel="noopener">man-docs</a>、相关文章：<a href="http://blog.chinaunix.net/uid-23069658-id-3160506.html" target="_blank" rel="noopener">洞悉linux下的Netfilter&amp;iptables</a></li><li>iptables其实不是真正的防火墙，我们可以把它理解成一个客户端代理，用户通过iptables这个代理，将用户的安全设定执行到对应的安全框架(如：netfilter)中，这个安全框架才是直正的防火墙。netfilter位于内核空间，iptables位于用户空间</li><li>iptables的规则存储在内核空间的信息包过滤表中，这些规则分别指定了源地址、目的地址、传输协议(如TCP、UDP、ICMP)和服务类型(如HTTP、FTP和SMTP)等。当数据包与规则匹配时，iptables就根据规则所定义的方法来处理这些数据包，如放行(accept)、拒绝(reject)和丢弃(drop)等。配置防火墙的主要工作就是添加、修改和删除这些规则</li><li><p>链(规则)类型：<code>PREROUTING</code>、<code>INPUT</code>、<code>FORWARD</code>、<code>OUTPUT</code>、<code>POSTROUTING</code>。每种链类型上可能会有多个规则 <a href="http://www.zsythink.net/archives/1199/" title="iptables概念" target="_blank" rel="noopener">^1</a></p><p> <img src="/data/images/linux/报文流向.png" alt="报文流向"></p><ul><li>流入本机：PREROUTING –&gt; INPUT–&gt; 用户空间进程(本地套接字)</li><li>转发(本机程序间)：PREROUTING –&gt; FORWARD –&gt; POSTROUTING</li><li><p>流出本机（通常为响应报文）：用户空间进程 –&gt; OUTPUT–&gt; POSTROUTING</p><p><img src="/data/images/linux/iptables-route.png" alt="iptables-route"></p></li><li><p>整个chain是从prerouting入，到postrouting出</p></li><li>input和output都是针对运行中的监听进程而言，不是网卡，也不是主机</li><li>数据包到路由，路由通过路由表判断数据包的目的地。如果目的地是本机，就把数据包转给intput。如果目的地不是本机，则把数据包转给forward处理，通过forward处理后，再转给postrouting处理</li></ul></li><li>表：把具有相同功能的规则的集合叫做”表”，不同功能的规则可以放置在不同的表中进行管理。当他们处于同一条”链”时，执行的优先级为：<strong>raw &gt; mangle &gt; nat &gt; filter</strong><ul><li><code>raw</code>表：关闭nat表上启用的连接追踪机制；iptable_raw。可能被PREROUTING，OUTPUT使用</li><li><code>mangle</code>表：拆解报文，做出修改，并重新封装的功能；iptable_mangle。可能被PREROUTING，INPUT，FORWARD，OUTPUT，POSTROUTING使用</li><li><code>nat</code>表：network address translation，网络地址转换功能；内核模块：iptable_nat。可能被PREROUTING，INPUT，OUTPUT，POSTROUTING（centos6中无INPUT）使用</li><li><code>filter</code>表：负责过滤功能，防火墙；内核模块：iptables_filter。可能被INPUT，FORWARD，OUTPUT使用</li></ul></li><li>规则由匹配条件和处理动作组成<ul><li>匹配条件：源地址Source IP，目标地址 Destination IP，和一些扩展匹配条件</li><li>处理动作<a href="http://ipset.netfilter.org/iptables-extensions.man.html#lbCM" target="_blank" rel="noopener">target</a><ul><li><code>ACCEPT</code>：允许数据包通过（<strong>后续规则继续执行</strong>。此时会继续校验此链上的其他规则和剩余其他链规则）</li><li><code>DROP</code>：直接丢弃数据包，不给任何回应信息，过了超时时间才会有反应。或者出现ping永远无返回信息即卡死（<strong>后续不执行</strong>）</li><li><code>REJECT</code>：拒绝数据包通过，必要时会给数据发送端一个响应的信息，客户端刚请求就会收到拒绝的信息（<strong>后续不执行</strong>）</li><li><code>SNAT</code>：源地址转换，解决内网用户用同一个公网地址上网的问题（<strong>后续规则继续执行</strong>；只能在nat中使用）</li><li><code>MASQUERADE</code>：是SNAT的一种特殊形式，适用于动态的、临时会变的ip上（只能在nat中使用）</li><li><code>PNAT</code>：源端口转换</li><li><code>DNAT</code>：目标地址转换（只能在nat中使用）</li><li><code>REDIRECT</code>：在本机做端口映射（只能在nat中使用）</li><li><code>LOG</code>：在/var/log/messages文件中记录日志信息，然后将数据包传递给下一条规则，也就是说除了记录以外不对数据包做任何其他操作，仍然让下一条规则去匹配</li><li><code>RETURN</code>：结束在目前规则链中的过滤程序，返回主规则链继续过滤。如果把自定义链看成是一个子程序，那么这个动作就相当于提早结束子程序并返回到主程序中（<strong>此自定义链后续规则不执行，主链继续执行</strong>）</li><li><code>QUEUE</code>：防火墙将数据包移交到用户空间</li><li><code>TTL</code>：操作TTL（只能在mangle中使用）</li><li><code>TRACE</code>：跟踪记录日志（只能在raw表中使用）</li></ul></li></ul></li><li>列出iptables表规则 <a href="http://cn.linux.vbird.org/linux_server/0250simple_firewall.php#netfilter" title="防火墙与 NAT 服务器" target="_blank" rel="noopener">^2</a></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 列出iptables表规则</span></span><br><span class="line">iptables [-t tables] [-L] [-nv]</span><br><span class="line">    <span class="comment"># 选项与参数：</span></span><br><span class="line">    <span class="comment"># -t ：后面接 table ，例如 nat 或 filter ，若省略此项目，则使用默认的 filter</span></span><br><span class="line">    <span class="comment"># -n ：仅显示IP，不进行 IP 与 HOSTNAME 的反查。(否则显示HOSTNAME)</span></span><br><span class="line">    <span class="comment"># -v ：列出更多的信息，包括通过该规则的封包总位数、相关的网络接口等</span></span><br><span class="line">    <span class="comment"># -x ：显示详细数据，不进行单位换算</span></span><br><span class="line">    <span class="comment"># -L ：列出目前的 table 的规则</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出 **filter表(若nat表加参数`-t nat`)** 相关链的规则明细，包含数据包大小等</span></span><br><span class="line">iptables -nvxL</span><br><span class="line">    <span class="comment"># pkts        对应规则匹配到的报文的个数</span></span><br><span class="line">    <span class="comment"># bytes       对应匹配到的报文包的大小总和</span></span><br><span class="line">    <span class="comment"># target      规则对应的traget，表示对应的动作，即规则匹配成功后需要采取的措施</span></span><br><span class="line">    <span class="comment"># prot        表示规则对应的协议，是否只针对某些协议应用此规则</span></span><br><span class="line">    <span class="comment"># opt         表示规则对应的选项</span></span><br><span class="line">    <span class="comment"># in          表示数据包由哪个接口流入，可以设置哪块网卡流入的报文需要匹配当前规则</span></span><br><span class="line">    <span class="comment"># out         表示数据包由哪个接口流出，可以设置哪块网卡流出的报文需要匹配当前规则</span></span><br><span class="line">    <span class="comment"># source      表示规则对应的源头地址，可以是一个ip，也可以是一个网段</span></span><br><span class="line">    <span class="comment"># destination 表示规则对应的目标地址，可以是一个ip，也可以是一个网段</span></span><br><span class="line"><span class="comment"># 查看filter表的FORWARD链规则</span></span><br><span class="line">iptables -nvxL FORWARD</span><br><span class="line"><span class="comment"># 列出 nat table 相关链的规则（--line显示行编号）</span></span><br><span class="line">iptables -nvxL --line -t nat</span><br><span class="line"><span class="comment"># 基于链的顺序显示nat表中的规则</span></span><br><span class="line">iptables -t nat -S</span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例：iptables -nvxL 部分显示如下</span></span><br><span class="line">Chain INPUT (policy ACCEPT 937 packets, 77099 bytes) <span class="comment"># INPUT链中无任何规则；policy ACCEPT为默认处理动作</span></span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination      </span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes) <span class="comment"># FORWARD链中引入了自定义链DOCKER-ISOLATION-STAGE-1和DOCKER内容，当符合后面的规则就执行自定义链，相当于执行子函数；prot代表使用的封包协议（tcp, udp 及 icmp）；opt额外的选项说明；source/destination为源/目标地址</span></span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </span><br><span class="line">   30 10743 DOCKER-USER  all  --  *      *       0.0.0.0/0            0.0.0.0/0           </span><br><span class="line">   30 10743 DOCKER-ISOLATION-STAGE-1  all  --  *      *       0.0.0.0/0            0.0.0.0/0           </span><br><span class="line">   15  9681 ACCEPT     all  --  *      docker0  0.0.0.0/0            0.0.0.0/0            ctstate RELATED,ESTABLISHED</span><br><span class="line">    0     0 DOCKER     all  --  *      docker0  0.0.0.0/0            0.0.0.0/0           <span class="comment"># 此时虽然符合执行DOCKER子链，但是DOCKER子链中并无规则，所以此规则记录的pkts和bytes为0</span></span><br><span class="line">   15  1062 ACCEPT     all  --  docker0 !docker0  0.0.0.0/0            0.0.0.0/0           </span><br><span class="line">    0     0 ACCEPT     all  --  docker0 docker0  0.0.0.0/0            0.0.0.0/0           </span><br><span class="line">    0     0 ACCEPT     all  --  *      br-92de1a13d5ca  0.0.0.0/0            0.0.0.0/0            ctstate RELATED,ESTABLISHED</span><br><span class="line">   ...</span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT 723 packets, 123K bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </span><br><span class="line"></span><br><span class="line">Chain DOCKER (3 references)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">Chain DOCKER-USER (1 references)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </span><br><span class="line">   30 10743 RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0</span><br></pre></td></tr></table></figure><ul><li>操作iptables规则 <a href="https://blog.51cto.com/yijiu/1356254" title="iptables详解" target="_blank" rel="noopener">^3</a></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 参考：https://blog.csdn.net/qq_38892883/article/details/79709023</span></span><br><span class="line"><span class="comment">## 语法</span></span><br><span class="line">iptables [-t table] COMMAND [chain] CRETIRIA -j ACTION</span><br><span class="line">    -t table    <span class="comment"># filter/nat/mangle</span></span><br><span class="line">    COMMAND     <span class="comment"># 定义如何对规则进行管理</span></span><br><span class="line">    chain       <span class="comment"># 定义规则作用的链；当定义策略的时可省略的</span></span><br><span class="line">    CRETIRIA    <span class="comment"># 指定匹配标准</span></span><br><span class="line">    -j ACTION   <span class="comment"># 指定如何进行处理。参考处理动作(target)：ACCEPT、DROP、SNAT、DNAT等</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## COMMAND参数解释</span></span><br><span class="line"><span class="comment"># 链管理命令</span></span><br><span class="line">-P  <span class="comment"># 设置默认策略(DROP|ACCEPT)</span></span><br><span class="line">        <span class="comment"># eg: iptables -P INPUT DROP # 进入到INPUT链时，如果没有匹配到任何规则，则默认DROP拒绝此数据包</span></span><br><span class="line">-F  <span class="comment"># FLASH，清空规则链的</span></span><br><span class="line">        <span class="comment"># eg: iptables -t nat -F            # 清空nat表的所有链</span></span><br><span class="line">        <span class="comment"># eg: iptables -t nat -F PREROUTING # 清空nat表的PREROUTING链</span></span><br><span class="line">-N  <span class="comment"># NEW，支持用户新建一个链</span></span><br><span class="line">        <span class="comment"># eg: iptables -N inbound_tcp_web # 逻辑意义为附在tcp表上用于检查web</span></span><br><span class="line">-X  <span class="comment"># 用于删除用户自定义的空链；使用方法跟-N相同，但是在删除之前必须要将里面的链给清空</span></span><br><span class="line">-E  <span class="comment"># 用来Rename chain主要是用来给用户自定义的链重命名</span></span><br><span class="line">        <span class="comment"># eg: iptables -E oldname newname</span></span><br><span class="line">-Z  <span class="comment"># 清空链及链中默认规则的计数器的（有两个计数器：数据包个数、数据包字节大小）</span></span><br><span class="line">        <span class="comment"># eg: iptables -Z -t mangle</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 规则管理命令</span></span><br><span class="line">-A  <span class="comment"># 追加，在当前链的最后新增一个规则</span></span><br><span class="line">-I  <span class="comment"># 插入，把当前规则插入为第几条</span></span><br><span class="line">    <span class="comment"># eg: iptables -I PREROUTING 3 ... # 向PREROUTING链中的第3条插入规则</span></span><br><span class="line">-R  <span class="comment"># 替换/修改第几条规则</span></span><br><span class="line">    <span class="comment"># eg: iptables -R 3 ... # 修改第3条规则</span></span><br><span class="line">-D  <span class="comment"># 删除第几条规则</span></span><br><span class="line">    <span class="comment"># eg: sudo iptables -t mangle -D PREROUTING 1 # 删除 mangle表PREROUTING链的第1条规则</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看管理命令</span></span><br><span class="line">-L  <span class="comment"># 查看表中的规则</span></span><br><span class="line">    <span class="comment"># 子命令：-n、-v、-vv、-vvv、-x、--line/--line-numbers、-t</span></span><br><span class="line">-S  <span class="comment"># 基于链的顺序显示表中规则。eg：iptables -t nat -S</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## CRETIRIA匹配标准参数解释</span></span><br><span class="line"><span class="comment"># 通用匹配：源地址目标地址的匹配</span></span><br><span class="line">-s          <span class="comment"># 指定作为源地址匹配，这里不能指定主机名称，必须是IP（IP | IP/MASK | 0.0.0.0/0.0.0.0），而且地址可以取反，加一个"!"表示除了哪个IP之外.</span></span><br><span class="line">    <span class="comment"># eg: -s 192.168.1.10   # 源地址为192.168.1.10的数据包</span></span><br><span class="line">    <span class="comment"># eg: ! -s 127.0.0.0/8   # 源地址不为127.0.0.0/8的数据包</span></span><br><span class="line">-d          <span class="comment"># 表示匹配目标地址</span></span><br><span class="line">-p          <span class="comment"># 用于匹配协议的（这里的协议通常有3种，TCP/UDP/ICMP，见下文）</span></span><br><span class="line">-i  eth0    <span class="comment"># 匹配数据经这块网卡流入，流入一般用在INPUT和PREROUTING上</span></span><br><span class="line">-o  eth0    <span class="comment"># 匹配数据经这块网卡流出，流出一般在OUTPUT和POSTROUTING上</span></span><br><span class="line"><span class="comment"># 扩展匹配</span></span><br><span class="line"><span class="comment"># 隐含扩展：对协议的扩展</span></span><br><span class="line">-p tcp  <span class="comment"># TCP协议的扩展</span></span><br><span class="line">    --dport XX-XX   <span class="comment"># 指定目标端口，不能指定多个非连续端口，只能指定单个端口</span></span><br><span class="line">        <span class="comment"># eg: --dport 21  或者 --dport 21-23(此时表示21,22,23)</span></span><br><span class="line">    --sport <span class="comment"># 指定源端口</span></span><br><span class="line">    --tcp-fiags <span class="comment"># 一般跟的参数：检查标志位、必须为1的标志位。TCP的标志位（SYN、ACK、FIN、PSH、RST、URG）</span></span><br><span class="line">        <span class="comment"># eg: --tcpflags syn,ack,fin,rst syn # 用于检测三次握手的第一次数据包，对于这种专门匹配第一包的SYN为1的包</span></span><br><span class="line">            <span class="comment"># 检查标志位：syn,ack,fin,rst，必须为1的标志位：syn(其他必须为0)</span></span><br><span class="line">            <span class="comment"># --tcpflags syn,ack,fin,rst syn &lt;=等同于=&gt; --syn</span></span><br><span class="line">-p udp  <span class="comment"># UDP协议的扩展</span></span><br><span class="line">    --dport</span><br><span class="line">    --sport</span><br><span class="line">-p icmp <span class="comment"># icmp数据报文的扩展</span></span><br><span class="line">    --icmp-type <span class="comment"># 匹配icmp类型</span></span><br><span class="line">        <span class="comment"># eg: --icmp-type 8 # 匹配请求回显数据包。echo-request(请求回显)，一般用8来表示；echo-reply(响应数据包)一般用0来表示</span></span><br><span class="line"><span class="comment"># 显式扩展（-m），扩展各种模块</span></span><br><span class="line">-m multiport    <span class="comment"># 表示启用多端口扩展，之后就可以使用比如：--dports 21,23,80</span></span><br><span class="line">-m ttl          <span class="comment"># 表示开启ttl扩展。如：iptables -A INPUT -m ttl --ttl-gt 50 -m length --length 722:65535 -j DROP</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 示例</span></span><br><span class="line"><span class="comment"># 如果数据包经 eth0 网卡流入，则对其TTL值加3 (有效解决主网TTL被运营线篡改导致TTL异常，如TTL=1，此时无法做子网路由)</span></span><br><span class="line">iptables -t mangle -A PREROUTING -i eth0 -j TTL --ttl-inc 3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 跟踪记录日志，保存在 /var/log/syslog</span></span><br><span class="line">iptables -t raw -A OUTPUT -p icmp -j TRACE</span><br><span class="line">iptables -t raw -A PREROUTING -p icmp -j TRACE</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开放防火墙指定端口</span></span><br><span class="line">iptables -A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT</span><br><span class="line">iptables -A INPUT -p tcp -m state --state NEW -m tcp --dport 80 -j ACCEPT</span><br><span class="line">iptables -A INPUT -p tcp -m state --state NEW -m tcp --dport 8080 -j ACCEPT</span><br><span class="line">iptables -A INPUT -p tcp -m state --state NEW -m tcp --dport 3306 -j ACCEPT</span><br><span class="line"><span class="comment"># 允许ip访问</span></span><br><span class="line">iptables -A INPUT -p tcp -s 192.168.xx.x -j ACCEPT</span><br><span class="line"><span class="comment"># 禁止ip访问</span></span><br><span class="line">iptables -A INPUT -p tcp -s 192.168.xx.x -j DROP</span><br><span class="line"><span class="comment"># 允许访问3306</span></span><br><span class="line">iptables -A INPUT -s 192.168.xx.x -p tcp -m tcp --dport 3306 -j ACCEPT</span><br><span class="line"><span class="comment"># 禁止访问3306</span></span><br><span class="line">iptables -A OUTPUT -s 192.168.xx.x -p tcp -m tcp --sport 3306 -j DROP</span><br></pre></td></tr></table></figure><ul><li>暂存和恢复iptables规则<ul><li><code>iptables-save &gt; /etc/sysconfig/iptables</code> 暂存所有规则到文件中</li><li><code>iptables-restore &lt; /etc/sysconfig/iptables</code> 将文件中暂存的规则恢复到规则表中</li></ul></li></ul><h4 id="firewalld"><a href="#firewalld" class="headerlink" title="firewalld"></a>firewalld</h4><ul><li>决定能否访问到服务器，或服务器能否访问其他服务，取决于<code>服务器防火墙</code>和<code>云服务器后台管理的安全组</code><ul><li>云服务器一般有进站出站规则，端口开放除了系统的防火墙也要考虑进出站规则</li></ul></li><li>Centos7默认防火墙为<code>firewalld</code>，代替了原来的<code>iptables</code><ul><li>防火墙路由规则使用firewall-cmd命令进行维护(也可使用iptables添加)；如果需要使用原来的iptables服务，则需要安装iptables-services才能使用(此时可使用<code>systemctl start iptables</code>启动)，但是两个服务只需要启动一个</li></ul></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看状态</span></span><br><span class="line">systemctl status firewalld</span><br><span class="line"><span class="comment"># 关闭防火墙</span></span><br><span class="line">systemctl stop firewalld &amp;&amp; systemctl <span class="built_in">disable</span> firewalld</span><br><span class="line"></span><br><span class="line"><span class="comment"># iptables查看filter表策略`iptables -nvxL`</span></span><br><span class="line"><span class="comment"># --zone 为区域(默认为public)</span></span><br><span class="line">firewall-cmd --zone=public --query-port=80/tcp <span class="comment"># 查看端口</span></span><br><span class="line">firewall-cmd --list-ports <span class="comment"># 查看所有端口</span></span><br><span class="line">firewall-cmd --list-all <span class="comment"># 列举所有配置</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 开放端口(必须重新载入配置或重启服务才会生效)；--permanent永久生效，没有此参数重启后失效；协议如: tcp(http/ws), udp, sctp or dccp；也可使用iptables添加</span></span><br><span class="line"><span class="comment"># 在每次修改端口和服务后 /etc/firewalld/zones/public.xml 文件(参考下文)就会被修改，所以也可以在文件中之间修改（**建议直接修改文件**）</span></span><br><span class="line"><span class="comment"># 使用命令实际也是在修改文件，需要重新加载（firewall-cmd --reload）才能生效</span></span><br><span class="line">firewall-cmd --permanent --add-port=22/tcp</span><br><span class="line">firewall-cmd --permanent --add-port=80/tcp</span><br><span class="line"><span class="comment"># 重新载入(需要将所有的修改都执行后再运行reload，修改后必须重新载入才会生效)</span></span><br><span class="line">firewall-cmd --reload</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除端口(必须重新载入才会生效)</span></span><br><span class="line">firewall-cmd --permanent --remove-port=80/tcp</span><br><span class="line"><span class="comment"># 可基于服务名称添加，需要结合/etc/firewalld/services目录下的xml配置文件 (也需要reload)</span></span><br><span class="line">firewall-cmd --permanent --add-service=xl2tpd</span><br><span class="line"></span><br><span class="line"><span class="comment"># firewall-cmd命令</span></span><br><span class="line">man firewall-cmd</span><br><span class="line">firewall-cmd -h</span><br></pre></td></tr></table></figure><ul><li>/etc/firewalld/zones/public.xml</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"utf-8"</span><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="tag">&lt;<span class="name">zone</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">service</span> <span class="attr">name</span>=<span class="string">"xl2tpd"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">port</span> <span class="attr">protocol</span>=<span class="string">"tcp"</span> <span class="attr">port</span>=<span class="string">"22"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">port</span> <span class="attr">protocol</span>=<span class="string">"tcp"</span> <span class="attr">port</span>=<span class="string">"80"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">zone</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="ebtables"><a href="#ebtables" class="headerlink" title="ebtables"></a>ebtables</h3><ul><li><a href="https://ebtables.netfilter.org" target="_blank" rel="noopener">ebtables</a>、<a href="https://ebtables.netfilter.org/misc/ebtables-man.html" target="_blank" rel="noopener">man-docs</a></li><li><code>ebtables</code> 和 <code>iptables</code> <a href="https://blog.csdn.net/gongjun12345/article/details/83788087" target="_blank" rel="noopener">^13</a><ul><li>都是linux系统下netfilter的配置工具，可以在链路层和网络层的几个关键节点配置报文过滤和修改规则</li><li>ebtables更侧重vlan，mac和报文流量(太网层面)；iptables侧重ip层信息，4层的端口信息</li><li>ebtables 就像以太网桥的 iptables。iptables 不能过滤桥接流量，而 ebtables 可以；ebtables 不适合作为 Internet 防火墙</li></ul></li><li>Netfilter-Packet-Flow</li></ul><p><img src="/data/images/linux/Netfilter-Packet-Flow.png" alt="Netfilter-Packet-Flow"></p><ul><li>使用示例</li></ul><blockquote><p><a href="https://ebtables.netfilter.org/misc/ebtables-man.html" target="_blank" rel="noopener">https://ebtables.netfilter.org/misc/ebtables-man.html</a></p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">ebtables <span class="comment"># 打印帮助</span></span><br><span class="line">-t      <span class="comment"># 指定表。table包含：broute、nat、filter</span></span><br><span class="line">        <span class="comment"># broute表：用于控制进来的数据包是需要进行bridge转发还是进行route转发，即2层转发和3层转发</span></span><br><span class="line">-L      <span class="comment"># 查询表规则</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 查询</span></span><br><span class="line"><span class="comment"># 查询 filter 表规则</span></span><br><span class="line">ebtables -L</span><br><span class="line"><span class="comment"># -t指定表为nat(参数必须在最前面)</span></span><br><span class="line">ebtables -t nat -L</span><br><span class="line">ebtables -t nat -Lx <span class="comment"># x必须在-L后面</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 记录日志(ebtables目前还不支持TRACE)，可在 /var/log/syslog 中查看</span></span><br><span class="line"><span class="comment"># 这里 --ip-proto 1 表示仅 match icmp packet</span></span><br><span class="line">ebtables -t broute -A BROUTING -p ipv4 --ip-proto 1 --<span class="built_in">log</span>-level 6 --<span class="built_in">log</span>-ip --<span class="built_in">log</span>-prefix <span class="string">"TRACE: eb:broute:BROUTING"</span> -j ACCEPT</span><br><span class="line">ebtables -t nat -A OUTPUT -p ipv4 --ip-proto 1 --<span class="built_in">log</span>-level 6 --<span class="built_in">log</span>-ip --<span class="built_in">log</span>-prefix <span class="string">"TRACE: eb:nat:OUTPUT"</span>  -j ACCEPT</span><br><span class="line">ebtables -t nat -A PREROUTING -p ipv4 --ip-proto 1 --<span class="built_in">log</span>-level 6 --<span class="built_in">log</span>-ip --<span class="built_in">log</span>-prefix <span class="string">"TRACE: eb:nat:PREROUTING"</span> -j ACCEPT</span><br><span class="line">ebtables -t filter -A INPUT -p ipv4 --ip-proto 1 --<span class="built_in">log</span>-level 6 --<span class="built_in">log</span>-ip --<span class="built_in">log</span>-prefix <span class="string">"TRACE: eb:filter:INPUT"</span> -j ACCEPT</span><br><span class="line">ebtables -t filter -A FORWARD -p ipv4 --ip-proto 1 --<span class="built_in">log</span>-level 6 --<span class="built_in">log</span>-ip --<span class="built_in">log</span>-prefix <span class="string">"TRACE: eb:filter:FORWARD"</span> -j ACCEPT</span><br><span class="line">ebtables -t filter -A OUTPUT -p ipv4 --ip-proto 1 --<span class="built_in">log</span>-level 6 --<span class="built_in">log</span>-ip --<span class="built_in">log</span>-prefix <span class="string">"TRACE: eb:filter:OUTPUT"</span> -j ACCEPT</span><br><span class="line">ebtables -t nat -A POSTROUTING -p ipv4 --ip-proto 1 --<span class="built_in">log</span>-level 6 --<span class="built_in">log</span>-ip --<span class="built_in">log</span>-prefix <span class="string">"TRACE: eb:nat:POSTROUTING"</span> -j ACCEPT</span><br></pre></td></tr></table></figure><h3 id="iftop-监控网络带宽使用-基于IP"><a href="#iftop-监控网络带宽使用-基于IP" class="headerlink" title="iftop 监控网络带宽使用(基于IP)"></a>iftop 监控网络带宽使用(基于IP)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 安装</span></span><br><span class="line">yum install iftop -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># 监控某网卡</span></span><br><span class="line">iftop -i eth0</span><br><span class="line"><span class="comment"># 监控某个特定IP的带宽访问情况</span></span><br><span class="line">iftop -i eth1 -B -F 192.168.***.10</span><br><span class="line"></span><br><span class="line"><span class="comment">## 界面说明:</span></span><br><span class="line"><span class="string">"&lt;="</span>与<span class="string">"=&gt;"</span>：表示的是流量的方向</span><br><span class="line"><span class="string">"TX"</span>：从网卡发出的流量</span><br><span class="line"><span class="string">"RX"</span>：网卡接收流量</span><br><span class="line"><span class="string">"TOTAL"</span>：网卡发送接收总流量</span><br><span class="line"><span class="string">"cum"</span>：iftop开始运行到当前时间点的总流量</span><br><span class="line"><span class="string">"peak"</span>：网卡流量峰值</span><br><span class="line"><span class="string">"rates"</span>：分别表示最近2s、10s、40s 的平均流量</span><br></pre></td></tr></table></figure><h3 id="nethogs-监控网络带宽使用-基于进程"><a href="#nethogs-监控网络带宽使用-基于进程" class="headerlink" title="nethogs 监控网络带宽使用(基于进程)"></a>nethogs 监控网络带宽使用(基于进程)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 安装</span></span><br><span class="line">yum -y install libpcap nethogs</span><br><span class="line"></span><br><span class="line"><span class="comment"># 监控网卡eth0的带宽占用情况，每五秒刷新一次</span></span><br><span class="line">nethogs eth0 -d 5</span><br><span class="line"></span><br><span class="line"><span class="comment">## 命令</span></span><br><span class="line">m :修改单位</span><br><span class="line">s :按发送流量排序</span><br><span class="line">r :按接收流量排序</span><br><span class="line">q :退出命令提示符</span><br></pre></td></tr></table></figure><h3 id="Socket测试-TCP-UDP"><a href="#Socket测试-TCP-UDP" class="headerlink" title="Socket测试(TCP/UDP)"></a>Socket测试(TCP/UDP)</h3><ul><li>linux测试工具<a href="http://netcat.sourceforge.net/" target="_blank" rel="noopener">Netcat</a>。Netcat是一款非常出名的网络工具，简称”NC”，有渗透测试中的”瑞士军刀”之称。它可以用作端口监听、端口扫描、远程文件传输、还可以实现远程shell等功能 <a href="https://medium.com/@programthink/%E6%89%AB%E7%9B%B2-netcat-%E7%BD%91%E7%8C%AB-%E7%9A%84-n-%E7%A7%8D%E7%94%A8%E6%B3%95-%E4%BB%8E-%E7%BD%91%E7%BB%9C%E8%AF%8A%E6%96%AD-%E5%88%B0-%E7%B3%BB%E7%BB%9F%E5%85%A5%E4%BE%B5-3c12b3ce0fdf" target="_blank" rel="noopener">^15</a></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">yum install -y nc</span><br><span class="line"></span><br><span class="line"><span class="comment"># （网络诊断）测试某个远程主机的监听端口是否可达，无法连接会退回到命令行</span></span><br><span class="line">nc 127.0.0.1 1000</span><br><span class="line"><span class="comment"># （网络诊断）判断防火墙是否允许or禁止某个端口，如下在服务器上启动监听，然后在另外一台机器上进行端口可达测试</span></span><br><span class="line">nc -lv -p 8080 <span class="comment"># -l进入监听模式，-v显示详细信息</span></span><br><span class="line"><span class="comment"># （渗透测试）用 nc 端口扫描。不论是 TCP 还是 UDP，协议规定的端口号范围都是：1 ~ 65535</span></span><br><span class="line">nc -znv 127.0.0.1 1-1024 2&gt;&amp;1 | grep succeeded <span class="comment"># 扫描此ip的1-1024端口开启情况。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 命令参数（其实常用的就几个参数-n,-v,-l,-p,-q）</span></span><br><span class="line">-c shell commands shell模式</span><br><span class="line">-e filename 程序重定向 [危险!!]</span><br><span class="line">-b 允许广播</span><br><span class="line">-d 无命令行界面,使用后台模式</span><br><span class="line">-g gateway 源路由跳跃点, 不超过8</span><br><span class="line">-G num 源路由指示器: 4, 8, 12, ...</span><br><span class="line">-h 获取帮助信息</span><br><span class="line">-i secs 延时设置,端口扫描时使用</span><br><span class="line">-k 设置在socket上的存活选项</span><br><span class="line">-l 监听入站信息</span><br><span class="line">-n 不对IP地址进行DNS解析</span><br><span class="line">-o file 使进制记录</span><br><span class="line">-p port 本地端口</span><br><span class="line">-r 随机本地和远程的端口</span><br><span class="line">-q secs 在标准输入且延迟后退出（翻译的不是很好，后面实例介绍）</span><br><span class="line">-s addr 本地源地址</span><br><span class="line">-T tos 设置服务类型</span><br><span class="line">-t 以TELNET的形式应答入站请求</span><br><span class="line">-u UDP模式</span><br><span class="line">-v 显示详细信息 [使用=vv获取更详细的信息</span><br><span class="line">-w secs 连接超时设置</span><br><span class="line">-z I/O 模式,只进行连接不进行通信 [扫描时使用]</span><br></pre></td></tr></table></figure><ul><li>windows测试工具如<a href="https://sourceforge.net/projects/sockettest/" target="_blank" rel="noopener">SocketTest</a>，可测试TCP/UDP，包含服务端和客户端</li></ul><h2 id="网络工具"><a href="#网络工具" class="headerlink" title="网络工具"></a>网络工具</h2><ul><li>Wireshark/Fiddler/Charles<ul><li>Wireshark能获取HTTP，也能获取HTTPS，但是不能解密HTTPS。如果是处理HTTP/HTTPS 可使用Fiddler，其他协议比如TCP/UDP就用Wireshark。Wireshark使用也更复杂</li><li>Fiddler不支持Mac，新的Fiddler everywhere需要破解</li></ul></li></ul><h3 id="Charles抓包"><a href="#Charles抓包" class="headerlink" title="Charles抓包"></a>Charles抓包</h3><ul><li><a href="https://www.charlesproxy.com/" target="_blank" rel="noopener">官网</a></li><li><a href="https://www.zzzmode.com/mytools/charles/" target="_blank" rel="noopener">下载5.0后破解(科学上网)</a>，如<code>moon/ef30d3ee8ee17ac30d</code></li><li>参考: <a href="https://www.zhoulujun.cn/html/tools/NetTools/PacketCapture/8908.html" target="_blank" rel="noopener">https://www.zhoulujun.cn/html/tools/NetTools/PacketCapture/8908.html</a></li></ul><h3 id="Wireshark抓包"><a href="#Wireshark抓包" class="headerlink" title="Wireshark抓包"></a>Wireshark抓包</h3><ul><li>参考<ul><li><a href="https://www.cnblogs.com/shadow-fy/p/17754479.html" target="_blank" rel="noopener">https://www.cnblogs.com/shadow-fy/p/17754479.html</a></li></ul></li><li>如果是公网抓包，一般需要选择监听类似以太网的网卡</li><li>常用表达式</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 监听本机发送给114.114.114.114的包</span></span><br><span class="line">ip.src == 192.168.1.100 &amp;&amp; ip.dst == 114.114.114.114</span><br><span class="line"><span class="comment"># 监听本机发送和收到的114.114.114.114的包</span></span><br><span class="line">(ip.src == 192.168.1.100 &amp;&amp; ip.dst == 114.114.114.114) || (ip.src == 114.114.114.114 &amp;&amp; ip.dst == 192.168.1.100)</span><br><span class="line"><span class="comment"># 监听本机发送给服务器80端口的包</span></span><br><span class="line">ip.src == 192.168.1.100 &amp;&amp; tcp.dstport == 80</span><br></pre></td></tr></table></figure><ul><li>表达式字典<ul><li>点击表达式输入框右侧的”表达式”按钮可显示所有支持的表达式（已经分好类）</li><li>常用的如<code>IPv4</code>、<code>HTTP2</code>、<code>TCP</code>、<code>UDP</code>、<code>ICMP</code>等。如搜索IPv4或ip.src和定位到相关表达式，右侧会显示此表达式支持的关系类型(==、!=、in、contains等)</li></ul></li></ul><h2 id="网络异常排查案例"><a href="#网络异常排查案例" class="headerlink" title="网络异常排查案例"></a>网络异常排查案例</h2><h3 id="TTL-1导致虚拟机-docker无法访问外网"><a href="#TTL-1导致虚拟机-docker无法访问外网" class="headerlink" title="TTL=1导致虚拟机/docker无法访问外网"></a>TTL=1导致虚拟机/docker无法访问外网</h3><ul><li>前言：公司选择了便宜的网络运营商，导致无论ping那个地址，总是返回TTL=1。直接在公司路由器上测试亦是如此，说明：ping公司内部网络是没有问题的</li><li>环境介绍：物理机A(192.168.1.72)安装Centos7系统；然后在物理机基于KVM虚拟化出一台虚拟机A1(192.168.122.86)，并且基于NAT的方式联网。之前在A上测试过使用桥接模式时，虚拟机A1是可以访问外网的。此测试在之前测试之上完成，因此物理机A上存在一个虚拟网桥br0，其网卡enp6s0是桥接于br0上的；而KVM使用NAT模式时会自动创建一个虚拟网桥virbr0和创建一个虚拟网卡vnet0</li><li>产生现象<ul><li>Linux物理机可正常上网，ping百度返回TTL=1。基于NAT模式，KVM虚拟机无法上网；基于网桥模式创建的docker容器，在docker容器内无法上网。(docker的网桥模式本质是基于iptables进行的NAT转发)</li><li>windows物理机上使用VMware创建Centos7虚拟机B当做上述的宿主机，且在VMware中设置为NAT网络模式，在B中创建KVM虚拟机B1。此时B和B1均可以访问外网；且在B中ping百度返回TTL=128</li></ul></li><li><p>现象分析</p><ul><li><p>基于NAT模式的KVM虚拟机无法上网</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### tcpdump监控上述A的几个网卡的icmp包，并在虚拟机A1上ping外网(只发一个包：ping -c 1 114.114.114.114)</span></span><br><span class="line"><span class="comment">## 数据包发送流向：eth0(A1) -&gt; vnet0(A) -&gt; virbr0 -&gt; br0 -&gt; enps60 -&gt; Internet</span></span><br><span class="line"><span class="comment">## 数据包返回流向：eth0(A1) &lt;-- vnet0(A) &lt;-- virbr0 &lt;- br0 &lt;- enps60 &lt;- Internet</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## virbr0(tcpdump -i virbr0 -n icmp -vv -e)</span></span><br><span class="line"><span class="comment"># 数据包经过virbr0，之前没有进行过路由转发，因此virbr0受到的数据包TTL=64；此时发现需要转发到br0，因此virbr0会对TTL减1，然后发给br0，因此br0受到的TTL=63</span></span><br><span class="line">12:58:34.595496 52:54:00:38:ba:c7 &gt; 52:54:00:7f:f7:c3, ethertype IPv4 (0x0800), length 98: (tos 0x0, ttl 64, id 25917, offset 0, flags [DF], proto ICMP (1), length 84)</span><br><span class="line">    192.168.122.86 &gt; 114.114.114.114: ICMP <span class="built_in">echo</span> request, id 14135, seq 1, length 64</span><br><span class="line"></span><br><span class="line"><span class="comment">## br0(tcpdump -i br0 -n icmp -vv -e)</span></span><br><span class="line">12:58:34.595557 00:e0:8a:68:01:42 &gt; 00:f1:f5:14:cf:ab, ethertype IPv4 (0x0800), length 98: (tos 0x0, ttl 63, id 25917, offset 0, flags [DF], proto ICMP (1), length 84)</span><br><span class="line">    192.168.1.72 &gt; 114.114.114.114: ICMP <span class="built_in">echo</span> request, id 14135, seq 1, length 64</span><br><span class="line"><span class="comment"># 此时TTL=1表示：Internet数据包(返回数据包)到此网卡时，数据包中TTL=1；此时会先将TTL减1后发现TTL值为0，而自己并非该数据报的目的主机，就会向源主机发送一个 ICMP 超时报文</span></span><br><span class="line"><span class="comment"># docker容器从docker0向eth0转发时，到达eth0的TTL也会减少1</span></span><br><span class="line">12:58:34.804159 00:f1:f5:14:cf:ab &gt; 00:e0:8a:68:01:42, ethertype IPv4 (0x0800), length 98: (tos 0x28, ttl 1, id 16493, offset 0, flags [none], proto ICMP (1), length 84)</span><br><span class="line">    114.114.114.114 &gt; 192.168.1.72: ICMP <span class="built_in">echo</span> reply, id 14135, seq 1, length 64</span><br><span class="line"><span class="comment"># 发送 ICMP time exceeded in-transit 超时报文，对应ICMP错误码：TYPE=11，CODE=0/1。并将此错误告知源主机(Internet)</span></span><br><span class="line">12:58:34.804208 00:e0:8a:68:01:42 &gt; 00:f1:f5:14:cf:ab, ethertype IPv4 (0x0800), length 126: (tos 0xc8, ttl 64, id 18352, offset 0, flags [none], proto ICMP (1), length 112)</span><br><span class="line">    192.168.1.72 &gt; 114.114.114.114: ICMP time exceeded <span class="keyword">in</span>-transit, length 92</span><br><span class="line">    (tos 0x28, ttl 1, id 16493, offset 0, flags [none], proto ICMP (1), length 84)</span><br><span class="line">    114.114.114.114 &gt; 192.168.1.72: ICMP <span class="built_in">echo</span> reply, id 14135, seq 1, length 64</span><br><span class="line"></span><br><span class="line"><span class="comment">## enp6s0(tcpdump -i enp6s0 -n icmp -vv -e)</span></span><br><span class="line">12:58:34.595571 00:e0:8a:68:01:42 &gt; 00:f1:f5:14:cf:ab, ethertype IPv4 (0x0800), length 98: (tos 0x0, ttl 63, id 25917, offset 0, flags [DF], proto ICMP (1), length 84)</span><br><span class="line">    192.168.1.72 &gt; 114.114.114.114: ICMP <span class="built_in">echo</span> request, id 14135, seq 1, length 64</span><br><span class="line">12:58:34.804159 00:f1:f5:14:cf:ab &gt; 00:e0:8a:68:01:42, ethertype IPv4 (0x0800), length 98: (tos 0x28, ttl 1, id 16493, offset 0, flags [none], proto ICMP (1), length 84)</span><br><span class="line">    114.114.114.114 &gt; 192.168.1.72: ICMP <span class="built_in">echo</span> reply, id 14135, seq 1, length 64</span><br><span class="line">12:58:34.804213 00:e0:8a:68:01:42 &gt; 00:f1:f5:14:cf:ab, ethertype IPv4 (0x0800), length 126: (tos 0xc8, ttl 64, id 18352, offset 0, flags [none], proto ICMP (1), length 112)</span><br><span class="line">    192.168.1.72 &gt; 114.114.114.114: ICMP time exceeded <span class="keyword">in</span>-transit, length 92</span><br><span class="line">    (tos 0x28, ttl 1, id 16493, offset 0, flags [none], proto ICMP (1), length 84)</span><br><span class="line">    114.114.114.114 &gt; 192.168.1.72: ICMP <span class="built_in">echo</span> reply, id 14135, seq 1, length 64</span><br><span class="line"></span><br><span class="line"><span class="comment">## 在本地windows上使用VMware创建Centos7虚拟机B作为宿主机，并使用NAT网络；在B中创建的KVM虚机上ping外网正常。如下为监听宿主机B的br0网卡信息</span></span><br><span class="line">10:58:15.103187 00:50:56:20:1d:3a &gt; 00:50:56:e2:64:56, ethertype IPv4 (0x0800), length 98: (tos 0x0, ttl 63, id 46399, offset 0, flags [DF], proto ICMP (1), length 84)</span><br><span class="line">    192.168.6.10 &gt; 114.114.114.114: ICMP <span class="built_in">echo</span> request, id 11275, seq 1, length 64</span><br><span class="line"><span class="comment"># 此时TTL=128。由此可知同样的环境，只不过是宿主机B的外层还套了一个VMware的控制，右侧可猜想是VMware的NAT模式篡改了此处TTL的值</span></span><br><span class="line">10:58:15.346226 00:50:56:e2:64:56 &gt; 00:50:56:20:1d:3a, ethertype IPv4 (0x0800), length 98: (tos 0x0, ttl 128, id 36174, offset 0, flags [none], proto ICMP (1), length 84)</span><br><span class="line">    114.114.114.114 &gt; 192.168.6.10: ICMP <span class="built_in">echo</span> reply, id 11275, seq 1, length 64</span><br></pre></td></tr></table></figure></li><li><p>docker容器内无法上网原因同上，相关分析如下</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- eth0`为容器网卡，docker0和eth0为宿主机网卡；eth0`和docker0中间基于veth pair进行交互此处省略 --&gt;</span></span><br><span class="line">1.eth0` -&gt; docker0 触发PREROUTING</span><br><span class="line">2.docker0路由判断：to 114 =&gt; docker0 -&gt; !docker0(out) 触发FORWARD</span><br><span class="line">3.访问114：MASQUERADE * -&gt; !docker0  172.17.0.0/16 -&gt; 0.0.0.0/0 触发POSTROUTING</span><br><span class="line">4.路由判断(ip r)，访问114：使用eth0访问，192.168.6.10 -&gt; 114</span><br><span class="line">5.114返回处理包：114 -&gt; 192.168.6.10 回执数据从eth0进入(返回)</span><br><span class="line">6.进入PREROUTING阶段，根据连接跟踪系统记录源发送IP为172，114 -&gt; 172.17.0.x</span><br><span class="line">7.路由判断，访问172则基于docker0流入，触发FORWARD</span><br><span class="line">8.之后报文经过POSTROUTING阶段进入容器</span><br></pre></td></tr></table></figure><ul><li>Docker网络参考 <a href="https://www.cnblogs.com/lkun/p/7747459.html" title="容器如何与外部进行通信）" target="_blank" rel="noopener">^6</a> <a href="https://blog.csdn.net/light_jiang2016/article/details/79029661" target="_blank" rel="noopener">^9</a><ul><li>Docker容器通过独立IP暴露给局域网的方法：基于路由完成(不常用) <a href="https://blog.csdn.net/lvshaorong/article/details/69950694" target="_blank" rel="noopener">^8</a></li></ul></li><li>关于连接跟踪系统记录的源IP参考 <a href="http://blog.chinaunix.net/uid-23069658-id-3211992.html" title="洞悉linux下的Netfilter&amp;iptables：网络地址转换原理之SNAT" target="_blank" rel="noopener">^10</a></li></ul></li></ul></li><li>解决方案：在宿主机A上添加iptables规则，对数据包的TTL进行操作 <code>iptables -t mangle -A PREROUTING -i br0 -j TTL --ttl-inc 10</code>表示数据包从eth0流入则对TTL加10</li><li><p>扩展问题：在宿主机A上安装KVM虚拟机A1，使用桥接网络，然后在虚拟机A1上安装docker，此时A和A1均可访问外网且返回TTL=1，且在容器中无法访问外网</p><ul><li>按照上述操作当数据包经过A1的eth0网卡时操作TTL值是可以成功让容器上网；但是每当容器重启或者A1重启时，docker都会重写iptables规则(实际是docker会定时重写iptables规则)，从而导致自定义规则被覆盖；因此想到一种解决方法是在宿主机A的网卡上操作TTL，但实际失败的，具体原因是默认iptables不对bridge的数据(A和A1基于网桥通信)进行处理，即在网桥上进行转发的并不会触发TTL值的变化，具体参考上文 <a href="#ebtables">ebtables#Netfilter-Packet-Flow</a></li><li><p>解决方案一(操作宿主机A) <a href="https://blog.csdn.net/tycoon1988/article/details/40826235" target="_blank" rel="noopener">^14</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/sysctl.conf</span><br><span class="line"><span class="comment"># 加入下列内容：开启iptables对经过bridge数据的转发，数据每经过网桥设备转发TTL也会减一，此时也可操作TTL。如果net.bridge.bridge-nf-call-iptables=1，也就意味着二层的网桥在转发包时也会被iptables的FORWARD规则所过滤，这样就会出现L3层的iptables rules去过滤L2的帧的问题</span></span><br><span class="line">net.bridge.bridge-nf-call-iptables=1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables=1</span><br><span class="line">net.bridge.bridge-nf-call-arptables=1</span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 载入指定模块(重启后失效。可设置开机启动，参考linux.md)。防止刷新可能报错：sysctl: cannot stat /proc/sys/net/bridge/bridge-nf-call-iptables: No such file</span></span><br><span class="line">modprobe br_netfilter</span><br><span class="line"><span class="comment"># 刷新</span></span><br><span class="line">sysctl -p</span><br><span class="line"></span><br><span class="line"><span class="comment"># 操作宿主机</span></span><br><span class="line">iptables -t mangle -A PREROUTING -i br0 -j TTL --ttl-inc 10</span><br></pre></td></tr></table></figure></li><li><p>解决方案二(操作宿主机A)</p><ul><li>此方法如果在虚拟机A1上使用，则docker会定时覆盖iptables规则导致失效。如果场景是直接在宿主机A上安装docker，同理也无法操作宿主机A，此时可以考虑修改上层路由的TTL，或者将宿主机A的docker设置成iptables=false(此时需要手动设置容器网络隔离和访问外网的规则)</li><li><p>保存iptables规则 <code>iptables-save &gt; /etc/sysconfig/iptables</code> (直接保存可能存在其他数据，此处可以手动保存到/etc/sysconfig/iptables)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Generated by iptables-save v1.4.21 on Thu Jun 20 16:05:03 2019</span></span><br><span class="line">*mangle</span><br><span class="line">:PREROUTING ACCEPT [0:0]</span><br><span class="line">:INPUT ACCEPT [0:0]</span><br><span class="line">:FORWARD ACCEPT [0:0]</span><br><span class="line">:OUTPUT ACCEPT [0:0]</span><br><span class="line">:POSTROUTING ACCEPT [0:0]</span><br><span class="line">-A PREROUTING -i eth0 -j TTL --ttl-inc 10</span><br><span class="line">COMMIT</span><br><span class="line"><span class="comment"># Completed on Thu Jun 20 16:05:03 2019</span></span><br></pre></td></tr></table></figure></li><li><p>将下列脚本加入到开机启动</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="comment"># chkconfig: 2345 50 50</span></span><br><span class="line"><span class="comment"># description: 初始化自定义iptables规则(防止docker覆盖)</span></span><br><span class="line"><span class="comment"># processname: iptables-init</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 基于文件中保存的iptables规则，提交到规则表中</span></span><br><span class="line">iptables-restore &lt; /etc/sysconfig/iptables</span><br></pre></td></tr></table></figure></li></ul></li></ul></li></ul><hr><p>参考文章</p></div><div></div><div></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> smalle</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="http://blog.aezo.cn/2019/06/20/linux/network/" title="网络">http://blog.aezo.cn/2019/06/20/linux/network/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/docker/" rel="tag"># docker</a> <a href="/tags/linux/" rel="tag"># linux</a> <a href="/tags/network/" rel="tag"># network</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2019/06/01/devops/kubernetes/" rel="next" title="Kubernetes"><i class="fa fa-chevron-left"></i> Kubernetes</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"> <a href="/2019/06/22/devops/helm/" rel="prev" title="Helm | K8s包管理器">Helm | K8s包管理器<i class="fa fa-chevron-right"></i></a></div></div></footer></article><div class="post-spread"><div> <a target="_blank" href="https://github.com/oldinaction/ChatGPT-MP"><img class="nofancybox" style="width:300px;margin:0 auto" src="https://cdn7.aezo.cn/one/chat/chat-gpt-open-banner.jpg" alt="ChatGPT开源小程序" title="ChatGPT开源小程序"></a></div></div></div></div><div class="comments" id="comments"></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> 文章目录</li><li class="sidebar-nav-overview" data-target="site-overview"> 站点概览</li></ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="https://avatars0.githubusercontent.com/u/15698218?v=3&u=ce740bf0b67ff0d74990ba6fc644d6e92f572dcb&s=400" alt="smalle"><p class="site-author-name" itemprop="name">smalle</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">167</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/index.html"><span class="site-state-item-count">14</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/index.html"><span class="site-state-item-count">153</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"></div><div> 欢迎关注公众号：阿壹族 <img class="nofancybox" style="width:120px;margin:0 auto" src="https://cdn7.aezo.cn/common/qrcode/ayz_qrcode.jpg" alt="欢迎关注公众号：阿壹族" title="欢迎关注公众号：阿壹族"></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Linux网络"><span class="nav-number">1.</span> <span class="nav-text">Linux网络</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#brctl网桥操作"><span class="nav-number">1.1.</span> <span class="nav-text">brctl网桥操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ip信息-路由信息"><span class="nav-number">1.2.</span> <span class="nav-text">ip信息/路由信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#curl-wget测试"><span class="nav-number">1.3.</span> <span class="nav-text">curl/wget测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ping"><span class="nav-number">1.4.</span> <span class="nav-text">ping</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#arp"><span class="nav-number">1.5.</span> <span class="nav-text">arp</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DNS查询"><span class="nav-number">1.6.</span> <span class="nav-text">DNS查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tcpdump"><span class="nav-number">1.7.</span> <span class="nav-text">tcpdump</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#traceroute-tracert"><span class="nav-number">1.8.</span> <span class="nav-text">traceroute/tracert</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#iptables"><span class="nav-number">1.9.</span> <span class="nav-text">iptables</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#firewalld"><span class="nav-number">1.9.1.</span> <span class="nav-text">firewalld</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ebtables"><span class="nav-number">1.10.</span> <span class="nav-text">ebtables</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#iftop-监控网络带宽使用-基于IP"><span class="nav-number">1.11.</span> <span class="nav-text">iftop 监控网络带宽使用(基于IP)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nethogs-监控网络带宽使用-基于进程"><span class="nav-number">1.12.</span> <span class="nav-text">nethogs 监控网络带宽使用(基于进程)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Socket测试-TCP-UDP"><span class="nav-number">1.13.</span> <span class="nav-text">Socket测试(TCP/UDP)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#网络工具"><span class="nav-number">2.</span> <span class="nav-text">网络工具</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Charles抓包"><span class="nav-number">2.1.</span> <span class="nav-text">Charles抓包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Wireshark抓包"><span class="nav-number">2.2.</span> <span class="nav-text">Wireshark抓包</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#网络异常排查案例"><span class="nav-number">3.</span> <span class="nav-text">网络异常排查案例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#TTL-1导致虚拟机-docker无法访问外网"><span class="nav-number">3.1.</span> <span class="nav-text">TTL=1导致虚拟机/docker无法访问外网</span></a></li></ol></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright"> &copy; 2016 - <span itemprop="copyrightYear">2025</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">smalle</span>&nbsp;&nbsp;&nbsp;&nbsp;<div class="powered-by"> 由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div><div class="powered-by"> 主题 - <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a></div><div class="theme-info"> <a class="theme-link" target="_blank" href="https://tongji.baidu.com/main/overview/10000542408/overview/index?siteId=18991897">站长统计</a></div></div><div class="ad"> <span style="font-weight:700">AD&nbsp;&nbsp;&nbsp;&nbsp;</span><div class="theme-info"> <a target="_blank" href="https://promotion.aliyun.com/ntms/yunparter/invite.html?userCode=oby5nolb">阿里云大礼包</a></div></div><div class="aezocn"> <span style="font-weight:700">&copy;AEZO.CN&nbsp;&nbsp;&nbsp;&nbsp;</span><div class="powered-by"> <a target="_blank" href="https://shengqitech.aezo.cn/">圣骑科技</a></div><div class="powered-by"> <a target="_blank" href="https://cdn7.aezo.cn/common/qrcode/one_qrcode.jpg">【One能抽屉】小程序</a></div><div class="theme-info"> <a target="_blank" href="http://shop.aezo.cn/">杂货铺(省钱小助手)</a></div></div><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?085f9cd91ef2ad985f791c677472f0d1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script><script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script type="text/javascript" src="/js/src/js.cookie.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/scroll-cookie.js?v=5.1.1"></script></body></html>